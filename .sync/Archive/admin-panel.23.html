<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>eTax Admin Panel - Quản lý hệ thống</title>
  <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      color: #333;
      line-height: 1.6;
    }

    /* Loading Screen */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: white;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .admin-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      display: none;
    }

    /* Header */
    .admin-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 20px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .admin-avatar {
      width: 60px;
      height: 60px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .admin-info h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .admin-role {
      opacity: 0.9;
      font-size: 14px;
    }

    .header-actions {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .logout-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      gap: 20px;
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
    }

    .stat-icon.users { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .stat-icon.tokens { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .stat-icon.devices { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .stat-icon.docs { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }

    .stat-content h3 {
      font-size: 32px;
      font-weight: 700;
      color: #333;
      margin-bottom: 5px;
    }

    .stat-content p {
      color: #666;
      font-size: 14px;
    }

    /* Navigation Tabs */
    .nav-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .nav-tab {
      padding: 12px 20px;
      background: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      color: #666;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .nav-tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      transform: translateY(-2px);
    }

    .nav-tab:hover:not(.active) {
      background: #f8f9fa;
      transform: translateY(-1px);
    }

    /* Section Cards */
    .section-card {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.08);
      margin-bottom: 30px;
    }

    .card-title {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Form Styles */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-label {
      font-weight: 600;
      margin-bottom: 8px;
      color: #555;
    }

    .form-input, .form-select {
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s;
      background: white;
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: #667eea;
    }

    /* Buttons */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    .btn-success { background: #28a745; color: white; }
    .btn-warning { background: #ffc107; color: #333; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-info { background: #17a2b8; color: white; }
    .btn-small { padding: 8px 16px; font-size: 14px; }

    /* Token Generator */
    .token-generator {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 20px;
    }

    .generated-token {
      background: rgba(255, 255, 255, 0.2);
      padding: 15px;
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      margin: 15px 0;
      word-break: break-all;
    }

    /* Tables */
    .table-container {
      overflow-x: auto;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.08);
      background: white;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 12px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
    }

    .data-table td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }

    .data-table tr:hover {
      background: #f8f9ff;
    }

    /* Upload Area */
    .upload-area {
      border: 3px dashed #d1ecf1;
      border-radius: 15px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
      margin-bottom: 20px;
    }

    .upload-area:hover {
      border-color: #5a67d8;
      background: linear-gradient(135deg, #f0f2ff 0%, #f8f9ff 100%);
      transform: translateY(-2px);
    }

    .upload-icon {
      font-size: 48px;
      color: #667eea;
      margin-bottom: 15px;
    }

    .file-info {
      background: linear-gradient(135deg, #e3f2fd 0%, #f8f9ff 100%);
      border-radius: 12px;
      padding: 20px;
      margin: 15px 0;
      border-left: 4px solid #2196f3;
      display: none;
    }

    .extraction-result {
      background: linear-gradient(135deg, #e8f5e8 0%, #f0fff0 100%);
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      border-left: 4px solid #28a745;
      display: none;
    }

    /* Notifications */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 10px;
      color: white;
      font-weight: 600;
      z-index: 10000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
      max-width: 400px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success { background: #28a745; }
    .notification.error { background: #dc3545; }
    .notification.warning { background: #ffc107; color: #333; }
    .notification.info { background: #17a2b8; }

    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal.show {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    /* Hidden sections */
    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .admin-container {
        padding: 15px;
      }

      .header-content {
        flex-direction: column;
        text-align: center;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .nav-tabs {
        flex-direction: column;
        gap: 5px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-spinner"></div>
    <p>Đang xác thực quyền truy cập...</p>
  </div>

  <div class="admin-container" id="adminContainer">
    <!-- Header -->
    <div class="admin-header">
      <div class="header-content">
        <div class="header-left">
          <div class="admin-avatar">
            <i class="fas fa-user-shield"></i>
          </div>
          <div class="admin-info">
            <h1 id="adminName">Admin Panel</h1>
            <div class="admin-role" id="adminRole">Super Administrator</div>
          </div>
        </div>
        <div class="header-actions">
          <span id="lastLogin" style="opacity: 0.8; font-size: 14px;"></span>
          <button class="logout-btn" onclick="logoutAdmin()">
            <i class="fas fa-sign-out-alt"></i>
            Đăng xuất
          </button>
        </div>
      </div>
    </div>

    <!-- Stats Dashboard -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon users">
          <i class="fas fa-users"></i>
        </div>
        <div class="stat-content">
          <h3 id="totalUsers">0</h3>
          <p>Tổng người dùng</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon tokens">
          <i class="fas fa-key"></i>
        </div>
        <div class="stat-content">
          <h3 id="activeTokens">0</h3>
          <p>Token hoạt động</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon devices">
          <i class="fas fa-mobile-alt"></i>
        </div>
        <div class="stat-content">
          <h3 id="totalDevices">0</h3>
          <p>Thiết bị đã xác thực</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon docs">
          <i class="fas fa-file-pdf"></i>
        </div>
        <div class="stat-content">
          <h3 id="totalDocuments">0</h3>
          <p>Chứng từ PDF</p>
        </div>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="switchTab('users')">
        <i class="fas fa-users"></i> Quản lý người dùng
      </button>
      <button class="nav-tab" onclick="switchTab('upload')">
        <i class="fas fa-cloud-upload-alt"></i> Upload chứng từ
      </button>
      <button class="nav-tab" onclick="switchTab('tokens')">
        <i class="fas fa-key"></i> Quản lý Token
      </button>
      <button class="nav-tab" onclick="switchTab('documents')">
        <i class="fas fa-file-pdf"></i> Chứng từ
      </button>
      <button class="nav-tab" onclick="switchTab('notifications')">
        <i class="fas fa-bell"></i> Thông báo
      </button>
      <button class="nav-tab" onclick="switchTab('activity')">
        <i class="fas fa-history"></i> Nhật ký hoạt động
      </button>
    </div>

    <!-- User Management Section -->
    <div id="users-section" class="section active">
      <div class="section-card">
        <h2 class="card-title">
          <i class="fas fa-user-plus"></i>
          Tạo tài khoản người dùng mới
        </h2>

        <!-- Token Generator -->
        <div class="token-generator">
          <h3><i class="fas fa-key"></i> Tạo Device Token</h3>
          <p>Token này sẽ được liên kết với tài khoản người dùng</p>
          <div class="generated-token" id="generatedToken">
            Nhấn "Tạo Token mới" để tạo token
          </div>
          <button type="button" class="btn btn-primary" onclick="generateToken()">
            <i class="fas fa-refresh"></i> Tạo Token mới
          </button>
        </div>

        <!-- User Form -->
        <form onsubmit="createNewUser(event)">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Device Token *</label>
              <input type="text" id="userToken" class="form-input" required readonly 
                     placeholder="Token sẽ được tạo tự động">
            </div>
            <div class="form-group">
              <label class="form-label">Mã số thuế (MST) *</label>
              <input type="text" id="userId" class="form-input" required 
                     placeholder="Nhập mã số thuế">
            </div>
            <div class="form-group">
              <label class="form-label">Mật khẩu *</label>
              <input type="password" id="userPassword" class="form-input" required 
                     placeholder="Nhập mật khẩu">
            </div>
            <div class="form-group">
              <label class="form-label">Họ tên *</label>
              <input type="text" id="userFullName" class="form-input" required 
                     placeholder="Nhập họ tên đầy đủ">
            </div>
            <div class="form-group">
              <label class="form-label">Địa chỉ</label>
              <input type="text" id="userAddress" class="form-input" 
                     placeholder="Nhập địa chỉ">
            </div>
            <div class="form-group">
              <label class="form-label">Cục thuế</label>
              <input type="text" id="userTaxOffice" class="form-input" 
                     placeholder="Nhập tên cục thuế">
            </div>
            <div class="form-group">
              <label class="form-label">Vai trò</label>
              <select id="userRole" class="form-select">
                <option value="taxpayer">Người nộp thuế</option>
                <option value="business">Doanh nghiệp</option>
                <option value="individual">Cá nhân</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Thời hạn (ngày)</label>
              <input type="number" id="userDuration" class="form-input" value="365" 
                     min="1" max="3650" placeholder="Số ngày có hiệu lực">
            </div>
          </div>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-user-plus"></i> Tạo tài khoản
          </button>
        </form>
      </div>

      <!-- Users List -->
      <div class="section-card">
        <h2 class="card-title">
          <i class="fas fa-users"></i>
          Danh sách người dùng
        </h2>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>MST</th>
                <th>Họ tên</th>
                <th>Vai trò</th>
                <th>Ngày tạo</th>
                <th>Trạng thái</th>
                <th>Thao tác</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <tr>
                <td colspan="6" style="text-align: center; padding: 40px;">
                  <i class="fas fa-spinner fa-spin"></i> Đang tải dữ liệu...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Upload Section -->
    <div id="upload-section" class="section">
      <div class="section-card">
        <h2 class="card-title">
          <i class="fas fa-cloud-upload-alt"></i>
          Upload chứng từ PDF
        </h2>

        <!-- File Upload Area -->
        <div class="upload-area" onclick="document.getElementById('pdfFile').click()">
          <div class="upload-icon">
            <i class="fas fa-cloud-upload-alt"></i>
          </div>
          <h3>Chọn file PDF</h3>
          <p>Nhấn vào đây để chọn file PDF hoặc kéo thả file vào đây</p>
          <input type="file" id="pdfFile" accept=".pdf" style="display: none;" onchange="handleFileSelect(event)">
        </div>

        <!-- File Info -->
        <div id="fileInfo" class="file-info">
          <h4><i class="fas fa-file-pdf"></i> Thông tin file</h4>
          <p><strong>Tên file:</strong> <span id="fileName"></span></p>
          <button type="button" class="btn btn-info" onclick="extractPDFData()">
            <i class="fas fa-search"></i> Phân tích PDF
          </button>
        </div>

        <!-- Extraction Results -->
        <div id="extractionResults" class="extraction-result">
          <h4><i class="fas fa-check-circle"></i> Thông tin được trích xuất</h4>
          <div id="extractedData"></div>
        </div>

        <!-- Document Form -->
        <form onsubmit="uploadDocument(event)">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Mã tham chiếu *</label>
              <input type="text" id="documentReference" class="form-input" required 
                     placeholder="Mã tham chiếu chứng từ">
            </div>
            <div class="form-group">
              <label class="form-label">Người nộp thuế (MST) *</label>
              <select id="documentUser" class="form-select" required>
                <option value="">Chọn người dùng</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Thuế TNCN</label>
              <input type="text" id="taxTNCN" class="form-input" 
                     placeholder="Số tiền thuế TNCN">
            </div>
            <div class="form-group">
              <label class="form-label">Thuế GTGT</label>
              <input type="text" id="taxGTGT" class="form-input" 
                     placeholder="Số tiền thuế GTGT">
            </div>
            <div class="form-group">
              <label class="form-label">Tổng số tiền *</label>
              <input type="text" id="totalAmount" class="form-input" required 
                     placeholder="Tổng số tiền" oninput="convertToWords()">
            </div>
            <div class="form-group">
              <label class="form-label">Số tiền bằng chữ</label>
              <input type="text" id="amountInWords" class="form-input" readonly 
                     placeholder="Sẽ được tự động chuyển đổi">
            </div>
            <div class="form-group">
              <label class="form-label">Ngày nộp *</label>
              <input type="date" id="paymentDate" class="form-input" required>
            </div>
            <div class="form-group">
              <label class="form-label">Giờ nộp</label>
              <input type="time" id="paymentTime" class="form-input">
            </div>
            <div class="form-group">
              <label class="form-label">Mã ĐBHC</label>
              <input type="text" id="dbhcCode" class="form-input" 
                     placeholder="Mã điều tra - bổ hoàn - chuyển">
            </div>
            <div class="form-group">
              <label class="form-label">Trạng thái</label>
              <select id="documentStatus" class="form-select">
                <option value="completed">Hoàn thành</option>
                <option value="pending">Đang xử lý</option>
                <option value="failed">Thất bại</option>
              </select>
            </div>
            <div class="form-group" style="grid-column: 1 / -1;">
              <label class="form-label">Ghi chú</label>
              <textarea id="documentNotes" class="form-input" rows="3" 
                        placeholder="Ghi chú thêm về chứng từ"></textarea>
            </div>
          </div>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> Lưu chứng từ
          </button>
        </form>
      </div>
    </div>

    <!-- Tokens Section -->
  <!-- Tokens Section -->
   <div id="tokens-section" class="section">
     <div class="section-card">
       <h2 class="card-title">
         <i class="fas fa-key"></i>
         Quản lý Device Token
       </h2>
       <div class="table-container">
         <table class="data-table">
           <thead>
             <tr>
               <th>Token</th>
               <th>Người dùng liên kết</th>
               <th>Ngày tạo</th>
               <th>Trạng thái</th>
               <th>Hết hạn</th>
               <th>Thao tác</th>
             </tr>
           </thead>
           <tbody id="tokensTableBody">
             <tr>
               <td colspan="6" style="text-align: center; padding: 40px;">
                 <i class="fas fa-spinner fa-spin"></i> Đang tải dữ liệu...
               </td>
             </tr>
           </tbody>
         </table>
       </div>
     </div>
   </div>

   <!-- Documents Section -->
   <div id="documents-section" class="section">
     <div class="section-card">
       <h2 class="card-title">
         <i class="fas fa-file-pdf"></i>
         Danh sách chứng từ
       </h2>
       <div class="table-container">
         <table class="data-table">
           <thead>
             <tr>
               <th>Mã tham chiếu</th>
               <th>Người nộp thuế</th>
               <th>Số tiền</th>
               <th>Ngày nộp</th>
               <th>Trạng thái</th>
               <th>Thao tác</th>
             </tr>
           </thead>
           <tbody id="documentsTableBody">
             <tr>
               <td colspan="6" style="text-align: center; padding: 40px;">
                 <i class="fas fa-spinner fa-spin"></i> Đang tải dữ liệu...
               </td>
             </tr>
           </tbody>
         </table>
       </div>
     </div>
   </div>

   <!-- Notifications Section -->
   <div id="notifications-section" class="section">
     <div class="section-card">
       <h2 class="card-title">
         <i class="fas fa-bell"></i>
         Gửi thông báo
       </h2>
       <form onsubmit="createNotification(event)">
         <div class="form-grid">
           <div class="form-group">
             <label class="form-label">Người nhận *</label>
             <select id="notificationUser" class="form-select" required>
               <option value="">Chọn người dùng</option>
               <option value="all">Tất cả người dùng</option>
             </select>
           </div>
           <div class="form-group">
             <label class="form-label">Loại thông báo *</label>
             <select id="notificationType" class="form-select" required>
               <option value="info">Thông tin</option>
               <option value="warning">Cảnh báo</option>
               <option value="success">Thành công</option>
               <option value="error">Lỗi</option>
               <option value="transaction">Giao dịch</option>
               <option value="account">Tài khoản</option>
             </select>
           </div>
           <div class="form-group">
             <label class="form-label">Tiêu đề *</label>
             <input type="text" id="notificationTitle" class="form-input" required 
                    placeholder="Tiêu đề thông báo">
           </div>
           <div class="form-group">
             <label class="form-label">Thời gian</label>
             <input type="datetime-local" id="notificationDate" class="form-input">
           </div>
           <div class="form-group" style="grid-column: 1 / -1;">
             <label class="form-label">Nội dung *</label>
             <textarea id="notificationContent" class="form-input" rows="4" required 
                       placeholder="Nội dung thông báo"></textarea>
           </div>
           <div class="form-group">
             <label class="form-label">Chứng từ liên quan</label>
             <input type="text" id="relatedDocument" class="form-input" 
                    placeholder="Mã chứng từ (nếu có)">
           </div>
         </div>
         <button type="submit" class="btn btn-primary">
           <i class="fas fa-paper-plane"></i> Gửi thông báo
         </button>
       </form>
     </div>
   </div>

   <!-- Activity Log Section -->
   <div id="activity-section" class="section">
     <div class="section-card">
       <h2 class="card-title">
         <i class="fas fa-history"></i>
         Nhật ký hoạt động hệ thống
       </h2>
       <div class="table-container">
         <table class="data-table">
           <thead>
             <tr>
               <th>Thời gian</th>
               <th>Hoạt động</th>
               <th>User/Token</th>
               <th>Thiết bị</th>
               <th>Chi tiết</th>
             </tr>
           </thead>
           <tbody id="activityTableBody">
             <tr>
               <td colspan="5" style="text-align: center; padding: 40px;">
                 <i class="fas fa-spinner fa-spin"></i> Đang tải dữ liệu...
               </td>
             </tr>
           </tbody>
         </table>
       </div>
     </div>
   </div>
 </div>

 <!-- Edit User Modal -->
 <div id="editUserModal" class="modal">
   <div class="modal-content">
     <h3><i class="fas fa-edit"></i> Chỉnh sửa thông tin người dùng</h3>
     <form onsubmit="updateUser(event)">
       <div class="form-group">
         <label class="form-label">Họ tên *</label>
         <input type="text" id="editUserName" class="form-input" required>
       </div>
       <div class="form-group">
         <label class="form-label">Địa chỉ</label>
         <input type="text" id="editUserAddress" class="form-input">
       </div>
       <div class="form-group">
         <label class="form-label">Cục thuế</label>
         <input type="text" id="editUserTaxOffice" class="form-input">
       </div>
       <div class="form-group">
         <label class="form-label">Vai trò</label>
         <select id="editUserRole" class="form-select">
           <option value="taxpayer">Người nộp thuế</option>
           <option value="business">Doanh nghiệp</option>
           <option value="individual">Cá nhân</option>
         </select>
       </div>
       <div style="display: flex; gap: 10px; margin-top: 20px;">
         <button type="submit" class="btn btn-primary">
           <i class="fas fa-save"></i> Cập nhật
         </button>
         <button type="button" class="btn btn-secondary" onclick="closeModal('editUserModal')">
           <i class="fas fa-times"></i> Hủy
         </button>
       </div>
     </form>
   </div>
 </div>

 <script>
   // ===== FIREBASE CONFIGURATION =====
   const firebaseConfig = {
     apiKey: "AIzaSyC9kUYfuA1w7WXl9u-DJFXNvN7FWUmzFgc",
     authDomain: "etax-mobile-38a39.firebaseapp.com",
     databaseURL: "https://etax-mobile-38a39-default-rtdb.asia-southeast1.firebasedatabase.app",
     projectId: "etax-mobile-38a39",
     storageBucket: "etax-mobile-38a39.appspot.com",
     messagingSenderId: "908034763832",
     appId: "1:908034763832:web:8e8d7b66f7bcbf7a0e2f3e"
   };

   // Initialize Firebase
   firebase.initializeApp(firebaseConfig);
   const db = firebase.database();

   // ===== GLOBAL VARIABLES =====
   let currentAdminUser = null;
   let currentToken = '';
   let editingUserId = '';

   // ===== AUTHENTICATION AND INITIALIZATION =====
   async function checkAdminAuth() {
     const session = localStorage.getItem('etax_admin_session');
     
     if (!session) {
       window.location.href = 'admin-login.html';
       return;
     }

     try {
       currentAdminUser = JSON.parse(session);
       
       // Update UI
       document.getElementById('adminName').textContent = currentAdminUser.name;
       document.getElementById('adminRole').textContent = currentAdminUser.role;
       document.getElementById('lastLogin').textContent = 
         `Đăng nhập lần cuối: ${new Date(currentAdminUser.lastLogin).toLocaleString('vi-VN')}`;

       // Hide loading screen and show admin panel
       document.getElementById('loadingScreen').style.display = 'none';
       document.getElementById('adminContainer').style.display = 'block';

       // Load initial data
       await loadDashboardStats();
       await loadUsers();
       await loadUserDropdown();
       await loadTokens();
       await loadDocuments();
       await loadActivityLog();
       setDefaultDateTime();
       setDefaultNotificationDate();

     } catch (error) {
       console.error('Auth error:', error);
       localStorage.removeItem('etax_admin_session');
       window.location.href = 'admin-login.html';
     }
   }

   // ===== NAVIGATION FUNCTIONS =====
   function switchTab(tabName) {
     // Hide all sections
     document.querySelectorAll('.section').forEach(section => {
       section.classList.remove('active');
     });

     // Remove active class from all tabs
     document.querySelectorAll('.nav-tab').forEach(tab => {
       tab.classList.remove('active');
     });

     // Show selected section
     document.getElementById(tabName + '-section').classList.add('active');

     // Add active class to clicked tab
     event.target.classList.add('active');

     // Load data for specific sections
     if (tabName === 'activity') {
       loadActivityLog();
     }
   }

   // ===== TOKEN MANAGEMENT =====
   function generateToken() {
     currentToken = 'ETAX' + Date.now().toString(36).toUpperCase() + 
                    Math.random().toString(36).substr(2, 5).toUpperCase();
     
     document.getElementById('generatedToken').textContent = currentToken;
     document.getElementById('userToken').value = currentToken;
     
     showNotification('🎉 Token mới đã được tạo: ' + currentToken, 'success');
   }

   // ===== NOTIFICATION HELPER FUNCTIONS =====
   async function createNotificationForUser(userId, notificationData) {
     try {
       const notificationId = db.ref().push().key;
       await db.ref(`notifications/${userId}/${notificationId}`).set({
         ...notificationData,
         createdAt: Date.now(),
         createdBy: currentAdminUser ? currentAdminUser.username : 'system'
       });
       
       console.log(`✅ Notification created for user ${userId}`);
       return true;
       
     } catch (error) {
       console.error('Error creating notification for user:', error);
       return false;
     }
   }

   async function createTransactionNotification(documentData) {
     const success = await createNotificationForUser(documentData.taxpayerMST, {
       type: 'transaction',
       title: 'Giao dịch nộp thuế',
       content: `Người nộp thuế đã nộp thuế thành công cho mã số thuế ${documentData.taxpayerMST}, mã tham chiếu: ${documentData.mst}. Số tiền: ${documentData.amount} VND.`,
       timestamp: Date.now(),
       relatedDocument: documentData.mst
     });
     
     if (success) {
       console.log('✅ Transaction notification sent');
     }
   }

   async function createAccountNotification(userId, createdDate) {
     const success = await createNotificationForUser(userId, {
       type: 'account',
       title: 'Tài khoản giao dịch thuế điện tử',
       content: `Tài khoản thuế điện tử của bạn đã được tạo thành công vào ngày ${createdDate}. Bạn có thể sử dụng dịch vụ thuế điện tử ngay bây giờ.`,
       timestamp: Date.now(),
       relatedDocument: null
     });
     
     if (success) {
       console.log('✅ Account notification sent');
     }
   }

   // ===== USER MANAGEMENT FUNCTIONS =====
   async function createNewUser(event) {
     event.preventDefault();
     
     const token = document.getElementById('userToken').value.trim();
     const userId = document.getElementById('userId').value.trim();
     const password = document.getElementById('userPassword').value.trim();
     const fullName = document.getElementById('userFullName').value.trim();
     const address = document.getElementById('userAddress').value.trim();
     const taxOffice = document.getElementById('userTaxOffice').value.trim();
     const role = document.getElementById('userRole').value;
     const duration = parseInt(document.getElementById('userDuration').value);

     if (!token || !userId || !password || !fullName) {
       showNotification('❌ Vui lòng điền đầy đủ thông tin bắt buộc!', 'error');
       return;
     }

     try {
       // Check if user already exists
       const userSnapshot = await db.ref('users/' + userId).once('value');
       if (userSnapshot.exists()) {
         showNotification('❌ MST này đã tồn tại trong hệ thống!', 'error');
         return;
       }

       const now = Date.now();
       const expiresAt = now + (duration * 24 * 60 * 60 * 1000);

       // Create user data
       const userData = {
         mst: userId,
         password: password,
         name: fullName,
         address: address,
         taxoffice: taxOffice,
         role: role,
         date: new Date().toISOString().split('T')[0],
         duration: duration,
         createdAt: now,
         expiresAt: expiresAt,
         status: 'active',
         linkedToken: token,
         createdBy: currentAdminUser.username
       };

       // Create token data
       const tokenData = {
         linkedUserId: userId,
         createdAt: now,
         expiresAt: expiresAt,
         used: false,
         createdBy: currentAdminUser.username
       };

       // Save to Firebase
       await db.ref('users/' + userId).set(userData);
       await db.ref('deviceTokens/' + token).set(tokenData);

       // Send account notification
       const createdDate = new Date().toLocaleDateString('vi-VN');
       await createAccountNotification(userId, createdDate);

       // Log activity
       await db.ref('activityLogs').push({
         type: 'user_created',
         userId: userId,
         userName: fullName,
         token: token,
         timestamp: Date.now(),
         details: `Admin tạo tài khoản mới cho ${fullName}`,
         admin: currentAdminUser.username
       });

       showNotification('🎉 Tạo tài khoản thành công! Token: ' + token, 'success');
       
       // Reset form
       document.querySelector('#users-section form').reset();
       document.getElementById('userDuration').value = '365';
       document.getElementById('generatedToken').textContent = 'Nhấn "Tạo Token mới" để tạo token';
       document.getElementById('userToken').value = '';
       currentToken = '';
       
       // Reload data
       loadUsers();
       loadDashboardStats();
       loadUserDropdown();

     } catch (error) {
       console.error('Error creating user:', error);
       showNotification('❌ Có lỗi xảy ra khi tạo tài khoản: ' + error.message, 'error');
     }
   }

  async function loadUsers() {
  console.log('Starting to load users');
  try {
    const snapshot = await db.ref('users').once('value');
    const users = snapshot.val() || {};
    console.log('Users data fetched:', users);

    const tbody = document.getElementById('usersTableBody');
    if (!tbody) {
      console.error('Users table body element not found');
      return;
    }
    tbody.innerHTML = ''; // Clear initial "Loading..." message

    if (Object.keys(users).length === 0) {
      console.log('No users found in database');
      tbody.innerHTML = `
        <tr>
          <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
            <i class="fas fa-users" style="font-size: 48px; opacity: 0.3; margin-bottom: 10px; display: block;"></i>
            Chưa có người dùng nào được tạo
          </td>
        </tr>
      `;
    } else {
      Object.entries(users).forEach(([userId, userData]) => {
        const createdDate = userData.createdAt
          ? new Date(userData.createdAt).toLocaleDateString('vi-VN')
          : userData.date || 'N/A';
        const status = userData.status === 'active'
          ? '<span style="color: #28a745; font-weight: bold;">✅ Hoạt động</span>'
          : '<span style="color: #dc3545; font-weight: bold;">❌ Không hoạt động</span>';

        const row = `
          <tr>
            <td><code>${userId}</code></td>
            <td><strong>${userData.name}</strong></td>
            <td><span class="badge">${userData.role || 'taxpayer'}</span></td>
            <td>${createdDate}</td>
            <td>${status}</td>
            <td>
              <div style="display: flex; gap: 5px;">
                <button class="btn btn-small btn-warning" onclick="editUser('${userId}')">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-small btn-danger" onclick="deleteUser('${userId}')">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
        tbody.innerHTML += row;
      });
      console.log('Users table updated successfully');
    }
  } catch (error) {
    console.error('Error loading users:', error);
    showNotification('❌ Có lỗi khi tải danh sách người dùng: ' + error.message, 'error');
  }
}

   async function loadUserDropdown() {
     try {
       const snapshot = await db.ref('users').once('value');
       const users = snapshot.val() || {};
       
       const dropdowns = ['documentUser', 'notificationUser'];
       
       dropdowns.forEach(dropdownId => {
         const dropdown = document.getElementById(dropdownId);
         if (!dropdown) return;
         
         // Clear existing options (keep first option)
         const firstOption = dropdown.firstElementChild;
         dropdown.innerHTML = '';
         dropdown.appendChild(firstOption);
         
         // Add "all users" option for notification dropdown
         if (dropdownId === 'notificationUser') {
           const allOption = document.createElement('option');
           allOption.value = 'all';
           allOption.textContent = 'Tất cả người dùng';
           dropdown.appendChild(allOption);
         }
         
         // Add user options
         Object.entries(users).forEach(([userId, userData]) => {
           const option = document.createElement('option');
           option.value = userId;
           option.textContent = `${userId} - ${userData.name}`;
           dropdown.appendChild(option);
         });
       });

     } catch (error) {
       console.error('Error loading user dropdown:', error);
     }
   }

   async function editUser(userId) {
     try {
       const snapshot = await db.ref('users/' + userId).once('value');
       const userData = snapshot.val();
       
       if (!userData) {
         showNotification('❌ Không tìm thấy thông tin người dùng', 'error');
         return;
       }

       // Fill form
       document.getElementById('editUserName').value = userData.name || '';
       document.getElementById('editUserAddress').value = userData.address || '';
       document.getElementById('editUserTaxOffice').value = userData.taxoffice || '';
       document.getElementById('editUserRole').value = userData.role || 'taxpayer';
       
       editingUserId = userId;
       showModal('editUserModal');

     } catch (error) {
       console.error('Error loading user for edit:', error);
       showNotification('❌ Có lỗi khi tải thông tin người dùng', 'error');
     }
   }

   async function updateUser(event) {
     event.preventDefault();
     
     if (!editingUserId) {
       showNotification('❌ Không xác định được người dùng cần cập nhật', 'error');
       return;
     }

     try {
       const updateData = {
         name: document.getElementById('editUserName').value.trim(),
         address: document.getElementById('editUserAddress').value.trim(),
         taxoffice: document.getElementById('editUserTaxOffice').value.trim(),
         role: document.getElementById('editUserRole').value,
         updatedAt: Date.now(),
         updatedBy: currentAdminUser.username
       };

       await db.ref('users/' + editingUserId).update(updateData);

       // Log activity
       await db.ref('activityLogs').push({
         type: 'user_updated',
         userId: editingUserId,
         timestamp: Date.now(),
         details: `Admin cập nhật thông tin user ${editingUserId}`,
         admin: currentAdminUser.username
       });

       showNotification('🎉 Cập nhật thông tin người dùng thành công!', 'success');
       closeModal('editUserModal');
       loadUsers();
       loadUserDropdown();

     } catch (error) {
       console.error('Error updating user:', error);
       showNotification('❌ Có lỗi khi cập nhật: ' + error.message, 'error');
     }
   }

   async function deleteUser(userId) {
     if (!confirm(`Bạn có chắc chắn muốn xóa người dùng "${userId}"?\n\n⚠️ Thao tác này sẽ xóa:\n- Tài khoản người dùng\n- Token liên kết\n- Tất cả chứng từ của người dùng\n- Dữ liệu không thể khôi phục!`)) {
       return;
     }

     try {
       // Get user data first
       const userSnapshot = await db.ref('users/' + userId).once('value');
       const userData = userSnapshot.val();
       
       if (!userData) {
         showNotification('❌ Không tìm thấy người dùng', 'error');
         return;
       }

       // Delete user
       await db.ref('users/' + userId).remove();
       
       // Delete linked token
       if (userData.linkedToken) {
         await db.ref('deviceTokens/' + userData.linkedToken).remove();
       }
       
       // Delete user's documents
       const documentsSnapshot = await db.ref('pdf_documents').orderByChild('taxpayerMST').equalTo(userId).once('value');
       if (documentsSnapshot.exists()) {
         const documents = documentsSnapshot.val();
         const deletePromises = Object.keys(documents).map(docId => 
           db.ref('pdf_documents/' + docId).remove()
         );
         await Promise.all(deletePromises);
       }
       
       // Delete user's notifications
       await db.ref('notifications/' + userId).remove();
       
       // Log deletion
       await db.ref('activityLogs').push({
         type: 'user_deleted',
         userId: userId,
         timestamp: Date.now(),
         details: `Admin xóa user ${userId} và tất cả dữ liệu liên quan`,
         admin: currentAdminUser.username
       });
       
       showNotification(`🎉 Đã xóa người dùng "${userId}" và tất cả dữ liệu liên quan!`, 'success');
       loadUsers();
       loadDashboardStats();
       loadUserDropdown();
       loadTokens();
       loadDocuments();

     } catch (error) {
       console.error('Error deleting user:', error);
       showNotification('❌ Có lỗi khi xóa người dùng: ' + error.message, 'error');
     }
   }

   // ===== DOCUMENT UPLOAD FUNCTIONS =====
   function handleFileSelect(event) {
     const file = event.target.files[0];
     if (file && file.type === 'application/pdf') {
       document.getElementById('fileName').textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
       document.getElementById('fileInfo').style.display = 'block';
       
       // Store file globally
       window.selectedPDFFile = file;
       
       showNotification('✅ File PDF đã được chọn. Nhấn "Phân tích PDF" để extract thông tin!', 'success');
     } else {
       showNotification('❌ Vui lòng chọn file PDF hợp lệ!', 'error');
     }
   }

   async function extractPDFData() {
     if (!window.selectedPDFFile) {
       showNotification('❌ Vui lòng chọn file PDF trước!', 'error');
       return;
     }

     showNotification('⏳ Đang phân tích PDF...', 'info');

     // Mock data extraction (trong thực tế cần PDF.js)
     setTimeout(() => {
       const mockData = {
         reference: 'TAX' + Date.now().toString().slice(-8),
         amount: '5000000',
         taxTNCN: '500000',
         taxGTGT: '1000000',
         date: new Date().toISOString().split('T')[0],
         time: '14:30',
         dbhc: 'DBHC001'
       };

       // Fill form with extracted data
       document.getElementById('documentReference').value = mockData.reference;
       document.getElementById('totalAmount').value = mockData.amount;
       document.getElementById('taxTNCN').value = mockData.taxTNCN;
       document.getElementById('taxGTGT').value = mockData.taxGTGT;
       document.getElementById('paymentDate').value = mockData.date;
       document.getElementById('paymentTime').value = mockData.time;
       document.getElementById('dbhcCode').value = mockData.dbhc;

       // Convert amount to words
       convertToWords();

       // Show results
       document.getElementById('extractedData').innerHTML = `
         <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
           <div style="background: white; padding: 10px; border-radius: 8px; border-left: 3px solid #28a745;">
             <strong>Mã tham chiếu:</strong> ${mockData.reference}
           </div>
           <div style="background: white; padding: 10px; border-radius: 8px; border-left: 3px solid #28a745;">
             <strong>Tổng tiền:</strong> ${parseInt(mockData.amount).toLocaleString('vi-VN')} VND
           </div>
           <div style="background: white; padding: 10px; border-radius: 8px; border-left: 3px solid #28a745;">
             <strong>Thuế TNCN:</strong> ${parseInt(mockData.taxTNCN).toLocaleString('vi-VN')} VND
           </div>
           <div style="background: white; padding: 10px; border-radius: 8px; border-left: 3px solid #28a745;">
             <strong>Ngày nộp:</strong> ${new Date(mockData.date).toLocaleDateString('vi-VN')}
           </div>
         </div>
       `;
       document.getElementById('extractionResults').style.display = 'block';

       showNotification('🎉 Phân tích PDF thành công! Dữ liệu đã được điền vào form.', 'success');
     }, 2000);
   }

   async function uploadDocument(event) {
     event.preventDefault();
     
     if (!window.selectedPDFFile) {
       showNotification('❌ Vui lòng chọn file PDF trước!', 'error');
       return;
     }
     
     const documentData = {
       mst: document.getElementById('documentReference').value.trim(),
       taxpayerMST: document.getElementById('documentUser').value,
       taxTNCN: document.getElementById('taxTNCN').value.trim(),
       taxGTGT: document.getElementById('taxGTGT').value.trim(),
       amount: document.getElementById('totalAmount').value.trim(),
       amountInWords: document.getElementById('amountInWords').value.trim(),
       date: document.getElementById('paymentDate').value,
       time: document.getElementById('paymentTime').value,
       dbhc: document.getElementById('dbhcCode').value.trim(),
       status: document.getElementById('documentStatus').value,
       notes: document.getElementById('documentNotes').value.trim(),
       uploadDate: new Date().toISOString(),
       uploadedBy: currentAdminUser.username,
       type: 'tax_payment_document'
     };
     
     if (!documentData.mst || !documentData.taxpayerMST) {
       showNotification('❌ Vui lòng điền đầy đủ thông tin bắt buộc!', 'error');
       return;
     }
     
     try {
       showNotification('⏳ Đang lưu chứng từ...', 'info');
       
       // Save document to Firebase
       await db.ref('pdf_documents/' + documentData.mst).set(documentData);
       
       // Send notification to user
       await createTransactionNotification(documentData);
       
       // Log activity
       await db.ref('activityLogs').push({
         type: 'document_uploaded',
         documentId: documentData.mst,
         userId: documentData.taxpayerMST,
         timestamp: Date.now(),
         details: `Upload chứng từ ${documentData.mst} cho user ${documentData.taxpayerMST}`,
         admin: currentAdminUser.username
       });
       
       showNotification('🎉 Lưu chứng từ thành công!', 'success');
       
       // Reset form
       document.querySelector('#upload-section form').reset();
       document.getElementById('fileInfo').style.display = 'none';
       document.getElementById('extractionResults').style.display = 'none';
       window.selectedPDFFile = null;
       setDefaultDateTime();
       
       // Reload data
       loadDocuments();
       loadDashboardStats();
       
     } catch (error) {
       console.error('Error uploading document:', error);
       showNotification('❌ Có lỗi khi lưu chứng từ: ' + error.message, 'error');
     }
   }

   // ===== NOTIFICATION MANAGEMENT =====
   async function createNotification(event) {
     event.preventDefault();
     
     const userId = document.getElementById('notificationUser').value;
     const type = document.getElementById('notificationType').value;
     const title = document.getElementById('notificationTitle').value.trim();
     const content = document.getElementById('notificationContent').value.trim();
     const date = document.getElementById('notificationDate').value;
     const relatedDocument = document.getElementById('relatedDocument').value.trim();
     
     if (!userId || !title || !content) {
       showNotification('❌ Vui lòng điền đầy đủ thông tin bắt buộc!', 'error');
       return;
     }
     
     try {
       const notificationData = {
         type: type,
         title: title,
         content: content,
         timestamp: date ? new Date(date).getTime() : Date.now(),
         createdBy: currentAdminUser.username,
         createdAt: Date.now(),
         relatedDocument: relatedDocument || null
       };
       
       if (userId === 'all') {
         // Send to all users
         const usersSnapshot = await db.ref('users').once('value');
         const users = usersSnapshot.val() || {};
         
         const promises = Object.keys(users).map(async (userMst) => {
           const notificationId = db.ref().push().key;
           return db.ref(`notifications/${userMst}/${notificationId}`).set(notificationData);
         });
         
         await Promise.all(promises);
         
         showNotification(`🎉 Đã gửi thông báo cho ${Object.keys(users).length} người dùng!`, 'success');
         
       } else {
         // Send to specific user
         const notificationId = db.ref().push().key;
         await db.ref(`notifications/${userId}/${notificationId}`).set(notificationData);
         
         showNotification(`🎉 Đã gửi thông báo cho user ${userId}!`, 'success');
       }
       
       // Log activity
       await db.ref('activityLogs').push({
         type: 'notification_sent',
         targetUser: userId,
         notificationTitle: title,
         timestamp: Date.now(),
         details: `Admin gửi thông báo "${title}" cho ${userId === 'all' ? 'tất cả người dùng' : userId}`,
         admin: currentAdminUser.username
       });
       
       // Reset form
       document.querySelector('#notifications-section form').reset();
       setDefaultNotificationDate();
       
     } catch (error) {
       console.error('Error creating notification:', error);
       showNotification('❌ Có lỗi khi gửi thông báo: ' + error.message, 'error');
     }
   }

   function setDefaultNotificationDate() {
     const now = new Date();
     const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
     document.getElementById('notificationDate').value = localDateTime;
   }

   // ===== DATA LOADING FUNCTIONS =====
   async function loadDashboardStats() {
     try {
       const [usersSnapshot, tokensSnapshot, documentsSnapshot] = await Promise.all([
         db.ref('users').once('value'),
         db.ref('deviceTokens').once('value'),
         db.ref('pdf_documents').once('value')
       ]);

       const users = usersSnapshot.val() || {};
       const tokens = tokensSnapshot.val() || {};
       const documents = documentsSnapshot.val() || {};

       const totalUsers = Object.keys(users).length;
       const activeTokens = Object.values(tokens).filter(token => !token.used).length;
       const totalDevices = Object.values(tokens).filter(token => token.used).length;
       const totalDocuments = Object.keys(documents).length;

       document.getElementById('totalUsers').textContent = totalUsers;
       document.getElementById('activeTokens').textContent = activeTokens;
       document.getElementById('totalDevices').textContent = totalDevices;
       document.getElementById('totalDocuments').textContent = totalDocuments;

     } catch (error) {
       console.error('Error loading dashboard stats:', error);
     }
   }

   async function loadTokens() {
     try {
       const snapshot = await db.ref('deviceTokens').once('value');
       const tokens = snapshot.val() || {};
       
       const tbody = document.getElementById('tokensTableBody');
       tbody.innerHTML = '';

       if (Object.keys(tokens).length === 0) {
         tbody.innerHTML = `
           <tr>
             <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
               <i class="fas fa-key" style="font-size: 48px; opacity: 0.3; margin-bottom: 10px; display: block;"></i>
               Chưa có token nào được tạo
             </td>
           </tr>
         `;
         return;
       }

       Object.entries(tokens).forEach(([tokenId, tokenData]) => {
         const createdDate = new Date(tokenData.createdAt || Date.now()).toLocaleDateString('vi-VN');
         const expiresDate = new Date(tokenData.expiresAt || Date.now()).toLocaleDateString('vi-VN');
         
         const status = tokenData.used ? 
           '<span style="color: #28a745; font-weight: bold;">✅ Đã sử dụng</span>' : 
           '<span style="color: #ffc107; font-weight: bold;">⏳ Chưa sử dụng</span>';

         const linkedUser = tokenData.linkedUserId || 'Chưa liên kết';

         const row = `
           <tr>
             <td><code style="font-size: 12px;">${tokenId.slice(0, 20)}...</code></td>
             <td><strong>${linkedUser}</strong></td>
             <td>${createdDate}</td>
             <td>${status}</td>
             <td>${expiresDate}</td>
             <td>
               <button class="btn btn-small btn-info" onclick="viewTokenDetails('${tokenId}')">
                 <i class="fas fa-eye"></i>
               </button>
             </td>
           </tr>
         `;
         tbody.innerHTML += row;
       });

     } catch (error) {
       console.error('Error loading tokens:', error);
       showNotification('❌ Có lỗi khi tải danh sách token', 'error');
     }
   }

   async function loadDocuments() {
     try {
       const snapshot = await db.ref('pdf_documents').once('value');
       const documents = snapshot.val() || {};
       
       const tbody = document.getElementById('documentsTableBody');
       tbody.innerHTML = '';

       if (Object.keys(documents).length === 0) {
         tbody.innerHTML = `
           <tr>
             <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
               <i class="fas fa-file-pdf" style="font-size: 48px; opacity: 0.3; margin-bottom: 10px; display: block;"></i>
               Chưa có chứng từ nào được upload
             </td>
           </tr>
         `;
         return;
       }

       Object.entries(documents).forEach(([docId, docData]) => {
         const uploadDate = docData.uploadDate ? 
           new Date(docData.uploadDate).toLocaleDateString('vi-VN') : 
           docData.date || 'N/A';
         
         const amount = docData.amount ? 
           parseInt(docData.amount).toLocaleString('vi-VN') + ' VND' : 
           'N/A';

         const status = docData.status === 'completed' ? 
           '<span style="color: #28a745; font-weight: bold;">✅ Hoàn thành</span>' : 
           docData.status === 'pending' ? 
           '<span style="color: #ffc107; font-weight: bold;">⏳ Đang xử lý</span>' :
           '<span style="color: #dc3545; font-weight: bold;">❌ Thất bại</span>';

         const row = `
           <tr>
             <td><code>${docData.mst || docId}</code></td>
             <td><strong>${docData.taxpayerMST}</strong></td>
             <td>${amount}</td>
             <td>${uploadDate}</td>
             <td>${status}</td>
             <td>
               <div style="display: flex; gap: 5px;">
                 <button class="btn btn-small btn-info" onclick="viewDocument('${docId}')">
                   <i class="fas fa-eye"></i>
                 </button>
                 <button class="btn btn-small btn-danger" onclick="deleteDocument('${docId}')">
                   <i class="fas fa-trash"></i>
                 </button>
               </div>
             </td>
           </tr>
         `;
         tbody.innerHTML += row;
       });

     } catch (error) {
       console.error('Error loading documents:', error);
       showNotification('❌ Có lỗi khi tải danh sách chứng từ', 'error');
     }
   }

   async function loadActivityLog() {
     try {
       const snapshot = await db.ref('activityLogs').orderByChild('timestamp').limitToLast(100).once('value');
       const logs = snapshot.val() || {};
       
       const tbody = document.getElementById('activityTableBody');
       tbody.innerHTML = '';

       if (Object.keys(logs).length === 0) {
         tbody.innerHTML = `
           <tr>
             <td colspan="5" style="text-align: center; padding: 40px; color: #666;">
               <i class="fas fa-history" style="font-size: 48px; opacity: 0.3; margin-bottom: 10px; display: block;"></i>
               Chưa có hoạt động nào được ghi nhận
             </td>
           </tr>
         `;
         return;
       }

       // Convert to array and sort by timestamp (newest first)
       const logsArray = Object.entries(logs).map(([id, data]) => ({ id, ...data }));
       logsArray.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

       logsArray.forEach((logData) => {
         const timestamp = new Date(logData.timestamp || Date.now()).toLocaleString('vi-VN');
         const activityType = getActivityIcon(logData.type);
         const deviceInfo = logData.deviceId ? 
           logData.deviceId.slice(0, 20) + '...' : 'N/A';
         
         const row = `
           <tr>
             <td>${timestamp}</td>
             <td>
               <span class="activity-badge ${logData.type}" style="
                 background: #f8f9fa; 
                 color: #333; 
                 padding: 4px 8px; 
                 border-radius: 12px; 
                 font-size: 12px; 
                 font-weight: 600;
                 border-left: 3px solid #667eea;
               ">
                 ${activityType.icon} ${activityType.text}
               </span>
             </td>
             <td><code>${logData.token || logData.userId || 'N/A'}</code></td>
             <td style="font-size: 12px;">${deviceInfo}</td>
             <td>${logData.details || ''}</td>
           </tr>
         `;
         tbody.innerHTML += row;
       });

     } catch (error) {
       console.error('Error loading activity log:', error);
       showNotification('❌ Có lỗi khi tải nhật ký hoạt động', 'error');
     }
   }

   function getActivityIcon(type) {
     const types = {
       'token_activated': { icon: '🔓', text: 'Token được kích hoạt' },
       'token_revoked': { icon: '🚫', text: 'Token bị thu hồi' },
       'user_login': { icon: '🔑', text: 'Đăng nhập' },
       'user_logout': { icon: '🚪', text: 'Đăng xuất' },
       'user_created': { icon: '👤', text: 'Tạo tài khoản' },
       'user_updated': { icon: '✏️', text: 'Cập nhật thông tin' },
       'user_deleted': { icon: '🗑️', text: 'Xóa tài khoản' },
       'document_uploaded': { icon: '📄', text: 'Upload chứng từ' },
       'document_deleted': { icon: '🗑️', text: 'Xóa chứng từ' },
       'notification_sent': { icon: '📢', text: 'Gửi thông báo' },
       'device_linked': { icon: '📱', text: 'Liên kết thiết bị' },
       'direct_user_access': { icon: '🔗', text: 'Truy cập trực tiếp' },
       'password_changed': { icon: '🔐', text: 'Đổi mật khẩu' }
     };
     return types[type] || { icon: '📝', text: 'Hoạt động khác' };
   }

   // ===== UTILITY FUNCTIONS =====
   function convertToWords() {
     const amount = document.getElementById('totalAmount').value.trim();
     if (!amount || isNaN(amount)) {
       document.getElementById('amountInWords').value = '';
       return;
     }

     const words = convertNumberToWords(parseInt(amount));
     document.getElementById('amountInWords').value = words;
   }

   function convertNumberToWords(amount) {
     if (amount === 0) return "không đồng";
     
     const ones = ["", "một", "hai", "ba", "bốn", "năm", "sáu", "bảy", "tám", "chín"];
     const tens = ["", "", "hai mươi", "ba mươi", "bốn mươi", "năm mươi", "sáu mươi", "bảy mươi", "tám mươi", "chín mươi"];
     
     function convertThreeDigits(num) {
       let result = "";
       const hundreds = Math.floor(num / 100);
       const remainder = num % 100;
       const tensDigit = Math.floor(remainder / 10);
       const onesDigit = remainder % 10;
       
       if (hundreds > 0) {
         result += ones[hundreds] + " trăm";
         if (remainder > 0) result += " ";
       }
       
       if (tensDigit >= 2) {
         result += tens[tensDigit];
         if (onesDigit > 0) {
           result += " " + ones[onesDigit];
         }
       } else if (tensDigit === 1) {
         result += "mười";
         if (onesDigit > 0) {
           result += " " + ones[onesDigit];
         }
       } else if (onesDigit > 0) {
         result += ones[onesDigit];
       }
       
       return result;
     }
     
     if (amount < 1000) {
       return convertThreeDigits(amount) + " đồng";
     } else if (amount < 1000000) {
       const thousands = Math.floor(amount / 1000);
       const remainder = amount % 1000;
       let result = convertThreeDigits(thousands) + " nghìn";
       if (remainder > 0) result += " " + convertThreeDigits(remainder);
       return result + " đồng";
     } else if (amount < 1000000000) {
       const millions = Math.floor(amount / 1000000);
       const remainder = amount % 1000000;
       let result = convertThreeDigits(millions) + " triệu";
       if (remainder > 0) {
         if (remainder >= 1000) {
           const thousands = Math.floor(remainder / 1000);
           const lastThree = remainder % 1000;
           result += " " + convertThreeDigits(thousands) + " nghìn";
           if (lastThree > 0) result += " " + convertThreeDigits(lastThree);
         } else {
           result += " " + convertThreeDigits(remainder);
         }
       }
       return result + " đồng";
     }
     
     return amount.toLocaleString('vi-VN') + " đồng";
   }

   function setDefaultDateTime() {
     const now = new Date();
     const localDate = now.toISOString().split('T')[0];
     const localTime = now.toTimeString().slice(0, 5);
     
     document.getElementById('paymentDate').value = localDate;
     document.getElementById('paymentTime').value = localTime;
   }

   function viewDocument(mst) {
     window.open(`xem-chung-tu.html?mst=${mst}`, '_blank');
   }

   function viewTokenDetails(tokenId) {
     showNotification(`Token: ${tokenId}`, 'info');
   }

   async function deleteDocument(mst) {
     if (!confirm(`Bạn có chắc chắn muốn xóa chứng từ "${mst}"?\n\nThao tác này không thể hoàn tác.`)) {
       return;
     }

     try {
       await db.ref('pdf_documents/' + mst).remove();
       
       // Log deletion
       await db.ref('activityLogs').push({
         type: 'document_deleted',
         documentId: mst,
         admin: currentAdminUser.username,
         timestamp: Date.now(),
         details: `Xóa chứng từ ${mst}`
       });
       
       showNotification(`🎉 Đã xóa chứng từ "${mst}" thành công!`, 'success');
       loadDocuments();
       loadDashboardStats();
       
     } catch (error) {
       console.error('Error deleting document:', error);
       showNotification('❌ Có lỗi khi xóa chứng từ: ' + error.message, 'error');
     }
   }

   // ===== LOGOUT FUNCTION =====
   function logoutAdmin() {
     if (confirm('Bạn có chắc chắn muốn đăng xuất khỏi admin panel?')) {
       // Log logout
       db.ref('activityLogs').push({
         type: 'admin_logout',
         admin: currentAdminUser.username,
         timestamp: Date.now(),
         details: `Admin ${currentAdminUser.username} đăng xuất`
       });
       
       localStorage.removeItem('etax_admin_session');
       showNotification('🎉 Đã đăng xuất thành công!', 'success');
       setTimeout(() => {
         window.location.href = 'admin-login.html';
       }, 1500);
     }
   }

   // ===== MODAL FUNCTIONS =====
   function showModal(modalId) {
     document.getElementById(modalId).classList.add('show');
   }

   function closeModal(modalId) {
     document.getElementById(modalId).classList.remove('show');
     editingUserId = '';
   }

   // ===== NOTIFICATION SYSTEM =====
   function showNotification(message, type = 'info') {
     // Remove existing notifications
     const existingNotifications = document.querySelectorAll('.notification');
     existingNotifications.forEach(notif => notif.remove());

     const notification = document.createElement('div');
     notification.className = `notification ${type}`;
     notification.innerHTML = `
       <div style="display: flex; align-items: center; gap: 10px;">
         <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
         <span style="white-space: pre-line;">${message}</span>
       </div>
     `;

     document.body.appendChild(notification);

     // Show notification
     setTimeout(() => notification.classList.add('show'), 100);

     // Auto hide after 5 seconds
     setTimeout(() => {
       notification.classList.remove('show');
       setTimeout(() => notification.remove(), 300);
     }, 5000);
   }

   // ===== EVENT LISTENERS =====
   document.addEventListener('click', function(event) {
     if (event.target.classList.contains('modal')) {
       closeModal(event.target.id);
     }
   });

   document.addEventListener('keydown', function(event) {
     if (event.key === 'Escape') {
       const openModal = document.querySelector('.modal.show');
       if (openModal) {
         closeModal(openModal.id);
       }
     }
   });

   // Auto-refresh data every 60 seconds
   setInterval(() => {
     if (document.visibilityState === 'visible') {
       loadDashboardStats();
     }
   }, 60000);

   // Check session validity every 5 minutes
   setInterval(() => {
     checkAdminAuth();
   }, 5 * 60 * 1000);

   // ===== INITIALIZE APPLICATION =====
   document.addEventListener('DOMContentLoaded', function() {
     checkAdminAuth();
   });

   // Prevent form submission with Enter key in certain fields
   document.addEventListener('keydown', function(event) {
     if (event.key === 'Enter' && event.target.type !== 'submit' && event.target.tagName !== 'TEXTAREA') {
       event.preventDefault();
     }
   });
 </script>
</body>
</html>