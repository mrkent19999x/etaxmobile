<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>eTax Admin Panel - Qu·∫£n l√Ω h·ªá th·ªëng</title>
  <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      color: #333;
      line-height: 1.6;
    }

    /* Loading Screen */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: white;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .admin-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      display: none;
    }

    /* Header */
    .admin-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 20px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .admin-avatar {
      width: 60px;
      height: 60px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .admin-info h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .admin-role {
      opacity: 0.9;
      font-size: 14px;
    }

    .header-actions {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .logout-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      gap: 20px;
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
    }

    .stat-icon.users { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .stat-icon.tokens { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .stat-icon.devices { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .stat-icon.docs { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }

    .stat-content h3 {
      font-size: 32px;
      font-weight: 700;
      color: #333;
      margin-bottom: 5px;
    }

    .stat-content p {
      color: #666;
      font-size: 14px;
    }

    /* Navigation Tabs */
    .nav-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .nav-tab {
      padding: 12px 20px;
      background: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      color: #666;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .nav-tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      transform: translateY(-2px);
    }

    .nav-tab:hover:not(.active) {
      background: #f8f9fa;
      transform: translateY(-1px);
    }

    /* Section Cards */
    .section-card {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.08);
      margin-bottom: 30px;
    }

    .card-title {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Form Styles */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-label {
      font-weight: 600;
      margin-bottom: 8px;
      color: #555;
    }

    .form-input, .form-select {
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s;
      background: white;
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: #667eea;
    }

    /* Buttons */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    .btn-success { background: #28a745; color: white; }
    .btn-warning { background: #ffc107; color: #333; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-info { background: #17a2b8; color: white; }
    .btn-small { padding: 8px 16px; font-size: 14px; }

    /* Token Generator */
    .token-generator {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 20px;
    }

    .generated-token {
      background: rgba(255, 255, 255, 0.2);
      padding: 15px;
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      margin: 15px 0;
      word-break: break-all;
    }

    /* Tables */
    .table-container {
      overflow-x: auto;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.08);
      background: white;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 12px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
    }

    .data-table td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }

    .data-table tr:hover {
      background: #f8f9ff;
    }

    /* Upload Area */
    .upload-area {
      border: 3px dashed #d1ecf1;
      border-radius: 15px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
      margin-bottom: 20px;
    }

    .upload-area:hover {
      border-color: #5a67d8;
      background: linear-gradient(135deg, #f0f2ff 0%, #f8f9ff 100%);
      transform: translateY(-2px);
    }

    .upload-icon {
      font-size: 48px;
      color: #667eea;
      margin-bottom: 15px;
    }

    .file-info {
      background: linear-gradient(135deg, #e3f2fd 0%, #f8f9ff 100%);
      border-radius: 12px;
      padding: 20px;
      margin: 15px 0;
      border-left: 4px solid #2196f3;
      display: none;
    }

    .extraction-result {
      background: linear-gradient(135deg, #e8f5e8 0%, #f0fff0 100%);
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      border-left: 4px solid #28a745;
      display: none;
    }

    /* Notifications */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 10px;
      color: white;
      font-weight: 600;
      z-index: 10000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
      max-width: 400px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success { background: #28a745; }
    .notification.error { background: #dc3545; }
    .notification.warning { background: #ffc107; color: #333; }
    .notification.info { background: #17a2b8; }

    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal.show {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    /* Hidden sections */
    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .admin-container {
        padding: 15px;
      }

      .header-content {
        flex-direction: column;
        text-align: center;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .nav-tabs {
        flex-direction: column;
        gap: 5px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-spinner"></div>
    <p>ƒêang x√°c th·ª±c quy·ªÅn truy c·∫≠p...</p>
  </div>

  <div class="admin-container" id="adminContainer">
    <!-- Header -->
    <div class="admin-header">
      <div class="header-content">
        <div class="header-left">
          <div class="admin-avatar">
            <i class="fas fa-user-shield"></i>
          </div>
          <div class="admin-info">
            <h1 id="adminName">Admin Panel</h1>
            <div class="admin-role" id="adminRole">Super Administrator</div>
          </div>
        </div>
        <div class="header-actions">
          <span id="lastLogin" style="opacity: 0.8; font-size: 14px;"></span>
          <button class="logout-btn" onclick="logoutAdmin()">
            <i class="fas fa-sign-out-alt"></i>
            ƒêƒÉng xu·∫•t
          </button>
        </div>
      </div>
    </div>

    <!-- Stats Dashboard -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon users">
          <i class="fas fa-users"></i>
        </div>
        <div class="stat-content">
          <h3 id="totalUsers">0</h3>
          <p>T·ªïng ng∆∞·ªùi d√πng</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon tokens">
          <i class="fas fa-key"></i>
        </div>
        <div class="stat-content">
          <h3 id="activeTokens">0</h3>
          <p>Token ho·∫°t ƒë·ªông</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon devices">
          <i class="fas fa-mobile-alt"></i>
        </div>
        <div class="stat-content">
          <h3 id="totalDevices">0</h3>
          <p>Thi·∫øt b·ªã ƒë√£ x√°c th·ª±c</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon docs">
          <i class="fas fa-file-pdf"></i>
        </div>
        <div class="stat-content">
          <h3 id="totalDocuments">0</h3>
          <p>Ch·ª©ng t·ª´ PDF</p>
        </div>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="switchTab('users')">
        <i class="fas fa-users"></i> Qu·∫£n l√Ω ng∆∞·ªùi d√πng
      </button>
      <button class="nav-tab" onclick="switchTab('upload')">
        <i class="fas fa-cloud-upload-alt"></i> Upload ch·ª©ng t·ª´
      </button>
      <button class="nav-tab" onclick="switchTab('tokens')">
        <i class="fas fa-key"></i> Qu·∫£n l√Ω Token
      </button>
      <button class="nav-tab" onclick="switchTab('documents')">
        <i class="fas fa-file-pdf"></i> Ch·ª©ng t·ª´
      </button>
      <button class="nav-tab" onclick="switchTab('notifications')">
        <i class="fas fa-bell"></i> Th√¥ng b√°o
      </button>
      <button class="nav-tab" onclick="switchTab('activity')">
        <i class="fas fa-history"></i> Nh·∫≠t k√Ω ho·∫°t ƒë·ªông
      </button>
    </div>

    <!-- User Management Section -->
    <div id="users-section" class="section active">
      <div class="section-card">
        <h2 class="card-title">
          <i class="fas fa-user-plus"></i>
          T·∫°o t√†i kho·∫£n ng∆∞·ªùi d√πng m·ªõi
        </h2>

        <!-- Token Generator -->
        <div class="token-generator">
          <h3><i class="fas fa-key"></i> T·∫°o Device Token</h3>
          <p>Token n√†y s·∫Ω ƒë∆∞·ª£c li√™n k·∫øt v·ªõi t√†i kho·∫£n ng∆∞·ªùi d√πng</p>
          <div class="generated-token" id="generatedToken">
            Nh·∫•n "T·∫°o Token m·ªõi" ƒë·ªÉ t·∫°o token
          </div>
          <button type="button" class="btn btn-primary" onclick="generateToken()">
            <i class="fas fa-refresh"></i> T·∫°o Token m·ªõi
          </button>
        </div>

        <!-- User Form -->
        <form onsubmit="createNewUser(event)">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Device Token *</label>
              <input type="text" id="userToken" class="form-input" required readonly 
                     placeholder="Token s·∫Ω ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông">
            </div>
            <div class="form-group">
              <label class="form-label">M√£ s·ªë thu·∫ø (MST) *</label>
              <input type="text" id="userId" class="form-input" required 
                     placeholder="Nh·∫≠p m√£ s·ªë thu·∫ø">
            </div>
            <div class="form-group">
              <label class="form-label">M·∫≠t kh·∫©u *</label>
              <input type="password" id="userPassword" class="form-input" required 
                     placeholder="Nh·∫≠p m·∫≠t kh·∫©u">
            </div>
            <div class="form-group">
              <label class="form-label">H·ªç t√™n *</label>
              <input type="text" id="userFullName" class="form-input" required 
                     placeholder="Nh·∫≠p h·ªç t√™n ƒë·∫ßy ƒë·ªß">
            </div>
            <div class="form-group">
              <label class="form-label">ƒê·ªãa ch·ªâ</label>
              <input type="text" id="userAddress" class="form-input" 
                     placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ">
            </div>
            <div class="form-group">
              <label class="form-label">C·ª•c thu·∫ø</label>
              <input type="text" id="userTaxOffice" class="form-input" 
                     placeholder="Nh·∫≠p t√™n c·ª•c thu·∫ø">
            </div>
            <div class="form-group">
              <label class="form-label">Vai tr√≤</label>
              <select id="userRole" class="form-select">
                <option value="taxpayer">Ng∆∞·ªùi n·ªôp thu·∫ø</option>
                <option value="business">Doanh nghi·ªáp</option>
                <option value="individual">C√° nh√¢n</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Th·ªùi h·∫°n (ng√†y)</label>
              <input type="number" id="userDuration" class="form-input" value="365" 
                     min="1" max="3650" placeholder="S·ªë ng√†y c√≥ hi·ªáu l·ª±c">
            </div>
          </div>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-user-plus"></i> T·∫°o t√†i kho·∫£n
          </button>
        </form>
      </div>

      <!-- Users List -->
      <div class="section-card">
        <h2 class="card-title">
          <i class="fas fa-users"></i>
          Danh s√°ch ng∆∞·ªùi d√πng
        </h2>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>MST</th>
                <th>H·ªç t√™n</th>
                <th>Vai tr√≤</th>
                <th>Ng√†y t·∫°o</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <tr>
                <td colspan="6" style="text-align: center; padding: 40px;">
                  <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i d·ªØ li·ªáu...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Upload Section -->
    <div id="upload-section" class="section">
      <div class="section-card">
        <h2 class="card-title">
          <i class="fas fa-cloud-upload-alt"></i>
          Upload ch·ª©ng t·ª´ PDF
        </h2>

        <!-- File Upload Area -->
        <div class="upload-area" onclick="document.getElementById('pdfFile').click()">
          <div class="upload-icon">
            <i class="fas fa-cloud-upload-alt"></i>
          </div>
          <h3>Ch·ªçn file PDF</h3>
          <p>Nh·∫•n v√†o ƒë√¢y ƒë·ªÉ ch·ªçn file PDF ho·∫∑c k√©o th·∫£ file v√†o ƒë√¢y</p>
          <input type="file" id="pdfFile" accept=".pdf" style="display: none;" onchange="handleFileSelect(event)">
        </div>

        <!-- File Info -->
        <div id="fileInfo" class="file-info">
          <h4><i class="fas fa-file-pdf"></i> Th√¥ng tin file</h4>
          <p><strong>T√™n file:</strong> <span id="fileName"></span></p>
          <button type="button" class="btn btn-info" onclick="extractPDFData()">
            <i class="fas fa-search"></i> Ph√¢n t√≠ch PDF
          </button>
        </div>

        <!-- Extraction Results -->
        <div id="extractionResults" class="extraction-result">
          <h4><i class="fas fa-check-circle"></i> Th√¥ng tin ƒë∆∞·ª£c tr√≠ch xu·∫•t</h4>
          <div id="extractedData"></div>
        </div>

        <!-- Document Form -->
        <form onsubmit="uploadDocument(event)">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">M√£ tham chi·∫øu *</label>
              <input type="text" id="documentReference" class="form-input" required 
                     placeholder="M√£ tham chi·∫øu ch·ª©ng t·ª´">
            </div>
            <div class="form-group">
              <label class="form-label">Ng∆∞·ªùi n·ªôp thu·∫ø (MST) *</label>
              <select id="documentUser" class="form-select" required>
                <option value="">Ch·ªçn ng∆∞·ªùi d√πng</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Thu·∫ø TNCN</label>
              <input type="text" id="taxTNCN" class="form-input" 
                     placeholder="S·ªë ti·ªÅn thu·∫ø TNCN">
            </div>
            <div class="form-group">
              <label class="form-label">Thu·∫ø GTGT</label>
              <input type="text" id="taxGTGT" class="form-input" 
                     placeholder="S·ªë ti·ªÅn thu·∫ø GTGT">
            </div>
            <div class="form-group">
              <label class="form-label">T·ªïng s·ªë ti·ªÅn *</label>
              <input type="text" id="totalAmount" class="form-input" required 
                     placeholder="T·ªïng s·ªë ti·ªÅn" oninput="convertToWords()">
            </div>
            <div class="form-group">
              <label class="form-label">S·ªë ti·ªÅn b·∫±ng ch·ªØ</label>
              <input type="text" id="amountInWords" class="form-input" readonly 
                     placeholder="S·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông chuy·ªÉn ƒë·ªïi">
            </div>
            <div class="form-group">
              <label class="form-label">Ng√†y n·ªôp *</label>
              <input type="date" id="paymentDate" class="form-input" required>
            </div>
            <div class="form-group">
              <label class="form-label">Gi·ªù n·ªôp</label>
              <input type="time" id="paymentTime" class="form-input">
            </div>
            <div class="form-group">
              <label class="form-label">M√£ ƒêBHC</label>
              <input type="text" id="dbhcCode" class="form-input" 
                     placeholder="M√£ ƒëi·ªÅu tra - b·ªï ho√†n - chuy·ªÉn">
            </div>
            <div class="form-group">
              <label class="form-label">Tr·∫°ng th√°i</label>
              <select id="documentStatus" class="form-select">
                <option value="completed">Ho√†n th√†nh</option>
                <option value="pending">ƒêang x·ª≠ l√Ω</option>
                <option value="failed">Th·∫•t b·∫°i</option>
              </select>
            </div>
            <div class="form-group" style="grid-column: 1 / -1;">
              <label class="form-label">Ghi ch√∫</label>
              <textarea id="documentNotes" class="form-input" rows="3" 
                        placeholder="Ghi ch√∫ th√™m v·ªÅ ch·ª©ng t·ª´"></textarea>
            </div>
          </div>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> L∆∞u ch·ª©ng t·ª´
          </button>
        </form>
      </div>
    </div>

    <!-- Tokens Section -->
  <!-- Tokens Section -->
   <div id="tokens-section" class="section">
     <div class="section-card">
       <h2 class="card-title">
         <i class="fas fa-key"></i>
         Qu·∫£n l√Ω Device Token
       </h2>
       <div class="table-container">
         <table class="data-table">
           <thead>
             <tr>
               <th>Token</th>
               <th>Ng∆∞·ªùi d√πng li√™n k·∫øt</th>
               <th>Ng√†y t·∫°o</th>
               <th>Tr·∫°ng th√°i</th>
               <th>H·∫øt h·∫°n</th>
               <th>Thao t√°c</th>
             </tr>
           </thead>
           <tbody id="tokensTableBody">
             <tr>
               <td colspan="6" style="text-align: center; padding: 40px;">
                 <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i d·ªØ li·ªáu...
               </td>
             </tr>
           </tbody>
         </table>
       </div>
     </div>
   </div>

   <!-- Documents Section -->
   <div id="documents-section" class="section">
     <div class="section-card">
       <h2 class="card-title">
         <i class="fas fa-file-pdf"></i>
         Danh s√°ch ch·ª©ng t·ª´
       </h2>
       <div class="table-container">
         <table class="data-table">
           <thead>
             <tr>
               <th>M√£ tham chi·∫øu</th>
               <th>Ng∆∞·ªùi n·ªôp thu·∫ø</th>
               <th>S·ªë ti·ªÅn</th>
               <th>Ng√†y n·ªôp</th>
               <th>Tr·∫°ng th√°i</th>
               <th>Thao t√°c</th>
             </tr>
           </thead>
           <tbody id="documentsTableBody">
             <tr>
               <td colspan="6" style="text-align: center; padding: 40px;">
                 <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i d·ªØ li·ªáu...
               </td>
             </tr>
           </tbody>
         </table>
       </div>
     </div>
   </div>

   <!-- Notifications Section -->
   <div id="notifications-section" class="section">
     <div class="section-card">
       <h2 class="card-title">
         <i class="fas fa-bell"></i>
         G·ª≠i th√¥ng b√°o
       </h2>
       <form onsubmit="createNotification(event)">
         <div class="form-grid">
           <div class="form-group">
             <label class="form-label">Ng∆∞·ªùi nh·∫≠n *</label>
             <select id="notificationUser" class="form-select" required>
               <option value="">Ch·ªçn ng∆∞·ªùi d√πng</option>
               <option value="all">T·∫•t c·∫£ ng∆∞·ªùi d√πng</option>
             </select>
           </div>
           <div class="form-group">
             <label class="form-label">Lo·∫°i th√¥ng b√°o *</label>
             <select id="notificationType" class="form-select" required>
               <option value="info">Th√¥ng tin</option>
               <option value="warning">C·∫£nh b√°o</option>
               <option value="success">Th√†nh c√¥ng</option>
               <option value="error">L·ªói</option>
               <option value="transaction">Giao d·ªãch</option>
               <option value="account">T√†i kho·∫£n</option>
             </select>
           </div>
           <div class="form-group">
             <label class="form-label">Ti√™u ƒë·ªÅ *</label>
             <input type="text" id="notificationTitle" class="form-input" required 
                    placeholder="Ti√™u ƒë·ªÅ th√¥ng b√°o">
           </div>
           <div class="form-group">
             <label class="form-label">Th·ªùi gian</label>
             <input type="datetime-local" id="notificationDate" class="form-input">
           </div>
           <div class="form-group" style="grid-column: 1 / -1;">
             <label class="form-label">N·ªôi dung *</label>
             <textarea id="notificationContent" class="form-input" rows="4" required 
                       placeholder="N·ªôi dung th√¥ng b√°o"></textarea>
           </div>
           <div class="form-group">
             <label class="form-label">Ch·ª©ng t·ª´ li√™n quan</label>
             <input type="text" id="relatedDocument" class="form-input" 
                    placeholder="M√£ ch·ª©ng t·ª´ (n·∫øu c√≥)">
           </div>
         </div>
         <button type="submit" class="btn btn-primary">
           <i class="fas fa-paper-plane"></i> G·ª≠i th√¥ng b√°o
         </button>
       </form>
     </div>
   </div>

   <!-- Activity Log Section -->
   <div id="activity-section" class="section">
     <div class="section-card">
       <h2 class="card-title">
         <i class="fas fa-history"></i>
         Nh·∫≠t k√Ω ho·∫°t ƒë·ªông h·ªá th·ªëng
       </h2>
       <div class="table-container">
         <table class="data-table">
           <thead>
             <tr>
               <th>Th·ªùi gian</th>
               <th>Ho·∫°t ƒë·ªông</th>
               <th>User/Token</th>
               <th>Thi·∫øt b·ªã</th>
               <th>Chi ti·∫øt</th>
             </tr>
           </thead>
           <tbody id="activityTableBody">
             <tr>
               <td colspan="5" style="text-align: center; padding: 40px;">
                 <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i d·ªØ li·ªáu...
               </td>
             </tr>
           </tbody>
         </table>
       </div>
     </div>
   </div>
 </div>

 <!-- Edit User Modal -->
 <div id="editUserModal" class="modal">
   <div class="modal-content">
     <h3><i class="fas fa-edit"></i> Ch·ªânh s·ª≠a th√¥ng tin ng∆∞·ªùi d√πng</h3>
     <form onsubmit="updateUser(event)">
       <div class="form-group">
         <label class="form-label">H·ªç t√™n *</label>
         <input type="text" id="editUserName" class="form-input" required>
       </div>
       <div class="form-group">
         <label class="form-label">ƒê·ªãa ch·ªâ</label>
         <input type="text" id="editUserAddress" class="form-input">
       </div>
       <div class="form-group">
         <label class="form-label">C·ª•c thu·∫ø</label>
         <input type="text" id="editUserTaxOffice" class="form-input">
       </div>
       <div class="form-group">
         <label class="form-label">Vai tr√≤</label>
         <select id="editUserRole" class="form-select">
           <option value="taxpayer">Ng∆∞·ªùi n·ªôp thu·∫ø</option>
           <option value="business">Doanh nghi·ªáp</option>
           <option value="individual">C√° nh√¢n</option>
         </select>
       </div>
       <div style="display: flex; gap: 10px; margin-top: 20px;">
         <button type="submit" class="btn btn-primary">
           <i class="fas fa-save"></i> C·∫≠p nh·∫≠t
         </button>
         <button type="button" class="btn btn-secondary" onclick="closeModal('editUserModal')">
           <i class="fas fa-times"></i> H·ªßy
         </button>
       </div>
     </form>
   </div>
 </div>

 <script>
   // ===== FIREBASE CONFIGURATION =====
   const firebaseConfig = {
     apiKey: "AIzaSyC9kUYfuA1w7WXl9u-DJFXNvN7FWUmzFgc",
     authDomain: "etax-mobile-38a39.firebaseapp.com",
     databaseURL: "https://etax-mobile-38a39-default-rtdb.asia-southeast1.firebasedatabase.app",
     projectId: "etax-mobile-38a39",
     storageBucket: "etax-mobile-38a39.appspot.com",
     messagingSenderId: "908034763832",
     appId: "1:908034763832:web:8e8d7b66f7bcbf7a0e2f3e"
   };

   // Initialize Firebase
   firebase.initializeApp(firebaseConfig);
   const db = firebase.database();

   // ===== GLOBAL VARIABLES =====
   let currentAdminUser = null;
   let currentToken = '';
   let editingUserId = '';

   // ===== AUTHENTICATION AND INITIALIZATION =====
   async function checkAdminAuth() {
     const session = localStorage.getItem('etax_admin_session');
     
     if (!session) {
       window.location.href = 'admin-login.html';
       return;
     }

     try {
       currentAdminUser = JSON.parse(session);
       
       // Update UI
       document.getElementById('adminName').textContent = currentAdminUser.name;
       document.getElementById('adminRole').textContent = currentAdminUser.role;
       document.getElementById('lastLogin').textContent = 
         `ƒêƒÉng nh·∫≠p l·∫ßn cu·ªëi: ${new Date(currentAdminUser.lastLogin).toLocaleString('vi-VN')}`;

       // Hide loading screen and show admin panel
       document.getElementById('loadingScreen').style.display = 'none';
       document.getElementById('adminContainer').style.display = 'block';

       // Load initial data
       await loadDashboardStats();
       await loadUsers();
       await loadUserDropdown();
       await loadTokens();
       await loadDocuments();
       await loadActivityLog();
       setDefaultDateTime();
       setDefaultNotificationDate();

     } catch (error) {
       console.error('Auth error:', error);
       localStorage.removeItem('etax_admin_session');
       window.location.href = 'admin-login.html';
     }
   }

   // ===== NAVIGATION FUNCTIONS =====
   function switchTab(tabName) {
     // Hide all sections
     document.querySelectorAll('.section').forEach(section => {
       section.classList.remove('active');
     });

     // Remove active class from all tabs
     document.querySelectorAll('.nav-tab').forEach(tab => {
       tab.classList.remove('active');
     });

     // Show selected section
     document.getElementById(tabName + '-section').classList.add('active');

     // Add active class to clicked tab
     event.target.classList.add('active');

     // Load data for specific sections
     if (tabName === 'activity') {
       loadActivityLog();
     }
   }

   // ===== TOKEN MANAGEMENT =====
   function generateToken() {
     currentToken = 'ETAX' + Date.now().toString(36).toUpperCase() + 
                    Math.random().toString(36).substr(2, 5).toUpperCase();
     
     document.getElementById('generatedToken').textContent = currentToken;
     document.getElementById('userToken').value = currentToken;
     
     showNotification('üéâ Token m·ªõi ƒë√£ ƒë∆∞·ª£c t·∫°o: ' + currentToken, 'success');
   }

   // ===== NOTIFICATION HELPER FUNCTIONS =====
   async function createNotificationForUser(userId, notificationData) {
     try {
       const notificationId = db.ref().push().key;
       await db.ref(`notifications/${userId}/${notificationId}`).set({
         ...notificationData,
         createdAt: Date.now(),
         createdBy: currentAdminUser ? currentAdminUser.username : 'system'
       });
       
       console.log(`‚úÖ Notification created for user ${userId}`);
       return true;
       
     } catch (error) {
       console.error('Error creating notification for user:', error);
       return false;
     }
   }

   async function createTransactionNotification(documentData) {
     const success = await createNotificationForUser(documentData.taxpayerMST, {
       type: 'transaction',
       title: 'Giao d·ªãch n·ªôp thu·∫ø',
       content: `Ng∆∞·ªùi n·ªôp thu·∫ø ƒë√£ n·ªôp thu·∫ø th√†nh c√¥ng cho m√£ s·ªë thu·∫ø ${documentData.taxpayerMST}, m√£ tham chi·∫øu: ${documentData.mst}. S·ªë ti·ªÅn: ${documentData.amount} VND.`,
       timestamp: Date.now(),
       relatedDocument: documentData.mst
     });
     
     if (success) {
       console.log('‚úÖ Transaction notification sent');
     }
   }

   async function createAccountNotification(userId, createdDate) {
     const success = await createNotificationForUser(userId, {
       type: 'account',
       title: 'T√†i kho·∫£n giao d·ªãch thu·∫ø ƒëi·ªán t·ª≠',
       content: `T√†i kho·∫£n thu·∫ø ƒëi·ªán t·ª≠ c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng v√†o ng√†y ${createdDate}. B·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng d·ªãch v·ª• thu·∫ø ƒëi·ªán t·ª≠ ngay b√¢y gi·ªù.`,
       timestamp: Date.now(),
       relatedDocument: null
     });
     
     if (success) {
       console.log('‚úÖ Account notification sent');
     }
   }

   // ===== USER MANAGEMENT FUNCTIONS =====
   async function createNewUser(event) {
     event.preventDefault();
     
     const token = document.getElementById('userToken').value.trim();
     const userId = document.getElementById('userId').value.trim();
     const password = document.getElementById('userPassword').value.trim();
     const fullName = document.getElementById('userFullName').value.trim();
     const address = document.getElementById('userAddress').value.trim();
     const taxOffice = document.getElementById('userTaxOffice').value.trim();
     const role = document.getElementById('userRole').value;
     const duration = parseInt(document.getElementById('userDuration').value);

     if (!token || !userId || !password || !fullName) {
       showNotification('‚ùå Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!', 'error');
       return;
     }

     try {
       // Check if user already exists
       const userSnapshot = await db.ref('users/' + userId).once('value');
       if (userSnapshot.exists()) {
         showNotification('‚ùå MST n√†y ƒë√£ t·ªìn t·∫°i trong h·ªá th·ªëng!', 'error');
         return;
       }

       const now = Date.now();
       const expiresAt = now + (duration * 24 * 60 * 60 * 1000);

       // Create user data
       const userData = {
         mst: userId,
         password: password,
         name: fullName,
         address: address,
         taxoffice: taxOffice,
         role: role,
         date: new Date().toISOString().split('T')[0],
         duration: duration,
         createdAt: now,
         expiresAt: expiresAt,
         status: 'active',
         linkedToken: token,
         createdBy: currentAdminUser.username
       };

       // Create token data
       const tokenData = {
         linkedUserId: userId,
         createdAt: now,
         expiresAt: expiresAt,
         used: false,
         createdBy: currentAdminUser.username
       };

       // Save to Firebase
       await db.ref('users/' + userId).set(userData);
       await db.ref('deviceTokens/' + token).set(tokenData);

       // Send account notification
       const createdDate = new Date().toLocaleDateString('vi-VN');
       await createAccountNotification(userId, createdDate);

       // Log activity
       await db.ref('activityLogs').push({
         type: 'user_created',
         userId: userId,
         userName: fullName,
         token: token,
         timestamp: Date.now(),
         details: `Admin t·∫°o t√†i kho·∫£n m·ªõi cho ${fullName}`,
         admin: currentAdminUser.username
       });

       showNotification('üéâ T·∫°o t√†i kho·∫£n th√†nh c√¥ng! Token: ' + token, 'success');
       
       // Reset form
       document.querySelector('#users-section form').reset();
       document.getElementById('userDuration').value = '365';
       document.getElementById('generatedToken').textContent = 'Nh·∫•n "T·∫°o Token m·ªõi" ƒë·ªÉ t·∫°o token';
       document.getElementById('userToken').value = '';
       currentToken = '';
       
       // Reload data
       loadUsers();
       loadDashboardStats();
       loadUserDropdown();

     } catch (error) {
       console.error('Error creating user:', error);
       showNotification('‚ùå C√≥ l·ªói x·∫£y ra khi t·∫°o t√†i kho·∫£n: ' + error.message, 'error');
     }
   }

  async function loadUsers() {
  console.log('Starting to load users');
  try {
    const snapshot = await db.ref('users').once('value');
    const users = snapshot.val() || {};
    console.log('Users data fetched:', users);

    const tbody = document.getElementById('usersTableBody');
    if (!tbody) {
      console.error('Users table body element not found');
      return;
    }
    tbody.innerHTML = ''; // Clear initial "Loading..." message

    if (Object.keys(users).length === 0) {
      console.log('No users found in database');
      tbody.innerHTML = `
        <tr>
          <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
            <i class="fas fa-users" style="font-size: 48px; opacity: 0.3; margin-bottom: 10px; display: block;"></i>
            Ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o ƒë∆∞·ª£c t·∫°o
          </td>
        </tr>
      `;
    } else {
      Object.entries(users).forEach(([userId, userData]) => {
        const createdDate = userData.createdAt
          ? new Date(userData.createdAt).toLocaleDateString('vi-VN')
          : userData.date || 'N/A';
        const status = userData.status === 'active'
          ? '<span style="color: #28a745; font-weight: bold;">‚úÖ Ho·∫°t ƒë·ªông</span>'
          : '<span style="color: #dc3545; font-weight: bold;">‚ùå Kh√¥ng ho·∫°t ƒë·ªông</span>';

        const row = `
          <tr>
            <td><code>${userId}</code></td>
            <td><strong>${userData.name}</strong></td>
            <td><span class="badge">${userData.role || 'taxpayer'}</span></td>
            <td>${createdDate}</td>
            <td>${status}</td>
            <td>
              <div style="display: flex; gap: 5px;">
                <button class="btn btn-small btn-warning" onclick="editUser('${userId}')">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-small btn-danger" onclick="deleteUser('${userId}')">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
        tbody.innerHTML += row;
      });
      console.log('Users table updated successfully');
    }
  } catch (error) {
    console.error('Error loading users:', error);
    showNotification('‚ùå C√≥ l·ªói khi t·∫£i danh s√°ch ng∆∞·ªùi d√πng: ' + error.message, 'error');
  }
}

   async function loadUserDropdown() {
     try {
       const snapshot = await db.ref('users').once('value');
       const users = snapshot.val() || {};
       
       const dropdowns = ['documentUser', 'notificationUser'];
       
       dropdowns.forEach(dropdownId => {
         const dropdown = document.getElementById(dropdownId);
         if (!dropdown) return;
         
         // Clear existing options (keep first option)
         const firstOption = dropdown.firstElementChild;
         dropdown.innerHTML = '';
         dropdown.appendChild(firstOption);
         
         // Add "all users" option for notification dropdown
         if (dropdownId === 'notificationUser') {
           const allOption = document.createElement('option');
           allOption.value = 'all';
           allOption.textContent = 'T·∫•t c·∫£ ng∆∞·ªùi d√πng';
           dropdown.appendChild(allOption);
         }
         
         // Add user options
         Object.entries(users).forEach(([userId, userData]) => {
           const option = document.createElement('option');
           option.value = userId;
           option.textContent = `${userId} - ${userData.name}`;
           dropdown.appendChild(option);
         });
       });

     } catch (error) {
       console.error('Error loading user dropdown:', error);
     }
   }

   async function editUser(userId) {
     try {
       const snapshot = await db.ref('users/' + userId).once('value');
       const userData = snapshot.val();
       
       if (!userData) {
         showNotification('‚ùå Kh√¥ng t√¨m th·∫•y th√¥ng tin ng∆∞·ªùi d√πng', 'error');
         return;
       }

       // Fill form
       document.getElementById('editUserName').value = userData.name || '';
       document.getElementById('editUserAddress').value = userData.address || '';
       document.getElementById('editUserTaxOffice').value = userData.taxoffice || '';
       document.getElementById('editUserRole').value = userData.role || 'taxpayer';
       
       editingUserId = userId;
       showModal('editUserModal');

     } catch (error) {
       console.error('Error loading user for edit:', error);
       showNotification('‚ùå C√≥ l·ªói khi t·∫£i th√¥ng tin ng∆∞·ªùi d√πng', 'error');
     }
   }

   async function updateUser(event) {
     event.preventDefault();
     
     if (!editingUserId) {
       showNotification('‚ùå Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c ng∆∞·ªùi d√πng c·∫ßn c·∫≠p nh·∫≠t', 'error');
       return;
     }

     try {
       const updateData = {
         name: document.getElementById('editUserName').value.trim(),
         address: document.getElementById('editUserAddress').value.trim(),
         taxoffice: document.getElementById('editUserTaxOffice').value.trim(),
         role: document.getElementById('editUserRole').value,
         updatedAt: Date.now(),
         updatedBy: currentAdminUser.username
       };

       await db.ref('users/' + editingUserId).update(updateData);

       // Log activity
       await db.ref('activityLogs').push({
         type: 'user_updated',
         userId: editingUserId,
         timestamp: Date.now(),
         details: `Admin c·∫≠p nh·∫≠t th√¥ng tin user ${editingUserId}`,
         admin: currentAdminUser.username
       });

       showNotification('üéâ C·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi d√πng th√†nh c√¥ng!', 'success');
       closeModal('editUserModal');
       loadUsers();
       loadUserDropdown();

     } catch (error) {
       console.error('Error updating user:', error);
       showNotification('‚ùå C√≥ l·ªói khi c·∫≠p nh·∫≠t: ' + error.message, 'error');
     }
   }

   async function deleteUser(userId) {
     if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng∆∞·ªùi d√πng "${userId}"?\n\n‚ö†Ô∏è Thao t√°c n√†y s·∫Ω x√≥a:\n- T√†i kho·∫£n ng∆∞·ªùi d√πng\n- Token li√™n k·∫øt\n- T·∫•t c·∫£ ch·ª©ng t·ª´ c·ªßa ng∆∞·ªùi d√πng\n- D·ªØ li·ªáu kh√¥ng th·ªÉ kh√¥i ph·ª•c!`)) {
       return;
     }

     try {
       // Get user data first
       const userSnapshot = await db.ref('users/' + userId).once('value');
       const userData = userSnapshot.val();
       
       if (!userData) {
         showNotification('‚ùå Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng', 'error');
         return;
       }

       // Delete user
       await db.ref('users/' + userId).remove();
       
       // Delete linked token
       if (userData.linkedToken) {
         await db.ref('deviceTokens/' + userData.linkedToken).remove();
       }
       
       // Delete user's documents
       const documentsSnapshot = await db.ref('pdf_documents').orderByChild('taxpayerMST').equalTo(userId).once('value');
       if (documentsSnapshot.exists()) {
         const documents = documentsSnapshot.val();
         const deletePromises = Object.keys(documents).map(docId => 
           db.ref('pdf_documents/' + docId).remove()
         );
         await Promise.all(deletePromises);
       }
       
       // Delete user's notifications
       await db.ref('notifications/' + userId).remove();
       
       // Log deletion
       await db.ref('activityLogs').push({
         type: 'user_deleted',
         userId: userId,
         timestamp: Date.now(),
         details: `Admin x√≥a user ${userId} v√† t·∫•t c·∫£ d·ªØ li·ªáu li√™n quan`,
         admin: currentAdminUser.username
       });
       
       showNotification(`üéâ ƒê√£ x√≥a ng∆∞·ªùi d√πng "${userId}" v√† t·∫•t c·∫£ d·ªØ li·ªáu li√™n quan!`, 'success');
       loadUsers();
       loadDashboardStats();
       loadUserDropdown();
       loadTokens();
       loadDocuments();

     } catch (error) {
       console.error('Error deleting user:', error);
       showNotification('‚ùå C√≥ l·ªói khi x√≥a ng∆∞·ªùi d√πng: ' + error.message, 'error');
     }
   }

   // ===== DOCUMENT UPLOAD FUNCTIONS =====
   function handleFileSelect(event) {
     const file = event.target.files[0];
     if (file && file.type === 'application/pdf') {
       document.getElementById('fileName').textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
       document.getElementById('fileInfo').style.display = 'block';
       
       // Store file globally
       window.selectedPDFFile = file;
       
       showNotification('‚úÖ File PDF ƒë√£ ƒë∆∞·ª£c ch·ªçn. Nh·∫•n "Ph√¢n t√≠ch PDF" ƒë·ªÉ extract th√¥ng tin!', 'success');
     } else {
       showNotification('‚ùå Vui l√≤ng ch·ªçn file PDF h·ª£p l·ªá!', 'error');
     }
   }

   async function extractPDFData() {
     if (!window.selectedPDFFile) {
       showNotification('‚ùå Vui l√≤ng ch·ªçn file PDF tr∆∞·ªõc!', 'error');
       return;
     }

     showNotification('‚è≥ ƒêang ph√¢n t√≠ch PDF...', 'info');

     // Mock data extraction (trong th·ª±c t·∫ø c·∫ßn PDF.js)
     setTimeout(() => {
       const mockData = {
         reference: 'TAX' + Date.now().toString().slice(-8),
         amount: '5000000',
         taxTNCN: '500000',
         taxGTGT: '1000000',
         date: new Date().toISOString().split('T')[0],
         time: '14:30',
         dbhc: 'DBHC001'
       };

       // Fill form with extracted data
       document.getElementById('documentReference').value = mockData.reference;
       document.getElementById('totalAmount').value = mockData.amount;
       document.getElementById('taxTNCN').value = mockData.taxTNCN;
       document.getElementById('taxGTGT').value = mockData.taxGTGT;
       document.getElementById('paymentDate').value = mockData.date;
       document.getElementById('paymentTime').value = mockData.time;
       document.getElementById('dbhcCode').value = mockData.dbhc;

       // Convert amount to words
       convertToWords();

       // Show results
       document.getElementById('extractedData').innerHTML = `
         <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
           <div style="background: white; padding: 10px; border-radius: 8px; border-left: 3px solid #28a745;">
             <strong>M√£ tham chi·∫øu:</strong> ${mockData.reference}
           </div>
           <div style="background: white; padding: 10px; border-radius: 8px; border-left: 3px solid #28a745;">
             <strong>T·ªïng ti·ªÅn:</strong> ${parseInt(mockData.amount).toLocaleString('vi-VN')} VND
           </div>
           <div style="background: white; padding: 10px; border-radius: 8px; border-left: 3px solid #28a745;">
             <strong>Thu·∫ø TNCN:</strong> ${parseInt(mockData.taxTNCN).toLocaleString('vi-VN')} VND
           </div>
           <div style="background: white; padding: 10px; border-radius: 8px; border-left: 3px solid #28a745;">
             <strong>Ng√†y n·ªôp:</strong> ${new Date(mockData.date).toLocaleDateString('vi-VN')}
           </div>
         </div>
       `;
       document.getElementById('extractionResults').style.display = 'block';

       showNotification('üéâ Ph√¢n t√≠ch PDF th√†nh c√¥ng! D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c ƒëi·ªÅn v√†o form.', 'success');
     }, 2000);
   }

   async function uploadDocument(event) {
     event.preventDefault();
     
     if (!window.selectedPDFFile) {
       showNotification('‚ùå Vui l√≤ng ch·ªçn file PDF tr∆∞·ªõc!', 'error');
       return;
     }
     
     const documentData = {
       mst: document.getElementById('documentReference').value.trim(),
       taxpayerMST: document.getElementById('documentUser').value,
       taxTNCN: document.getElementById('taxTNCN').value.trim(),
       taxGTGT: document.getElementById('taxGTGT').value.trim(),
       amount: document.getElementById('totalAmount').value.trim(),
       amountInWords: document.getElementById('amountInWords').value.trim(),
       date: document.getElementById('paymentDate').value,
       time: document.getElementById('paymentTime').value,
       dbhc: document.getElementById('dbhcCode').value.trim(),
       status: document.getElementById('documentStatus').value,
       notes: document.getElementById('documentNotes').value.trim(),
       uploadDate: new Date().toISOString(),
       uploadedBy: currentAdminUser.username,
       type: 'tax_payment_document'
     };
     
     if (!documentData.mst || !documentData.taxpayerMST) {
       showNotification('‚ùå Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!', 'error');
       return;
     }
     
     try {
       showNotification('‚è≥ ƒêang l∆∞u ch·ª©ng t·ª´...', 'info');
       
       // Save document to Firebase
       await db.ref('pdf_documents/' + documentData.mst).set(documentData);
       
       // Send notification to user
       await createTransactionNotification(documentData);
       
       // Log activity
       await db.ref('activityLogs').push({
         type: 'document_uploaded',
         documentId: documentData.mst,
         userId: documentData.taxpayerMST,
         timestamp: Date.now(),
         details: `Upload ch·ª©ng t·ª´ ${documentData.mst} cho user ${documentData.taxpayerMST}`,
         admin: currentAdminUser.username
       });
       
       showNotification('üéâ L∆∞u ch·ª©ng t·ª´ th√†nh c√¥ng!', 'success');
       
       // Reset form
       document.querySelector('#upload-section form').reset();
       document.getElementById('fileInfo').style.display = 'none';
       document.getElementById('extractionResults').style.display = 'none';
       window.selectedPDFFile = null;
       setDefaultDateTime();
       
       // Reload data
       loadDocuments();
       loadDashboardStats();
       
     } catch (error) {
       console.error('Error uploading document:', error);
       showNotification('‚ùå C√≥ l·ªói khi l∆∞u ch·ª©ng t·ª´: ' + error.message, 'error');
     }
   }

   // ===== NOTIFICATION MANAGEMENT =====
   async function createNotification(event) {
     event.preventDefault();
     
     const userId = document.getElementById('notificationUser').value;
     const type = document.getElementById('notificationType').value;
     const title = document.getElementById('notificationTitle').value.trim();
     const content = document.getElementById('notificationContent').value.trim();
     const date = document.getElementById('notificationDate').value;
     const relatedDocument = document.getElementById('relatedDocument').value.trim();
     
     if (!userId || !title || !content) {
       showNotification('‚ùå Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!', 'error');
       return;
     }
     
     try {
       const notificationData = {
         type: type,
         title: title,
         content: content,
         timestamp: date ? new Date(date).getTime() : Date.now(),
         createdBy: currentAdminUser.username,
         createdAt: Date.now(),
         relatedDocument: relatedDocument || null
       };
       
       if (userId === 'all') {
         // Send to all users
         const usersSnapshot = await db.ref('users').once('value');
         const users = usersSnapshot.val() || {};
         
         const promises = Object.keys(users).map(async (userMst) => {
           const notificationId = db.ref().push().key;
           return db.ref(`notifications/${userMst}/${notificationId}`).set(notificationData);
         });
         
         await Promise.all(promises);
         
         showNotification(`üéâ ƒê√£ g·ª≠i th√¥ng b√°o cho ${Object.keys(users).length} ng∆∞·ªùi d√πng!`, 'success');
         
       } else {
         // Send to specific user
         const notificationId = db.ref().push().key;
         await db.ref(`notifications/${userId}/${notificationId}`).set(notificationData);
         
         showNotification(`üéâ ƒê√£ g·ª≠i th√¥ng b√°o cho user ${userId}!`, 'success');
       }
       
       // Log activity
       await db.ref('activityLogs').push({
         type: 'notification_sent',
         targetUser: userId,
         notificationTitle: title,
         timestamp: Date.now(),
         details: `Admin g·ª≠i th√¥ng b√°o "${title}" cho ${userId === 'all' ? 't·∫•t c·∫£ ng∆∞·ªùi d√πng' : userId}`,
         admin: currentAdminUser.username
       });
       
       // Reset form
       document.querySelector('#notifications-section form').reset();
       setDefaultNotificationDate();
       
     } catch (error) {
       console.error('Error creating notification:', error);
       showNotification('‚ùå C√≥ l·ªói khi g·ª≠i th√¥ng b√°o: ' + error.message, 'error');
     }
   }

   function setDefaultNotificationDate() {
     const now = new Date();
     const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
     document.getElementById('notificationDate').value = localDateTime;
   }

   // ===== DATA LOADING FUNCTIONS =====
   async function loadDashboardStats() {
     try {
       const [usersSnapshot, tokensSnapshot, documentsSnapshot] = await Promise.all([
         db.ref('users').once('value'),
         db.ref('deviceTokens').once('value'),
         db.ref('pdf_documents').once('value')
       ]);

       const users = usersSnapshot.val() || {};
       const tokens = tokensSnapshot.val() || {};
       const documents = documentsSnapshot.val() || {};

       const totalUsers = Object.keys(users).length;
       const activeTokens = Object.values(tokens).filter(token => !token.used).length;
       const totalDevices = Object.values(tokens).filter(token => token.used).length;
       const totalDocuments = Object.keys(documents).length;

       document.getElementById('totalUsers').textContent = totalUsers;
       document.getElementById('activeTokens').textContent = activeTokens;
       document.getElementById('totalDevices').textContent = totalDevices;
       document.getElementById('totalDocuments').textContent = totalDocuments;

     } catch (error) {
       console.error('Error loading dashboard stats:', error);
     }
   }

   async function loadTokens() {
     try {
       const snapshot = await db.ref('deviceTokens').once('value');
       const tokens = snapshot.val() || {};
       
       const tbody = document.getElementById('tokensTableBody');
       tbody.innerHTML = '';

       if (Object.keys(tokens).length === 0) {
         tbody.innerHTML = `
           <tr>
             <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
               <i class="fas fa-key" style="font-size: 48px; opacity: 0.3; margin-bottom: 10px; display: block;"></i>
               Ch∆∞a c√≥ token n√†o ƒë∆∞·ª£c t·∫°o
             </td>
           </tr>
         `;
         return;
       }

       Object.entries(tokens).forEach(([tokenId, tokenData]) => {
         const createdDate = new Date(tokenData.createdAt || Date.now()).toLocaleDateString('vi-VN');
         const expiresDate = new Date(tokenData.expiresAt || Date.now()).toLocaleDateString('vi-VN');
         
         const status = tokenData.used ? 
           '<span style="color: #28a745; font-weight: bold;">‚úÖ ƒê√£ s·ª≠ d·ª•ng</span>' : 
           '<span style="color: #ffc107; font-weight: bold;">‚è≥ Ch∆∞a s·ª≠ d·ª•ng</span>';

         const linkedUser = tokenData.linkedUserId || 'Ch∆∞a li√™n k·∫øt';

         const row = `
           <tr>
             <td><code style="font-size: 12px;">${tokenId.slice(0, 20)}...</code></td>
             <td><strong>${linkedUser}</strong></td>
             <td>${createdDate}</td>
             <td>${status}</td>
             <td>${expiresDate}</td>
             <td>
               <button class="btn btn-small btn-info" onclick="viewTokenDetails('${tokenId}')">
                 <i class="fas fa-eye"></i>
               </button>
             </td>
           </tr>
         `;
         tbody.innerHTML += row;
       });

     } catch (error) {
       console.error('Error loading tokens:', error);
       showNotification('‚ùå C√≥ l·ªói khi t·∫£i danh s√°ch token', 'error');
     }
   }

   async function loadDocuments() {
     try {
       const snapshot = await db.ref('pdf_documents').once('value');
       const documents = snapshot.val() || {};
       
       const tbody = document.getElementById('documentsTableBody');
       tbody.innerHTML = '';

       if (Object.keys(documents).length === 0) {
         tbody.innerHTML = `
           <tr>
             <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
               <i class="fas fa-file-pdf" style="font-size: 48px; opacity: 0.3; margin-bottom: 10px; display: block;"></i>
               Ch∆∞a c√≥ ch·ª©ng t·ª´ n√†o ƒë∆∞·ª£c upload
             </td>
           </tr>
         `;
         return;
       }

       Object.entries(documents).forEach(([docId, docData]) => {
         const uploadDate = docData.uploadDate ? 
           new Date(docData.uploadDate).toLocaleDateString('vi-VN') : 
           docData.date || 'N/A';
         
         const amount = docData.amount ? 
           parseInt(docData.amount).toLocaleString('vi-VN') + ' VND' : 
           'N/A';

         const status = docData.status === 'completed' ? 
           '<span style="color: #28a745; font-weight: bold;">‚úÖ Ho√†n th√†nh</span>' : 
           docData.status === 'pending' ? 
           '<span style="color: #ffc107; font-weight: bold;">‚è≥ ƒêang x·ª≠ l√Ω</span>' :
           '<span style="color: #dc3545; font-weight: bold;">‚ùå Th·∫•t b·∫°i</span>';

         const row = `
           <tr>
             <td><code>${docData.mst || docId}</code></td>
             <td><strong>${docData.taxpayerMST}</strong></td>
             <td>${amount}</td>
             <td>${uploadDate}</td>
             <td>${status}</td>
             <td>
               <div style="display: flex; gap: 5px;">
                 <button class="btn btn-small btn-info" onclick="viewDocument('${docId}')">
                   <i class="fas fa-eye"></i>
                 </button>
                 <button class="btn btn-small btn-danger" onclick="deleteDocument('${docId}')">
                   <i class="fas fa-trash"></i>
                 </button>
               </div>
             </td>
           </tr>
         `;
         tbody.innerHTML += row;
       });

     } catch (error) {
       console.error('Error loading documents:', error);
       showNotification('‚ùå C√≥ l·ªói khi t·∫£i danh s√°ch ch·ª©ng t·ª´', 'error');
     }
   }

   async function loadActivityLog() {
     try {
       const snapshot = await db.ref('activityLogs').orderByChild('timestamp').limitToLast(100).once('value');
       const logs = snapshot.val() || {};
       
       const tbody = document.getElementById('activityTableBody');
       tbody.innerHTML = '';

       if (Object.keys(logs).length === 0) {
         tbody.innerHTML = `
           <tr>
             <td colspan="5" style="text-align: center; padding: 40px; color: #666;">
               <i class="fas fa-history" style="font-size: 48px; opacity: 0.3; margin-bottom: 10px; display: block;"></i>
               Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o ƒë∆∞·ª£c ghi nh·∫≠n
             </td>
           </tr>
         `;
         return;
       }

       // Convert to array and sort by timestamp (newest first)
       const logsArray = Object.entries(logs).map(([id, data]) => ({ id, ...data }));
       logsArray.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

       logsArray.forEach((logData) => {
         const timestamp = new Date(logData.timestamp || Date.now()).toLocaleString('vi-VN');
         const activityType = getActivityIcon(logData.type);
         const deviceInfo = logData.deviceId ? 
           logData.deviceId.slice(0, 20) + '...' : 'N/A';
         
         const row = `
           <tr>
             <td>${timestamp}</td>
             <td>
               <span class="activity-badge ${logData.type}" style="
                 background: #f8f9fa; 
                 color: #333; 
                 padding: 4px 8px; 
                 border-radius: 12px; 
                 font-size: 12px; 
                 font-weight: 600;
                 border-left: 3px solid #667eea;
               ">
                 ${activityType.icon} ${activityType.text}
               </span>
             </td>
             <td><code>${logData.token || logData.userId || 'N/A'}</code></td>
             <td style="font-size: 12px;">${deviceInfo}</td>
             <td>${logData.details || ''}</td>
           </tr>
         `;
         tbody.innerHTML += row;
       });

     } catch (error) {
       console.error('Error loading activity log:', error);
       showNotification('‚ùå C√≥ l·ªói khi t·∫£i nh·∫≠t k√Ω ho·∫°t ƒë·ªông', 'error');
     }
   }

   function getActivityIcon(type) {
     const types = {
       'token_activated': { icon: 'üîì', text: 'Token ƒë∆∞·ª£c k√≠ch ho·∫°t' },
       'token_revoked': { icon: 'üö´', text: 'Token b·ªã thu h·ªìi' },
       'user_login': { icon: 'üîë', text: 'ƒêƒÉng nh·∫≠p' },
       'user_logout': { icon: 'üö™', text: 'ƒêƒÉng xu·∫•t' },
       'user_created': { icon: 'üë§', text: 'T·∫°o t√†i kho·∫£n' },
       'user_updated': { icon: '‚úèÔ∏è', text: 'C·∫≠p nh·∫≠t th√¥ng tin' },
       'user_deleted': { icon: 'üóëÔ∏è', text: 'X√≥a t√†i kho·∫£n' },
       'document_uploaded': { icon: 'üìÑ', text: 'Upload ch·ª©ng t·ª´' },
       'document_deleted': { icon: 'üóëÔ∏è', text: 'X√≥a ch·ª©ng t·ª´' },
       'notification_sent': { icon: 'üì¢', text: 'G·ª≠i th√¥ng b√°o' },
       'device_linked': { icon: 'üì±', text: 'Li√™n k·∫øt thi·∫øt b·ªã' },
       'direct_user_access': { icon: 'üîó', text: 'Truy c·∫≠p tr·ª±c ti·∫øp' },
       'password_changed': { icon: 'üîê', text: 'ƒê·ªïi m·∫≠t kh·∫©u' }
     };
     return types[type] || { icon: 'üìù', text: 'Ho·∫°t ƒë·ªông kh√°c' };
   }

   // ===== UTILITY FUNCTIONS =====
   function convertToWords() {
     const amount = document.getElementById('totalAmount').value.trim();
     if (!amount || isNaN(amount)) {
       document.getElementById('amountInWords').value = '';
       return;
     }

     const words = convertNumberToWords(parseInt(amount));
     document.getElementById('amountInWords').value = words;
   }

   function convertNumberToWords(amount) {
     if (amount === 0) return "kh√¥ng ƒë·ªìng";
     
     const ones = ["", "m·ªôt", "hai", "ba", "b·ªën", "nƒÉm", "s√°u", "b·∫£y", "t√°m", "ch√≠n"];
     const tens = ["", "", "hai m∆∞∆°i", "ba m∆∞∆°i", "b·ªën m∆∞∆°i", "nƒÉm m∆∞∆°i", "s√°u m∆∞∆°i", "b·∫£y m∆∞∆°i", "t√°m m∆∞∆°i", "ch√≠n m∆∞∆°i"];
     
     function convertThreeDigits(num) {
       let result = "";
       const hundreds = Math.floor(num / 100);
       const remainder = num % 100;
       const tensDigit = Math.floor(remainder / 10);
       const onesDigit = remainder % 10;
       
       if (hundreds > 0) {
         result += ones[hundreds] + " trƒÉm";
         if (remainder > 0) result += " ";
       }
       
       if (tensDigit >= 2) {
         result += tens[tensDigit];
         if (onesDigit > 0) {
           result += " " + ones[onesDigit];
         }
       } else if (tensDigit === 1) {
         result += "m∆∞·ªùi";
         if (onesDigit > 0) {
           result += " " + ones[onesDigit];
         }
       } else if (onesDigit > 0) {
         result += ones[onesDigit];
       }
       
       return result;
     }
     
     if (amount < 1000) {
       return convertThreeDigits(amount) + " ƒë·ªìng";
     } else if (amount < 1000000) {
       const thousands = Math.floor(amount / 1000);
       const remainder = amount % 1000;
       let result = convertThreeDigits(thousands) + " ngh√¨n";
       if (remainder > 0) result += " " + convertThreeDigits(remainder);
       return result + " ƒë·ªìng";
     } else if (amount < 1000000000) {
       const millions = Math.floor(amount / 1000000);
       const remainder = amount % 1000000;
       let result = convertThreeDigits(millions) + " tri·ªáu";
       if (remainder > 0) {
         if (remainder >= 1000) {
           const thousands = Math.floor(remainder / 1000);
           const lastThree = remainder % 1000;
           result += " " + convertThreeDigits(thousands) + " ngh√¨n";
           if (lastThree > 0) result += " " + convertThreeDigits(lastThree);
         } else {
           result += " " + convertThreeDigits(remainder);
         }
       }
       return result + " ƒë·ªìng";
     }
     
     return amount.toLocaleString('vi-VN') + " ƒë·ªìng";
   }

   function setDefaultDateTime() {
     const now = new Date();
     const localDate = now.toISOString().split('T')[0];
     const localTime = now.toTimeString().slice(0, 5);
     
     document.getElementById('paymentDate').value = localDate;
     document.getElementById('paymentTime').value = localTime;
   }

   function viewDocument(mst) {
     window.open(`xem-chung-tu.html?mst=${mst}`, '_blank');
   }

   function viewTokenDetails(tokenId) {
     showNotification(`Token: ${tokenId}`, 'info');
   }

   async function deleteDocument(mst) {
     if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ch·ª©ng t·ª´ "${mst}"?\n\nThao t√°c n√†y kh√¥ng th·ªÉ ho√†n t√°c.`)) {
       return;
     }

     try {
       await db.ref('pdf_documents/' + mst).remove();
       
       // Log deletion
       await db.ref('activityLogs').push({
         type: 'document_deleted',
         documentId: mst,
         admin: currentAdminUser.username,
         timestamp: Date.now(),
         details: `X√≥a ch·ª©ng t·ª´ ${mst}`
       });
       
       showNotification(`üéâ ƒê√£ x√≥a ch·ª©ng t·ª´ "${mst}" th√†nh c√¥ng!`, 'success');
       loadDocuments();
       loadDashboardStats();
       
     } catch (error) {
       console.error('Error deleting document:', error);
       showNotification('‚ùå C√≥ l·ªói khi x√≥a ch·ª©ng t·ª´: ' + error.message, 'error');
     }
   }

   // ===== LOGOUT FUNCTION =====
   function logoutAdmin() {
     if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t kh·ªèi admin panel?')) {
       // Log logout
       db.ref('activityLogs').push({
         type: 'admin_logout',
         admin: currentAdminUser.username,
         timestamp: Date.now(),
         details: `Admin ${currentAdminUser.username} ƒëƒÉng xu·∫•t`
       });
       
       localStorage.removeItem('etax_admin_session');
       showNotification('üéâ ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!', 'success');
       setTimeout(() => {
         window.location.href = 'admin-login.html';
       }, 1500);
     }
   }

   // ===== MODAL FUNCTIONS =====
   function showModal(modalId) {
     document.getElementById(modalId).classList.add('show');
   }

   function closeModal(modalId) {
     document.getElementById(modalId).classList.remove('show');
     editingUserId = '';
   }

   // ===== NOTIFICATION SYSTEM =====
   function showNotification(message, type = 'info') {
     // Remove existing notifications
     const existingNotifications = document.querySelectorAll('.notification');
     existingNotifications.forEach(notif => notif.remove());

     const notification = document.createElement('div');
     notification.className = `notification ${type}`;
     notification.innerHTML = `
       <div style="display: flex; align-items: center; gap: 10px;">
         <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
         <span style="white-space: pre-line;">${message}</span>
       </div>
     `;

     document.body.appendChild(notification);

     // Show notification
     setTimeout(() => notification.classList.add('show'), 100);

     // Auto hide after 5 seconds
     setTimeout(() => {
       notification.classList.remove('show');
       setTimeout(() => notification.remove(), 300);
     }, 5000);
   }

   // ===== EVENT LISTENERS =====
   document.addEventListener('click', function(event) {
     if (event.target.classList.contains('modal')) {
       closeModal(event.target.id);
     }
   });

   document.addEventListener('keydown', function(event) {
     if (event.key === 'Escape') {
       const openModal = document.querySelector('.modal.show');
       if (openModal) {
         closeModal(openModal.id);
       }
     }
   });

   // Auto-refresh data every 60 seconds
   setInterval(() => {
     if (document.visibilityState === 'visible') {
       loadDashboardStats();
     }
   }, 60000);

   // Check session validity every 5 minutes
   setInterval(() => {
     checkAdminAuth();
   }, 5 * 60 * 1000);

   // ===== INITIALIZE APPLICATION =====
   document.addEventListener('DOMContentLoaded', function() {
     checkAdminAuth();
   });

   // Prevent form submission with Enter key in certain fields
   document.addEventListener('keydown', function(event) {
     if (event.key === 'Enter' && event.target.type !== 'submit' && event.target.tagName !== 'TEXTAREA') {
       event.preventDefault();
     }
   });
 </script>
</body>
</html>