<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>eTax Admin Panel - Hệ thống quản lý</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  
  <style>
  /* Thêm vào phần CSS của admin-panel.html */

/* Extraction results styling */
.extraction-result {
    background: linear-gradient(135deg, #e8f5e8 0%, #f0fff0 100%);
    border-radius: 15px;
    padding: 20px;
    margin: 20px 0;
    border-left: 4px solid #28a745;
}

.extraction-items {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 10px;
}

.extraction-item {
    background: white;
    padding: 10px 15px;
    border-radius: 8px;
    font-size: 14px;
    border-left: 3px solid #28a745;
}

/* Upload area enhancements */
.upload-area {
    border: 2px dashed #667eea;
    border-radius: 15px;
    padding: 40px;
    text-align: center;
    background: linear-gradient(135deg, #f8f9ff 0%, #fff 100%);
    transition: all 0.3s ease;
    cursor: pointer;
}

.upload-area:hover {
    border-color: #5a67d8;
    background: linear-gradient(135deg, #f0f2ff 0%, #f8f9ff 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
}

.upload-area.dragover {
    border-color: #4c51bf;
    background: linear-gradient(135deg, #e6fffa 0%, #f0fff4 100%);
    border-style: solid;
}

.file-info {
    background: linear-gradient(135deg, #e3f2fd 0%, #f8f9ff 100%);
    border-radius: 12px;
    padding: 20px;
    margin: 15px 0;
    border-left: 4px solid #2196f3;
}

/* Activity log styling */
.activity-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.activity-badge.token_activated {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    color: #155724;
    border: 1px solid #c3e6cb;
}

.activity-badge.user_login {
    background: linear-gradient(135deg, #cce5ff 0%, #b3d7ff 100%);
    color: #004085;
    border: 1px solid #b3d7ff;
}

/* Enhanced document management */
.document-preview {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin: 15px 0;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
}

.document-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 15px;
    border-bottom: 2px solid #f0f0f0;
    margin-bottom: 15px;
}

.document-amount {
    font-size: 24px;
    font-weight: bold;
    color: #28a745;
}

.document-status-success {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      color: #333;
      line-height: 1.6;
    }

    /* Loading Screen */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: white;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .admin-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      display: none;
    }

    /* Header với thông tin admin */
    .admin-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 20px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      position: relative;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .admin-avatar {
      width: 60px;
      height: 60px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .admin-info h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .admin-role {
      opacity: 0.9;
      font-size: 14px;
    }

    .header-actions {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .logout-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      cursor: pointer;
      transition: background 0.3s;
      font-weight: 500;
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* Stats Dashboard */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      gap: 20px;
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
    }

    .stat-icon.users { background: linear-gradient(45deg, #667eea, #764ba2); }
    .stat-icon.tokens { background: linear-gradient(45deg, #f093fb, #f5576c); }
    .stat-icon.devices { background: linear-gradient(45deg, #4facfe, #00f2fe); }
    .stat-icon.docs { background: linear-gradient(45deg, #43e97b, #38f9d7); }

    .stat-content h3 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 5px;
      color: #333;
    }

    .stat-content p {
      color: #666;
      font-size: 14px;
    }

    /* Navigation Tabs */
    .nav-tabs {
      display: flex;
      background: white;
      border-radius: 15px;
      padding: 8px;
      margin-bottom: 30px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      overflow-x: auto;
    }

    .nav-tab {
      flex: 1;
      padding: 15px 25px;
      background: transparent;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      white-space: nowrap;
      min-width: 140px;
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
    }

    .nav-tab.active {
      background: #667eea;
      color: white;
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    .nav-tab:hover:not(.active) {
      background: #f0f0f0;
    }

    /* Content Sections */
    .content-section {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .content-section.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Cards */
    .card {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .card-title {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Form Styles */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-label {
      font-weight: 600;
      margin-bottom: 8px;
      color: #555;
    }

    .form-input {
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    .form-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-select {
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      background: white;
      cursor: pointer;
    }

    /* Buttons */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #f8f9fa;
      color: #333;
      border: 2px solid #e0e0e0;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-warning {
      background: #ffc107;
      color: #333;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-info {
      background: #17a2b8;
      color: white;
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 14px;
    }

    /* Token Generator */
    .token-generator {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 20px;
    }

    .generated-token {
      background: rgba(255, 255, 255, 0.2);
      padding: 15px;
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      margin: 15px 0;
      word-break: break-all;
      position: relative;
    }

    .copy-token-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.3);
      border: none;
      color: white;
      padding: 8px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .copy-token-btn:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    /* User Management Table */
    .users-table-container {
      overflow-x: auto;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    .users-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      min-width: 900px;
    }

    .users-table th,
    .users-table td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    .users-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #555;
      position: sticky;
      top: 0;
      font-size: 14px;
    }

    .users-table tr:hover {
      background: #f8f9fa;
    }

    .user-status {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-active {
      background: #d4edda;
      color: #155724;
    }

    .status-inactive {
      background: #f8d7da;
      color: #721c24;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .user-actions {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }

    .action-tooltip {
      position: relative;
    }

    .action-tooltip:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 1000;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      backdrop-filter: blur(5px);
    }

    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 22px;
      font-weight: 600;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s;
    }

    .close-btn:hover {
      background: #f0f0f0;
    }

    /* Notifications */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      z-index: 2000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
      max-width: 350px;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      border-left: 4px solid #28a745;
    }

    .notification.error {
      border-left: 4px solid #dc3545;
    }

    .notification.warning {
      border-left: 4px solid #ffc107;
    }

    .notification.info {
      border-left: 4px solid #17a2b8;
    }

    /* Password visibility toggle */
    .password-group {
      position: relative;
    }

    .password-toggle {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      padding: 5px;
    }

    /* ===== MỚI THÊM: ACTIVITY LOG STYLES ===== */
    .activity-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .activity-badge.token_activated {
      background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .activity-badge.user_login {
      background: linear-gradient(135deg, #cce5ff 0%, #b3d7ff 100%);
      color: #004085;
      border: 1px solid #b3d7ff;
    }

    .activity-badge.direct_user_access {
      background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .activity-badge.token_revoked {
      background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    /* ===== MỚI THÊM: UPLOAD PDF STYLES ===== */
    .upload-area {
      border: 2px dashed #667eea;
      border-radius: 15px;
      padding: 40px;
      text-align: center;
      background: linear-gradient(135deg, #f8f9ff 0%, #fff 100%);
      transition: all 0.3s ease;
      cursor: pointer;
      margin-bottom: 20px;
    }

    .upload-area:hover {
      border-color: #5a67d8;
      background: linear-gradient(135deg, #f0f2ff 0%, #f8f9ff 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
    }

    .upload-area.dragover {
      border-color: #4c51bf;
      background: linear-gradient(135deg, #e6fffa 0%, #f0fff4 100%);
      border-style: solid;
    }

    .upload-icon {
      font-size: 48px;
      color: #667eea;
      margin-bottom: 15px;
    }

    .file-info {
      background: linear-gradient(135deg, #e3f2fd 0%, #f8f9ff 100%);
      border-radius: 12px;
      padding: 20px;
      margin: 15px 0;
      border-left: 4px solid #2196f3;
      display: none;
    }

    .extraction-result {
      background: linear-gradient(135deg, #e8f5e8 0%, #f0fff0 100%);
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      border-left: 4px solid #28a745;
      display: none;
    }

    .extraction-items {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 10px;
    }

    .extraction-item {
      background: white;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 14px;
      border-left: 3px solid #28a745;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .admin-container {
        padding: 15px;
      }

      .header-content {
        flex-direction: column;
        text-align: center;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .nav-tabs {
        flex-direction: column;
        gap: 5px;
      }

      .nav-tab {
        min-width: auto;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .users-table-container {
        font-size: 14px;
      }

      .user-actions {
        flex-direction: column;
        gap: 5px;
      }

      .btn-small {
        padding: 6px 12px;
        font-size: 12px;
		/* ===== NÂNG CẤP TOKEN & PDF STYLING ===== */

/* Token status styling nâng cấp */
.token-status {
  padding: 8px 16px;
  border-radius: 25px;
  font-size: 12px;
  font-weight: 700;
  display: inline-flex;
  align-items: center;
  gap: 5px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.status-active {
  background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
  color: #155724;
  border: 2px solid #28a745;
  box-shadow: 0 3px 10px rgba(40, 167, 69, 0.3);
}

.status-used {
  background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
  color: #856404;
  border: 2px solid #ffc107;
  box-shadow: 0 3px 10px rgba(255, 193, 7, 0.3);
}

.status-expired {
  background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
  color: #721c24;
  border: 2px solid #dc3545;
  box-shadow: 0 3px 10px rgba(220, 53, 69, 0.3);
}

/* Action buttons nâng cấp */
.token-actions, .document-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  justify-content: center;
}

.btn-action {
  padding: 10px 15px;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  font-size: 11px;
  font-weight: 700;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.btn-action:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.2);
}

.btn-success {
  background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
  color: white;
}

.btn-success:hover {
  background: linear-gradient(135deg, #20c997 0%, #28a745 100%);
}

.btn-primary {
  background: linear-gradient(135deg, #007bff 0%, #6f42c1 100%);
  color: white;
}

.btn-secondary {
  background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
  color: white;
}

.btn-danger {
  background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
  color: white;
}

/* Document status badges */
.status-badge {
  padding: 10px 20px;
  border-radius: 30px;
  font-size: 13px;
  font-weight: 700;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.status-success {
  background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
  color: #155724;
  border: 2px solid #28a745;
}

.status-pending {
  background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
  color: #856404;
  border: 2px solid #ffc107;
}

.status-failed {
  background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
  color: #721c24;
  border: 2px solid #dc3545;
}

/* PDF viewer enhancements */
.pdf-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 10px;
}

.pdf-preview {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border: 2px dashed #6c757d;
  border-radius: 15px;
  padding: 20px;
  text-align: center;
  margin: 15px 0;
}

.upload-success {
  background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
  border: 2px solid #28a745;
  color: #155724;
}
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-spinner"></div>
    <p>Đang xác thực quyền truy cập...</p>
  </div>

  <div class="admin-container" id="adminContainer">
    <!-- Header -->
    <div class="admin-header">
      <div class="header-content">
        <div class="header-left">
          <div class="admin-avatar">
            <i class="fas fa-user-shield"></i>
          </div>
          <div class="admin-info">
            <h1 id="adminName">Admin Panel</h1>
            <div class="admin-role" id="adminRole">Super Administrator</div>
          </div>
        </div>
        <div class="header-actions">
          <span id="lastLogin" style="opacity: 0.8; font-size: 14px;"></span>
          <button class="logout-btn" onclick="logoutAdmin()">
            <i class="fas fa-sign-out-alt"></i>
            Đăng xuất
          </button>
        </div>
      </div>
    </div>

    <!-- Stats Dashboard -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon users">
          <i class="fas fa-users"></i>
        </div>
        <div class="stat-content">
          <h3 id="totalUsers">0</h3>
          <p>Tổng người dùng</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon tokens">
          <i class="fas fa-key"></i>
        </div>
        <div class="stat-content">
          <h3 id="activeTokens">0</h3>
          <p>Token hoạt động</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon devices">
          <i class="fas fa-mobile-alt"></i>
        </div>
        <div class="stat-content">
          <h3 id="totalDevices">0</h3>
          <p>Thiết bị đã xác thực</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon docs">
          <i class="fas fa-file-pdf"></i>
        </div>
        <div class="stat-content">
          <h3 id="totalDocuments">0</h3>
          <p>Chứng từ PDF</p>
        </div>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="switchTab('users')">
        <i class="fas fa-users"></i> Quản lý người dùng
      </button>
      <button class="nav-tab" onclick="switchTab('upload')">
        <i class="fas fa-cloud-upload-alt"></i> Upload chứng từ
      </button>
      <button class="nav-tab" onclick="switchTab('tokens')">
        <i class="fas fa-key"></i> Quản lý Token
      </button>
      <button class="nav-tab" onclick="switchTab('documents')">
        <i class="fas fa-file-pdf"></i> Chứng từ
      </button>
      <button class="nav-tab" onclick="switchTab('activity')">
        <i class="fas fa-history"></i> Nhật ký hoạt động
      </button>
      <button class="nav-tab" onclick="switchTab('analytics')">
        <i class="fas fa-chart-bar"></i> Thống kê
      </button>
    </div>

    <!-- Users Management Section -->
    <div id="users-section" class="content-section active">
      <!-- ... Code Users section giữ nguyên như file gốc ... -->
      <div class="card">
        <div class="card-title">
          <i class="fas fa-user-plus"></i>
          Tạo tài khoản mới
        </div>
        
        <!-- Token Generator -->
        <div class="token-generator">
          <h4>🔑 Tạo Token thiết bị</h4>
          <button class="btn btn-secondary btn-small" onclick="generateNewToken()">
            <i class="fas fa-refresh"></i> Tạo Token mới
          </button>
          <div class="generated-token" id="generatedToken">
            Nhấn "Tạo Token mới" để tạo token
            <button class="copy-token-btn" onclick="copyToken()" title="Copy token">
              <i class="fas fa-copy"></i>
            </button>
          </div>
        </div>

        <form onsubmit="createNewUser(event)">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Token thiết bị <span style="color: red;">*</span></label>
              <input type="text" class="form-input" id="userToken" placeholder="Token sẽ tự động điền" readonly>
            </div>
            
            <div class="form-group">
              <label class="form-label">Tên đăng nhập (MST) <span style="color: red;">*</span></label>
              <input type="text" class="form-input" id="userId" placeholder="VD: 0123456789" required>
            </div>
            
            <div class="form-group password-group">
              <label class="form-label">Mật khẩu <span style="color: red;">*</span></label>
              <input type="password" class="form-input" id="userPassword" placeholder="Mật khẩu đăng nhập" required>
              <button type="button" class="password-toggle" onclick="togglePassword('userPassword')">
                <i class="fas fa-eye"></i>
              </button>
            </div>
            
            <div class="form-group">
              <label class="form-label">Họ tên đầy đủ <span style="color: red;">*</span></label>
              <input type="text" class="form-input" id="userFullName" placeholder="VD: Nguyễn Văn A" required>
            </div>
            
            <div class="form-group">
              <label class="form-label">Địa chỉ</label>
              <input type="text" class="form-input" id="userAddress" placeholder="Địa chỉ người dùng">
            </div>
            
            <div class="form-group">
              <label class="form-label">CQT quản lý</label>
              <input type="text" class="form-input" id="userTaxOffice" placeholder="Cơ quan thuế quản lý">
            </div>
            
            <div class="form-group">
              <label class="form-label">Vai trò</label>
              <select class="form-select" id="userRole">
                <option value="user">Người dùng</option>
                <option value="admin">Admin</option>
              </select>
            </div>
            
            <div class="form-group">
              <label class="form-label">Thời hạn sử dụng (ngày)</label>
              <input type="number" class="form-input" id="userDuration" value="365" min="1">
            </div>
          </div>
          
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-plus"></i>
            Tạo tài khoản
          </button>
        </form>
      </div>

      <!-- Users List -->
      <div class="card">
        <div class="card-title">
          <i class="fas fa-list"></i>
          Danh sách người dùng
          <button class="btn btn-secondary btn-small" onclick="loadUsers()" style="margin-left: auto;">
            <i class="fas fa-sync-alt"></i> Làm mới
          </button>
        </div>
        
        <div class="users-table-container">
          <table class="users-table">
            <thead>
              <tr>
                <th>MST</th>
                <th>Tên đầy đủ</th>
                <th>Token</th>
                <th>Trạng thái</th>
                <th>Ngày tạo</th>
                <th>Hết hạn</th>
                <th>Thao tác</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <tr>
                <td colspan="7" style="text-align: center; padding: 40px;">
                  <div class="loading-spinner" style="width: 30px; height: 30px; margin: 0 auto 15px;"></div>
                  <div>Đang tải dữ liệu...</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ===== MỚI: UPLOAD DOCUMENTS SECTION WITH PDF EXTRACTION =====
	<!-- ===== MỚI: UPLOAD DOCUMENTS SECTION WITH PDF EXTRACTION ===== -->
   <div id="upload-section" class="content-section">
     <div class="card">
       <div class="card-title">
         <i class="fas fa-cloud-upload-alt"></i>
         Upload chứng từ PDF - Tự động extract thông tin
       </div>
       
       <!-- File Upload Area -->
       <div class="upload-area" id="uploadArea" onclick="document.getElementById('pdfFile').click()">
         <div class="upload-icon">
           <i class="fas fa-file-pdf"></i>
         </div>
         <h4>Kéo thả file PDF vào đây hoặc click để chọn</h4>
         <p>Hỗ trợ file PDF có thông tin thuế TNCN, GTGT</p>
         <input type="file" id="pdfFile" accept=".pdf" style="display: none;" onchange="handleFileSelect(event)">
       </div>
       
       <div class="file-info" id="fileInfo">
         <h5>📄 File đã chọn:</h5>
         <div id="fileName"></div>
         <button class="btn btn-primary btn-small" onclick="extractPDFData()">
           <i class="fas fa-search"></i> Phân tích PDF
         </button>
       </div>
       
       <form onsubmit="uploadDocument(event)">
         <div class="form-grid">
           <div class="form-group">
             <label class="form-label">Chọn người dùng <span style="color: red;">*</span></label>
             <select class="form-select" id="documentUser" required>
               <option value="">-- Chọn người dùng --</option>
             </select>
           </div>
           
           <div class="form-group">
             <label class="form-label">Mã tham chiếu <span style="color: red;">*</span></label>
             <input type="text" class="form-input" id="documentReference" placeholder="VD: 1102025xxxxxxx" required>
             <button type="button" class="btn btn-secondary btn-small" onclick="generateReference()" style="margin-top: 8px;">
               <i class="fas fa-magic"></i> Tự động tạo
             </button>
           </div>
         </div>

         <div class="form-grid">
           <div class="form-group">
             <label class="form-label">Thuế TNCN (1003) <span style="color: red;">*</span></label>
             <input type="text" class="form-input" id="taxTNCN" placeholder="VD: 255,000" required style="background: #f8f9ff;">
             <small style="color: #666;">Sẽ tự động điền từ PDF</small>
           </div>
           
           <div class="form-group">
             <label class="form-label">Thuế GTGT (1701) <span style="color: red;">*</span></label>
             <input type="text" class="form-input" id="taxGTGT" placeholder="VD: 510,000" required style="background: #f8f9ff;">
             <small style="color: #666;">Sẽ tự động điền từ PDF</small>
           </div>
           
           <div class="form-group">
             <label class="form-label">Tổng số tiền</label>
             <input type="text" class="form-input" id="totalAmount" readonly style="background: #f0f0f0; font-weight: bold;">
           </div>
           
           <div class="form-group">
             <label class="form-label">Số tiền bằng chữ</label>
             <input type="text" class="form-input" id="amountInWords" readonly style="background: #f0f0f0; font-style: italic;">
           </div>
         </div>

         <div class="form-grid">
           <div class="form-group">
             <label class="form-label">Ngày nộp <span style="color: red;">*</span></label>
             <input type="date" class="form-input" id="paymentDate" required style="background: #f8f9ff;">
             <small style="color: #666;">Sẽ tự động điền từ PDF</small>
           </div>
           
           <div class="form-group">
             <label class="form-label">Giờ nộp <span style="color: red;">*</span></label>
             <input type="time" class="form-input" id="paymentTime" required style="background: #f8f9ff;">
             <small style="color: #666;">Sẽ tự động điền từ PDF</small>
           </div>
           
           <div class="form-group">
             <label class="form-label">Mã ĐBHC <span style="color: red;">*</span></label>
             <input type="text" class="form-input" id="dbhcCode" placeholder="VD: 269HH" required style="background: #f8f9ff;">
             <small style="color: #666;">Sẽ tự động điền từ PDF</small>
           </div>
           
           <div class="form-group">
             <label class="form-label">Trạng thái</label>
             <select class="form-select" id="documentStatus">
               <option value="Thành công - NH/ TGTT đã trừ tiền thành công">Thành công - NH/ TGTT đã trừ tiền thành công</option>
               <option value="Đang xử lý">Đang xử lý</option>
               <option value="Thất bại">Thất bại</option>
             </select>
           </div>
         </div>

         <div class="form-group">
           <label class="form-label">Ghi chú</label>
           <textarea class="form-input" id="documentNotes" rows="3" placeholder="Thông tin bổ sung..."></textarea>
         </div>
         
         <div class="extraction-result" id="extractionResult">
           <h5>🔍 Kết quả phân tích PDF:</h5>
           <div id="extractedData"></div>
         </div>
         
         <button type="submit" class="btn btn-primary">
           <i class="fas fa-save"></i>
           Lưu chứng từ
         </button>
       </form>
     </div>
   </div>

   <!-- Tokens Management Section -->
   <div id="tokens-section" class="content-section">
  <div class="card">
    <div class="card-title">
      <i class="fas fa-key"></i>
      Quản lý Token thiết bị - Nâng cấp
      <button class="btn btn-secondary btn-small" onclick="loadTokens()" style="margin-left: auto;">
        <i class="fas fa-sync-alt"></i> Làm mới
      </button>
    </div>
    
    <div class="tokens-table-container">
      <table class="tokens-table">
        <thead>
          <tr>
            <th>Token</th>
            <th>Người dùng liên kết</th>
            <th>Ngày tạo</th>
            <th>Hết hạn</th>
            <th>Trạng thái</th>
            <th>Thao tác nâng cao</th>
          </tr>
        </thead>
        <tbody id="tokensTableBody">
          <tr>
            <td colspan="6" style="text-align: center; padding: 40px;">
              <div class="loading-spinner"></div>
              <div>Đang tải dữ liệu token...</div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

   <!-- Documents Management Section -->
   <div id="documents-section" class="content-section">
     <div class="card">
       <div class="card-title">
         <i class="fas fa-file-pdf"></i>
         Quản lý chứng từ PDF
       </div>
       <div class="users-table-container">
         <table class="users-table">
           <thead>
             <tr>
               <th>Mã tham chiếu</th>
               <th>Người dùng</th>
               <th>Số tiền</th>
               <th>Ngày nộp</th>
               <th>Trạng thái</th>
               <th>Thao tác</th>
             </tr>
           </thead>
           <tbody id="documentsTableBody">
             <tr>
               <td colspan="6" style="text-align: center; padding: 40px;">
                 <div class="loading-spinner" style="width: 30px; height: 30px; margin: 0 auto 15px;"></div>
                 <div>Đang tải chứng từ...</div>
               </td>
             </tr>
           </tbody>
         </table>
       </div>
     </div>
   </div>

   <!-- ===== MỚI: ACTIVITY LOG SECTION ===== -->
   <div id="activity-section" class="content-section">
     <div class="card">
       <div class="card-title">
         <i class="fas fa-history"></i>
         Nhật ký hoạt động hệ thống
         <button class="btn btn-secondary btn-small" onclick="loadActivityLog()" style="margin-left: auto;">
           <i class="fas fa-sync-alt"></i> Làm mới
         </button>
       </div>
       
       <div class="users-table-container">
         <table class="users-table">
           <thead>
             <tr>
               <th>Thời gian</th>
               <th>Hoạt động</th>
               <th>Token/User</th>
               <th>Thiết bị</th>
               <th>Chi tiết</th>
             </tr>
           </thead>
           <tbody id="activityTableBody">
             <tr>
               <td colspan="5" style="text-align: center; padding: 40px;">
                 <div class="loading-spinner" style="width: 30px; height: 30px; margin: 0 auto 15px;"></div>
                 <div>Đang tải nhật ký...</div>
               </td>
             </tr>
           </tbody>
         </table>
       </div>
     </div>
   </div>

   <!-- Analytics Section -->
   <div id="analytics-section" class="content-section">
     <div class="card">
       <div class="card-title">
         <i class="fas fa-chart-bar"></i>
         Thống kê hệ thống
       </div>
       <p>Biểu đồ và thống kê chi tiết sẽ được phát triển thêm...</p>
     </div>
   </div>
 </div>

 <!-- Edit User Modal -->
 <div id="editUserModal" class="modal">
   <div class="modal-content">
     <div class="modal-header">
       <h3 class="modal-title">Chỉnh sửa thông tin người dùng</h3>
       <button class="close-btn" onclick="closeModal('editUserModal')">&times;</button>
     </div>
     <form onsubmit="updateUser(event)">
       <div class="form-grid">
         <div class="form-group">
           <label class="form-label">MST (không thể sửa)</label>
           <input type="text" class="form-input" id="editUserId" readonly>
         </div>
         
         <div class="form-group">
           <label class="form-label">Họ tên đầy đủ</label>
           <input type="text" class="form-input" id="editUserFullName" required>
         </div>
         
         <div class="form-group">
           <label class="form-label">Địa chỉ</label>
           <input type="text" class="form-input" id="editUserAddress">
         </div>
         
         <div class="form-group">
           <label class="form-label">CQT quản lý</label>
           <input type="text" class="form-input" id="editUserTaxOffice">
         </div>
         
         <div class="form-group">
           <label class="form-label">Vai trò</label>
           <select class="form-select" id="editUserRole">
             <option value="user">Người dùng</option>
             <option value="admin">Admin</option>
           </select>
         </div>
         
         <div class="form-group">
           <label class="form-label">Thời hạn sử dụng (ngày)</label>
           <input type="number" class="form-input" id="editUserDuration" min="1">
         </div>
       </div>
       
       <div style="display: flex; gap: 15px; margin-top: 20px;">
         <button type="button" class="btn btn-secondary" onclick="closeModal('editUserModal')">
           Hủy
         </button>
         <button type="submit" class="btn btn-primary">
           <i class="fas fa-save"></i>
           Lưu thay đổi
         </button>
       </div>
     </form>
   </div>
 </div>

 <!-- Change Password Modal -->
 <div id="changePasswordModal" class="modal">
   <div class="modal-content">
     <div class="modal-header">
       <h3 class="modal-title">Đổi mật khẩu người dùng</h3>
       <button class="close-btn" onclick="closeModal('changePasswordModal')">&times;</button>
     </div>
     <form onsubmit="changeUserPassword(event)">
       <div class="form-group">
         <label class="form-label">Người dùng:</label>
         <input type="text" class="form-input" id="passwordUserId" readonly>
       </div>
       
       <div class="form-group password-group">
         <label class="form-label">Mật khẩu mới <span style="color: red;">*</span></label>
         <input type="password" class="form-input" id="newPassword" placeholder="Nhập mật khẩu mới" required minlength="6">
         <button type="button" class="password-toggle" onclick="togglePassword('newPassword')">
           <i class="fas fa-eye"></i>
         </button>
       </div>
       
       <div class="form-group password-group">
         <label class="form-label">Xác nhận mật khẩu mới <span style="color: red;">*</span></label>
         <input type="password" class="form-input" id="confirmNewPassword" placeholder="Nhập lại mật khẩu mới" required>
         <button type="button" class="password-toggle" onclick="togglePassword('confirmNewPassword')">
           <i class="fas fa-eye"></i>
         </button>
       </div>
       
       <div style="display: flex; gap: 15px; margin-top: 20px;">
         <button type="button" class="btn btn-secondary" onclick="closeModal('changePasswordModal')">
           Hủy
         </button>
         <button type="submit" class="btn btn-warning">
           <i class="fas fa-key"></i>
           Đổi mật khẩu
         </button>
       </div>
     </form>
   </div>
 </div>

 <!-- Firebase SDK -->
 <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
 <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

 <script>
   // Firebase Configuration
   const firebaseConfig = {
     apiKey: "AIzaSyD_rJgBFgBulheVenQUE2KXr4PBpSpTCxw",
     authDomain: "etax-7fbf8.firebaseapp.com",
     databaseURL: "https://etax-7fbf8-default-rtdb.asia-southeast1.firebasedatabase.app",
     projectId: "etax-7fbf8",
     storageBucket: "etax-7fbf8.appspot.com",
     messagingSenderId: "1030026724634",
     appId: "1:1030026724634:web:d76f5f9dad43bad6fd58a3",
     measurementId: "G-YS5DLECJE6"
   };
   
   firebase.initializeApp(firebaseConfig);
   const db = firebase.database();

   // Global variables
   let currentToken = '';
   let editingUserId = '';
   let currentAdminUser = null;

   // Check admin authentication on page load
   document.addEventListener('DOMContentLoaded', function() {
     checkAdminAuth();
   });

   // Check admin authentication
   function checkAdminAuth() {
     const adminSession = localStorage.getItem('etax_admin_session');
     
     if (!adminSession) {
       window.location.href = 'admin-login.html';
       return;
     }
     
     try {
       const session = JSON.parse(adminSession);
       
       // Check if session expired
       if (Date.now() > session.expiresAt) {
         localStorage.removeItem('etax_admin_session');
         showNotification('Phiên đăng nhập đã hết hạn!', 'warning');
         setTimeout(() => {
           window.location.href = 'admin-login.html';
         }, 2000);
         return;
       }
       
       currentAdminUser = session;
       initializeAdminPanel();
       
     } catch (error) {
       console.error('Invalid admin session:', error);
       localStorage.removeItem('etax_admin_session');
       window.location.href = 'admin-login.html';
     }
   }

   // Initialize admin panel
   function initializeAdminPanel() {
     // Hide loading screen
     document.getElementById('loadingScreen').style.display = 'none';
     document.getElementById('adminContainer').style.display = 'block';
     
     // Set admin info
     document.getElementById('adminName').textContent = `${currentAdminUser.username}`;
     document.getElementById('adminRole').textContent = currentAdminUser.role || 'Administrator';
     document.getElementById('lastLogin').textContent = `Đăng nhập lúc: ${new Date(currentAdminUser.loginTime).toLocaleString('vi-VN')}`;
     
     // Load data
     loadDashboardStats();
     loadUsers();
     loadUserDropdown();
     loadTokens();
     loadDocuments();
     loadActivityLog();
     setDefaultDateTime();
   }

   // Set default date and time
   function setDefaultDateTime() {
     const now = new Date();
     const today = now.toISOString().split('T')[0];
     const currentTime = now.toTimeString().split(' ')[0].slice(0, 5);
     
     document.getElementById('paymentDate').value = today;
     document.getElementById('paymentTime').value = currentTime;
   }

   // Tab switching
   function switchTab(tabName) {
     // Remove active class from all tabs and sections
     document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
     document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
     
     // Add active class to clicked tab and corresponding section
     event.target.classList.add('active');
     document.getElementById(tabName + '-section').classList.add('active');
     
     // Load specific data based on tab
     switch(tabName) {
       case 'tokens':
         loadTokens();
         break;
       case 'documents':
         loadDocuments();
         break;
       case 'upload':
         loadUserDropdown();
         break;
       case 'activity':
         loadActivityLog();
         break;
     }
   }

   // ===== MỚI: ACTIVITY LOG FUNCTIONS =====
   async function loadActivityLog() {
     try {
       const snapshot = await db.ref('activityLogs').orderByChild('timestamp').limitToLast(100).once('value');
       const logs = snapshot.val() || {};
       
       const tbody = document.getElementById('activityTableBody');
       tbody.innerHTML = '';

       if (Object.keys(logs).length === 0) {
         tbody.innerHTML = `
           <tr>
             <td colspan="5" style="text-align: center; padding: 40px; color: #666;">
               Chưa có hoạt động nào được ghi nhận
             </td>
           </tr>
         `;
         return;
       }

       // Sort by timestamp desc
       const sortedLogs = Object.entries(logs).sort(([,a], [,b]) => b.timestamp - a.timestamp);

       sortedLogs.forEach(([logId, logData]) => {
         const timestamp = new Date(logData.timestamp).toLocaleString('vi-VN');
         const activityType = getActivityIcon(logData.type);
         const deviceInfo = logData.deviceId ? logData.deviceId.slice(0, 20) + '...' : 'N/A';
         
         const row = `
           <tr>
             <td>${timestamp}</td>
             <td>
               <span class="activity-badge ${logData.type}">
                 ${activityType.icon} ${activityType.text}
               </span>
             </td>
             <td><code>${logData.token || logData.userId || 'N/A'}</code></td>
             <td style="font-size: 12px;">${deviceInfo}</td>
             <td>${logData.details || ''}</td>
           </tr>
         `;
         tbody.innerHTML += row;
       });

     } catch (error) {
       console.error('Error loading activity log:', error);
       showNotification('Có lỗi khi tải nhật ký hoạt động', 'error');
     }
   }

   function getActivityIcon(type) {
     const types = {
       'token_activated': { icon: '🔓', text: 'Token được kích hoạt' },
       'token_revoked': { icon: '🚫', text: 'Token bị thu hồi' },
       'user_login': { icon: '🔑', text: 'Đăng nhập' },
       'user_logout': { icon: '🚪', text: 'Đăng xuất' },
       'user_created': { icon: '👤', text: 'Tạo tài khoản' },
       'document_uploaded': { icon: '📄', text: 'Upload chứng từ' },
       'device_linked': { icon: '📱', text: 'Liên kết thiết bị' },
       'direct_user_access': { icon: '🔗', text: 'Truy cập trực tiếp' },
       'password_changed': { icon: '🔐', text: 'Đổi mật khẩu' },
       'user_updated': { icon: '✏️', text: 'Cập nhật thông tin' }
     };
     return types[type] || { icon: '📝', text: 'Hoạt động khác' };
   }

   // ===== MỚI: PDF UPLOAD AND EXTRACTION FUNCTIONS =====
   
   // Handle file selection
   function handleFileSelect(event) {
     const file = event.target.files[0];
     if (file && file.type === 'application/pdf') {
       document.getElementById('fileName').textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
       document.getElementById('fileInfo').style.display = 'block';
       
       // Store file globally
       window.selectedPDFFile = file;
       
       showNotification('File PDF đã được chọn. Nhấn "Phân tích PDF" để extract thông tin!', 'success');
     } else {
       showNotification('Vui lòng chọn file PDF hợp lệ!', 'error');
     }
   }

   // Extract data from PDF (Mock function - thực tế cần PDF.js library)
   async function extractPDFData() {
     if (!window.selectedPDFFile) {
       showNotification('Vui lòng chọn file PDF trước!', 'error');
       return;
     }
     
     showNotification('Đang phân tích PDF... Vui lòng đợi', 'info');
     
     try {
       // Mock extraction - trong thực tế sẽ dùng PDF.js để parse
       // Giả lập kết quả extraction
       setTimeout(() => {
         const mockData = {
           taxTNCN: '255,000',
           taxGTGT: '510,000',
           paymentDate: '2025-01-15',
           paymentTime: '14:30',
           dbhcCode: '269HH',
           referenceCode: '1102025' + Date.now().toString().slice(-10)
         };
         
         displayExtractionResults(mockData);
       }, 2000);
       
     } catch (error) {
       console.error('Error extracting PDF:', error);
       showNotification('Có lỗi khi phân tích PDF!', 'error');
     }
   }

   // Display extraction results
   function displayExtractionResults(data) {
     // Fill form fields
     if (data.taxTNCN) {
       document.getElementById('taxTNCN').value = data.taxTNCN;
       document.getElementById('taxTNCN').readOnly = false;
     }
     
     if (data.taxGTGT) {
       document.getElementById('taxGTGT').value = data.taxGTGT;
       document.getElementById('taxGTGT').readOnly = false;
     }
     
     if (data.paymentDate) {
       document.getElementById('paymentDate').value = data.paymentDate;
       document.getElementById('paymentDate').readOnly = false;
     }
     
     if (data.paymentTime) {
       document.getElementById('paymentTime').value = data.paymentTime;
       document.getElementById('paymentTime').readOnly = false;
     }
     
     if (data.dbhcCode) {
       document.getElementById('dbhcCode').value = data.dbhcCode;
       document.getElementById('dbhcCode').readOnly = false;
     }
     
     if (data.referenceCode) {
       document.getElementById('documentReference').value = data.referenceCode;
     }
     
     // Calculate total
     calculateTotal();
     
     // Show results
     const resultDiv = document.getElementById('extractionResult');
     const extractedDataDiv = document.getElementById('extractedData');
     
     let resultHTML = '<div class="extraction-items">';
     for (const [key, value] of Object.entries(data)) {
       if (value) {
         const fieldNames = {
           taxTNCN: 'Thuế TNCN',
           taxGTGT: 'Thuế GTGT', 
           paymentDate: 'Ngày nộp',
           paymentTime: 'Giờ nộp',
           dbhcCode: 'Mã ĐBHC',
           referenceCode: 'Mã tham chiếu'
         };
         resultHTML += `<div class="extraction-item">✅ ${fieldNames[key]}: <strong>${value}</strong></div>`;
       }
     }
     resultHTML += '</div>';
     
     extractedDataDiv.innerHTML = resultHTML;
     resultDiv.style.display = 'block';
     
     showNotification('Đã phân tích PDF và tự động điền thông tin thành công!', 'success');
   }

   // Drag and drop functionality
   document.addEventListener('DOMContentLoaded', function() {
     const uploadArea = document.getElementById('uploadArea');
     
     ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
       uploadArea.addEventListener(eventName, preventDefaults, false);
     });

     function preventDefaults(e) {
       e.preventDefault();
       e.stopPropagation();
     }

     ['dragenter', 'dragover'].forEach(eventName => {
       uploadArea.addEventListener(eventName, highlight, false);
     });

     ['dragleave', 'drop'].forEach(eventName => {
       uploadArea.addEventListener(eventName, unhighlight, false);
     });

     function highlight(e) {
       uploadArea.classList.add('dragover');
     }

     function unhighlight(e) {
       uploadArea.classList.remove('dragover');
     }

     uploadArea.addEventListener('drop', handleDrop, false);

     function handleDrop(e) {
       const dt = e.dataTransfer;
       const files = dt.files;
       
       if (files.length > 0) {
         document.getElementById('pdfFile').files = files;
         handleFileSelect({ target: { files: files } });
       }
     }
   });

   // ===== EXISTING FUNCTIONS (giữ nguyên từ file gốc) =====
   
   // Generate new token
   function generateNewToken() {
     const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
     let token = '';
     for (let i = 0; i < 12; i++) {
       token += characters.charAt(Math.floor(Math.random() * characters.length));
     }
     
     currentToken = token;
     document.getElementById('generatedToken').innerHTML = `
       ${token}
       <button class="copy-token-btn" onclick="copyToken()" title="Copy token">
         <i class="fas fa-copy"></i>
       </button>
     `;
     document.getElementById('userToken').value = token;
     
     showNotification('Token mới đã được tạo: ' + token, 'success');
   }

   // Copy token to clipboard
   function copyToken() {
     if (currentToken) {
       navigator.clipboard.writeText(currentToken).then(() => {
         showNotification('Đã copy token vào clipboard!', 'success');
       }).catch(() => {
         // Fallback method
         const textarea = document.createElement('textarea');
         textarea.value = currentToken;
         document.body.appendChild(textarea);
         textarea.select();
         document.execCommand('copy');
         document.body.removeChild(textarea);
         showNotification('Đã copy token vào clipboard!', 'success');
       });
     }
   }

   // Generate reference code
   function generateReference() {
     const prefix = "1102025";
     const timestamp = Date.now().toString();
     const randomPart = Math.floor(Math.random() * 1000000).toString().padStart(6, '0');
     const combinedSuffix = (timestamp.slice(-4) + randomPart).slice(0, 10);
     const fullReference = prefix + combinedSuffix;
     
     document.getElementById('documentReference').value = fullReference;
     showNotification('Mã tham chiếu đã được tạo tự động', 'info');
   }
   // Format currency input
   function formatCurrency(input) {
     let value = input.value.replace(/[^\d]/g, '');
     if (value) {
       value = parseInt(value).toLocaleString('vi-VN');
       input.value = value;
     }
   }

   // Calculate total amount
   function calculateTotal() {
     const tncn = parseFloat(document.getElementById('taxTNCN').value.replace(/,/g, '')) || 0;
     const gtgt = parseFloat(document.getElementById('taxGTGT').value.replace(/,/g, '')) || 0;
     const total = tncn + gtgt;
     
     document.getElementById('totalAmount').value = total.toLocaleString('vi-VN');
     document.getElementById('amountInWords').value = convertToVietnameseWords(total);
   }

   // Convert number to Vietnamese words
   function convertToVietnameseWords(amount) {
     if (amount === 0) return "Không đồng";
     
     const ones = ["", "một", "hai", "ba", "bốn", "năm", "sáu", "bảy", "tám", "chín"];
     const tens = ["", "", "hai mươi", "ba mươi", "bốn mươi", "năm mươi", "sáu mươi", "bảy mươi", "tám mươi", "chín mươi"];
     const hundreds = ["", "một trăm", "hai trăm", "ba trăm", "bốn trăm", "năm trăm", "sáu trăm", "bảy trăm", "tám trăm", "chín trăm"];
     
     function convertThreeDigits(num) {
       let result = "";
       const h = Math.floor(num / 100);
       const t = Math.floor((num % 100) / 10);
       const o = num % 10;
       
       if (h > 0) result += hundreds[h] + " ";
       if (t > 1) {
         result += tens[t] + " ";
         if (o > 0) result += ones[o] + " ";
       } else if (t === 1) {
         result += "mười ";
         if (o > 0) result += ones[o] + " ";
       } else if (o > 0) {
         result += ones[o] + " ";
       }
       
       return result.trim();
     }
     
     if (amount < 1000) {
       return convertThreeDigits(amount) + " đồng";
     } else if (amount < 1000000) {
       const thousands = Math.floor(amount / 1000);
       const remainder = amount % 1000;
       let result = convertThreeDigits(thousands) + " nghìn";
       if (remainder > 0) result += " " + convertThreeDigits(remainder);
       return result + " đồng";
     } else if (amount < 1000000000) {
       const millions = Math.floor(amount / 1000000);
       const remainder = amount % 1000000;
       let result = convertThreeDigits(millions) + " triệu";
       if (remainder > 0) {
         if (remainder >= 1000) {
           const thousands = Math.floor(remainder / 1000);
           const lastThree = remainder % 1000;
           result += " " + convertThreeDigits(thousands) + " nghìn";
           if (lastThree > 0) result += " " + convertThreeDigits(lastThree);
         } else {
           result += " " + convertThreeDigits(remainder);
         }
       }
       return result + " đồng";
     }
     
     return amount.toLocaleString('vi-VN') + " đồng";
   }

   // Password visibility toggle
   function togglePassword(inputId) {
     const input = document.getElementById(inputId);
     const button = input.parentNode.querySelector('.password-toggle i');
     
     if (input.type === 'password') {
       input.type = 'text';
       button.className = 'fas fa-eye-slash';
     } else {
       input.type = 'password';
       button.className = 'fas fa-eye';
     }
   }

   // Create new user
   async function createNewUser(event) {
     event.preventDefault();
     
     const token = document.getElementById('userToken').value.trim();
     const userId = document.getElementById('userId').value.trim();
     const password = document.getElementById('userPassword').value.trim();
     const fullName = document.getElementById('userFullName').value.trim();
     const address = document.getElementById('userAddress').value.trim();
     const taxOffice = document.getElementById('userTaxOffice').value.trim();
     const role = document.getElementById('userRole').value;
     const duration = parseInt(document.getElementById('userDuration').value);
     
     if (!token) {
       showNotification('Vui lòng tạo token trước khi tạo tài khoản!', 'error');
       return;
     }
     
     if (!userId || !password || !fullName) {
       showNotification('Vui lòng điền đầy đủ thông tin bắt buộc!', 'error');
       return;
     }

     try {
       // Check if user already exists
       const userSnapshot = await db.ref('users/' + userId).once('value');
       if (userSnapshot.exists()) {
         showNotification('MST này đã tồn tại trong hệ thống!', 'error');
         return;
       }

       const now = Date.now();
       const expiresAt = now + (duration * 24 * 60 * 60 * 1000);

       // Create user data
       const userData = {
         mst: userId,
         password: password,
         name: fullName,
         address: address,
         taxoffice: taxOffice,
         role: role,
         date: new Date().toISOString().split('T')[0],
         duration: duration,
         createdAt: now,
         expiresAt: expiresAt,
         status: 'active',
         linkedToken: token,
         createdBy: currentAdminUser.username
       };

       // Create token data
       const tokenData = {
         linkedUserId: userId,
         createdAt: now,
         expiresAt: expiresAt,
         used: false,
         createdBy: currentAdminUser.username
       };

       // Save to Firebase
       await db.ref('users/' + userId).set(userData);
       await db.ref('deviceTokens/' + token).set(tokenData);

       // Log activity
       await db.ref('activityLogs').push({
         type: 'user_created',
         userId: userId,
         userName: fullName,
         token: token,
         timestamp: Date.now(),
         details: `Admin tạo tài khoản mới cho ${fullName}`,
         admin: currentAdminUser.username
       });

       showNotification('Tạo tài khoản thành công! Token: ' + token, 'success');
       
       // Reset form
       document.querySelector('form').reset();
       document.getElementById('userDuration').value = '365';
       document.getElementById('generatedToken').textContent = 'Nhấn "Tạo Token mới" để tạo token';
       document.getElementById('userToken').value = '';
       currentToken = '';
       setDefaultDateTime();
       
       // Reload data
       loadUsers();
       loadDashboardStats();
       loadUserDropdown();

     } catch (error) {
       console.error('Error creating user:', error);
       showNotification('Có lỗi xảy ra khi tạo tài khoản: ' + error.message, 'error');
     }
   }

   // Load dashboard statistics
   async function loadDashboardStats() {
     try {
       const [usersSnapshot, tokensSnapshot, documentsSnapshot] = await Promise.all([
         db.ref('users').once('value'),
         db.ref('deviceTokens').once('value'),
         db.ref('pdf_documents').once('value')
       ]);

       const users = usersSnapshot.val() || {};
       const tokens = tokensSnapshot.val() || {};
       const documents = documentsSnapshot.val() || {};

       const totalUsers = Object.keys(users).length;
       const activeTokens = Object.values(tokens).filter(token => !token.used).length;
       const totalDevices = Object.values(tokens).filter(token => token.used).length;
       const totalDocuments = Object.keys(documents).length;

       document.getElementById('totalUsers').textContent = totalUsers;
       document.getElementById('activeTokens').textContent = activeTokens;
       document.getElementById('totalDevices').textContent = totalDevices;
       document.getElementById('totalDocuments').textContent = totalDocuments;

     } catch (error) {
       console.error('Error loading stats:', error);
     }
   }

   // Load users list
   async function loadUsers() {
     try {
       const snapshot = await db.ref('users').once('value');
       const users = snapshot.val() || {};
       
       const tbody = document.getElementById('usersTableBody');
       tbody.innerHTML = '';

       if (Object.keys(users).length === 0) {
         tbody.innerHTML = `
           <tr>
             <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
               Chưa có người dùng nào được tạo
             </td>
           </tr>
         `;
         return;
       }

       Object.entries(users).forEach(([mst, user]) => {
         const createdDate = new Date(user.createdAt || 0).toLocaleDateString('vi-VN');
         const expiresDate = new Date(user.expiresAt || 0).toLocaleDateString('vi-VN');
         const isExpired = user.expiresAt && Date.now() > user.expiresAt;
         
         const statusClass = isExpired ? 'status-inactive' : 'status-active';
         const statusText = isExpired ? 'Hết hạn' : 'Hoạt động';

         const row = `
           <tr>
             <td><strong>${mst}</strong></td>
             <td>${user.name || 'N/A'}</td>
             <td><code style="font-size: 12px;">${user.linkedToken || 'N/A'}</code></td>
             <td><span class="user-status ${statusClass}">${statusText}</span></td>
             <td>${createdDate}</td>
             <td>${expiresDate}</td>
             <td>
               <div class="user-actions">
                 <button class="btn btn-info btn-small action-tooltip" onclick="goToUserIndex('${mst}')" data-tooltip="Vào trang index của user">
                   <i class="fas fa-external-link-alt"></i>
                 </button>
                 <button class="btn btn-warning btn-small action-tooltip" onclick="editUser('${mst}')" data-tooltip="Chỉnh sửa thông tin">
                   <i class="fas fa-edit"></i>
                 </button>
                 <button class="btn btn-success btn-small action-tooltip" onclick="changePassword('${mst}')" data-tooltip="Đổi mật khẩu">
                   <i class="fas fa-key"></i>
                 </button>
                 <button class="btn btn-secondary btn-small action-tooltip" onclick="viewUserDetails('${mst}')" data-tooltip="Xem chi tiết">
                   <i class="fas fa-eye"></i>
                 </button>
                 <button class="btn btn-danger btn-small action-tooltip" onclick="deleteUser('${mst}')" data-tooltip="Xóa người dùng">
                   <i class="fas fa-trash"></i>
                 </button>
               </div>
             </td>
           </tr>
         `;
         tbody.innerHTML += row;
       });

     } catch (error) {
       console.error('Error loading users:', error);
       showNotification('Có lỗi khi tải danh sách người dùng', 'error');
     }
   }

   // Go to user's index page - ĐÃ SỬA: Tự động log hoạt động
   function goToUserIndex(userId) {
     // Log activity trước khi chuyển hướng
     db.ref('activityLogs').push({
       type: 'direct_user_access',
       userId: userId,
       timestamp: Date.now(),
       details: `Admin truy cập trực tiếp tài khoản ${userId}`,
       admin: currentAdminUser.username,
       source: 'admin_panel'
     });
     
     // Tạo URL với thông tin user để truy cập trực tiếp
     const userUrl = `index.html?direct_user=${encodeURIComponent(userId)}`;
     window.open(userUrl, '_blank');
     showNotification(`Đang mở trang index cho user: ${userId}`, 'info');
   }

   // Load user dropdown for upload
   async function loadUserDropdown() {
     try {
       const snapshot = await db.ref('users').once('value');
       const users = snapshot.val() || {};
       
       const select = document.getElementById('documentUser');
       select.innerHTML = '<option value="">-- Chọn người dùng --</option>';
       
       Object.entries(users).forEach(([mst, user]) => {
         const option = document.createElement('option');
         option.value = mst;
         option.textContent = `${mst} - ${user.name || 'N/A'}`;
         select.appendChild(option);
       });
       
     } catch (error) {
       console.error('Error loading users for dropdown:', error);
     }
   }

   // Upload document
   async function uploadDocument(event) {
     event.preventDefault();
     
     const documentData = {
       mst: document.getElementById('documentReference').value.trim(),
       taxpayerMST: document.getElementById('documentUser').value,
       taxTNCN: document.getElementById('taxTNCN').value.trim(),
       taxGTGT: document.getElementById('taxGTGT').value.trim(),
       amount: document.getElementById('totalAmount').value.trim(),
       amountInWords: document.getElementById('amountInWords').value.trim(),
       date: document.getElementById('paymentDate').value,
       time: document.getElementById('paymentTime').value,
       dbhc: document.getElementById('dbhcCode').value.trim(),
       status: document.getElementById('documentStatus').value,
       notes: document.getElementById('documentNotes').value.trim(),
       uploadDate: new Date().toISOString(),
       uploadedBy: currentAdminUser.username,
       type: 'tax_payment_document',
       hasAttachment: !!window.selectedPDFFile
     };
     
     if (!documentData.mst || !documentData.taxpayerMST || !documentData.taxTNCN || !documentData.taxGTGT) {
       showNotification('Vui lòng điền đầy đủ thông tin bắt buộc!', 'error');
       return;
     }
     
     try {
       // Check if document with same reference exists
       const existingDoc = await db.ref('pdf_documents/' + documentData.mst).once('value');
       if (existingDoc.exists()) {
         if (!confirm('Mã tham chiếu đã tồn tại! Bạn có muốn ghi đè không?')) {
           return;
         }
       }
       
       // Save document to Firebase
       await db.ref('pdf_documents/' + documentData.mst).set(documentData);
       
       // Log activity
       await db.ref('activityLogs').push({
         type: 'document_uploaded',
         documentId: documentData.mst,
         userId: documentData.taxpayerMST,
         timestamp: Date.now(),
         details: `Upload chứng từ ${documentData.mst} cho user ${documentData.taxpayerMST}`,
         admin: currentAdminUser.username
       });
       
       showNotification('Lưu chứng từ thành công! Mã: ' + documentData.mst, 'success');
       
       // Reset form
       event.target.reset();
       setDefaultDateTime();
       document.getElementById('totalAmount').value = '';
       document.getElementById('amountInWords').value = '';
       document.getElementById('fileInfo').style.display = 'none';
       document.getElementById('extractionResult').style.display = 'none';
       window.selectedPDFFile = null;
       
       // Reload data
       loadDashboardStats();
       loadDocuments();
       
     } catch (error) {
       console.error('Error uploading document:', error);
       showNotification('Có lỗi khi lưu chứng từ: ' + error.message, 'error');
     }
   }

   // Load tokens
   // ===== NÂNG CẤP LOAD TOKENS =====
async function loadTokens() {
  try {
    const snapshot = await db.ref('deviceTokens').once('value');
    const tokens = snapshot.val() || {};
    
    const tbody = document.getElementById('tokensTableBody');
    tbody.innerHTML = '';

    if (Object.keys(tokens).length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
            <i class="fas fa-info-circle" style="font-size: 48px; opacity: 0.3; margin-bottom: 15px;"></i>
            <br>Chưa có token nào được tạo
          </td>
        </tr>
      `;
      return;
    }

    for (const [token, tokenData] of Object.entries(tokens)) {
      const createdDate = new Date(tokenData.createdAt || 0).toLocaleDateString('vi-VN');
      const expiresDate = new Date(tokenData.expiresAt || 0).toLocaleDateString('vi-VN');
      const isExpired = tokenData.expiresAt && Date.now() > tokenData.expiresAt;
      
      // Xác định trạng thái và actions
      let status, statusClass, actions;
      
      if (isExpired) {
        status = '⏰ Hết hạn';
        statusClass = 'status-expired';
        actions = `
          <button class="btn-action btn-danger" onclick="revokeToken('${token}')" 
                  title="Thu hồi token hết hạn">
            <i class="fas fa-trash"></i> Xóa
          </button>
        `;
      } else if (tokenData.used) {
        status = '🔒 Đã sử dụng';
        statusClass = 'status-used';
        actions = `
          <button class="btn-action btn-success" onclick="resetToken('${token}')" 
                  title="Tạo code mới - Reset về trạng thái có thể sử dụng">
            <i class="fas fa-redo"></i> Code mới
          </button>
          <button class="btn-action btn-danger" onclick="revokeToken('${token}')" 
                  title="Thu hồi token vĩnh viễn">
            <i class="fas fa-ban"></i> Thu hồi
          </button>
        `;
      } else {
        status = '✅ Được phép truy cập';
        statusClass = 'status-active';
        actions = `
          <button class="btn-action btn-primary" onclick="copyTokenForUser('${token}')" 
                  title="Copy link truy cập trực tiếp cho user">
            <i class="fas fa-link"></i> Link
          </button>
          <button class="btn-action btn-secondary" onclick="copyTokenCode('${token}')" 
                  title="Copy mã token">
            <i class="fas fa-copy"></i> Copy
          </button>
          <button class="btn-action btn-danger" onclick="revokeToken('${token}')" 
                  title="Thu hồi token">
            <i class="fas fa-times"></i> Thu hồi
          </button>
        `;
      }
      
      const userInfo = tokenData.linkedUserId || '<span style="color: #999; font-style: italic;">Chưa liên kết</span>';
      const tokenDisplay = token.length > 25 ? token.substring(0, 25) + '...' : token;
      
      const row = `
        <tr style="transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor=''">
          <td><code style="font-size: 11px; background: #f1f3f4; padding: 4px 8px; border-radius: 6px;">${tokenDisplay}</code></td>
          <td>${userInfo}</td>
          <td><small>${createdDate}</small></td>
          <td><small>${expiresDate}</small></td>
          <td><span class="token-status ${statusClass}">${status}</span></td>
          <td class="token-actions">${actions}</td>
        </tr>
      `;
      tbody.innerHTML += row;
    }

  } catch (error) {
    console.error('Error loading tokens:', error);
    showNotification('❌ Có lỗi khi tải danh sách token', 'error');
  }
}

       Object.entries(tokens).forEach(([token, data]) => {
         const createdDate = new Date(data.createdAt || 0).toLocaleString('vi-VN');
         const statusClass = data.used ? 'status-inactive' : 'status-active';
         const statusText = data.used ? 'Đã sử dụng' : 'Chưa sử dụng';
         const deviceInfo = data.deviceId ? `${data.deviceId.slice(0, 20)}...` : 'Chưa có';
         
         const row = `
           <tr>
             <td><code style="font-size: 12px;">${token}</code></td>
             <td>${data.linkedUserId || 'N/A'}</td>
             <td><span class="user-status ${statusClass}">${statusText}</span></td>
             <td>${createdDate}</td>
             <td style="font-size: 12px;">${deviceInfo}</td>
             <td>
               <button class="btn btn-danger btn-small" onclick="revokeToken('${token}')">
                 <i class="fas fa-ban"></i> Thu hồi
               </button>
             </td>
           </tr>
         `;
         tbody.innerHTML += row;
       });

     } catch (error) {
       console.error('Error loading tokens:', error);
       showNotification('Có lỗi khi tải token', 'error');
     }
   }

   // Load documents
   async function loadDocuments() {
     try {
       const snapshot = await db.ref('pdf_documents').once('value');
       const documents = snapshot.val() || {};
       
       const tbody = document.getElementById('documentsTableBody');
       tbody.innerHTML = '';

       if (Object.keys(documents).length === 0) {
         tbody.innerHTML = `
           <tr>
             <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
               Chưa có chứng từ nào được tạo
             </td>
           </tr>
         `;
         return;
       }

       Object.entries(documents).forEach(([mst, doc]) => {
         const uploadDate = new Date(doc.uploadDate || 0).toLocaleDateString('vi-VN');
         const amount = doc.amount || '0';
         const paymentDate = doc.date || 'N/A';
         
         const row = `
           <tr>
             <td><code>${mst}</code></td>
             <td>${doc.taxpayerMST || 'N/A'}</td>
             <td><strong>${amount} VND</strong></td>
             <td>${paymentDate}</td>
             <td><span class="user-status status-active">${doc.status || 'N/A'}</span></td>
             <td>
               <div class="user-actions">
                 <button class="btn btn-info btn-small" onclick="viewDocument('${mst}')" title="Xem chứng từ">
                   <i class="fas fa-eye"></i>
                 </button>
                 <button class="btn btn-warning btn-small" onclick="editDocument('${mst}')" title="Chỉnh sửa">
                   <i class="fas fa-edit"></i>
                 </button>
                 <button class="btn btn-danger btn-small" onclick="deleteDocument('${mst}')" title="Xóa">
                   <i class="fas fa-trash"></i>
                 </button>
               </div>
             </td>
           </tr>
         `;
         tbody.innerHTML += row;
       });

     } catch (error) {
       console.error('Error loading documents:', error);
       showNotification('Có lỗi khi tải chứng từ', 'error');
     }
   }

   // View document
   function viewDocument(mst) {
     window.open(`xem-chung-tu.html?mst=${mst}`, '_blank');
   }

   // Edit document (placeholder)
   function editDocument(mst) {
     showNotification('Tính năng chỉnh sửa chứng từ đang được phát triển', 'info');
   }

   // Delete document
   async function deleteDocument(mst) {
     if (!confirm(`Bạn có chắc chắn muốn xóa chứng từ "${mst}"?\n\nThao tác này không thể hoàn tác.`)) {
       return;
     }

     try {
       await db.ref('pdf_documents/' + mst).remove();
       
       // Log deletion
       await db.ref('activityLogs').push({
         type: 'document_deleted',
         documentId: mst,
         admin: currentAdminUser.username,
         timestamp: Date.now(),
         details: `Xóa chứng từ ${mst}`
       });
       
       showNotification(`Đã xóa chứng từ "${mst}" thành công!`, 'success');
       loadDocuments();
       loadDashboardStats();
       
     } catch (error) {
       console.error('Error deleting document:', error);
       showNotification('Có lỗi khi xóa chứng từ: ' + error.message, 'error');
     }
   }

   // Revoke token
   async function revokeToken(token) {
     if (!confirm(`Bạn có chắc chắn muốn thu hồi token "${token}"?\n\nToken sẽ không thể sử dụng nữa.`)) {
       return;
     }
// ===== CHỨC NĂNG MỚI: RESET TOKEN =====
async function resetToken(token) {
  if (!confirm(`🔄 TẠO CODE MỚI CHO TOKEN\n\n` +
              `Token: ${token.substring(0, 25)}...\n\n` +
              `Sau khi tạo code mới:\n` +
              `✅ Token chuyển về trạng thái "được phép truy cập"\n` +
              `✅ User có thể sử dụng lại token này\n` +
              `✅ Không cần tạo token mới\n` +
              `✅ Phù hợp cho việc test và demo\n\n` +
              `⚠️ Lưu ý: Token sẽ có thể được sử dụng ngay lập tức!\n\n` +
              `Bạn có chắc chắn muốn tiếp tục?`)) {
    return;
  }

  try {
    showNotification('⏳ Đang tạo code mới...', 'info');
    
    // Lấy thông tin token hiện tại
    const tokenSnapshot = await db.ref('deviceTokens/' + token).once('value');
    const currentData = tokenSnapshot.val() || {};
    
    // Reset token status
    const resetData = {
      ...currentData,
      used: false,
      resetAt: Date.now(),
      resetBy: currentAdminUser.username,
      resetCount: (currentData.resetCount || 0) + 1,
      lastResetReason: 'Admin tạo code mới cho test/demo'
    };
    
    await db.ref('deviceTokens/' + token).set(resetData);
    
    // Log activity
    await db.ref('activityLogs').push({
      type: 'token_reset',
      token: token,
      admin: currentAdminUser.username,
      timestamp: Date.now(),
      details: `🔄 Admin tạo code mới - Reset token ${token.substring(0, 20)}... về trạng thái "được phép truy cập" (Lần reset thứ ${resetData.resetCount})`
    });
    
    showNotification(`🎉 TẠO CODE MỚI THÀNH CÔNG!\n\n` +
                    `✅ Token "${token.substring(0, 25)}..." đã được reset\n` +
                    `✅ Trạng thái: "Được phép truy cập"\n` +
                    `✅ User có thể sử dụng ngay lập tức\n` +
                    `📊 Đây là lần reset thứ ${resetData.resetCount}`, 'success');
    
    // Reload data
    loadTokens();
    loadDashboardStats();
    
  } catch (error) {
    console.error('Error resetting token:', error);
    showNotification('❌ Có lỗi khi tạo code mới: ' + error.message, 'error');
  }
}

// ===== CHỨC NĂNG MỚI: TRUY CẬP TRỰC TIẾP =====
function copyTokenForUser(token) {
  // Tạo link truy cập trực tiếp không cần nhập token
  const directLink = `${window.location.origin}/index.html?autoToken=${token}`;
  
  // Copy to clipboard
  navigator.clipboard.writeText(directLink).then(() => {
    showNotification(`📋 ĐÃ COPY LINK TRUY CẬP TRỰC TIẾP!\n\n` +
                    `🔗 Link: ${directLink}\n\n` +
                    `💡 Hướng dẫn sử dụng:\n` +
                    `• Gửi link này cho user\n` +
                    `• User chỉ cần click vào link\n` +
                    `• Sẽ tự động đăng nhập không cần nhập token\n` +
                    `• Phù hợp cho demo và test`, 'success');
  }).catch(() => {
    // Fallback for older browsers
    const textarea = document.createElement('textarea');
    textarea.value = directLink;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    showNotification(`📋 Đã copy link truy cập trực tiếp!\n\n🔗 ${directLink}`, 'success');
  });
}

// ===== CHỨC NĂNG MỚI: COPY TOKEN CODE =====
function copyTokenCode(token) {
  navigator.clipboard.writeText(token).then(() => {
    showNotification(`📋 Đã copy mã token!\n\n🔑 ${token}`, 'success');
  }).catch(() => {
    const textarea = document.createElement('textarea');
    textarea.value = token;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    showNotification('📋 Đã copy mã token!', 'success');
  });
}
     try {
       await db.ref('deviceTokens/' + token).remove();
       
       // Log token revocation
       await db.ref('activityLogs').push({
         type: 'token_revoked',
         token: token,
         admin: currentAdminUser.username,
         timestamp: Date.now(),
         details: `Thu hồi token ${token}`
       });
       
       showNotification(`Đã thu hồi token "${token}" thành công!`, 'success');
       loadTokens();
       loadDashboardStats();
       
     } catch (error) {
       console.error('Error revoking token:', error);
       showNotification('Có lỗi khi thu hồi token: ' + error.message, 'error');
     }
   }

   // ===== EXISTING USER MANAGEMENT FUNCTIONS (giữ nguyên) =====
   
   // Edit user
   async function editUser(userId) {
     try {
       const snapshot = await db.ref('users/' + userId).once('value');
       const userData = snapshot.val();
       
       if (!userData) {
         showNotification('Không tìm thấy thông tin người dùng', 'error');
         return;
       }

       // Fill edit form
       document.getElementById('editUserId').value = userId;
       document.getElementById('editUserFullName').value = userData.name || '';
       document.getElementById('editUserAddress').value = userData.address || '';
       document.getElementById('editUserTaxOffice').value = userData.taxoffice || '';
       document.getElementById('editUserRole').value = userData.role || 'user';
       document.getElementById('editUserDuration').value = userData.duration || 365;
       
       editingUserId = userId;
       showModal('editUserModal');

     } catch (error) {
       console.error('Error loading user data:', error);
       showNotification('Có lỗi khi tải thông tin người dùng', 'error');
     }
   }

   // Update user
   async function updateUser(event) {
     event.preventDefault();
     
     if (!editingUserId) {
       showNotification('Không xác định được người dùng cần cập nhật', 'error');
       return;
     }

     try {
       const updateData = {
         name: document.getElementById('editUserFullName').value.trim(),
         address: document.getElementById('editUserAddress').value.trim(),
         taxoffice: document.getElementById('editUserTaxOffice').value.trim(),
         role: document.getElementById('editUserRole').value,
         duration: parseInt(document.getElementById('editUserDuration').value),
         updatedAt: Date.now(),
         updatedBy: currentAdminUser.username
       };

       // Recalculate expiration date if duration changed
       const userSnapshot = await db.ref('users/' + editingUserId).once('value');
       const currentUser = userSnapshot.val();
       if (currentUser && currentUser.createdAt) {
         updateData.expiresAt = currentUser.createdAt + (updateData.duration * 24 * 60 * 60 * 1000);
       }

       await db.ref('users/' + editingUserId).update(updateData);
       
       // Log update
       await db.ref('activityLogs').push({
         type: 'user_updated',
         userId: editingUserId,
         admin: currentAdminUser.username,
         timestamp: Date.now(),
         details: `Cập nhật thông tin user ${editingUserId}`
       });
       
       showNotification('Cập nhật thông tin thành công!', 'success');
       closeModal('editUserModal');
       loadUsers();
       loadDashboardStats();

     } catch (error) {
       console.error('Error updating user:', error);
       showNotification('Có lỗi khi cập nhật thông tin: ' + error.message, 'error');
     }
   }

   // Change password
   function changePassword(userId) {
     editingUserId = userId;
     document.getElementById('passwordUserId').value = userId;
     document.getElementById('newPassword').value = '';
     document.getElementById('confirmNewPassword').value = '';
     showModal('changePasswordModal');
   }

   // Change user password submit
   async function changeUserPassword(event) {
     event.preventDefault();
     
     const newPassword = document.getElementById('newPassword').value;
     const confirmPassword = document.getElementById('confirmNewPassword').value;
     
     if (newPassword !== confirmPassword) {
       showNotification('Mật khẩu xác nhận không khớp!', 'error');
       return;
     }
     
     if (newPassword.length < 6) {
       showNotification('Mật khẩu phải có ít nhất 6 ký tự!', 'error');
       return;
     }
     
     try {
       await db.ref('users/' + editingUserId + '/password').set(newPassword);
       
       // Log password change
       await db.ref('activityLogs').push({
         type: 'password_changed',
         userId: editingUserId,
         admin: currentAdminUser.username,
         timestamp: Date.now(),
         details: `Đổi mật khẩu cho user ${editingUserId}`
       });
       
       showNotification(`Đã đổi mật khẩu cho user "${editingUserId}" thành công!`, 'success');
       closeModal('changePasswordModal');
       
     } catch (error) {
       console.error('Error changing password:', error);
       showNotification('Có lỗi khi đổi mật khẩu: ' + error.message, 'error');
     }
   }

   // View user details
   async function viewUserDetails(userId) {
     try {
       const snapshot = await db.ref('users/' + userId).once('value');
       const userData = snapshot.val();
       
       if (!userData) {
         showNotification('Không tìm thấy thông tin người dùng', 'error');
         return;
       }

       const details = `
📋 THÔNG TIN CHI TIẾT NGƯỜI DÙNG

🆔 MST: ${userId}
👤 Họ tên: ${userData.name || 'N/A'}
🏠 Địa chỉ: ${userData.address || 'N/A'}
🏢 CQT quản lý: ${userData.taxoffice || 'N/A'}
👑 Vai trò: ${userData.role || 'user'}
🔑 Token liên kết: ${userData.linkedToken || 'N/A'}
📅 Ngày tạo: ${new Date(userData.createdAt || 0).toLocaleString('vi-VN')}
⏰ Hết hạn: ${new Date(userData.expiresAt || 0).toLocaleString('vi-VN')}
📝 Thời hạn: ${userData.duration || 0} ngày
👨‍💼 Được tạo bởi: ${userData.createdBy || 'N/A'}

🔐 Mật khẩu: ${userData.password} (hiển thị cho admin)
       `;

       alert(details);

     } catch (error) {
       console.error('Error loading user details:', error);
       showNotification('Có lỗi khi tải thông tin chi tiết', 'error');
     }
   }

   // Delete user
   async function deleteUser(userId) {
     if (!confirm(`⚠️ BẠN CÓ CHẮC CHẮN MUỐN XÓA NGƯỜI DÙNG "${userId}"?\n\nThao tác này sẽ:\n- Xóa vĩnh viễn tài khoản\n- Vô hiệu hóa token liên kết\n- Xóa tất cả chứng từ liên quan\n- Không thể hoàn tác\n\nNhấn OK để xác nhận xóa`)) {
       return;
     }

     try {
       // Get user data to find linked token and documents
       const userSnapshot = await db.ref('users/' + userId).once('value');
       const userData = userSnapshot.val();
       
       // Delete user
       await db.ref('users/' + userId).remove();
       
       // Delete linked token if exists
       if (userData && userData.linkedToken) {
         await db.ref('deviceTokens/' + userData.linkedToken).remove();
		}
       
       // Delete user's documents
       const documentsSnapshot = await db.ref('pdf_documents').orderByChild('taxpayerMST').equalTo(userId).once('value');
       if (documentsSnapshot.exists()) {
         const documents = documentsSnapshot.val();
         const deletePromises = Object.keys(documents).map(docId => 
           db.ref('pdf_documents/' + docId).remove()
         );
         await Promise.all(deletePromises);
       }
       
       // Log deletion
       await db.ref('adminLogs').push({
         action: 'user_deleted',
         targetUser: userId,
         admin: currentAdminUser.username,
         timestamp: Date.now()
       });
       
       showNotification(`Đã xóa người dùng "${userId}" và tất cả dữ liệu liên quan!`, 'success');
       loadUsers();
       loadDashboardStats();
       loadUserDropdown();
       loadTokens();
       loadDocuments();

     } catch (error) {
       console.error('Error deleting user:', error);
       showNotification('Có lỗi khi xóa người dùng: ' + error.message, 'error');
     }
   }

   // Logout admin
   function logoutAdmin() {
     if (confirm('Bạn có chắc chắn muốn đăng xuất khỏi admin panel?')) {
       // Log logout
       db.ref('adminLogs').push({
         action: 'logout',
         admin: currentAdminUser.username,
         timestamp: Date.now()
       });
       
       localStorage.removeItem('etax_admin_session');
       showNotification('Đã đăng xuất thành công!', 'success');
       setTimeout(() => {
         window.location.href = 'admin-login.html';
       }, 1500);
     }
   }

   // Modal functions
   function showModal(modalId) {
     document.getElementById(modalId).classList.add('show');
   }

   function closeModal(modalId) {
     document.getElementById(modalId).classList.remove('show');
     editingUserId = '';
   }

   // Notification system
   function showNotification(message, type = 'info') {
     // Remove existing notifications
     const existingNotifications = document.querySelectorAll('.notification');
     existingNotifications.forEach(notif => notif.remove());

     const notification = document.createElement('div');
     notification.className = `notification ${type}`;
     notification.innerHTML = `
       <div style="display: flex; align-items: center; gap: 10px;">
         <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
         <span>${message}</span>
       </div>
     `;

     document.body.appendChild(notification);

     // Show notification
     setTimeout(() => notification.classList.add('show'), 100);

     // Auto hide after 5 seconds
     setTimeout(() => {
       notification.classList.remove('show');
       setTimeout(() => notification.remove(), 300);
     }, 5000);
   }

   // Close modal when clicking outside
   document.addEventListener('click', function(event) {
     if (event.target.classList.contains('modal')) {
       closeModal(event.target.id);
     }
   });

   // Keyboard shortcuts
   document.addEventListener('keydown', function(event) {
     if (event.key === 'Escape') {
       const openModal = document.querySelector('.modal.show');
       if (openModal) {
         closeModal(openModal.id);
       }
     }
   });

   // Auto-refresh data every 60 seconds
   setInterval(() => {
     if (document.visibilityState === 'visible') {
       loadDashboardStats();
     }
   }, 60000);

   // Check session validity every 5 minutes
   setInterval(() => {
     checkAdminAuth();
   }, 5 * 60 * 1000);
 </script>
</body>
</html>