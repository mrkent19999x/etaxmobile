<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>eTax Admin Panel - H·ªá th·ªëng qu·∫£n l√Ω</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  
  <style>
  /* Th√™m v√†o ph·∫ßn CSS c·ªßa admin-panel.html */

/* Extraction results styling */
.extraction-result {
    background: linear-gradient(135deg, #e8f5e8 0%, #f0fff0 100%);
    border-radius: 15px;
    padding: 20px;
    margin: 20px 0;
    border-left: 4px solid #28a745;
}

.extraction-items {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 10px;
}

.extraction-item {
    background: white;
    padding: 10px 15px;
    border-radius: 8px;
    font-size: 14px;
    border-left: 3px solid #28a745;
}

/* Upload area enhancements */
.upload-area {
    border: 2px dashed #667eea;
    border-radius: 15px;
    padding: 40px;
    text-align: center;
    background: linear-gradient(135deg, #f8f9ff 0%, #fff 100%);
    transition: all 0.3s ease;
    cursor: pointer;
}

.upload-area:hover {
    border-color: #5a67d8;
    background: linear-gradient(135deg, #f0f2ff 0%, #f8f9ff 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
}

.upload-area.dragover {
    border-color: #4c51bf;
    background: linear-gradient(135deg, #e6fffa 0%, #f0fff4 100%);
    border-style: solid;
}

.file-info {
    background: linear-gradient(135deg, #e3f2fd 0%, #f8f9ff 100%);
    border-radius: 12px;
    padding: 20px;
    margin: 15px 0;
    border-left: 4px solid #2196f3;
}

/* Activity log styling */
.activity-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.activity-badge.token_activated {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    color: #155724;
    border: 1px solid #c3e6cb;
}

.activity-badge.user_login {
    background: linear-gradient(135deg, #cce5ff 0%, #b3d7ff 100%);
    color: #004085;
    border: 1px solid #b3d7ff;
}

/* Enhanced document management */
.document-preview {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin: 15px 0;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
}

.document-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 15px;
    border-bottom: 2px solid #f0f0f0;
    margin-bottom: 15px;
}

.document-amount {
    font-size: 24px;
    font-weight: bold;
    color: #28a745;
}

.document-status-success {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      color: #333;
      line-height: 1.6;
    }

    /* Loading Screen */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: white;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .admin-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      display: none;
    }

    /* Header v·ªõi th√¥ng tin admin */
    .admin-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 20px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      position: relative;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .admin-avatar {
      width: 60px;
      height: 60px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .admin-info h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .admin-role {
      opacity: 0.9;
      font-size: 14px;
    }

    .header-actions {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .logout-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      cursor: pointer;
      transition: background 0.3s;
      font-weight: 500;
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* Stats Dashboard */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      gap: 20px;
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
    }

    .stat-icon.users { background: linear-gradient(45deg, #667eea, #764ba2); }
    .stat-icon.tokens { background: linear-gradient(45deg, #f093fb, #f5576c); }
    .stat-icon.devices { background: linear-gradient(45deg, #4facfe, #00f2fe); }
    .stat-icon.docs { background: linear-gradient(45deg, #43e97b, #38f9d7); }

    .stat-content h3 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 5px;
      color: #333;
    }

    .stat-content p {
      color: #666;
      font-size: 14px;
    }

    /* Navigation Tabs */
    .nav-tabs {
      display: flex;
      background: white;
      border-radius: 15px;
      padding: 8px;
      margin-bottom: 30px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      overflow-x: auto;
    }

    .nav-tab {
      flex: 1;
      padding: 15px 25px;
      background: transparent;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      white-space: nowrap;
      min-width: 140px;
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
    }

    .nav-tab.active {
      background: #667eea;
      color: white;
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    .nav-tab:hover:not(.active) {
      background: #f0f0f0;
    }

    /* Content Sections */
    .content-section {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .content-section.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Cards */
    .card {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .card-title {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Form Styles */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-label {
      font-weight: 600;
      margin-bottom: 8px;
      color: #555;
    }

    .form-input {
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    .form-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-select {
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      background: white;
      cursor: pointer;
    }

    /* Buttons */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #f8f9fa;
      color: #333;
      border: 2px solid #e0e0e0;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-warning {
      background: #ffc107;
      color: #333;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-info {
      background: #17a2b8;
      color: white;
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 14px;
    }

    /* Token Generator */
    .token-generator {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 20px;
    }

    .generated-token {
      background: rgba(255, 255, 255, 0.2);
      padding: 15px;
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      margin: 15px 0;
      word-break: break-all;
      position: relative;
    }

    .copy-token-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.3);
      border: none;
      color: white;
      padding: 8px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .copy-token-btn:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    /* User Management Table */
    .users-table-container {
      overflow-x: auto;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    .users-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      min-width: 900px;
    }

    .users-table th,
    .users-table td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    .users-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #555;
      position: sticky;
      top: 0;
      font-size: 14px;
    }

    .users-table tr:hover {
      background: #f8f9fa;
    }

    .user-status {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-active {
      background: #d4edda;
      color: #155724;
    }

    .status-inactive {
      background: #f8d7da;
      color: #721c24;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .user-actions {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }

    .action-tooltip {
      position: relative;
    }

    .action-tooltip:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 1000;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      backdrop-filter: blur(5px);
    }

    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 22px;
      font-weight: 600;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s;
    }

    .close-btn:hover {
      background: #f0f0f0;
    }

    /* Notifications */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      z-index: 2000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
      max-width: 350px;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      border-left: 4px solid #28a745;
    }

    .notification.error {
      border-left: 4px solid #dc3545;
    }

    .notification.warning {
      border-left: 4px solid #ffc107;
    }

    .notification.info {
      border-left: 4px solid #17a2b8;
    }

    /* Password visibility toggle */
    .password-group {
      position: relative;
    }

    .password-toggle {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      padding: 5px;
    }

    /* ===== M·ªöI TH√äM: ACTIVITY LOG STYLES ===== */
    .activity-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .activity-badge.token_activated {
      background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .activity-badge.user_login {
      background: linear-gradient(135deg, #cce5ff 0%, #b3d7ff 100%);
      color: #004085;
      border: 1px solid #b3d7ff;
    }

    .activity-badge.direct_user_access {
      background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .activity-badge.token_revoked {
      background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    /* ===== M·ªöI TH√äM: UPLOAD PDF STYLES ===== */
    .upload-area {
      border: 2px dashed #667eea;
      border-radius: 15px;
      padding: 40px;
      text-align: center;
      background: linear-gradient(135deg, #f8f9ff 0%, #fff 100%);
      transition: all 0.3s ease;
      cursor: pointer;
      margin-bottom: 20px;
    }

    .upload-area:hover {
      border-color: #5a67d8;
      background: linear-gradient(135deg, #f0f2ff 0%, #f8f9ff 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
    }

    .upload-area.dragover {
      border-color: #4c51bf;
      background: linear-gradient(135deg, #e6fffa 0%, #f0fff4 100%);
      border-style: solid;
    }

    .upload-icon {
      font-size: 48px;
      color: #667eea;
      margin-bottom: 15px;
    }

    .file-info {
      background: linear-gradient(135deg, #e3f2fd 0%, #f8f9ff 100%);
      border-radius: 12px;
      padding: 20px;
      margin: 15px 0;
      border-left: 4px solid #2196f3;
      display: none;
    }

    .extraction-result {
      background: linear-gradient(135deg, #e8f5e8 0%, #f0fff0 100%);
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      border-left: 4px solid #28a745;
      display: none;
    }

    .extraction-items {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 10px;
    }

    .extraction-item {
      background: white;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 14px;
      border-left: 3px solid #28a745;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .admin-container {
        padding: 15px;
      }

      .header-content {
        flex-direction: column;
        text-align: center;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .nav-tabs {
        flex-direction: column;
        gap: 5px;
      }

      .nav-tab {
        min-width: auto;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .users-table-container {
        font-size: 14px;
      }

      .user-actions {
        flex-direction: column;
        gap: 5px;
      }

      .btn-small {
        padding: 6px 12px;
        font-size: 12px;
		/* ===== N√ÇNG C·∫§P TOKEN & PDF STYLING ===== */

/* Token status styling n√¢ng c·∫•p */
.token-status {
  padding: 8px 16px;
  border-radius: 25px;
  font-size: 12px;
  font-weight: 700;
  display: inline-flex;
  align-items: center;
  gap: 5px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.status-active {
  background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
  color: #155724;
  border: 2px solid #28a745;
  box-shadow: 0 3px 10px rgba(40, 167, 69, 0.3);
}

.status-used {
  background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
  color: #856404;
  border: 2px solid #ffc107;
  box-shadow: 0 3px 10px rgba(255, 193, 7, 0.3);
}

.status-expired {
  background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
  color: #721c24;
  border: 2px solid #dc3545;
  box-shadow: 0 3px 10px rgba(220, 53, 69, 0.3);
}

/* Action buttons n√¢ng c·∫•p */
.token-actions, .document-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  justify-content: center;
}

.btn-action {
  padding: 10px 15px;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  font-size: 11px;
  font-weight: 700;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.btn-action:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.2);
}

.btn-success {
  background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
  color: white;
}

.btn-success:hover {
  background: linear-gradient(135deg, #20c997 0%, #28a745 100%);
}

.btn-primary {
  background: linear-gradient(135deg, #007bff 0%, #6f42c1 100%);
  color: white;
}

.btn-secondary {
  background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
  color: white;
}

.btn-danger {
  background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
  color: white;
}

/* Document status badges */
.status-badge {
  padding: 10px 20px;
  border-radius: 30px;
  font-size: 13px;
  font-weight: 700;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.status-success {
  background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
  color: #155724;
  border: 2px solid #28a745;
}

.status-pending {
  background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
  color: #856404;
  border: 2px solid #ffc107;
}

.status-failed {
  background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
  color: #721c24;
  border: 2px solid #dc3545;
}

/* PDF viewer enhancements */
.pdf-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 10px;
}

.pdf-preview {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border: 2px dashed #6c757d;
  border-radius: 15px;
  padding: 20px;
  text-align: center;
  margin: 15px 0;
}

.upload-success {
  background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
  border: 2px solid #28a745;
  color: #155724;
}
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-spinner"></div>
    <p>ƒêang x√°c th·ª±c quy·ªÅn truy c·∫≠p...</p>
  </div>

  <div class="admin-container" id="adminContainer">
    <!-- Header -->
    <div class="admin-header">
      <div class="header-content">
        <div class="header-left">
          <div class="admin-avatar">
            <i class="fas fa-user-shield"></i>
          </div>
          <div class="admin-info">
            <h1 id="adminName">Admin Panel</h1>
            <div class="admin-role" id="adminRole">Super Administrator</div>
          </div>
        </div>
        <div class="header-actions">
          <span id="lastLogin" style="opacity: 0.8; font-size: 14px;"></span>
          <button class="logout-btn" onclick="logoutAdmin()">
            <i class="fas fa-sign-out-alt"></i>
            ƒêƒÉng xu·∫•t
          </button>
        </div>
      </div>
    </div>

    <!-- Stats Dashboard -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon users">
          <i class="fas fa-users"></i>
        </div>
        <div class="stat-content">
          <h3 id="totalUsers">0</h3>
          <p>T·ªïng ng∆∞·ªùi d√πng</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon tokens">
          <i class="fas fa-key"></i>
        </div>
        <div class="stat-content">
          <h3 id="activeTokens">0</h3>
          <p>Token ho·∫°t ƒë·ªông</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon devices">
          <i class="fas fa-mobile-alt"></i>
        </div>
        <div class="stat-content">
          <h3 id="totalDevices">0</h3>
          <p>Thi·∫øt b·ªã ƒë√£ x√°c th·ª±c</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon docs">
          <i class="fas fa-file-pdf"></i>
        </div>
        <div class="stat-content">
          <h3 id="totalDocuments">0</h3>
          <p>Ch·ª©ng t·ª´ PDF</p>
        </div>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="switchTab('users')">
        <i class="fas fa-users"></i> Qu·∫£n l√Ω ng∆∞·ªùi d√πng
      </button>
      <button class="nav-tab" onclick="switchTab('upload')">
        <i class="fas fa-cloud-upload-alt"></i> Upload ch·ª©ng t·ª´
      </button>
      <button class="nav-tab" onclick="switchTab('tokens')">
        <i class="fas fa-key"></i> Qu·∫£n l√Ω Token
      </button>
      <button class="nav-tab" onclick="switchTab('documents')">
        <i class="fas fa-file-pdf"></i> Ch·ª©ng t·ª´
      </button>
      <button class="nav-tab" onclick="switchTab('activity')">
        <i class="fas fa-history"></i> Nh·∫≠t k√Ω ho·∫°t ƒë·ªông
      </button>
      <button class="nav-tab" onclick="switchTab('analytics')">
        <i class="fas fa-chart-bar"></i> Th·ªëng k√™
      </button>
    </div>

    <!-- Users Management Section -->
    <div id="users-section" class="content-section active">
      <!-- ... Code Users section gi·ªØ nguy√™n nh∆∞ file g·ªëc ... -->
      <div class="card">
        <div class="card-title">
          <i class="fas fa-user-plus"></i>
          T·∫°o t√†i kho·∫£n m·ªõi
        </div>
        
        <!-- Token Generator -->
        <div class="token-generator">
          <h4>üîë T·∫°o Token thi·∫øt b·ªã</h4>
          <button class="btn btn-secondary btn-small" onclick="generateNewToken()">
            <i class="fas fa-refresh"></i> T·∫°o Token m·ªõi
          </button>
          <div class="generated-token" id="generatedToken">
            Nh·∫•n "T·∫°o Token m·ªõi" ƒë·ªÉ t·∫°o token
            <button class="copy-token-btn" onclick="copyToken()" title="Copy token">
              <i class="fas fa-copy"></i>
            </button>
          </div>
        </div>

        <form onsubmit="createNewUser(event)">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Token thi·∫øt b·ªã <span style="color: red;">*</span></label>
              <input type="text" class="form-input" id="userToken" placeholder="Token s·∫Ω t·ª± ƒë·ªông ƒëi·ªÅn" readonly>
            </div>
            
            <div class="form-group">
              <label class="form-label">T√™n ƒëƒÉng nh·∫≠p (MST) <span style="color: red;">*</span></label>
              <input type="text" class="form-input" id="userId" placeholder="VD: 0123456789" required>
            </div>
            
            <div class="form-group password-group">
              <label class="form-label">M·∫≠t kh·∫©u <span style="color: red;">*</span></label>
              <input type="password" class="form-input" id="userPassword" placeholder="M·∫≠t kh·∫©u ƒëƒÉng nh·∫≠p" required>
              <button type="button" class="password-toggle" onclick="togglePassword('userPassword')">
                <i class="fas fa-eye"></i>
              </button>
            </div>
            
            <div class="form-group">
              <label class="form-label">H·ªç t√™n ƒë·∫ßy ƒë·ªß <span style="color: red;">*</span></label>
              <input type="text" class="form-input" id="userFullName" placeholder="VD: Nguy·ªÖn VƒÉn A" required>
            </div>
            
            <div class="form-group">
              <label class="form-label">ƒê·ªãa ch·ªâ</label>
              <input type="text" class="form-input" id="userAddress" placeholder="ƒê·ªãa ch·ªâ ng∆∞·ªùi d√πng">
            </div>
            
            <div class="form-group">
              <label class="form-label">CQT qu·∫£n l√Ω</label>
              <input type="text" class="form-input" id="userTaxOffice" placeholder="C∆° quan thu·∫ø qu·∫£n l√Ω">
            </div>
            
            <div class="form-group">
              <label class="form-label">Vai tr√≤</label>
              <select class="form-select" id="userRole">
                <option value="user">Ng∆∞·ªùi d√πng</option>
                <option value="admin">Admin</option>
              </select>
            </div>
            
            <div class="form-group">
              <label class="form-label">Th·ªùi h·∫°n s·ª≠ d·ª•ng (ng√†y)</label>
              <input type="number" class="form-input" id="userDuration" value="365" min="1">
            </div>
          </div>
          
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-plus"></i>
            T·∫°o t√†i kho·∫£n
          </button>
        </form>
      </div>

      <!-- Users List -->
      <div class="card">
        <div class="card-title">
          <i class="fas fa-list"></i>
          Danh s√°ch ng∆∞·ªùi d√πng
          <button class="btn btn-secondary btn-small" onclick="loadUsers()" style="margin-left: auto;">
            <i class="fas fa-sync-alt"></i> L√†m m·ªõi
          </button>
        </div>
        
        <div class="users-table-container">
          <table class="users-table">
            <thead>
              <tr>
                <th>MST</th>
                <th>T√™n ƒë·∫ßy ƒë·ªß</th>
                <th>Token</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Ng√†y t·∫°o</th>
                <th>H·∫øt h·∫°n</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <tr>
                <td colspan="7" style="text-align: center; padding: 40px;">
                  <div class="loading-spinner" style="width: 30px; height: 30px; margin: 0 auto 15px;"></div>
                  <div>ƒêang t·∫£i d·ªØ li·ªáu...</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ===== M·ªöI: UPLOAD DOCUMENTS SECTION WITH PDF EXTRACTION =====
	<!-- ===== M·ªöI: UPLOAD DOCUMENTS SECTION WITH PDF EXTRACTION ===== -->
   <div id="upload-section" class="content-section">
     <div class="card">
       <div class="card-title">
         <i class="fas fa-cloud-upload-alt"></i>
         Upload ch·ª©ng t·ª´ PDF - T·ª± ƒë·ªông extract th√¥ng tin
       </div>
       
       <!-- File Upload Area -->
       <div class="upload-area" id="uploadArea" onclick="document.getElementById('pdfFile').click()">
         <div class="upload-icon">
           <i class="fas fa-file-pdf"></i>
         </div>
         <h4>K√©o th·∫£ file PDF v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn</h4>
         <p>H·ªó tr·ª£ file PDF c√≥ th√¥ng tin thu·∫ø TNCN, GTGT</p>
         <input type="file" id="pdfFile" accept=".pdf" style="display: none;" onchange="handleFileSelect(event)">
       </div>
       
       <div class="file-info" id="fileInfo">
         <h5>üìÑ File ƒë√£ ch·ªçn:</h5>
         <div id="fileName"></div>
         <button class="btn btn-primary btn-small" onclick="extractPDFData()">
           <i class="fas fa-search"></i> Ph√¢n t√≠ch PDF
         </button>
       </div>
       
       <form onsubmit="uploadDocument(event)">
         <div class="form-grid">
           <div class="form-group">
             <label class="form-label">Ch·ªçn ng∆∞·ªùi d√πng <span style="color: red;">*</span></label>
             <select class="form-select" id="documentUser" required>
               <option value="">-- Ch·ªçn ng∆∞·ªùi d√πng --</option>
             </select>
           </div>
           
           <div class="form-group">
             <label class="form-label">M√£ tham chi·∫øu <span style="color: red;">*</span></label>
             <input type="text" class="form-input" id="documentReference" placeholder="VD: 1102025xxxxxxx" required>
             <button type="button" class="btn btn-secondary btn-small" onclick="generateReference()" style="margin-top: 8px;">
               <i class="fas fa-magic"></i> T·ª± ƒë·ªông t·∫°o
             </button>
           </div>
         </div>

         <div class="form-grid">
           <div class="form-group">
             <label class="form-label">Thu·∫ø TNCN (1003) <span style="color: red;">*</span></label>
             <input type="text" class="form-input" id="taxTNCN" placeholder="VD: 255,000" required style="background: #f8f9ff;">
             <small style="color: #666;">S·∫Ω t·ª± ƒë·ªông ƒëi·ªÅn t·ª´ PDF</small>
           </div>
           
           <div class="form-group">
             <label class="form-label">Thu·∫ø GTGT (1701) <span style="color: red;">*</span></label>
             <input type="text" class="form-input" id="taxGTGT" placeholder="VD: 510,000" required style="background: #f8f9ff;">
             <small style="color: #666;">S·∫Ω t·ª± ƒë·ªông ƒëi·ªÅn t·ª´ PDF</small>
           </div>
           
           <div class="form-group">
             <label class="form-label">T·ªïng s·ªë ti·ªÅn</label>
             <input type="text" class="form-input" id="totalAmount" readonly style="background: #f0f0f0; font-weight: bold;">
           </div>
           
           <div class="form-group">
             <label class="form-label">S·ªë ti·ªÅn b·∫±ng ch·ªØ</label>
             <input type="text" class="form-input" id="amountInWords" readonly style="background: #f0f0f0; font-style: italic;">
           </div>
         </div>

         <div class="form-grid">
           <div class="form-group">
             <label class="form-label">Ng√†y n·ªôp <span style="color: red;">*</span></label>
             <input type="date" class="form-input" id="paymentDate" required style="background: #f8f9ff;">
             <small style="color: #666;">S·∫Ω t·ª± ƒë·ªông ƒëi·ªÅn t·ª´ PDF</small>
           </div>
           
           <div class="form-group">
             <label class="form-label">Gi·ªù n·ªôp <span style="color: red;">*</span></label>
             <input type="time" class="form-input" id="paymentTime" required style="background: #f8f9ff;">
             <small style="color: #666;">S·∫Ω t·ª± ƒë·ªông ƒëi·ªÅn t·ª´ PDF</small>
           </div>
           
           <div class="form-group">
             <label class="form-label">M√£ ƒêBHC <span style="color: red;">*</span></label>
             <input type="text" class="form-input" id="dbhcCode" placeholder="VD: 269HH" required style="background: #f8f9ff;">
             <small style="color: #666;">S·∫Ω t·ª± ƒë·ªông ƒëi·ªÅn t·ª´ PDF</small>
           </div>
           
           <div class="form-group">
             <label class="form-label">Tr·∫°ng th√°i</label>
             <select class="form-select" id="documentStatus">
               <option value="Th√†nh c√¥ng - NH/ TGTT ƒë√£ tr·ª´ ti·ªÅn th√†nh c√¥ng">Th√†nh c√¥ng - NH/ TGTT ƒë√£ tr·ª´ ti·ªÅn th√†nh c√¥ng</option>
               <option value="ƒêang x·ª≠ l√Ω">ƒêang x·ª≠ l√Ω</option>
               <option value="Th·∫•t b·∫°i">Th·∫•t b·∫°i</option>
             </select>
           </div>
         </div>

         <div class="form-group">
           <label class="form-label">Ghi ch√∫</label>
           <textarea class="form-input" id="documentNotes" rows="3" placeholder="Th√¥ng tin b·ªï sung..."></textarea>
         </div>
         
         <div class="extraction-result" id="extractionResult">
           <h5>üîç K·∫øt qu·∫£ ph√¢n t√≠ch PDF:</h5>
           <div id="extractedData"></div>
         </div>
         
         <button type="submit" class="btn btn-primary">
           <i class="fas fa-save"></i>
           L∆∞u ch·ª©ng t·ª´
         </button>
       </form>
     </div>
   </div>

   <!-- Tokens Management Section -->
   <div id="tokens-section" class="content-section">
  <div class="card">
    <div class="card-title">
      <i class="fas fa-key"></i>
      Qu·∫£n l√Ω Token thi·∫øt b·ªã - N√¢ng c·∫•p
      <button class="btn btn-secondary btn-small" onclick="loadTokens()" style="margin-left: auto;">
        <i class="fas fa-sync-alt"></i> L√†m m·ªõi
      </button>
    </div>
    
    <div class="tokens-table-container">
      <table class="tokens-table">
        <thead>
          <tr>
            <th>Token</th>
            <th>Ng∆∞·ªùi d√πng li√™n k·∫øt</th>
            <th>Ng√†y t·∫°o</th>
            <th>H·∫øt h·∫°n</th>
            <th>Tr·∫°ng th√°i</th>
            <th>Thao t√°c n√¢ng cao</th>
          </tr>
        </thead>
        <tbody id="tokensTableBody">
          <tr>
            <td colspan="6" style="text-align: center; padding: 40px;">
              <div class="loading-spinner"></div>
              <div>ƒêang t·∫£i d·ªØ li·ªáu token...</div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

   <!-- Documents Management Section -->
   <div id="documents-section" class="content-section">
     <div class="card">
       <div class="card-title">
         <i class="fas fa-file-pdf"></i>
         Qu·∫£n l√Ω ch·ª©ng t·ª´ PDF
       </div>
       <div class="users-table-container">
         <table class="users-table">
           <thead>
             <tr>
               <th>M√£ tham chi·∫øu</th>
               <th>Ng∆∞·ªùi d√πng</th>
               <th>S·ªë ti·ªÅn</th>
               <th>Ng√†y n·ªôp</th>
               <th>Tr·∫°ng th√°i</th>
               <th>Thao t√°c</th>
             </tr>
           </thead>
           <tbody id="documentsTableBody">
             <tr>
               <td colspan="6" style="text-align: center; padding: 40px;">
                 <div class="loading-spinner" style="width: 30px; height: 30px; margin: 0 auto 15px;"></div>
                 <div>ƒêang t·∫£i ch·ª©ng t·ª´...</div>
               </td>
             </tr>
           </tbody>
         </table>
       </div>
     </div>
   </div>

   <!-- ===== M·ªöI: ACTIVITY LOG SECTION ===== -->
   <div id="activity-section" class="content-section">
     <div class="card">
       <div class="card-title">
         <i class="fas fa-history"></i>
         Nh·∫≠t k√Ω ho·∫°t ƒë·ªông h·ªá th·ªëng
         <button class="btn btn-secondary btn-small" onclick="loadActivityLog()" style="margin-left: auto;">
           <i class="fas fa-sync-alt"></i> L√†m m·ªõi
         </button>
       </div>
       
       <div class="users-table-container">
         <table class="users-table">
           <thead>
             <tr>
               <th>Th·ªùi gian</th>
               <th>Ho·∫°t ƒë·ªông</th>
               <th>Token/User</th>
               <th>Thi·∫øt b·ªã</th>
               <th>Chi ti·∫øt</th>
             </tr>
           </thead>
           <tbody id="activityTableBody">
             <tr>
               <td colspan="5" style="text-align: center; padding: 40px;">
                 <div class="loading-spinner" style="width: 30px; height: 30px; margin: 0 auto 15px;"></div>
                 <div>ƒêang t·∫£i nh·∫≠t k√Ω...</div>
               </td>
             </tr>
           </tbody>
         </table>
       </div>
     </div>
   </div>

   <!-- Analytics Section -->
   <div id="analytics-section" class="content-section">
     <div class="card">
       <div class="card-title">
         <i class="fas fa-chart-bar"></i>
         Th·ªëng k√™ h·ªá th·ªëng
       </div>
       <p>Bi·ªÉu ƒë·ªì v√† th·ªëng k√™ chi ti·∫øt s·∫Ω ƒë∆∞·ª£c ph√°t tri·ªÉn th√™m...</p>
     </div>
   </div>
 </div>

 <!-- Edit User Modal -->
 <div id="editUserModal" class="modal">
   <div class="modal-content">
     <div class="modal-header">
       <h3 class="modal-title">Ch·ªânh s·ª≠a th√¥ng tin ng∆∞·ªùi d√πng</h3>
       <button class="close-btn" onclick="closeModal('editUserModal')">&times;</button>
     </div>
     <form onsubmit="updateUser(event)">
       <div class="form-grid">
         <div class="form-group">
           <label class="form-label">MST (kh√¥ng th·ªÉ s·ª≠a)</label>
           <input type="text" class="form-input" id="editUserId" readonly>
         </div>
         
         <div class="form-group">
           <label class="form-label">H·ªç t√™n ƒë·∫ßy ƒë·ªß</label>
           <input type="text" class="form-input" id="editUserFullName" required>
         </div>
         
         <div class="form-group">
           <label class="form-label">ƒê·ªãa ch·ªâ</label>
           <input type="text" class="form-input" id="editUserAddress">
         </div>
         
         <div class="form-group">
           <label class="form-label">CQT qu·∫£n l√Ω</label>
           <input type="text" class="form-input" id="editUserTaxOffice">
         </div>
         
         <div class="form-group">
           <label class="form-label">Vai tr√≤</label>
           <select class="form-select" id="editUserRole">
             <option value="user">Ng∆∞·ªùi d√πng</option>
             <option value="admin">Admin</option>
           </select>
         </div>
         
         <div class="form-group">
           <label class="form-label">Th·ªùi h·∫°n s·ª≠ d·ª•ng (ng√†y)</label>
           <input type="number" class="form-input" id="editUserDuration" min="1">
         </div>
       </div>
       
       <div style="display: flex; gap: 15px; margin-top: 20px;">
         <button type="button" class="btn btn-secondary" onclick="closeModal('editUserModal')">
           H·ªßy
         </button>
         <button type="submit" class="btn btn-primary">
           <i class="fas fa-save"></i>
           L∆∞u thay ƒë·ªïi
         </button>
       </div>
     </form>
   </div>
 </div>

 <!-- Change Password Modal -->
 <div id="changePasswordModal" class="modal">
   <div class="modal-content">
     <div class="modal-header">
       <h3 class="modal-title">ƒê·ªïi m·∫≠t kh·∫©u ng∆∞·ªùi d√πng</h3>
       <button class="close-btn" onclick="closeModal('changePasswordModal')">&times;</button>
     </div>
     <form onsubmit="changeUserPassword(event)">
       <div class="form-group">
         <label class="form-label">Ng∆∞·ªùi d√πng:</label>
         <input type="text" class="form-input" id="passwordUserId" readonly>
       </div>
       
       <div class="form-group password-group">
         <label class="form-label">M·∫≠t kh·∫©u m·ªõi <span style="color: red;">*</span></label>
         <input type="password" class="form-input" id="newPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi" required minlength="6">
         <button type="button" class="password-toggle" onclick="togglePassword('newPassword')">
           <i class="fas fa-eye"></i>
         </button>
       </div>
       
       <div class="form-group password-group">
         <label class="form-label">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi <span style="color: red;">*</span></label>
         <input type="password" class="form-input" id="confirmNewPassword" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi" required>
         <button type="button" class="password-toggle" onclick="togglePassword('confirmNewPassword')">
           <i class="fas fa-eye"></i>
         </button>
       </div>
       
       <div style="display: flex; gap: 15px; margin-top: 20px;">
         <button type="button" class="btn btn-secondary" onclick="closeModal('changePasswordModal')">
           H·ªßy
         </button>
         <button type="submit" class="btn btn-warning">
           <i class="fas fa-key"></i>
           ƒê·ªïi m·∫≠t kh·∫©u
         </button>
       </div>
     </form>
   </div>
 </div>

 <!-- Firebase SDK -->
 <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
 <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

 <script>
   // Firebase Configuration
   const firebaseConfig = {
     apiKey: "AIzaSyD_rJgBFgBulheVenQUE2KXr4PBpSpTCxw",
     authDomain: "etax-7fbf8.firebaseapp.com",
     databaseURL: "https://etax-7fbf8-default-rtdb.asia-southeast1.firebasedatabase.app",
     projectId: "etax-7fbf8",
     storageBucket: "etax-7fbf8.appspot.com",
     messagingSenderId: "1030026724634",
     appId: "1:1030026724634:web:d76f5f9dad43bad6fd58a3",
     measurementId: "G-YS5DLECJE6"
   };
   
   firebase.initializeApp(firebaseConfig);
   const db = firebase.database();

   // Global variables
   let currentToken = '';
   let editingUserId = '';
   let currentAdminUser = null;

   // Check admin authentication on page load
   document.addEventListener('DOMContentLoaded', function() {
     checkAdminAuth();
   });

   // Check admin authentication
   function checkAdminAuth() {
     const adminSession = localStorage.getItem('etax_admin_session');
     
     if (!adminSession) {
       window.location.href = 'admin-login.html';
       return;
     }
     
     try {
       const session = JSON.parse(adminSession);
       
       // Check if session expired
       if (Date.now() > session.expiresAt) {
         localStorage.removeItem('etax_admin_session');
         showNotification('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n!', 'warning');
         setTimeout(() => {
           window.location.href = 'admin-login.html';
         }, 2000);
         return;
       }
       
       currentAdminUser = session;
       initializeAdminPanel();
       
     } catch (error) {
       console.error('Invalid admin session:', error);
       localStorage.removeItem('etax_admin_session');
       window.location.href = 'admin-login.html';
     }
   }

   // Initialize admin panel
   function initializeAdminPanel() {
     // Hide loading screen
     document.getElementById('loadingScreen').style.display = 'none';
     document.getElementById('adminContainer').style.display = 'block';
     
     // Set admin info
     document.getElementById('adminName').textContent = `${currentAdminUser.username}`;
     document.getElementById('adminRole').textContent = currentAdminUser.role || 'Administrator';
     document.getElementById('lastLogin').textContent = `ƒêƒÉng nh·∫≠p l√∫c: ${new Date(currentAdminUser.loginTime).toLocaleString('vi-VN')}`;
     
     // Load data
     loadDashboardStats();
     loadUsers();
     loadUserDropdown();
     loadTokens();
     loadDocuments();
     loadActivityLog();
     setDefaultDateTime();
   }

   // Set default date and time
   function setDefaultDateTime() {
     const now = new Date();
     const today = now.toISOString().split('T')[0];
     const currentTime = now.toTimeString().split(' ')[0].slice(0, 5);
     
     document.getElementById('paymentDate').value = today;
     document.getElementById('paymentTime').value = currentTime;
   }

   // Tab switching
   function switchTab(tabName) {
     // Remove active class from all tabs and sections
     document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
     document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
     
     // Add active class to clicked tab and corresponding section
     event.target.classList.add('active');
     document.getElementById(tabName + '-section').classList.add('active');
     
     // Load specific data based on tab
     switch(tabName) {
       case 'tokens':
         loadTokens();
         break;
       case 'documents':
         loadDocuments();
         break;
       case 'upload':
         loadUserDropdown();
         break;
       case 'activity':
         loadActivityLog();
         break;
     }
   }

   // ===== M·ªöI: ACTIVITY LOG FUNCTIONS =====
   async function loadActivityLog() {
     try {
       const snapshot = await db.ref('activityLogs').orderByChild('timestamp').limitToLast(100).once('value');
       const logs = snapshot.val() || {};
       
       const tbody = document.getElementById('activityTableBody');
       tbody.innerHTML = '';

       if (Object.keys(logs).length === 0) {
         tbody.innerHTML = `
           <tr>
             <td colspan="5" style="text-align: center; padding: 40px; color: #666;">
               Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o ƒë∆∞·ª£c ghi nh·∫≠n
             </td>
           </tr>
         `;
         return;
       }

       // Sort by timestamp desc
       const sortedLogs = Object.entries(logs).sort(([,a], [,b]) => b.timestamp - a.timestamp);

       sortedLogs.forEach(([logId, logData]) => {
         const timestamp = new Date(logData.timestamp).toLocaleString('vi-VN');
         const activityType = getActivityIcon(logData.type);
         const deviceInfo = logData.deviceId ? logData.deviceId.slice(0, 20) + '...' : 'N/A';
         
         const row = `
           <tr>
             <td>${timestamp}</td>
             <td>
               <span class="activity-badge ${logData.type}">
                 ${activityType.icon} ${activityType.text}
               </span>
             </td>
             <td><code>${logData.token || logData.userId || 'N/A'}</code></td>
             <td style="font-size: 12px;">${deviceInfo}</td>
             <td>${logData.details || ''}</td>
           </tr>
         `;
         tbody.innerHTML += row;
       });

     } catch (error) {
       console.error('Error loading activity log:', error);
       showNotification('C√≥ l·ªói khi t·∫£i nh·∫≠t k√Ω ho·∫°t ƒë·ªông', 'error');
     }
   }

   function getActivityIcon(type) {
     const types = {
       'token_activated': { icon: 'üîì', text: 'Token ƒë∆∞·ª£c k√≠ch ho·∫°t' },
       'token_revoked': { icon: 'üö´', text: 'Token b·ªã thu h·ªìi' },
       'user_login': { icon: 'üîë', text: 'ƒêƒÉng nh·∫≠p' },
       'user_logout': { icon: 'üö™', text: 'ƒêƒÉng xu·∫•t' },
       'user_created': { icon: 'üë§', text: 'T·∫°o t√†i kho·∫£n' },
       'document_uploaded': { icon: 'üìÑ', text: 'Upload ch·ª©ng t·ª´' },
       'device_linked': { icon: 'üì±', text: 'Li√™n k·∫øt thi·∫øt b·ªã' },
       'direct_user_access': { icon: 'üîó', text: 'Truy c·∫≠p tr·ª±c ti·∫øp' },
       'password_changed': { icon: 'üîê', text: 'ƒê·ªïi m·∫≠t kh·∫©u' },
       'user_updated': { icon: '‚úèÔ∏è', text: 'C·∫≠p nh·∫≠t th√¥ng tin' }
     };
     return types[type] || { icon: 'üìù', text: 'Ho·∫°t ƒë·ªông kh√°c' };
   }

   // ===== M·ªöI: PDF UPLOAD AND EXTRACTION FUNCTIONS =====
   
   // Handle file selection
   function handleFileSelect(event) {
     const file = event.target.files[0];
     if (file && file.type === 'application/pdf') {
       document.getElementById('fileName').textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
       document.getElementById('fileInfo').style.display = 'block';
       
       // Store file globally
       window.selectedPDFFile = file;
       
       showNotification('File PDF ƒë√£ ƒë∆∞·ª£c ch·ªçn. Nh·∫•n "Ph√¢n t√≠ch PDF" ƒë·ªÉ extract th√¥ng tin!', 'success');
     } else {
       showNotification('Vui l√≤ng ch·ªçn file PDF h·ª£p l·ªá!', 'error');
     }
   }

   // Extract data from PDF (Mock function - th·ª±c t·∫ø c·∫ßn PDF.js library)
   async function extractPDFData() {
     if (!window.selectedPDFFile) {
       showNotification('Vui l√≤ng ch·ªçn file PDF tr∆∞·ªõc!', 'error');
       return;
     }
     
     showNotification('ƒêang ph√¢n t√≠ch PDF... Vui l√≤ng ƒë·ª£i', 'info');
     
     try {
       // Mock extraction - trong th·ª±c t·∫ø s·∫Ω d√πng PDF.js ƒë·ªÉ parse
       // Gi·∫£ l·∫≠p k·∫øt qu·∫£ extraction
       setTimeout(() => {
         const mockData = {
           taxTNCN: '255,000',
           taxGTGT: '510,000',
           paymentDate: '2025-01-15',
           paymentTime: '14:30',
           dbhcCode: '269HH',
           referenceCode: '1102025' + Date.now().toString().slice(-10)
         };
         
         displayExtractionResults(mockData);
       }, 2000);
       
     } catch (error) {
       console.error('Error extracting PDF:', error);
       showNotification('C√≥ l·ªói khi ph√¢n t√≠ch PDF!', 'error');
     }
   }

   // Display extraction results
   function displayExtractionResults(data) {
     // Fill form fields
     if (data.taxTNCN) {
       document.getElementById('taxTNCN').value = data.taxTNCN;
       document.getElementById('taxTNCN').readOnly = false;
     }
     
     if (data.taxGTGT) {
       document.getElementById('taxGTGT').value = data.taxGTGT;
       document.getElementById('taxGTGT').readOnly = false;
     }
     
     if (data.paymentDate) {
       document.getElementById('paymentDate').value = data.paymentDate;
       document.getElementById('paymentDate').readOnly = false;
     }
     
     if (data.paymentTime) {
       document.getElementById('paymentTime').value = data.paymentTime;
       document.getElementById('paymentTime').readOnly = false;
     }
     
     if (data.dbhcCode) {
       document.getElementById('dbhcCode').value = data.dbhcCode;
       document.getElementById('dbhcCode').readOnly = false;
     }
     
     if (data.referenceCode) {
       document.getElementById('documentReference').value = data.referenceCode;
     }
     
     // Calculate total
     calculateTotal();
     
     // Show results
     const resultDiv = document.getElementById('extractionResult');
     const extractedDataDiv = document.getElementById('extractedData');
     
     let resultHTML = '<div class="extraction-items">';
     for (const [key, value] of Object.entries(data)) {
       if (value) {
         const fieldNames = {
           taxTNCN: 'Thu·∫ø TNCN',
           taxGTGT: 'Thu·∫ø GTGT', 
           paymentDate: 'Ng√†y n·ªôp',
           paymentTime: 'Gi·ªù n·ªôp',
           dbhcCode: 'M√£ ƒêBHC',
           referenceCode: 'M√£ tham chi·∫øu'
         };
         resultHTML += `<div class="extraction-item">‚úÖ ${fieldNames[key]}: <strong>${value}</strong></div>`;
       }
     }
     resultHTML += '</div>';
     
     extractedDataDiv.innerHTML = resultHTML;
     resultDiv.style.display = 'block';
     
     showNotification('ƒê√£ ph√¢n t√≠ch PDF v√† t·ª± ƒë·ªông ƒëi·ªÅn th√¥ng tin th√†nh c√¥ng!', 'success');
   }

   // Drag and drop functionality
   document.addEventListener('DOMContentLoaded', function() {
     const uploadArea = document.getElementById('uploadArea');
     
     ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
       uploadArea.addEventListener(eventName, preventDefaults, false);
     });

     function preventDefaults(e) {
       e.preventDefault();
       e.stopPropagation();
     }

     ['dragenter', 'dragover'].forEach(eventName => {
       uploadArea.addEventListener(eventName, highlight, false);
     });

     ['dragleave', 'drop'].forEach(eventName => {
       uploadArea.addEventListener(eventName, unhighlight, false);
     });

     function highlight(e) {
       uploadArea.classList.add('dragover');
     }

     function unhighlight(e) {
       uploadArea.classList.remove('dragover');
     }

     uploadArea.addEventListener('drop', handleDrop, false);

     function handleDrop(e) {
       const dt = e.dataTransfer;
       const files = dt.files;
       
       if (files.length > 0) {
         document.getElementById('pdfFile').files = files;
         handleFileSelect({ target: { files: files } });
       }
     }
   });

   // ===== EXISTING FUNCTIONS (gi·ªØ nguy√™n t·ª´ file g·ªëc) =====
   
   // Generate new token
   function generateNewToken() {
     const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
     let token = '';
     for (let i = 0; i < 12; i++) {
       token += characters.charAt(Math.floor(Math.random() * characters.length));
     }
     
     currentToken = token;
     document.getElementById('generatedToken').innerHTML = `
       ${token}
       <button class="copy-token-btn" onclick="copyToken()" title="Copy token">
         <i class="fas fa-copy"></i>
       </button>
     `;
     document.getElementById('userToken').value = token;
     
     showNotification('Token m·ªõi ƒë√£ ƒë∆∞·ª£c t·∫°o: ' + token, 'success');
   }

   // Copy token to clipboard
   function copyToken() {
     if (currentToken) {
       navigator.clipboard.writeText(currentToken).then(() => {
         showNotification('ƒê√£ copy token v√†o clipboard!', 'success');
       }).catch(() => {
         // Fallback method
         const textarea = document.createElement('textarea');
         textarea.value = currentToken;
         document.body.appendChild(textarea);
         textarea.select();
         document.execCommand('copy');
         document.body.removeChild(textarea);
         showNotification('ƒê√£ copy token v√†o clipboard!', 'success');
       });
     }
   }

   // Generate reference code
   function generateReference() {
     const prefix = "1102025";
     const timestamp = Date.now().toString();
     const randomPart = Math.floor(Math.random() * 1000000).toString().padStart(6, '0');
     const combinedSuffix = (timestamp.slice(-4) + randomPart).slice(0, 10);
     const fullReference = prefix + combinedSuffix;
     
     document.getElementById('documentReference').value = fullReference;
     showNotification('M√£ tham chi·∫øu ƒë√£ ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông', 'info');
   }
   // Format currency input
   function formatCurrency(input) {
     let value = input.value.replace(/[^\d]/g, '');
     if (value) {
       value = parseInt(value).toLocaleString('vi-VN');
       input.value = value;
     }
   }

   // Calculate total amount
   function calculateTotal() {
     const tncn = parseFloat(document.getElementById('taxTNCN').value.replace(/,/g, '')) || 0;
     const gtgt = parseFloat(document.getElementById('taxGTGT').value.replace(/,/g, '')) || 0;
     const total = tncn + gtgt;
     
     document.getElementById('totalAmount').value = total.toLocaleString('vi-VN');
     document.getElementById('amountInWords').value = convertToVietnameseWords(total);
   }

   // Convert number to Vietnamese words
   function convertToVietnameseWords(amount) {
     if (amount === 0) return "Kh√¥ng ƒë·ªìng";
     
     const ones = ["", "m·ªôt", "hai", "ba", "b·ªën", "nƒÉm", "s√°u", "b·∫£y", "t√°m", "ch√≠n"];
     const tens = ["", "", "hai m∆∞∆°i", "ba m∆∞∆°i", "b·ªën m∆∞∆°i", "nƒÉm m∆∞∆°i", "s√°u m∆∞∆°i", "b·∫£y m∆∞∆°i", "t√°m m∆∞∆°i", "ch√≠n m∆∞∆°i"];
     const hundreds = ["", "m·ªôt trƒÉm", "hai trƒÉm", "ba trƒÉm", "b·ªën trƒÉm", "nƒÉm trƒÉm", "s√°u trƒÉm", "b·∫£y trƒÉm", "t√°m trƒÉm", "ch√≠n trƒÉm"];
     
     function convertThreeDigits(num) {
       let result = "";
       const h = Math.floor(num / 100);
       const t = Math.floor((num % 100) / 10);
       const o = num % 10;
       
       if (h > 0) result += hundreds[h] + " ";
       if (t > 1) {
         result += tens[t] + " ";
         if (o > 0) result += ones[o] + " ";
       } else if (t === 1) {
         result += "m∆∞·ªùi ";
         if (o > 0) result += ones[o] + " ";
       } else if (o > 0) {
         result += ones[o] + " ";
       }
       
       return result.trim();
     }
     
     if (amount < 1000) {
       return convertThreeDigits(amount) + " ƒë·ªìng";
     } else if (amount < 1000000) {
       const thousands = Math.floor(amount / 1000);
       const remainder = amount % 1000;
       let result = convertThreeDigits(thousands) + " ngh√¨n";
       if (remainder > 0) result += " " + convertThreeDigits(remainder);
       return result + " ƒë·ªìng";
     } else if (amount < 1000000000) {
       const millions = Math.floor(amount / 1000000);
       const remainder = amount % 1000000;
       let result = convertThreeDigits(millions) + " tri·ªáu";
       if (remainder > 0) {
         if (remainder >= 1000) {
           const thousands = Math.floor(remainder / 1000);
           const lastThree = remainder % 1000;
           result += " " + convertThreeDigits(thousands) + " ngh√¨n";
           if (lastThree > 0) result += " " + convertThreeDigits(lastThree);
         } else {
           result += " " + convertThreeDigits(remainder);
         }
       }
       return result + " ƒë·ªìng";
     }
     
     return amount.toLocaleString('vi-VN') + " ƒë·ªìng";
   }

   // Password visibility toggle
   function togglePassword(inputId) {
     const input = document.getElementById(inputId);
     const button = input.parentNode.querySelector('.password-toggle i');
     
     if (input.type === 'password') {
       input.type = 'text';
       button.className = 'fas fa-eye-slash';
     } else {
       input.type = 'password';
       button.className = 'fas fa-eye';
     }
   }

   // Create new user
   async function createNewUser(event) {
     event.preventDefault();
     
     const token = document.getElementById('userToken').value.trim();
     const userId = document.getElementById('userId').value.trim();
     const password = document.getElementById('userPassword').value.trim();
     const fullName = document.getElementById('userFullName').value.trim();
     const address = document.getElementById('userAddress').value.trim();
     const taxOffice = document.getElementById('userTaxOffice').value.trim();
     const role = document.getElementById('userRole').value;
     const duration = parseInt(document.getElementById('userDuration').value);
     
     if (!token) {
       showNotification('Vui l√≤ng t·∫°o token tr∆∞·ªõc khi t·∫°o t√†i kho·∫£n!', 'error');
       return;
     }
     
     if (!userId || !password || !fullName) {
       showNotification('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!', 'error');
       return;
     }

     try {
       // Check if user already exists
       const userSnapshot = await db.ref('users/' + userId).once('value');
       if (userSnapshot.exists()) {
         showNotification('MST n√†y ƒë√£ t·ªìn t·∫°i trong h·ªá th·ªëng!', 'error');
         return;
       }

       const now = Date.now();
       const expiresAt = now + (duration * 24 * 60 * 60 * 1000);

       // Create user data
       const userData = {
         mst: userId,
         password: password,
         name: fullName,
         address: address,
         taxoffice: taxOffice,
         role: role,
         date: new Date().toISOString().split('T')[0],
         duration: duration,
         createdAt: now,
         expiresAt: expiresAt,
         status: 'active',
         linkedToken: token,
         createdBy: currentAdminUser.username
       };

       // Create token data
       const tokenData = {
         linkedUserId: userId,
         createdAt: now,
         expiresAt: expiresAt,
         used: false,
         createdBy: currentAdminUser.username
       };

       // Save to Firebase
       await db.ref('users/' + userId).set(userData);
       await db.ref('deviceTokens/' + token).set(tokenData);

       // Log activity
       await db.ref('activityLogs').push({
         type: 'user_created',
         userId: userId,
         userName: fullName,
         token: token,
         timestamp: Date.now(),
         details: `Admin t·∫°o t√†i kho·∫£n m·ªõi cho ${fullName}`,
         admin: currentAdminUser.username
       });

       showNotification('T·∫°o t√†i kho·∫£n th√†nh c√¥ng! Token: ' + token, 'success');
       
       // Reset form
       document.querySelector('form').reset();
       document.getElementById('userDuration').value = '365';
       document.getElementById('generatedToken').textContent = 'Nh·∫•n "T·∫°o Token m·ªõi" ƒë·ªÉ t·∫°o token';
       document.getElementById('userToken').value = '';
       currentToken = '';
       setDefaultDateTime();
       
       // Reload data
       loadUsers();
       loadDashboardStats();
       loadUserDropdown();

     } catch (error) {
       console.error('Error creating user:', error);
       showNotification('C√≥ l·ªói x·∫£y ra khi t·∫°o t√†i kho·∫£n: ' + error.message, 'error');
     }
   }

   // Load dashboard statistics
   async function loadDashboardStats() {
     try {
       const [usersSnapshot, tokensSnapshot, documentsSnapshot] = await Promise.all([
         db.ref('users').once('value'),
         db.ref('deviceTokens').once('value'),
         db.ref('pdf_documents').once('value')
       ]);

       const users = usersSnapshot.val() || {};
       const tokens = tokensSnapshot.val() || {};
       const documents = documentsSnapshot.val() || {};

       const totalUsers = Object.keys(users).length;
       const activeTokens = Object.values(tokens).filter(token => !token.used).length;
       const totalDevices = Object.values(tokens).filter(token => token.used).length;
       const totalDocuments = Object.keys(documents).length;

       document.getElementById('totalUsers').textContent = totalUsers;
       document.getElementById('activeTokens').textContent = activeTokens;
       document.getElementById('totalDevices').textContent = totalDevices;
       document.getElementById('totalDocuments').textContent = totalDocuments;

     } catch (error) {
       console.error('Error loading stats:', error);
     }
   }

   // Load users list
   async function loadUsers() {
     try {
       const snapshot = await db.ref('users').once('value');
       const users = snapshot.val() || {};
       
       const tbody = document.getElementById('usersTableBody');
       tbody.innerHTML = '';

       if (Object.keys(users).length === 0) {
         tbody.innerHTML = `
           <tr>
             <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
               Ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o ƒë∆∞·ª£c t·∫°o
             </td>
           </tr>
         `;
         return;
       }

       Object.entries(users).forEach(([mst, user]) => {
         const createdDate = new Date(user.createdAt || 0).toLocaleDateString('vi-VN');
         const expiresDate = new Date(user.expiresAt || 0).toLocaleDateString('vi-VN');
         const isExpired = user.expiresAt && Date.now() > user.expiresAt;
         
         const statusClass = isExpired ? 'status-inactive' : 'status-active';
         const statusText = isExpired ? 'H·∫øt h·∫°n' : 'Ho·∫°t ƒë·ªông';

         const row = `
           <tr>
             <td><strong>${mst}</strong></td>
             <td>${user.name || 'N/A'}</td>
             <td><code style="font-size: 12px;">${user.linkedToken || 'N/A'}</code></td>
             <td><span class="user-status ${statusClass}">${statusText}</span></td>
             <td>${createdDate}</td>
             <td>${expiresDate}</td>
             <td>
               <div class="user-actions">
                 <button class="btn btn-info btn-small action-tooltip" onclick="goToUserIndex('${mst}')" data-tooltip="V√†o trang index c·ªßa user">
                   <i class="fas fa-external-link-alt"></i>
                 </button>
                 <button class="btn btn-warning btn-small action-tooltip" onclick="editUser('${mst}')" data-tooltip="Ch·ªânh s·ª≠a th√¥ng tin">
                   <i class="fas fa-edit"></i>
                 </button>
                 <button class="btn btn-success btn-small action-tooltip" onclick="changePassword('${mst}')" data-tooltip="ƒê·ªïi m·∫≠t kh·∫©u">
                   <i class="fas fa-key"></i>
                 </button>
                 <button class="btn btn-secondary btn-small action-tooltip" onclick="viewUserDetails('${mst}')" data-tooltip="Xem chi ti·∫øt">
                   <i class="fas fa-eye"></i>
                 </button>
                 <button class="btn btn-danger btn-small action-tooltip" onclick="deleteUser('${mst}')" data-tooltip="X√≥a ng∆∞·ªùi d√πng">
                   <i class="fas fa-trash"></i>
                 </button>
               </div>
             </td>
           </tr>
         `;
         tbody.innerHTML += row;
       });

     } catch (error) {
       console.error('Error loading users:', error);
       showNotification('C√≥ l·ªói khi t·∫£i danh s√°ch ng∆∞·ªùi d√πng', 'error');
     }
   }

   // Go to user's index page - ƒê√É S·ª¨A: T·ª± ƒë·ªông log ho·∫°t ƒë·ªông
   function goToUserIndex(userId) {
     // Log activity tr∆∞·ªõc khi chuy·ªÉn h∆∞·ªõng
     db.ref('activityLogs').push({
       type: 'direct_user_access',
       userId: userId,
       timestamp: Date.now(),
       details: `Admin truy c·∫≠p tr·ª±c ti·∫øp t√†i kho·∫£n ${userId}`,
       admin: currentAdminUser.username,
       source: 'admin_panel'
     });
     
     // T·∫°o URL v·ªõi th√¥ng tin user ƒë·ªÉ truy c·∫≠p tr·ª±c ti·∫øp
     const userUrl = `index.html?direct_user=${encodeURIComponent(userId)}`;
     window.open(userUrl, '_blank');
     showNotification(`ƒêang m·ªü trang index cho user: ${userId}`, 'info');
   }

   // Load user dropdown for upload
   async function loadUserDropdown() {
     try {
       const snapshot = await db.ref('users').once('value');
       const users = snapshot.val() || {};
       
       const select = document.getElementById('documentUser');
       select.innerHTML = '<option value="">-- Ch·ªçn ng∆∞·ªùi d√πng --</option>';
       
       Object.entries(users).forEach(([mst, user]) => {
         const option = document.createElement('option');
         option.value = mst;
         option.textContent = `${mst} - ${user.name || 'N/A'}`;
         select.appendChild(option);
       });
       
     } catch (error) {
       console.error('Error loading users for dropdown:', error);
     }
   }

   // Upload document
   async function uploadDocument(event) {
     event.preventDefault();
     
     const documentData = {
       mst: document.getElementById('documentReference').value.trim(),
       taxpayerMST: document.getElementById('documentUser').value,
       taxTNCN: document.getElementById('taxTNCN').value.trim(),
       taxGTGT: document.getElementById('taxGTGT').value.trim(),
       amount: document.getElementById('totalAmount').value.trim(),
       amountInWords: document.getElementById('amountInWords').value.trim(),
       date: document.getElementById('paymentDate').value,
       time: document.getElementById('paymentTime').value,
       dbhc: document.getElementById('dbhcCode').value.trim(),
       status: document.getElementById('documentStatus').value,
       notes: document.getElementById('documentNotes').value.trim(),
       uploadDate: new Date().toISOString(),
       uploadedBy: currentAdminUser.username,
       type: 'tax_payment_document',
       hasAttachment: !!window.selectedPDFFile
     };
     
     if (!documentData.mst || !documentData.taxpayerMST || !documentData.taxTNCN || !documentData.taxGTGT) {
       showNotification('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!', 'error');
       return;
     }
     
     try {
       // Check if document with same reference exists
       const existingDoc = await db.ref('pdf_documents/' + documentData.mst).once('value');
       if (existingDoc.exists()) {
         if (!confirm('M√£ tham chi·∫øu ƒë√£ t·ªìn t·∫°i! B·∫°n c√≥ mu·ªën ghi ƒë√® kh√¥ng?')) {
           return;
         }
       }
       
       // Save document to Firebase
       await db.ref('pdf_documents/' + documentData.mst).set(documentData);
       
       // Log activity
       await db.ref('activityLogs').push({
         type: 'document_uploaded',
         documentId: documentData.mst,
         userId: documentData.taxpayerMST,
         timestamp: Date.now(),
         details: `Upload ch·ª©ng t·ª´ ${documentData.mst} cho user ${documentData.taxpayerMST}`,
         admin: currentAdminUser.username
       });
       
       showNotification('L∆∞u ch·ª©ng t·ª´ th√†nh c√¥ng! M√£: ' + documentData.mst, 'success');
       
       // Reset form
       event.target.reset();
       setDefaultDateTime();
       document.getElementById('totalAmount').value = '';
       document.getElementById('amountInWords').value = '';
       document.getElementById('fileInfo').style.display = 'none';
       document.getElementById('extractionResult').style.display = 'none';
       window.selectedPDFFile = null;
       
       // Reload data
       loadDashboardStats();
       loadDocuments();
       
     } catch (error) {
       console.error('Error uploading document:', error);
       showNotification('C√≥ l·ªói khi l∆∞u ch·ª©ng t·ª´: ' + error.message, 'error');
     }
   }

   // Load tokens
   // ===== N√ÇNG C·∫§P LOAD TOKENS =====
async function loadTokens() {
  try {
    const snapshot = await db.ref('deviceTokens').once('value');
    const tokens = snapshot.val() || {};
    
    const tbody = document.getElementById('tokensTableBody');
    tbody.innerHTML = '';

    if (Object.keys(tokens).length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
            <i class="fas fa-info-circle" style="font-size: 48px; opacity: 0.3; margin-bottom: 15px;"></i>
            <br>Ch∆∞a c√≥ token n√†o ƒë∆∞·ª£c t·∫°o
          </td>
        </tr>
      `;
      return;
    }

    for (const [token, tokenData] of Object.entries(tokens)) {
      const createdDate = new Date(tokenData.createdAt || 0).toLocaleDateString('vi-VN');
      const expiresDate = new Date(tokenData.expiresAt || 0).toLocaleDateString('vi-VN');
      const isExpired = tokenData.expiresAt && Date.now() > tokenData.expiresAt;
      
      // X√°c ƒë·ªãnh tr·∫°ng th√°i v√† actions
      let status, statusClass, actions;
      
      if (isExpired) {
        status = '‚è∞ H·∫øt h·∫°n';
        statusClass = 'status-expired';
        actions = `
          <button class="btn-action btn-danger" onclick="revokeToken('${token}')" 
                  title="Thu h·ªìi token h·∫øt h·∫°n">
            <i class="fas fa-trash"></i> X√≥a
          </button>
        `;
      } else if (tokenData.used) {
        status = 'üîí ƒê√£ s·ª≠ d·ª•ng';
        statusClass = 'status-used';
        actions = `
          <button class="btn-action btn-success" onclick="resetToken('${token}')" 
                  title="T·∫°o code m·ªõi - Reset v·ªÅ tr·∫°ng th√°i c√≥ th·ªÉ s·ª≠ d·ª•ng">
            <i class="fas fa-redo"></i> Code m·ªõi
          </button>
          <button class="btn-action btn-danger" onclick="revokeToken('${token}')" 
                  title="Thu h·ªìi token vƒ©nh vi·ªÖn">
            <i class="fas fa-ban"></i> Thu h·ªìi
          </button>
        `;
      } else {
        status = '‚úÖ ƒê∆∞·ª£c ph√©p truy c·∫≠p';
        statusClass = 'status-active';
        actions = `
          <button class="btn-action btn-primary" onclick="copyTokenForUser('${token}')" 
                  title="Copy link truy c·∫≠p tr·ª±c ti·∫øp cho user">
            <i class="fas fa-link"></i> Link
          </button>
          <button class="btn-action btn-secondary" onclick="copyTokenCode('${token}')" 
                  title="Copy m√£ token">
            <i class="fas fa-copy"></i> Copy
          </button>
          <button class="btn-action btn-danger" onclick="revokeToken('${token}')" 
                  title="Thu h·ªìi token">
            <i class="fas fa-times"></i> Thu h·ªìi
          </button>
        `;
      }
      
      const userInfo = tokenData.linkedUserId || '<span style="color: #999; font-style: italic;">Ch∆∞a li√™n k·∫øt</span>';
      const tokenDisplay = token.length > 25 ? token.substring(0, 25) + '...' : token;
      
      const row = `
        <tr style="transition: all 0.3s ease;" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor=''">
          <td><code style="font-size: 11px; background: #f1f3f4; padding: 4px 8px; border-radius: 6px;">${tokenDisplay}</code></td>
          <td>${userInfo}</td>
          <td><small>${createdDate}</small></td>
          <td><small>${expiresDate}</small></td>
          <td><span class="token-status ${statusClass}">${status}</span></td>
          <td class="token-actions">${actions}</td>
        </tr>
      `;
      tbody.innerHTML += row;
    }

  } catch (error) {
    console.error('Error loading tokens:', error);
    showNotification('‚ùå C√≥ l·ªói khi t·∫£i danh s√°ch token', 'error');
  }
}

       Object.entries(tokens).forEach(([token, data]) => {
         const createdDate = new Date(data.createdAt || 0).toLocaleString('vi-VN');
         const statusClass = data.used ? 'status-inactive' : 'status-active';
         const statusText = data.used ? 'ƒê√£ s·ª≠ d·ª•ng' : 'Ch∆∞a s·ª≠ d·ª•ng';
         const deviceInfo = data.deviceId ? `${data.deviceId.slice(0, 20)}...` : 'Ch∆∞a c√≥';
         
         const row = `
           <tr>
             <td><code style="font-size: 12px;">${token}</code></td>
             <td>${data.linkedUserId || 'N/A'}</td>
             <td><span class="user-status ${statusClass}">${statusText}</span></td>
             <td>${createdDate}</td>
             <td style="font-size: 12px;">${deviceInfo}</td>
             <td>
               <button class="btn btn-danger btn-small" onclick="revokeToken('${token}')">
                 <i class="fas fa-ban"></i> Thu h·ªìi
               </button>
             </td>
           </tr>
         `;
         tbody.innerHTML += row;
       });

     } catch (error) {
       console.error('Error loading tokens:', error);
       showNotification('C√≥ l·ªói khi t·∫£i token', 'error');
     }
   }

   // Load documents
   async function loadDocuments() {
     try {
       const snapshot = await db.ref('pdf_documents').once('value');
       const documents = snapshot.val() || {};
       
       const tbody = document.getElementById('documentsTableBody');
       tbody.innerHTML = '';

       if (Object.keys(documents).length === 0) {
         tbody.innerHTML = `
           <tr>
             <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
               Ch∆∞a c√≥ ch·ª©ng t·ª´ n√†o ƒë∆∞·ª£c t·∫°o
             </td>
           </tr>
         `;
         return;
       }

       Object.entries(documents).forEach(([mst, doc]) => {
         const uploadDate = new Date(doc.uploadDate || 0).toLocaleDateString('vi-VN');
         const amount = doc.amount || '0';
         const paymentDate = doc.date || 'N/A';
         
         const row = `
           <tr>
             <td><code>${mst}</code></td>
             <td>${doc.taxpayerMST || 'N/A'}</td>
             <td><strong>${amount} VND</strong></td>
             <td>${paymentDate}</td>
             <td><span class="user-status status-active">${doc.status || 'N/A'}</span></td>
             <td>
               <div class="user-actions">
                 <button class="btn btn-info btn-small" onclick="viewDocument('${mst}')" title="Xem ch·ª©ng t·ª´">
                   <i class="fas fa-eye"></i>
                 </button>
                 <button class="btn btn-warning btn-small" onclick="editDocument('${mst}')" title="Ch·ªânh s·ª≠a">
                   <i class="fas fa-edit"></i>
                 </button>
                 <button class="btn btn-danger btn-small" onclick="deleteDocument('${mst}')" title="X√≥a">
                   <i class="fas fa-trash"></i>
                 </button>
               </div>
             </td>
           </tr>
         `;
         tbody.innerHTML += row;
       });

     } catch (error) {
       console.error('Error loading documents:', error);
       showNotification('C√≥ l·ªói khi t·∫£i ch·ª©ng t·ª´', 'error');
     }
   }

   // View document
   function viewDocument(mst) {
     window.open(`xem-chung-tu.html?mst=${mst}`, '_blank');
   }

   // Edit document (placeholder)
   function editDocument(mst) {
     showNotification('T√≠nh nƒÉng ch·ªânh s·ª≠a ch·ª©ng t·ª´ ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn', 'info');
   }

   // Delete document
   async function deleteDocument(mst) {
     if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ch·ª©ng t·ª´ "${mst}"?\n\nThao t√°c n√†y kh√¥ng th·ªÉ ho√†n t√°c.`)) {
       return;
     }

     try {
       await db.ref('pdf_documents/' + mst).remove();
       
       // Log deletion
       await db.ref('activityLogs').push({
         type: 'document_deleted',
         documentId: mst,
         admin: currentAdminUser.username,
         timestamp: Date.now(),
         details: `X√≥a ch·ª©ng t·ª´ ${mst}`
       });
       
       showNotification(`ƒê√£ x√≥a ch·ª©ng t·ª´ "${mst}" th√†nh c√¥ng!`, 'success');
       loadDocuments();
       loadDashboardStats();
       
     } catch (error) {
       console.error('Error deleting document:', error);
       showNotification('C√≥ l·ªói khi x√≥a ch·ª©ng t·ª´: ' + error.message, 'error');
     }
   }

   // Revoke token
   async function revokeToken(token) {
     if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën thu h·ªìi token "${token}"?\n\nToken s·∫Ω kh√¥ng th·ªÉ s·ª≠ d·ª•ng n·ªØa.`)) {
       return;
     }
// ===== CH·ª®C NƒÇNG M·ªöI: RESET TOKEN =====
async function resetToken(token) {
  if (!confirm(`üîÑ T·∫†O CODE M·ªöI CHO TOKEN\n\n` +
              `Token: ${token.substring(0, 25)}...\n\n` +
              `Sau khi t·∫°o code m·ªõi:\n` +
              `‚úÖ Token chuy·ªÉn v·ªÅ tr·∫°ng th√°i "ƒë∆∞·ª£c ph√©p truy c·∫≠p"\n` +
              `‚úÖ User c√≥ th·ªÉ s·ª≠ d·ª•ng l·∫°i token n√†y\n` +
              `‚úÖ Kh√¥ng c·∫ßn t·∫°o token m·ªõi\n` +
              `‚úÖ Ph√π h·ª£p cho vi·ªác test v√† demo\n\n` +
              `‚ö†Ô∏è L∆∞u √Ω: Token s·∫Ω c√≥ th·ªÉ ƒë∆∞·ª£c s·ª≠ d·ª•ng ngay l·∫≠p t·ª©c!\n\n` +
              `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c?`)) {
    return;
  }

  try {
    showNotification('‚è≥ ƒêang t·∫°o code m·ªõi...', 'info');
    
    // L·∫•y th√¥ng tin token hi·ªán t·∫°i
    const tokenSnapshot = await db.ref('deviceTokens/' + token).once('value');
    const currentData = tokenSnapshot.val() || {};
    
    // Reset token status
    const resetData = {
      ...currentData,
      used: false,
      resetAt: Date.now(),
      resetBy: currentAdminUser.username,
      resetCount: (currentData.resetCount || 0) + 1,
      lastResetReason: 'Admin t·∫°o code m·ªõi cho test/demo'
    };
    
    await db.ref('deviceTokens/' + token).set(resetData);
    
    // Log activity
    await db.ref('activityLogs').push({
      type: 'token_reset',
      token: token,
      admin: currentAdminUser.username,
      timestamp: Date.now(),
      details: `üîÑ Admin t·∫°o code m·ªõi - Reset token ${token.substring(0, 20)}... v·ªÅ tr·∫°ng th√°i "ƒë∆∞·ª£c ph√©p truy c·∫≠p" (L·∫ßn reset th·ª© ${resetData.resetCount})`
    });
    
    showNotification(`üéâ T·∫†O CODE M·ªöI TH√ÄNH C√îNG!\n\n` +
                    `‚úÖ Token "${token.substring(0, 25)}..." ƒë√£ ƒë∆∞·ª£c reset\n` +
                    `‚úÖ Tr·∫°ng th√°i: "ƒê∆∞·ª£c ph√©p truy c·∫≠p"\n` +
                    `‚úÖ User c√≥ th·ªÉ s·ª≠ d·ª•ng ngay l·∫≠p t·ª©c\n` +
                    `üìä ƒê√¢y l√† l·∫ßn reset th·ª© ${resetData.resetCount}`, 'success');
    
    // Reload data
    loadTokens();
    loadDashboardStats();
    
  } catch (error) {
    console.error('Error resetting token:', error);
    showNotification('‚ùå C√≥ l·ªói khi t·∫°o code m·ªõi: ' + error.message, 'error');
  }
}

// ===== CH·ª®C NƒÇNG M·ªöI: TRUY C·∫¨P TR·ª∞C TI·∫æP =====
function copyTokenForUser(token) {
  // T·∫°o link truy c·∫≠p tr·ª±c ti·∫øp kh√¥ng c·∫ßn nh·∫≠p token
  const directLink = `${window.location.origin}/index.html?autoToken=${token}`;
  
  // Copy to clipboard
  navigator.clipboard.writeText(directLink).then(() => {
    showNotification(`üìã ƒê√É COPY LINK TRUY C·∫¨P TR·ª∞C TI·∫æP!\n\n` +
                    `üîó Link: ${directLink}\n\n` +
                    `üí° H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng:\n` +
                    `‚Ä¢ G·ª≠i link n√†y cho user\n` +
                    `‚Ä¢ User ch·ªâ c·∫ßn click v√†o link\n` +
                    `‚Ä¢ S·∫Ω t·ª± ƒë·ªông ƒëƒÉng nh·∫≠p kh√¥ng c·∫ßn nh·∫≠p token\n` +
                    `‚Ä¢ Ph√π h·ª£p cho demo v√† test`, 'success');
  }).catch(() => {
    // Fallback for older browsers
    const textarea = document.createElement('textarea');
    textarea.value = directLink;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    showNotification(`üìã ƒê√£ copy link truy c·∫≠p tr·ª±c ti·∫øp!\n\nüîó ${directLink}`, 'success');
  });
}

// ===== CH·ª®C NƒÇNG M·ªöI: COPY TOKEN CODE =====
function copyTokenCode(token) {
  navigator.clipboard.writeText(token).then(() => {
    showNotification(`üìã ƒê√£ copy m√£ token!\n\nüîë ${token}`, 'success');
  }).catch(() => {
    const textarea = document.createElement('textarea');
    textarea.value = token;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    showNotification('üìã ƒê√£ copy m√£ token!', 'success');
  });
}
     try {
       await db.ref('deviceTokens/' + token).remove();
       
       // Log token revocation
       await db.ref('activityLogs').push({
         type: 'token_revoked',
         token: token,
         admin: currentAdminUser.username,
         timestamp: Date.now(),
         details: `Thu h·ªìi token ${token}`
       });
       
       showNotification(`ƒê√£ thu h·ªìi token "${token}" th√†nh c√¥ng!`, 'success');
       loadTokens();
       loadDashboardStats();
       
     } catch (error) {
       console.error('Error revoking token:', error);
       showNotification('C√≥ l·ªói khi thu h·ªìi token: ' + error.message, 'error');
     }
   }

   // ===== EXISTING USER MANAGEMENT FUNCTIONS (gi·ªØ nguy√™n) =====
   
   // Edit user
   async function editUser(userId) {
     try {
       const snapshot = await db.ref('users/' + userId).once('value');
       const userData = snapshot.val();
       
       if (!userData) {
         showNotification('Kh√¥ng t√¨m th·∫•y th√¥ng tin ng∆∞·ªùi d√πng', 'error');
         return;
       }

       // Fill edit form
       document.getElementById('editUserId').value = userId;
       document.getElementById('editUserFullName').value = userData.name || '';
       document.getElementById('editUserAddress').value = userData.address || '';
       document.getElementById('editUserTaxOffice').value = userData.taxoffice || '';
       document.getElementById('editUserRole').value = userData.role || 'user';
       document.getElementById('editUserDuration').value = userData.duration || 365;
       
       editingUserId = userId;
       showModal('editUserModal');

     } catch (error) {
       console.error('Error loading user data:', error);
       showNotification('C√≥ l·ªói khi t·∫£i th√¥ng tin ng∆∞·ªùi d√πng', 'error');
     }
   }

   // Update user
   async function updateUser(event) {
     event.preventDefault();
     
     if (!editingUserId) {
       showNotification('Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c ng∆∞·ªùi d√πng c·∫ßn c·∫≠p nh·∫≠t', 'error');
       return;
     }

     try {
       const updateData = {
         name: document.getElementById('editUserFullName').value.trim(),
         address: document.getElementById('editUserAddress').value.trim(),
         taxoffice: document.getElementById('editUserTaxOffice').value.trim(),
         role: document.getElementById('editUserRole').value,
         duration: parseInt(document.getElementById('editUserDuration').value),
         updatedAt: Date.now(),
         updatedBy: currentAdminUser.username
       };

       // Recalculate expiration date if duration changed
       const userSnapshot = await db.ref('users/' + editingUserId).once('value');
       const currentUser = userSnapshot.val();
       if (currentUser && currentUser.createdAt) {
         updateData.expiresAt = currentUser.createdAt + (updateData.duration * 24 * 60 * 60 * 1000);
       }

       await db.ref('users/' + editingUserId).update(updateData);
       
       // Log update
       await db.ref('activityLogs').push({
         type: 'user_updated',
         userId: editingUserId,
         admin: currentAdminUser.username,
         timestamp: Date.now(),
         details: `C·∫≠p nh·∫≠t th√¥ng tin user ${editingUserId}`
       });
       
       showNotification('C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!', 'success');
       closeModal('editUserModal');
       loadUsers();
       loadDashboardStats();

     } catch (error) {
       console.error('Error updating user:', error);
       showNotification('C√≥ l·ªói khi c·∫≠p nh·∫≠t th√¥ng tin: ' + error.message, 'error');
     }
   }

   // Change password
   function changePassword(userId) {
     editingUserId = userId;
     document.getElementById('passwordUserId').value = userId;
     document.getElementById('newPassword').value = '';
     document.getElementById('confirmNewPassword').value = '';
     showModal('changePasswordModal');
   }

   // Change user password submit
   async function changeUserPassword(event) {
     event.preventDefault();
     
     const newPassword = document.getElementById('newPassword').value;
     const confirmPassword = document.getElementById('confirmNewPassword').value;
     
     if (newPassword !== confirmPassword) {
       showNotification('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!', 'error');
       return;
     }
     
     if (newPassword.length < 6) {
       showNotification('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!', 'error');
       return;
     }
     
     try {
       await db.ref('users/' + editingUserId + '/password').set(newPassword);
       
       // Log password change
       await db.ref('activityLogs').push({
         type: 'password_changed',
         userId: editingUserId,
         admin: currentAdminUser.username,
         timestamp: Date.now(),
         details: `ƒê·ªïi m·∫≠t kh·∫©u cho user ${editingUserId}`
       });
       
       showNotification(`ƒê√£ ƒë·ªïi m·∫≠t kh·∫©u cho user "${editingUserId}" th√†nh c√¥ng!`, 'success');
       closeModal('changePasswordModal');
       
     } catch (error) {
       console.error('Error changing password:', error);
       showNotification('C√≥ l·ªói khi ƒë·ªïi m·∫≠t kh·∫©u: ' + error.message, 'error');
     }
   }

   // View user details
   async function viewUserDetails(userId) {
     try {
       const snapshot = await db.ref('users/' + userId).once('value');
       const userData = snapshot.val();
       
       if (!userData) {
         showNotification('Kh√¥ng t√¨m th·∫•y th√¥ng tin ng∆∞·ªùi d√πng', 'error');
         return;
       }

       const details = `
üìã TH√îNG TIN CHI TI·∫æT NG∆Ø·ªúI D√ôNG

üÜî MST: ${userId}
üë§ H·ªç t√™n: ${userData.name || 'N/A'}
üè† ƒê·ªãa ch·ªâ: ${userData.address || 'N/A'}
üè¢ CQT qu·∫£n l√Ω: ${userData.taxoffice || 'N/A'}
üëë Vai tr√≤: ${userData.role || 'user'}
üîë Token li√™n k·∫øt: ${userData.linkedToken || 'N/A'}
üìÖ Ng√†y t·∫°o: ${new Date(userData.createdAt || 0).toLocaleString('vi-VN')}
‚è∞ H·∫øt h·∫°n: ${new Date(userData.expiresAt || 0).toLocaleString('vi-VN')}
üìù Th·ªùi h·∫°n: ${userData.duration || 0} ng√†y
üë®‚Äçüíº ƒê∆∞·ª£c t·∫°o b·ªüi: ${userData.createdBy || 'N/A'}

üîê M·∫≠t kh·∫©u: ${userData.password} (hi·ªÉn th·ªã cho admin)
       `;

       alert(details);

     } catch (error) {
       console.error('Error loading user details:', error);
       showNotification('C√≥ l·ªói khi t·∫£i th√¥ng tin chi ti·∫øt', 'error');
     }
   }

   // Delete user
   async function deleteUser(userId) {
     if (!confirm(`‚ö†Ô∏è B·∫†N C√ì CH·∫ÆC CH·∫ÆN MU·ªêN X√ìA NG∆Ø·ªúI D√ôNG "${userId}"?\n\nThao t√°c n√†y s·∫Ω:\n- X√≥a vƒ©nh vi·ªÖn t√†i kho·∫£n\n- V√¥ hi·ªáu h√≥a token li√™n k·∫øt\n- X√≥a t·∫•t c·∫£ ch·ª©ng t·ª´ li√™n quan\n- Kh√¥ng th·ªÉ ho√†n t√°c\n\nNh·∫•n OK ƒë·ªÉ x√°c nh·∫≠n x√≥a`)) {
       return;
     }

     try {
       // Get user data to find linked token and documents
       const userSnapshot = await db.ref('users/' + userId).once('value');
       const userData = userSnapshot.val();
       
       // Delete user
       await db.ref('users/' + userId).remove();
       
       // Delete linked token if exists
       if (userData && userData.linkedToken) {
         await db.ref('deviceTokens/' + userData.linkedToken).remove();
		}
       
       // Delete user's documents
       const documentsSnapshot = await db.ref('pdf_documents').orderByChild('taxpayerMST').equalTo(userId).once('value');
       if (documentsSnapshot.exists()) {
         const documents = documentsSnapshot.val();
         const deletePromises = Object.keys(documents).map(docId => 
           db.ref('pdf_documents/' + docId).remove()
         );
         await Promise.all(deletePromises);
       }
       
       // Log deletion
       await db.ref('adminLogs').push({
         action: 'user_deleted',
         targetUser: userId,
         admin: currentAdminUser.username,
         timestamp: Date.now()
       });
       
       showNotification(`ƒê√£ x√≥a ng∆∞·ªùi d√πng "${userId}" v√† t·∫•t c·∫£ d·ªØ li·ªáu li√™n quan!`, 'success');
       loadUsers();
       loadDashboardStats();
       loadUserDropdown();
       loadTokens();
       loadDocuments();

     } catch (error) {
       console.error('Error deleting user:', error);
       showNotification('C√≥ l·ªói khi x√≥a ng∆∞·ªùi d√πng: ' + error.message, 'error');
     }
   }

   // Logout admin
   function logoutAdmin() {
     if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t kh·ªèi admin panel?')) {
       // Log logout
       db.ref('adminLogs').push({
         action: 'logout',
         admin: currentAdminUser.username,
         timestamp: Date.now()
       });
       
       localStorage.removeItem('etax_admin_session');
       showNotification('ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!', 'success');
       setTimeout(() => {
         window.location.href = 'admin-login.html';
       }, 1500);
     }
   }

   // Modal functions
   function showModal(modalId) {
     document.getElementById(modalId).classList.add('show');
   }

   function closeModal(modalId) {
     document.getElementById(modalId).classList.remove('show');
     editingUserId = '';
   }

   // Notification system
   function showNotification(message, type = 'info') {
     // Remove existing notifications
     const existingNotifications = document.querySelectorAll('.notification');
     existingNotifications.forEach(notif => notif.remove());

     const notification = document.createElement('div');
     notification.className = `notification ${type}`;
     notification.innerHTML = `
       <div style="display: flex; align-items: center; gap: 10px;">
         <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
         <span>${message}</span>
       </div>
     `;

     document.body.appendChild(notification);

     // Show notification
     setTimeout(() => notification.classList.add('show'), 100);

     // Auto hide after 5 seconds
     setTimeout(() => {
       notification.classList.remove('show');
       setTimeout(() => notification.remove(), 300);
     }, 5000);
   }

   // Close modal when clicking outside
   document.addEventListener('click', function(event) {
     if (event.target.classList.contains('modal')) {
       closeModal(event.target.id);
     }
   });

   // Keyboard shortcuts
   document.addEventListener('keydown', function(event) {
     if (event.key === 'Escape') {
       const openModal = document.querySelector('.modal.show');
       if (openModal) {
         closeModal(openModal.id);
       }
     }
   });

   // Auto-refresh data every 60 seconds
   setInterval(() => {
     if (document.visibilityState === 'visible') {
       loadDashboardStats();
     }
   }, 60000);

   // Check session validity every 5 minutes
   setInterval(() => {
     checkAdminAuth();
   }, 5 * 60 * 1000);
 </script>
</body>
</html>