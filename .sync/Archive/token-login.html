<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Xác thực mã truy cập - eTax</title>
  <link rel="stylesheet" href="style.css">
  <!-- Firebase CDN: chỉ để 1 lần! -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>
  <div class="token-frame">
    <div class="token-title">Xác thực mã truy cập</div>
    <div class="token-desc">Nhập mã token truy cập do quản trị viên cấp riêng cho thiết bị này để tiếp tục sử dụng dịch vụ.</div>
    <input class="token-input" id="token" placeholder="Nhập mã token..." autocomplete="off" autofocus>
    <div class="token-error" id="error"></div>
    <button class="token-btn" onclick="verifyToken()">Xác nhận truy cập</button>
    <div class="token-note">Bảo mật mỗi phiên: mã token chỉ dùng cho 1 thiết bị/máy.</div>
  </div>
  <script>
    // CẤU HÌNH CHUẨN DỰ ÁN E-TAX CỦA SẾP
    const firebaseConfig = {
      apiKey: "AIzaSyD_rJgBFgBulheVenQUE2KXr4PBpSpTCxw",
      authDomain: "etax-7fbf8.firebaseapp.com",
      databaseURL: "https://etax-7fbf8-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "etax-7fbf8",
      storageBucket: "etax-7fbf8.appspot.com",
      messagingSenderId: "1030026724634",
      appId: "1:1030026724634:web:d76f5f9dad43bad6fd58a3",
      measurementId: "G-YS5DLECJE6"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Nếu đã xác thực thì tự vào login
    if (localStorage.getItem('etax_token_verified') === 'true') {
      window.location.href = 'login.html';
    }

    // Hàm xác thực token, kiểm tra cả /accessTokens và /tokens
    function verifyToken() {
      var token = document.getElementById('token').value.trim();
      var errorEl = document.getElementById('error');
      if (!token) {
        errorEl.innerText = 'Nhập mã token truy cập!'; return;
      }
      db.ref('accessTokens/' + token).get().then(function(snap1) {
        if (snap1.exists()) {
          localStorage.setItem('etax_token_verified', 'true');
          window.location.href = 'login.html';
        } else {
          db.ref('tokens/' + token).get().then(function(snap2) {
            if (snap2.exists()) {
              localStorage.setItem('etax_token_verified', 'true');
              window.location.href = 'login.html';
            } else {
              errorEl.innerText = 'Mã token không đúng, vui lòng kiểm tra lại!';
            }
          });
        }
      });
    }
  </script>
</body>
</html>
