<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Xác thực thiết bị - eTax</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .token-container {
      background: white;
      border-radius: 20px;
      padding: 40px 30px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      text-align: center;
    }
    
    .logo {
      width: 80px;
      height: 80px;
      background: #d62828;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      color: white;
      font-size: 24px;
      font-weight: bold;
    }
    
    .title {
      font-size: 24px;
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      line-height: 1.5;
    }
    
    .input-group {
      margin-bottom: 20px;
      text-align: left;
    }
    
    .input-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
    }
    
    .token-input {
      width: 100%;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 16px;
      transition: border-color 0.3s;
      box-sizing: border-box;
    }
    
    .token-input:focus {
      outline: none;
      border-color: #d62828;
    }
    
    .verify-btn {
      width: 100%;
      background: #d62828;
      color: white;
      border: none;
      padding: 15px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .verify-btn:hover {
      background: #b71c1c;
    }
    
    .verify-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .error-msg {
      color: #f44336;
      margin-top: 15px;
      display: none;
    }
    
    .success-msg {
      color: #4caf50;
      margin-top: 15px;
      display: none;
    }
    
    .device-info {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 15px;
      margin-top: 20px;
      font-size: 14px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="token-container">
    <div class="logo">eTax</div>
    <h1 class="title">Xác thực thiết bị</h1>
    <p class="subtitle">Nhập token được cấp để kích hoạt thiết bị này sử dụng dịch vụ eTax Mobile</p>
    
    <div class="input-group">
      <label class="input-label" for="deviceToken">Token xác thực:</label>
      <input 
        type="text" 
        id="deviceToken" 
        class="token-input" 
        placeholder="Nhập token được cấp..." 
        autocomplete="off"
        maxlength="20"
      />
    </div>
    
    <button class="verify-btn" onclick="verifyDeviceToken()" id="verifyBtn">
      Xác thực thiết bị
    </button>
    
    <div class="error-msg" id="errorMsg"></div>
    <div class="success-msg" id="successMsg"></div>
    
    <div class="device-info">
      <strong>Lưu ý:</strong> Token chỉ có thể sử dụng một lần duy nhất. Sau khi xác thực thành công, thiết bị này sẽ được ghi nhớ và bạn có thể đăng nhập trực tiếp.
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD_rJgBFgBulheVenQUE2KXr4PBpSpTCxw",
      authDomain: "etax-7fbf8.firebaseapp.com",
      databaseURL: "https://etax-7fbf8-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "etax-7fbf8",
      storageBucket: "etax-7fbf8.appspot.com",
      messagingSenderId: "1030026724634",
      appId: "1:1030026724634:web:d76f5f9dad43bad6fd58a3",
      measurementId: "G-YS5DLECJE6"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Tạo ID thiết bị duy nhất
    function generateDeviceId() {
      return 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // Kiểm tra thiết bị đã được xác thực chưa
    function checkDeviceStatus() {
      const deviceId = localStorage.getItem('etax_device_id');
      const deviceVerified = localStorage.getItem('etax_device_verified');
      
      if (deviceId && deviceVerified === 'true') {
        // Thiết bị đã xác thực, chuyển thẳng tới login
        showSuccess('Thiết bị đã được xác thực. Đang chuyển tới trang đăng nhập...');
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 2000);
        return true;
      }
      return false;
    }

    // Xác thực token
    async function verifyDeviceToken() {
      const token = document.getElementById('deviceToken').value.trim();
      const errorEl = document.getElementById('errorMsg');
      const successEl = document.getElementById('successMsg');
      const verifyBtn = document.getElementById('verifyBtn');
      
      if (!token) {
        showError('Vui lòng nhập token xác thực!');
        return;
      }

      // Disable button và hiển thị loading
      verifyBtn.disabled = true;
      verifyBtn.textContent = 'Đang xác thực...';
      hideMessages();

      try {
        // Kiểm tra token trong database
        const tokenRef = db.ref('deviceTokens/' + token);
        const snapshot = await tokenRef.once('value');
        
        if (!snapshot.exists()) {
          showError('Token không hợp lệ hoặc đã được sử dụng!');
          resetButton();
          return;
        }

        const tokenData = snapshot.val();
        
        // Kiểm tra token đã được sử dụng chưa
        if (tokenData.used === true) {
          showError('Token này đã được sử dụng trên thiết bị khác!');
          resetButton();
          return;
        }

        // Kiểm tra token hết hạn chưa (nếu có)
        if (tokenData.expiresAt && Date.now() > tokenData.expiresAt) {
          showError('Token đã hết hạn!');
          resetButton();
          return;
        }

        // Tạo device ID và lưu thông tin
        let deviceId = localStorage.getItem('etax_device_id');
        if (!deviceId) {
          deviceId = generateDeviceId();
          localStorage.setItem('etax_device_id', deviceId);
        }

        // Đánh dấu token đã được sử dụng
        await tokenRef.update({
          used: true,
          usedAt: Date.now(),
          deviceId: deviceId,
          userAgent: navigator.userAgent
        });

        // Lưu trạng thái xác thực vào localStorage
        localStorage.setItem('etax_device_verified', 'true');
        localStorage.setItem('etax_token_used', token);
        
        // Lưu thông tin liên kết user nếu có
        if (tokenData.linkedUserId) {
          localStorage.setItem('etax_linked_user', tokenData.linkedUserId);
        }

        showSuccess('Xác thực thành công! Thiết bị đã được kích hoạt. Đang chuyển tới trang đăng nhập...');
        
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 3000);

      } catch (error) {
        console.error('Error verifying token:', error);
        showError('Có lỗi xảy ra khi xác thực. Vui lòng thử lại!');
        resetButton();
      }
    }

    function resetButton() {
      const verifyBtn = document.getElementById('verifyBtn');
      verifyBtn.disabled = false;
      verifyBtn.textContent = 'Xác thực thiết bị';
    }

    function showError(message) {
      const errorEl = document.getElementById('errorMsg');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      document.getElementById('successMsg').style.display = 'none';
    }

    function showSuccess(message) {
      const successEl = document.getElementById('successMsg');
      successEl.textContent = message;
      successEl.style.display = 'block';
      document.getElementById('errorMsg').style.display = 'none';
    }

    function hideMessages() {
      document.getElementById('errorMsg').style.display = 'none';
      document.getElementById('successMsg').style.display = 'none';
    }

    // Enter key support
    document.getElementById('deviceToken').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        verifyDeviceToken();
      }
    });

    // Kiểm tra khi trang load
    window.addEventListener('load', function() {
      checkDeviceStatus();
    });
  </script>
</body>
</html>