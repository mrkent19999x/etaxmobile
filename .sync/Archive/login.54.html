<!DOCTYPE html>
<html lang="vi">
<head>
  <!-- PWA Meta Tags -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="eTax Mobile">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#d62828">

  <!-- PWA Icons -->
  <link rel="apple-touch-icon" href="assets/logo.png">
  <link rel="icon" type="image/png" href="assets/logo.png">
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <title>eTax Mobile - Đăng nhập</title>

  <style>
    * {
  box-sizing: border-box;
}
body {
  margin: 0;
}
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  touch-action:manipulation;
  -webkit-overflow-scrolling:touch;
  -webkit-tap-highlight-color:transparent;
}
html, body{
  margin:0 !important;
  padding:0 !important;
  width:100vw;
  min-width:100vw;
  height:100vh;
  min-height:100vh;
  overflow-x:hidden;
  background:#000 !important;
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
  align-items:center;
}
body{
  font-family:'Roboto', sans-serif;
  color:white;
  animation:fadeIn 1.2s ease-in;
}
.phone-frame{
  width:100vw !important;
  max-width:100vw !important;
  min-height:100vh !important;
  background-image:url('assets/bglogin.png');
  background-size:cover;
  background-repeat:no-repeat;
  background-position:center center;
  border-radius:0 !important;
  undefined:undefined;
  margin:0 !important;
  box-shadow:none !important;
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
  align-items:stretch;
  overflow:hidden;
}
.container{
  width:100%;
  max-width:420px;
  margin:0 auto;
  padding:24px 16px;
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
  min-height:100vh;
  background:transparent;
  undefined:undefined;
}
.logo-wrapper{
  text-align:center;
  margin-top:32px;
  margin-bottom:12px;
}
.logo{
  width:90px;
  margin-bottom:8px;
}
.title{
  font-size:20px;
  font-weight:500;
  color:white;
}
.login-form{
  display:flex;
  flex-direction:column;
  gap:14px;
  align-items:stretch;
  animation:fadeIn 1.5s ease-in-out;
  width: 100%;
  margin:0 auto;
}
.form-group{
  display:flex;
  flex-direction:column;
  align-items:flex-start;
  position:relative;
}
.form-group label{
  font-size:13px;
  margin-bottom:4px;
  color:#fff;
}
.form-group input{
  width:100%;
  padding:12px 12px 12px 44px;
  border:none;
  border-radius:8px;
  font-size:16px;
  undefined:undefined;
  background-color:transparent;
  border-bottom:1px solid white;
  color:white;
  outline:none;
}
.form-group input::placeholder{
  color:rgba(255, 255, 255, 0.7);
}
.input-icon-wrap{
  position:relative;
  width:100%;
  display:flex;
  align-items:center;
}
.input-icon-wrap i.fa-user-large, .input-icon-wrap i.fa-lock{
  position:absolute;
  left:14px;
  color:#bdbdbd;
  font-size:20px;
  top:50%;
  transform:translateY(-50%);
  z-index:2;
}
.input-icon-wrap i.fa-eye, .input-icon-wrap i.fa-eye-slash{
  position:absolute;
  right:14px;
  color:#bdbdbd;
  font-size:20px;
  top:50%;
  transform:translateY(-50%);
  z-index:2;
  cursor:pointer;
}
.links{
  display:flex;
  justify-content:space-between;
  font-size:13px;
  color:yellow;
  margin:-5px 0 10px;
}
.links a{
  color:yellow;
  text-decoration:none;
}
.btn-login{
  background-color:#e60000;
  color:#fff;
  padding:14px;
  font-size:16px;
  border:none;
  border-radius:25px;
  font-weight:bold;
  cursor:pointer;
  transition:all 0.3s ease;
  width:100%;
  max-width:340px;
  margin:0 auto;
  display:block;
}
.btn-login:hover{
  background-color:#cc0000;
  transform:translateY(-1px);
}
.btn-login:disabled{
  background-color:#666;
  cursor:not-allowed;
  transform:none;
}
.btn-id {
  display: flex;
  align-items: center; /* Căn giữa icon + chữ theo chiều dọc */
  justify-content: space-between;
  background: #fff;
  border-radius: 12px;
  padding: 0 16px;
  color: #000;
  gap: 12px;
  min-height: 64px;
}



.text-box {
  display: flex;
  flex-direction: column;
  justify-content: center;      /* ✅ Căn giữa 2 dòng chữ theo chiều dọc */
  align-items: flex-start;      /* ✅ Căn trái chữ như ảnh gốc */
  height: 100%;                 /* ✅ Bắt buộc để justify-center hoạt động */
  line-height: 1.3;
}




.line1 {
  font-size: 15px;
}

.line2 {
  font-size: 15px;
  font-weight: bold;
  margin-top: 2px;
}

.icon-wrap img{
  height:36px;
  object-fit:contain;
}
.register{
  text-align:center;
  font-size:13px;
  color:white;
}
.register a{
  color:yellow;
  text-decoration:none;
}
.bottom-nav{
  display:flex;
  justify-content:space-around;
  font-size:12px;
  padding:8px 0;
  border-top:1px solid rgba(255, 255, 255, 0.1);
  color:white;
}
.bottom-nav div{
  text-align:center;
}
.bottom-nav img{
  height:32px;
  margin-bottom:4px;
  display:block;
  margin-left:auto;
  margin-right:auto;
}
.flex{
  display:flex;
}
.flex-column{
  flex-direction:column;
}
.items-center{
  align-items:center;
}
#idtpf{
  margin:28px;
}
#iad3f{
  padding-left:44px;
}
#itguy{
  padding-left:44px;
}
#iuevn{
  margin:25px;
}
#iueh8{
  margin:20px;
}
#iruof{
  height:60px;
}
@keyframes fadeIn{
  0%{
    opacity:0;
  }
  100%{
    opacity:1;
  }
}
@keyframes spin{
  to{
    transform:rotate(360deg);
  }
}
@keyframes slideInFromTop{
  from{
    opacity:0;
    transform:translateY(-20px);
  }
  to{
    opacity:1;
    transform:translateY(0);
  }
}
@keyframes shake{
  0%, 20%, 40%, 60%, 80%, 100%{
    transform:translateX(0);
  }
  10%, 30%, 50%, 70%, 90%{
    transform:translateX(-5px);
  }
}
@media (min-width: 601px){
  .phone-frame{
    border-radius:30px !important;
    margin:32px auto !important;
    box-shadow:0 0 20px rgba(0,0,0,0.3) !important;
    width:400px !important;
    max-width:400px !important;
  }
}
@media (max-width: 480px){
  #iryz1{
    float:right;
  }
  #iyofu{
    text-align:center;
  }
  #itdmi{
    text-align:center;
  }
}

  </style>
</head>

<body>
    
  <div class="phone-frame">
    <div class="container">
      <div class="logo-wrapper">
        <img src="assets/logo.png" alt="Logo Thuế" class="logo" />
        <h1 class="title">eTax Mobile</h1>
      </div>
      <div style="margin: 28px;"></div>
      
      <!-- Message Container -->
      <div id="messageContainer"></div>
      
      <form class="login-form" onsubmit="return false;">
        <div class="form-group" id="tax-id-group">
          <label for="tax-id" style="padding-left: 44px;">Mã số thuế</label>
          <div class="input-icon-wrap">
            <i class="fa-solid fa-user-large"></i>
            <input type="text" id="tax-id" placeholder="Mã số thuế" />
          </div>
        </div>
        <div class="form-group password-group">
          <label for="password" style="padding-left: 44px;">Mật khẩu</label>
          <div class="input-icon-wrap">
            <i class="fa-solid fa-lock"></i>
            <input type="password" id="password" placeholder="Mật khẩu" />
            <i class="fa-solid fa-eye" id="togglePassword" onclick="togglePassword()"></i>
          </div>
        </div>
        <div class="links">
          <a href="#">Quên tài khoản (mã số thuế)?</a>
          <a href="#">Quên mật khẩu?</a>
        </div>
        <button type="button" class="btn-login" id="loginBtn" onclick="login()">
          Đăng nhập
        </button>
        <div style="
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: white;
  border-radius: 12px;
  padding: 12px 16px;
  color: black;
  width: 100%;
  max-width: 360px;
  margin: 0 auto;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
">
  <div style="
    display: flex;
    flex-direction: column;
    justify-content: center;
    font-size: 14px;
    line-height: 1.4;
  ">
    <div>Đăng nhập bằng tài khoản</div>
    <div><strong>Định danh điện tử</strong></div>
  </div>
  <div>
    <img src="assets/nvid.png" alt="VNID Icon" style="
      height: 40px;
      width: 40px;
      object-fit: contain;
    ">
  </div>
</div>

      </form>
      <div style="margin: 25px; te"></div>
      <p class="register">Bạn chưa có tài khoản? <a href="#">Đăng ký ngay</a></p>
      <div style="margin: 20px;"></div>
      <div class="bottom-nav" style="height: 60px;">
        <div class="flex flex-column items-center">
          <img src="assets/icon-qr.png" />
          <div>QR tem</div>
        </div>
        <div class="flex flex-column items-center">
          <img src="assets/tienich.png" />
          <div>Tiện ích</div>
        </div>
        <div class="flex flex-column items-center">
          <img src="assets/hotro.png" />
          <div>Hỗ trợ</div>
        </div>
        <div class="flex flex-column items-center">
          <img src="assets/chiase.png" />
          <div>Chia sẻ</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // ===== FIREBASE CONFIGURATION =====
    const firebaseConfig = {
      apiKey: "AIzaSyD_rJgBFgBulheVenQUE2KXr4PBpSpTCxw",
      authDomain: "etax-7fbf8.firebaseapp.com",
      databaseURL: "https://etax-7fbf8-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "etax-7fbf8",
      storageBucket: "etax-7fbf8.appspot.com",
      messagingSenderId: "1030026724634",
      appId: "1:1030026724634:web:d76f5f9dad43bad6fd58a3",
      measurementId: "G-YS5DLECJE6"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ===== AUTHENTICATION FLOW =====
    document.addEventListener('DOMContentLoaded', function() {
      console.log('=== LOGIN PAGE DEBUG ===');
      checkTokenVerification();
    });

    function checkTokenVerification() {
      const tokenVerified = localStorage.getItem('etax_token_verified');
      const deviceVerified = localStorage.getItem('etax_device_verified');
      const userLoggedIn = localStorage.getItem('etax_logged_in_user');
      
      console.log('Token verified:', tokenVerified);
      console.log('Device verified:', deviceVerified);
      console.log('User logged in:', userLoggedIn);
      
      // Nếu user đã đăng nhập rồi, cho phép bypass token check
      if (userLoggedIn) {
        console.log('✅ User đã đăng nhập, bypass token check');
        initializeLoginPage();
        return;
      }
      
      // Nếu chưa verify token, chuyển về token-login
      if (tokenVerified !== 'true' || deviceVerified !== 'true') {
        console.log('❌ Token chưa được verify, chuyển về token-login');
        setTimeout(() => {
          window.location.href = 'token-login.html';
        }, 100);
        return;
      }
      
      console.log('✅ Token đã verify, có thể đăng nhập');
      initializeLoginPage();
    }

    function initializeLoginPage() {
      console.log('🚀 Khởi tạo trang login thành công');
      
      // Focus vào field đầu tiên
      const firstInput = document.getElementById('tax-id');
      if (firstInput) {
        setTimeout(() => firstInput.focus(), 500);
      }
      
      // Kiểm tra nếu có thông tin user đã lưu
      const savedUser = localStorage.getItem('etax_logged_in_user');
      if (savedUser) {
        document.getElementById('tax-id').value = savedUser;
        setTimeout(() => {
          document.getElementById('password').focus();
        }, 600);
      }
    }

    // ===== MAIN LOGIN FUNCTION =====
    async function login() {
      const userId = document.getElementById("tax-id").value.trim();
      const password = document.getElementById("password").value.trim();
      const loginBtn = document.getElementById("loginBtn");

      // Validation
      if (!userId || !password) {
        showMessage("❌ Vui lòng nhập đầy đủ Mã số thuế và Mật khẩu", "error");
        return;
      }

      // Set loading state
      setButtonLoading(loginBtn, true);

      try {
        // Xác thực với Firebase
        const snapshot = await db.ref("users/" + userId).once("value");
        
        if (snapshot.exists()) {
          const userData = snapshot.val();
          
          if (userData.password === password) {
            // Đăng nhập thành công
            await handleSuccessfulLogin(userId, userData);
          } else {
            showMessage("❌ Sai mật khẩu. Vui lòng thử lại.", "error");
          }
        } else {
          showMessage("❌ Không tìm thấy người dùng với MST này.", "error");
        }
        
      } catch (error) {
        console.error("Login error:", error);
        showMessage("❌ Có lỗi kết nối. Vui lòng thử lại sau.", "error");
      } finally {
        setButtonLoading(loginBtn, false);
      }
    }

    // ===== HANDLE SUCCESSFUL LOGIN =====
    async function handleSuccessfulLogin(userId, userData) {
      console.log('🎉 Đăng nhập thành công cho user:', userId);
      
      // Lưu thông tin user vào localStorage
      localStorage.setItem("etax_logged_in_user", userId);
      localStorage.setItem("etax_user_info", JSON.stringify({
        mst: userId,
        name: userData.name,
        address: userData.address || "",
        taxoffice: userData.taxoffice || "",
        date: userData.date,
        password: userData.password,
        role: userData.role,
        token: userData.linkedToken || userData.token,
        duration: userData.duration
      }));
      
      // Lưu trạng thái đăng nhập để bypass token check
      localStorage.setItem("etax_login_success", "true");
      localStorage.setItem("etax_login_timestamp", Date.now().toString());
      
      // Log activity
      try {
        await db.ref('activityLogs').push({
          type: 'user_login',
          userId: userId,
          timestamp: Date.now(),
          details: `User ${userId} đăng nhập thành công`,
          deviceInfo: getUserAgent()
        });
      } catch (logError) {
        console.warn('Failed to log activity:', logError);
      }
      
      // Hiển thị thông báo thành công
      showMessage("🎉 Đăng nhập thành công! Đang chuyển hướng...", "success");
      
      // Chuyển hướng sau 1.5 giây
      setTimeout(() => {
        window.location.href = "index.html";
      }, 1500);
    }

    // ===== HELPER FUNCTIONS =====
    function togglePassword() {
      const passwordInput = document.getElementById("password");
      const eyeIcon = document.getElementById("togglePassword");
      
      if (passwordInput.type === "password") {
        passwordInput.type = "text";
        eyeIcon.classList.remove("fa-eye");
        eyeIcon.classList.add("fa-eye-slash");
      } else {
        passwordInput.type = "password";
        eyeIcon.classList.remove("fa-eye-slash");
        eyeIcon.classList.add("fa-eye");
      }
    }

    function setButtonLoading(button, loading) {
      if (loading) {
        button.disabled = true;
        button.innerHTML = '<span class="loading-spinner"></span> Đang đăng nhập...';
      } else {
        button.disabled = false;
        button.innerHTML = 'Đăng nhập';
      }
    }

    function showMessage(message, type = 'info') {
      const container = document.getElementById('messageContainer');
      
      // Remove existing messages
      container.innerHTML = '';
      
      // Create new message
      const messageDiv = document.createElement('div');
      messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
      messageDiv.textContent = message;
      
      container.appendChild(messageDiv);
      
      // Auto-hide after 5 seconds for non-success messages
      if (type !== 'success') {
        setTimeout(() => {
          messageDiv.remove();
        }, 5000);
      }
    }

    function getUserAgent() {
      return {
        userAgent: navigator.userAgent,
        platform: navigator.platform,
        language: navigator.language,
        screen: `${screen.width}x${screen.height}`,
        timestamp: Date.now()
      };
    }

    // ===== KEYBOARD SUPPORT =====
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        login();
      }
    });

    // ===== AUTO-FILL SUPPORT =====
    document.getElementById('tax-id').addEventListener('input', function() {
      // Remove any non-numeric characters for MST
      const value = this.value.replace(/[^0-9]/g, '');
      if (this.value !== value) {
        this.value = value;
      }
    });

    // ===== ERROR HANDLING =====
    window.addEventListener('error', function(event) {
      console.error('Login page error:', event.error);
      
      if (event.error.message.includes('Firebase') || event.error.message.includes('network')) {
        showMessage('❌ Có lỗi kết nối. Vui lòng thử lại.', 'error');
      }
    });

    console.log('🚀 Login.html initialized successfully');
  </script>
</body>
</html>