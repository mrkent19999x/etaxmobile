<!DOCTYPE html>
<html lang="vi">
<head>
  <!-- PWA Meta Tags -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="eTax Mobile">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#d62828">

  <!-- PWA Icons -->
  <link rel="apple-touch-icon" href="assets/logo.png">
  <link rel="icon" type="image/png" href="assets/logo.png">
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <title>eTax Mobile - ƒêƒÉng nh·∫≠p</title>

  <style>
    * {
  box-sizing: border-box;
}
body {
  margin: 0;
}
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  touch-action:manipulation;
  -webkit-overflow-scrolling:touch;
  -webkit-tap-highlight-color:transparent;
}
html, body{
  margin:0 !important;
  padding:0 !important;
  width:100vw;
  min-width:100vw;
  height:100vh;
  min-height:100vh;
  overflow-x:hidden;
  background:#000 !important;
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
  align-items:center;
}
body{
  font-family:'Roboto', sans-serif;
  color:white;
  animation:fadeIn 1.2s ease-in;
}
.phone-frame{
  width:100vw !important;
  max-width:100vw !important;
  min-height:100vh !important;
  background-image:url('assets/bglogin.png');
  background-size:cover;
  background-repeat:no-repeat;
  background-position:center center;
  border-radius:0 !important;
  undefined:undefined;
  margin:0 !important;
  box-shadow:none !important;
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
  align-items:stretch;
  overflow:hidden;
}
.container{
  width:100%;
  max-width:420px;
  margin:0 auto;
  padding:24px 16px;
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
  min-height:100vh;
  background:transparent;
  undefined:undefined;
}
.logo-wrapper{
  text-align:center;
  margin-top:32px;
  margin-bottom:12px;
}
.logo{
  width:90px;
  margin-bottom:8px;
}
.title{
  font-size:20px;
  font-weight:500;
  color:white;
}
.login-form{
  display:flex;
  flex-direction:column;
  gap:14px;
  align-items:stretch;
  animation:fadeIn 1.5s ease-in-out;
  width: 100%;
  margin:0 auto;
}
.form-group{
  display:flex;
  flex-direction:column;
  align-items:flex-start;
  position:relative;
}
.form-group label{
  font-size:13px;
  margin-bottom:4px;
  color:#fff;
}
.form-group input{
  width:100%;
  padding:12px 12px 12px 44px;
  border:none;
  border-radius:8px;
  font-size:16px;
  undefined:undefined;
  background-color:transparent;
  border-bottom:1px solid white;
  color:white;
  outline:none;
}
.form-group input::placeholder{
  color:rgba(255, 255, 255, 0.7);
}
.input-icon-wrap{
  position:relative;
  width:100%;
  display:flex;
  align-items:center;
}
.input-icon-wrap i.fa-user-large, .input-icon-wrap i.fa-lock{
  position:absolute;
  left:14px;
  color:#bdbdbd;
  font-size:20px;
  top:50%;
  transform:translateY(-50%);
  z-index:2;
}
.input-icon-wrap i.fa-eye, .input-icon-wrap i.fa-eye-slash{
  position:absolute;
  right:14px;
  color:#bdbdbd;
  font-size:20px;
  top:50%;
  transform:translateY(-50%);
  z-index:2;
  cursor:pointer;
}
.links{
  display:flex;
  justify-content:space-between;
  font-size:13px;
  color:yellow;
  margin:-5px 0 10px;
}
.links a{
  color:yellow;
  text-decoration:none;
}
.btn-login{
  background-color:#e60000;
  color:#fff;
  padding:14px;
  font-size:16px;
  border:none;
  border-radius:25px;
  font-weight:bold;
  cursor:pointer;
  transition:all 0.3s ease;
  width:100%;
  max-width:340px;
  margin:0 auto;
  display:block;
}
.btn-login:hover{
  background-color:#cc0000;
  transform:translateY(-1px);
}
.btn-login:disabled{
  background-color:#666;
  cursor:not-allowed;
  transform:none;
}
.btn-id {
  display: flex;
  align-items: center; /* CƒÉn gi·ªØa icon + ch·ªØ theo chi·ªÅu d·ªçc */
  justify-content: space-between;
  background: #fff;
  border-radius: 12px;
  padding: 0 16px;
  color: #000;
  gap: 12px;
  min-height: 64px;
}



.text-box {
  display: flex;
  flex-direction: column;
  justify-content: center;      /* ‚úÖ CƒÉn gi·ªØa 2 d√≤ng ch·ªØ theo chi·ªÅu d·ªçc */
  align-items: flex-start;      /* ‚úÖ CƒÉn tr√°i ch·ªØ nh∆∞ ·∫£nh g·ªëc */
  height: 100%;                 /* ‚úÖ B·∫Øt bu·ªôc ƒë·ªÉ justify-center ho·∫°t ƒë·ªông */
  line-height: 1.3;
}




.line1 {
  font-size: 15px;
}

.line2 {
  font-size: 15px;
  font-weight: bold;
  margin-top: 2px;
}

.icon-wrap img{
  height:36px;
  object-fit:contain;
}
.register{
  text-align:center;
  font-size:13px;
  color:white;
}
.register a{
  color:yellow;
  text-decoration:none;
}
.bottom-nav{
  display:flex;
  justify-content:space-around;
  font-size:12px;
  padding:8px 0;
  border-top:1px solid rgba(255, 255, 255, 0.1);
  color:white;
}
.bottom-nav div{
  text-align:center;
}
.bottom-nav img{
  height:32px;
  margin-bottom:4px;
  display:block;
  margin-left:auto;
  margin-right:auto;
}
.flex{
  display:flex;
}
.flex-column{
  flex-direction:column;
}
.items-center{
  align-items:center;
}
#idtpf{
  margin:28px;
}
#iad3f{
  padding-left:44px;
}
#itguy{
  padding-left:44px;
}
#iuevn{
  margin:25px;
}
#iueh8{
  margin:20px;
}
#iruof{
  height:60px;
}
@keyframes fadeIn{
  0%{
    opacity:0;
  }
  100%{
    opacity:1;
  }
}
@keyframes spin{
  to{
    transform:rotate(360deg);
  }
}
@keyframes slideInFromTop{
  from{
    opacity:0;
    transform:translateY(-20px);
  }
  to{
    opacity:1;
    transform:translateY(0);
  }
}
@keyframes shake{
  0%, 20%, 40%, 60%, 80%, 100%{
    transform:translateX(0);
  }
  10%, 30%, 50%, 70%, 90%{
    transform:translateX(-5px);
  }
}
@media (min-width: 601px){
  .phone-frame{
    border-radius:30px !important;
    margin:32px auto !important;
    box-shadow:0 0 20px rgba(0,0,0,0.3) !important;
    width:400px !important;
    max-width:400px !important;
  }
}
@media (max-width: 480px){
  #iryz1{
    float:right;
  }
  #iyofu{
    text-align:center;
  }
  #itdmi{
    text-align:center;
  }
}

  </style>
</head>

<body>
    
  <div class="phone-frame">
    <div class="container">
      <div class="logo-wrapper">
        <img src="assets/logo.png" alt="Logo Thu·∫ø" class="logo" />
        <h1 class="title">eTax Mobile</h1>
      </div>
      <div style="margin: 28px;"></div>
      
      <!-- Message Container -->
      <div id="messageContainer"></div>
      
      <form class="login-form" onsubmit="return false;">
        <div class="form-group" id="tax-id-group">
          <label for="tax-id" style="padding-left: 44px;">M√£ s·ªë thu·∫ø</label>
          <div class="input-icon-wrap">
            <i class="fa-solid fa-user-large"></i>
            <input type="text" id="tax-id" placeholder="M√£ s·ªë thu·∫ø" />
          </div>
        </div>
        <div class="form-group password-group">
          <label for="password" style="padding-left: 44px;">M·∫≠t kh·∫©u</label>
          <div class="input-icon-wrap">
            <i class="fa-solid fa-lock"></i>
            <input type="password" id="password" placeholder="M·∫≠t kh·∫©u" />
            <i class="fa-solid fa-eye" id="togglePassword" onclick="togglePassword()"></i>
          </div>
        </div>
        <div class="links">
          <a href="#">Qu√™n t√†i kho·∫£n (m√£ s·ªë thu·∫ø)?</a>
          <a href="#">Qu√™n m·∫≠t kh·∫©u?</a>
        </div>
        <button type="button" class="btn-login" id="loginBtn" onclick="login()">
          ƒêƒÉng nh·∫≠p
        </button>
        <div style="
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: white;
  border-radius: 12px;
  padding: 12px 16px;
  color: black;
  width: 100%;
  max-width: 360px;
  margin: 0 auto;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
">
  <div style="
    display: flex;
    flex-direction: column;
    justify-content: center;
    font-size: 14px;
    line-height: 1.4;
  ">
    <div>ƒêƒÉng nh·∫≠p b·∫±ng t√†i kho·∫£n</div>
    <div><strong>ƒê·ªãnh danh ƒëi·ªán t·ª≠</strong></div>
  </div>
  <div>
    <img src="assets/nvid.png" alt="VNID Icon" style="
      height: 40px;
      width: 40px;
      object-fit: contain;
    ">
  </div>
</div>

      </form>
      <div style="margin: 25px; te"></div>
      <p class="register">B·∫°n ch∆∞a c√≥ t√†i kho·∫£n? <a href="#">ƒêƒÉng k√Ω ngay</a></p>
      <div style="margin: 20px;"></div>
      <div class="bottom-nav" style="height: 60px;">
        <div class="flex flex-column items-center">
          <img src="assets/icon-qr.png" />
          <div>QR tem</div>
        </div>
        <div class="flex flex-column items-center">
          <img src="assets/tienich.png" />
          <div>Ti·ªán √≠ch</div>
        </div>
        <div class="flex flex-column items-center">
          <img src="assets/hotro.png" />
          <div>H·ªó tr·ª£</div>
        </div>
        <div class="flex flex-column items-center">
          <img src="assets/chiase.png" />
          <div>Chia s·∫ª</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // ===== FIREBASE CONFIGURATION =====
    const firebaseConfig = {
      apiKey: "AIzaSyD_rJgBFgBulheVenQUE2KXr4PBpSpTCxw",
      authDomain: "etax-7fbf8.firebaseapp.com",
      databaseURL: "https://etax-7fbf8-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "etax-7fbf8",
      storageBucket: "etax-7fbf8.appspot.com",
      messagingSenderId: "1030026724634",
      appId: "1:1030026724634:web:d76f5f9dad43bad6fd58a3",
      measurementId: "G-YS5DLECJE6"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ===== AUTHENTICATION FLOW =====
    document.addEventListener('DOMContentLoaded', function() {
      console.log('=== LOGIN PAGE DEBUG ===');
      checkTokenVerification();
    });

    function checkTokenVerification() {
      const tokenVerified = localStorage.getItem('etax_token_verified');
      const deviceVerified = localStorage.getItem('etax_device_verified');
      const userLoggedIn = localStorage.getItem('etax_logged_in_user');
      
      console.log('Token verified:', tokenVerified);
      console.log('Device verified:', deviceVerified);
      console.log('User logged in:', userLoggedIn);
      
      // N·∫øu user ƒë√£ ƒëƒÉng nh·∫≠p r·ªìi, cho ph√©p bypass token check
      if (userLoggedIn) {
        console.log('‚úÖ User ƒë√£ ƒëƒÉng nh·∫≠p, bypass token check');
        initializeLoginPage();
        return;
      }
      
      // N·∫øu ch∆∞a verify token, chuy·ªÉn v·ªÅ token-login
      if (tokenVerified !== 'true' || deviceVerified !== 'true') {
        console.log('‚ùå Token ch∆∞a ƒë∆∞·ª£c verify, chuy·ªÉn v·ªÅ token-login');
        setTimeout(() => {
          window.location.href = 'token-login.html';
        }, 100);
        return;
      }
      
      console.log('‚úÖ Token ƒë√£ verify, c√≥ th·ªÉ ƒëƒÉng nh·∫≠p');
      initializeLoginPage();
    }

    function initializeLoginPage() {
      console.log('üöÄ Kh·ªüi t·∫°o trang login th√†nh c√¥ng');
      
      // Focus v√†o field ƒë·∫ßu ti√™n
      const firstInput = document.getElementById('tax-id');
      if (firstInput) {
        setTimeout(() => firstInput.focus(), 500);
      }
      
      // Ki·ªÉm tra n·∫øu c√≥ th√¥ng tin user ƒë√£ l∆∞u
      const savedUser = localStorage.getItem('etax_logged_in_user');
      if (savedUser) {
        document.getElementById('tax-id').value = savedUser;
        setTimeout(() => {
          document.getElementById('password').focus();
        }, 600);
      }
    }

    // ===== MAIN LOGIN FUNCTION =====
    async function login() {
      const userId = document.getElementById("tax-id").value.trim();
      const password = document.getElementById("password").value.trim();
      const loginBtn = document.getElementById("loginBtn");

      // Validation
      if (!userId || !password) {
        showMessage("‚ùå Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß M√£ s·ªë thu·∫ø v√† M·∫≠t kh·∫©u", "error");
        return;
      }

      // Set loading state
      setButtonLoading(loginBtn, true);

      try {
        // X√°c th·ª±c v·ªõi Firebase
        const snapshot = await db.ref("users/" + userId).once("value");
        
        if (snapshot.exists()) {
          const userData = snapshot.val();
          
          if (userData.password === password) {
            // ƒêƒÉng nh·∫≠p th√†nh c√¥ng
            await handleSuccessfulLogin(userId, userData);
          } else {
            showMessage("‚ùå Sai m·∫≠t kh·∫©u. Vui l√≤ng th·ª≠ l·∫°i.", "error");
          }
        } else {
          showMessage("‚ùå Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng v·ªõi MST n√†y.", "error");
        }
        
      } catch (error) {
        console.error("Login error:", error);
        showMessage("‚ùå C√≥ l·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i sau.", "error");
      } finally {
        setButtonLoading(loginBtn, false);
      }
    }

    // ===== HANDLE SUCCESSFUL LOGIN =====
    async function handleSuccessfulLogin(userId, userData) {
      console.log('üéâ ƒêƒÉng nh·∫≠p th√†nh c√¥ng cho user:', userId);
      
      // L∆∞u th√¥ng tin user v√†o localStorage
      localStorage.setItem("etax_logged_in_user", userId);
      localStorage.setItem("etax_user_info", JSON.stringify({
        mst: userId,
        name: userData.name,
        address: userData.address || "",
        taxoffice: userData.taxoffice || "",
        date: userData.date,
        password: userData.password,
        role: userData.role,
        token: userData.linkedToken || userData.token,
        duration: userData.duration
      }));
      
      // L∆∞u tr·∫°ng th√°i ƒëƒÉng nh·∫≠p ƒë·ªÉ bypass token check
      localStorage.setItem("etax_login_success", "true");
      localStorage.setItem("etax_login_timestamp", Date.now().toString());
      
      // Log activity
      try {
        await db.ref('activityLogs').push({
          type: 'user_login',
          userId: userId,
          timestamp: Date.now(),
          details: `User ${userId} ƒëƒÉng nh·∫≠p th√†nh c√¥ng`,
          deviceInfo: getUserAgent()
        });
      } catch (logError) {
        console.warn('Failed to log activity:', logError);
      }
      
      // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
      showMessage("üéâ ƒêƒÉng nh·∫≠p th√†nh c√¥ng! ƒêang chuy·ªÉn h∆∞·ªõng...", "success");
      
      // Chuy·ªÉn h∆∞·ªõng sau 1.5 gi√¢y
      setTimeout(() => {
        window.location.href = "index.html";
      }, 1500);
    }

    // ===== HELPER FUNCTIONS =====
    function togglePassword() {
      const passwordInput = document.getElementById("password");
      const eyeIcon = document.getElementById("togglePassword");
      
      if (passwordInput.type === "password") {
        passwordInput.type = "text";
        eyeIcon.classList.remove("fa-eye");
        eyeIcon.classList.add("fa-eye-slash");
      } else {
        passwordInput.type = "password";
        eyeIcon.classList.remove("fa-eye-slash");
        eyeIcon.classList.add("fa-eye");
      }
    }

    function setButtonLoading(button, loading) {
      if (loading) {
        button.disabled = true;
        button.innerHTML = '<span class="loading-spinner"></span> ƒêang ƒëƒÉng nh·∫≠p...';
      } else {
        button.disabled = false;
        button.innerHTML = 'ƒêƒÉng nh·∫≠p';
      }
    }

    function showMessage(message, type = 'info') {
      const container = document.getElementById('messageContainer');
      
      // Remove existing messages
      container.innerHTML = '';
      
      // Create new message
      const messageDiv = document.createElement('div');
      messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
      messageDiv.textContent = message;
      
      container.appendChild(messageDiv);
      
      // Auto-hide after 5 seconds for non-success messages
      if (type !== 'success') {
        setTimeout(() => {
          messageDiv.remove();
        }, 5000);
      }
    }

    function getUserAgent() {
      return {
        userAgent: navigator.userAgent,
        platform: navigator.platform,
        language: navigator.language,
        screen: `${screen.width}x${screen.height}`,
        timestamp: Date.now()
      };
    }

    // ===== KEYBOARD SUPPORT =====
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        login();
      }
    });

    // ===== AUTO-FILL SUPPORT =====
    document.getElementById('tax-id').addEventListener('input', function() {
      // Remove any non-numeric characters for MST
      const value = this.value.replace(/[^0-9]/g, '');
      if (this.value !== value) {
        this.value = value;
      }
    });

    // ===== ERROR HANDLING =====
    window.addEventListener('error', function(event) {
      console.error('Login page error:', event.error);
      
      if (event.error.message.includes('Firebase') || event.error.message.includes('network')) {
        showMessage('‚ùå C√≥ l·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
      }
    });

    console.log('üöÄ Login.html initialized successfully');
  </script>
</body>
</html>