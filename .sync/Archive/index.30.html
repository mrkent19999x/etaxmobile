<!DOCTYPE html>
<html lang="vi">
<head>
  <!-- PWA Meta Tags -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="eTax Mobile">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#d62828">

  <!-- PWA Icons -->
  <link rel="apple-touch-icon" href="assets/logo.png">
  <link rel="icon" type="image/png" href="assets/logo.png">
  <link rel="manifest" href="manifest.json">
  
  <title>eTax Mobile - Trang ch·ªß</title>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    /* ===== UNIVERSAL RESPONSIVE FIX ===== */
    html, body {
      margin: 0 !important;
      padding: 0 !important;
      width: 100% !important;
      height: 100% !important;
      box-sizing: border-box;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
    }

    * {
      box-sizing: border-box;
      touch-action: manipulation;
      -webkit-overflow-scrolling: touch;
      -webkit-tap-highlight-color: transparent;
    }

    /* ‚úÖ PWA VIEWPORT FIX */
    @supports (padding: max(0px)) {
      .safe-area-top {
        padding-top: max(20px, env(safe-area-inset-top));
      }
      
      .safe-area-bottom {
        padding-bottom: max(20px, env(safe-area-inset-bottom));
      }
    }

    /* ‚úÖ MOBILE CONTAINER FIX */
    .phone-frame, .container, .main-container {
      width: 100% !important;
      max-width: 100% !important;
      margin: 0 !important;
      padding: 0 16px !important;
      overflow-x: hidden !important;
    }

    /* ‚úÖ DESKTOP RESPONSIVE */
    @media (min-width: 768px) {
      .phone-frame, .container, .main-container {
        max-width: 414px !important;
        margin: 0 auto !important;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      }
    }

    /* Reset v√† chu·∫©n h√≥a to√†n b·ªô giao di·ªán */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Roboto', sans-serif;
    }

    html, body {
      margin: 0 !important;
      padding: 0 !important;
      width: 100vw;
      min-width: 100vw;
      height: 100vh;
      min-height: 100vh;
      overflow-x: hidden;
      background: linear-gradient(to bottom, #000, #111);
      scroll-behavior: smooth;
    }

    body {
      padding-top: 0 !important;
      margin-top: 0 !important;
      max-width: 414px;
      margin: 0 auto;
      color: #000;
    }

    .phone-frame {
      width: 100vw;
      max-width: 420px;
      min-height: 100vh;
      background-image: url('assets/nen.png');
      background-size: 100%;
      background-repeat: no-repeat;
      background-position: center center;
      border-radius: 0;
      margin: 0 auto;
      box-shadow: none;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: stretch;
    }

    @media (min-width: 601px) {
      .phone-frame {
        border-radius: 30px;
        margin: 32px auto;
        box-shadow: 0 0 20px rgba(0,0,0,0.3);
        width: 400px;
      }
    }

    /* Topbar */
    .topbar {
      position: sticky;
      top: env(safe-area-inset-top, 0px);
      z-index: 1000;
      background-color: #a40000;
      color: white;
      padding: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 100px;
    }

    .left-menu {
      font-size: 24px;
      color: white;
     padding-left: 10px;
     cursor: pointer;
   }

   .center-logo {
     display: flex;
     align-items: center;
     justify-content: center;
     flex-direction: column;
     flex-grow: 1;
     text-align: center;
   }

   .center-logo img {
     height: 40px;
     margin-bottom: 4px;
   }

   .center-logo span {
     font-weight: bold;
     font-size: 16px;
   }

   .right-icon {
     display: flex;
     gap: 10px;
     padding-right: 10px;
   }

   .right-icon img {
     height: 24px;
   }

   .user-info {
     background-color: white;
     display: flex;
     align-items: center;
     padding: 16px;
     margin: 8px;
     border-radius: 12px;
     box-shadow: 0 2px 4px rgba(0,0,0,0.1);
   }

   .avatar {
     height: 48px;
     width: 48px;
     border-radius: 50%;
     margin-right: 16px;
   }

   .userinfo-text .mst {
     font-size: 14px;
     color: #555;
   }

   .userinfo-text .username {
     font-size: 18px;
     font-weight: bold;
     color: #a40000;
   }

   .quick-actions,
   .group-services {
     margin: 16px;
   }

   h3 {
     font-size: 16px;
     font-weight: bold;
     margin-bottom: 12px;
     color: white;
   }

   .scroll-row {
     display: flex;
     overflow-x: auto;
     gap: 12px;
   }

   .circle-item {
     background-color: #a40000;
     color: white;
     padding: 12px;
     border-radius: 50%;
     min-width: 80px;
     min-height: 80px;
     display: flex;
     flex-direction: column;
     align-items: center;
     justify-content: center;
     font-size: 10px;
     text-align: center;
     word-break: break-word;
     white-space: normal;
   }

   .grid-box {
     display: grid;
     grid-template-columns: repeat(3, 1fr);
     gap: 12px;
   }

   .grid-item {
     background-color: white;
     border-radius: 16px;
     padding: 12px;
     text-align: center;
     font-size: 13px;
     color: #000;
     box-shadow: 0 2px 4px rgba(0,0,0,0.1);
     transition: transform 0.2s ease;
     cursor: pointer;
   }

   .grid-item:hover {
     transform: scale(1.02);
   }

   .grid-item img {
     height: 32px;
     margin-bottom: 8px;
   }

   /* Slide menu */
   .slide-menu {
     position: fixed;
     top: 0;
     left: -300px;
     width: 280px;
     height: 100vh;
     background: white;
     z-index: 9999;
     transition: left 0.3s ease;
     overflow-y: auto;
     box-shadow: 2px 0 6px rgba(0,0,0,0.2);
   }

   .slide-menu.open {
     left: 0;
   }

   .menu-overlay {
     position: fixed;
     top: 0;
     left: 0;
     width: 100%;
     height: 100%;
     background: rgba(0,0,0,0.5);
     z-index: 9998;
     opacity: 0;
     visibility: hidden;
     transition: all 0.3s ease;
   }

   .menu-overlay.show {
     opacity: 1;
     visibility: visible;
   }

   .slide-header {
     background-image: url('assets/back.png');
     background-size: cover;          /* ·∫¢nh ph·ªß k√≠n to√†n ph·∫ßn t·ª≠ */
background-position: center;     /* CƒÉn gi·ªØa ·∫£nh */
background-repeat: no-repeat;    /* Kh√¥ng l·∫∑p l·∫°i ·∫£nh */
     color: white;
     text-align: center;
     padding: 1rem;
   }

   .slide-header .logo {
     width: 60px;
     margin-bottom: 0.5rem;
   }

   .slide-links {
     display: flex;
     flex-direction: column;
     padding: 1rem;
   }

   .slide-links a:not(:last-child) {
     text-decoration: none;
     color: #333;
     padding: 0.5rem 0;
     font-size: 15px;
     display: flex;
     align-items: center;
     gap: 10px;
     border-bottom: 1px solid #eee;
   }

   .logout-btn-wrapper {
     margin-top: 20px;
     padding-top: 20px;
     border-top: 2px solid #eee;
   }

   .logout-btn {
     background: #d62828;
     color: white;
     padding: 12px 20px;
     border-radius: 8px;
     text-decoration: none;
     display: block;
     text-align: center;
     font-weight: bold;
     transition: background 0.3s;
   }

   .logout-btn:hover {
     background: #b71c1c;
   }

   /* Notification styles */
   .notification {
     position: fixed;
     top: 20px;
     right: 20px;
     padding: 15px 20px;
     border-radius: 8px;
     color: white;
     font-weight: 600;
     z-index: 10000;
     transform: translateX(400px);
     transition: transform 0.3s ease;
     max-width: 350px;
     box-shadow: 0 5px 20px rgba(0,0,0,0.3);
   }

   .notification.show {
     transform: translateX(0);
   }

   .notification.success { background: #4caf50; }
   .notification.error { background: #f44336; }
   .notification.info { background: #2196f3; }
   .notification.warning { background: #ff9800; }

   /* Content scrollable */
   .content-scrollable {
     flex: 1;
     overflow-y: auto;
     padding-bottom: 20px;
   }

   /* Loading spinner */
   .loading-spinner {
     width: 50px;
     height: 50px;
     border: 4px solid rgba(255,255,255,0.3);
     border-top: 4px solid white;
     border-radius: 50%;
     animation: spin 1s linear infinite;
     margin: 0 auto 20px;
   }

   @keyframes spin {
     0% { transform: rotate(0deg); }
     100% { transform: rotate(360deg); }
   }
 </style>
 
 <script>
   // Register service worker for PWA
   if ('serviceWorker' in navigator) {
     window.addEventListener('load', () => {
       navigator.serviceWorker.register('service-worker.js')
         .then(registration => console.log('SW registered'))
         .catch(error => console.log('SW registration failed'));
     });
   }
 </script>
</head>

<body>
 <div class="phone-frame">
   <!-- Slide Menu -->
   <div id="slideMenu" class="slide-menu">
     <div class="slide-header" style="height: 250px;">
       <img src="assets/logo.png" class="logo" style="width: 150px; height: 150px;" />
       <div class="slide-user" style="
         background-color: red;
         color: white;
         height: 60px;
         line-height: 60px;
         text-align: center;
         ∆∞
       ">
         Xin ch√†o <span id="slide-username">...</span>
       </div>
     </div>
     <div class="slide-links">
       <a href="#" onclick="location.reload()">
         <img src="assets/trangchu.png" width="35" height="35" style="object-fit: cover;"> Trang ch·ªß
       </a>
       <a href="dangky.html">
         <img src="assets/icon5.png" width="35" height="35" style="object-fit: cover;"> ƒêƒÉng k√Ω thu·∫ø
       </a>
       <a href="ho-tro-qtt.html">
         <img src="assets/icon6.png" width="35" height="35" style="object-fit: cover;"> H·ªó tr·ª£ quy·∫øt to√°n thu·∫ø TNCN
       </a>
       <a href="hoso.html">
         <img src="assets/icon7.png" width="35" height="35" style="object-fit: cover;"> Tra c·ª©u h·ªì s∆° khai thu·∫ø
       </a>
       <a href="nopthue.html">
         <img src="assets/icon8.png" width="35" height="35" style="object-fit: cover;"> Nh√≥m ch·ª©c nƒÉng n·ªôp thu·∫ø
       </a>
       <a href="nghiavu.html">
         <img src="assets/icon9.png" width="35" height="35" style="object-fit: cover;"> Tra c·ª©u nghƒ©a v·ª• thu·∫ø
       </a>
       <a href="thongbao.html">
         <img src="assets/icon10.png" width="35" height="35" style="object-fit: cover;"> Tra c·ª©u th√¥ng b√°o
       </a>
       <a href="tienich.html">
         <img src="assets/icon11.png" width="30px" height="30px" style="object-fit: cover;"> Ti·ªán √≠ch
       </a>
       <a href="hotro.html">
         <img src="assets/icon12.png" width="35px" height="35px" style="object-fit: cover;"> H·ªó tr·ª£
       </a>
       <a href="thietlap.html">
         <img src="assets/icon13.png" width="35px" height="35px" style="object-fit: cover;"> Thi·∫øt l·∫≠p c√° nh√¢n
       </a>
       <a href="#">
         <img src="assets/icon-doimk.png" width="35px" height="35px" style="object-fit: cover;"> ƒê·ªïi m·∫≠t kh·∫©u ƒëƒÉng nh·∫≠p
       </a>
       <a href="#">
         <img src="assets/faceid.png" width="35px" height="35px" style="object-fit: cover;"> ƒêƒÉng nh·∫≠p b·∫±ng v√¢n tay / FaceID
       </a>
       <div class="logout-btn-wrapper">
         <a href="#" onclick="logout()" class="logout-btn">ƒêƒÉng xu·∫•t</a>
       </div>
     </div>
   </div>

   <!-- Menu Overlay -->
   <div id="menuOverlay" class="menu-overlay" onclick="closeMenu()"></div>

   <!-- Header -->
   <header class="topbar" style="position: sticky; top: 0; z-index: 1000; height: 100px; margin: 0; width: 100%;">
     <div class="left-menu" onclick="openMenu()">‚ò∞</div>
     <div class="center-logo">
       <img src="assets/logo.png" alt="Logo" />
       <span>eTax Mobile</span>
     </div>
     <div class="right-icon">
       <img src="assets/icon-qr.png" alt="QR" />
       <a href="thongbao.html"><img src="assets/icon-bell.png" alt="Bell" /></a>
     </div>
   </header>

   <!-- Scrollable Content -->
   <div class="content-scrollable">
     <!-- User Info Section -->
     <section class="user-info" style="width: 380px; border-radius: 16px; background-image: url('assets/backgrounftd.png'); display: flex; align-items: center; padding: 12px; margin: 7px auto; height: 130px;">
       <img class="avatar" src="assets/avatar.png" alt="Avatar" style="width: 80px; height: 80px;" />
       <div class="userinfo-text" style="margin-left: 12px; flex-grow: 1;">
         <div class="mst" style="color: black; font-size: 14px;" id="user-mst">MST: ...</div>
         <div class="username" style="display: flex; align-items: center; gap: 8px; white-space: nowrap; font-size: 18px; font-weight: bold; color: #b10000;">
           <span id="user-name">(Ch∆∞a ƒëƒÉng nh·∫≠p)</span>
           <a href="thongtin.html"><img src="assets/nutha.png" alt="Th√¥ng tin" style="width: 20px; height: 20px;"></a>
         </div>
       </div>
     </section>

     <!-- Quick Actions Section -->
     <section style="background-color: rgb(255, 255, 255); height: 200px; border-radius: 16px; max-width: 380px; margin: 10px auto; position: relative; overflow: hidden; padding: 10px;">
       <div style="display: flex; align-items: center; justify-content: space-between;">
         <h3 style="color: black; margin: 0;">&nbsp;&nbsp;Ch·ª©c nƒÉng hay d√πng</h3>
         <img src="assets/2gach.png" alt="c√†i ƒë·∫∑t" style="width: 30px; height: 20px; margin-right: 10px;" />
       </div>

       <button onclick="scrollLeft()" style="position: absolute; left: 0; top: 50%; transform: translateY(-50%); background: none; border: none; z-index: 10;">
         <img src="assets/arrow-left.png" style="width: 30px;" />
       </button>

       <button onclick="scrollRight()" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); background: none; border: none; z-index: 10;">
         <img src="assets/arrow-right.png" style="width: 30px;" />
       </button>

       <div id="scrollable" style="display: flex; overflow-x: auto; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; scrollbar-width: none; -ms-overflow-style: none; gap: 10px; padding: 10px 20px; cursor: grab;">
         <div style="text-align: center; min-width: 80px; flex-shrink: 0;">
           <img src="assets/icon1.png" style="width: 50px; height: 50px;" /><br>
           <span style="display: inline-block; line-height: 1.4; font-size: 13px;">Tra c·ª©u<br>th√¥ng tin<br>ng∆∞·ªùi ph·ª•<br>thu·ªôc</span>
         </div>
         <div style="text-align: center; min-width: 80px; flex-shrink: 0;">
           <img src="assets/icon2.png" style="width: 50px; height: 50px;" /><br>
           <span style="display: inline-block; line-height: 1.4; font-size: 13px;">H·ªì s∆°<br>ƒëƒÉng k√Ω<br>thu·∫ø</span>
         </div>
         <div style="text-align: center; min-width: 80px; flex-shrink: 0;">
           <img src="assets/icon3.png" style="width: 50px; height: 50px;" /><br>
           <span style="display: inline-block; line-height: 1.4; font-size: 13px;">H·ªì s∆°<br>quy·∫øt<br>to√°n thu·∫ø</span>
         </div>
         <div style="text-align: center; min-width: 80px; flex-shrink: 0;">
           <img src="assets/icon4.png" style="width: 50px; height: 50px;" /><br>
           <span style="display: inline-block; line-height: 1.4; font-size: 13px;">Tra c·ª©u<br>th√¥ng tin<br>quy·∫øt<br>to√°n</span>
         </div>
         <div style="text-align: center; min-width: 80px; flex-shrink: 0; cursor: pointer;" onclick="javascript:location.href='tra-cuu-chung-tu.html';">
           <img src="assets/icon4.png" style="width: 50px; height: 50px;" /><br>
           <span style="display: inline-block; line-height: 1.4; font-size: 13px;">Tra c·ª©u<br>ch·ª©ng t·ª´<br>thu·∫ø</span>
         </div>
       </div>
     </section>

     <!-- Services Grid Section -->
     <section style="background: #fff; padding: 10px; max-width: 380px; margin: 10px auto 0 auto; font-family: sans-serif; border-radius: 14px; height: 400px;">
       <h3 style="margin-bottom: 16px; font-size: 18px; color: black;">Danh s√°ch nh√≥m d·ªãch v·ª•</h3>
       <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
         <div onclick="window.location.href='dangky.html'" style="text-align: center; cursor: pointer;">
           <img src="assets/icon5.png" style="width: 35px; height: 35px;" />
           <span style="display: block; margin-top: 8px; font-size: 14px;">ƒêƒÉng k√Ω thu·∫ø</span>
         </div>
         <div onclick="window.location.href='ho-tro-qtt.html'" style="text-align: center; cursor: pointer;">
           <img src="assets/icon6.png" style="width: 35px; height: 35px;" />
           <span style="display: block; margin-top: 8px; font-size: 14px;">H·ªó tr·ª£ quy·∫øt to√°n thu·∫ø<br>TNCN</span>
         </div>
         <div onclick="window.location.href='hoso.html'" style="text-align: center; cursor: pointer;">
           <img src="assets/icon7.png" style="width: 35px; height: 35px;" />
           <span style="display: block; margin-top: 8px; font-size: 14px;">Tra c·ª©u h·ªì s∆°<br>khai thu·∫ø</span>
         </div>
         <div onclick="window.location.href='nopthue.html'" style="text-align: center; cursor: pointer;">
           <img src="assets/icon8.png" style="width: 35px; height: 35px;" />
           <span style="display: block; margin-top: 8px; font-size: 14px;">Nh√≥m ch·ª©c<br>nƒÉng n·ªôp<br>thu·∫ø</span>
         </div>
         <div onclick="window.location.href='nghiavu.html'" style="text-align: center; cursor: pointer;">
           <img src="assets/icon9.png" style="width: 35px; height: 35px;" />
           <span style="display: block; margin-top: 8px; font-size: 14px;">Tra c·ª©u nghƒ©a<br>v·ª• thu·∫ø</span>
         </div>
         <div onclick="window.location.href='thongbao.html'" style="text-align: center; cursor: pointer;">
           <img src="assets/icon10.png" style="width: 35px; height: 35px;" />
           <span style="display: block; margin-top: 8px; font-size: 14px;">Tra c·ª©u th√¥ng<br>b√°o</span>
         </div>
         <div onclick="window.location.href='tienich.html'" style="text-align: center; cursor: pointer;">
           <img src="assets/icon11.png" style="width: 35px; height: 35px;" />
           <span style="display: block; margin-top: 8px; font-size: 14px;">Ti·ªán √≠ch</span>
         </div>
         <div onclick="window.location.href='hotro.html'" style="text-align: center; cursor: pointer;">
           <img src="assets/icon12.png" style="width: 35px; height: 35px;" />
           <span style="display: block; margin-top: 8px; font-size: 14px;">H·ªó tr·ª£</span>
         </div>
         <div onclick="window.location.href='thietlap.html'" style="text-align: center; cursor: pointer;">
           <img src="assets/icon13.png" style="width: 35px; height: 35px;" />
           <span style="display: block; margin-top: 8px; font-size: 14px;">Thi·∫øt l·∫≠p c√° nh√¢n</span>
         </div>
       </div>
     </section>

     <div style="height: 20px;"></div>
   </div>
 </div>

 <!-- Firebase CDN -->
 <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
 <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

 <script>
   // ===== AUTHENTICATION CHECK =====
   document.addEventListener('DOMContentLoaded', function() {
     console.log('=== INDEX PAGE DEBUG ===');
     checkAuthentication();
     initializePage();
     checkAutoToken();
   });

   // ===== AUTHENTICATION LOGIC =====
   function checkAuthentication() {
     const tokenVerified = localStorage.getItem('etax_token_verified');
     const userLoggedIn = localStorage.getItem('etax_logged_in_user');
     const loginSuccess = localStorage.getItem('etax_login_success');
     
     console.log('Token verified:', tokenVerified);
     console.log('User logged in:', userLoggedIn);
     console.log('Login success:', loginSuccess);
     
     // Ki·ªÉm tra n·∫øu user ch∆∞a ƒëƒÉng nh·∫≠p
     if (!userLoggedIn && !loginSuccess) {
       console.log('‚ùå User ch∆∞a ƒëƒÉng nh·∫≠p, redirect to login');
       window.location.href = 'login.html';
       return;
     }
     
     // Ki·ªÉm tra n·∫øu ch∆∞a verify token (tr·ª´ khi ƒë√£ ƒëƒÉng nh·∫≠p th√†nh c√¥ng)
     if (tokenVerified !== 'true' && !loginSuccess) {
       console.log('‚ùå Token ch∆∞a verify, redirect to token-login');
       window.location.href = 'token-login.html';
       return;
     }
     
     console.log('‚úÖ Authentication passed');
   }

   // ===== FIREBASE CONFIGURATION =====
   const firebaseConfig = {
     apiKey: "AIzaSyD_rJgBFgBulheVenQUE2KXr4PBpSpTCxw",
     authDomain: "etax-7fbf8.firebaseapp.com",
     databaseURL: "https://etax-7fbf8-default-rtdb.asia-southeast1.firebasedatabase.app",
     projectId: "etax-7fbf8",
     storageBucket: "etax-7fbf8.appspot.com",
     messagingSenderId: "1030026724634",
     appId: "1:1030026724634:web:d76f5f9dad43bad6fd58a3",
     measurementId: "G-YS5DLECJE6"
   };
   
   firebase.initializeApp(firebaseConfig);
   const db = firebase.database();

   // ===== GLOBAL VARIABLES =====
   let user = {};

   // ===== AUTO TOKEN CHECK =====
   async function checkAutoToken() {
     const urlParams = new URLSearchParams(window.location.search);
     const autoToken = urlParams.get('autoToken');
     
     if (autoToken) {
       console.log('üîë Ph√°t hi·ªán auto token, ƒëang x√°c th·ª±c...', autoToken.substring(0, 20) + '...');
       
       // Show processing message
       showNotification('üîë ƒêang x√°c th·ª±c t·ª± ƒë·ªông...', 'info');
       
       try {
         // Verify token with Firebase
         const tokenSnapshot = await db.ref('deviceTokens/' + autoToken).once('value');
         const tokenData = tokenSnapshot.val();
         
         if (tokenData && !tokenData.used && tokenData.expiresAt > Date.now()) {
           // Valid token - auto login
           localStorage.setItem('deviceToken', autoToken);
           localStorage.setItem('etax_token_verified', 'true');
           localStorage.setItem('etax_device_verified', 'true');
           
           // Update token status
           await db.ref('deviceTokens/' + autoToken).update({
             used: true,
             usedAt: Date.now(),
             deviceInfo: getUserAgent(),
             autoLoginUsed: true
           });
           
           // Log activity
           await db.ref('activityLogs').push({
             type: 'direct_user_access',
             token: autoToken,
             timestamp: Date.now(),
             details: 'üîó User truy c·∫≠p tr·ª±c ti·∫øp qua link auto-token',
             deviceInfo: getUserAgent()
           });
           
           showNotification('üéâ ƒêƒÉng nh·∫≠p t·ª± ƒë·ªông th√†nh c√¥ng!', 'success');
           
           // Redirect to dashboard
           setTimeout(() => {
             window.location.href = 'dashboard.html';
           }, 1500);
           
         } else {
           // Invalid token
           let errorMessage = '‚ùå Token kh√¥ng h·ª£p l·ªá';
           if (tokenData) {
             if (tokenData.used) errorMessage = '‚ùå Token ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng';
             if (tokenData.expiresAt <= Date.now()) errorMessage = '‚ùå Token ƒë√£ h·∫øt h·∫°n';
           }
           
           showNotification(errorMessage + '\n\nVui l√≤ng li√™n h·ªá admin ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£.', 'error');
           
           // Remove parameter from URL
           window.history.replaceState({}, document.title, window.location.pathname);
         }
         
       } catch (error) {
         console.error('Error auto-authenticating:', error);
         showNotification('‚ùå C√≥ l·ªói khi x√°c th·ª±c t·ª± ƒë·ªông\n\nVui l√≤ng th·ª≠ l·∫°i ho·∫∑c nh·∫≠p token th·ªß c√¥ng.', 'error');
       }
     }
   }

   // ===== INITIALIZE PAGE =====
   function initializePage() {
     // Load user info from localStorage
     const userInfo = localStorage.getItem("etax_user_info");
     if (userInfo) {
       try {
         user = JSON.parse(userInfo);
         document.getElementById("user-mst").innerText = "MST: " + (user.mst || "...");
         document.getElementById("user-name").innerText = user.name || "(Ch∆∞a ƒëƒÉng nh·∫≠p)";
         
         if (document.getElementById("slide-username")) {
           document.getElementById("slide-username").innerText = user.name || "...";
         }
       } catch (error) {
         console.error('Error parsing user info:', error);
         user = {};
       }
     }

     // Setup event listeners
     setupEventListeners();
     
     console.log('‚úÖ Page initialized successfully');
   }

   // ===== NAVIGATION FUNCTIONS =====
   function openMenu() {
     document.getElementById("slideMenu").classList.add("open");
     document.getElementById("menuOverlay").classList.add("show");
     document.getElementById("slide-username").innerText = user.name || "...";
   }

   function closeMenu() {
     document.getElementById("slideMenu").classList.remove("open");
     document.getElementById("menuOverlay").classList.remove("show");
   }

   function logout() {
     if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?')) {
       // Clear all localStorage
       localStorage.clear();
       
       // Log activity if possible
       try {
         db.ref('activityLogs').push({
           type: 'user_logout',
           userId: user.mst || 'unknown',
           timestamp: Date.now(),
           details: `User ${user.mst || 'unknown'} ƒëƒÉng xu·∫•t`,
           deviceInfo: getUserAgent()
         });
       } catch (error) {
         console.warn('Failed to log logout activity:', error);
       }
       
       showNotification('ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!', 'success');
       
       // Redirect to login
       setTimeout(() => {
         window.location.href = 'login.html';
       }, 1000);
     }
   }

   // ===== SCROLL FUNCTIONS =====
   function scrollLeft() {
     const scrollable = document.getElementById("scrollable");
     scrollable.scrollBy({ left: -120, behavior: 'smooth' });
   }

   function scrollRight() {
     const scrollable = document.getElementById("scrollable");
     scrollable.scrollBy({ left: 120, behavior: 'smooth' });
   }

   // ===== EVENT LISTENERS SETUP =====
   function setupEventListeners() {
     const scrollable = document.getElementById("scrollable");
     
     if (scrollable) {
       // Touch and mouse events for scrolling
       let isDown = false;
       let startX, scrollLeftStart, startXTouch;

       // Touch events
       scrollable.addEventListener('touchstart', function(e) {
         startXTouch = e.touches[0].clientX;
       });
       
       scrollable.addEventListener('touchmove', function(e) {
         if (startXTouch) {
           let deltaX = e.touches[0].clientX - startXTouch;
           scrollable.scrollLeft -= deltaX;
           startXTouch = e.touches[0].clientX;
         }
       });

       // Mouse events
       scrollable.addEventListener('mousedown', function(e) {
         isDown = true;
         startX = e.pageX - scrollable.offsetLeft;
         scrollLeftStart = scrollable.scrollLeft;
       });

       scrollable.addEventListener('mouseleave', function() {
         isDown = false;
       });

       scrollable.addEventListener('mouseup', function() {
         isDown = false;
       });

       scrollable.addEventListener('mousemove', function(e) {
         if (!isDown) return;
         e.preventDefault();
         const x = e.pageX - scrollable.offsetLeft;
         const walk = (x - startX) * 1.2;
         scrollable.scrollLeft = scrollLeftStart - walk;
       });
     }
   }

   // ===== UTILITY FUNCTIONS =====
   function getUserAgent() {
     return {
       userAgent: navigator.userAgent,
       platform: navigator.platform,
       language: navigator.language,
       screen: `${screen.width}x${screen.height}`,
       timestamp: Date.now(),
       timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
     };
   }

   function closeMenu() {
      document.getElementById("slideMenu").classList.remove("open");
      document.getElementById("menuOverlay").classList.remove("show");
    }

    function logout() {
      localStorage.clear();
      location.href = 'login.html';
    }

    // Function chuy·ªÉn trang tra c·ª©u ch·ª©ng t·ª´
    function navigateToChungTu() {
      console.log('Navigating to tra-cuu-chung-tu.html');
      window.location.href = 'tra-cuu-chung-tu.html';
    }

    // Functions cu·ªôn ngang
    const scrollable = document.getElementById("scrollable");

    function scrollLeft() {
      scrollable.scrollBy({ left: -120, behavior: 'smooth' });
    }

    function scrollRight() {
      scrollable.scrollBy({ left: 120, behavior: 'smooth' });
    }

    // Kh·ªüi t·∫°o khi trang load
    window.onload = function() {
      initializePage();
    }

    // Kh·ªüi t·∫°o l·∫°i khi trang ƒë∆∞·ª£c hi·ªÉn th·ªã (bao g·ªìm c·∫£ khi back t·ª´ trang kh√°c)
    window.addEventListener('pageshow', function(event) {
      initializePage();
    });

    // Function kh·ªüi t·∫°o trang
    function initializePage() {
      user = JSON.parse(localStorage.getItem("etax_user_info") || "{}");
      document.getElementById("user-mst").innerText = "MST: " + (user.mst || "...");
      document.getElementById("user-name").innerText = user.name || "(Ch∆∞a ƒëƒÉng nh·∫≠p)";
      
      if(document.getElementById("slide-username")) {
        document.getElementById("slide-username").innerText = user.name || "...";
      }

      // ƒê·∫£m b·∫£o event listeners ƒë∆∞·ª£c kh·ªüi t·∫°o l·∫°i
      setupEventListeners();
    }

    // Function thi·∫øt l·∫≠p event listeners
    function setupEventListeners() {
      const scrollable = document.getElementById("scrollable");
      
      // X√≥a event listeners c≈© tr∆∞·ªõc khi th√™m m·ªõi (tr√°nh tr√πng l·∫∑p)
      scrollable.removeEventListener('touchstart', handleTouchStart);
      scrollable.removeEventListener('touchmove', handleTouchMove);
      scrollable.removeEventListener('mousedown', handleMouseDown);
      scrollable.removeEventListener('mouseleave', handleMouseLeave);
      scrollable.removeEventListener('mouseup', handleMouseUp);
      scrollable.removeEventListener('mousemove', handleMouseMove);

      // Th√™m event listeners m·ªõi
      scrollable.addEventListener('touchstart', handleTouchStart);
      scrollable.addEventListener('touchmove', handleTouchMove);
      scrollable.addEventListener('mousedown', handleMouseDown);
      scrollable.addEventListener('mouseleave', handleMouseLeave);
      scrollable.addEventListener('mouseup', handleMouseUp);
      scrollable.addEventListener('mousemove', handleMouseMove);
    }

    // Touch swipe event handlers
    let startXTouch;
    function handleTouchStart(e) {
      startXTouch = e.touches[0].clientX;
    }
    
    function handleTouchMove(e) {
      let deltaX = e.touches[0].clientX - startXTouch;
      scrollable.scrollLeft -= deltaX;
      startXTouch = e.touches[0].clientX;
    }

    // Mouse drag event handlers
    let isDown = false;
    let startX, scrollLeftStart;

    function handleMouseDown(e) {
      isDown = true;
      scrollable.classList.add('active');
      startX = e.pageX - scrollable.offsetLeft;
      scrollLeftStart = scrollable.scrollLeft;
    }

    function handleMouseLeave() {
      isDown = false;
    }

    function handleMouseUp() {
      isDown = false;
    }

    function handleMouseMove(e) {
      if (!isDown) return;
      e.preventDefault();
      const x = e.pageX - scrollable.offsetLeft;
      const walk = (x - startX) * 1.2;
      scrollable.scrollLeft = scrollLeftStart - walk;
    }
  </script>
</body>
</html>