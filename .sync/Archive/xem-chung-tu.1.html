<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Xem ch·ª©ng t·ª´ PDF - eTax Mobile</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }

    .pdf-viewer {
      width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .pdf-header {
      background: #d62828;
      color: white;
      padding: 10px 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .pdf-header .back-btn {
      background: none;
      border: none;
      color: white;
      font-size: 18px;
      padding: 5px;
      cursor: pointer;
    }

    .pdf-header .title {
      font-size: 16px;
      font-weight: 600;
    }

    .pdf-content {
      flex: 1;
      overflow: auto;
      background: white;
      position: relative;
    }

    .loading-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 20px;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #d62828;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error-state {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 20px;
      text-align: center;
    }

    .error-icon {
      font-size: 48px;
      color: #dc3545;
      margin-bottom: 15px;
    }

    .error-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 10px;
      color: #333;
    }

    .error-message {
      color: #666;
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .retry-btn {
      background: #d62828;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }

    .pdf-frame {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* ‚úÖ RESPONSIVE FIX */
    @media (max-width: 768px) {
      .pdf-header {
        padding: 12px 16px;
      }
      
      .pdf-header .title {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="pdf-viewer">
    <!-- Header -->
    <div class="pdf-header">
      <button class="back-btn" onclick="goBack()">
        <i class="fas fa-arrow-left"></i>
      </button>
      <div class="title">Ch·ª©ng t·ª´ PDF</div>
      <div></div>
    </div>

    <!-- Content -->
    <div class="pdf-content" id="pdfContent">
      <!-- Loading State -->
      <div class="loading-state" id="loadingState">
        <div class="loading-spinner"></div>
        <div>ƒêang t·∫£i ch·ª©ng t·ª´...</div>
      </div>

      <!-- Error State -->
      <div class="error-state" id="errorState">
        <div class="error-icon">üìÑ</div>
        <div class="error-title">Kh√¥ng th·ªÉ t·∫£i ch·ª©ng t·ª´</div>
        <div class="error-message" id="errorMessage">
          Kh√¥ng t√¨m th·∫•y file ch·ª©ng t·ª´ cho MST n√†y.
        </div>
        <button class="retry-btn" onclick="loadPDF()">Th·ª≠ l·∫°i</button>
      </div>

      <!-- PDF Frame -->
      <iframe class="pdf-frame" id="pdfFrame" style="display: none;"></iframe>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD_rJgBFgBulheVenQUE2KXr4PBpSpTCxw",
      authDomain: "etax-7fbf8.firebaseapp.com",
      databaseURL: "https://etax-7fbf8-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "etax-7fbf8",
      storageBucket: "etax-7fbf8.appspot.com",
      messagingSenderId: "1030026724634",
      appId: "1:1030026724634:web:d76f5f9dad43bad6fd58a3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentMST = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      // Get MST from URL
      const urlParams = new URLSearchParams(window.location.search);
      currentMST = urlParams.get('mst');
      
      if (!currentMST) {
        showError('Kh√¥ng t√¨m th·∫•y m√£ s·ªë thu·∫ø', 'Vui l√≤ng quay l·∫°i trang tra c·ª©u v√† ch·ªçn l·∫°i ch·ª©ng t·ª´.');
        return;
      }
      
      // Load PDF
      loadPDF();
    });

    // ===== LOAD PDF FROM FIREBASE =====
    async function loadPDF() {
      try {
        showLoading();
        
        console.log('Loading PDF for MST:', currentMST);
        
        // ‚úÖ Get document info from Firebase
        const snapshot = await db.ref('pdf_documents/' + currentMST).once('value');
        
        if (!snapshot.exists()) {
          showError('Kh√¥ng t√¨m th·∫•y ch·ª©ng t·ª´', `Kh√¥ng t√¨m th·∫•y file ch·ª©ng t·ª´ cho MST: ${currentMST}`);
          return;
        }
        
        const documentData = snapshot.val();
        
        // ‚úÖ Check if PDF file exists
        if (!documentData.pdfFile || !documentData.pdfFile.downloadURL) {
          showError('File kh√¥ng t·ªìn t·∫°i', 'File PDF kh√¥ng ƒë∆∞·ª£c t√¨m th·∫•y trong h·ªá th·ªëng.');
          return;
        }
        
        // ‚úÖ Load PDF using Firebase Storage URL
        const pdfURL = documentData.pdfFile.downloadURL;
        console.log('Loading PDF from URL:', pdfURL);
        
        // Set PDF source
        const pdfFrame = document.getElementById('pdfFrame');
        pdfFrame.src = pdfURL + '#toolbar=1&navpanes=0&scrollbar=1';
        
        // Show PDF frame when loaded
        pdfFrame.onload = function() {
          hideLoading();
          pdfFrame.style.display = 'block';
          console.log('PDF loaded successfully');
        };
        
        // Handle PDF loading errors
        pdfFrame.onerror = function() {
          console.error('Error loading PDF iframe');
          showError('L·ªói t·∫£i file', 'Kh√¥ng th·ªÉ hi·ªÉn th·ªã file PDF. Vui l√≤ng th·ª≠ l·∫°i.');
        };
        
      } catch (error) {
        console.error('Error loading PDF:', error);
        showError('L·ªói h·ªá th·ªëng', 'C√≥ l·ªói x·∫£y ra khi t·∫£i ch·ª©ng t·ª´. Vui l√≤ng th·ª≠ l·∫°i.');
      }
    }

    // UI State Functions
    function showLoading() {
      document.getElementById('loadingState').style.display = 'flex';
      document.getElementById('errorState').style.display = 'none';
      document.getElementById('pdfFrame').style.display = 'none';
    }

    function hideLoading() {
      document.getElementById('loadingState').style.display = 'none';
    }

    function showError(title, message) {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('pdfFrame').style.display = 'none';
      document.getElementById('errorState').style.display = 'flex';
      
      document.querySelector('.error-title').textContent = title;
      document.getElementById('errorMessage').textContent = message;
    }

    // Navigation
    function goBack() {
      if (document.referrer) {
        window.history.back();
      } else {
        window.location.href = 'tra-cuu-chung-tu.html';
      }
    }

    console.log('‚úÖ xem-chung-tu.html initialized successfully');
  </script>
</body>
</html>