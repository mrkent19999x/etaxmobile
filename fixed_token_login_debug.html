<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="eTax Mobile">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#d62828">
  
  <link rel="apple-touch-icon" href="assets/logo.png">
  <link rel="icon" type="image/png" href="assets/logo.png">
  <link rel="manifest" href="manifest.json">
  
  <title>eTax Mobile - Debug Token Login</title>
  
  <style>
    /* Mobile-first CSS */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      min-height: 100vh;
      padding: 20px;
      color: white;
    }

    .container {
      max-width: 400px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      color: #333;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }

    .logo {
      text-align: center;
      margin-bottom: 30px;
    }

    .logo h1 {
      color: #d62828;
      font-size: 28px;
      margin-bottom: 10px;
    }

    .input-group {
      margin-bottom: 20px;
    }

    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .input-group input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    .input-group input:focus {
      outline: none;
      border-color: #d62828;
    }

    .btn {
      width: 100%;
      padding: 14px;
      background: #d62828;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 15px;
      transition: background 0.3s;
    }

    .btn:hover {
      background: #c71e1e;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .message {
      padding: 12px;
      border-radius: 8px;
      margin: 15px 0;
      display: none;
    }

    .error { background: #fee; color: #c33; border: 1px solid #fcc; }
    .success { background: #efe; color: #363; border: 1px solid #cfc; }
    .info { background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; }

    .debug-section {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
      border-left: 4px solid #007bff;
    }

    .debug-title {
      font-weight: 600;
      color: #007bff;
      margin-bottom: 10px;
    }

    .debug-content {
      font-family: monospace;
      font-size: 12px;
      background: white;
      padding: 10px;
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <h1>üîß eTax Mobile Debug</h1>
      <p>Token Login Troubleshooter</p>
    </div>

    <div class="input-group">
      <label for="tokenInput">Nh·∫≠p Token ƒë·ªÉ test:</label>
      <input type="text" id="tokenInput" placeholder="Nh·∫≠p token..." maxlength="20">
    </div>

    <button class="btn" onclick="debugToken()">üîç Debug Token</button>
    <button class="btn" onclick="checkDatabaseStructure()">üóÑÔ∏è Ki·ªÉm tra Database</button>
    <button class="btn" onclick="verifyTokenFixed()">‚úÖ Verify Token (Fixed)</button>

    <div class="message error" id="errorMsg"></div>
    <div class="message success" id="successMsg"></div>
    <div class="message info" id="infoMsg"></div>

    <!-- Debug Results -->
    <div class="debug-section">
      <div class="debug-title">üîç Debug Results:</div>
      <div class="debug-content" id="debugResults">Nh·∫•n "Debug Token" ƒë·ªÉ b·∫Øt ƒë·∫ßu...</div>
    </div>

    <div class="debug-section">
      <div class="debug-title">üóÑÔ∏è Database Structure:</div>
      <div class="debug-content" id="dbStructure">Nh·∫•n "Ki·ªÉm tra Database" ƒë·ªÉ xem c·∫•u tr√∫c...</div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD_rJgBFgBulheVenQUE2KXr4PBpSpTCxw",
      authDomain: "etax-7fbf8.firebaseapp.com",
      databaseURL: "https://etax-7fbf8-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "etax-7fbf8",
      storageBucket: "etax-7fbf8.appspot.com",
      messagingSenderId: "1030026724634",
      appId: "1:1030026724634:web:d76f5f9dad43bad6fd58a3",
      measurementId: "G-YS5DLECJE6"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // üîç Debug token - t√¨m ·ªü t·∫•t c·∫£ locations c√≥ th·ªÉ
    async function debugToken() {
      const token = document.getElementById('tokenInput').value.trim();
      if (!token) {
        showError('Vui l√≤ng nh·∫≠p token ƒë·ªÉ debug');
        return;
      }

      showInfo('üîç ƒêang debug token: ' + token);

      const debugResults = {
        token: token,
        timestamp: new Date().toISOString(),
        searches: []
      };

      try {
        // T√¨m ·ªü c√°c locations kh√°c nhau
        const locations = [
          'tokens',
          'deviceTokens', 
          'device_tokens',
          'user_tokens'
        ];

        for (let location of locations) {
          console.log(`üîç Searching in: ${location}`);
          
          try {
            // T√¨m tr·ª±c ti·∫øp b·∫±ng key
            const directSnapshot = await db.ref(`${location}/${token}`).once('value');
            
            // T√¨m b·∫±ng query
            const querySnapshot = await db.ref(location).orderByChild('token').equalTo(token).once('value');
            
            // T√¨m t·∫•t c·∫£ trong location ƒë√≥
            const allSnapshot = await db.ref(location).once('value');
            
            const searchResult = {
              location: location,
              directSearch: {
                exists: directSnapshot.exists(),
                data: directSnapshot.exists() ? directSnapshot.val() : null
              },
              querySearch: {
                exists: querySnapshot.exists(),
                data: querySnapshot.exists() ? querySnapshot.val() : null
              },
              allData: allSnapshot.exists() ? allSnapshot.val() : null
            };

            debugResults.searches.push(searchResult);

            if (directSnapshot.exists() || querySnapshot.exists()) {
              showSuccess(`‚úÖ T√¨m th·∫•y token trong "${location}"!`);
            }

          } catch (error) {
            debugResults.searches.push({
              location: location,
              error: error.message
            });
          }
        }

        // Hi·ªÉn th·ªã k·∫øt qu·∫£ debug
        document.getElementById('debugResults').textContent = JSON.stringify(debugResults, null, 2);

      } catch (error) {
        showError('L·ªói debug: ' + error.message);
        console.error('Debug error:', error);
      }
    }

    // üóÑÔ∏è Ki·ªÉm tra c·∫•u tr√∫c database
    async function checkDatabaseStructure() {
      showInfo('üóÑÔ∏è ƒêang ki·ªÉm tra c·∫•u tr√∫c database...');

      try {
        const structure = {};

        // Ki·ªÉm tra c√°c nodes ch√≠nh
        const mainNodes = ['users', 'tokens', 'deviceTokens', 'device_tokens', 'user_tokens'];

        for (let node of mainNodes) {
          try {
            const snapshot = await db.ref(node).once('value');
            if (snapshot.exists()) {
              const data = snapshot.val();
              structure[node] = {
                exists: true,
                count: Object.keys(data).length,
                sampleKeys: Object.keys(data).slice(0, 3),
                sampleData: data[Object.keys(data)[0]] || null
              };
            } else {
              structure[node] = { exists: false };
            }
          } catch (error) {
            structure[node] = { error: error.message };
          }
        }

        document.getElementById('dbStructure').textContent = JSON.stringify(structure, null, 2);
        showSuccess('‚úÖ ƒê√£ ki·ªÉm tra c·∫•u tr√∫c database');

      } catch (error) {
        showError('L·ªói ki·ªÉm tra database: ' + error.message);
      }
    }

    // ‚úÖ Verify token v·ªõi logic fixed
    async function verifyTokenFixed() {
      const token = document.getElementById('tokenInput').value.trim();
      if (!token) {
        showError('Vui l√≤ng nh·∫≠p token ƒë·ªÉ verify');
        return;
      }

      showInfo('‚ö° ƒêang verify token v·ªõi logic fixed...');

      try {
        let tokenFound = false;
        let tokenData = null;
        let tokenLocation = '';

        // üîç T√¨m token ·ªü t·∫•t c·∫£ locations c√≥ th·ªÉ
        const searchLocations = [
          { path: 'deviceTokens', keyField: null }, // Direct key lookup
          { path: 'tokens', keyField: null }, // Direct key lookup  
          { path: 'device_tokens', keyField: null }, // Direct key lookup
          { path: 'deviceTokens', keyField: 'token' }, // Query by token field
          { path: 'tokens', keyField: 'token' }, // Query by token field
        ];

        for (let search of searchLocations) {
          console.log(`üîç Searching ${search.path}...`);

          try {
            let snapshot;
            
            if (search.keyField) {
              // Query by field
              snapshot = await db.ref(search.path).orderByChild(search.keyField).equalTo(token).once('value');
            } else {
              // Direct key lookup
              snapshot = await db.ref(`${search.path}/${token}`).once('value');
            }

            if (snapshot.exists()) {
              tokenFound = true;
              tokenLocation = search.path;
              
              if (search.keyField) {
                // Get first result from query
                const results = snapshot.val();
                const firstKey = Object.keys(results)[0];
                tokenData = results[firstKey];
              } else {
                tokenData = snapshot.val();
              }
              
              console.log(`‚úÖ Found token in ${tokenLocation}:`, tokenData);
              break;
            }
          } catch (error) {
            console.warn(`‚ùå Error searching ${search.path}:`, error);
          }
        }

        if (!tokenFound) {
          showError('‚ùå Token kh√¥ng t·ªìn t·∫°i trong b·∫•t k·ª≥ location n√†o');
          return;
        }

        // ‚úÖ Ki·ªÉm tra token validity
        const now = Date.now();
        let isValid = true;
        let validationErrors = [];

        // Ki·ªÉm tra ƒë√£ s·ª≠ d·ª•ng ch∆∞a
        if (tokenData.used === true) {
          isValid = false;
          validationErrors.push('Token ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng');
        }

        // Ki·ªÉm tra h·∫øt h·∫°n
        const expiryField = tokenData.expiresAt || tokenData.expireAt || tokenData.expires_at;
        if (expiryField && now > expiryField) {
          isValid = false;
          validationErrors.push('Token ƒë√£ h·∫øt h·∫°n');
        }

        if (!isValid) {
          showError('‚ùå Token kh√¥ng h·ª£p l·ªá: ' + validationErrors.join(', '));
          return;
        }

        // ‚úÖ Token h·ª£p l·ªá - th·ª±c hi·ªán x√°c th·ª±c
        showSuccess('üéâ Token h·ª£p l·ªá! ƒêang x√°c th·ª±c thi·∫øt b·ªã...');

        // Generate device ID
        const deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

        // Mark token as used
        const tokenPath = tokenLocation === 'deviceTokens' ? `deviceTokens/${token}` :
                         tokenLocation === 'tokens' ? `tokens/${token}` :
                         `${tokenLocation}/${token}`;

        await db.ref(tokenPath).update({
          used: true,
          used_at: Date.now(),
          device_id: deviceId,
          user_agent: navigator.userAgent
        });

        // Save device verification
        localStorage.setItem('etax_device_id', deviceId);
        localStorage.setItem('etax_device_verified', 'true');
        localStorage.setItem('etax_token_verified', 'true');
        localStorage.setItem(`etax_verified_${deviceId}`, 'true');
        localStorage.setItem('etax_verified_token', token);
        localStorage.setItem('etax_verification_time', Date.now().toString());

        showSuccess('‚úÖ X√°c th·ª±c th√†nh c√¥ng! Chuy·ªÉn trang sau 3 gi√¢y...');

        setTimeout(() => {
          window.location.href = 'login.html';
        }, 3000);

      } catch (error) {
        showError('L·ªói verify: ' + error.message);
        console.error('Verify error:', error);
      }
    }

    // Utility functions
    function showError(message) {
      const el = document.getElementById('errorMsg');
      el.textContent = message;
      el.style.display = 'block';
      hideOtherMessages('errorMsg');
    }

    function showSuccess(message) {
      const el = document.getElementById('successMsg');
      el.textContent = message;
      el.style.display = 'block';
      hideOtherMessages('successMsg');
    }

    function showInfo(message) {
      const el = document.getElementById('infoMsg');
      el.textContent = message;
      el.style.display = 'block';
      hideOtherMessages('infoMsg');
    }

    function hideOtherMessages(keep) {
      const messages = ['errorMsg', 'successMsg', 'infoMsg'];
      messages.forEach(id => {
        if (id !== keep) {
          document.getElementById(id).style.display = 'none';
        }
      });
    }

    // Auto clear messages after 5 seconds
    setInterval(() => {
      document.querySelectorAll('.message').forEach(el => {
        if (el.style.display === 'block') {
          setTimeout(() => {
            el.style.display = 'none';
          }, 5000);
        }
      });
    }, 1000);

    // Add enter key support
    document.getElementById('tokenInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        verifyTokenFixed();
      }
    });

    console.log('üîß eTax Mobile Debug Tool loaded');
  </script>
</body>
</html>