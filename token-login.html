<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>eTax Mobile - X√°c th·ª±c thi·∫øt b·ªã</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#b71c1c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="eTax Mobile">
    <link rel="apple-touch-icon" href="./assets/logo.png">
    <meta name="format-detection" content="telephone=no">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 40px 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #4CAF50, #2196F3, #FF9800);
        }

        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(45deg, #4CAF50, #2196F3);
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            font-weight: bold;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .progress-steps {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 10px;
        }

        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #666;
            position: relative;
        }

        .step.active {
            background: #4CAF50;
            color: white;
        }

        .step.completed {
            background: #2196F3;
            color: white;
        }

        .device-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: left;
        }

        .device-info h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .device-detail {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .device-detail .label {
            color: #666;
            font-weight: 500;
        }

        .device-detail .value {
            color: #333;
            font-weight: 600;
        }

        .token-form {
            margin: 20px 0;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            color: #333;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .verify-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .verify-btn:hover {
            transform: translateY(-2px);
        }

        .verify-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .status-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .status-card.show {
            display: block;
        }

        .status-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .status-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .status-message {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }

        .success-card {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .error-card {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: white;
        }

        .message {
            padding: 12px 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 14px;
            display: none;
        }

        .message.show {
            display: block;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        @media (max-width: 480px) {
            .container {
                margin: 10px;
                padding: 30px 20px;
            }
            
            .logo {
                width: 60px;
                height: 60px;
                font-size: 24px;
            }
            
            h1 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="orientation-warning">
      <div>
        <h2>üì± Xoay m√†n h√¨nh</h2>
        <p>Vui l√≤ng xoay thi·∫øt b·ªã v·ªÅ ch·∫ø ƒë·ªô d·ªçc ƒë·ªÉ s·ª≠ d·ª•ng ·ª©ng d·ª•ng</p>
      </div>
    </div>
    <div class="container">
        <div class="logo">eT</div>
        <h1>eTax Mobile</h1>
        <p class="subtitle">X√°c th·ª±c thi·∫øt b·ªã c·ªßa b·∫°n</p>

        <div class="progress-steps">
            <div class="step active" id="step1">1</div>
            <div class="step" id="step2">2</div>
            <div class="step" id="step3">3</div>
        </div>

        <div class="device-info">
            <h3>üì± Th√¥ng tin thi·∫øt b·ªã</h3>
            <div class="device-detail">
                <span class="label">üÜî Device ID:</span>
                <span class="value" id="deviceId">ƒêang t·∫£i...</span>
            </div>
            <div class="device-detail">
                <span class="label">üñ•Ô∏è Platform:</span>
                <span class="value" id="platform">ƒêang t·∫£i...</span>
            </div>
            <div class="device-detail">
                <span class="label">üìè Screen:</span>
                <span class="value" id="screen">ƒêang t·∫£i...</span>
            </div>
        </div>

        <div class="status-card" id="newDeviceCard">
            <div class="status-icon">üîí</div>
            <div class="status-title">Thi·∫øt b·ªã m·ªõi</div>
            <div class="status-message">C·∫ßn x√°c th·ª±c b·∫±ng token</div>
        </div>

        <div class="status-card success-card" id="trustedDeviceCard">
            <div class="status-icon">‚úÖ</div>
            <div class="status-title">Thi·∫øt b·ªã tin c·∫≠y</div>
            <div class="status-message">ƒêang chuy·ªÉn ƒë·∫øn trang ƒëƒÉng nh·∫≠p...</div>
        </div>

        <div class="token-form" id="tokenForm">
            <div class="form-group">
                <label for="tokenInput">Nh·∫≠p m√£ token:</label>
                <input type="text" id="tokenInput" placeholder="Nh·∫≠p token..." maxlength="20" autocomplete="off">
            </div>
            <button class="verify-btn" onclick="verifyToken()" id="verifyBtn">
                X√°c th·ª±c
            </button>
        </div>

        <div id="messageContainer"></div>
    </div>

    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyD_rJgBFgBulheVenQUE2KXr4PBpSpTCxw",
            authDomain: "etax-7fbf8.firebaseapp.com",
            databaseURL: "https://etax-7fbf8-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "etax-7fbf8",
            storageBucket: "etax-7fbf8.appspot.com",
            messagingSenderId: "1030026724634",
            appId: "1:1030026724634:web:d76f5f9dad43bad6fd58a3",
            measurementId: "G-YS5DLECJE6"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ===== DEVICE MANAGER CLASS (FIXED) =====
        class SimpleDeviceManager {
            constructor() {
                this.deviceId = this.generateDeviceId();
                console.log('üîß SimpleDeviceManager initialized:', this.deviceId);
            }

            generateDeviceId() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                ctx.textBaseline = 'top';
                ctx.font = '14px Arial';
                ctx.fillText('Device fingerprint', 2, 2);
                
                const fingerprint = canvas.toDataURL();
                const userAgent = navigator.userAgent;
                const screen = `${window.screen.width}x${window.screen.height}`;
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                
                const combined = `${fingerprint}-${userAgent}-${screen}-${timezone}`;
                return 'dev_' + btoa(combined).substring(0, 20).replace(/[+/=]/g, '');
            }

            detectPlatform() {
                const ua = navigator.userAgent;
                if (/iPhone|iPad|iPod/.test(ua)) return 'iOS';
                if (/Android/.test(ua)) return 'Android';
                if (/Windows/.test(ua)) return 'Windows';
                if (/Mac/.test(ua)) return 'macOS';
                return 'Unknown';
            }

            getDeviceInfo() {
                return {
                    deviceId: this.deviceId,
                    platform: this.detectPlatform(),
                    screen: `${window.screen.width}x${window.screen.height}`,
                    userAgent: navigator.userAgent,
                    timestamp: Date.now()
                };
            }
        }

        // ===== GLOBAL VARIABLES =====
        let deviceManager;
        let currentStep = 1;

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== eTAX TOKEN-LOGIN FIXED VERSION ===');
            console.log('localStorage flags:', {
                device_verified: localStorage.getItem('etax_device_verified'),
                token_verified: localStorage.getItem('etax_token_verified'),
                device_id: localStorage.getItem('etax_device_id'),
                redirect_flag: localStorage.getItem('etax_redirect_from_token_login')
            });
            initializeApp();
        });

        async function initializeApp() {
            try {
                // Initialize device manager
                deviceManager = new SimpleDeviceManager();
                
                // Display device info
                updateDeviceInfo();
                
                // Check if device is already trusted
                await checkDeviceStatus();
                
                // Setup form
                setupTokenForm();
                
            } catch (error) {
                console.error('‚ùå Initialization failed:', error);
                showMessage('L·ªói kh·ªüi t·∫°o ·ª©ng d·ª•ng', 'error');
            }
        }

        // ===== UPDATE DEVICE INFO DISPLAY =====
        function updateDeviceInfo() {
            const info = deviceManager.getDeviceInfo();
            
            document.getElementById('deviceId').textContent = info.deviceId;
            document.getElementById('platform').textContent = info.platform;
            document.getElementById('screen').textContent = info.screen;
        }

        // ===== CHECK DEVICE STATUS =====
        async function checkDeviceStatus() {
            try {
                console.log('üîç Checking device status...');
                
                const trustedRef = db.ref('trustedDevices/' + deviceManager.deviceId);
                const snapshot = await trustedRef.once('value');
                
                if (snapshot.exists() && snapshot.val().trusted) {
                    console.log('‚úÖ Device is already trusted');
                    showTrustedDevice();
                    redirectToLogin();
                } else {
                    console.log('‚ùå New device, requires token verification');
                    showNewDevice();
                }
                
            } catch (error) {
                console.error('‚ùå Device status check failed:', error);
                showNewDevice();
            }
        }

        // ===== UI UPDATE FUNCTIONS =====
        function showNewDevice() {
            document.getElementById('newDeviceCard').classList.add('show');
            document.getElementById('trustedDeviceCard').classList.remove('show');
            document.getElementById('tokenForm').style.display = 'block';
        }

        function showTrustedDevice() {
            document.getElementById('newDeviceCard').classList.remove('show');
            document.getElementById('trustedDeviceCard').classList.add('show');
            document.getElementById('tokenForm').style.display = 'none';
            updateStep(3);
        }

        function updateStep(step) {
            currentStep = step;
            
            for (let i = 1; i <= 3; i++) {
                const stepEl = document.getElementById(`step${i}`);
                stepEl.classList.remove('active', 'completed');
                
                if (i < step) {
                    stepEl.classList.add('completed');
                } else if (i === step) {
                    stepEl.classList.add('active');
                }
            }
        }

        // ===== SETUP TOKEN FORM =====
        function setupTokenForm() {
            const tokenInput = document.getElementById('tokenInput');
            
            tokenInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    verifyToken();
                }
            });
            
            tokenInput.addEventListener('input', function() {
                this.value = this.value.toUpperCase();
            });
        }

        // ===== TOKEN VERIFICATION (FIXED) =====
        async function verifyToken() {
            const token = document.getElementById('tokenInput').value.trim();
            
            if (!token) {
                showMessage('Vui l√≤ng nh·∫≠p token', 'error');
                return;
            }

            const verifyBtn = document.getElementById('verifyBtn');
            verifyBtn.disabled = true;
            verifyBtn.textContent = 'ƒêang x√°c th·ª±c...';
            
            try {
                console.log('üîç Checking token:', token);
                showMessage('üîç ƒêang ki·ªÉm tra token...', 'info');
                
                // üîß FIX 1: T√¨m token trong database v·ªõi nhi·ªÅu locations
                let tokenData = null;
                let tokenRef = null;
                
                // T√¨m ·ªü deviceTokens tr∆∞·ªõc
                const deviceTokenRef = db.ref('deviceTokens/' + token);
                let snapshot = await deviceTokenRef.once('value');
                
                if (snapshot.exists()) {
                    tokenData = snapshot.val();
                    tokenRef = deviceTokenRef;
                    console.log('üîç Token data:', tokenData);
                } else {
                    // T√¨m ·ªü tokens backup
                    const tokensRef = db.ref('tokens/' + token);
                    snapshot = await tokensRef.once('value');
                    
                    if (snapshot.exists()) {
                        tokenData = snapshot.val();
                        tokenRef = tokensRef;
                        console.log('üîç Token data (backup):', tokenData);
                    }
                }

                if (!tokenData) {
                    throw new Error('Token kh√¥ng t·ªìn t·∫°i ho·∫∑c kh√¥ng h·ª£p l·ªá');
                }

                // üîß FIX 2: Ki·ªÉm tra tr·∫°ng th√°i token ƒê√öNG C√ÅCH
                console.log('üîç Token status check...');
                
                // Ki·ªÉm tra h·∫øt h·∫°n
                if (tokenData.expiresAt && Date.now() > tokenData.expiresAt) {
                    throw new Error('Token ƒë√£ h·∫øt h·∫°n');
                }

                // üîß FIX 3: CH·ªà KI·ªÇM TRA "used" KHI C√ì usedAt, KH√îNG KI·ªÇM TRA status
                console.log('üîç Token usage check:', {
                    usedAt: tokenData.usedAt,
                    used: tokenData.used,
                    status: tokenData.status
                });
                
                if (tokenData.usedAt && tokenData.usedAt > 0) {
                    throw new Error('Token ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng l√∫c: ' + new Date(tokenData.usedAt).toLocaleString());
                }

                // L·∫•y th√¥ng tin user
                console.log('üîç Getting user info...');
                
                // üîß FIX 4: T√¨m user ID ƒë√∫ng c√°ch - th√™m linkedUserId
                let userId = tokenData.userId || tokenData.uid || tokenData.targetUserId || tokenData.linkedUserId;
                
                console.log('üîç Token data keys:', Object.keys(tokenData));
                console.log('üîç Extracted userId:', userId);
                
                if (!userId) {
                    throw new Error('Token kh√¥ng c√≥ th√¥ng tin user');
                }

                // T√¨m user trong database
                console.log('üîç Looking for user in /users/' + userId);
                let userSnapshot = await db.ref('users/' + userId).once('value');
                let userInfo = null;

                if (userSnapshot.exists()) {
                    userInfo = userSnapshot.val();
                    userInfo.userId = userId;
                    console.log('‚úÖ Found user in /users/', userInfo);
                } else {
                    console.log('‚ùå User not found in /users/, trying /taxpayers/' + userId);
                    // Th·ª≠ t√¨m trong taxpayers
                    userSnapshot = await db.ref('taxpayers/' + userId).once('value');
                    if (userSnapshot.exists()) {
                        userInfo = userSnapshot.val();
                        userInfo.userId = userId;
                        console.log('‚úÖ Found user in /taxpayers/', userInfo);
                    } else {
                        console.log('‚ùå User not found in /taxpayers/ either');
                    }
                }

                if (!userInfo) {
                    throw new Error('Kh√¥ng t√¨m th·∫•y th√¥ng tin user v·ªõi ID: ' + userId + '. Ki·ªÉm tra trong Firebase: /users/' + userId + ' ho·∫∑c /taxpayers/' + userId);
                }

                console.log('‚úÖ Found user:', userInfo);
                showMessage('‚úÖ Token verification successful!', 'success');

                // üîß FIX 5: L∆∞u trusted device v·ªõi d·ªØ li·ªáu ƒê√öNG
                console.log('üíæ Saving trusted device...');
                
                const deviceData = {
                    userId: userId, // üîß ƒê·∫£m b·∫£o userId KH√îNG undefined
                    deviceId: deviceManager.deviceId,
                    trusted: true,
                    registeredAt: Date.now(),
                    token: token,
                    userAgent: navigator.userAgent,
                    lastAccess: Date.now(),
                    platform: deviceManager.detectPlatform(),
                    // Th√™m c√°c tr∆∞·ªùng backup ƒë·ªÉ ƒë·∫£m b·∫£o
                    userName: userInfo.name || userInfo.fullName || 'Unknown',
                    userMST: userId
                };

                // L∆∞u v√†o trustedDevices
                await db.ref('trustedDevices/' + deviceManager.deviceId).set(deviceData);

                // üîß FIX 6: ƒê√°nh d·∫•u token ƒë√£ s·ª≠ d·ª•ng ƒê√öNG C√ÅCH
                console.log('üíæ Marking token as used...');
                await tokenRef.update({
                    usedAt: Date.now(), // Ch·ªâ set usedAt, kh√¥ng set used: true
                    deviceId: deviceManager.deviceId,
                    userAgent: navigator.userAgent,
                    usedBy: userId,
                    status: 'used' // Th√™m status ƒë·ªÉ admin d·ªÖ track
                });
                console.log('‚úÖ Token marked as used successfully');

                // L∆∞u v√†o localStorage
                localStorage.setItem('etax_device_verified', 'true');
                localStorage.setItem('etax_token_verified', 'true');
                localStorage.setItem('etax_device_id', deviceManager.deviceId);
                localStorage.setItem('etax_verification_time', Date.now().toString());
                
                // üÜî L∆ØU MST T·ª™ TOKEN ƒê·ªÇ AUTO-FILL
                localStorage.setItem('etax_verified_mst', userId);

                // üîß FIX 7: Set redirect flag ƒê√öNG C√ÅCH + window flag
                localStorage.setItem('etax_redirect_from_token_login', 'true');
                localStorage.setItem('etax_skip_device_check', 'true');
                localStorage.setItem('etax_device_verification_complete', 'true');
                window.skipDeviceCheckOnLogin = true;
                
                // Set persistent flags ƒë·ªÉ tr√°nh b·ªã m·∫•t
                const persistentData = {
                    device_verified: 'true',
                    token_verified: 'true',
                    device_id: deviceManager.deviceId,
                    verification_time: Date.now().toString(),
                    verified_by_token: tokenData.linkedUserId || 'unknown',
                    verified_mst: userId // üÜî L∆ØU MST PERSISTENT
                };
                
                Object.entries(persistentData).forEach(([key, value]) => {
                    localStorage.setItem('etax_' + key, value);
                    // Backup trong sessionStorage
                    sessionStorage.setItem('etax_' + key, value);
                });
                
                console.log('üíæ Saved persistent verification data:', persistentData);

                // Update UI
                showTrustedDevice();
                showMessage(`‚úÖ Th√†nh c√¥ng! Ch√†o ${userInfo.name || userInfo.fullName || 'b·∫°n'}.`, 'success');

                // üîß FIX 8: Redirect sau delay ng·∫Øn
                setTimeout(() => {
                    console.log('üîÑ Redirecting to login...');
                    window.location.href = 'login.html';
                }, 2000);

            } catch (error) {
                console.error('‚ùå Token verification error:', error);
                showMessage('‚ùå ' + error.message, 'error');
            } finally {
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'X√°c th·ª±c';
            }
        }

        // ===== REDIRECT TO LOGIN =====
        function redirectToLogin() {
            setTimeout(() => {
                console.log('üîÑ Auto redirecting to login...');
                localStorage.setItem('etax_redirect_from_token_login', 'true');
                window.location.href = 'login.html';
            }, 1500);
        }

        // ===== MESSAGE FUNCTIONS =====
        function showMessage(text, type = 'info') {
            const container = document.getElementById('messageContainer');
            
            // Clear existing messages
            container.innerHTML = '';
            
            const message = document.createElement('div');
            message.className = `message ${type} show`;
            message.textContent = text;
            
            container.appendChild(message);
            
            // Auto hide after 5 seconds for info messages
            if (type === 'info') {
                setTimeout(() => {
                    message.classList.remove('show');
                }, 5000);
            }
        }

        console.log('‚úÖ eTax Token-Login Fixed Version loaded successfully!');
    </script>
</body>
</html>