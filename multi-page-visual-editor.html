<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ¨ MULTI-PAGE VISUAL EDITOR - ETAX ADMIN</title>
  
  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', 'Tahoma', 'Microsoft Sans Serif', 'Arial', sans-serif;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      overflow: hidden;
    }

    .visual-editor-container {
      display: grid;
      grid-template-columns: 300px 1fr 350px;
      height: 100vh;
      background: white;
    }

    /* Left Sidebar - Page Navigation */
    .page-navigator {
      background: #2c3e50;
      color: white;
      overflow-y: auto;
    }

    .navigator-header {
      background: #34495e;
      padding: 20px;
      text-align: center;
      border-bottom: 1px solid #455a7a;
    }

    .navigator-header h2 {
      font-size: 16px;
      margin-bottom: 5px;
    }

    .navigator-header p {
      font-size: 12px;
      opacity: 0.8;
    }

    .page-list {
      padding: 15px 0;
    }

    .page-item {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      cursor: pointer;
      transition: all 0.3s;
      border-bottom: 1px solid #34495e;
    }

    .page-item:hover {
      background: #34495e;
    }

    .page-item.active {
      background: #b71c1c;
      border-left: 4px solid #ff5722;
    }

    .page-icon {
      width: 30px;
      text-align: center;
      font-size: 16px;
      margin-right: 10px;
    }

    .page-info h4 {
      font-size: 13px;
      margin-bottom: 2px;
    }

    .page-info p {
      font-size: 11px;
      opacity: 0.7;
    }

    /* Center - Live Preview */
    .preview-area {
      background: #f8f9fa;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .preview-toolbar {
      background: white;
      padding: 15px 20px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .preview-info h3 {
      color: #333;
      font-size: 16px;
      margin-bottom: 3px;
    }

    .preview-info p {
      color: #666;
      font-size: 12px;
    }

    .preview-controls {
      display: flex;
      gap: 10px;
    }

    .preview-btn {
      background: #e0e0e0;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.3s;
    }

    .preview-btn.active {
      background: #b71c1c;
      color: white;
    }

    .preview-frame-container {
      flex: 1;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      overflow: auto;
    }

    .preview-frame {
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }

    .preview-frame.mobile-view {
      width: 375px;
      height: 667px;
    }

    .preview-frame.tablet-view {
      width: 768px;
      height: 600px;
    }

    .preview-frame.desktop-view {
      width: 1024px;
      height: 600px;
    }

    .editable-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 100;
    }

    .editable-element {
      position: absolute;
      border: 2px dashed transparent;
      cursor: pointer;
      pointer-events: all;
      transition: all 0.3s;
    }

    .editable-element:hover {
      border-color: #ff5722;
      background: rgba(255, 87, 34, 0.1);
    }

    .editable-element.selected {
      border-color: #b71c1c;
      background: rgba(183, 28, 28, 0.1);
    }

    .edit-tooltip {
      position: absolute;
      top: -30px;
      left: 0;
      background: #333;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      white-space: nowrap;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .editable-element:hover .edit-tooltip {
      opacity: 1;
    }

    /* Right Sidebar - Style Controls */
    .style-controls {
      background: white;
      border-left: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .controls-header {
      background: #f8f9fa;
      padding: 20px;
      border-bottom: 1px solid #e0e0e0;
    }

    .controls-header h3 {
      color: #333;
      font-size: 16px;
      margin-bottom: 5px;
    }

    .controls-header p {
      color: #666;
      font-size: 12px;
    }

    .controls-body {
      flex: 1;
      padding: 20px;
    }

    .control-section {
      margin-bottom: 25px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
      border: 1px solid #e9ecef;
    }

    .control-section h4 {
      color: #b71c1c;
      margin-bottom: 12px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .control-group {
      margin-bottom: 12px;
    }

    .control-label {
      display: block;
      margin-bottom: 4px;
      font-weight: 600;
      color: #333;
      font-size: 12px;
    }

    .control-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 12px;
      transition: all 0.3s;
    }

    .control-input:focus {
      outline: none;
      border-color: #b71c1c;
      box-shadow: 0 0 0 2px rgba(183, 28, 28, 0.1);
    }

    .color-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      margin-top: 6px;
    }

    .color-option {
      width: 30px;
      height: 30px;
      border-radius: 6px;
      border: 1px solid #ddd;
      cursor: pointer;
      transition: all 0.3s;
    }

    .color-option:hover,
    .color-option.active {
      transform: scale(1.1);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .size-slider {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
    }

    .size-slider input[type="range"] {
      flex: 1;
    }

    .size-display {
      background: #e9ecef;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      min-width: 45px;
      text-align: center;
    }

    .apply-buttons {
      padding: 15px 20px;
      border-top: 1px solid #e0e0e0;
      background: #f8f9fa;
    }

    .apply-btn {
      width: 100%;
      background: linear-gradient(135deg, #b71c1c 0%, #dc3545 100%);
      color: white;
      border: none;
      padding: 10px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 8px;
    }

    .apply-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(183, 28, 28, 0.3);
    }

    .reset-btn {
      width: 100%;
      background: #6c757d;
      color: white;
      border: none;
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
    }

    /* Page Content Templates */
    .page-content {
      width: 100%;
      height: 100%;
      overflow-y: auto;
    }

    .etax-page {
      background: white;
      min-height: 100%;
    }

    .etax-header {
      background: linear-gradient(135deg, #b71c1c 0%, #8e0000 100%);
      color: white;
      padding: 15px;
      text-align: center;
      font-weight: 600;
      position: relative;
    }

    .etax-content {
      padding: 20px;
    }

    .user-info-section {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      text-align: center;
    }

    .user-name {
      font-size: 18px;
      font-weight: 700;
      color: #333;
      margin-bottom: 8px;
    }

    .user-mst {
      color: #666;
      font-size: 14px;
      margin-bottom: 5px;
    }

    .user-address {
      color: #888;
      font-size: 12px;
    }

    .tax-card {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin: 10px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 1px solid #f0f0f0;
    }

    .tax-card h4 {
      color: #b71c1c;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .tax-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      font-size: 12px;
    }

    .no-selection {
      text-align: center;
      color: #999;
      padding: 40px 20px;
    }

    @media (max-width: 1200px) {
      .visual-editor-container {
        grid-template-columns: 250px 1fr 300px;
      }
    }

    @media (max-width: 768px) {
      .visual-editor-container {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr auto;
      }
      
      .page-navigator,
      .style-controls {
        max-height: 200px;
      }
    }
  </style>
</head>
<body>
  <div class="visual-editor-container">
    <!-- Left Sidebar - Page Navigation -->
    <div class="page-navigator">
      <div class="navigator-header">
        <h2>ğŸ“± TRANG ETAX</h2>
        <p>Chá»n trang Ä‘á»ƒ chá»‰nh sá»­a</p>
      </div>
      
      <div class="page-list">
        <div class="page-item active" onclick="selectPage('index')" data-page="index">
          <div class="page-icon">ğŸ </div>
          <div class="page-info">
            <h4>Trang chÃ­nh</h4>
            <p>index.html</p>
          </div>
        </div>
        
        <div class="page-item" onclick="selectPage('login')" data-page="login">
          <div class="page-icon">ğŸ”</div>
          <div class="page-info">
            <h4>ÄÄƒng nháº­p</h4>
            <p>user-otp-system.html</p>
          </div>
        </div>
        
        <div class="page-item" onclick="selectPage('tax-info')" data-page="tax-info">
          <div class="page-icon">ğŸ“‹</div>
          <div class="page-info">
            <h4>ThÃ´ng tin thuáº¿</h4>
            <p>thong-tin-nghia-vu-thue.html</p>
          </div>
        </div>
        
        <div class="page-item" onclick="selectPage('notifications')" data-page="notifications">
          <div class="page-icon">ğŸ””</div>
          <div class="page-info">
            <h4>ThÃ´ng bÃ¡o</h4>
            <p>thong-bao.html</p>
          </div>
        </div>
        
        <div class="page-item" onclick="selectPage('search')" data-page="search">
          <div class="page-icon">ğŸ”</div>
          <div class="page-info">
            <h4>Tra cá»©u</h4>
            <p>tra-cuu.html</p>
          </div>
        </div>
        
        <div class="page-item" onclick="selectPage('profile')" data-page="profile">
          <div class="page-icon">ğŸ‘¤</div>
          <div class="page-info">
            <h4>Há»“ sÆ¡</h4>
            <p>ho-so-ca-nhan.html</p>
          </div>
        </div>
        
        <div class="page-item" onclick="selectPage('payment')" data-page="payment">
          <div class="page-icon">ğŸ’³</div>
          <div class="page-info">
            <h4>Thanh toÃ¡n</h4>
            <p>thanh-toan.html</p>
          </div>
        </div>
        
        <div class="page-item" onclick="selectPage('history')" data-page="history">
          <div class="page-icon">ğŸ“œ</div>
          <div class="page-info">
            <h4>Lá»‹ch sá»­</h4>
            <p>lich-su-giao-dich.html</p>
          </div>
        </div>
        
        <div class="page-item" onclick="selectPage('support')" data-page="support">
          <div class="page-icon">ğŸ†˜</div>
          <div class="page-info">
            <h4>Há»— trá»£</h4>
            <p>ho-tro.html</p>
          </div>
        </div>
        
        <div class="page-item" onclick="selectPage('settings')" data-page="settings">
          <div class="page-icon">âš™ï¸</div>
          <div class="page-info">
            <h4>CÃ i Ä‘áº·t</h4>
            <p>cai-dat.html</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Center - Live Preview -->
    <div class="preview-area">
      <div class="preview-toolbar">
        <div class="preview-info">
          <h3 id="currentPageTitle">ğŸ  Trang chÃ­nh - index.html</h3>
          <p>Click vÃ o element Ä‘á»ƒ chá»‰nh sá»­a styling</p>
        </div>
        
        <div class="preview-controls">
          <button class="preview-btn active" onclick="setPreviewMode('mobile')">ğŸ“± Mobile</button>
          <button class="preview-btn" onclick="setPreviewMode('tablet')">ğŸ“Ÿ Tablet</button>
          <button class="preview-btn" onclick="setPreviewMode('desktop')">ğŸ–¥ï¸ Desktop</button>
        </div>
      </div>
      
      <div class="preview-frame-container">
        <div class="preview-frame mobile-view" id="previewFrame">
          <div class="page-content" id="pageContent">
            <!-- Content sáº½ Ä‘Æ°á»£c load Ä‘á»™ng -->
          </div>
          
          <!-- Editable Overlay -->
          <div class="editable-overlay" id="editableOverlay">
            <!-- Editable elements sáº½ Ä‘Æ°á»£c táº¡o Ä‘á»™ng -->
          </div>
        </div>
      </div>
    </div>

    <!-- Right Sidebar - Style Controls -->
    <div class="style-controls">
      <div class="controls-header">
        <h3>ğŸ¨ CHá»ˆNH Sá»¬A STYLE</h3>
        <p id="selectedElementInfo">Chá»n element Ä‘á»ƒ chá»‰nh sá»­a</p>
      </div>
      
      <div class="controls-body" id="controlsBody">
        <div class="no-selection">
          <h4>ğŸ‘† Chá»n element</h4>
          <p>Click vÃ o text, button hoáº·c element trÃªn preview Ä‘á»ƒ chá»‰nh sá»­a styling</p>
        </div>
      </div>
      
      <div class="apply-buttons" style="display: none;" id="applyButtons">
        <button class="apply-btn" onclick="applyStyles()">
          ğŸ’¾ Ãp dá»¥ng thay Ä‘á»•i
        </button>
        <button class="reset-btn" onclick="resetElement()">
          ğŸ”„ Reset vá» máº·c Ä‘á»‹nh
        </button>
      </div>
    </div>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD_rJgBFgBulheVenQUE2KXr4PBpSpTCxw",
      authDomain: "etax-7fbf8.firebaseapp.com",
      databaseURL: "https://etax-7fbf8-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "etax-7fbf8",
      storageBucket: "etax-7fbf8.appspot.com",
      messagingSenderId: "1030026724634",
      appId: "1:1030026724634:web:d76f5f9dad43bad6fd58a3",
      measurementId: "G-YS5DLECJE6"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentPage = 'index';
    let selectedElement = null;
    let currentStyles = {};

    // ğŸ“„ Page URLs - Load real pages via iframe
    const pageUrls = {
      index: {
        title: 'ğŸ  Trang chÃ­nh - index.html',
        url: 'index.html',
        editableSelectors: ['h1', '.user-name', '.tax-amount', 'button', '.page-title']
      },
      
      login: {
        title: 'ğŸ” ÄÄƒng nháº­p - user-otp-system.html',
        url: 'user-otp-system.html',
        editableSelectors: ['.login-title', '.user-name', '.form-label', '.login-btn']
      },
      
      'tax-info': {
        title: 'ğŸ“‹ ThÃ´ng tin thuáº¿ - thong-tin-nghia-vu-thue.html',
        url: 'content-styling-demo.html', // Demo page for now
        editableSelectors: ['.user-name', '.tax-amount', '.tax-info', 'h3', 'h4']
      },
      
      notifications: {
        title: 'ğŸ”” ThÃ´ng bÃ¡o - thong-bao.html',
        url: 'thongbao.html',
        editableSelectors: ['.notification-title', '.notification-content', '.date']
      },
      
      search: {
        title: 'ğŸ” Tra cá»©u - tra-cuu.html',
        url: 'tracuttnpt.html',
        editableSelectors: ['input', 'button', '.search-results', '.tax-info']
      },
      
      profile: {
        title: 'ğŸ‘¤ Há»“ sÆ¡ - ho-so-ca-nhan.html',
        url: 'hoso.html',
        editableSelectors: ['.user-name', '.user-info', '.profile-field']
      },
      
      payment: {
        title: 'ğŸ’³ Thanh toÃ¡n - thanh-toan.html',
        url: 'nopthue.html',
        editableSelectors: ['.payment-amount', '.payment-method', '.user-info']
      },
      
      history: {
        title: 'ğŸ“œ Lá»‹ch sá»­ - lich-su-giao-dich.html',
        url: 'thongtin.html',
        editableSelectors: ['.history-item', '.date', '.amount']
      },
      
      support: {
        title: 'ğŸ†˜ Há»— trá»£ - ho-tro.html',
        url: 'hotro.html',
        editableSelectors: ['.support-content', '.contact-info', '.faq-item']
      },
      
      settings: {
        title: 'âš™ï¸ CÃ i Ä‘áº·t - cai-dat.html',
        url: 'thietlap.html',
        editableSelectors: ['.setting-item', '.setting-value', '.user-preferences']
      }
    };

    // ğŸ¯ Initialize
    function init() {
      try {
        console.log('ğŸ¨ Multi-Page Visual Editor starting...');
        loadPage('index');
        console.log('âœ… Multi-Page Visual Editor loaded successfully');
      } catch (error) {
        console.error('âŒ Error initializing Visual Editor:', error);
        // Fallback: Show manual interface
        document.getElementById('pageContent').innerHTML = `
          <div style="padding: 40px; text-align: center;">
            <h3 style="color: #b71c1c;">ğŸ¨ VISUAL EDITOR</h3>
            <p style="margin: 20px 0;">Ready to edit eTax pages!</p>
            <button onclick="loadPage('index')" style="background: #b71c1c; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer;">
              ğŸ  Load Trang chÃ­nh
            </button>
          </div>
        `;
      }
    }

    // ğŸ“„ Select page
    function selectPage(pageId) {
      // Update active state
      document.querySelectorAll('.page-item').forEach(item => {
        item.classList.remove('active');
      });
      document.querySelector(`[data-page="${pageId}"]`).classList.add('active');
      
      currentPage = pageId;
      selectedElement = null;
      loadPage(pageId);
      clearSelection();
    }

    // ğŸ“„ Load page content via iframe
    function loadPage(pageId) {
      try {
        console.log(`Loading page: ${pageId}`);
        
        const pageInfo = pageUrls[pageId];
        if (!pageInfo) {
          console.warn(`No config found for page: ${pageId}`);
          document.getElementById('pageContent').innerHTML = `
            <div style="padding: 40px; text-align: center; color: #999;">
              <h3>ğŸš§ Trang Ä‘ang phÃ¡t triá»ƒn</h3>
              <p>Page config cho ${pageId} sáº½ Ä‘Æ°á»£c thÃªm sau</p>
              <div style="margin-top: 20px;">
                <button onclick="loadPage('index')" style="background: #b71c1c; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; margin: 5px;">
                  ğŸ  Trang chÃ­nh
                </button>
                <button onclick="loadPage('login')" style="background: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; margin: 5px;">
                  ğŸ” ÄÄƒng nháº­p
                </button>
              </div>
            </div>
          `;
          return;
        }
        
        // Update title
        const titleElement = document.getElementById('currentPageTitle');
        if (titleElement) {
          titleElement.textContent = pageInfo.title;
        }
        
        // Create iframe to load real page
        const pageContent = document.getElementById('pageContent');
        if (pageContent) {
          pageContent.innerHTML = `
            <iframe 
              id="pageIframe" 
              src="${pageInfo.url}" 
              style="width: 100%; height: 100%; border: none; border-radius: 10px;"
              onload="setupIframeEditing('${pageId}')"
              onerror="handleIframeError('${pageId}')"
            ></iframe>
          `;
        }
        
        // Add loading indicator
        showLoadingState();
        
        console.log(`âœ… Page ${pageId} loading initiated`);
        
      } catch (error) {
        console.error(`âŒ Error loading page ${pageId}:`, error);
        document.getElementById('pageContent').innerHTML = `
          <div style="padding: 40px; text-align: center; color: #dc3545;">
            <h3>âŒ Lá»—i táº£i trang</h3>
            <p>CÃ³ lá»—i khi táº£i ${pageId}: ${error.message}</p>
            <button onclick="loadPage('index')" style="background: #b71c1c; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; margin-top: 15px;">
              ğŸ”„ Thá»­ láº¡i
            </button>
          </div>
        `;
      }
    }

    // ğŸš¨ Handle iframe loading errors
    function handleIframeError(pageId) {
      console.error(`âŒ Iframe failed to load: ${pageId}`);
      document.getElementById('pageContent').innerHTML = `
        <div style="padding: 40px; text-align: center; color: #dc3545;">
          <h3>âŒ KhÃ´ng thá»ƒ táº£i trang</h3>
          <p>File ${pageUrls[pageId]?.url || pageId} khÃ´ng tá»“n táº¡i hoáº·c khÃ´ng thá»ƒ truy cáº­p</p>
          <button onclick="loadPage('index')" style="background: #b71c1c; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; margin-top: 15px;">
            ğŸ”„ Thá»­ táº£i trang khÃ¡c
          </button>
        </div>
      `;
    }

    // ğŸ”„ Show loading state
    function showLoadingState() {
      document.getElementById('editableOverlay').innerHTML = `
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #666;">
          <div class="spinner" style="margin: 0 auto 15px;"></div>
          <p>Äang táº£i trang...</p>
        </div>
      `;
    }

    // ğŸ¯ Setup iframe editing
    function setupIframeEditing(pageId) {
      const iframe = document.getElementById('pageIframe');
      const pageInfo = pageUrls[pageId];
      
      try {
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        const overlay = document.getElementById('editableOverlay');
        overlay.innerHTML = '';
        
        // Find editable elements based on selectors
        pageInfo.editableSelectors.forEach((selector, index) => {
          const elements = iframeDoc.querySelectorAll(selector);
          
          elements.forEach((element, elemIndex) => {
            createEditableOverlay(element, iframe, `${selector}-${elemIndex}`, index + elemIndex);
          });
        });
        
      } catch (error) {
        console.log('Cross-origin iframe - using fallback method');
        // Fallback for cross-origin iframes
        setupFallbackEditing(pageId);
      }
    }

    // ğŸ¯ Create editable overlay for iframe elements
    function createEditableOverlay(element, iframe, elementId, index) {
      const iframeRect = iframe.getBoundingClientRect();
      const elementRect = element.getBoundingClientRect();
      const overlay = document.getElementById('editableOverlay');
      
      const editableDiv = document.createElement('div');
      editableDiv.className = 'editable-element';
      editableDiv.dataset.elementId = elementId;
      editableDiv.dataset.index = index;
      
      // Position overlay element relative to iframe
      editableDiv.style.left = (elementRect.left - iframeRect.left) + 'px';
      editableDiv.style.top = (elementRect.top - iframeRect.top) + 'px';
      editableDiv.style.width = elementRect.width + 'px';
      editableDiv.style.height = elementRect.height + 'px';
      
      // Add tooltip
      const tooltip = document.createElement('div');
      tooltip.className = 'edit-tooltip';
      tooltip.textContent = `Chá»‰nh sá»­a: ${elementId}`;
      editableDiv.appendChild(tooltip);
      
      // Click handler
      editableDiv.addEventListener('click', () => {
        selectIframeElement(element, editableDiv, elementId);
      });
      
      overlay.appendChild(editableDiv);
    }

    // ğŸ¯ Setup fallback editing for cross-origin iframes
    function setupFallbackEditing(pageId) {
      const overlay = document.getElementById('editableOverlay');
      overlay.innerHTML = `
        <div style="padding: 30px; text-align: center; color: #666; background: rgba(255,255,255,0.9); border-radius: 10px; margin: 20px;">
          <h4 style="color: #b71c1c; margin-bottom: 15px;">ğŸ¯ IFRAME EDITING MODE</h4>
          <p style="margin-bottom: 20px;">
            Trang <strong>${pageId}</strong> Ä‘Ã£ Ä‘Æ°á»£c load thÃ nh cÃ´ng!<br>
            Sá»­ dá»¥ng cÃ¡c controls bÃªn pháº£i Ä‘á»ƒ chá»‰nh sá»­a styling.
          </p>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin: 20px 0;">
            <button class="preview-btn" onclick="selectFallbackElement('user-name', 'TÃªn ngÆ°á»i dÃ¹ng')">ğŸ‘¤ TÃªn</button>
            <button class="preview-btn" onclick="selectFallbackElement('title', 'TiÃªu Ä‘á»')">ğŸ“ TiÃªu Ä‘á»</button>
            <button class="preview-btn" onclick="selectFallbackElement('button', 'NÃºt báº¥m')">ğŸ”˜ Button</button>
            <button class="preview-btn" onclick="selectFallbackElement('content', 'Ná»™i dung')">ğŸ“„ Content</button>
          </div>
          
          <p style="font-size: 12px; color: #999;">
            Click vÃ o element type Ä‘á»ƒ chá»‰nh sá»­a styling
          </p>
        </div>
      `;
    }

    // ğŸ¯ Select fallback element
    function selectFallbackElement(elementType, displayName) {
      selectedElement = {
        type: elementType,
        name: displayName
      };
      
      // Mock current styles
      currentStyles = {
        color: '#333',
        fontSize: 16,
        fontWeight: '400',
        textAlign: 'left',
        marginTop: 0,
        marginBottom: 0,
        paddingTop: 0,
        paddingBottom: 0
      };
      
      updateFallbackStyleControls(elementType, displayName);
    }

    // ğŸ¯ Select iframe element for editing
    function selectIframeElement(element, overlayElement, elementId) {
      // Clear previous selection
      document.querySelectorAll('.editable-element').forEach(el => {
        el.classList.remove('selected');
      });
      
      // Select new element
      overlayElement.classList.add('selected');
      selectedElement = {
        element: element,
        id: elementId,
        isIframe: true
      };
      
      // Get current styles from iframe element
      try {
        const computedStyle = element.ownerDocument.defaultView.getComputedStyle(element);
        currentStyles = {
          color: rgbToHex(computedStyle.color),
          fontSize: parseInt(computedStyle.fontSize),
          fontWeight: computedStyle.fontWeight,
          textAlign: computedStyle.textAlign,
          marginTop: parseInt(computedStyle.marginTop) || 0,
          marginBottom: parseInt(computedStyle.marginBottom) || 0,
          paddingTop: parseInt(computedStyle.paddingTop) || 0,
          paddingBottom: parseInt(computedStyle.paddingBottom) || 0
        };
      } catch (error) {
        // Fallback styles
        currentStyles = {
          color: '#333',
          fontSize: 16,
          fontWeight: '400',
          textAlign: 'left',
          marginTop: 0,
          marginBottom: 0,
          paddingTop: 0,
          paddingBottom: 0
        };
      }
      
      // Update controls
      updateStyleControls();
    }

    // ğŸ¯ Select element for editing (legacy)
    function selectElement(element, overlayElement) {
      // Clear previous selection
      document.querySelectorAll('.editable-element').forEach(el => {
        el.classList.remove('selected');
      });
      
      // Select new element
      overlayElement.classList.add('selected');
      selectedElement = element;
      
      // Get current styles
      const computedStyle = window.getComputedStyle(element);
      currentStyles = {
        color: rgbToHex(computedStyle.color),
        fontSize: parseInt(computedStyle.fontSize),
        fontWeight: computedStyle.fontWeight,
        textAlign: computedStyle.textAlign,
        marginTop: parseInt(computedStyle.marginTop) || 0,
        marginBottom: parseInt(computedStyle.marginBottom) || 0,
        paddingTop: parseInt(computedStyle.paddingTop) || 0,
        paddingBottom: parseInt(computedStyle.paddingBottom) || 0
      };
      
      // Update controls
      updateStyleControls();
    }

    // ğŸ¨ Update fallback style controls
    function updateFallbackStyleControls(elementType, displayName) {
      document.getElementById('selectedElementInfo').textContent = 
        `Äang chá»‰nh sá»­a: ${displayName} (${elementType})`;
      
      updateStyleControlsHTML();
      document.getElementById('applyButtons').style.display = 'block';
    }

    // ğŸ¨ Update style controls HTML
    function updateStyleControlsHTML() {
      document.getElementById('controlsBody').innerHTML = `
        <div class="control-section">
          <h4>ğŸ¨ MÃ u sáº¯c</h4>
          <div class="control-group">
            <label class="control-label">MÃ u chá»¯:</label>
            <input type="color" class="control-input" value="${currentStyles.color}" 
                   onchange="updateStyle('color', this.value)">
          </div>
          <div class="color-grid">
            <div class="color-option" style="background: #333" onclick="updateStyle('color', '#333')"></div>
            <div class="color-option" style="background: #b71c1c" onclick="updateStyle('color', '#b71c1c')"></div>
            <div class="color-option" style="background: #ffc107" onclick="updateStyle('color', '#ffc107')"></div>
            <div class="color-option" style="background: #28a745" onclick="updateStyle('color', '#28a745')"></div>
          </div>
        </div>

        <div class="control-section">
          <h4>ğŸ“ KÃ­ch thÆ°á»›c</h4>
          <div class="control-group">
            <label class="control-label">Cá»¡ chá»¯:</label>
            <div class="size-slider">
              <input type="range" min="10" max="48" value="${currentStyles.fontSize}" 
                     oninput="updateStyle('fontSize', this.value + 'px'); updateSizeDisplay(this.value)">
              <div class="size-display" id="sizeDisplay">${currentStyles.fontSize}px</div>
            </div>
          </div>
          
          <div class="control-group">
            <label class="control-label">Äá»™ Ä‘áº­m:</label>
            <select class="control-input" onchange="updateStyle('fontWeight', this.value)">
              <option value="400" ${currentStyles.fontWeight === '400' ? 'selected' : ''}>BÃ¬nh thÆ°á»ng</option>
              <option value="600" ${currentStyles.fontWeight === '600' ? 'selected' : ''}>Semi-bold</option>
              <option value="700" ${currentStyles.fontWeight === '700' ? 'selected' : ''}>Äáº­m</option>
              <option value="800" ${currentStyles.fontWeight === '800' ? 'selected' : ''}>Ráº¥t Ä‘áº­m</option>
            </select>
          </div>
        </div>

        <div class="control-section">
          <h4>ğŸ“ CÄƒn chá»‰nh & Khoáº£ng cÃ¡ch</h4>
          <div class="control-group">
            <label class="control-label">CÄƒn chá»‰nh:</label>
            <select class="control-input" onchange="updateStyle('textAlign', this.value)">
              <option value="left" ${currentStyles.textAlign === 'left' ? 'selected' : ''}>TrÃ¡i</option>
              <option value="center" ${currentStyles.textAlign === 'center' ? 'selected' : ''}>Giá»¯a</option>
              <option value="right" ${currentStyles.textAlign === 'right' ? 'selected' : ''}>Pháº£i</option>
            </select>
          </div>
          
          <div class="control-group">
            <label class="control-label">Margin trÃªn:</label>
            <input type="range" class="control-input" min="0" max="50" value="${currentStyles.marginTop}" 
                   oninput="updateStyle('marginTop', this.value + 'px')">
          </div>
          
          <div class="control-group">
            <label class="control-label">Margin dÆ°á»›i:</label>
            <input type="range" class="control-input" min="0" max="50" value="${currentStyles.marginBottom}" 
                   oninput="updateStyle('marginBottom', this.value + 'px')">
          </div>
        </div>
      `;
    }

    // ğŸ¨ Update style controls
    function updateStyleControls() {
      if (!selectedElement) return;
      
      const elementInfo = selectedElement.isIframe 
        ? `${selectedElement.id} (iframe)` 
        : selectedElement.dataset?.editable || selectedElement.name || 'Unknown element';
      
      document.getElementById('selectedElementInfo').textContent = 
        `Äang chá»‰nh sá»­a: ${elementInfo}`;
      
      updateStyleControlsHTML();
      document.getElementById('applyButtons').style.display = 'block';
    }

    // ğŸ¨ Update style
    function updateStyle(property, value) {
      if (!selectedElement) return;
      
      currentStyles[property] = value;
      
      // Apply style based on element type
      if (selectedElement.isIframe && selectedElement.element) {
        // Apply to iframe element
        selectedElement.element.style[property] = value;
      } else if (selectedElement.style) {
        // Apply to regular element
        selectedElement.style[property] = value;
      }
      
      // Update display
      if (property === 'fontSize') {
        const sizeDisplay = document.getElementById('sizeDisplay');
        if (sizeDisplay) {
          sizeDisplay.textContent = value;
        }
      }
    }

    // ğŸ“± Set preview mode
    function setPreviewMode(mode) {
      const frame = document.getElementById('previewFrame');
      const buttons = document.querySelectorAll('.preview-btn');
      
      // Update buttons
      buttons.forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      // Update frame
      frame.className = `preview-frame ${mode}-view`;
      
      // Refresh editable elements
      setTimeout(() => {
        setupEditableElements();
      }, 300);
    }

    // ğŸ’¾ Apply styles
    async function applyStyles() {
      if (!selectedElement) return;
      
      try {
        const elementId = selectedElement.isIframe 
          ? selectedElement.id 
          : selectedElement.dataset?.editable || selectedElement.type || 'unknown';
        
        const styleData = {
          page: currentPage,
          element: elementId,
          styles: currentStyles,
          updatedAt: Date.now(),
          updatedBy: 'admin@etax.vn',
          elementType: selectedElement.isIframe ? 'iframe' : 'direct'
        };
        
        await db.ref(`pageStyles/${currentPage}/${elementId}`).set(styleData);
        
        alert(`âœ… ÄÃ£ lÆ°u styling cho "${elementId}" thÃ nh cÃ´ng!\n\nThay Ä‘á»•i sáº½ Ä‘Æ°á»£c Ã¡p dá»¥ng trÃªn trang tháº­t.`);
        
        console.log('ğŸ’¾ Saved style data:', styleData);
        
      } catch (error) {
        console.error('Save error:', error);
        alert('âŒ CÃ³ lá»—i khi lÆ°u. Vui lÃ²ng thá»­ láº¡i!');
      }
    }

    // ğŸ”„ Reset element
    function resetElement() {
      if (!selectedElement) return;
      
      selectedElement.style.cssText = '';
      clearSelection();
    }

    // ğŸ§¹ Clear selection
    function clearSelection() {
      selectedElement = null;
      document.querySelectorAll('.editable-element').forEach(el => {
        el.classList.remove('selected');
      });
      
      document.getElementById('selectedElementInfo').textContent = 'Chá»n element Ä‘á»ƒ chá»‰nh sá»­a';
      document.getElementById('controlsBody').innerHTML = `
        <div class="no-selection">
          <h4>ğŸ‘† Chá»n element</h4>
          <p>Click vÃ o text, button hoáº·c element trÃªn preview Ä‘á»ƒ chá»‰nh sá»­a styling</p>
        </div>
      `;
      document.getElementById('applyButtons').style.display = 'none';
    }

    // ğŸ”§ Helper functions
    function updateSizeDisplay(value) {
      document.getElementById('sizeDisplay').textContent = value + 'px';
    }

    function rgbToHex(rgb) {
      if (rgb.startsWith('#')) return rgb;
      const values = rgb.match(/\d+/g);
      if (!values) return '#000000';
      return '#' + values.map(x => parseInt(x).toString(16).padStart(2, '0')).join('');
    }

    // ğŸš€ Initialize on load
    window.onload = init;
  </script>
</body>
</html>