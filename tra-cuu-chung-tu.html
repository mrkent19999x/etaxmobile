<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <!-- ===== PWA META TAGS HO√ÄN CH·ªàNH ===== -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#b71c1c">
  <meta name="msapplication-navbutton-color" content="#b71c1c">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="eTax Mobile">
  <link rel="apple-touch-icon" href="./assets/logo.png">
  <link rel="apple-touch-icon" sizes="152x152" href="./assets/logo.png">
  <link rel="apple-touch-icon" sizes="180x180" href="./assets/logo.png">
  <meta name="format-detection" content="telephone=no">
  <meta name="format-detection" content="email=no">
  
  <title>Tra c·ª©u ch·ª©ng t·ª´ - eTax Mobile</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <link rel="stylesheet" href="css/etax-template.css">
  <style>
    /* ‚úÖ OVERRIDE EXTERNAL CSS - FORCE FULL WIDTH HEADER */
    .header {
      position: sticky !important;
      top: 0 !important;
      background-color: #b71c1c !important;
      width: 100vw !important; /* ‚úÖ Full width override */
      max-width: none !important; /* ‚úÖ Remove max-width constraint */
      margin: 0 !important; /* ‚úÖ Remove margin auto */
      left: 0 !important;
      right: 0 !important;
      padding-left: 0 !important;
      padding-right: 0 !important;
      border-radius: 0 !important; /* ‚úÖ Remove border radius */
      box-shadow: none !important; /* ‚úÖ Remove border shadows */
    }
    
    /* ‚úÖ OVERRIDE PHONE-FRAME CONSTRAINTS */
    .phone-frame {
      width: 100vw !important;
      max-width: none !important;
      margin: 0 !important;
      border-radius: 0 !important;
      box-shadow: none !important;
    }
    
    /* ‚úÖ CONTENT FULL WIDTH WITH PROPER SPACING */
    .content {
      width: 100vw !important;
      max-width: none !important;
      margin: 0 !important;
      padding: 20px 16px !important; /* ‚úÖ Better spacing for form */
    }
    
    /* ‚úÖ FORM ELEMENTS SPACING */
    .form-group {
        display: flex;
        align-items: center;
        margin-bottom: 15px !important;
    }
    .form-group label {
        width: 120px; /* Fixed width for labels */
        text-align: left;
        margin-right: 10px;
        color: #333;
    }
    .form-input {
        flex: 1;
        text-align: left;
    }
    /* Style for date input icon */
    input[type="date"]::-webkit-calendar-picker-indicator {
        filter: invert(20%) sepia(100%) saturate(500%) hue-rotate(330deg);
    }
    
    .form-input {
      padding: 12px 16px !important;
      margin-top: 8px !important;
      border-radius: 8px !important;
      border: 1px solid #ddd !important;
      font-size: 16px !important;
    }
    
    .btn-search, .btn-print {
      margin-top: 16px !important;
      padding: 14px 20px !important;
      border-radius: 8px !important;
    }
    
    /* ‚úÖ TABLE STYLING */
    .result-table {
      margin-top: 24px !important;
      padding: 16px !important;
      background: white !important;
      border-radius: 8px !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
    }
    
    /* ‚úÖ LO·∫†I B·ªé THANH ƒêEN 2 B√äN - OVERRIDE EXTERNAL CSS */
    body {
      padding-top: 0 !important;
      background: #fff !important; /* ‚úÖ Force white background */
      margin: 0 !important;
      padding-left: 0 !important;
      padding-right: 0 !important;
    }
    
    html {
      background: #fff !important; /* ‚úÖ Force white background */
      margin: 0 !important;
      padding: 0 !important;
    }
    
    /* ‚úÖ OVERRIDE ANY CONTAINER BORDERS */
    *, *::before, *::after {
      border-left: none !important;
      border-right: none !important;
      outline: none !important;
    }
    
    /* ‚úÖ SPECIFIC OVERRIDE FOR EXTERNAL TEMPLATE */
    .container, .main-container, .app-container {
      border: none !important;
      box-shadow: none !important;
      margin: 0 !important;
      padding-left: 0 !important;
      padding-right: 0 !important;
      max-width: none !important;
      width: 100vw !important;
    }

    /* ‚úÖ POPUP X√ÅC NH·∫¨N DOWNLOAD */
    .download-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .popup-content {
      background: white;
      padding: 30px 25px;
      border-radius: 15px;
      text-align: center;
      max-width: 320px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .popup-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }

    .popup-subtitle {
      color: #b71c1c;
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 25px;
    }

    .popup-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .popup-btn {
      padding: 12px 30px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid #b71c1c;
    }

    .popup-btn-cancel {
      background: white;
      color: #b71c1c;
    }

    .popup-btn-confirm {
      background: #b71c1c;
      color: white;
    }

    .popup-btn:hover {
      transform: translateY(-2px);
    }

    /* ‚úÖ LOADING STATE */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9998;
    }

    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #b71c1c;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      color: #b71c1c;
      font-weight: 600;
    }
  </style>
</head>

<body>
  <div class="phone-frame">
    <header class="header" style="background-color: #b71c1c; color: white; height: 100px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding-top: max(12px, env(safe-area-inset-top));">
        <i class="fas fa-arrow-left" onclick="window.location.href='index.html'" style="font-size: 20px; cursor: pointer;"></i>
        <div class="header-title" style="font-size: 20px; font-weight: 500; text-align: center; flex: 1;">Tra c·ª©u ch·ª©ng t·ª´</div>
        <i class="fas fa-house" onclick="window.location.href='index.html'" style="font-size: 20px; cursor: pointer; visibility: hidden;"></i>
    </header>

    <main class="content" style="padding-top: 100px;">
      <!-- Search Form -->
      <form id="searchForm">
        <div class="form-group">
          <label for="fromDate">T·ª´ ng√†y <span class="required">*</span></label>
          <input type="date" id="fromDate" class="form-input">
        </div>

        <div class="form-group">
          <label for="toDate">ƒê·∫øn ng√†y <span class="required">*</span></label>
          <input type="date" id="toDate" class="form-input">
        </div>

        <div class="form-group">
          <label for="refNumber">M√£ tham chi·∫øu</label>
          <input type="text" id="refNumber" class="form-input" placeholder="Nh·∫≠p m√£ tham chi·∫øu">
        </div>

        <button type="button" class="btn-search" onclick="searchDocuments()">
          Tra c·ª©u
        </button>
      </form>

      <!-- Results Table -->
      <div class="result-table" id="resultsTable" style="display: none;">
        <h3 style="color: #b71c1c; margin-bottom: 15px; text-align: center;" id="resultsTitle">üìÑ K·∫øt qu·∫£ tra c·ª©u</h3>
        <table>
          <thead>
            <tr>
              <th>M√£<br>tham<br>chi·∫øu</th>
              <th>S·ªë ti·ªÅn</th>
              <th>Ng√†y n·ªôp</th>
              <th>Tr·∫°ng<br>th√°i</th>
              <th>In<br>ch·ª©ng<br>t·ª´</th>
            </tr>
          </thead>
          <tbody id="resultsBody">
          </tbody>
        </table>
      </div>

      <!-- Loading State -->
      <div class="loading-overlay" id="loadingState" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text">ƒêang t√¨m ki·∫øm ch·ª©ng t·ª´...</div>
      </div>

      <!-- Empty State -->
      <div style="display: none; text-align: center; padding: 40px; color: #999;" id="emptyState">
        <div style="font-size: 48px; margin-bottom: 15px;">üìÑ</div>
        <h3>Kh√¥ng t√¨m th·∫•y ch·ª©ng t·ª´</h3>
        <p>Kh√¥ng c√≥ ch·ª©ng t·ª´ n√†o trong kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn.</p>
      </div>

      <button type="button" class="btn-print" onclick="printAllDocuments()" id="printAllBtn" style="display: none;">
        In ch·ª©ng t·ª´
      </button>
    </main>
  </div>

  <!-- Popup x√°c nh·∫≠n download -->
  <div class="download-popup" id="downloadPopup" style="display: none;">
    <div class="popup-content">
      <div class="popup-title">B·∫°n c√≥ mu·ªën t·∫£i t·∫≠p tin?</div>
      <div class="popup-subtitle">T·∫£i ngay!</div>
      <div class="popup-buttons">
        <button class="popup-btn popup-btn-cancel" onclick="cancelDownload()">B·ªè qua</button>
        <button class="popup-btn popup-btn-confirm" onclick="confirmDownload()">ƒê·ªìng √Ω</button>
      </div>
    </div>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD_rJgBFgBulheVenQUE2KXr4PBpSpTCxw",
      authDomain: "etax-7fbf8.firebaseapp.com",
      databaseURL: "https://etax-7fbf8-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "etax-7fbf8",
      storageBucket: "etax-7fbf8.appspot.com",
      messagingSenderId: "1030026724634",
      appId: "1:1030026724634:web:d76f5f9dad43bad6fd58a3",
      measurementId: "G-YS5DLECJE6"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUserMST = null;
    let searchResults = [];
    let pendingDownloadId = null;

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üìÑ Document Search page loaded');
      
      // Get current user MST
      getCurrentUserMST();
      
      // Set default date range (1 year)
      setDefaultDateRange();
      
      // Setup date validation
      setupDateValidation();
    });

    function getCurrentUserMST() {
      // Get from session or URL parameter
      const urlParams = new URLSearchParams(window.location.search);
      const mstParam = urlParams.get('mst');
      
      if (mstParam) {
        currentUserMST = mstParam;
      } else {
        // Try to get from localStorage or session
        const session = localStorage.getItem('etax_user_session');
        if (session) {
          try {
            const sessionData = JSON.parse(session);
            currentUserMST = sessionData.mst;
          } catch (error) {
            console.error('Error parsing user session:', error);
          }
        }
      }
      
      if (!currentUserMST) {
        // Default MST for demo
        currentUserMST = '001095026798';
      }
      
      console.log('üìä Current user MST:', currentUserMST);
    }

    function setDefaultDateRange() {
      // L·∫•y ng√†y hi·ªán t·∫°i theo m√∫i gi·ªù Vi·ªát Nam (UTC+7)
      const now = new Date();
      console.log('‚è∞ Current local time:', now);
      
      // Chuy·ªÉn ƒë·ªïi sang m√∫i gi·ªù Vi·ªát Nam
      const vietnamTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Ho_Chi_Minh"}));
      console.log('üáªüá≥ Vietnam time:', vietnamTime);
      
      // Format th√†nh YYYY-MM-DD cho input date
      const year = vietnamTime.getFullYear();
      const month = String(vietnamTime.getMonth() + 1).padStart(2, '0');  
      const day = String(vietnamTime.getDate()).padStart(2, '0');
      const today = `${year}-${month}-${day}`;
      
      console.log('üìÖ Formatted today:', today);
      
      // M·∫∑c ƒë·ªãnh c·∫£ 2 √¥ ƒë·ªÅu l√† ng√†y hi·ªán t·∫°i Vi·ªát Nam
      document.getElementById('fromDate').value = today;
      document.getElementById('toDate').value = today;
      
      console.log('‚úÖ Default date set to Vietnam time:', today);
    }

    function setupDateValidation() {
      const fromDate = document.getElementById('fromDate');
      const toDate = document.getElementById('toDate');
      
      // L·∫•y ng√†y hi·ªán t·∫°i Vi·ªát Nam
      const now = new Date();
      const vietnamOffset = 7 * 60;
      const vietnamTime = new Date(now.getTime() + (vietnamOffset - now.getTimezoneOffset()) * 60000);
      const today = vietnamTime.toISOString().split('T')[0];
      
      // T√≠nh ng√†y 2 nƒÉm tr∆∞·ªõc
      const twoYearsAgo = new Date(vietnamTime);
      twoYearsAgo.setFullYear(vietnamTime.getFullYear() - 2);
      const minDate = twoYearsAgo.toISOString().split('T')[0];
      
      // C√†i ƒë·∫∑t gi·ªõi h·∫°n cho fromDate (cho ph√©p s·ª≠a trong ph·∫°m vi 2 nƒÉm)
      fromDate.max = today;
      fromDate.min = minDate;
      
      // C√†i ƒë·∫∑t toDate (KH√îNG cho s·ª≠a - readonly)
      toDate.max = today;
      toDate.min = today;
      toDate.readOnly = true;
      toDate.style.backgroundColor = '#f5f5f5';
      toDate.style.cursor = 'not-allowed';
      
      fromDate.addEventListener('change', validateDateRange);
      
      console.log('üìÖ Date validation setup:', { today, minDate });
    }

    function validateDateRange() {
      const fromDateValue = document.getElementById('fromDate').value;
      const toDateValue = document.getElementById('toDate').value;
      
      if (!fromDateValue || !toDateValue) return true;
      
      const fromDate = new Date(fromDateValue);
      const toDate = new Date(toDateValue);
      
      // L·∫•y ng√†y hi·ªán t·∫°i Vi·ªát Nam
      const now = new Date();
      const vietnamOffset = 7 * 60;
      const vietnamTime = new Date(now.getTime() + (vietnamOffset - now.getTimezoneOffset()) * 60000);
      
      const today = new Date(vietnamTime.toISOString().split('T')[0]);
      const twoYearsAgo = new Date(vietnamTime);
      twoYearsAgo.setFullYear(vietnamTime.getFullYear() - 2);
      
      if (fromDate > toDate) {
        alert('‚ùå Ng√†y b·∫Øt ƒë·∫ßu kh√¥ng th·ªÉ l·ªõn h∆°n ng√†y k·∫øt th√∫c');
        return false;
      }
      
      const diffTime = Math.abs(toDate - fromDate);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays > (365 * 2)) { // Approx 2 years
        alert('‚ùå Kho·∫£ng th·ªùi gian tra c·ª©u kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 2 nƒÉm');
        return false;
      }
      
      if (fromDate < twoYearsAgo || toDate > today) {
        alert('‚ùå Th·ªùi gian tra c·ª©u ch·ªâ ƒë∆∞·ª£c ph√©p trong v√≤ng 2 nƒÉm g·∫ßn nh·∫•t');
        return false;
      }
      
      return true;
    }

    async function searchDocuments() {
      if (!validateDateRange()) return;
      if (!currentUserMST) {
        alert('‚ùå Kh√¥ng t√¨m th·∫•y th√¥ng tin MST ng∆∞·ªùi d√πng');
        return;
      }
      
      const fromDate = new Date(document.getElementById('fromDate').value);
      const toDate = new Date(document.getElementById('toDate').value);
      
      // Show loading
      showLoading();
      
      try {
        console.log('üîç Searching documents for MST:', currentUserMST);
        
        // NEW: Get certificates assigned to this user (from admin-pdf.html)
        const userCertificatesRef = db.ref('userCertificates/' + currentUserMST);
        const userCertificatesSnapshot = await userCertificatesRef.once('value');
        const userCertificates = userCertificatesSnapshot.val() || {};
        
        console.log('üìã User Certificates found:', Object.keys(userCertificates).length);
        console.log('üìã Raw userCertificates data:', userCertificates);
        
        const documents = [];
        
        // Method 1: Load from certificates (NEW - from admin-pdf.html)
        for (const [certId, assignment] of Object.entries(userCertificates)) {
          try {
            console.log('üîç Loading certificate:', certId);
            const certSnapshot = await db.ref('certificates/' + certId).once('value');
            const certData = certSnapshot.val();
            
            console.log('üìã Certificate data:', certData);
            
            if (certData) {
              // Parse payment date from certificate
              let paymentDate = null;
              if (certData.paymentDate) {
                const dateStr = certData.paymentDate;
                console.log('üîç Parsing date:', dateStr);
                const dateParts = dateStr.split(/[\/\-]/);
                
                if (dateParts.length === 3) {
                  const day = parseInt(dateParts[0]);
                  const month = parseInt(dateParts[1]) - 1; // Month is 0-indexed
                  const year = parseInt(dateParts[2]);
                  
                  paymentDate = new Date(year, month, day);
                  console.log('üìÖ Parsed paymentDate:', paymentDate);
                }
              }
              
              // If no payment date, use creation time
              if (!paymentDate || isNaN(paymentDate.getTime())) {
                paymentDate = new Date(certData.createdAt);
                console.log('üìÖ Using createdAt as paymentDate:', paymentDate);
              }
              
              console.log('üìä Date range check:', {
                paymentDate: paymentDate,
                fromDate: fromDate, 
                toDate: toDate,
                inRange: paymentDate >= fromDate && paymentDate <= toDate
              });
              
              // Check if payment date is within search range
              if (paymentDate >= fromDate && paymentDate <= toDate) {
                documents.push({
                  id: certId,
                  referenceNumber: certData.referenceNumber || certId.substring(5, 18),
                  amount: certData.amount || '0',
                  paymentDate: paymentDate,
                  status: certData.status || '<div>Th√†nh c√¥ng -NH<br>TGTT ƒë√£<br>tr·ª´ ti·ªÅn th√†nh<br>c√¥ng</div>',
                  pdfLink: certData.pdfLink || 'PDFForm/unknown.pdf',
                  extractedData: {
                    referenceNumber: certData.referenceNumber,
                    amount: certData.amount,
                    paymentDate: certData.paymentDate
                  }
                });
              }
            }
          } catch (error) {
            console.error('Error loading certificate details:', error);
          }
        }
        
        // Method 2: Fallback to old method (customerPDFs ‚Üí pdfDocuments)
        if (documents.length === 0) {
          console.log('üìÑ No certificates found, trying customerPDFs...');
          
          const customerPDFsRef = db.ref('customerPDFs/' + currentUserMST);
          const customerPDFsSnapshot = await customerPDFsRef.once('value');
          const customerPDFs = customerPDFsSnapshot.val() || {};
          
          console.log('üìÑ CustomerPDFs found:', Object.keys(customerPDFs).length);
          console.log('üìÑ Raw customerPDFs data:', customerPDFs);
          
          for (const [pdfId, assignment] of Object.entries(customerPDFs)) {
            try {
              console.log('üîç Loading PDF:', pdfId);
              const pdfSnapshot = await db.ref('pdfDocuments/' + pdfId).once('value');
              const pdfData = pdfSnapshot.val();
              
              console.log('üìÑ PDF data:', pdfData);
              
              if (pdfData && pdfData.extractedData) {
                // Parse payment date
                let paymentDate = null;
                if (pdfData.extractedData.paymentDate) {
                  const dateStr = pdfData.extractedData.paymentDate;
                  const dateParts = dateStr.split(/[\/\-]/);
                  
                  if (dateParts.length === 3) {
                    const day = parseInt(dateParts[0]);
                    const month = parseInt(dateParts[1]) - 1; // Month is 0-indexed
                    const year = parseInt(dateParts[2]);
                    
                    paymentDate = new Date(year, month, day);
                  }
                }
                
                // If no payment date from PDF, use upload time
                if (!paymentDate || isNaN(paymentDate.getTime())) {
                  paymentDate = new Date(pdfData.uploadTime);
                }
                
                // Check if payment date is within search range
                if (paymentDate >= fromDate && paymentDate <= toDate) {
                  documents.push({
                    id: pdfId,
                    referenceNumber: pdfData.extractedData.referenceNumber || pdfId.substring(4, 17),
                    amount: pdfData.extractedData.amount || '50,000',
                    paymentDate: paymentDate,
                    status: '<div>Th√†nh c√¥ng -NH<br>TGTT ƒë√£<br>tr·ª´ ti·ªÅn th√†nh<br>c√¥ng</div>',
                    pdfLink: `PDFForm/${pdfData.fileName}`,
                    extractedData: pdfData.extractedData
                  });
                }
              }
            } catch (error) {
              console.error('Error loading PDF details:', error);
            }
          }
        }
        
        console.log('üìä Documents in date range:', documents.length);
        
        // Sort by payment date (newest first)
        documents.sort((a, b) => b.paymentDate - a.paymentDate);
        
        searchResults = documents;
        
        if (documents.length > 0) {
          displayResults(documents);
        } else {
          showEmptyState();
        }
        
      } catch (error) {
        console.error('‚ùå Search error:', error);
        alert('‚ùå L·ªói t√¨m ki·∫øm: ' + error.message);
        hideLoading();
      }
    }

    function displayResults(documents) {
      hideLoading();
      
      const resultsTable = document.getElementById('resultsTable');
      const resultsTitle = document.getElementById('resultsTitle');
      const resultsBody = document.getElementById('resultsBody');
      const printAllBtn = document.getElementById('printAllBtn');
      
      resultsTitle.textContent = `üìÑ K·∫øt qu·∫£ tra c·ª©u (${documents.length} ch·ª©ng t·ª´)`;
      
      // Build table rows
      resultsBody.innerHTML = documents.map((doc, index) => `
        <tr>
          <td>${doc.referenceNumber}</td>
          <td style="color: #28a745; font-weight: 600;">${formatAmount(doc.amount)}</td>
          <td>${formatDate(doc.paymentDate)}</td>
          <td style="color: #28a745; font-weight: 600; font-size: 12px;">${doc.status}</td>
          <td>
            <div style="background: #b71c1c; color: white; border: none; padding: 8px; border-radius: 50%; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; margin: 0 auto;" onclick="printDocument('${doc.id}')" title="In ch·ª©ng t·ª´: ${doc.pdfLink || 'N/A'}">
              ‚≠ï
            </div>
          </td>
        </tr>
      `).join('');
      
      // Show results
      resultsTable.style.display = 'block';
      printAllBtn.style.display = 'block';
    }

    function formatDate(date) {
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      
      return `${day}/${month}/${year}`;
    }
    
    function formatAmount(amount) {
      if (!amount) return '0';
      // Remove any existing formatting and convert to number
      const numAmount = parseFloat(amount.toString().replace(/[,\.]/g, ''));
      if (isNaN(numAmount)) return amount;
      
      // Format with comma thousands separator
      return numAmount.toLocaleString('vi-VN');
    }

    function showLoading() {
      document.getElementById('loadingState').style.display = 'flex';
      document.getElementById('resultsTable').style.display = 'none';
      document.getElementById('emptyState').style.display = 'none';
    }

    function hideLoading() {
      document.getElementById('loadingState').style.display = 'none';
    }

    function showEmptyState() {
      hideLoading();
      document.getElementById('emptyState').style.display = 'block';
      document.getElementById('resultsTable').style.display = 'none';
    }

    // Print functionality v·ªõi popup x√°c nh·∫≠n
    function printDocument(documentId) {
      console.log('üñ®Ô∏è Print document requested:', documentId);
      pendingDownloadId = documentId;
      document.getElementById('downloadPopup').style.display = 'flex';
    }

    function cancelDownload() {
      document.getElementById('downloadPopup').style.display = 'none';
      pendingDownloadId = null;
    }

    async function confirmDownload() {
      document.getElementById('downloadPopup').style.display = 'none';
      
      if (!pendingDownloadId) return;
      
      try {
        console.log('üì• Downloading document:', pendingDownloadId);
        
        // Get document data
        const pdfSnapshot = await db.ref('pdfDocuments/' + pendingDownloadId).once('value');
        const pdfData = pdfSnapshot.val();
        
        if (!pdfData) {
          alert('‚ùå Kh√¥ng t√¨m th·∫•y ch·ª©ng t·ª´');
          return;
        }
        
        // Generate PDF content
        const pdfContent = generateAdvancedPDF(pdfData);
        
        // Create blob
        const blob = new Blob([pdfContent], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        
        // Mobile device detection
        const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        
        console.log('üì± Device detection:', { isMobile, isIOS });
        
        // Use window.open for native PDF viewer (as requested)
        const fileName = pdfData.fileName || `ChungTu_${pendingDownloadId.substring(4, 12)}.pdf`;
        
        // Open PDF in new tab/window (triggers native viewer)
        const newWindow = window.open(url, '_blank', 'noopener,noreferrer');
        
        if (newWindow) {
          console.log('‚úÖ PDF opened in native viewer');
          setTimeout(() => URL.revokeObjectURL(url), 3000);
        } else {
          // Fallback to download if popup blocked
          const link = document.createElement('a');
          link.href = url;
          link.download = fileName;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          setTimeout(() => URL.revokeObjectURL(url), 1000);
        }
        
        pendingDownloadId = null;
        
      } catch (error) {
        console.error('‚ùå Download error:', error);
        alert('‚ùå L·ªói t·∫£i ch·ª©ng t·ª´: ' + error.message);
      }
    }

    function generateAdvancedPDF(pdfData) {
      // Generate enhanced PDF content with Vietnamese tax receipt format
      const extractedData = pdfData.extractedData || {};
      const timestamp = new Date().toLocaleString('vi-VN');
      
      const content = `%PDF-1.4
1 0 obj
<<
/Type /Catalog
/Pages 2 0 R
>>
endobj

2 0 obj
<<
/Type /Pages
/Kids [3 0 R]
/Count 1
>>
endobj

3 0 obj
<<
/Type /Page
/Parent 2 0 R
/MediaBox [0 0 612 792]
/Contents 4 0 R
/Resources <<
/Font <<
/F1 5 0 R
/F2 6 0 R
>>
>>
>>
endobj

4 0 obj
<<
/Length 1200
>>
stream
BT
/F2 16 Tf
50 750 Td
(C·ªòNG H√íA X√É H·ªòI CH·ª¶ NGHƒ®A VI·ªÜT NAM) Tj
0 -20 Td
(ƒê·ªôc l·∫≠p - T·ª± do - H·∫°nh ph√∫c) Tj
0 -40 Td
/F1 18 Tf
150 0 Td
(GI·∫§Y N·ªòP TI·ªÄN V√ÄO NG√ÇN S√ÅCH NH√Ä N∆Ø·ªöC) Tj
-150 -60 Td
/F1 12 Tf
(M√£ s·ªë thu·∫ø: ${extractedData.mst || currentUserMST || '001095026798'}) Tj
0 -25 Td
(T√™n ng∆∞·ªùi n·ªôp: ${extractedData.name || 'C√îNG TY TNHH ABC'}) Tj
0 -25 Td
(ƒê·ªãa ch·ªâ: ${extractedData.address || 'Ph∆∞·ªùng Vƒ©nh Tuy, Hai B√† Tr∆∞ng, H√† N·ªôi'}) Tj
0 -40 Td
/F2 14 Tf
(TH√îNG TIN N·ªòP THU·∫æ) Tj
0 -30 Td
/F1 12 Tf
(Lo·∫°i thu·∫ø: ${extractedData.taxType || 'Thu t·ª´ ƒë·∫•t ·ªü t·∫°i ƒë√¥ th·ªã'}) Tj
0 -20 Td
(S·ªë ti·ªÅn: ${extractedData.amount || '519,042'} VND) Tj
0 -20 Td
(Ng√†y n·ªôp: ${extractedData.paymentDate || '09/03/2025'}) Tj
0 -20 Td
(M√£ tham chi·∫øu: ${extractedData.referenceNumber || 'RF' + Date.now().toString().substring(8)}) Tj
0 -40 Td
(Tr·∫°ng th√°i: ƒê√É N·ªòP TH√ÄNH C√îNG) Tj
0 -15 Td
(Th·ªùi gian t·∫°o ch·ª©ng t·ª´: ${timestamp}) Tj
0 -15 Td
(Ngu·ªìn: eTax Mobile System - Ch·ª©ng t·ª´ ƒëi·ªán t·ª≠) Tj
ET
endstream
endobj

5 0 obj
<<
/Type /Font
/Subtype /Type1
/BaseFont /Helvetica
>>
endobj

6 0 obj
<<
/Type /Font
/Subtype /Type1
/BaseFont /Helvetica-Bold
>>
endobj

xref
0 7
0000000000 65535 f 
0000000010 00000 n 
0000000068 00000 n 
0000000125 00000 n 
0000000284 00000 n 
0000001536 00000 n 
0000001593 00000 n 
trailer
<<
/Size 7
/Root 1 0 R
>>
startxref
1657
%%EOF`;
      
      return content;
    }

    async function printAllDocuments() {
      if (searchResults.length === 0) {
        alert('‚ùå Kh√¥ng c√≥ ch·ª©ng t·ª´ n√†o ƒë·ªÉ in');
        return;
      }
      
      if (!confirm(`B·∫°n mu·ªën in t·∫•t c·∫£ ${searchResults.length} ch·ª©ng t·ª´ kh√¥ng?`)) {
        return;
      }
      
      try {
        // Download all documents
        for (let i = 0; i < searchResults.length; i++) {
          await new Promise(resolve => {
            pendingDownloadId = searchResults[i].id;
            confirmDownload().then(resolve);
          });
          
          // Small delay between downloads
          if (i < searchResults.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 1000));
          }
        }
        
        alert('‚úÖ ƒê√£ t·∫£i xu·ªëng t·∫•t c·∫£ ch·ª©ng t·ª´');
        
      } catch (error) {
        console.error('‚ùå Print all error:', error);
        alert('‚ùå L·ªói in ch·ª©ng t·ª´: ' + error.message);
      }
    }

    // ‚úÖ PWA Navigation Functions
    function goBack() {
      if (window.history.length > 1) {
        window.history.back();
      } else {
        window.location.href = 'index.html';
      }
    }

    function goHome() {
      window.location.href = 'index.html';
    }

    // ‚úÖ PWA Performance
    if ('serviceWorker' in navigator && window.location.protocol !== 'file:') {
      navigator.serviceWorker.register('service-worker.js').catch(console.error);
    }
  </script>
</body>
</html>