<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>eTax Mobile - Tra cứu nghĩa vụ thuế</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
    body, html { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background-color: #f4f4f9; }
    .header {
        background-color: #b71c1c; color: white; padding: 15px 20px;
        display: flex; align-items: center; justify-content: space-between;
        position: sticky; top: 0; z-index: 1000;
    }
    .header-title { font-size: 18px; font-weight: 500; }
    .content-area { padding: 20px; }
    .tax-item {
        background: white; border-radius: 12px; margin-bottom: 15px;
        padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: flex; align-items: center; justify-content: space-between;
    }
    .tax-info h4 { margin: 0 0 5px 0; font-size: 16px; color: #333; }
    .tax-info p { margin: 0; font-size: 14px; color: #666; }
    .details-btn {
        width: 30px; height: 30px; background: #dc3545; color: white;
        border-radius: 50%; border: none; cursor: pointer; font-weight: bold;
    }
    .modal { /* Styles for the popup */
        display: none; position: fixed; z-index: 2000; left: 0; top: 0;
        width: 100%; height: 100%; background-color: rgba(0,0,0,0.6);
    }
    .modal-content {
        background-color: #fefefe; margin: 15% auto; padding: 20px;
        border-radius: 15px; width: 90%; max-width: 500px;
    }
    .modal-header { padding-bottom: 10px; border-bottom: 1px solid #eee; margin-bottom: 15px; }
    .modal-title { font-size: 20px; color: #b71c1c; }
    .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .modal-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
</style>
</head>
<body>

<header class="header">
    <i class="fas fa-arrow-left" onclick="window.location.href='index.html'"></i>
    <div class="header-title">Tra cứu nghĩa vụ thuế</div>
    <i class="fas fa-house" onclick="window.location.href='index.html'" style="visibility: hidden;"></i>
</header>

<div class="content-area" id="nghiaVuListContainer">
    <!-- Tax obligations will be loaded here -->
</div>

<!-- The Modal -->
<div id="detailsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <span class="close-btn">&times;</span>
      <h2 class="modal-title">Chi tiết khoản phải nộp</h2>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD_rJgBFgBulheVenQUE2KXr4PBpSpTCxw",
        authDomain: "etax-7fbf8.firebaseapp.com",
        databaseURL: "https://etax-7fbf8-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "etax-7fbf8",
        storageBucket: "etax-7fbf8.appspot.com",
        messagingSenderId: "1030026724634",
        appId: "1:1030026724634:web:d76f5f9dad43bad6fd58a3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    document.addEventListener('DOMContentLoaded', function() {
        const loggedInMST = localStorage.getItem('etax_logged_in_user');
        if (!loggedInMST) {
            window.location.href = 'login.html';
            return;
        }
        loadNghiaVuThue(loggedInMST);
        setupModal();
    });

    async function loadNghiaVuThue(mst) {
        const container = document.getElementById('nghiaVuListContainer');
        container.innerHTML = '<p>Đang tải dữ liệu...</p>';

        try {
            const snapshot = await db.ref('userTaxObligations/' + mst).once('value');
            const obligations = snapshot.val();

            if (!obligations) {
                container.innerHTML = '<p>Không có nghĩa vụ thuế nào được tìm thấy.</p>';
                return;
            }

            container.innerHTML = ''; // Clear loading message
            Object.keys(obligations).forEach(key => {
                const ob = obligations[key];
                const item = document.createElement('div');
                item.className = 'tax-item';
                item.innerHTML = `
                    <div class="tax-info">
                        <h4>${ob.doiThue || 'N/A'}</h4>
                        <p>${ob.loaiNV || 'N/A'} - ${ob.soTien || '0'} VND</p>
                    </div>
                    <button class="details-btn" data-key="${key}">✓</button>
                `;
                container.appendChild(item);
            });

            // Add event listeners to buttons
            document.querySelectorAll('.details-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const key = this.getAttribute('data-key');
                    showDetailsPopup(obligations[key]);
                });
            });

        } catch (error) {
            console.error("Error loading tax obligations:", error);
            container.innerHTML = '<p>Lỗi khi tải dữ liệu. Vui lòng thử lại.</p>';
        }
    }

    function showDetailsPopup(data) {
        const modalBody = document.getElementById('modalBody');
        const soTien = parseFloat(data.soTien) || 0;
        const daNop = parseFloat(data.daNop) || 0;
        const loaiNghiaVu = soTien > daNop ? '<div style="color: red;">Còn phải nộp</div>' : '<div style="color: green;">Đã nộp</div>';

        modalBody.innerHTML = `
            <div class="modal-row"><span>Thứ tự thanh toán</span><span>${data.thuTu}</span></div>
            <div class="modal-row"><span>ID khoản phải nộp</span><span>${data.idKhoan}</span></div>
            <div class="modal-row"><span>Số quyết định/ Số<br>thông báo</span><span>${data.soQDTB}</span></div>
            <div class="modal-row"><span>Ngày quyết định/<br>Ngày thông báo</span><span>${data.ngayQD}</span></div>
            <div class="modal-row"><span>Tên cơ quan thu</span><span>${data.doiThue}</span></div>
            <div class="modal-row"><span>Chương</span><span>${data.chuong}</span></div>
            <div class="modal-row"><span>Kỳ thuế</span><span>${data.ky}</span></div>
            <div class="modal-row"><span>Địa bàn hành chính</span><span>${data.diaBan}</span></div>
            <div class="modal-row"><span>Hạn nộp</span><span>${data.hanNop}</span></div>
            <div class="modal-row"><span>Số tiền</span><span>${data.soTien}</span></div>
            <div class="modal-row"><span>Số tiền đã nộp</span><span>${data.daNop}</span></div>
            <div class="modal-row"><span>Loại nghĩa vụ</span><span>${loaiNghiaVu}</span></div>
            <div class="modal-row"><span>Số tham chiếu</span><span>...</span></div>
        `;

        document.getElementById('detailsModal').style.display = 'block';
    }

    function setupModal() {
        const modal = document.getElementById('detailsModal');
        const closeBtn = document.querySelector('.close-btn');
        closeBtn.onclick = () => modal.style.display = "none";
        window.onclick = (event) => {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    }

    // ✅ PWA LOCK SETTINGS
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(e) {
        const now = Date.now();
        if (now - lastTouchEnd <= 300) e.preventDefault();
        lastTouchEnd = now;
    }, false);
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('touchstart', function(e) {
        if (e.touches.length > 1) e.preventDefault();
    });
    document.addEventListener('dragstart', e => e.preventDefault());

</script>

</body>
</html>