<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚úèÔ∏è T·∫°o N·ªôi dung - eTAX ADMIN</title>
  
  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
a  <!-- üí° T·ªëi ∆∞u h√≥a: T·∫£i c·∫•u h√¨nh Firebase t·ª´ t·ªáp chung -->
  <script src="./firebase-config.js"></script>
  
  <!-- CKEditor -->
  <script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', 'Tahoma', 'Microsoft Sans Serif', 'Arial', sans-serif;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    .admin-header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .admin-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 20px;
      font-weight: 700;
      color: #dc3545;
    }

    .back-btn {
      background: #6c757d;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      transition: background 0.3s;
    }

    .back-btn:hover {
      background: #545b62;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    .content-header {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .content-title {
      font-size: 24px;
      color: #333;
      margin-bottom: 15px;
    }

    .tabs {
      display: flex;
      background: #f8f9fa;
      border-radius: 10px;
      padding: 5px;
      margin-bottom: 25px;
    }

    .tab-btn {
      flex: 1;
      padding: 12px 20px;
      border: none;
      background: transparent;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      color: #666;
      transition: all 0.3s;
    }

    .tab-btn.active,
    .tab-btn:hover {
      background: white;
      color: #333;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .main-layout {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 30px;
    }

    .editor-section {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .preview-section {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .card-title {
      color: #b71c1c;
      margin-bottom: 15px;
      font-size: 16px;
      font-weight: 600;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: #007bff;
    }

    .form-row {
      display: flex;
      gap: 15px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
      margin-right: 10px;
    }

    .btn-primary {
      background: #007bff;
      color: white;
    }

    .btn-primary:hover {
      background: #0056b3;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #1e7e34;
    }

    .btn-warning {
      background: #ffc107;
      color: #333;
    }

    .btn-warning:hover {
      background: #e0a800;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      margin-right: 8px;
    }

    /* Mobile Preview Frame */
    .mobile-preview {
      background: #333;
      border-radius: 25px;
      padding: 20px 15px;
      position: relative;
    }

    .mobile-screen {
      background: white;
      border-radius: 15px;
      overflow: hidden;
      position: relative;
      width: 100%;
      min-height: 400px;
    }

    .mobile-header {
      background: #b71c1c;
      color: white;
      padding: 15px;
      text-align: center;
      font-weight: 600;
    }

    .mobile-content {
      padding: 20px;
      min-height: 300px;
      font-size: 14px;
      line-height: 1.6;
    }

    .notification-item {
      background: #f8f9fa;
      border-left: 4px solid #007bff;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
    }

    .notification-item.general {
      border-left-color: #dc3545;
    }

    .notification-item.personal {
      border-left-color: #28a745;
    }

    .notification-date {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
    }

    .notification-title {
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }

    .notification-content {
      color: #666;
      font-size: 13px;
    }

    .template-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }

    .template-btn {
      background: #f8f9fa;
      border: 2px solid #e0e0e0;
      padding: 15px;
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s;
    }

    .template-btn:hover {
      border-color: #007bff;
      background: #e3f2fd;
    }

    .template-btn.active {
      border-color: #007bff;
      background: #e3f2fd;
    }

    .ck-editor__editable {
      min-height: 300px !important;
    }

    @media (max-width: 1200px) {
      .main-layout {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .preview-section {
        order: -1;
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px 15px;
      }
      
      .form-row {
        flex-direction: column;
      }
      
      .template-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="admin-header">
    <div class="admin-logo">
      ‚úèÔ∏è T·∫°o N·ªôi dung Th√¥ng b√°o
    </div>
    <a href="admin-dashboard.html" class="back-btn">‚Üê V·ªÅ Dashboard</a>
  </div>

  <div class="container">
    <!-- Header -->
    <div class="content-header">
      <h2 class="content-title">‚úèÔ∏è T·∫†O N·ªòI DUNG TH√îNG B√ÅO REALTIME</h2>
      
      <div class="tabs">
        <button class="tab-btn active" onclick="showTab('create')">
          üìù T·∫°o th√¥ng b√°o m·ªõi
        </button>
        <button class="tab-btn" onclick="showTab('manage')">
          üìã Qu·∫£n l√Ω th√¥ng b√°o
        </button>
        <button class="tab-btn" onclick="showTab('auto')">
          ü§ñ Th√¥ng b√°o t·ª± ƒë·ªông
        </button>
      </div>
    </div>

    <!-- Main Layout -->
    <div class="main-layout">
      <!-- Editor Section -->
      <div class="editor-section">
        <div id="tabContent">
          <!-- Content will be loaded here -->
        </div>
      </div>

      <!-- Preview Section -->
      <div class="preview-section">
        <!-- Mobile Preview -->
        <div class="card">
          <h4 class="card-title">üì± Preview Mobile</h4>
          <div class="mobile-preview">
            <div class="mobile-screen">
              <div class="mobile-header">
                üîî Th√¥ng b√°o - eTax Mobile
              </div>
              <div class="mobile-content" id="mobilePreview">
                <div style="text-align: center; color: #999; padding: 40px 20px;">
                  üìù N·ªôi dung th√¥ng b√°o s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="card">
          <h4 class="card-title">üìä Th·ªëng k√™ nhanh</h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center;">
            <div>
              <div style="font-size: 24px; font-weight: 700; color: #007bff;" id="totalNotifications">0</div>
              <div style="font-size: 12px; color: #666;">T·ªïng th√¥ng b√°o</div>
            </div>
            <div>
              <div style="font-size: 24px; font-weight: 700; color: #28a745;" id="activeNotifications">0</div>
              <div style="font-size: 12px; color: #666;">ƒêang hi·ªÉn th·ªã</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let editor = null;
    let currentNotificationType = 'general';
    let allUsers = [];
    let allNotifications = [];

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      console.log('‚úèÔ∏è Content Creator page loaded');
      initializePage();
    });

    async function initializePage() {
      try {
        // Load users for personal notifications
        await loadUsers();
        
        // Load existing notifications for stats
        await loadNotifications();
        
        // Show default tab
        showTab('create');
        
        console.log('‚úÖ Content Creator initialized');
        
      } catch (error) {
        console.error('‚ùå Error initializing page:', error);
      }
    }

    // Load users
    async function loadUsers() {
      try {
        const usersSnapshot = await db.ref('users').once('value');
        const users = usersSnapshot.val() || {};
        
        allUsers = Object.entries(users).map(([mst, user]) => ({
          mst,
          name: `${user.lastName || ''} ${user.firstName || user.fullName || ''}`.trim(),
          companyName: user.companyName || ''
        }));
        
        console.log('‚úÖ Users loaded:', allUsers.length);
        
      } catch (error) {
        console.error('‚ùå Error loading users:', error);
      }
    }

    // Load notifications for stats
    async function loadNotifications() {
      try {
        const notificationsSnapshot = await db.ref('notifications').once('value');
        const notifications = notificationsSnapshot.val() || {};
        
        allNotifications = Object.entries(notifications).map(([id, notif]) => ({ id, ...notif }));
        
        // Update stats
        const total = allNotifications.length;
        const active = allNotifications.filter(n => n.status === 'active').length;
        
        document.getElementById('totalNotifications').textContent = total;
        document.getElementById('activeNotifications').textContent = active;
        
        console.log('‚úÖ Notifications loaded:', total);
        
      } catch (error) {
        console.error('‚ùå Error loading notifications:', error);
      }
    }

    // Show tab
    function showTab(tabType) {
      // Update tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      const tabContent = document.getElementById('tabContent');
      
      if (tabType === 'create') {
        showCreateTab();
      } else if (tabType === 'manage') {
        showManageTab();
      } else if (tabType === 'auto') {
        showAutoTab();
      }
    }

    // Show create tab
    function showCreateTab() {
      const tabContent = document.getElementById('tabContent');
      
      tabContent.innerHTML = `
        <h3 style="color: #b71c1c; margin-bottom: 20px;">üìù T·∫°o Th√¥ng b√°o M·ªõi</h3>
        
        <!-- Notification Type -->
        <div class="form-group">
          <label class="form-label">üì± Lo·∫°i th√¥ng b√°o:</label>
          <div class="template-grid">
            <div class="template-btn active" onclick="selectNotificationType('general')">
              <div style="font-size: 24px; margin-bottom: 8px;">üì¢</div>
              <div style="font-weight: 600;">Th√¥ng b√°o chung</div>
              <div style="font-size: 12px; color: #666;">Cho t·∫•t c·∫£ user</div>
            </div>
            
          </div>
        </div>

        

        <!-- Basic Info -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">üìã Ti√™u ƒë·ªÅ th√¥ng b√°o:</label>
            <input type="text" class="form-input" id="notificationTitle" placeholder="Nh·∫≠p ti√™u ƒë·ªÅ..." onkeyup="updatePreview()">
          </div>
          <div class="form-group">
            <label class="form-label">‚≠ê M·ª©c ƒë·ªô ∆∞u ti√™n:</label>
            <select class="form-select" id="notificationPriority" onchange="updatePreview()">
              <option value="normal">üîµ B√¨nh th∆∞·ªùng</option>
              <option value="important">üü° Quan tr·ªçng</option>
              <option value="urgent">üî¥ Kh·∫©n c·∫•p</option>
            </select>
          </div>
        </div>

        <!-- Content Templates -->
        <div class="form-group">
          <label class="form-label">üìÑ Template nhanh:</label>
          <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
            <button class="btn btn-primary btn-small" onclick="insertTemplate('maintenance')">
              üîß B·∫£o tr√¨ h·ªá th·ªëng
            </button>
            <button class="btn btn-success btn-small" onclick="insertTemplate('tax_reminder')">
              üìÖ Nh·∫Øc n·ªôp thu·∫ø
            </button>
            <button class="btn btn-warning btn-small" onclick="insertTemplate('policy')">
              üìú Ch√≠nh s√°ch m·ªõi
            </button>
            <button class="btn btn-danger btn-small" onclick="insertTemplate('security')">
              üîí C·∫£nh b√°o b·∫£o m·∫≠t
            </button>
          </div>
        </div>

        <!-- Rich Text Editor -->
        <div class="form-group">
          <label class="form-label">‚úèÔ∏è N·ªôi dung th√¥ng b√°o:</label>
          <textarea id="contentEditor" class="form-textarea" rows="10" placeholder="Nh·∫≠p n·ªôi dung th√¥ng b√°o..." onkeyup="updatePreview()"></textarea>
        </div>

        <!-- Scheduling -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">üìÖ Ng√†y hi·ªÉn th·ªã:</label>
            <input type="datetime-local" class="form-input" id="displayDate" value="${new Date().toISOString().slice(0, 16)}">
          </div>
          <div class="form-group">
            <label class="form-label">‚è∞ Ng√†y h·∫øt h·∫°n:</label>
            <input type="datetime-local" class="form-input" id="expireDate">
          </div>
        </div>

        <!-- Actions -->
        <div style="margin-top: 30px; display: flex; gap: 15px;">
          <button class="btn btn-warning" onclick="previewNotification()">
            üëÅÔ∏è Xem tr∆∞·ªõc
          </button>
          <button class="btn btn-primary" onclick="saveNotification()">
            üíæ L∆∞u nh√°p
          </button>
          <button class="btn btn-success" onclick="publishNotification()">
            üöÄ Xu·∫•t b·∫£n ngay
          </button>
        </div>
      `;
      
      // Initialize CKEditor for rich content
      initializeEditor();
    }

    // Show manage tab
    function showManageTab() {
      const tabContent = document.getElementById('tabContent');
      
      if (allNotifications.length === 0) {
        tabContent.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: #999;">
            <div style="font-size: 64px; margin-bottom: 20px;">üì≠</div>
            <h3>Ch∆∞a c√≥ th√¥ng b√°o n√†o</h3>
            <p>H√£y t·∫°o th√¥ng b√°o ƒë·∫ßu ti√™n b·∫±ng tab "T·∫°o th√¥ng b√°o m·ªõi"</p>
          </div>
        `;
        return;
      }
      
      const sortedNotifications = [...allNotifications].sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
      
      tabContent.innerHTML = `
        <h3 style="color: #b71c1c; margin-bottom: 20px;">üìã Qu·∫£n l√Ω Th√¥ng b√°o (${allNotifications.length})</h3>
        
        <div style="max-height: 600px; overflow-y: auto;">
          ${sortedNotifications.map(notif => `
            <div style="background: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 15px; border-left: 4px solid ${notif.type === 'general' ? '#dc3545' : '#28a745'};">
              <div style="display: flex; justify-content: between; align-items: flex-start; margin-bottom: 10px;">
                <div style="flex: 1;">
                  <div style="font-weight: 600; color: #333; margin-bottom: 5px;">
                    ${notif.type === 'general' ? 'üì¢' : 'üë§'} ${notif.title || 'Kh√¥ng c√≥ ti√™u ƒë·ªÅ'}
                  </div>
                  <div style="font-size: 12px; color: #666;">
                    ${notif.type === 'general' ? 'Th√¥ng b√°o chung' : 'Th√¥ng b√°o c√° nh√¢n'} ‚Ä¢ 
                    ${notif.createdAt ? new Date(notif.createdAt).toLocaleString('vi-VN') : 'N/A'}
                  </div>
                </div>
                <div style="display: flex; gap: 5px;">
                  <button class="btn btn-primary btn-small" onclick="editNotification('${notif.id}')">
                    ‚úèÔ∏è S·ª≠a
                  </button>
                  <button class="btn btn-danger btn-small" onclick="deleteNotification('${notif.id}')">
                    üóëÔ∏è X√≥a
                  </button>
                </div>
              </div>
              <div style="color: #666; font-size: 14px; line-height: 1.5;">
                ${(notif.content || '').substring(0, 200)}${(notif.content || '').length > 200 ? '...' : ''}
              </div>
              <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
                <span class="btn btn-small" style="background: ${notif.status === 'active' ? '#28a745' : '#6c757d'}; color: white;">
                  ${notif.status === 'active' ? '‚úÖ ƒêang hi·ªÉn th·ªã' : '‚è∏Ô∏è T·∫°m d·ª´ng'}
                </span>
                <span style="font-size: 12px; color: #666;">
                  ∆Øu ti√™n: ${notif.priority === 'urgent' ? 'üî¥ Kh·∫©n c·∫•p' : notif.priority === 'important' ? 'üü° Quan tr·ªçng' : 'üîµ B√¨nh th∆∞·ªùng'}
                </span>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // Show auto tab
    function showAutoTab() {
      const tabContent = document.getElementById('tabContent');
      
      tabContent.innerHTML = `
        <h3 style="color: #b71c1c; margin-bottom: 20px;">ü§ñ Th√¥ng b√°o T·ª± ƒë·ªông</h3>
        
        <div style="background: #e8f4fd; padding: 20px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #007bff;">
          <h4 style="color: #0056b3; margin-bottom: 10px;">üìã H·ªá th·ªëng t·ª± ƒë·ªông ho·∫°t ƒë·ªông:</h4>
          <p style="margin-bottom: 8px;">‚Ä¢ <strong>T·∫°o t√†i kho·∫£n:</strong> T·ª± ƒë·ªông g·ª≠i th√¥ng b√°o "T√†i kho·∫£n k√≠ch ho·∫°t" cho user m·ªõi</p>
          <p style="margin-bottom: 8px;">‚Ä¢ <strong>Upload PDF:</strong> T·ª± ƒë·ªông th√¥ng b√°o "ƒê√£ c√≥ t√†i li·ªáu m·ªõi" khi admin upload</p>
          <p style="margin-bottom: 8px;">‚Ä¢ <strong>Template t√πy ch·ªânh:</strong> C√≥ th·ªÉ ch·ªânh s·ª≠a n·ªôi dung m·∫´u b√™n d∆∞·ªõi</p>
        </div>

        <!-- Account Creation Template -->
        <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
          <h4 style="color: #28a745; margin-bottom: 15px;">üë§ Template: T·∫°o t√†i kho·∫£n</h4>
          <div class="form-group">
            <label class="form-label">üìã Ti√™u ƒë·ªÅ:</label>
            <input type="text" class="form-input" id="accountTemplate_title" value="üéâ T√†i kho·∫£n ƒë∆∞·ª£c k√≠ch ho·∫°t th√†nh c√¥ng!">
          </div>
          <div class="form-group">
            <label class="form-label">‚úèÔ∏è N·ªôi dung (s·ª≠ d·ª•ng {MST}, {NAME}, {DATE}):</label>
            <textarea class="form-textarea" id="accountTemplate_content" rows="4">Xin ch√†o {NAME},

T√†i kho·∫£n MST {MST} c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t th√†nh c√¥ng v√†o {DATE}.

B·∫°n c√≥ th·ªÉ ƒëƒÉng nh·∫≠p v√† s·ª≠ d·ª•ng ƒë·∫ßy ƒë·ªß c√°c t√≠nh nƒÉng c·ªßa eTax Mobile.

Tr√¢n tr·ªçng,
ƒê·ªôi ng≈© eTax Support</textarea>
          </div>
          <button class="btn btn-success" onclick="saveAutoTemplate('account')">üíæ L∆∞u template</button>
        </div>

        <!-- PDF Upload Template -->
        <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
          <h4 style="color: #007bff; margin-bottom: 15px;">üìÑ Template: Upload PDF</h4>
          <div class="form-group">
            <label class="form-label">üìã Ti√™u ƒë·ªÅ:</label>
            <input type="text" class="form-input" id="pdfTemplate_title" value="üìÑ C√≥ t√†i li·ªáu thu·∫ø m·ªõi">
          </div>
          <div class="form-group">
            <label class="form-label">‚úèÔ∏è N·ªôi dung (s·ª≠ d·ª•ng {MST}, {FILENAME}, {DATE}, {AMOUNT}):</label>
            <textarea class="form-textarea" id="pdfTemplate_content" rows="4">K√≠nh g·ª≠i kh√°ch h√†ng MST {MST},

Ch√∫ng t√¥i ƒë√£ c·∫≠p nh·∫≠t t√†i li·ªáu thu·∫ø m·ªõi cho b·∫°n:
üìÑ File: {FILENAME}
üí∞ S·ªë ti·ªÅn: {AMOUNT}
üìÖ Ng√†y c·∫≠p nh·∫≠t: {DATE}

B·∫°n c√≥ th·ªÉ tra c·ª©u v√† t·∫£i v·ªÅ t·∫°i m·ª•c "Tra c·ª©u ch·ª©ng t·ª´".

eTax Mobile Team</textarea>
          </div>
          <button class="btn btn-primary" onclick="saveAutoTemplate('pdf')">üíæ L∆∞u template</button>
        </div>

        <!-- Test Auto Notification -->
        <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 20px;">
          <h4 style="color: #856404; margin-bottom: 15px;">üß™ Test Th√¥ng b√°o T·ª± ƒë·ªông</h4>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">üë§ Ch·ªçn user test:</label>
              <select class="form-select" id="testUser">
                <option value="">-- Ch·ªçn user --</option>
                ${allUsers.map(user => 
                  `<option value="${user.mst}">${user.mst} - ${user.name || 'N/A'}</option>`
                ).join('')}
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">üé≠ Lo·∫°i test:</label>
              <select class="form-select" id="testType">
                <option value="account">üë§ K√≠ch ho·∫°t t√†i kho·∫£n</option>
                <option value="pdf">üìÑ Upload PDF</option>
              </select>
            </div>
          </div>
          <button class="btn btn-warning" onclick="testAutoNotification()">üß™ G·ª≠i th√¥ng b√°o test</button>
        </div>
      `;
      
      // Load existing templates
      loadAutoTemplates();
    }

    // Select notification type
    function selectNotificationType(type) {
      currentNotificationType = type;
      
      // Update template buttons
      document.querySelectorAll('.template-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      updatePreview();
    }

    // Insert template
    function insertTemplate(templateType) {
      const editor = document.getElementById('contentEditor');
      let content = '';
      
      switch (templateType) {
        case 'maintenance':
          content = `üîß TH√îNG B√ÅO B·∫¢O TR√å H·ªÜ TH·ªêNG

K√≠nh g·ª≠i qu√Ω kh√°ch h√†ng,

H·ªá th·ªëng eTax Mobile s·∫Ω t·∫°m d·ª´ng ho·∫°t ƒë·ªông ƒë·ªÉ b·∫£o tr√¨ t·ª´:
üìÖ Th·ªùi gian: 02:00 - 06:00 ng√†y [DATE]

Trong th·ªùi gian n√†y, qu√Ω kh√°ch t·∫°m th·ªùi kh√¥ng th·ªÉ:
‚Ä¢ ƒêƒÉng nh·∫≠p v√†o h·ªá th·ªëng
‚Ä¢ Tra c·ª©u th√¥ng tin thu·∫ø
‚Ä¢ Th·ª±c hi·ªán c√°c giao d·ªãch

Ch√∫ng t√¥i xin l·ªói v√¨ s·ª± b·∫•t ti·ªán n√†y!

Tr√¢n tr·ªçng,
Ban Qu·∫£n Tr·ªã eTax`;
          break;
          
        case 'tax_reminder':
          content = `üìÖ NH·∫ÆC NH·ªû N·ªòP THU·∫æ

K√≠nh g·ª≠i qu√Ω kh√°ch h√†ng,

ƒê√¢y l√† th√¥ng b√°o nh·∫Øc nh·ªü v·ªÅ vi·ªác n·ªôp thu·∫ø:

üìã Lo·∫°i thu·∫ø: [TAX_TYPE]
üìÖ H·∫°n n·ªôp: [DUE_DATE]
üí∞ S·ªë ti·ªÅn: [AMOUNT]

Vui l√≤ng ho√†n th√†nh vi·ªác n·ªôp thu·∫ø tr∆∞·ªõc h·∫°n ƒë·ªÉ tr√°nh b·ªã ph·∫°t ch·∫≠m n·ªôp.

Tra c·ª©u chi ti·∫øt t·∫°i m·ª•c "Tra c·ª©u ch·ª©ng t·ª´".

eTax Mobile Team`;
          break;
          
        case 'policy':
          content = `üìú TH√îNG B√ÅO CH√çNH S√ÅCH M·ªöI

K√≠nh g·ª≠i qu√Ω kh√°ch h√†ng,

B·ªô T√†i Ch√≠nh v·ª´a ban h√†nh ch√≠nh s√°ch thu·∫ø m·ªõi c√≥ hi·ªáu l·ª±c t·ª´ [DATE]:

üî∏ [POLICY_POINT_1]
üî∏ [POLICY_POINT_2]
üî∏ [POLICY_POINT_3]

Chi ti·∫øt xem t·∫°i: [LINK]

M·ªçi th·∫Øc m·∫Øc vui l√≤ng li√™n h·ªá hotline h·ªó tr·ª£.

Ban Qu·∫£n Tr·ªã eTax`;
          break;
          
        case 'security':
          content = `üîí C·∫¢NH B√ÅO B·∫¢O M·∫¨T

QUAN TR·ªåNG! Vui l√≤ng ƒë·ªçc k·ªπ th√¥ng b√°o n√†y.

‚ö†Ô∏è Ch√∫ng t√¥i ph√°t hi·ªán c√≥ d·∫•u hi·ªáu b·∫•t th∆∞·ªùng trong h·ªá th·ªëng.

üìã Khuy·∫øn c√°o b·∫£o m·∫≠t:
‚Ä¢ Kh√¥ng chia s·∫ª m·∫≠t kh·∫©u cho b·∫•t k·ª≥ ai
‚Ä¢ ƒêƒÉng xu·∫•t sau khi s·ª≠ d·ª•ng
‚Ä¢ C·∫≠p nh·∫≠t ·ª©ng d·ª•ng v·ªÅ phi√™n b·∫£n m·ªõi nh·∫•t
‚Ä¢ Li√™n h·ªá ngay n·∫øu ph√°t hi·ªán b·∫•t th∆∞·ªùng

‚òéÔ∏è Hotline: 1900-xxxx (24/7)

ƒê·ªôi ng≈© B·∫£o m·∫≠t eTax`;
          break;
      }
      
      editor.value = content;
      updatePreview();
    }

    // Initialize CKEditor
    function initializeEditor() {
      if (editor) {
        editor.destroy();
      }
      
      ClassicEditor
        .create(document.querySelector('#contentEditor'), {
          toolbar: [
            'heading', '|',
            'bold', 'italic', 'underline', '|',
            'bulletedList', 'numberedList', '|',
            'link', 'blockQuote', '|',
            'undo', 'redo'
          ]
        })
        .then(newEditor => {
          editor = newEditor;
          editor.model.document.on('change:data', () => {
            updatePreview();
          });
          console.log('‚úÖ CKEditor initialized');
        })
        .catch(error => {
          console.error('‚ùå CKEditor error:', error);
          // Fallback to textarea if CKEditor fails
          document.getElementById('contentEditor').style.display = 'block';
        });
    }

    // Update preview
    function updatePreview() {
      const title = document.getElementById('notificationTitle')?.value || '';
      const priority = document.getElementById('notificationPriority')?.value || 'normal';
      
      let content = '';
      if (editor) {
        content = editor.getData();
      } else {
        content = document.getElementById('contentEditor')?.value || '';
      }
      
      const priorityIcons = {
        normal: 'üîµ',
        important: 'üü°',
        urgent: 'üî¥'
      };
      
      const typeIcon = currentNotificationType === 'general' ? 'üì¢' : 'üë§';
      
      const preview = document.getElementById('mobilePreview');
      preview.innerHTML = `
        <div class="notification-item ${currentNotificationType}">
          <div class="notification-date">
            ${new Date().toLocaleString('vi-VN')} ‚Ä¢ ${priorityIcons[priority]}
          </div>
          <div class="notification-title">
            ${typeIcon} ${title || 'Ti√™u ƒë·ªÅ th√¥ng b√°o'}
          </div>
          <div class="notification-content">
            ${content || 'N·ªôi dung th√¥ng b√°o s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...'}
          </div>
        </div>
      `;
    }

    // Save notification
    async function saveNotification() {
      try {
        const notificationData = collectNotificationData();
        notificationData.status = 'draft';
        
        const notificationId = 'notif_' + Date.now();
        await db.ref('notifications/' + notificationId).set(notificationData);
        
        console.log('‚úÖ Notification saved as draft:', notificationId);
        alert('üíæ ƒê√£ l∆∞u th√¥ng b√°o v√†o nh√°p');
        
        await loadNotifications();
        
      } catch (error) {
        console.error('‚ùå Error saving notification:', error);
        alert('‚ùå L·ªói l∆∞u th√¥ng b√°o: ' + error.message);
      }
    }

    // Publish notification
    async function publishNotification() {
      try {
        const notificationData = collectNotificationData();
        notificationData.status = 'active';
        notificationData.publishedAt = Date.now();
        
        const notificationId = 'notif_' + Date.now();
        await db.ref('notifications/' + notificationId).set(notificationData);
        
        console.log('‚úÖ Notification published:', notificationId);
        alert('üöÄ ƒê√£ xu·∫•t b·∫£n th√¥ng b√°o th√†nh c√¥ng!');
        
        // Clear form
        clearForm();
        await loadNotifications();
        
      } catch (error) {
        console.error('‚ùå Error publishing notification:', error);
        alert('‚ùå L·ªói xu·∫•t b·∫£n th√¥ng b√°o: ' + error.message);
      }
    }

    // Collect notification data
    function collectNotificationData() {
      const title = document.getElementById('notificationTitle')?.value || '';
      const priority = document.getElementById('notificationPriority')?.value || 'normal';
      const displayDate = document.getElementById('displayDate')?.value || '';
      const expireDate = document.getElementById('expireDate')?.value || '';
      const targetUser = document.getElementById('targetUser')?.value || '';
      
      let content = '';
      if (editor) {
        content = editor.getData();
      } else {
        content = document.getElementById('contentEditor')?.value || '';
      }
      
      return {
        title,
        content,
        type: currentNotificationType,
        priority,
        targetUser: currentNotificationType === 'personal' ? targetUser : null,
        displayDate: displayDate ? new Date(displayDate).getTime() : Date.now(),
        expireDate: expireDate ? new Date(expireDate).getTime() : null,
        createdAt: Date.now(),
        createdBy: 'admin@etax.vn'
      };
    }

    // Clear form
    function clearForm() {
      document.getElementById('notificationTitle').value = '';
      document.getElementById('displayDate').value = new Date().toISOString().slice(0, 16);
      document.getElementById('expireDate').value = '';
      if (document.getElementById('targetUser')) {
        document.getElementById('targetUser').value = '';
      }
      
      if (editor) {
        editor.setData('');
      } else {
        document.getElementById('contentEditor').value = '';
      }
      
      updatePreview();
    }

    // Delete notification
    async function deleteNotification(notificationId) {
      if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a th√¥ng b√°o n√†y?')) return;
      
      try {
        await db.ref('notifications/' + notificationId).remove();
        
        console.log('‚úÖ Notification deleted:', notificationId);
        alert('üóëÔ∏è ƒê√£ x√≥a th√¥ng b√°o');
        
        await loadNotifications();
        showManageTab();
        
      } catch (error) {
        console.error('‚ùå Error deleting notification:', error);
        alert('‚ùå L·ªói x√≥a th√¥ng b√°o: ' + error.message);
      }
    }

    // Load auto templates
    async function loadAutoTemplates() {
      try {
        const templatesSnapshot = await db.ref('autoTemplates').once('value');
        const templates = templatesSnapshot.val() || {};
        
        if (templates.account) {
          document.getElementById('accountTemplate_title').value = templates.account.title || '';
          document.getElementById('accountTemplate_content').value = templates.account.content || '';
        }
        
        if (templates.pdf) {
          document.getElementById('pdfTemplate_title').value = templates.pdf.title || '';
          document.getElementById('pdfTemplate_content').value = templates.pdf.content || '';
        }
        
      } catch (error) {
        console.error('‚ùå Error loading auto templates:', error);
      }
    }

    // Save auto template
    async function saveAutoTemplate(templateType) {
      try {
        const title = document.getElementById(`${templateType}Template_title`).value;
        const content = document.getElementById(`${templateType}Template_content`).value;
        
        await db.ref(`autoTemplates/${templateType}`).set({
          title,
          content,
          updatedAt: Date.now(),
          updatedBy: 'admin@etax.vn'
        });
        
        console.log('‚úÖ Auto template saved:', templateType);
        alert('üíæ ƒê√£ l∆∞u template t·ª± ƒë·ªông');
        
      } catch (error) {
        console.error('‚ùå Error saving auto template:', error);
        alert('‚ùå L·ªói l∆∞u template: ' + error.message);
      }
    }

    // Test auto notification
    async function testAutoNotification() {
      const testUser = document.getElementById('testUser').value;
      const testType = document.getElementById('testType').value;
      
      if (!testUser) {
        alert('‚ùå Vui l√≤ng ch·ªçn user ƒë·ªÉ test');
        return;
      }
      
      try {
        const user = allUsers.find(u => u.mst === testUser);
        if (!user) {
          alert('‚ùå Kh√¥ng t√¨m th·∫•y user');
          return;
        }
        
        // Load template
        const templatesSnapshot = await db.ref(`autoTemplates/${testType}`).once('value');
        const template = templatesSnapshot.val() || {};
        
        let title = template.title || 'Test notification';
        let content = template.content || 'Test content';
        
        // Replace placeholders
        const replacements = {
          '{MST}': user.mst,
          '{NAME}': user.name || user.mst,
          '{DATE}': new Date().toLocaleString('vi-VN'),
          '{FILENAME}': 'test_document.pdf',
          '{AMOUNT}': '1,000,000 VND'
        };
        
        Object.entries(replacements).forEach(([placeholder, value]) => {
          title = title.replace(new RegExp(placeholder, 'g'), value);
          content = content.replace(new RegExp(placeholder, 'g'), value);
        });
        
        // Send test notification
        const notificationId = 'test_' + Date.now();
        await db.ref('notifications/' + notificationId).set({
          title,
          content,
          type: 'personal',
          targetUser: user.mst,
          priority: 'normal',
          status: 'active',
          isTest: true,
          createdAt: Date.now(),
          createdBy: 'admin@etax.vn'
        });
        
        console.log('‚úÖ Test notification sent:', notificationId);
        alert(`üß™ ƒê√£ g·ª≠i th√¥ng b√°o test cho user ${user.mst}`);
        
      } catch (error) {
        console.error('‚ùå Error sending test notification:', error);
        alert('‚ùå L·ªói g·ª≠i test: ' + error.message);
      }
    }

    // Initialize
    updatePreview();
  </script>
</body>
</html>