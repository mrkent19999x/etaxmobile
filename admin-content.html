<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>âœï¸ Táº¡o Ná»™i dung - eTAX ADMIN</title>
  
  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
a  <!-- ğŸ’¡ Tá»‘i Æ°u hÃ³a: Táº£i cáº¥u hÃ¬nh Firebase tá»« tá»‡p chung -->
  <script src="./firebase-config.js"></script>
  
  <!-- CKEditor -->
  <script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', 'Tahoma', 'Microsoft Sans Serif', 'Arial', sans-serif;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    .admin-header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .admin-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 20px;
      font-weight: 700;
      color: #dc3545;
    }

    .back-btn {
      background: #6c757d;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      transition: background 0.3s;
    }

    .back-btn:hover {
      background: #545b62;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    .content-header {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .content-title {
      font-size: 24px;
      color: #333;
      margin-bottom: 15px;
    }

    .tabs {
      display: flex;
      background: #f8f9fa;
      border-radius: 10px;
      padding: 5px;
      margin-bottom: 25px;
    }

    .tab-btn {
      flex: 1;
      padding: 12px 20px;
      border: none;
      background: transparent;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      color: #666;
      transition: all 0.3s;
    }

    .tab-btn.active,
    .tab-btn:hover {
      background: white;
      color: #333;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .main-layout {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 30px;
    }

    .editor-section {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .preview-section {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .card-title {
      color: #b71c1c;
      margin-bottom: 15px;
      font-size: 16px;
      font-weight: 600;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: #007bff;
    }

    .form-row {
      display: flex;
      gap: 15px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
      margin-right: 10px;
    }

    .btn-primary {
      background: #007bff;
      color: white;
    }

    .btn-primary:hover {
      background: #0056b3;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #1e7e34;
    }

    .btn-warning {
      background: #ffc107;
      color: #333;
    }

    .btn-warning:hover {
      background: #e0a800;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      margin-right: 8px;
    }

    /* Mobile Preview Frame */
    .mobile-preview {
      background: #333;
      border-radius: 25px;
      padding: 20px 15px;
      position: relative;
    }

    .mobile-screen {
      background: white;
      border-radius: 15px;
      overflow: hidden;
      position: relative;
      width: 100%;
      min-height: 400px;
    }

    .mobile-header {
      background: #b71c1c;
      color: white;
      padding: 15px;
      text-align: center;
      font-weight: 600;
    }

    .mobile-content {
      padding: 20px;
      min-height: 300px;
      font-size: 14px;
      line-height: 1.6;
    }

    .notification-item {
      background: #f8f9fa;
      border-left: 4px solid #007bff;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
    }

    .notification-item.general {
      border-left-color: #dc3545;
    }

    .notification-item.personal {
      border-left-color: #28a745;
    }

    .notification-date {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
    }

    .notification-title {
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }

    .notification-content {
      color: #666;
      font-size: 13px;
    }

    .template-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }

    .template-btn {
      background: #f8f9fa;
      border: 2px solid #e0e0e0;
      padding: 15px;
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s;
    }

    .template-btn:hover {
      border-color: #007bff;
      background: #e3f2fd;
    }

    .template-btn.active {
      border-color: #007bff;
      background: #e3f2fd;
    }

    .ck-editor__editable {
      min-height: 300px !important;
    }

    @media (max-width: 1200px) {
      .main-layout {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .preview-section {
        order: -1;
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px 15px;
      }
      
      .form-row {
        flex-direction: column;
      }
      
      .template-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="admin-header">
    <div class="admin-logo">
      âœï¸ Táº¡o Ná»™i dung ThÃ´ng bÃ¡o
    </div>
    <a href="admin-dashboard.html" class="back-btn">â† Vá» Dashboard</a>
  </div>

  <div class="container">
    <!-- Header -->
    <div class="content-header">
      <h2 class="content-title">âœï¸ Táº O Ná»˜I DUNG THÃ”NG BÃO REALTIME</h2>
      
      <div class="tabs">
        <button class="tab-btn active" onclick="showTab('create')">
          ğŸ“ Táº¡o thÃ´ng bÃ¡o má»›i
        </button>
        <button class="tab-btn" onclick="showTab('manage')">
          ğŸ“‹ Quáº£n lÃ½ thÃ´ng bÃ¡o
        </button>
        <button class="tab-btn" onclick="showTab('auto')">
          ğŸ¤– ThÃ´ng bÃ¡o tá»± Ä‘á»™ng
        </button>
      </div>
    </div>

    <!-- Main Layout -->
    <div class="main-layout">
      <!-- Editor Section -->
      <div class="editor-section">
        <div id="tabContent">
          <!-- Content will be loaded here -->
        </div>
      </div>

      <!-- Preview Section -->
      <div class="preview-section">
        <!-- Mobile Preview -->
        <div class="card">
          <h4 class="card-title">ğŸ“± Preview Mobile</h4>
          <div class="mobile-preview">
            <div class="mobile-screen">
              <div class="mobile-header">
                ğŸ”” ThÃ´ng bÃ¡o - eTax Mobile
              </div>
              <div class="mobile-content" id="mobilePreview">
                <div style="text-align: center; color: #999; padding: 40px 20px;">
                  ğŸ“ Ná»™i dung thÃ´ng bÃ¡o sáº½ hiá»ƒn thá»‹ á»Ÿ Ä‘Ã¢y...
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="card">
          <h4 class="card-title">ğŸ“Š Thá»‘ng kÃª nhanh</h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center;">
            <div>
              <div style="font-size: 24px; font-weight: 700; color: #007bff;" id="totalNotifications">0</div>
              <div style="font-size: 12px; color: #666;">Tá»•ng thÃ´ng bÃ¡o</div>
            </div>
            <div>
              <div style="font-size: 24px; font-weight: 700; color: #28a745;" id="activeNotifications">0</div>
              <div style="font-size: 12px; color: #666;">Äang hiá»ƒn thá»‹</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let editor = null;
    let currentNotificationType = 'general';
    let allUsers = [];
    let allNotifications = [];

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      console.log('âœï¸ Content Creator page loaded');
      initializePage();
    });

    async function initializePage() {
      try {
        // Load users for personal notifications
        await loadUsers();
        
        // Load existing notifications for stats
        await loadNotifications();
        
        // Show default tab
        showTab('create');
        
        console.log('âœ… Content Creator initialized');
        
      } catch (error) {
        console.error('âŒ Error initializing page:', error);
      }
    }

    // Load users
    async function loadUsers() {
      try {
        const usersSnapshot = await db.ref('users').once('value');
        const users = usersSnapshot.val() || {};
        
        allUsers = Object.entries(users).map(([mst, user]) => ({
          mst,
          name: `${user.lastName || ''} ${user.firstName || user.fullName || ''}`.trim(),
          companyName: user.companyName || ''
        }));
        
        console.log('âœ… Users loaded:', allUsers.length);
        
      } catch (error) {
        console.error('âŒ Error loading users:', error);
      }
    }

    // Load notifications for stats
    async function loadNotifications() {
      try {
        const notificationsSnapshot = await db.ref('notifications').once('value');
        const notifications = notificationsSnapshot.val() || {};
        
        allNotifications = Object.entries(notifications).map(([id, notif]) => ({ id, ...notif }));
        
        // Update stats
        const total = allNotifications.length;
        const active = allNotifications.filter(n => n.status === 'active').length;
        
        document.getElementById('totalNotifications').textContent = total;
        document.getElementById('activeNotifications').textContent = active;
        
        console.log('âœ… Notifications loaded:', total);
        
      } catch (error) {
        console.error('âŒ Error loading notifications:', error);
      }
    }

    // Show tab
    function showTab(tabType) {
      // Update tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      const tabContent = document.getElementById('tabContent');
      
      if (tabType === 'create') {
        showCreateTab();
      } else if (tabType === 'manage') {
        showManageTab();
      } else if (tabType === 'auto') {
        showAutoTab();
      }
    }

    // Show create tab
    function showCreateTab() {
      const tabContent = document.getElementById('tabContent');
      
      tabContent.innerHTML = `
        <h3 style="color: #b71c1c; margin-bottom: 20px;">ğŸ“ Táº¡o ThÃ´ng bÃ¡o Má»›i</h3>
        
        <!-- Notification Type -->
        <div class="form-group">
          <label class="form-label">ğŸ“± Loáº¡i thÃ´ng bÃ¡o:</label>
          <div class="template-grid">
            <div class="template-btn active" onclick="selectNotificationType('general')">
              <div style="font-size: 24px; margin-bottom: 8px;">ğŸ“¢</div>
              <div style="font-weight: 600;">ThÃ´ng bÃ¡o chung</div>
              <div style="font-size: 12px; color: #666;">Cho táº¥t cáº£ user</div>
            </div>
            
          </div>
        </div>

        

        <!-- Basic Info -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ğŸ“‹ TiÃªu Ä‘á» thÃ´ng bÃ¡o:</label>
            <input type="text" class="form-input" id="notificationTitle" placeholder="Nháº­p tiÃªu Ä‘á»..." onkeyup="updatePreview()">
          </div>
          <div class="form-group">
            <label class="form-label">â­ Má»©c Ä‘á»™ Æ°u tiÃªn:</label>
            <select class="form-select" id="notificationPriority" onchange="updatePreview()">
              <option value="normal">ğŸ”µ BÃ¬nh thÆ°á»ng</option>
              <option value="important">ğŸŸ¡ Quan trá»ng</option>
              <option value="urgent">ğŸ”´ Kháº©n cáº¥p</option>
            </select>
          </div>
        </div>

        <!-- Content Templates -->
        <div class="form-group">
          <label class="form-label">ğŸ“„ Template nhanh:</label>
          <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
            <button class="btn btn-primary btn-small" onclick="insertTemplate('maintenance')">
              ğŸ”§ Báº£o trÃ¬ há»‡ thá»‘ng
            </button>
            <button class="btn btn-success btn-small" onclick="insertTemplate('tax_reminder')">
              ğŸ“… Nháº¯c ná»™p thuáº¿
            </button>
            <button class="btn btn-warning btn-small" onclick="insertTemplate('policy')">
              ğŸ“œ ChÃ­nh sÃ¡ch má»›i
            </button>
            <button class="btn btn-danger btn-small" onclick="insertTemplate('security')">
              ğŸ”’ Cáº£nh bÃ¡o báº£o máº­t
            </button>
          </div>
        </div>

        <!-- Rich Text Editor -->
        <div class="form-group">
          <label class="form-label">âœï¸ Ná»™i dung thÃ´ng bÃ¡o:</label>
          <textarea id="contentEditor" class="form-textarea" rows="10" placeholder="Nháº­p ná»™i dung thÃ´ng bÃ¡o..." onkeyup="updatePreview()"></textarea>
        </div>

        <!-- Scheduling -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ğŸ“… NgÃ y hiá»ƒn thá»‹:</label>
            <input type="datetime-local" class="form-input" id="displayDate" value="${new Date().toISOString().slice(0, 16)}">
          </div>
          <div class="form-group">
            <label class="form-label">â° NgÃ y háº¿t háº¡n:</label>
            <input type="datetime-local" class="form-input" id="expireDate">
          </div>
        </div>

        <!-- Actions -->
        <div style="margin-top: 30px; display: flex; gap: 15px;">
          <button class="btn btn-warning" onclick="previewNotification()">
            ğŸ‘ï¸ Xem trÆ°á»›c
          </button>
          <button class="btn btn-primary" onclick="saveNotification()">
            ğŸ’¾ LÆ°u nhÃ¡p
          </button>
          <button class="btn btn-success" onclick="publishNotification()">
            ğŸš€ Xuáº¥t báº£n ngay
          </button>
        </div>
      `;
      
      // Initialize CKEditor for rich content
      initializeEditor();
    }

    // Show manage tab
    function showManageTab() {
      const tabContent = document.getElementById('tabContent');
      
      if (allNotifications.length === 0) {
        tabContent.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: #999;">
            <div style="font-size: 64px; margin-bottom: 20px;">ğŸ“­</div>
            <h3>ChÆ°a cÃ³ thÃ´ng bÃ¡o nÃ o</h3>
            <p>HÃ£y táº¡o thÃ´ng bÃ¡o Ä‘áº§u tiÃªn báº±ng tab "Táº¡o thÃ´ng bÃ¡o má»›i"</p>
          </div>
        `;
        return;
      }
      
      const sortedNotifications = [...allNotifications].sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
      
      tabContent.innerHTML = `
        <h3 style="color: #b71c1c; margin-bottom: 20px;">ğŸ“‹ Quáº£n lÃ½ ThÃ´ng bÃ¡o (${allNotifications.length})</h3>
        
        <div style="max-height: 600px; overflow-y: auto;">
          ${sortedNotifications.map(notif => `
            <div style="background: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 15px; border-left: 4px solid ${notif.type === 'general' ? '#dc3545' : '#28a745'};">
              <div style="display: flex; justify-content: between; align-items: flex-start; margin-bottom: 10px;">
                <div style="flex: 1;">
                  <div style="font-weight: 600; color: #333; margin-bottom: 5px;">
                    ${notif.type === 'general' ? 'ğŸ“¢' : 'ğŸ‘¤'} ${notif.title || 'KhÃ´ng cÃ³ tiÃªu Ä‘á»'}
                  </div>
                  <div style="font-size: 12px; color: #666;">
                    ${notif.type === 'general' ? 'ThÃ´ng bÃ¡o chung' : 'ThÃ´ng bÃ¡o cÃ¡ nhÃ¢n'} â€¢ 
                    ${notif.createdAt ? new Date(notif.createdAt).toLocaleString('vi-VN') : 'N/A'}
                  </div>
                </div>
                <div style="display: flex; gap: 5px;">
                  <button class="btn btn-primary btn-small" onclick="editNotification('${notif.id}')">
                    âœï¸ Sá»­a
                  </button>
                  <button class="btn btn-danger btn-small" onclick="deleteNotification('${notif.id}')">
                    ğŸ—‘ï¸ XÃ³a
                  </button>
                </div>
              </div>
              <div style="color: #666; font-size: 14px; line-height: 1.5;">
                ${(notif.content || '').substring(0, 200)}${(notif.content || '').length > 200 ? '...' : ''}
              </div>
              <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
                <span class="btn btn-small" style="background: ${notif.status === 'active' ? '#28a745' : '#6c757d'}; color: white;">
                  ${notif.status === 'active' ? 'âœ… Äang hiá»ƒn thá»‹' : 'â¸ï¸ Táº¡m dá»«ng'}
                </span>
                <span style="font-size: 12px; color: #666;">
                  Æ¯u tiÃªn: ${notif.priority === 'urgent' ? 'ğŸ”´ Kháº©n cáº¥p' : notif.priority === 'important' ? 'ğŸŸ¡ Quan trá»ng' : 'ğŸ”µ BÃ¬nh thÆ°á»ng'}
                </span>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // Show auto tab
    function showAutoTab() {
      const tabContent = document.getElementById('tabContent');
      
      tabContent.innerHTML = `
        <h3 style="color: #b71c1c; margin-bottom: 20px;">ğŸ¤– ThÃ´ng bÃ¡o Tá»± Ä‘á»™ng</h3>
        
        <div style="background: #e8f4fd; padding: 20px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #007bff;">
          <h4 style="color: #0056b3; margin-bottom: 10px;">ğŸ“‹ Há»‡ thá»‘ng tá»± Ä‘á»™ng hoáº¡t Ä‘á»™ng:</h4>
          <p style="margin-bottom: 8px;">â€¢ <strong>Táº¡o tÃ i khoáº£n:</strong> Tá»± Ä‘á»™ng gá»­i thÃ´ng bÃ¡o "TÃ i khoáº£n kÃ­ch hoáº¡t" cho user má»›i</p>
          <p style="margin-bottom: 8px;">â€¢ <strong>Upload PDF:</strong> Tá»± Ä‘á»™ng thÃ´ng bÃ¡o "ÄÃ£ cÃ³ tÃ i liá»‡u má»›i" khi admin upload</p>
          <p style="margin-bottom: 8px;">â€¢ <strong>Template tÃ¹y chá»‰nh:</strong> CÃ³ thá»ƒ chá»‰nh sá»­a ná»™i dung máº«u bÃªn dÆ°á»›i</p>
        </div>

        <!-- Account Creation Template -->
        <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
          <h4 style="color: #28a745; margin-bottom: 15px;">ğŸ‘¤ Template: Táº¡o tÃ i khoáº£n</h4>
          <div class="form-group">
            <label class="form-label">ğŸ“‹ TiÃªu Ä‘á»:</label>
            <input type="text" class="form-input" id="accountTemplate_title" value="ğŸ‰ TÃ i khoáº£n Ä‘Æ°á»£c kÃ­ch hoáº¡t thÃ nh cÃ´ng!">
          </div>
          <div class="form-group">
            <label class="form-label">âœï¸ Ná»™i dung (sá»­ dá»¥ng {MST}, {NAME}, {DATE}):</label>
            <textarea class="form-textarea" id="accountTemplate_content" rows="4">Xin chÃ o {NAME},

TÃ i khoáº£n MST {MST} cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c kÃ­ch hoáº¡t thÃ nh cÃ´ng vÃ o {DATE}.

Báº¡n cÃ³ thá»ƒ Ä‘Äƒng nháº­p vÃ  sá»­ dá»¥ng Ä‘áº§y Ä‘á»§ cÃ¡c tÃ­nh nÄƒng cá»§a eTax Mobile.

TrÃ¢n trá»ng,
Äá»™i ngÅ© eTax Support</textarea>
          </div>
          <button class="btn btn-success" onclick="saveAutoTemplate('account')">ğŸ’¾ LÆ°u template</button>
        </div>

        <!-- PDF Upload Template -->
        <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
          <h4 style="color: #007bff; margin-bottom: 15px;">ğŸ“„ Template: Upload PDF</h4>
          <div class="form-group">
            <label class="form-label">ğŸ“‹ TiÃªu Ä‘á»:</label>
            <input type="text" class="form-input" id="pdfTemplate_title" value="ğŸ“„ CÃ³ tÃ i liá»‡u thuáº¿ má»›i">
          </div>
          <div class="form-group">
            <label class="form-label">âœï¸ Ná»™i dung (sá»­ dá»¥ng {MST}, {FILENAME}, {DATE}, {AMOUNT}):</label>
            <textarea class="form-textarea" id="pdfTemplate_content" rows="4">KÃ­nh gá»­i khÃ¡ch hÃ ng MST {MST},

ChÃºng tÃ´i Ä‘Ã£ cáº­p nháº­t tÃ i liá»‡u thuáº¿ má»›i cho báº¡n:
ğŸ“„ File: {FILENAME}
ğŸ’° Sá»‘ tiá»n: {AMOUNT}
ğŸ“… NgÃ y cáº­p nháº­t: {DATE}

Báº¡n cÃ³ thá»ƒ tra cá»©u vÃ  táº£i vá» táº¡i má»¥c "Tra cá»©u chá»©ng tá»«".

eTax Mobile Team</textarea>
          </div>
          <button class="btn btn-primary" onclick="saveAutoTemplate('pdf')">ğŸ’¾ LÆ°u template</button>
        </div>

        <!-- Test Auto Notification -->
        <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 20px;">
          <h4 style="color: #856404; margin-bottom: 15px;">ğŸ§ª Test ThÃ´ng bÃ¡o Tá»± Ä‘á»™ng</h4>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ğŸ‘¤ Chá»n user test:</label>
              <select class="form-select" id="testUser">
                <option value="">-- Chá»n user --</option>
                ${allUsers.map(user => 
                  `<option value="${user.mst}">${user.mst} - ${user.name || 'N/A'}</option>`
                ).join('')}
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">ğŸ­ Loáº¡i test:</label>
              <select class="form-select" id="testType">
                <option value="account">ğŸ‘¤ KÃ­ch hoáº¡t tÃ i khoáº£n</option>
                <option value="pdf">ğŸ“„ Upload PDF</option>
              </select>
            </div>
          </div>
          <button class="btn btn-warning" onclick="testAutoNotification()">ğŸ§ª Gá»­i thÃ´ng bÃ¡o test</button>
        </div>
      `;
      
      // Load existing templates
      loadAutoTemplates();
    }

    // Select notification type
    function selectNotificationType(type) {
      currentNotificationType = type;
      
      // Update template buttons
      document.querySelectorAll('.template-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      updatePreview();
    }

    // Insert template
    function insertTemplate(templateType) {
      const editor = document.getElementById('contentEditor');
      let content = '';
      
      switch (templateType) {
        case 'maintenance':
          content = `ğŸ”§ THÃ”NG BÃO Báº¢O TRÃŒ Há»† THá»NG

KÃ­nh gá»­i quÃ½ khÃ¡ch hÃ ng,

Há»‡ thá»‘ng eTax Mobile sáº½ táº¡m dá»«ng hoáº¡t Ä‘á»™ng Ä‘á»ƒ báº£o trÃ¬ tá»«:
ğŸ“… Thá»i gian: 02:00 - 06:00 ngÃ y [DATE]

Trong thá»i gian nÃ y, quÃ½ khÃ¡ch táº¡m thá»i khÃ´ng thá»ƒ:
â€¢ ÄÄƒng nháº­p vÃ o há»‡ thá»‘ng
â€¢ Tra cá»©u thÃ´ng tin thuáº¿
â€¢ Thá»±c hiá»‡n cÃ¡c giao dá»‹ch

ChÃºng tÃ´i xin lá»—i vÃ¬ sá»± báº¥t tiá»‡n nÃ y!

TrÃ¢n trá»ng,
Ban Quáº£n Trá»‹ eTax`;
          break;
          
        case 'tax_reminder':
          content = `ğŸ“… NHáº®C NHá» Ná»˜P THUáº¾

KÃ­nh gá»­i quÃ½ khÃ¡ch hÃ ng,

ÄÃ¢y lÃ  thÃ´ng bÃ¡o nháº¯c nhá»Ÿ vá» viá»‡c ná»™p thuáº¿:

ğŸ“‹ Loáº¡i thuáº¿: [TAX_TYPE]
ğŸ“… Háº¡n ná»™p: [DUE_DATE]
ğŸ’° Sá»‘ tiá»n: [AMOUNT]

Vui lÃ²ng hoÃ n thÃ nh viá»‡c ná»™p thuáº¿ trÆ°á»›c háº¡n Ä‘á»ƒ trÃ¡nh bá»‹ pháº¡t cháº­m ná»™p.

Tra cá»©u chi tiáº¿t táº¡i má»¥c "Tra cá»©u chá»©ng tá»«".

eTax Mobile Team`;
          break;
          
        case 'policy':
          content = `ğŸ“œ THÃ”NG BÃO CHÃNH SÃCH Má»šI

KÃ­nh gá»­i quÃ½ khÃ¡ch hÃ ng,

Bá»™ TÃ i ChÃ­nh vá»«a ban hÃ nh chÃ­nh sÃ¡ch thuáº¿ má»›i cÃ³ hiá»‡u lá»±c tá»« [DATE]:

ğŸ”¸ [POLICY_POINT_1]
ğŸ”¸ [POLICY_POINT_2]
ğŸ”¸ [POLICY_POINT_3]

Chi tiáº¿t xem táº¡i: [LINK]

Má»i tháº¯c máº¯c vui lÃ²ng liÃªn há»‡ hotline há»— trá»£.

Ban Quáº£n Trá»‹ eTax`;
          break;
          
        case 'security':
          content = `ğŸ”’ Cáº¢NH BÃO Báº¢O Máº¬T

QUAN TRá»ŒNG! Vui lÃ²ng Ä‘á»c ká»¹ thÃ´ng bÃ¡o nÃ y.

âš ï¸ ChÃºng tÃ´i phÃ¡t hiá»‡n cÃ³ dáº¥u hiá»‡u báº¥t thÆ°á»ng trong há»‡ thá»‘ng.

ğŸ“‹ Khuyáº¿n cÃ¡o báº£o máº­t:
â€¢ KhÃ´ng chia sáº» máº­t kháº©u cho báº¥t ká»³ ai
â€¢ ÄÄƒng xuáº¥t sau khi sá»­ dá»¥ng
â€¢ Cáº­p nháº­t á»©ng dá»¥ng vá» phiÃªn báº£n má»›i nháº¥t
â€¢ LiÃªn há»‡ ngay náº¿u phÃ¡t hiá»‡n báº¥t thÆ°á»ng

â˜ï¸ Hotline: 1900-xxxx (24/7)

Äá»™i ngÅ© Báº£o máº­t eTax`;
          break;
      }
      
      editor.value = content;
      updatePreview();
    }

    // Initialize CKEditor
    function initializeEditor() {
      if (editor) {
        editor.destroy();
      }
      
      ClassicEditor
        .create(document.querySelector('#contentEditor'), {
          toolbar: [
            'heading', '|',
            'bold', 'italic', 'underline', '|',
            'bulletedList', 'numberedList', '|',
            'link', 'blockQuote', '|',
            'undo', 'redo'
          ]
        })
        .then(newEditor => {
          editor = newEditor;
          editor.model.document.on('change:data', () => {
            updatePreview();
          });
          console.log('âœ… CKEditor initialized');
        })
        .catch(error => {
          console.error('âŒ CKEditor error:', error);
          // Fallback to textarea if CKEditor fails
          document.getElementById('contentEditor').style.display = 'block';
        });
    }

    // Update preview
    function updatePreview() {
      const title = document.getElementById('notificationTitle')?.value || '';
      const priority = document.getElementById('notificationPriority')?.value || 'normal';
      
      let content = '';
      if (editor) {
        content = editor.getData();
      } else {
        content = document.getElementById('contentEditor')?.value || '';
      }
      
      const priorityIcons = {
        normal: 'ğŸ”µ',
        important: 'ğŸŸ¡',
        urgent: 'ğŸ”´'
      };
      
      const typeIcon = currentNotificationType === 'general' ? 'ğŸ“¢' : 'ğŸ‘¤';
      
      const preview = document.getElementById('mobilePreview');
      preview.innerHTML = `
        <div class="notification-item ${currentNotificationType}">
          <div class="notification-date">
            ${new Date().toLocaleString('vi-VN')} â€¢ ${priorityIcons[priority]}
          </div>
          <div class="notification-title">
            ${typeIcon} ${title || 'TiÃªu Ä‘á» thÃ´ng bÃ¡o'}
          </div>
          <div class="notification-content">
            ${content || 'Ná»™i dung thÃ´ng bÃ¡o sáº½ hiá»ƒn thá»‹ á»Ÿ Ä‘Ã¢y...'}
          </div>
        </div>
      `;
    }

    // Save notification
    async function saveNotification() {
      try {
        const notificationData = collectNotificationData();
        notificationData.status = 'draft';
        
        const notificationId = 'notif_' + Date.now();
        await db.ref('notifications/' + notificationId).set(notificationData);
        
        console.log('âœ… Notification saved as draft:', notificationId);
        alert('ğŸ’¾ ÄÃ£ lÆ°u thÃ´ng bÃ¡o vÃ o nhÃ¡p');
        
        await loadNotifications();
        
      } catch (error) {
        console.error('âŒ Error saving notification:', error);
        alert('âŒ Lá»—i lÆ°u thÃ´ng bÃ¡o: ' + error.message);
      }
    }

    // Publish notification
    async function publishNotification() {
      try {
        const notificationData = collectNotificationData();
        notificationData.status = 'active';
        notificationData.publishedAt = Date.now();
        
        const notificationId = 'notif_' + Date.now();
        await db.ref('notifications/' + notificationId).set(notificationData);
        
        console.log('âœ… Notification published:', notificationId);
        alert('ğŸš€ ÄÃ£ xuáº¥t báº£n thÃ´ng bÃ¡o thÃ nh cÃ´ng!');
        
        // Clear form
        clearForm();
        await loadNotifications();
        
      } catch (error) {
        console.error('âŒ Error publishing notification:', error);
        alert('âŒ Lá»—i xuáº¥t báº£n thÃ´ng bÃ¡o: ' + error.message);
      }
    }

    // Collect notification data
    function collectNotificationData() {
      const title = document.getElementById('notificationTitle')?.value || '';
      const priority = document.getElementById('notificationPriority')?.value || 'normal';
      const displayDate = document.getElementById('displayDate')?.value || '';
      const expireDate = document.getElementById('expireDate')?.value || '';
      const targetUser = document.getElementById('targetUser')?.value || '';
      
      let content = '';
      if (editor) {
        content = editor.getData();
      } else {
        content = document.getElementById('contentEditor')?.value || '';
      }
      
      return {
        title,
        content,
        type: currentNotificationType,
        priority,
        targetUser: currentNotificationType === 'personal' ? targetUser : null,
        displayDate: displayDate ? new Date(displayDate).getTime() : Date.now(),
        expireDate: expireDate ? new Date(expireDate).getTime() : null,
        createdAt: Date.now(),
        createdBy: 'admin@etax.vn'
      };
    }

    // Clear form
    function clearForm() {
      document.getElementById('notificationTitle').value = '';
      document.getElementById('displayDate').value = new Date().toISOString().slice(0, 16);
      document.getElementById('expireDate').value = '';
      if (document.getElementById('targetUser')) {
        document.getElementById('targetUser').value = '';
      }
      
      if (editor) {
        editor.setData('');
      } else {
        document.getElementById('contentEditor').value = '';
      }
      
      updatePreview();
    }

    // Delete notification
    async function deleteNotification(notificationId) {
      if (!confirm('Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a thÃ´ng bÃ¡o nÃ y?')) return;
      
      try {
        await db.ref('notifications/' + notificationId).remove();
        
        console.log('âœ… Notification deleted:', notificationId);
        alert('ğŸ—‘ï¸ ÄÃ£ xÃ³a thÃ´ng bÃ¡o');
        
        await loadNotifications();
        showManageTab();
        
      } catch (error) {
        console.error('âŒ Error deleting notification:', error);
        alert('âŒ Lá»—i xÃ³a thÃ´ng bÃ¡o: ' + error.message);
      }
    }

    // Load auto templates
    async function loadAutoTemplates() {
      try {
        const templatesSnapshot = await db.ref('autoTemplates').once('value');
        const templates = templatesSnapshot.val() || {};
        
        if (templates.account) {
          document.getElementById('accountTemplate_title').value = templates.account.title || '';
          document.getElementById('accountTemplate_content').value = templates.account.content || '';
        }
        
        if (templates.pdf) {
          document.getElementById('pdfTemplate_title').value = templates.pdf.title || '';
          document.getElementById('pdfTemplate_content').value = templates.pdf.content || '';
        }
        
      } catch (error) {
        console.error('âŒ Error loading auto templates:', error);
      }
    }

    // Save auto template
    async function saveAutoTemplate(templateType) {
      try {
        const title = document.getElementById(`${templateType}Template_title`).value;
        const content = document.getElementById(`${templateType}Template_content`).value;
        
        await db.ref(`autoTemplates/${templateType}`).set({
          title,
          content,
          updatedAt: Date.now(),
          updatedBy: 'admin@etax.vn'
        });
        
        console.log('âœ… Auto template saved:', templateType);
        alert('ğŸ’¾ ÄÃ£ lÆ°u template tá»± Ä‘á»™ng');
        
      } catch (error) {
        console.error('âŒ Error saving auto template:', error);
        alert('âŒ Lá»—i lÆ°u template: ' + error.message);
      }
    }

    // Test auto notification
    async function testAutoNotification() {
      const testUser = document.getElementById('testUser').value;
      const testType = document.getElementById('testType').value;
      
      if (!testUser) {
        alert('âŒ Vui lÃ²ng chá»n user Ä‘á»ƒ test');
        return;
      }
      
      try {
        const user = allUsers.find(u => u.mst === testUser);
        if (!user) {
          alert('âŒ KhÃ´ng tÃ¬m tháº¥y user');
          return;
        }
        
        // Load template
        const templatesSnapshot = await db.ref(`autoTemplates/${testType}`).once('value');
        const template = templatesSnapshot.val() || {};
        
        let title = template.title || 'Test notification';
        let content = template.content || 'Test content';
        
        // Replace placeholders
        const replacements = {
          '{MST}': user.mst,
          '{NAME}': user.name || user.mst,
          '{DATE}': new Date().toLocaleString('vi-VN'),
          '{FILENAME}': 'test_document.pdf',
          '{AMOUNT}': '1,000,000 VND'
        };
        
        Object.entries(replacements).forEach(([placeholder, value]) => {
          title = title.replace(new RegExp(placeholder, 'g'), value);
          content = content.replace(new RegExp(placeholder, 'g'), value);
        });
        
        // Send test notification
        const notificationId = 'test_' + Date.now();
        await db.ref('notifications/' + notificationId).set({
          title,
          content,
          type: 'personal',
          targetUser: user.mst,
          priority: 'normal',
          status: 'active',
          isTest: true,
          createdAt: Date.now(),
          createdBy: 'admin@etax.vn'
        });
        
        console.log('âœ… Test notification sent:', notificationId);
        alert(`ğŸ§ª ÄÃ£ gá»­i thÃ´ng bÃ¡o test cho user ${user.mst}`);
        
      } catch (error) {
        console.error('âŒ Error sending test notification:', error);
        alert('âŒ Lá»—i gá»­i test: ' + error.message);
      }
    }

    // Initialize
    updatePreview();
  </script>
</body>
</html>