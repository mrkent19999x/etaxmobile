<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚öôÔ∏è C√†i ƒë·∫∑t & Logs - eTAX ADMIN</title>
  
  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <!-- üí° T·ªëi ∆∞u h√≥a: T·∫£i c·∫•u h√¨nh Firebase t·ª´ t·ªáp chung -->
  <script src="./firebase-config.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', 'Tahoma', 'Microsoft Sans Serif', 'Arial', sans-serif;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    .admin-header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .admin-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 20px;
      font-weight: 700;
      color: #dc3545;
    }

    .back-btn {
      background: #6c757d;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      transition: background 0.3s;
    }

    .back-btn:hover {
      background: #545b62;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    .content-header {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .content-title {
      font-size: 24px;
      color: #333;
      margin-bottom: 15px;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }

    .card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .card-title {
      color: #b71c1c;
      margin-bottom: 20px;
      font-size: 18px;
      font-weight: 600;
    }

    .settings-section {
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #eee;
    }

    .settings-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      border-bottom: 1px solid #f5f5f5;
    }

    .setting-item:last-child {
      border-bottom: none;
    }

    .setting-label {
      flex: 1;
    }

    .setting-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .setting-desc {
      font-size: 13px;
      color: #666;
    }

    .setting-control {
      margin-left: 15px;
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 25px;
      background: #ccc;
      border-radius: 25px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle-switch.active {
      background: #28a745;
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 21px;
      height: 21px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
    }

    .toggle-switch.active::after {
      transform: translateX(25px);
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
    }

    .btn-primary {
      background: #007bff;
      color: white;
    }

    .btn-primary:hover {
      background: #0056b3;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #1e7e34;
    }

    .btn-warning {
      background: #ffc107;
      color: #333;
    }

    .btn-warning:hover {
      background: #e0a800;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .system-info {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #e0e0e0;
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      font-weight: 600;
      color: #333;
    }

    .info-value {
      color: #666;
    }

    .logs-container {
      max-height: 400px;
      overflow-y: auto;
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
    }

    .log-entry {
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 12px;
      border-left: 4px solid #007bff;
    }

    .log-entry.info {
      background: #e3f2fd;
      border-left-color: #007bff;
    }

    .log-entry.success {
      background: #e8f5e8;
      border-left-color: #28a745;
    }

    .log-entry.warning {
      background: #fff3cd;
      border-left-color: #ffc107;
    }

    .log-entry.error {
      background: #f8d7da;
      border-left-color: #dc3545;
    }

    .log-time {
      color: #666;
      margin-right: 10px;
    }

    .log-message {
      color: #333;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
    }

    .stat-number {
      font-size: 24px;
      font-weight: 700;
      color: #007bff;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 12px;
      color: #666;
    }

    .backup-section {
      background: #e8f4fd;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .backup-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #d0e3f0;
    }

    .backup-item:last-child {
      border-bottom: none;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px 15px;
      }
      
      .main-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>

<body>
  <div class="admin-header">
    <div class="admin-logo">
      ‚öôÔ∏è C√†i ƒë·∫∑t & Logs
    </div>
    <a href="admin-dashboard.html" class="back-btn">‚Üê V·ªÅ Dashboard</a>
  </div>

  <div class="container">
    <!-- Header -->
    <div class="content-header">
      <h2 class="content-title">‚öôÔ∏è C√ÄI ƒê·∫∂T H·ªÜ TH·ªêNG & QU·∫¢N L√ù LOGS</h2>
      
      <!-- System Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="systemUptime">-</div>
          <div class="stat-label">Uptime (gi·ªù)</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalRequests">-</div>
          <div class="stat-label">Requests h√¥m nay</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="errorRate">-</div>
          <div class="stat-label">T·ª∑ l·ªá l·ªói (%)</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="dbSize">-</div>
          <div class="stat-label">DB Size (MB)</div>
        </div>
      </div>
    </div>

    <!-- Main Grid -->
    <div class="main-grid">
      <!-- Left: System Settings -->
      <div class="card">
        <h3 class="card-title">üîß C√†i ƒë·∫∑t H·ªá th·ªëng</h3>
        
        

        <!-- Security Settings -->
        <div class="settings-section">
          <h4 style="margin-bottom: 15px; color: #333;">üîí B·∫£o m·∫≠t</h4>
          
          <div class="setting-item" style="flex-direction: column; align-items: flex-start;">
            <div class="setting-label" style="margin-bottom: 15px;">
              <div class="setting-name">üîê ƒê·ªïi m·∫≠t kh·∫©u Admin</div>
              <div class="setting-desc">Thay ƒë·ªïi m·∫≠t kh·∫©u ƒëƒÉng nh·∫≠p h·ªá th·ªëng admin</div>
            </div>
            <button class="btn btn-warning" onclick="openChangePasswordModal()" style="padding: 8px 16px; background: #ffc107; color: #000; border: none; border-radius: 5px; cursor: pointer; font-weight: 500;">
              üîë ƒê·ªïi m·∫≠t kh·∫©u
            </button>
          </div>
          
          
          
          <div class="setting-item">
            <div class="setting-label">
              <div class="setting-name">Auto-lock t√†i kho·∫£n</div>
              <div class="setting-desc">T·ª± ƒë·ªông kh√≥a sau 5 l·∫ßn ƒëƒÉng nh·∫≠p sai</div>
            </div>
            <div class="setting-control">
              <div class="toggle-switch active" onclick="toggleSetting('autoLock')"></div>
            </div>
          </div>
          
          <div class="setting-item">
            <div class="setting-label">
              <div class="setting-name">Log IP addresses</div>
              <div class="setting-desc">Ghi l·∫°i ƒë·ªãa ch·ªâ IP c·ªßa t·∫•t c·∫£ requests</div>
            </div>
            <div class="setting-control">
              <div class="toggle-switch active" onclick="toggleSetting('logIP')"></div>
            </div>
          </div>
        </div>

        <!-- System Settings -->
        <div class="settings-section">
          <h4 style="margin-bottom: 15px; color: #333;">‚öôÔ∏è H·ªá th·ªëng</h4>
          
          <div class="setting-item">
            <div class="setting-label">
              <div class="setting-name">Auto-backup</div>
              <div class="setting-desc">T·ª± ƒë·ªông backup database h√†ng ng√†y</div>
            </div>
            <div class="setting-control">
              <div class="toggle-switch active" onclick="toggleSetting('autoBackup')"></div>
            </div>
          </div>
          
          <div class="setting-item">
            <div class="setting-label">
              <div class="setting-name">Debug mode</div>
              <div class="setting-desc">Hi·ªÉn th·ªã th√¥ng tin debug chi ti·∫øt</div>
            </div>
            <div class="setting-control">
              <div class="toggle-switch" onclick="toggleSetting('debugMode')"></div>
            </div>
          </div>
          
          <div class="setting-item">
            <div class="setting-label">
              <div class="setting-name">Maintenance mode</div>
              <div class="setting-desc">Ch·∫ø ƒë·ªô b·∫£o tr√¨ (ch·ªâ admin truy c·∫≠p)</div>
            </div>
            <div class="setting-control">
              <div class="toggle-switch" onclick="toggleSetting('maintenanceMode')"></div>
            </div>
          </div>
        </div>

        <!-- System Info -->
        <div class="settings-section">
          <h4 style="margin-bottom: 15px; color: #333;">üìä Th√¥ng tin H·ªá th·ªëng</h4>
          <div class="system-info">
            <div class="info-row">
              <span class="info-label">Phi√™n b·∫£n:</span>
              <span class="info-value">eTAX v2.1.0</span>
            </div>
            <div class="info-row">
              <span class="info-label">Database:</span>
              <span class="info-value">Firebase Realtime DB</span>
            </div>
            <div class="info-row">
              <span class="info-label">Server time:</span>
              <span class="info-value" id="serverTime">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Last backup:</span>
              <span class="info-value" id="lastBackup">-</span>
            </div>
          </div>
        </div>

        <!-- Backup Section -->
        <div class="settings-section">
          <h4 style="margin-bottom: 15px; color: #333;">üíæ Backup & Ph·ª•c h·ªìi</h4>
          <div class="backup-section">
            <div class="backup-item">
              <span>Backup to√†n b·ªô database</span>
              <button class="btn btn-primary" onclick="createBackup()">üì¶ T·∫°o backup</button>
            </div>
            <div class="backup-item">
              <span>Xu·∫•t d·ªØ li·ªáu ng∆∞·ªùi d√πng</span>
              <button class="btn btn-success" onclick="exportUsers()">üìä Xu·∫•t Excel</button>
            </div>
            <div class="backup-item">
              <span>D·ªçn d·∫πp logs c≈©</span>
              <button class="btn btn-warning" onclick="cleanOldLogs()">üßπ D·ªçn d·∫πp</button>
            </div>
            <div class="backup-item">
              <span>Reset to√†n b·ªô h·ªá th·ªëng</span>
              <button class="btn btn-danger" onclick="resetSystem()">‚ö†Ô∏è Reset</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Right: System Logs -->
      <div class="card">
        <h3 class="card-title">üìã System Logs & Ho·∫°t ƒë·ªông</h3>
        
        <div style="margin-bottom: 20px;">
          <button class="btn btn-primary" onclick="refreshLogs()">üîÑ L√†m m·ªõi</button>
          <button class="btn btn-success" onclick="exportLogs()">üìä Xu·∫•t logs</button>
          <button class="btn btn-warning" onclick="clearLogs()">üóëÔ∏è X√≥a logs</button>
        </div>
        
        <div class="logs-container" id="logsContainer">
          <div class="loading">ƒêang t·∫£i logs...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let systemSettings = {
      otpRequired: true,
      autoLock: true,
      logIP: true,
      autoBackup: true,
      debugMode: false,
      maintenanceMode: false
    };

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      console.log('‚öôÔ∏è Settings page loaded');
      initializePage();
    });

    async function initializePage() {
      try {
        await loadSystemStats();
        await loadSystemLogs();
        updateServerTime();
        
        console.log('‚úÖ Settings page initialized');
        
      } catch (error) {
        console.error('‚ùå Error initializing settings page:', error);
      }
    }

    // Load system statistics
    async function loadSystemStats() {
      try {
        // Mock data - replace with real system metrics
        document.getElementById('systemUptime').textContent = Math.floor(Math.random() * 720) + 24;
        document.getElementById('totalRequests').textContent = Math.floor(Math.random() * 5000) + 1000;
        document.getElementById('errorRate').textContent = (Math.random() * 2).toFixed(1);
        document.getElementById('dbSize').textContent = (Math.random() * 100 + 50).toFixed(1);
        
        console.log('‚úÖ System stats loaded');
        
      } catch (error) {
        console.error('‚ùå Error loading system stats:', error);
      }
    }

    // Load system logs
    async function loadSystemLogs() {
      try {
        const logsContainer = document.getElementById('logsContainer');
        
        // Generate sample logs - replace with real log data
        const sampleLogs = [
          { time: new Date(), type: 'info', message: 'H·ªá th·ªëng kh·ªüi ƒë·ªông th√†nh c√¥ng' },
          { time: new Date(Date.now() - 300000), type: 'success', message: 'User 0123456789 ƒëƒÉng nh·∫≠p th√†nh c√¥ng' },
          { time: new Date(Date.now() - 600000), type: 'warning', message: 'OTP request from IP 192.168.1.100' },
          { time: new Date(Date.now() - 900000), type: 'info', message: 'PDF uploaded: tax_doc_2024.pdf' },
          { time: new Date(Date.now() - 1200000), type: 'success', message: 'Backup t·ª± ƒë·ªông ho√†n th√†nh' },
          { time: new Date(Date.now() - 1500000), type: 'error', message: 'Failed login attempt for MST: 0987654321' },
          { time: new Date(Date.now() - 1800000), type: 'info', message: 'Notification sent to 15 users' },
          { time: new Date(Date.now() - 2100000), type: 'warning', message: 'High memory usage detected: 87%' }
        ];
        
        logsContainer.innerHTML = sampleLogs.map(log => `
          <div class="log-entry ${log.type}">
            <span class="log-time">${log.time.toLocaleTimeString('vi-VN')}</span>
            <span class="log-message">${log.message}</span>
          </div>
        `).join('');
        
        console.log('‚úÖ System logs loaded');
        
      } catch (error) {
        console.error('‚ùå Error loading system logs:', error);
        document.getElementById('logsContainer').innerHTML = '<div class="log-entry error">L·ªói t·∫£i logs</div>';
      }
    }

    // Toggle system setting
    function toggleSetting(settingName) {
      const toggle = event.target;
      systemSettings[settingName] = !systemSettings[settingName];
      
      if (systemSettings[settingName]) {
        toggle.classList.add('active');
      } else {
        toggle.classList.remove('active');
      }
      
      console.log(`‚öôÔ∏è Setting ${settingName} changed to:`, systemSettings[settingName]);
      
      // Save to Firebase (optional)
      try {
        db.ref('systemSettings/' + settingName).set(systemSettings[settingName]);
      } catch (error) {
        console.error('‚ùå Error saving setting:', error);
      }
    }

    // Update server time
    function updateServerTime() {
      const now = new Date();
      document.getElementById('serverTime').textContent = now.toLocaleString('vi-VN');
      document.getElementById('lastBackup').textContent = 'H√¥m nay, 03:00 AM';
    }

    // Backup functions
    async function createBackup() {
      try {
        const confirmed = confirm('T·∫°o backup to√†n b·ªô database? Qu√° tr√¨nh n√†y c√≥ th·ªÉ m·∫•t v√†i ph√∫t.');
        if (!confirmed) return;
        
        console.log('üíæ Creating system backup...');
        alert('üîÑ ƒêang t·∫°o backup... (Demo)');
        
        // Simulate backup process
        setTimeout(() => {
          alert('‚úÖ Backup ho√†n th√†nh! File: etax_backup_' + new Date().toISOString().split('T')[0] + '.json');
          updateServerTime();
        }, 2000);
        
      } catch (error) {
        console.error('‚ùå Error creating backup:', error);
        alert('‚ùå L·ªói t·∫°o backup: ' + error.message);
      }
    }

    async function exportUsers() {
      try {
        console.log('üìä Exporting user data...');
        alert('üìä ƒêang xu·∫•t d·ªØ li·ªáu ng∆∞·ªùi d√πng... (Demo)');
        
        // Simulate export
        setTimeout(() => {
          alert('‚úÖ Xu·∫•t d·ªØ li·ªáu th√†nh c√¥ng! File: users_export_' + new Date().toISOString().split('T')[0] + '.xlsx');
        }, 1500);
        
      } catch (error) {
        console.error('‚ùå Error exporting users:', error);
        alert('‚ùå L·ªói xu·∫•t d·ªØ li·ªáu: ' + error.message);
      }
    }

    function cleanOldLogs() {
      if (!confirm('X√≥a logs c≈© h∆°n 30 ng√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.')) return;
      
      console.log('üßπ Cleaning old logs...');
      alert('üßπ ƒê√£ d·ªçn d·∫πp logs c≈© (Demo)');
      refreshLogs();
    }

    function resetSystem() {
      const confirmed = confirm('‚ö†Ô∏è C·∫¢NH B√ÅO: Reset to√†n b·ªô h·ªá th·ªëng s·∫Ω x√≥a T·∫§T C·∫¢ d·ªØ li·ªáu!\n\nB·∫°n c√≥ CH·∫ÆC CH·∫ÆN mu·ªën ti·∫øp t·ª•c?');
      if (!confirmed) return;
      
      const doubleConfirm = confirm('L·∫ßn x√°c nh·∫≠n cu·ªëi: B·∫°n c√≥ th·ª±c s·ª± mu·ªën RESET TO√ÄN B·ªò h·ªá th·ªëng?');
      if (!doubleConfirm) return;
      
      alert('‚ö†Ô∏è Ch·ª©c nƒÉng reset h·ªá th·ªëng ƒë√£ b·ªã v√¥ hi·ªáu h√≥a v√¨ l√Ω do an to√†n (Demo)');
    }

    // Log functions
    function refreshLogs() {
      console.log('üîÑ Refreshing logs...');
      loadSystemLogs();
    }

    function exportLogs() {
      console.log('üìä Exporting logs...');
      alert('üìä ƒê√£ xu·∫•t logs (Demo)');
    }

    function clearLogs() {
      if (!confirm('X√≥a t·∫•t c·∫£ logs hi·ªán t·∫°i?')) return;
      
      document.getElementById('logsContainer').innerHTML = '<div class="log-entry info">Logs ƒë√£ ƒë∆∞·ª£c x√≥a</div>';
      console.log('üóëÔ∏è Logs cleared');
    }

    // Auto refresh every 30 seconds
    setInterval(() => {
      updateServerTime();
      loadSystemStats();
    }, 30000);

    // Auto refresh logs every 2 minutes
    setInterval(loadSystemLogs, 120000);
    
    // Load admins list on page load
    loadAdminsList();
    
    // Change Password Modal Functions
    function openChangePasswordModal() {
      const modal = document.getElementById('changePasswordModal');
      if (modal) {
        modal.style.display = 'flex';
        document.getElementById('currentPassword').focus();
      }
    }
    
    function closeChangePasswordModal() {
      const modal = document.getElementById('changePasswordModal');
      if (modal) {
        modal.style.display = 'none';
        document.getElementById('changePasswordForm').reset();
      }
    }
    
    async function changeAdminPassword() {
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      // Validation
      if (!currentPassword || !newPassword || !confirmPassword) {
        alert('‚ùå Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin');
        return;
      }
      
      if (newPassword !== confirmPassword) {
        alert('‚ùå M·∫≠t kh·∫©u m·ªõi v√† x√°c nh·∫≠n kh√¥ng kh·ªõp');
        return;
      }
      
      if (newPassword.length < 8) {
        alert('‚ùå M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 8 k√Ω t·ª±');
        return;
      }
      
      try {
        // üîí C·∫¢NH B√ÅO B·∫¢O M·∫¨T NGHI√äM TR·ªåNG
        // Logic x√°c th·ª±c v√† thay ƒë·ªïi m·∫≠t kh·∫©u kh√¥ng bao gi·ªù ƒë∆∞·ª£c th·ª±c hi·ªán ·ªü ph√≠a client.
        // ƒêo·∫°n code n√†y ƒë√£ ƒë∆∞·ª£c v√¥ hi·ªáu h√≥a ƒë·ªÉ tr√°nh l·ªô m·∫≠t kh·∫©u.
        // B·∫†N C·∫¶N X√ÇY D·ª∞NG m·ªôt backend (v√≠ d·ª•: Firebase Functions) ƒë·ªÉ:
        // 1. X√°c th·ª±c m·∫≠t kh·∫©u c≈© m·ªôt c√°ch an to√†n.
        // 2. BƒÉm (hash) m·∫≠t kh·∫©u m·ªõi tr∆∞·ªõc khi l∆∞u v√†o c∆° s·ªü d·ªØ li·ªáu.
        
        alert('üîí Ch·ª©c nƒÉng n√†y c·∫ßn ƒë∆∞·ª£c x·ª≠ l√Ω ·ªü backend ƒë·ªÉ ƒë·∫£m b·∫£o an to√†n. Vui l√≤ng tham kh·∫£o t√†i li·ªáu v·ªÅ Firebase Functions.');
        return;

        // Log password change activity
        await db.ref('adminLogs').push({
          action: 'password_change',
          timestamp: Date.now(),
          adminId: 'admin@etax.vn',
          details: 'Admin password changed successfully'
        });
        
        alert('‚úÖ ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!\n‚ö†Ô∏è L∆∞u √Ω: C·∫ßn c·∫≠p nh·∫≠t m·∫≠t kh·∫©u m·ªõi trong code admin-panel-working.html');
        closeChangePasswordModal();
        
        console.log('üîê New admin password:', newPassword);
        console.log('üìù Please update ADMIN_CREDENTIALS in admin-panel-working.html');
        
      } catch (error) {
        console.error('‚ùå Error changing password:', error);
        alert('‚ùå L·ªói khi ƒë·ªïi m·∫≠t kh·∫©u: ' + error.message);
      }
    }
    
    // Admin Management Functions
    async function loadAdminsList() {
      try {
        const adminsSnapshot = await db.ref('admins').once('value');
        const admins = adminsSnapshot.val();
        const adminsList = document.getElementById('adminsList');
        
        if (!admins || Object.keys(admins).length === 0) {
          // Initialize with default admin if no admins exist
          await db.ref('admins').set({
            'admin@etax.vn': {
              username: 'admin@etax.vn', // üîí C·∫¢NH B√ÅO: M·∫≠t kh·∫©u kh√¥ng ƒë∆∞·ª£c l∆∞u d·∫°ng vƒÉn b·∫£n th√¥
              // C·∫ßn ƒë∆∞·ª£c bƒÉm v√† mu·ªëi (hashed and salted)
              password: 'eTax2024@Admin',
              role: 'super_admin',
              createdAt: Date.now(),
              createdBy: 'system',
              lastLogin: null,
              status: 'active'
            }
          });
          
          adminsList.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #f0f0f0;">
              <div>
                <strong>admin@etax.vn</strong> <span style="color: #28a745; font-size: 12px;">(Super Admin)</span><br>
                <small style="color: #666;">T·∫°o: System Default</small>
              </div>
              <span style="color: #28a745; font-weight: 500;">Active</span>
            </div>
          `;
        } else {
          let adminHTML = '';
          Object.keys(admins).forEach(adminId => {
            const admin = admins[adminId];
            const roleText = admin.role === 'super_admin' ? 'Super Admin' : 'Admin';
            const statusColor = admin.status === 'active' ? '#28a745' : '#dc3545';
            
            adminHTML += `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #f0f0f0;">
                <div>
                  <strong>${admin.username}</strong> <span style="color: #28a745; font-size: 12px;">(${roleText})</span><br>
                  <small style="color: #666;">T·∫°o: ${new Date(admin.createdAt).toLocaleDateString('vi-VN')}</small>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                  <span style="color: ${statusColor}; font-weight: 500;">${admin.status === 'active' ? 'Active' : 'Blocked'}</span>
                  ${admin.username !== 'admin@etax.vn' ? `<button onclick="toggleAdminStatus('${adminId}', '${admin.status}')" style="padding: 4px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px; background: ${admin.status === 'active' ? '#dc3545' : '#28a745'}; color: white;">${admin.status === 'active' ? 'Block' : 'Unblock'}</button>` : ''}
                </div>
              </div>
            `;
          });
          adminsList.innerHTML = adminHTML;
        }
      } catch (error) {
        console.error('‚ùå Error loading admins:', error);
        document.getElementById('adminsList').innerHTML = '<div style="color: #dc3545; text-align: center;">L·ªói khi t·∫£i danh s√°ch admin</div>';
      }
    }
    
    function openCreateAdminModal() {
      const modal = document.getElementById('createAdminModal');
      if (modal) {
        modal.style.display = 'flex';
        document.getElementById('adminUsername').focus();
      }
    }
    
    function closeCreateAdminModal() {
      const modal = document.getElementById('createAdminModal');
      if (modal) {
        modal.style.display = 'none';
        document.getElementById('createAdminForm').reset();
      }
    }
    
    async function createNewAdmin() {
      const username = document.getElementById('adminUsername').value.trim();
      const password = document.getElementById('adminPassword').value;
      const confirmPassword = document.getElementById('adminConfirmPassword').value;
      const fullName = document.getElementById('adminFullName').value.trim();
      
      // Validation
      if (!username || !password || !confirmPassword || !fullName) {
        alert('‚ùå Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin');
        return;
      }
      
      if (password !== confirmPassword) {
        alert('‚ùå M·∫≠t kh·∫©u v√† x√°c nh·∫≠n kh√¥ng kh·ªõp');
        return;
      }
      
      if (password.length < 8) {
        alert('‚ùå M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 8 k√Ω t·ª±');
        return;
      }
      
      if (!username.includes('@')) {
        alert('‚ùå Username ph·∫£i c√≥ ƒë·ªãnh d·∫°ng email');
        return;
      }
      
      try {
        // Check if admin already exists
        const existingAdmin = await db.ref(`admins/${username.replace('.', '_dot_')}`).once('value');
        if (existingAdmin.exists()) {
          alert('‚ùå Admin n√†y ƒë√£ t·ªìn t·∫°i trong h·ªá th·ªëng');
          return;
        }
        
        // Create new admin
        const adminData = {
          // üîí C·∫¢NH B√ÅO B·∫¢O M·∫¨T: M·∫≠t kh·∫©u kh√¥ng ƒë∆∞·ª£c l∆∞u d·∫°ng vƒÉn b·∫£n th√¥.
          // C·∫ßn g·ªçi Firebase Function ƒë·ªÉ bƒÉm (hash) m·∫≠t kh·∫©u n√†y tr∆∞·ªõc khi l∆∞u.
          // V√≠ d·ª•: passwordHash: await callFirebaseFunction('hashPassword', { password })
          username: username,
          password: password,
          fullName: fullName,
          role: 'admin',
          createdAt: Date.now(),
          createdBy: 'admin@etax.vn',
          lastLogin: null,
          status: 'active'
        };
        
        await db.ref(`admins/${username.replace('.', '_dot_')}`).set(adminData);
        
        // Log admin creation
        await db.ref('adminLogs').push({
          action: 'create_admin',
          timestamp: Date.now(),
          adminId: 'admin@etax.vn',
          targetAdmin: username,
          details: `Created new admin: ${fullName}`
        });
        
        alert('‚úÖ T·∫°o admin m·ªõi th√†nh c√¥ng!');
        closeCreateAdminModal();
        loadAdminsList();
        
      } catch (error) {
        console.error('‚ùå Error creating admin:', error);
        alert('‚ùå L·ªói khi t·∫°o admin: ' + error.message);
      }
    }
    
    async function toggleAdminStatus(adminId, currentStatus) {
      const newStatus = currentStatus === 'active' ? 'blocked' : 'active';
      const action = newStatus === 'active' ? 'unblock' : 'block';
      
      if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën ${action} admin n√†y?`)) return;
      
      try {
        await db.ref(`admins/${adminId}/status`).set(newStatus);
        
        // Log action
        await db.ref('adminLogs').push({
          action: `${action}_admin`,
          timestamp: Date.now(),
          adminId: 'admin@etax.vn',
          targetAdmin: adminId,
          details: `Admin ${action}ed successfully`
        });
        
        alert(`‚úÖ Admin ƒë√£ ƒë∆∞·ª£c ${action} th√†nh c√¥ng!`);
        loadAdminsList();
        
      } catch (error) {
        console.error('‚ùå Error toggling admin status:', error);
        alert('‚ùå L·ªói khi thay ƒë·ªïi tr·∫°ng th√°i admin: ' + error.message);
      }
    }
  </script>

  <!-- Change Password Modal -->
  <div id="changePasswordModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 2000;">
    <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h3 style="color: #b71c1c; margin: 0;">üîê ƒê·ªïi m·∫≠t kh·∫©u Admin</h3>
        <button onclick="closeChangePasswordModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
      </div>
      
      <form id="changePasswordForm" onsubmit="event.preventDefault(); changeAdminPassword();">
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">M·∫≠t kh·∫©u hi·ªán t·∫°i *</label>
          <input type="password" id="currentPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
        </div>
        
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">M·∫≠t kh·∫©u m·ªõi *</label>
          <input type="password" id="newPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi (t·ªëi thi·ªÉu 8 k√Ω t·ª±)" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
        </div>
        
        <div style="margin-bottom: 25px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi *</label>
          <input type="password" id="confirmPassword" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
        </div>
        
        <div style="display: flex; gap: 15px; justify-content: flex-end;">
          <button type="button" onclick="closeChangePasswordModal()" style="padding: 12px 24px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">H·ªßy</button>
          <button type="submit" style="padding: 12px 24px; background: #b71c1c; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">üîë ƒê·ªïi m·∫≠t kh·∫©u</button>
        </div>
      </form>
      
      <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
        <strong>‚ö†Ô∏è L∆∞u √Ω quan tr·ªçng:</strong><br>
        Sau khi ƒë·ªïi m·∫≠t kh·∫©u, b·∫°n c·∫ßn c·∫≠p nh·∫≠t m·∫≠t kh·∫©u m·ªõi trong file <code>admin-panel-working.html</code> ƒë·ªÉ c√≥ th·ªÉ ƒëƒÉng nh·∫≠p ƒë∆∞·ª£c.
      </div>
    </div>
  </div>

  <!-- Create Admin Modal -->
  <div id="createAdminModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 2000;">
    <div style="background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h3 style="color: #b71c1c; margin: 0;">üë®‚Äçüíº T·∫°o Admin m·ªõi</h3>
        <button onclick="closeCreateAdminModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
      </div>
      
      <form id="createAdminForm" onsubmit="event.preventDefault(); createNewAdmin();">
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Username (Email) *</label>
          <input type="email" id="adminUsername" placeholder="admin@company.com" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
        </div>
        
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">H·ªç v√† t√™n *</label>
          <input type="text" id="adminFullName" placeholder="Nguy·ªÖn VƒÉn A" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
        </div>
        
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">M·∫≠t kh·∫©u *</label>
          <input type="password" id="adminPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u (t·ªëi thi·ªÉu 8 k√Ω t·ª±)" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
        </div>
        
        <div style="margin-bottom: 25px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">X√°c nh·∫≠n m·∫≠t kh·∫©u *</label>
          <input type="password" id="adminConfirmPassword" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
        </div>
        
        <div style="display: flex; gap: 15px; justify-content: flex-end;">
          <button type="button" onclick="closeCreateAdminModal()" style="padding: 12px 24px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">H·ªßy</button>
          <button type="submit" style="padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">üë®‚Äçüíº T·∫°o Admin</button>
        </div>
      </form>
      
      <div style="margin-top: 20px; padding: 15px; background: #d4edda; border-radius: 8px; border-left: 4px solid #28a745;">
        <strong>‚ÑπÔ∏è Th√¥ng tin:</strong><br>
        Admin m·ªõi s·∫Ω c√≥ quy·ªÅn t∆∞∆°ng ƒë∆∞∆°ng v√† c√≥ th·ªÉ ƒëƒÉng nh·∫≠p v√†o admin panel v·ªõi username/password v·ª´a t·∫°o.
      </div>
    </div>
  </div>
</body>
</html>