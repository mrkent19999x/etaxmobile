<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#b71c1c">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<title>eTax Mobile - ƒêƒÉng nh·∫≠p</title>

<style>
/* General Styles */
body, html {
    margin: 0; padding: 0; font-family: 'Roboto', sans-serif; color: white;
    height: 100%; width: 100%; overflow: hidden; background: #000;
}
.phone-frame {
    width: 100%; height: 100%; background-image: url('assets/bglogin.png');
    background-size: cover; background-position: center; display: flex;
    flex-direction: column; align-items: center; padding: 20px;
}
.logo-wrapper { text-align: center; margin-top: 60px; margin-bottom: 40px; }
.logo { width: 120px; }
.title { font-size: 22px; font-weight: 500; letter-spacing: 2px; }
.login-form { width: 100%; max-width: 340px; }
.form-group { position: relative; margin-bottom: 25px; }
.form-group input {
    width: 100%; padding: 12px 12px 12px 45px; border: none;
    border-bottom: 2px solid rgba(255,255,255,0.4); background: transparent;
    color: white; font-size: 16px;
}
.form-group input:focus { outline: none; border-bottom-color: white; }
.input-icon-wrap { position: relative; }
.input-icon-wrap i {
    position: absolute; left: 15px; top: 50%;
    transform: translateY(-50%); color: rgba(255,255,255,0.7);
}
#togglePassword { left: auto; right: 15px; cursor: pointer; }
.btn-login {
    width: 100%; padding: 15px; background-color: #B71C1C; border: none;
    border-radius: 25px; color: white; font-size: 18px; font-weight: bold; cursor: pointer;
}
.btn-login.loading { opacity: 0.7; cursor: not-allowed; }
.error-msg {
    background: rgba(244, 67, 54, 0.9); color: white; padding: 12px;
    border-radius: 8px; text-align: center; margin-bottom: 15px; display: none;
}

/* Debug Panel Styles */
#debugPanel {
    position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8);
    border: 1px solid #ffc107; border-radius: 8px; color: #fff;
    font-family: monospace; font-size: 12px; z-index: 9999; width: 350px;
    display: none; /* Initially hidden */
}
#debugHeader {
    background: #ffc107; color: #000; padding: 5px 10px;
    font-weight: bold; cursor: pointer; display: flex; justify-content: space-between;
}
#debugContent { padding: 10px; max-height: 200px; overflow-y: auto; }
.debug-item { border-bottom: 1px dashed #444; padding: 3px 0; }
.debug-key { color: #ffc107; }
</style>

</head>
<body>
    <div class="phone-frame">
        <div class="logo-wrapper">
            <img src="assets/logo.png" alt="Logo Thu·∫ø" class="logo" />
            <h1 class="title">eTax Mobile</h1>
        </div>

        <form class="login-form" id="loginForm">
            <div class="error-msg" id="errorMsg"></div>

            <div class="form-group">
                <div class="input-icon-wrap">
                    <i class="fa-solid fa-user-large"></i>
                    <input type="text" id="tax-id" placeholder="M√£ s·ªë thu·∫ø" autocomplete="username" readonly />
                </div>
            </div>
            <div class="form-group">
                <div class="input-icon-wrap">
                    <i class="fa-solid fa-lock"></i>
                    <input type="password" id="password" placeholder="M·∫≠t kh·∫©u" autocomplete="current-password" />
                    <i class="fa-solid fa-eye" id="togglePassword" onclick="togglePassword()"></i>
                </div>
            </div>
            
            <button type="submit" class="btn-login" id="loginBtn">ƒêƒÉng nh·∫≠p</button>
        </form>
    </div>

    <!-- Debug Panel HTML -->
    <div id="debugPanel">
        <div id="debugHeader">
            <span>üêû B·∫£ng ƒëi·ªÅu khi·ªÉn Debug</span>
            <span id="toggleDebug">[·∫®n]</span>
        </div>
        <div id="debugContent"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

    <script>
        // ===== DEBUG PANEL LOGIC =====
        const debugPanel = document.getElementById('debugPanel');
        const debugContent = document.getElementById('debugContent');
        const debugHeader = document.getElementById('debugHeader');
        const toggleDebug = document.getElementById('toggleDebug');

        // Show panel if #debug is in URL
        if(window.location.hash === '#debug') {
            debugPanel.style.display = 'block';
        }

        debugHeader.onclick = () => {
            const content = document.getElementById('debugContent');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggleDebug.textContent = '[·∫®n]';
            } else {
                content.style.display = 'none';
                toggleDebug.textContent = '[Hi·ªán]';
            }
        };

        function updateDebug(key, value) {
            const item = document.createElement('div');
            item.className = 'debug-item';
            item.innerHTML = `<span class="debug-key">${key}:</span> ${value}`;
            debugContent.appendChild(item);
            debugContent.scrollTop = debugContent.scrollHeight;
        }

        // ===== FIREBASE CONFIG =====
        const firebaseConfig = {
            apiKey: "AIzaSyD_rJgBFgBulheVenQUE2KXr4PBpSpTCxw",
            authDomain: "etax-7fbf8.firebaseapp.com",
            databaseURL: "https://etax-7fbf8-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "etax-7fbf8",
            storageBucket: "etax-7fbf8.appspot.com",
            messagingSenderId: "1030026724634",
            appId: "1:1030026724634:web:d76f5f9dad43bad6fd58a3"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let validMST = null; // Stores the MST validated by the token

        // ===== MAIN INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            initializeLoginPage();
        });

        async function initializeLoginPage() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            updateDebug('Token t·ª´ URL', token || 'Kh√¥ng c√≥');

            if (!token) {
                showError("ƒê∆∞·ªùng d·∫´n ƒëƒÉng nh·∫≠p kh√¥ng h·ª£p l·ªá. Vui l√≤ng s·ª≠ d·ª•ng link ƒë∆∞·ª£c cung c·∫•p.");
                disableForm();
                return;
            }

            try {
                const tokenSnapshot = await db.ref('loginTokens/' + token).once('value');
                if (!tokenSnapshot.exists()) {
                    showError("Link ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n ho·∫∑c kh√¥ng t·ªìn t·∫°i.");
                    updateDebug('Tr·∫°ng th√°i Token', 'Kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng t·ªìn t·∫°i');
                    disableForm();
                    return;
                }

                validMST = tokenSnapshot.val().mst;
                updateDebug('MST h·ª£p l·ªá t·ª´ Token', validMST);
                
                document.getElementById('tax-id').value = validMST;
                document.getElementById('password').focus();

                setupLoginForm();

            } catch (error) {
                console.error("Token validation error:", error);
                showError("L·ªói x√°c th·ª±c link. Vui l√≤ng th·ª≠ l·∫°i.");
                updateDebug('L·ªói x√°c th·ª±c Token', error.message);
                disableForm();
            }
        }

        function setupLoginForm() {
            const form = document.getElementById('loginForm');
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                login();
            });
        }

        async function login() {
            const taxId = document.getElementById('tax-id').value.trim();
            const password = document.getElementById('password').value.trim();
            updateDebug('Input MST', taxId);
            updateDebug('Input Password', '***'); // Masked for security

            if (taxId !== validMST) {
                showError("MST kh√¥ng h·ª£p l·ªá cho ƒë∆∞·ªùng d·∫´n n√†y.");
                return;
            }

            if (!password) {
                showError("Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u.");
                return;
            }

            const loginBtn = document.getElementById('loginBtn');
            loginBtn.classList.add('loading');
            loginBtn.textContent = 'ƒêang ƒëƒÉng nh·∫≠p...';

            try {
                const userSnapshot = await db.ref('users/' + taxId).once('value');
                if (!userSnapshot.exists()) {
                    updateDebug('L·ªói', 'T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i trong /users/');
                    throw new Error("T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i.");
                }

                const userData = userSnapshot.val();
                updateDebug('M·∫≠t kh·∫©u t·ª´ Firebase', userData.password ? '***' : 'Kh√¥ng c√≥');

                if (userData.password !== password) {
                    updateDebug('So s√°nh m·∫≠t kh·∫©u', 'Th·∫•t b·∫°i');
                    throw new Error("M·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c.");
                }

                updateDebug('So s√°nh m·∫≠t kh·∫©u', 'Th√†nh c√¥ng');
                console.log(`‚úÖ Login successful for: ${userData.fullName}`);

                // Store session info
                localStorage.setItem('etax_logged_in_user', taxId);
                localStorage.setItem('etax_user_info', JSON.stringify(userData));

                // Redirect to index page
                window.location.href = 'index.html';

            } catch (error) {
                showError(error.message);
                updateDebug('L·ªói ƒëƒÉng nh·∫≠p', error.message);
            } finally {
                loginBtn.classList.remove('loading');
                loginBtn.textContent = 'ƒêƒÉng nh·∫≠p';
            }
        }

        function showError(message) {
            const errorMsg = document.getElementById('errorMsg');
            errorMsg.textContent = message;
            errorMsg.style.display = 'block';
        }

        function disableForm() {
            document.getElementById('tax-id').disabled = true;
            document.getElementById('password').disabled = true;
            document.getElementById('loginBtn').disabled = true;
        }

        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const toggleIcon = document.getElementById('togglePassword');
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        }

    </script>
</body>
</html>