<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!-- ===== PWA META TAGS HO√ÄN CH·ªàNH ===== -->
<!-- Viewport chu·∫©n cho PWA -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

<!-- PWA Manifest -->
<link rel="manifest" href="./manifest.json">

<!-- Theme colors -->
<meta name="theme-color" content="#b71c1c">
<meta name="msapplication-navbutton-color" content="#b71c1c">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<!-- Apple PWA Settings -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="eTax Mobile">

<!-- Apple Touch Icons -->
<link rel="apple-touch-icon" href="./assets/logo.png">
<link rel="apple-touch-icon" sizes="152x152" href="./assets/logo.png">
<link rel="apple-touch-icon" sizes="180x180" href="./assets/logo.png">
<link rel="apple-touch-icon" sizes="167x167" href="./assets/logo.png">

<!-- Splash Screen Images cho iOS -->
<link rel="apple-touch-startup-image" href="./assets/splash-2048x2732.png" sizes="2048x2732">
<link rel="apple-touch-startup-image" href="./assets/splash-1668x2224.png" sizes="1668x2224">
<link rel="apple-touch-startup-image" href="./assets/splash-1536x2048.png" sizes="1536x2048">
<link rel="apple-touch-startup-image" href="./assets/splash-1125x2436.png" sizes="1125x2436">
<link rel="apple-touch-startup-image" href="./assets/splash-1242x2208.png" sizes="1242x2208">
<link rel="apple-touch-startup-image" href="./assets/splash-750x1334.png" sizes="750x1334">
<link rel="apple-touch-startup-image" href="./assets/splash-640x1136.png" sizes="640x1136">

<!-- Microsoft PWA -->
<meta name="msapplication-starturl" content="./index.html">
<meta name="msapplication-TileColor" content="#b71c1c">
<meta name="msapplication-TileImage" content="./assets/logo.png">

<!-- T·∫Øt s·ªë ƒëi·ªán tho·∫°i t·ª± ƒë·ªông link -->
<meta name="format-detection" content="telephone=no">
<meta name="format-detection" content="email=no">
<meta name="format-detection" content="address=no">

<!-- Security headers -->
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">

<!-- CSS fixes cho PWA -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<!-- JavaScript cho PWA -->
<script>
// ƒêƒÉng k√Ω Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('./sw.js')
      .then(function(registration) {
        console.log('‚úÖ ServiceWorker registered successfully');
      })
      .catch(function(error) {
        console.log('‚ùå ServiceWorker registration failed');
      });
  });
}

// T·∫Øt context menu
document.addEventListener('contextmenu', function(e) {
  e.preventDefault();
});

// T·∫Øt drag
document.addEventListener('dragstart', function(e) {
  e.preventDefault();
});

// Kh·∫Øc ph·ª•c iOS Safari swipe back
document.addEventListener('touchstart', function(e) {
  if (e.touches.length > 1) {
    e.preventDefault();
  }
});

let lastTouchEnd = 0;
document.addEventListener('touchend', function(e) {
  const now = (new Date()).getTime();
  if (now - lastTouchEnd <= 300) {
    e.preventDefault();
  }
  lastTouchEnd = now;
}, false);

// Kh·∫Øc ph·ª•c double tap zoom
let lastTouchTime = 0;
document.addEventListener('touchstart', function(e) {
  const now = Date.now();
  if (now - lastTouchTime <= 500) {
    e.preventDefault();
  }
  lastTouchTime = now;
});

// T·∫Øt pull to refresh
let startY = 0;
document.addEventListener('touchstart', function(e) {
  startY = e.touches[0].clientY;
});

document.addEventListener('touchmove', function(e) {
  const y = e.touches[0].clientY;
  if (startY <= 10 && y > startY) {
    e.preventDefault();
  }
});

// Kh·∫Øc ph·ª•c viewport height cho mobile
function setViewportHeight() {
  const vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', vh + 'px');
}

window.addEventListener('resize', setViewportHeight);
window.addEventListener('orientationchange', function() {
  setTimeout(setViewportHeight, 500);
});
setViewportHeight();

// Orientation lock warning
function checkOrientation() {
  if (window.innerHeight < 500 && window.innerWidth > window.innerHeight) {
    document.body.classList.add('landscape-mode');
  } else {
    document.body.classList.remove('landscape-mode');
  }
}

window.addEventListener('orientationchange', function() {
  setTimeout(checkOrientation, 500);
});
window.addEventListener('resize', checkOrientation);
checkOrientation();
</script>

<!-- CSS cho orientation warning -->
<style>
.landscape-mode .orientation-warning {
  display: flex !important;
}

.orientation-warning {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: #b71c1c;
  color: white;
  align-items: center;
  justify-content: center;
  text-align: center;
  z-index: 10000;
  font-size: 18px;
  padding: 20px;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
}

.landscape-mode .phone-frame,
.landscape-mode .app-container,
.landscape-mode .main-container {
  display: none !important;
}
</style>

<!-- üîß QUAN TR·ªåNG: Script ch·∫∑n v√≤ng l·∫∑p -->
<script>
    // üö® ANTI-LOOP PROTECTION - CH·∫†Y NGAY L·∫¨P T·ª®C
    window.PREVENT_TOKEN_REDIRECT = true;
    window.skipDeviceCheckOnLogin = true;
    window.loginPageLoaded = true;
    
    // X√≥a m·ªçi flag c√≥ th·ªÉ g√¢y redirect
    try {
        localStorage.removeItem('etax_redirect_from_token_login');
        localStorage.setItem('etax_login_page_protection', 'true');
        console.log('üõ°Ô∏è ANTI-LOOP: Protection activated');
    } catch (e) {
        console.warn('localStorage access denied');
    }
</script>

<title>eTax Mobile - ƒêƒÉng nh·∫≠p</title>

<style>
body {
    margin: 0;
    padding: 0;
    font-family: 'Roboto', sans-serif;
    color: white;
    min-height: 100vh;
    background-position: center center;
    overflow-y: auto;
    /* ‚úÖ B·ªè animation fadeIn */
}
/* ‚úÖ B·ªè keyframes fadeIn */
/* @keyframes fadeIn {
    0% { opacity: 0; }
    100% { opacity: 1; }
} */
* {
    -webkit-tap-highlight-color: transparent;
    box-sizing: border-box;
}
.container {
    width: 100%;
    max-width: 420px;
    margin: 0 auto;
    padding: 24px 16px;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    min-height: 100vh;
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(2px);
    /* ‚úÖ B·ªè animation fadeIn */
}
/* 2Ô∏è‚É£ LOGO + T√äN APP - V·ªã tr√≠ ~60-250px, chi·ªÅu cao ~190px */
.logo-wrapper { 
    text-align: center; 
    height: 190px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    margin-top: 0;
    margin-bottom: 0;
}
.logo { 
    width: 120px; /* ‚úÖ Nh·ªè h∆°n t·ª´ 160px ‚Üí 120px */
    height: 120px;
    margin-bottom: 8px; 
}
.title { 
    font-size: 21.5px; /* ‚úÖ TƒÉng th√™m 0.5 */
    font-weight: 500; 
    letter-spacing: 2px;
    color: white;
}
/* 3Ô∏è‚É£ FORM ƒêƒÇNG NH·∫¨P - V·ªã tr√≠ ~250-950px, chi·ªÅu cao ~700px */
.login-form { 
    display: flex; 
    flex-direction: column; 
    gap: 14px; /* ‚úÖ TƒÉng gap cho spacing h·ª£p l√Ω */
    align-items: stretch; 
    /* ‚úÖ B·ªè animation fadeIn */
    height: 520px; /* ‚úÖ TƒÉng chi·ªÅu cao ƒë·ªÉ ch·ª©a register */
    justify-content: flex-start;
    padding: 20px 12px; /* ‚úÖ TƒÉng padding top ƒë·ªÉ l√πi xu·ªëng 1 ch√∫t */
}
.form-group { 
    display: flex; 
    flex-direction: column; 
    align-items: flex-start; 
    position: relative; 
    margin-bottom: 12px; /* ‚úÖ D·ªìn th√™m margin l√™n */
}
.form-group label { 
    font-size: 15.5px; /* ‚úÖ Kh√¥i ph·ª•c size chu·∫©n + th√™m 0.5 */
    margin-bottom: 8px; 
    color: #fff; /* ‚úÖ M√†u tr·∫Øng r√µ r√†ng */
    padding-left: 0; /* ‚úÖ B·ªè padding */
    position: relative; /* ‚úÖ Kh√¥i ph·ª•c position b√¨nh th∆∞·ªùng */
    pointer-events: auto;
    display: block;
}
.form-group input {
    width: 100%; 
    height: 52px; /* ‚úÖ Gi·∫£m chi·ªÅu cao ƒë·ªÉ ti·∫øt ki·ªám kh√¥ng gian */
    padding: 16px 25px 16px 50px; /* ‚úÖ Gi·∫£m padding ƒë·ªÉ ti·∫øt ki·ªám kh√¥ng gian */
    border: none; /* ‚úÖ B·ªè vi·ªÅn khung */
    border-bottom: 2px solid rgba(255,255,255,0.4); /* ‚úÖ Gi·∫£m ƒë·ªô s√°ng ƒë∆∞·ªùng k·∫ª tr·∫Øng */
    border-radius: 0; /* ‚úÖ B·ªè bo g√≥c */
    font-size: 16px; /* ‚úÖ C·ª° ch·ªØ 16px cho input */
    background-color: transparent; /* ‚úÖ Trong su·ªët ho√†n to√†n */
    color: white; 
    outline: none;
    transition: none; /* ‚úÖ B·ªè t·∫•t c·∫£ transition */
    font-family: 'Roboto', Arial, sans-serif; /* ‚úÖ Font Roboto/Arial */
}

/* ‚úÖ Hi·ªáu ·ª©ng focus cho input - B·ªè l·ªõp ph·ªß box */
.form-group input:focus {
    border-bottom: 2px solid rgba(255,255,255,0.6); /* ‚úÖ Gi·∫£m ƒë·ªô s√°ng khi focus */
    background-color: transparent; /* ‚úÖ B·ªè l·ªõp ph·ªß box khi click */
    box-shadow: none; /* ‚úÖ B·ªè shadow */
    outline: none; /* ‚úÖ B·ªè outline */
    transition: none; /* ‚úÖ B·ªè transition */
}
.form-group#tax-id-group::before {
    content: url('assets/21dc87d0-adfd-4596-84d1-7012dd2c3e79.png');
    position: absolute; left: 15px; top: 44px; /* ‚úÖ ƒêi·ªÅu ch·ªânh v·ªã tr√≠ icon theo input m·ªõi */
}
.form-group.password-group::before {
    content: url('assets/8ff693cf-2a7e-4c27-8a56-501e094951ed.png');
    position: absolute; left: 15px; top: 44px; /* ‚úÖ ƒêi·ªÅu ch·ªânh v·ªã tr√≠ icon theo input m·ªõi */
}

/* ‚úÖ TEXT PH·ª§: Qu√™n t√†i kho·∫£n/m·∫≠t kh·∫©u - Font ~14px, m√†u v√†ng neon */
.links { 
    display: flex; 
    justify-content: space-between; 
    font-size: 14px; /* ‚úÖ C·ª° ch·ªØ 14px theo y√™u c·∫ßu */
    color: #FFD700; /* ‚úÖ M√†u v√†ng kim FFD700 */
    margin: 10px 0 14px; /* ‚úÖ D·ªìn th√™m l√™n */
    padding: 0 5px;
    font-family: 'Roboto', Arial, sans-serif; /* ‚úÖ Font Roboto/Arial */
}
.links a { 
    color: #FFD700; /* ‚úÖ M√†u v√†ng kim FFD700 */
    text-decoration: none; 
    transition: none; /* ‚úÖ B·ªè transition */
    font-weight: normal; /* ‚úÖ Kh√¥ng in ƒë·∫≠m cho links qu√™n */
}
.links a:hover {
    /* ‚úÖ B·ªè hover effect ƒë·ªÉ tr√°nh lag */
}
.btn-login {
    background-color: #FF0000; color: #fff; padding: 12px 24px; font-size: 18px; /* ‚úÖ M√†u ƒë·ªè thu·∫ßn FF0000, c·ª° ch·ªØ 18px */
    border: none; border-radius: 25px; font-weight: bold; position: relative;
    width: 70%; /* ‚úÖ Thu nh·ªè th√™m chi·ªÅu ngang */
    max-width: 260px; /* ‚úÖ Gi·ªõi h·∫°n width nh·ªè h∆°n */
    margin: 0 auto; /* ‚úÖ CƒÉn gi·ªØa */
    display: block;
    height: 48px; /* ‚úÖ ƒê·ªãnh chi·ªÅu cao */
    font-family: 'Roboto', Arial, sans-serif; /* ‚úÖ Font Roboto/Arial */
}
/* ‚úÖ B·ªè icon FaceID trong n√∫t ƒëƒÉng nh·∫≠p */
/* .btn-login::after removed */

/* 5Ô∏è‚É£ ƒêƒÇNG NH·∫¨P QUA ƒê·ªäNH DANH - V·ªã tr√≠ ~1040-1140px, chi·ªÅu cao ~100px */
.btn-id { 
    display: flex; 
    align-items: center; 
    justify-content: space-between; /* ‚úÖ Kh√¥i ph·ª•c space-between */
    background: #fff;
    border-radius: 0; /* ‚úÖ B·ªè bo tr√≤n, ƒë·ªÉ 4 c·∫°nh vu√¥ng */
    padding: 12px 16px; /* ‚úÖ Gi·∫£m padding ƒë·ªÉ ti·∫øt ki·ªám kh√¥ng gian */
    color: #000; 
    gap: 8px; 
    margin: 16px 0; /* ‚úÖ C√¢n b·∫±ng margin */
    height: 80px; /* ‚úÖ Gi·∫£m chi·ªÅu cao ƒë·ªÉ ti·∫øt ki·ªám kh√¥ng gian */
}
/* ‚úÖ Text trong VNeID section */
.text-box { 
    display: flex; 
    flex-direction: column; 
    flex-grow: 1; 
    justify-content: center;
}
.line1 { 
    font-size: 16px; /* ‚úÖ C·ª° ch·ªØ 16px cho VNeID */
    text-align: center; /* ‚úÖ CƒÉn gi·ªØa */
    line-height: 1.3;
    color: #000 !important; /* ‚úÖ ƒê·∫£m b·∫£o m√†u ƒëen hi·ªÉn th·ªã */
    font-weight: normal !important;
    font-family: 'Roboto', Arial, sans-serif; /* ‚úÖ Font Roboto/Arial */
}

.line2 { 
    font-size: 16px; /* ‚úÖ C·ª° ch·ªØ 16px cho VNeID */
    text-align: center; /* ‚úÖ CƒÉn gi·ªØa */
    line-height: 1.3;
    color: #000 !important; /* ‚úÖ ƒê·∫£m b·∫£o m√†u ƒëen hi·ªÉn th·ªã */
    font-weight: normal !important; /* ‚úÖ Kh√¥ng in ƒë·∫≠m */
    margin-top: 2px;
    font-family: 'Roboto', Arial, sans-serif; /* ‚úÖ Font Roboto/Arial */
}
.line2 { 
    font-weight: normal; /* ‚úÖ B·ªè in ƒë·∫≠m */
    margin-top: 2px; 
}
.icon-wrap img { 
    width: 50px; /* ‚úÖ Icon VNeID cao ~50px */
    height: 50px; 
    object-fit: contain; 
}

/* ‚úÖ ƒêƒÇNG K√ù TEXT */
.register { 
    text-align: center; 
    font-size: 14px; /* ‚úÖ C·ª° ch·ªØ 14px theo y√™u c·∫ßu */
    margin: 16px 0; /* ‚úÖ Kho·∫£ng c√°ch c√¢n b·∫±ng v·ªõi Button ‚Üí VNeID */
    color: white;
    font-family: 'Roboto', Arial, sans-serif; /* ‚úÖ Font Roboto/Arial */
}
.register a { 
    color: #FFD700; /* ‚úÖ M√†u v√†ng kim FFD700 */
    text-decoration: none; 
    font-weight: bold; /* ‚úÖ In ƒë·∫≠m Ctrl+B */
}

/* 6Ô∏è‚É£ C√ÅC N√öT CH·ª®C NƒÇNG D∆Ø·ªöI C√ôNG - V·ªã tr√≠ ~1150-1350px, chi·ªÅu cao ~200px */
.bottom-nav { 
    display: flex; 
    justify-content: space-around; 
    align-items: center;
    font-size: 12.5px; /* ‚úÖ TƒÉng th√™m 0.5 */
    padding: 2px 6px; /* ‚úÖ D·ªìn th√™m l√™n n·ªØa */
    height: 75px; /* ‚úÖ Thu nh·ªè th√™m */
    margin-bottom: 4px; /* ‚úÖ D·ªìn l√™n */
    background: transparent; /* ‚úÖ B·ªè m√†u v√†ng ph·ªß */
    border-radius: 15px;
    margin: 8px 20px 4px; /* ‚úÖ D·ªìn th√™m l√™n t·ª´ register */
    position: relative;
    bottom: 0; /* ‚úÖ ƒê·∫£m b·∫£o n·∫±m ·ªü d∆∞·ªõi c√πng */
}
.bottom-nav div { 
    text-align: center; 
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}
.bottom-nav img { 
    width: 36px; /* ‚úÖ Gi·∫£m size icon ƒë·ªÉ fit t·ªët h∆°n */
    height: 36px; 
    margin-bottom: 6px; /* ‚úÖ Gi·∫£m margin */
    filter: brightness(0) invert(1); /* L√†m icon tr·∫Øng */
}
.input-icon-wrap { position: relative; width: 100%; display: flex; align-items: center; }
/* ‚úÖ ICONS TRONG INPUT - Size 16-20px theo chu·∫©n */
.input-icon-wrap i.fa-user-large, .input-icon-wrap i.fa-lock {
    position: absolute; 
    left: 18px; /* ‚úÖ ƒêi·ªÅu ch·ªânh v·ªã tr√≠ */
    color: rgba(255,255,255,0.7); 
    font-size: 18px; /* ‚úÖ Size 16-20px */
    top: 50%; 
    transform: translateY(-50%); 
    z-index: 2;
}
.input-icon-wrap i.fa-eye, .input-icon-wrap i.fa-eye-slash {
    position: absolute; 
    right: 18px; 
    color: rgba(255,255,255,0.7); 
    font-size: 18px; 
    top: 50%; 
    transform: translateY(-50%); 
    z-index: 2; 
    cursor: pointer;
}
.input-icon-wrap input { padding-left: 44px; padding-right: 44px; }

html, body {
    margin: 0 !important;
    padding: 0 !important;
    min-height: 100vh;
    min-width: 100vw;
    width: 100vw;
    height: 100vh;
    background: #000 !important; /* Gi·ªØ n·ªÅn ƒëen ph·ªß k√≠n to√†n m√†n h√¨nh */
    box-sizing: border-box;
    overflow: hidden !important; /* üîí KH√ìA T·∫§T C·∫¢ SCROLL */
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: center;
    /* üîí KH√ìA XOAY NGANG */
    transform-origin: center center;
}

/* ƒê·∫£m b·∫£o kh√¥ng l·∫∑p l·∫°i vi·ªÅn tr·∫Øng ·ªü m·ªçi k√≠ch th∆∞·ªõc */
body {
    padding: 0 !important;
    min-height: 100vh;
    min-width: 100vw;
    width: 100vw;
    height: 100vh;
    box-sizing: border-box;
    background: #000 !important;
    /* üîí FORCE KH√ìA ORIENTATION */
    position: fixed;
    top: 0;
    left: 0;
}

/* üìê eTAX MOBILE LAYOUT CHU·∫®N - T·ª∑ l·ªá 9:19.5 (iPhone X/11/12) */
.phone-frame {
    width: 100vw !important;
    background-image: url('assets/bglogin.png');
    background-size: cover;
    background-repeat: no-repeat;
    background-position: center center;
    border-radius: 0 !important; /* Kh√¥ng bo g√≥c tr√™n mobile */
    margin: 0 auto !important;
    box-shadow: none !important;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: stretch;
    /* ‚úÖ PWA Mobile enhancements */
    min-height: 100vh;
    max-height: 100vh;
    height: 100vh;
    position: relative;
    /* ‚úÖ Safe area support */
    padding-top: env(safe-area-inset-top, 60px); /* 1Ô∏è‚É£ Top System Bar ~60px */
    padding-bottom: env(safe-area-inset-bottom, 20px);
    padding-left: env(safe-area-inset-left, 28px); /* ‚úÖ TƒÉng padding ƒë·ªÉ sang ngang h∆°n */
    padding-right: env(safe-area-inset-right, 28px); /* ‚úÖ TƒÉng padding ƒë·ªÉ sang ngang h∆°n */
}

/* ‚úÖ TH√äM: iOS fallback cho safe areas */
@supports (-webkit-touch-callout: none) {
    .phone-frame {
        padding-top: constant(safe-area-inset-top, 0px);
        padding-bottom: constant(safe-area-inset-bottom, 0px);
        padding-left: constant(safe-area-inset-left, 0px);
        padding-right: constant(safe-area-inset-right, 0px);
    }
}

@media (min-width: 601px) {
    /* Bo g√≥c, b√≥ng khi desktop cho gi·ªëng app preview */
    .phone-frame {
        margin: 32px auto !important;
        box-shadow: 0 0 20px rgba(0,0,0,0.3) !important;
        width: 400px !important;
        height: 900px !important;
        max-height: 900px !important;
        border-radius: 30px !important;
    }
}

/* S·ª≠a l·∫°i n√∫t ƒêƒÉng nh·∫≠p kh√¥ng b·ªã k√©o d√†i 100vw */
.btn-login {
    width: 100%;
    max-width: 340px;
    margin: 0 auto;
    display: block;
    /* ‚úÖ TH√äM: Touch-friendly sizing */
    min-height: 48px;
    cursor: pointer;
    transition: all 0.2s ease;
}

/* ‚úÖ TH√äM: Enhanced button interaction */
.btn-login:active {
    transform: scale(0.98);
    background-color: #330000 !important; /* ‚úÖ ƒê·ªè ƒë·∫≠m h∆°n n·ªØa khi active */
}

/* C√°c input, block kh√°c ch·ªâ theo chi·ªÅu r·ªông c·ªßa app */
.login-form, .container {
    width: 100%;
    max-width: 400px; /* ‚úÖ TƒÉng th√™m width ƒë·ªÉ r·ªông h∆°n n·ªØa */
    margin: 0 auto;
    padding: 0 16px; /* ‚úÖ TƒÉng padding ƒë·ªÉ sang ngang h∆°n */
}

/* ‚úÖ TH√äM: Enhanced input styles cho mobile */
.form-group input {
    /* Prevent zoom on iOS */
    font-size: 16px !important;
    /* Remove iOS default styling */
    -webkit-appearance: none;
    appearance: none;
    /* Better touch interaction */
    min-height: 44px;
    box-sizing: border-box;
}

/* üéØ SUCCESS MESSAGE STYLES */
.success-banner {
    background: linear-gradient(45deg, #4CAF50, #45a049);
    color: white;
    padding: 16px 20px;
    border-radius: 12px;
    margin-bottom: 30px;
    text-align: center;
    box-shadow: 0 4px 20px rgba(76, 175, 80, 0.3);
    animation: slideInDown 0.6s ease-out;
}

@keyframes slideInDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.success-banner .icon {
    font-size: 24px;
    margin-bottom: 8px;
    display: block;
}

.success-banner .message {
    font-size: 16px;
    font-weight: 500;
}

/* ‚úÖ TH√äM: Loading states */
.btn-login.loading {
    opacity: 0.7;
    pointer-events: none;
}

.btn-login.loading::before {
    content: '';
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top: 2px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 8px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* ‚úÖ TH√äM: Error/Success message styles */
.message {
    margin: 10px auto;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 14px;
    text-align: center;
    display: none;
    max-width: 340px;
    animation: slideIn 0.3s ease-out;
}

.error-msg {
    background: rgba(244, 67, 54, 0.9);
    color: white;
    border: 1px solid rgba(244, 67, 54, 0.5);
}

.success-msg {
    background: rgba(76, 175, 80, 0.9);
    color: white;
    border: 1px solid rgba(76, 175, 80, 0.5);
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* ‚úÖ TH√äM: Enhanced responsive breakpoints */

/* iPhone SE v√† m√†n h√¨nh nh·ªè */
@media screen and (max-width: 375px) {
    .phone-frame {
        max-width: 375px;
    }
    
    .container {
        padding: 20px 12px;
        max-width: 340px;
    }
    
    .logo {
        width: 70px;
    }
    
    .title {
        font-size: 18px;
    }
    
    .login-form {
        max-width: 320px;
    }
}

/* ‚úÖ TH√äM: iPhone 12/13/14 */
@media screen and (max-width: 390px) {
    .phone-frame {
        max-width: 390px;
    }
}

/* ‚úÖ TH√äM: iPhone XR/11 */
@media screen and (max-width: 414px) {
    .phone-frame {
        max-width: 414px;
    }
}

/* ‚úÖ TH√äM: M√†n h√¨nh nh·ªè chi·ªÅu cao */
@media screen and (max-height: 700px) {
    .logo-wrapper {
        margin-top: 20px;
        margin-bottom: 8px;
    }
    
    .logo {
        width: 70px;
    }
    
    .title {
        font-size: 18px;
    }
    
    .container {
        padding: 16px 12px;
    }
    
    .login-form {
        gap: 12px;
    }
}

/* ‚úÖ X√ìA: Landscape orientation support - PWA t·ª± handle */

/* ‚úÖ TH√äM: Enhanced touch interactions */
.btn-id:active {
    transform: scale(0.98);
    background: #f0f0f0;
}

.links a:active {
    opacity: 0.7;
}

.input-icon-wrap i.fa-eye:active,
.input-icon-wrap i.fa-eye-slash:active {
    transform: translateY(-50%) scale(0.9);
}

/* ‚úÖ TH√äM: Enhanced accessibility */
@media (prefers-reduced-motion: reduce) {
    * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

/* ‚úÖ TH√äM: High contrast support */
@media (prefers-contrast: high) {
    .form-group input {
        border-bottom: 2px solid white;
    }
    
    .btn-login {
        border: 2px solid white;
    }
}

/* ‚úÖ TH√äM: Dark mode support (n·∫øu user thi·∫øt l·∫≠p) */
@media (prefers-color-scheme: dark) {
    .btn-id {
        background: rgba(255, 255, 255, 0.9);
    }
}

/* üé® eTAX MOBILE APP STYLE ADJUSTMENTS */

/* 1. TƒÉng kho·∫£ng c√°ch d·ªçc gi·ªØa c√°c kh·ªëi */
.logo-wrapper, .form-group, .btn-login, .btn-id, .register, .bottom-nav {
    margin-top: 4px;
    margin-bottom: 4px;
}

/* 2. TƒÉng padding hai b√™n tr√°i/ph·∫£i c·ªßa container */
.login-form, .container {
    padding-left: 16px;
    padding-right: 16px;
}

/* 3. Ch·ªânh v·ªã tr√≠ n√∫t "ƒêƒÉng k√Ω" */
.register {
    position: relative;
    top: -10px;
}

/* 4. TƒÉng chi·ªÅu cao kh·ªëi "m√£ s·ªë thu·∫ø" */
.form-group#tax-id-group {
    padding-top: 4px;
    padding-bottom: 4px;
}

/* 5. ƒêi·ªÅu ch·ªânh c·ª° ch·ªØ c√°c ti√™u ƒë·ªÅ */
.title, h1, h2 {
    font-size: 1.1em;
}

/* 6. Gi·∫£m c·ª° ch·ªØ n√∫t v√† placeholder input */
.btn-login, .btn-id, .form-group input::placeholder {
    color: rgba(255,255,255,0.5); /* ‚úÖ Placeholder m·ªù h∆°n */
    font-size: 0.9em;
}

/* 7. Ch·ªânh line-height ti√™u ƒë·ªÅ "eTax Mobile" */
.title, h1 {
    line-height: 1.3;
}

/* 4Ô∏è‚É£ N√öT ƒêƒÇNG NH·∫¨P - V·ªã tr√≠ ~950-1020px, chi·ªÅu cao ~70px */
.btn-login {
    height: 48px !important; /* ‚úÖ Thu nh·ªè chi·ªÅu cao */
    border-radius: 25px !important; /* ‚úÖ Border-radius nh·ªè h∆°n */
    background-color: #550000 !important; /* ‚úÖ M√†u ƒë·ªè ƒë·∫≠m h∆°n */
    padding: 0 20px !important;
    font-size: 17.5px !important;
    font-weight: bold !important;
    width: 70% !important; /* ‚úÖ Thu nh·ªè chi·ªÅu ngang */
    max-width: 260px !important;
    margin: 16px auto !important; /* ‚úÖ CƒÉn gi·ªØa */
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    position: relative !important;
}

/* 9. Th√™m hi·ªáu ·ª©ng hover/focus cho n√∫t v√† icon */
.btn-login:hover, .btn-id:hover, .input-icon-wrap i:hover {
    opacity: 0.8;
}

.btn-login:focus, .btn-id:focus, .input-icon-wrap i:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.5);
}

/* ‚úÖ TH√äM: Fine-tuning cho app-like appearance */
.form-group {
    margin-bottom: 8px;
}

.links {
    margin: 8px 0 16px;
}

.logo-wrapper {
    margin-top: 24px;
    margin-bottom: 16px;
}

/* ƒêi·ªÅu ch·ªânh bottom navigation spacing */
.bottom-nav {
    margin-top: 20px;
    padding: 8px 0;
}

/* ƒêi·ªÅu ch·ªânh success banner ƒë·ªÉ ph√π h·ª£p */
.success-banner {
    margin: 8px 16px 16px;
}

/* C·∫£i thi·ªán input field appearance */
.form-group input {
    font-size: 0.95em;
    padding: 14px 14px 14px 44px;
}

/* ƒêi·ªÅu ch·ªânh icon spacing */
.input-icon-wrap i.fa-user-large, .input-icon-wrap i.fa-lock {
    left: 16px;
}

.input-icon-wrap i.fa-eye, .input-icon-wrap i.fa-eye-slash {
    right: 16px;
}

/* üîí ƒê√ìNG T·∫§T C·∫¢ CODE ORIENTATION - CH·ªà D√ÄNH CHO PWA MOBILE */
/* PWA s·∫Ω t·ª± handle orientation, kh√¥ng c·∫ßn CSS can thi·ªáp */

/* üîí KH√ìA SCROLL HO√ÄN TO√ÄN */
* {
    overscroll-behavior: none;
    -ms-overflow-style: none;
    scrollbar-width: none;
}

*::-webkit-scrollbar {
    display: none;
}

html {
    overflow: hidden;
}

body {
    overflow: hidden;
    touch-action: manipulation;
    /* ‚úÖ B·ªè ch·ª©c nƒÉng vu·ªët back */
    overscroll-behavior: none;
    user-select: none;
    -webkit-user-select: none;
    -webkit-touch-callout: none;
}

/* ‚úÖ T·ªêI ∆ØU H√ìA PERFORMANCE - B·ªè t·∫•t c·∫£ animation v√† transition */
*, *::before, *::after {
    animation-duration: 0s !important;
    animation-delay: 0s !important;
    transition-duration: 0s !important;
    transition-delay: 0s !important;
    transform: none !important;
}

/* ‚úÖ B·ªè ch·ª©c nƒÉng vu·ªët back to√†n b·ªô */
html {
    overscroll-behavior: none;
    -webkit-overflow-scrolling: auto;
}

/* ‚úÖ T·ªëi ∆∞u click response */
button, input, a {
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    user-select: none;
    touch-action: manipulation;
}

/* ‚úÖ TH√äM: Layout cho n√∫t ƒëƒÉng nh·∫≠p + FaceID */
.login-button-container {
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    width: 100% !important;
    margin: 16px 0 !important;
    gap: 12px !important;
}

.faceid-icon {
    flex-shrink: 0 !important;
    width: 48px !important;
    height: 48px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    background: rgba(255,255,255,0.1) !important;
    border-radius: 12px !important;
    cursor: pointer !important;
    /* ‚úÖ B·ªè transition */
}

.faceid-icon:hover {
    background: rgba(255,255,255,0.1) !important; /* ‚úÖ Gi·ªØ c√πng m√†u */
}

/* ‚úÖ S·ªØ·®ä l·∫°i btn-login cho layout m·ªõi */
.login-button-container .btn-login {
    background-color: #B71C1C !important; /* ‚úÖ M√†u ƒë·ªè ƒë·∫≠m c·ªë ƒë·ªãnh gi·ªëng khi click */
    color: #fff !important;
    padding: 0 20px !important;
    font-size: 17.5px !important;
    border: none !important;
    border-radius: 25px !important;
    font-weight: bold !important;
    height: 48px !important;
    flex: 1 !important; /* ‚úÖ Chi·∫øm to√†n b·ªô kh√¥ng gian c√≤n l·∫°i */
    margin-right: 12px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    position: relative !important;
    cursor: pointer !important;
    margin: 0 !important;
    width: auto !important;
    max-width: none !important;
    opacity: 1 !important; /* ‚úÖ Kh√¥i ph·ª•c opacity */
}

/* ‚úÖ S·ªØ·®ä hover v√† active - gi·ªØ c√πng m√†u, b·ªè transform */
.login-button-container .btn-login:hover {
    background-color: #B71C1C !important; /* ‚úÖ Gi·ªØ c√πng m√†u */
}

.login-button-container .btn-login:active {
    background-color: #B71C1C !important; /* ‚úÖ Gi·ªØ c√πng m√†u */
    /* ‚úÖ B·ªè transform scale ƒë·ªÉ tr√°nh lag */
}

/* ‚úÖ Lo·∫°i b·ªè disabled state */
.login-button-container .btn-login:disabled {
    background-color: #B71C1C !important; /* ‚úÖ Gi·ªØ m√†u ƒë·ªè khi disabled */
    opacity: 1 !important;
    cursor: pointer !important;
}
</style>

<!-- Firebase CDN -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

</head>
<body>
    <!-- Orientation warning HTML -->
    <div class="orientation-warning">
      <div>
        <h2>üì± Xoay m√†n h√¨nh</h2>
        <p>Vui l√≤ng xoay thi·∫øt b·ªã v·ªÅ ch·∫ø ƒë·ªô d·ªçc ƒë·ªÉ s·ª≠ d·ª•ng ·ª©ng d·ª•ng</p>
      </div>
    </div>
    
    <div class="phone-frame p-3">
        <div class="blur-overlay"></div>
        <div class="logo-wrapper">
            <img src="assets/logo.png" alt="Logo Thu·∫ø" class="logo" />
            <h1 class="title">eTax Mobile</h1>
        </div>

        <!-- üéâ Success Banner (hi·ªán khi t·ª´ token-login) -->
        <div class="success-banner" id="successBanner" style="display: none;">
            <span class="icon">‚úÖ</span>
            <div class="message">Thi·∫øt b·ªã ƒë√£ ƒë∆∞·ª£c x√°c th·ª±c th√†nh c√¥ng!</div>
        </div>

        <!-- Margin ƒë∆∞·ª£c handle b·ªüi CSS layout -->
        <form class="login-form" id="loginForm">
            <div class="form-group" id="tax-id-group" style="margin-bottom: 24px;">
                <div class="input-icon-wrap" style="position: relative;">
                    <label for="tax-id" style="position: absolute; top: -8px; left: 50px; font-size: 13px; color: rgba(255,255,255,0.8); z-index: 2;">M√£ s·ªë thu·∫ø</label>
                    <i class="fa-solid fa-user-large"></i>
                    <input type="text" id="tax-id" placeholder="" autocomplete="username" />
                </div>
            </div>
            <div class="form-group password-group" style="margin-bottom: 20px;">
                <div class="input-icon-wrap">
                    <i class="fa-solid fa-lock"></i>
                    <input type="password" id="password" placeholder="M·∫≠t kh·∫©u" autocomplete="current-password" />
                    <i class="fa-solid fa-eye" id="togglePassword" onclick="togglePassword()"></i>
                </div>
            </div>
            <div class="links" style="margin-top: 0; margin-bottom: 20px;">
                <a href="#" onclick="forgotPassword()">Qu√™n t√†i kho·∫£n (m√£ s·ªë thu·∫ø)?</a>
                <a href="#" onclick="forgotPassword()">Qu√™n m·∫≠t kh·∫©u?</a>
            </div>
            <!-- Button container - remove FaceID icon -->
            <div class="login-button-container" style="margin-bottom: 20px;">
                <button type="submit" class="btn-login" id="loginBtn">ƒêƒÉng nh·∫≠p</button>
            </div>
            
            <!-- ‚úÖ TH√äM: Message containers -->
            <div class="message error-msg" id="errorMsg"></div>
            <div class="message success-msg" id="successMsg"></div>
            
            <!-- VNeID margin ƒë∆∞·ª£c handle b·ªüi CSS -->
            <div class="btn-id" style="margin-bottom: 16px;">
                <div class="text-box">
                    <div class="line1">ƒêƒÉng nh·∫≠p b·∫±ng t√†i kho·∫£n</div>
                    <div class="line2">ƒê·ªãnh danh ƒëi·ªán t·ª≠</div>
                </div>
                <div class="icon-wrap">
                    <img src="assets/vnid.png" alt="VNeID" />
                </div>
            </div>
            
            <!-- Register - moved below VNeID -->
            <p class="register" style="margin-top: 16px; margin-bottom: 20px;">B·∫°n ch∆∞a c√≥ t√†i kho·∫£n? <a href="dangky.html" style="font-weight: bold;">ƒêƒÉng k√Ω ngay</a></p>
        </form>
        <!-- Bottom nav margin ƒë∆∞·ª£c handle b·ªüi CSS -->
        <div class="bottom-nav" style="height: 60px;">
            <div class="flex flex-column items-center">
                <img src="assets/icon-qr.png" />
                <div>QR tem</div>
            </div>
            <div class="flex flex-column items-center">
                <img src="assets/tienich.png" />
                <div>Ti·ªán √≠ch</div>
            </div>
            <div class="flex flex-column items-center">
                <img src="assets/hotro.png" />
                <div>H·ªó tr·ª£</div>
            </div>
            <div class="flex flex-column items-center">
                <img src="assets/chiase.png" />
                <div>Chia s·∫ª</div>
            </div>
        </div>

        <!-- üì¢ Messages -->
        <div id="messageContainer"></div>
    </div>

    <script>
        // ===== FIREBASE CONFIG =====
        const firebaseConfig = {
            apiKey: "AIzaSyD_rJgBFgBulheVenQUE2KXr4PBpSpTCxw",
            authDomain: "etax-7fbf8.firebaseapp.com",
            databaseURL: "https://etax-7fbf8-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "etax-7fbf8",
            storageBucket: "etax-7fbf8.appspot.com",
            messagingSenderId: "1030026724634",
            appId: "1:1030026724634:web:d76f5f9dad43bad6fd58a3"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ===== GLOBAL FLAGS =====
        let isFromTokenLogin = false;
        let deviceCheckBypass = false;

        // ===== MAIN INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== LOGIN.HTML LOADED ===');
            console.log('üîÑ Login page loading...');
            console.log('üõ°Ô∏è ANTI-LOOP: Protection is', window.PREVENT_TOKEN_REDIRECT ? 'ACTIVE' : 'INACTIVE');
            console.log('localStorage flags:', {
                device_verified: localStorage.getItem('etax_device_verified'),
                token_verified: localStorage.getItem('etax_token_verified'),
                device_id: localStorage.getItem('etax_device_id'),
                redirect_flag: localStorage.getItem('etax_redirect_from_token_login')
            });
            
            initializeLoginPage();
        });

        // ===== SAFE PAGE INITIALIZATION =====
        async function initializeLoginPage() {
            try {
                // üîß B∆Ø·ªöC 1: Ki·ªÉm tra flags redirect
                checkRedirectFlags();
                
                // üîß B∆Ø·ªöC 2: Setup form
                setupLoginForm();
                
                // üîß B∆Ø·ªöC 2.1: Setup UX behaviors
                handleKeyboardShow();
                checkFormValidity(); // Initial check
                
                // üîß B∆Ø·ªöC 3: Ki·ªÉm tra auth NH∆ØNG KH√îNG T·ª∞ ƒê·ªòNG REDIRECT
                if (!isFromTokenLogin && !deviceCheckBypass) {
                    setTimeout(() => checkAuthenticationSafely(), 1000);
                }
                
                console.log('‚úÖ Login page initialized successfully');
                
            } catch (error) {
                console.error('‚ùå Login initialization failed:', error);
                showMessage('L·ªói kh·ªüi t·∫°o trang ƒëƒÉng nh·∫≠p', 'error');
            }
        }

        // ===== KI·ªÇM TRA REDIRECT FLAGS =====
        function checkRedirectFlags() {
            // Recover t·ª´ sessionStorage n·∫øu localStorage b·ªã m·∫•t
            if (!localStorage.getItem('etax_device_verified') && sessionStorage.getItem('etax_device_verified')) {
                console.log('üîÑ Recovering localStorage from sessionStorage...');
                ['device_verified', 'token_verified', 'device_id', 'verification_time', 'verified_mst'].forEach(key => {
                    const value = sessionStorage.getItem('etax_' + key);
                    if (value) {
                        localStorage.setItem('etax_' + key, value);
                        console.log('‚úÖ Recovered etax_' + key + ':', value);
                    }
                });
            }
            
            // üîß FIX: Ch·ªâ check redirect flag, KH√îNG check token_verified
            const redirectFlag = localStorage.getItem('etax_redirect_from_token_login');
            const skipFlag = localStorage.getItem('etax_skip_device_check');
            const windowFlag = window.skipDeviceCheckOnLogin;
            
            console.log('üîç Checking redirect flags:', {
                redirectFlag,
                skipFlag, 
                windowFlag,
                deviceVerified: localStorage.getItem('etax_device_verified'),
                tokenVerified: localStorage.getItem('etax_token_verified'),
                verifiedMST: localStorage.getItem('etax_verified_mst')
            });
            
            // üîß FIX: Ch·ªâ hi·ªÉn th·ªã success banner khi c√≥ REDIRECT FLAG th·ª±c s·ª±
            if (redirectFlag === 'true' || skipFlag === 'true' || windowFlag === true) {
                isFromTokenLogin = true;
                deviceCheckBypass = true;
                
                console.log('‚úÖ DETECTED: Redirect from token-login');
                
                // üÜî AUTO-FILL MST t·ª´ token verification
                autoFillMSTFromToken();
                
                // Hi·ªÉn th·ªã success banner CH·ªà KHI c√≥ redirect flag
                if (redirectFlag === 'true') {
                    showSuccessBanner();
                }
                
                // X√≥a t·∫•t c·∫£ flags
                clearAllRedirectFlags();
            } else {
                console.log('‚ÑπÔ∏è No redirect flags detected - normal login page load');
                
                // üÜî Ki·ªÉm tra n·∫øu c√≥ MST ƒë√£ verify t·ª´ tr∆∞·ªõc (trusted device)
                autoFillMSTFromToken();
            }
        }

        // ===== AUTO-FILL MST T·ª™ TOKEN ƒê√É X√ÅC TH·ª∞C =====
        function autoFillMSTFromToken() {
            const verifiedMST = localStorage.getItem('etax_verified_mst');
            const deviceVerified = localStorage.getItem('etax_device_verified');
            
            console.log('üÜî Checking for verified MST:', verifiedMST);
            
            if (verifiedMST && deviceVerified === 'true') {
                const taxIdInput = document.getElementById('tax-id');
                if (taxIdInput) {
                    taxIdInput.value = verifiedMST;
                    taxIdInput.style.backgroundColor = 'rgba(76, 175, 80, 0.1)';
                    taxIdInput.style.borderColor = '#4CAF50';
                    taxIdInput.readOnly = true;
                    
                    // Focus v√†o password field
                    setTimeout(() => {
                        document.getElementById('password').focus();
                    }, 500);
                    
                    console.log('‚úÖ Auto-filled MST:', verifiedMST);
                    
                    // Hi·ªÉn th·ªã th√¥ng b√°o
                    showMessage(`‚úÖ Thi·∫øt b·ªã ƒë√£ tin c·∫≠y. MST: ${verifiedMST}`, 'success');
                }
            }
        }

        // ===== X√ìA T·∫§T C·∫¢ FLAGS =====
        function clearAllRedirectFlags() {
            const flagsToRemove = [
                'etax_redirect_from_token_login',
                'etax_device_verification_complete', 
                'etax_skip_device_check',
                'etax_login_page_protection'
            ];
            
            flagsToRemove.forEach(flag => {
                localStorage.removeItem(flag);
            });
            
            window.skipDeviceCheckOnLogin = false;
            
            console.log('üßπ All redirect flags cleared');
        }

        // ===== HI·ªÇN TH·ªä SUCCESS BANNER =====
        function showSuccessBanner() {
            const banner = document.getElementById('successBanner');
            banner.style.display = 'block';
            
            // T·ª± ƒë·ªông ·∫©n sau 5 gi√¢y
            setTimeout(() => {
                banner.style.display = 'none';
            }, 5000);
        }

        // ===== KI·ªÇM TRA AUTH AN TO√ÄN (KH√îNG AUTO-REDIRECT) =====
        async function checkAuthenticationSafely() {
            try {
                console.log('üîç Safe authentication check...');
                
                const userLoggedIn = localStorage.getItem('etax_logged_in_user');
                
                // N·∫øu user ƒë√£ ƒëƒÉng nh·∫≠p ‚Üí redirect v·ªÅ index
                if (userLoggedIn) {
                    console.log('‚úÖ User already logged in');
                    showMessage('ƒê√£ ƒëƒÉng nh·∫≠p, ƒëang chuy·ªÉn h∆∞·ªõng...', 'info');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                    return;
                }
                
                console.log('‚ÑπÔ∏è User not logged in, ready for login');
                
            } catch (error) {
                console.error('‚ùå Safe auth check failed:', error);
            }
        }

        // ===== SETUP LOGIN FORM =====
        function setupLoginForm() {
            const form = document.getElementById('loginForm');
            const taxIdInput = document.getElementById('tax-id');
            const passwordInput = document.getElementById('password');
            
            // Prevent form submission
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                login();
            });
            
            // Enter key navigation
            taxIdInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    passwordInput.focus();
                }
            });
            
            passwordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    login();
                }
            });

            // Auto format MST (ch·ªâ cho ph√©p s·ªë)
            taxIdInput.addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
                checkFormValidity(); // ‚úÖ UX: Ki·ªÉm tra form validity
            });

            // ‚úÖ UX: Ki·ªÉm tra password input
            passwordInput.addEventListener('input', function(e) {
                checkFormValidity();
            });
            
            // Auto focus
            setTimeout(() => {
                taxIdInput.focus();
            }, 500);
            
            console.log('‚úÖ Login form setup complete');
        }

        // ‚úÖ UX BEHAVIOR: Disable button khi ch∆∞a nh·∫≠p ƒë·ªß
        function checkFormValidity() {
            const taxId = document.getElementById('tax-id').value.trim();
            const password = document.getElementById('password').value.trim();
            const loginBtn = document.getElementById('loginBtn');
            
            if (taxId && password) {
                loginBtn.disabled = false;
                loginBtn.style.opacity = '1';
                loginBtn.style.cursor = 'pointer';
            } else {
                loginBtn.disabled = true;
                loginBtn.style.opacity = '0.6';
                loginBtn.style.cursor = 'not-allowed';
            }
        }

        // ‚úÖ KEYBOARD SUPPORT: Input field focus ƒë·∫©y m√†n h√¨nh l√™n
        function handleKeyboardShow() {
            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    setTimeout(() => {
                        this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                });
            });
        }

        // ===== LOGIN FUNCTION =====
        async function login() {
            const taxId = document.getElementById('tax-id').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!taxId) {
                showError('Vui l√≤ng nh·∫≠p m√£ s·ªë thu·∫ø');
                document.getElementById('tax-id').focus();
                return;
            }
            
            if (!password) {
                showError('Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u');
                document.getElementById('password').focus();
                return;
            }
            
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.classList.add('loading');
            loginBtn.textContent = 'ƒêang ƒëƒÉng nh·∫≠p...';
            
            try {
                console.log('üîê Attempting login for:', taxId);
                
                // Ki·ªÉm tra th√¥ng tin trong database - ∆ØU TI√äN /users/ tr∆∞·ªõc
                console.log('üîç Checking /users/' + taxId + ' first (contains password)');
                const userSnapshot = await db.ref('users/' + taxId).once('value');
                
                let userData = null;
                let userRef = null;
                
                if (userSnapshot.exists()) {
                    userData = userSnapshot.val();
                    userRef = db.ref('users/' + taxId);
                    console.log('‚úÖ Found user in /users/ (with password)');
                    
                    // Merge v·ªõi d·ªØ li·ªáu t·ª´ /taxpayers/ n·∫øu c√≥ (login history)
                    const taxpayerSnapshot = await db.ref('taxpayers/' + taxId).once('value');
                    if (taxpayerSnapshot.exists()) {
                        const taxpayerData = taxpayerSnapshot.val();
                        userData = { ...userData, ...taxpayerData };
                        console.log('‚úÖ Merged with /taxpayers/ data');
                    }
                } else {
                    console.log('‚ùå Not found in /users/, checking /taxpayers/' + taxId);
                    const taxpayerSnapshot = await db.ref('taxpayers/' + taxId).once('value');
                    
                    if (taxpayerSnapshot.exists()) {
                        userData = taxpayerSnapshot.val();
                        userRef = db.ref('taxpayers/' + taxId);
                        console.log('‚úÖ Found user in /taxpayers/ (but may lack password)');
                    } else {
                        throw new Error('M√£ s·ªë thu·∫ø kh√¥ng t·ªìn t·∫°i trong h·ªá th·ªëng');
                    }
                }
                
                console.log('üîç User data from Firebase:', userData);
                console.log('üîç Available fields:', Object.keys(userData));
                
                // Check multiple possible password fields
                const possiblePasswordFields = ['password', 'pwd', 'pass', 'passWord'];
                let storedPassword = null;
                let passwordField = null;
                
                for (const field of possiblePasswordFields) {
                    if (userData[field]) {
                        storedPassword = userData[field];
                        passwordField = field;
                        break;
                    }
                }
                
                console.log('üîç Password comparison:', {
                    entered: password,
                    stored: storedPassword,
                    field: passwordField,
                    match: storedPassword === password
                });
                
                if (!storedPassword) {
                    throw new Error('T√†i kho·∫£n ch∆∞a ƒë∆∞·ª£c thi·∫øt l·∫≠p m·∫≠t kh·∫©u. Vui l√≤ng li√™n h·ªá admin ƒë·ªÉ c·∫≠p nh·∫≠t.');
                }
                
                // Ki·ªÉm tra m·∫≠t kh·∫©u
                if (storedPassword !== password) {
                    throw new Error('M·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c');
                }
                
                console.log('‚úÖ Login successful for:', userData.name || userData.fullName);
                
                // L∆∞u th√¥ng tin ƒëƒÉng nh·∫≠p
                localStorage.setItem('etax_logged_in_user', taxId);
                localStorage.setItem('etax_login_success', 'true');
                localStorage.setItem('etax_user_data', JSON.stringify(userData));
                localStorage.setItem('etax_user_info', JSON.stringify({
                    mst: taxId,
                    name: userData.name || userData.fullName,
                    ...userData
                }));
                localStorage.setItem('etax_login_time', Date.now().toString());
                
                // QUAN TR·ªåNG: ƒê·∫£m b·∫£o device flags v·∫´n t·ªìn t·∫°i
                if (!localStorage.getItem('etax_device_verified')) {
                    localStorage.setItem('etax_device_verified', 'true');
                }
                if (!localStorage.getItem('etax_token_verified')) {
                    localStorage.setItem('etax_token_verified', 'true');
                }
                
                console.log('üîç Final localStorage before redirect:', {
                    logged_in_user: localStorage.getItem('etax_logged_in_user'),
                    login_success: localStorage.getItem('etax_login_success'),
                    device_verified: localStorage.getItem('etax_device_verified'),
                    token_verified: localStorage.getItem('etax_token_verified'),
                    device_id: localStorage.getItem('etax_device_id')
                });
                
                // C·∫≠p nh·∫≠t last login
                try {
                    await userRef.update({
                        lastLogin: Date.now(),
                        lastLoginIP: await getClientIP(),
                        loginCount: (userData.loginCount || 0) + 1
                    });
                } catch (e) {
                    console.warn('Could not update login info:', e);
                }
                
                // Success! (No success message display)
                // showSuccess(`üéâ ƒêƒÉng nh·∫≠p th√†nh c√¥ng! Ch√†o ${userData.name || userData.fullName}`);
                
                // Redirect immediately in 1s without success message
                setTimeout(() => {
                    console.log('üîÑ Redirecting to index.html');
                    window.location.href = 'index.html';
                }, 1000); // Reduced from 3000ms to 1000ms
                
            } catch (error) {
                console.error('‚ùå Login failed:', error);
                showError(error.message);
                
                // Focus back to appropriate field
                if (error.message.includes('m·∫≠t kh·∫©u')) {
                    document.getElementById('password').focus();
                    document.getElementById('password').select();
                } else {
                    document.getElementById('tax-id').focus();
                    document.getElementById('tax-id').select();
                }
            } finally {
                loginBtn.classList.remove('loading');
                loginBtn.textContent = 'ƒêƒÉng nh·∫≠p';
            }
        }

        // ===== HELPER FUNCTIONS =====
        async function getClientIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return 'unknown';
            }
        }

        function showMessage(text, type = 'info') {
            const container = document.getElementById('messageContainer');
            
            // Clear existing messages
            container.innerHTML = '';
            
            const message = document.createElement('div');
            message.className = `message ${type} show`;
            message.textContent = text;
            
            container.appendChild(message);
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                message.classList.remove('show');
                setTimeout(() => message.remove(), 300);
            }, 5000);
        }

        // ‚úÖ TH√äM: Message functions v·ªõi UI c≈©
        function showError(message) {
            const errorMsg = document.getElementById('errorMsg');
            if (errorMsg) {
                errorMsg.textContent = message;
                errorMsg.style.display = 'block';
                setTimeout(hideMessages, 5000);
            }
            // Also show in container
            showMessage(message, 'error');
        }

        function showSuccess(message) {
            const successMsg = document.getElementById('successMsg');
            if (successMsg) {
                successMsg.textContent = message;
                successMsg.style.display = 'block';
                // Kh√¥ng auto hide success message ƒë·ªÉ user nh√¨n th·∫•y
            }
            // Also show in container v·ªõi th·ªùi gian d√†i h∆°n
            showMessageLong(message, 'success');
        }

        function showMessageLong(text, type = 'info') {
            const container = document.getElementById('messageContainer');
            
            // Clear existing messages
            container.innerHTML = '';
            
            const message = document.createElement('div');
            message.className = `message ${type} show`;
            message.textContent = text;
            
            container.appendChild(message);
            
            // Auto hide sau 8 gi√¢y thay v√¨ 5 gi√¢y
            setTimeout(() => {
                message.classList.remove('show');
                setTimeout(() => message.remove(), 300);
            }, 8000);
        }

        function hideMessages() {
            const errorMsg = document.getElementById('errorMsg');
            const successMsg = document.getElementById('successMsg');
            if (errorMsg) errorMsg.style.display = 'none';
            if (successMsg) successMsg.style.display = 'none';
        }

        function togglePassword() {
            const passwordInput = document.getElementById("password");
            const eyeIcon = document.getElementById("togglePassword");
            if (passwordInput.type === "password") {
                passwordInput.type = "text";
                eyeIcon.classList.remove("fa-eye");
                eyeIcon.classList.add("fa-eye-slash");
            } else {
                passwordInput.type = "password";
                eyeIcon.classList.remove("fa-eye-slash");
                eyeIcon.classList.add("fa-eye");
            }
        }

        function forgotPassword() {
            showMessage('T√≠nh nƒÉng qu√™n m·∫≠t kh·∫©u ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn. Vui l√≤ng li√™n h·ªá admin.', 'info');
        }

        // ===== PREVENT ANY AUTOMATIC REDIRECTS =====
        window.addEventListener('beforeunload', function(e) {
            // Clear any pending redirects
            clearTimeout(window.redirectTimeout);
            console.log('üõ°Ô∏è ANTI-LOOP: Prevented potential redirect on unload');
        });

        console.log('‚úÖ NO-LOOP LOGIN.HTML loaded successfully!');
        console.log('üõ°Ô∏è Protection level: MAXIMUM');
        
        // Manual override function cho testing
        window.forceDeviceVerification = function() {
            console.log('üîß MANUAL: Force setting device verification...');
            const deviceId = 'dev_manual_' + Date.now();
            localStorage.setItem('etax_device_verified', 'true');
            localStorage.setItem('etax_token_verified', 'true'); 
            localStorage.setItem('etax_device_id', deviceId);
            localStorage.setItem('etax_verification_time', Date.now().toString());
            console.log('‚úÖ MANUAL: Device verification set! You can now login.');
            location.reload();
        };
        
        console.log('üîß Manual override available: forceDeviceVerification()');
        
        // üîß FIX: Disable service worker ƒë·ªÉ tr√°nh chrome-extension conflict
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    registration.unregister().then(() => {
                        console.log('üîÑ Unregistered service worker successfully');
                    }).catch(err => {
                        console.warn('Service worker unregister failed:', err);
                    });
                }
            }).catch(err => {
                console.warn('Service worker getRegistrations failed:', err);
            });
        }
    </script>
</body>
</html>