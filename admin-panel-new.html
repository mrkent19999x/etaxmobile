<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üõ°Ô∏è B·∫¢NG ƒêI·ªÄU KHI·ªÇN eTAX ADMIN</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  
  <!-- üìù eTax Rich Text Editor -->
  <script src="js/etax-rich-editor.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', 'Tahoma', 'Microsoft Sans Serif', 'Arial', sans-serif;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    /* üéØ HEADER ADMIN */
    .admin-header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .admin-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 24px;
      font-weight: 700;
      color: #dc3545;
    }

    .admin-user {
      display: flex;
      align-items: center;
      gap: 15px;
      font-size: 14px;
      color: #666;
    }

    .logout-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.3s;
    }

    .logout-btn:hover {
      background: #c82333;
    }

    /* üìä MAIN CONTAINER */
    .admin-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 30px;
    }

    /* üéõÔ∏è SIDEBAR MENU */
    .admin-sidebar {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      height: fit-content;
      position: sticky;
      top: 100px;
    }

    .sidebar-title {
      font-size: 18px;
      font-weight: 700;
      color: #333;
      margin-bottom: 20px;
      text-align: center;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .menu-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 15px;
      margin-bottom: 8px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      color: #666;
      font-weight: 500;
    }

    .menu-item:hover, .menu-item.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      transform: translateX(5px);
    }

    .menu-icon {
      font-size: 18px;
      width: 24px;
    }

    /* üì± MAIN CONTENT */
    .admin-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      min-height: 600px;
    }

    .content-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #f0f0f0;
    }

    .content-title {
      font-size: 28px;
      font-weight: 700;
      color: #333;
    }

    .add-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
    }

    .add-btn:hover {
      background: #218838;
      transform: translateY(-2px);
    }

    /* üìä DASHBOARD STATS */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
      text-align: center;
    }

    .stat-number {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }

    /* üìã TABLE STYLES */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .data-table th,
    .data-table td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #f0f0f0;
    }

    .data-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #333;
    }

    .data-table tr:hover {
      background: #f8f9fa;
    }

    /* üé® ACTION BUTTONS */
    .action-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      margin-right: 5px;
      transition: all 0.3s;
    }

    .btn-edit {
      background: #ffc107;
      color: #333;
    }

    .btn-delete {
      background: #dc3545;
      color: white;
    }

    .btn-view {
      background: #17a2b8;
      color: white;
    }

    .action-btn:hover {
      transform: scale(1.05);
    }

    /* üì± RESPONSIVE */
    @media (max-width: 768px) {
      .admin-container {
        grid-template-columns: 1fr;
        gap: 20px;
        padding: 20px 15px;
      }
      
      .admin-header {
        padding: 15px 20px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    /* üîÑ LOADING STATE */
    .loading {
      text-align: center;
      padding: 50px;
      color: #666;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- üéØ HEADER -->
  <div class="admin-header">
    <div class="admin-logo">
      <i class="fas fa-shield-alt"></i>
      B·∫¢NG ƒêI·ªÄU KHI·ªÇN eTAX
    </div>
    <div class="admin-user">
      <span>üë®‚Äçüíº Xin ch√†o, Admin</span>
      <span id="currentTime"></span>
      <button class="logout-btn" onclick="adminLogout()">
        <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
      </button>
    </div>
  </div>

  <!-- üìä MAIN CONTAINER -->
  <div class="admin-container">
    <!-- üéõÔ∏è SIDEBAR -->
    <div class="admin-sidebar">
      <div class="sidebar-title">üìã MENU QU·∫¢N L√ù</div>
      
      <div class="menu-item active" onclick="showDashboard()">
        <i class="menu-icon fas fa-tachometer-alt"></i>
        T·ªïng quan h·ªá th·ªëng
      </div>
      
      <div class="menu-item" onclick="showSystemNotifications()">
        <i class="menu-icon fas fa-bullhorn"></i>
        Th√¥ng b√°o to√†n h·ªá th·ªëng
      </div>
      
      <div class="menu-item" onclick="showUserManagement()">
        <i class="menu-icon fas fa-users"></i>
        Qu·∫£n l√Ω ng∆∞·ªùi d√πng
      </div>
      
      <div class="menu-item" onclick="showContentManagement()">
        <i class="menu-icon fas fa-file-alt"></i>
        Qu·∫£n l√Ω n·ªôi dung
      </div>
      
      <div class="menu-item" onclick="openVisualEditor()">
        <i class="menu-icon fas fa-paint-brush"></i>
        Visual Editor
      </div>
      
      <div class="menu-item" onclick="showPageManagement()">
        <i class="menu-icon fas fa-sitemap"></i>
        Qu·∫£n l√Ω trang con
      </div>
      
      <div class="menu-item" onclick="showSystemLogs()">
        <i class="menu-icon fas fa-clipboard-list"></i>
        Nh·∫≠t k√Ω h·ªá th·ªëng
      </div>
      
      <div class="menu-item" onclick="showSettings()">
        <i class="menu-icon fas fa-cog"></i>
        C√†i ƒë·∫∑t h·ªá th·ªëng
      </div>
    </div>

    <!-- üì± MAIN CONTENT -->
    <div class="admin-content">
      <div id="contentArea">
        <!-- Dashboard s·∫Ω load ·ªü ƒë√¢y -->
        <div class="loading">
          <div class="spinner"></div>
          <p>ƒêang t·∫£i b·∫£ng ƒëi·ªÅu khi·ªÉn...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD_rJgBFgBulheVenQUE2KXr4PBpSpTCxw",
      authDomain: "etax-7fbf8.firebaseapp.com",
      databaseURL: "https://etax-7fbf8-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "etax-7fbf8",
      storageBucket: "etax-7fbf8.appspot.com",
      messagingSenderId: "1030026724634",
      appId: "1:1030026724634:web:d76f5f9dad43bad6fd58a3",
      measurementId: "G-YS5DLECJE6"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // üîê Ki·ªÉm tra session admin
    function checkAdminSession() {
      const session = localStorage.getItem('etax_admin_session');
      if (!session) {
        alert('‚ùå B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p! Chuy·ªÉn v·ªÅ trang ƒëƒÉng nh·∫≠p...');
        window.location.href = 'admin-login.html';
        return false;
      }

      const sessionData = JSON.parse(session);
      if (Date.now() > sessionData.expiresAt) {
        alert('‚è∞ Phi√™n l√†m vi·ªác ƒë√£ h·∫øt h·∫°n! Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i...');
        localStorage.removeItem('etax_admin_session');
        window.location.href = 'admin-login.html';
        return false;
      }

      return true;
    }

    // üö™ ƒêƒÉng xu·∫•t admin
    function adminLogout() {
      if (confirm('ü§î B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t kh√¥ng?')) {
        localStorage.removeItem('etax_admin_session');
        alert('‚úÖ ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!');
        window.location.href = 'admin-login.html';
      }
    }

    // ‚è∞ C·∫≠p nh·∫≠t th·ªùi gian
    function updateTime() {
      const now = new Date();
      document.getElementById('currentTime').textContent = 
        now.toLocaleString('vi-VN');
    }

    // üéõÔ∏è MENU FUNCTIONS
    function setActiveMenu(clickedItem) {
      document.querySelectorAll('.menu-item').forEach(item => {
        item.classList.remove('active');
      });
      clickedItem.classList.add('active');
    }

    // üìä DASHBOARD
    function showDashboard() {
      // Fix active menu
      document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
      const dashboardMenu = document.querySelector('[onclick="showDashboard()"]');
      if (dashboardMenu) {
        dashboardMenu.classList.add('active');
      }
      document.getElementById('contentArea').innerHTML = `
        <div class="content-header">
          <h2 class="content-title">üìä T·ªîNG QUAN H·ªÜ TH·ªêNG</h2>
          <span style="color: #666;">C·∫≠p nh·∫≠t: ${new Date().toLocaleString('vi-VN')}</span>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number" id="totalUsers">0</div>
            <div class="stat-label">üë• T·ªïng ng∆∞·ªùi d√πng</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="pendingUsers">0</div>
            <div class="stat-label">‚è≥ Ch·ªù duy·ªát</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="systemNotifications">0</div>
            <div class="stat-label">üì¢ Th√¥ng b√°o h·ªá th·ªëng</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalPages">13</div>
            <div class="stat-label">üì± Trang con</div>
          </div>
        </div>

        <h3 style="margin-bottom: 20px;">üìà Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y</h3>
        <div id="recentActivity"></div>
      `;
      loadDashboardData();
    }

    // üì¢ TH√îNG B√ÅO H·ªÜ TH·ªêNG
    function showSystemNotifications() {
      // Fix active menu
      document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
      const notifMenu = document.querySelector('[onclick="showSystemNotifications()"]');
      if (notifMenu) {
        notifMenu.classList.add('active');
      }
      document.getElementById('contentArea').innerHTML = `
        <div class="content-header">
          <h2 class="content-title">üì¢ TH√îNG B√ÅO TO√ÄN H·ªÜ TH·ªêNG</h2>
          <button class="add-btn" onclick="createSystemNotification()">
            <i class="fas fa-plus"></i> T·∫°o th√¥ng b√°o m·ªõi
          </button>
        </div>
        
        <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
          <h4 style="color: #1976d2; margin-bottom: 10px;">üí° H∆∞·ªõng d·∫´n:</h4>
          <p style="color: #333; margin-bottom: 10px;">‚Ä¢ Th√¥ng b√°o h·ªá th·ªëng s·∫Ω hi·ªÉn th·ªã tr√™n <strong>T·∫§T C·∫¢</strong> trang con c·ªßa eTax</p>
          <p style="color: #333; margin-bottom: 10px;">‚Ä¢ C√≥ th·ªÉ thi·∫øt l·∫≠p ng√†y gi·ªù t√πy ch·ªânh (backdate)</p>
          <p style="color: #333;">‚Ä¢ V√≠ d·ª•: Th√¥ng b√°o b·∫£o tr√¨, ng·ª´ng giao d·ªãch, c·∫≠p nh·∫≠t h·ªá th·ªëng...</p>
        </div>

        <div id="systemNotificationsList"></div>
      `;
      loadSystemNotifications();
    }

    // üë• QU·∫¢N L√ù NG∆Ø·ªúI D√ôNG v·ªõi OTP  
    function showUserManagement() {
      // Fix active menu
      document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
      const userMenu = document.querySelector('[onclick="showUserManagement()"]');
      if (userMenu) {
        userMenu.classList.add('active');
      }
      document.getElementById('contentArea').innerHTML = `
        <div class="content-header">
          <h2 class="content-title">üë• QU·∫¢N L√ù NG∆Ø·ªúI D√ôNG & OTP</h2>
          <div style="display: flex; gap: 10px;">
            <button class="add-btn" onclick="createUser()">
              <i class="fas fa-user-plus"></i> T·∫°o user m·ªõi
            </button>
            <button class="add-btn" onclick="viewPendingRequests()" style="background: #ffc107;">
              <i class="fas fa-clock"></i> Y√™u c·∫ßu ch·ªù duy·ªát (<span id="pendingCount">0</span>)
            </button>
          </div>
        </div>
        
        <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
          <h4 style="color: #1976d2; margin-bottom: 10px;">üîê SYSTEM OTP M·ªöI:</h4>
          <p style="color: #333; margin-bottom: 10px;">‚Ä¢ <strong>L·∫ßn ƒë·∫ßu:</strong> User nh·∫≠p MST + Password ‚Üí Admin duy·ªát + g·ª≠i OTP</p>
          <p style="color: #333; margin-bottom: 10px;">‚Ä¢ <strong>L·∫ßn sau:</strong> User v√†o lu√¥n kh√¥ng c·∫ßn OTP</p>
          <p style="color: #333; margin-bottom: 10px;">‚Ä¢ <strong>Admin control:</strong> C√≥ th·ªÉ y√™u c·∫ßu OTP l·∫°i b·∫•t k·ª≥ l√∫c n√†o</p>
          <p style="color: #333;">‚Ä¢ <strong>Real-time:</strong> Notifications t·ª´ user request ƒë·∫øn admin instant</p>
        </div>

        <div class="tabs-container" style="margin-bottom: 20px;">
          <div class="tabs" style="display: flex; background: #f8f9fa; border-radius: 10px; padding: 5px;">
            <button class="tab-btn active" onclick="showUserTab('approved')" style="flex: 1; padding: 10px; border: none; background: white; border-radius: 6px; font-weight: 600; cursor: pointer;">
              ‚úÖ User ƒë√£ duy·ªát
            </button>
            <button class="tab-btn" onclick="showUserTab('pending')" style="flex: 1; padding: 10px; border: none; background: transparent; border-radius: 6px; font-weight: 600; cursor: pointer;">
              ‚è≥ Ch·ªù duy·ªát (<span id="pendingTabCount">0</span>)
            </button>
            <button class="tab-btn" onclick="showUserTab('blocked')" style="flex: 1; padding: 10px; border: none; background: transparent; border-radius: 6px; font-weight: 600; cursor: pointer;">
              üö´ ƒê√£ kh√≥a
            </button>
          </div>
        </div>

        <div id="userTabContent"></div>
      `;
      loadUserManagement();
      loadPendingRequests();
    }

    // üìÑ Load dashboard data
    async function loadDashboardData() {
      try {
        // Load real data from Firebase
        const usersSnapshot = await db.ref('users').once('value');
        const users = usersSnapshot.val() || {};
        const totalUsers = Object.keys(users).length;
        
        const requestsSnapshot = await db.ref('userRequests').once('value');
        const requests = requestsSnapshot.val() || {};
        const pendingUsers = Object.values(requests).filter(req => req.status === 'pending').length;
        
        const notificationsSnapshot = await db.ref('systemNotifications').once('value');
        const notifications = notificationsSnapshot.val() || {};
        const totalNotifications = Object.keys(notifications).length;
        
        // Update UI with real data
        document.getElementById('totalUsers').textContent = totalUsers;
        document.getElementById('pendingUsers').textContent = pendingUsers;
        document.getElementById('systemNotifications').textContent = totalNotifications;
        
        document.getElementById('recentActivity').innerHTML = `
          <table class="data-table">
            <thead>
              <tr>
                <th>Th·ªùi gian</th>
                <th>Ho·∫°t ƒë·ªông</th>
                <th>Ng∆∞·ªùi th·ª±c hi·ªán</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>${new Date().toLocaleString('vi-VN')}</td>
                <td>ƒêƒÉng nh·∫≠p h·ªá th·ªëng</td>
                <td>admin@etax.vn</td>
              </tr>
            </tbody>
          </table>
        `;
      } catch (error) {
        console.error('L·ªói load dashboard:', error);
      }
    }

    // üì¢ Load system notifications
    async function loadSystemNotifications() {
      try {
        const snapshot = await db.ref('systemNotifications').orderByChild('createdAt').once('value');
        const notifications = [];
        
        snapshot.forEach(child => {
          const data = child.val();
          notifications.push({
            id: child.key,
            ...data
          });
        });
        
        // Reverse ƒë·ªÉ hi·ªÉn th·ªã m·ªõi nh·∫•t tr∆∞·ªõc
        notifications.reverse();
        
        let tableHTML = `
          <table class="data-table">
            <thead>
              <tr>
                <th>Lo·∫°i</th>
                <th>Ti√™u ƒë·ªÅ th√¥ng b√°o</th>
                <th>Th·ªùi gian hi·ªÉn th·ªã</th>
                <th>Tr·∫°ng th√°i</th>
                <th>H√†nh ƒë·ªông</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        if (notifications.length === 0) {
          tableHTML += `
            <tr>
              <td colspan="5" style="text-align: center; padding: 50px; color: #666;">
                üì¢ Ch∆∞a c√≥ th√¥ng b√°o h·ªá th·ªëng n√†o
              </td>
            </tr>
          `;
        } else {
          notifications.forEach(notif => {
            const typeIcons = {
              maintenance: 'üîß',
              announcement: 'üì¢', 
              urgent: 'üö®',
              update: 'üì±',
              holiday: 'üéâ'
            };
            
            const startDateTime = new Date(notif.startDate + 'T' + notif.startTime);
            const endDateTime = notif.endDate ? new Date(notif.endDate + 'T' + notif.endTime) : null;
            const now = new Date();
            
            let status = '';
            if (now < startDateTime) {
              status = '‚è≥ Ch∆∞a hi·ªÉn th·ªã';
            } else if (endDateTime && now > endDateTime) {
              status = '‚úÖ ƒê√£ k·∫øt th√∫c';
            } else {
              status = 'üü¢ ƒêang hi·ªÉn th·ªã';
            }
            
            const timeRange = notif.endDate ? 
              `${notif.startDate} ${notif.startTime} - ${notif.endDate} ${notif.endTime}` :
              `T·ª´ ${notif.startDate} ${notif.startTime}`;
            
            tableHTML += `
              <tr>
                <td>${typeIcons[notif.type] || 'üì¢'}</td>
                <td>
                  <strong>${notif.title}</strong><br>
                  <small style="color: #666;">${notif.content.substring(0, 50)}...</small>
                </td>
                <td><small>${timeRange}</small></td>
                <td>${status}</td>
                <td>
                  <button class="action-btn btn-view" onclick="viewNotification('${notif.id}')">üëÅÔ∏è Xem</button>
                  <button class="action-btn btn-edit" onclick="editNotification('${notif.id}')">‚úèÔ∏è S·ª≠a</button>
                  <button class="action-btn btn-delete" onclick="deleteNotification('${notif.id}')">üóëÔ∏è X√≥a</button>
                </td>
              </tr>
            `;
          });
        }
        
        tableHTML += `
            </tbody>
          </table>
        `;
        
        document.getElementById('systemNotificationsList').innerHTML = tableHTML;
        
      } catch (error) {
        console.error('L·ªói load th√¥ng b√°o:', error);
        document.getElementById('systemNotificationsList').innerHTML = `
          <div style="text-align: center; padding: 50px; color: #dc3545;">
            ‚ùå C√≥ l·ªói x·∫£y ra khi t·∫£i danh s√°ch th√¥ng b√°o
          </div>
        `;
      }
    }

    // üëÅÔ∏è Xem chi ti·∫øt th√¥ng b√°o
    async function viewNotification(id) {
      try {
        const snapshot = await db.ref('systemNotifications/' + id).once('value');
        const notif = snapshot.val();
        
        if (!notif) {
          alert('‚ùå Kh√¥ng t√¨m th·∫•y th√¥ng b√°o!');
          return;
        }
        
        const timeRange = notif.endDate ? 
          `${notif.startDate} ${notif.startTime} - ${notif.endDate} ${notif.endTime}` :
          `T·ª´ ${notif.startDate} ${notif.startTime} (v√¥ th·ªùi h·∫°n)`;
          
        alert(`üì¢ CHI TI·∫æT TH√îNG B√ÅO\\n\\n` +
              `Ti√™u ƒë·ªÅ: ${notif.title}\\n\\n` +
              `N·ªôi dung: ${notif.content}\\n\\n` +
              `Th·ªùi gian: ${timeRange}\\n\\n` +
              `ƒê·ªô ∆∞u ti√™n: ${notif.priority}\\n\\n` +
              `T·∫°o b·ªüi: ${notif.createdBy}\\n` +
              `T·∫°o l√∫c: ${new Date(notif.createdAt).toLocaleString('vi-VN')}`);
              
      } catch (error) {
        console.error('L·ªói xem th√¥ng b√°o:', error);
        alert('‚ùå C√≥ l·ªói x·∫£y ra!');
      }
    }

    // ‚úèÔ∏è S·ª≠a th√¥ng b√°o
    function editNotification(id) {
      alert('üöß Ch·ª©c nƒÉng s·ª≠a th√¥ng b√°o ƒëang ph√°t tri·ªÉn!');
    }

    // üóëÔ∏è X√≥a th√¥ng b√°o
    async function deleteNotification(id) {
      if (!confirm('ü§î B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a th√¥ng b√°o n√†y kh√¥ng?\\n\\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) {
        return;
      }
      
      try {
        await db.ref('systemNotifications/' + id).remove();
        
        // Ghi log
        await db.ref('adminLogs').push({
          action: 'X√≥a th√¥ng b√°o h·ªá th·ªëng',
          details: 'ID: ' + id,
          admin: 'admin@etax.vn',
          timestamp: Date.now(),
          date: new Date().toLocaleString('vi-VN')
        });
        
        alert('‚úÖ ƒê√£ x√≥a th√¥ng b√°o th√†nh c√¥ng!');
        loadSystemNotifications();
        
      } catch (error) {
        console.error('L·ªói x√≥a th√¥ng b√°o:', error);
        alert('‚ùå C√≥ l·ªói x·∫£y ra khi x√≥a th√¥ng b√°o!');
      }
    }

    // üë• Load user management v·ªõi OTP system
    async function loadUserManagement() {
      showUserTab('approved');
    }

    // üìã Show user tab
    async function showUserTab(tabType) {
      // Update tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = 'transparent';
      });
      event.target.classList.add('active');
      event.target.style.background = 'white';

      const contentDiv = document.getElementById('userTabContent');
      
      if (tabType === 'approved') {
        await loadApprovedUsers(contentDiv);
      } else if (tabType === 'pending') {
        await loadPendingRequests(contentDiv);
      } else if (tabType === 'blocked') {
        await loadBlockedUsers(contentDiv);
      }
    }

    // ‚úÖ Load approved users
    async function loadApprovedUsers(container) {
      try {
        const snapshot = await db.ref('users').orderByChild('status').equalTo('active').once('value');
        const users = [];
        
        snapshot.forEach(child => {
          users.push({
            mst: child.key,
            ...child.val()
          });
        });

        let tableHTML = `
          <table class="data-table">
            <thead>
              <tr>
                <th>MST</th>
                <th>Ng√†y t·∫°o</th>
                <th>L·∫ßn ƒëƒÉng nh·∫≠p cu·ªëi</th>
                <th>Tr·∫°ng th√°i</th>
                <th>H√†nh ƒë·ªông</th>
              </tr>
            </thead>
            <tbody>
        `;

        if (users.length === 0) {
          tableHTML += `
            <tr>
              <td colspan="5" style="text-align: center; padding: 50px; color: #666;">
                ‚úÖ Ch∆∞a c√≥ user n√†o ƒë∆∞·ª£c duy·ªát
              </td>
            </tr>
          `;
        } else {
          users.forEach(user => {
            const createdDate = new Date(user.createdAt).toLocaleString('vi-VN');
            const lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleString('vi-VN') : 'Ch∆∞a ƒëƒÉng nh·∫≠p';
            
            tableHTML += `
              <tr>
                <td><strong>${user.mst}</strong></td>
                <td>${createdDate}</td>
                <td>${lastLogin}</td>
                <td><span style="color: #28a745;">üü¢ Ho·∫°t ƒë·ªông</span></td>
                <td>
                  <button class="action-btn btn-edit" onclick="requireOTPUser('${user.mst}')">üîê Y√™u c·∫ßu OTP</button>
                  <button class="action-btn btn-delete" onclick="blockUser('${user.mst}')">üö´ Kh√≥a</button>
                  <button class="action-btn btn-view" onclick="viewUserDetails('${user.mst}')">üëÅÔ∏è Chi ti·∫øt</button>
                </td>
              </tr>
            `;
          });
        }

        tableHTML += `</tbody></table>`;
        container.innerHTML = tableHTML;

      } catch (error) {
        console.error('Load approved users error:', error);
        container.innerHTML = `<div style="color: #dc3545; text-align: center; padding: 50px;">‚ùå L·ªói t·∫£i danh s√°ch user</div>`;
      }
    }

    // ‚è≥ Load pending requests
    async function loadPendingRequests(container = null) {
      try {
        const snapshot = await db.ref('userRequests').orderByChild('status').equalTo('pending').once('value');
        const requests = [];
        
        snapshot.forEach(child => {
          requests.push({
            id: child.key,
            ...child.val()
          });
        });

        // Update counts
        const count = requests.length;
        const pendingCountEl = document.getElementById('pendingCount');
        const pendingTabCountEl = document.getElementById('pendingTabCount');
        if (pendingCountEl) pendingCountEl.textContent = count;
        if (pendingTabCountEl) pendingTabCountEl.textContent = count;

        if (!container) return; // Ch·ªâ update count

        let tableHTML = `
          <table class="data-table">
            <thead>
              <tr>
                <th>MST</th>
                <th>Th·ªùi gian y√™u c·∫ßu</th>
                <th>User Agent</th>
                <th>H√†nh ƒë·ªông</th>
              </tr>
            </thead>
            <tbody>
        `;

        if (requests.length === 0) {
          tableHTML += `
            <tr>
              <td colspan="4" style="text-align: center; padding: 50px; color: #666;">
                ‚è≥ Kh√¥ng c√≥ y√™u c·∫ßu n√†o ƒëang ch·ªù duy·ªát
              </td>
            </tr>
          `;
        } else {
          requests.forEach(request => {
            const requestTime = new Date(request.requestTime).toLocaleString('vi-VN');
            const userAgent = request.userAgent ? request.userAgent.substring(0, 50) + '...' : 'Unknown';
            
            tableHTML += `
              <tr>
                <td><strong>${request.mst}</strong></td>
                <td>${requestTime}</td>
                <td><small>${userAgent}</small></td>
                <td>
                  <button class="action-btn btn-edit" onclick="approveUser('${request.id}', '${request.mst}')">‚úÖ Duy·ªát</button>
                  <button class="action-btn btn-delete" onclick="rejectUser('${request.id}')">‚ùå T·ª´ ch·ªëi</button>
                  <button class="action-btn btn-view" onclick="viewRequestDetails('${request.id}')">üëÅÔ∏è Chi ti·∫øt</button>
                </td>
              </tr>
            `;
          });
        }

        tableHTML += `</tbody></table>`;
        container.innerHTML = tableHTML;

      } catch (error) {
        console.error('Load pending requests error:', error);
        if (container) {
          container.innerHTML = `<div style="color: #dc3545; text-align: center; padding: 50px;">‚ùå L·ªói t·∫£i y√™u c·∫ßu ch·ªù duy·ªát</div>`;
        }
      }
    }

    // ‚úÖ Approve user
    async function approveUser(requestId, mst) {
      const otp = prompt('üîê Nh·∫≠p m√£ OTP 6 s·ªë ƒë·ªÉ g·ª≠i cho user:');
      
      if (!otp || otp.length !== 6 || !/^[0-9]+$/.test(otp)) {
        alert('‚ùå Vui l√≤ng nh·∫≠p m√£ OTP 6 s·ªë!');
        return;
      }

      try {
        // Update request v·ªõi OTP v√† approve
        await db.ref('userRequests/' + requestId).update({
          status: 'approved',
          otp: otp,
          approvedTime: Date.now(),
          approvedBy: 'admin@etax.vn'
        });

        // Ghi log
        await db.ref('adminLogs').push({
          action: 'Duy·ªát user v√† g·ª≠i OTP',
          details: \`MST: \${mst}, OTP: \${otp}\`,
          admin: 'admin@etax.vn',
          timestamp: Date.now(),
          date: new Date().toLocaleString('vi-VN')
        });

        alert(\`‚úÖ ƒê√£ duy·ªát user MST: \${mst}\\n\\nüîê OTP ƒë√£ g·ª≠i: \${otp}\\n\\nVui l√≤ng th√¥ng b√°o m√£ n√†y cho user!\`);
        
        // Reload pending requests
        loadPendingRequests();
        
      } catch (error) {
        console.error('Approve user error:', error);
        alert('‚ùå C√≥ l·ªói x·∫£y ra khi duy·ªát user!');
      }
    }

    // ‚ùå Reject user
    async function rejectUser(requestId) {
      if (!confirm('ü§î B·∫°n c√≥ ch·∫Øc mu·ªën t·ª´ ch·ªëi y√™u c·∫ßu n√†y?')) return;

      try {
        await db.ref('userRequests/' + requestId).update({
          status: 'rejected',
          rejectedTime: Date.now(),
          rejectedBy: 'admin@etax.vn'
        });

        alert('‚úÖ ƒê√£ t·ª´ ch·ªëi y√™u c·∫ßu!');
        loadPendingRequests();
        
      } catch (error) {
        console.error('Reject user error:', error);
        alert('‚ùå C√≥ l·ªói x·∫£y ra khi t·ª´ ch·ªëi!');
      }
    }

    // üîê Require OTP for existing user
    async function requireOTPUser(mst) {
      if (!confirm(\`üîê Y√™u c·∫ßu user MST: \${mst} ph·∫£i nh·∫≠p OTP l·∫°i l·∫ßn ƒëƒÉng nh·∫≠p ti·∫øp theo?\\n\\nUser s·∫Ω ph·∫£i ch·ªù admin duy·ªát v√† g·ª≠i OTP m·ªõi.\`)) return;

      try {
        await db.ref('users/' + mst).update({
          requireOTP: true,
          otpRequiredTime: Date.now(),
          otpRequiredBy: 'admin@etax.vn'
        });

        alert(\`‚úÖ ƒê√£ y√™u c·∫ßu OTP cho user MST: \${mst}\\n\\nL·∫ßn ƒëƒÉng nh·∫≠p ti·∫øp theo user s·∫Ω ph·∫£i ch·ªù admin duy·ªát.\`);
        
      } catch (error) {
        console.error('Require OTP error:', error);
        alert('‚ùå C√≥ l·ªói x·∫£y ra!');
      }
    }

    // üö´ Block user
    async function blockUser(mst) {
      if (!confirm(\`üö´ Kh√≥a user MST: \${mst}?\\n\\nUser s·∫Ω kh√¥ng th·ªÉ ƒëƒÉng nh·∫≠p cho ƒë·∫øn khi ƒë∆∞·ª£c m·ªü kh√≥a.\`)) return;

      try {
        await db.ref('users/' + mst).update({
          status: 'blocked',
          blockedTime: Date.now(),
          blockedBy: 'admin@etax.vn'
        });

        alert(\`‚úÖ ƒê√£ kh√≥a user MST: \${mst}\`);
        loadUserManagement();
        
      } catch (error) {
        console.error('Block user error:', error);
        alert('‚ùå C√≥ l·ªói x·∫£y ra khi kh√≥a user!');
      }
    }

    // Start real-time listening for pending requests
    function startRealtimeUserMonitoring() {
      db.ref('userRequests').on('child_added', (snapshot) => {
        const request = snapshot.val();
        if (request.status === 'pending') {
          // Update count and show notification
          loadPendingRequests();
          
          // Desktop notification
          if (Notification.permission === 'granted') {
            new Notification('üîê Y√™u c·∫ßu ƒëƒÉng nh·∫≠p m·ªõi', {
              body: \`User MST: \${request.mst} mu·ªën ƒëƒÉng nh·∫≠p\`,
              icon: 'assets/logo.png'
            });
          }
        }
      });
    }

    // üì¢ T·∫°o th√¥ng b√°o h·ªá th·ªëng m·ªõi
    function createSystemNotification() {
      document.getElementById('contentArea').innerHTML = `
        <div class="content-header">
          <h2 class="content-title">üì¢ T·∫†O TH√îNG B√ÅO H·ªÜ TH·ªêNG</h2>
          <button class="add-btn" onclick="showSystemNotifications()" style="background: #6c757d;">
            <i class="fas fa-arrow-left"></i> Quay l·∫°i danh s√°ch
          </button>
        </div>
        
        <div style="max-width: 800px;">
          <form id="systemNotificationForm" onsubmit="saveSystemNotification(event)">
            
            <!-- Lo·∫°i th√¥ng b√°o -->
            <div style="margin-bottom: 25px;">
              <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;">
                üè∑Ô∏è Lo·∫°i th√¥ng b√°o:
              </label>
              <select id="notificationType" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                <option value="maintenance">üîß B·∫£o tr√¨ h·ªá th·ªëng</option>
                <option value="announcement">üì¢ Th√¥ng b√°o chung</option>
                <option value="urgent">üö® Kh·∫©n c·∫•p</option>
                <option value="update">üì± C·∫≠p nh·∫≠t h·ªá th·ªëng</option>
                <option value="holiday">üéâ Ng√†y l·ªÖ / Ngh·ªâ</option>
              </select>
            </div>

            <!-- Ti√™u ƒë·ªÅ -->
            <div style="margin-bottom: 25px;">
              <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;">
                üìù Ti√™u ƒë·ªÅ th√¥ng b√°o:
              </label>
              <input type="text" id="notificationTitle" required
                placeholder="VD: T·∫°m ng·ª´ng giao d·ªãch thu·∫ø ƒë·ªÉ b·∫£o tr√¨ h·ªá th·ªëng"
                style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
            </div>

            <!-- N·ªôi dung -->
            <div style="margin-bottom: 25px;">
              <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;">
                üìÑ N·ªôi dung th√¥ng b√°o:
              </label>
              <textarea id="notificationContent" rows="4" required
                placeholder="M√¥ t·∫£ chi ti·∫øt n·ªôi dung th√¥ng b√°o..."
                style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; resize: vertical;"></textarea>
            </div>

            <!-- Th·ªùi gian hi·ªÉn th·ªã -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;">
                  üìÖ Ng√†y b·∫Øt ƒë·∫ßu hi·ªÉn th·ªã:
                </label>
                <input type="date" id="startDate" required
                  style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
              </div>
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;">
                  ‚è∞ Gi·ªù b·∫Øt ƒë·∫ßu:
                </label>
                <input type="time" id="startTime" required
                  style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
              </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;">
                  üìÖ Ng√†y k·∫øt th√∫c hi·ªÉn th·ªã:
                </label>
                <input type="date" id="endDate"
                  style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                <small style="color: #666;">ƒê·ªÉ tr·ªëng n·∫øu hi·ªÉn th·ªã v√¥ th·ªùi h·∫°n</small>
              </div>
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;">
                  ‚è∞ Gi·ªù k·∫øt th√∫c:
                </label>
                <input type="time" id="endTime"
                  style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
              </div>
            </div>

            <!-- Hi·ªÉn th·ªã tr√™n trang n√†o -->
            <div style="margin-bottom: 25px;">
              <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;">
                üì± Hi·ªÉn th·ªã tr√™n c√°c trang:
              </label>
              <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <label style="display: block; margin-bottom: 10px;">
                  <input type="checkbox" id="showOnAll" checked onchange="toggleAllPages()" style="margin-right: 8px;">
                  <strong>‚úÖ T·∫•t c·∫£ trang (khuy·∫øn ngh·ªã)</strong>
                </label>
                <div id="specificPages" style="display: none; margin-left: 20px;">
                  <label style="display: block; margin-bottom: 5px;"><input type="checkbox" style="margin-right: 8px;"> üè† Trang ch·ªß (index.html)</label>
                  <label style="display: block; margin-bottom: 5px;"><input type="checkbox" style="margin-right: 8px;"> üì¢ Th√¥ng b√°o (thongbao.html)</label>
                  <label style="display: block; margin-bottom: 5px;"><input type="checkbox" style="margin-right: 8px;"> üìÑ H√≥a ƒë∆°n ƒëi·ªán t·ª≠ (hoadondt.html)</label>
                  <label style="display: block; margin-bottom: 5px;"><input type="checkbox" style="margin-right: 8px;"> üìã Khai thu·∫ø (khaithue.html)</label>
                  <label style="display: block; margin-bottom: 5px;"><input type="checkbox" style="margin-right: 8px;"> üí∞ N·ªôp thu·∫ø (nopthue.html)</label>
                </div>
              </div>
            </div>

            <!-- ƒê·ªô ∆∞u ti√™n -->
            <div style="margin-bottom: 30px;">
              <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;">
                ‚≠ê ƒê·ªô ∆∞u ti√™n hi·ªÉn th·ªã:
              </label>
              <select id="priority" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                <option value="normal">üìå B√¨nh th∆∞·ªùng</option>
                <option value="high">üî• Cao (n·ªïi b·∫≠t)</option>
                <option value="critical">üö® C·ª±c cao (popup)</option>
              </select>
            </div>

            <!-- Buttons -->
            <div style="display: flex; gap: 15px; justify-content: flex-end;">
              <button type="button" onclick="showSystemNotifications()" 
                style="padding: 12px 24px; border: 2px solid #6c757d; background: white; color: #6c757d; border-radius: 8px; cursor: pointer; font-weight: 600;">
                ‚ùå H·ªßy b·ªè
              </button>
              <button type="submit"
                style="padding: 12px 24px; border: none; background: #28a745; color: white; border-radius: 8px; cursor: pointer; font-weight: 600;">
                üíæ L∆∞u th√¥ng b√°o
              </button>
            </div>
          </form>
        </div>
      `;
      
      // Set default date to today
      const today = new Date();
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      
      document.getElementById('startDate').value = today.toISOString().split('T')[0];
      document.getElementById('startTime').value = '08:00';
      document.getElementById('endDate').value = tomorrow.toISOString().split('T')[0];
      document.getElementById('endTime').value = '17:00';
    }

    // üîÑ Toggle hi·ªÉn th·ªã t·∫•t c·∫£ trang
    function toggleAllPages() {
      const showOnAll = document.getElementById('showOnAll').checked;
      const specificPages = document.getElementById('specificPages');
      specificPages.style.display = showOnAll ? 'none' : 'block';
    }

    // üíæ L∆∞u th√¥ng b√°o h·ªá th·ªëng
    async function saveSystemNotification(event) {
      event.preventDefault();
      
      const formData = {
        type: document.getElementById('notificationType').value,
        title: document.getElementById('notificationTitle').value,
        content: document.getElementById('notificationContent').value,
        startDate: document.getElementById('startDate').value,
        startTime: document.getElementById('startTime').value,
        endDate: document.getElementById('endDate').value,
        endTime: document.getElementById('endTime').value,
        showOnAll: document.getElementById('showOnAll').checked,
        priority: document.getElementById('priority').value,
        createdAt: Date.now(),
        createdBy: 'admin@etax.vn',
        status: 'active'
      };

      try {
        // L∆∞u v√†o Firebase
        const notificationRef = await db.ref('systemNotifications').push(formData);
        
        // Ghi log
        await db.ref('adminLogs').push({
          action: 'T·∫°o th√¥ng b√°o h·ªá th·ªëng',
          details: formData.title,
          admin: 'admin@etax.vn',
          timestamp: Date.now(),
          date: new Date().toLocaleString('vi-VN')
        });

        alert('‚úÖ ƒê√£ t·∫°o th√¥ng b√°o h·ªá th·ªëng th√†nh c√¥ng!\\n\\nTh√¥ng b√°o s·∫Ω hi·ªÉn th·ªã tr√™n t·∫•t c·∫£ trang con theo th·ªùi gian ƒë√£ thi·∫øt l·∫≠p.');
        showSystemNotifications();
        
      } catch (error) {
        console.error('L·ªói l∆∞u th√¥ng b√°o:', error);
        alert('‚ùå C√≥ l·ªói x·∫£y ra khi l∆∞u th√¥ng b√°o!');
      }
    }

    // üë§ T·∫°o user m·ªõi
    function createUser() {
      alert('üöß Ch·ª©c nƒÉng ƒëang ph√°t tri·ªÉn - S·∫Ω c√≥ trong b∆∞·ªõc ti·∫øp theo!');
    }

    // üìÑ QU·∫¢N L√ù N·ªòI DUNG
    // üé® Open Visual Editor in new tab
    function openVisualEditor() {
      // Find and set active menu item
      const menuItems = document.querySelectorAll('.menu-item');
      menuItems.forEach(item => item.classList.remove('active'));
      const visualEditorMenu = document.querySelector('[onclick="openVisualEditor()"]');
      if (visualEditorMenu) {
        visualEditorMenu.classList.add('active');
      }
      
      // Open in new tab
      window.open('multi-page-visual-editor.html', '_blank', 'width=1400,height=900');
      
      // Also show info in current panel
      document.getElementById('contentArea').innerHTML = `
        <div class="content-header">
          <h2 class="content-title">üé® VISUAL EDITOR</h2>
          <button class="add-btn" onclick="openVisualEditor()">
            <i class="fas fa-external-link-alt"></i> M·ªü l·∫°i Visual Editor
          </button>
        </div>
        
        <div style="background: #e8f4fd; padding: 30px; border-radius: 15px; text-align: center;">
          <div style="font-size: 48px; margin-bottom: 20px;">üé®</div>
          <h3 style="color: #333; margin-bottom: 15px;">Visual Editor ƒë√£ m·ªü trong tab m·ªõi!</h3>
          <p style="color: #666; margin-bottom: 25px;">
            C√¥ng c·ª• ch·ªânh s·ª≠a visual cho ph√©p anh:
          </p>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 25px 0;">
            <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              <div style="font-size: 24px; margin-bottom: 10px;">üì±</div>
              <h4>Ch·ªânh s·ª≠a tr·ª±c ti·∫øp</h4>
              <p style="font-size: 13px; color: #666;">Click v√†o element ƒë·ªÉ ch·ªânh s·ª≠a styling</p>
            </div>
            
            <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              <div style="font-size: 24px; margin-bottom: 10px;">üéØ</div>
              <h4>Multi-page editing</h4>
              <p style="font-size: 13px; color: #666;">Qu·∫£n l√Ω t·∫•t c·∫£ 13 trang eTax</p>
            </div>
            
            <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              <div style="font-size: 24px; margin-bottom: 10px;">üíæ</div>
              <h4>Live saving</h4>
              <p style="font-size: 13px; color: #666;">Thay ƒë·ªïi ƒë∆∞·ª£c l∆∞u ngay v√†o Firebase</p>
            </div>
          </div>
          
          <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
            <strong>üí° H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng:</strong><br>
            1. Ch·ªçn trang t·ª´ sidebar tr√°i<br>
            2. Click v√†o element mu·ªën ch·ªânh s·ª≠a<br>
            3. Thay ƒë·ªïi style ·ªü panel ph·∫£i<br>
            4. ·∫§n "√Åp d·ª•ng thay ƒë·ªïi" ƒë·ªÉ l∆∞u
          </div>
        </div>
      `;
    }

    function showContentManagement() {
      // Fix active menu
      document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
      const contentMenu = document.querySelector('[onclick="showContentManagement()"]');
      if (contentMenu) {
        contentMenu.classList.add('active');
      }
      document.getElementById('contentArea').innerHTML = `
        <div class="content-header">
          <h2 class="content-title">üìÑ QU·∫¢N L√ù N·ªòI DUNG</h2>
          <button class="add-btn" onclick="createNewContent()">
            <i class="fas fa-plus"></i> T·∫°o n·ªôi dung m·ªõi
          </button>
        </div>
        
        <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
          <h4 style="color: #2e7d32; margin-bottom: 10px;">üìù RICH TEXT EDITOR:</h4>
          <p style="color: #333; margin-bottom: 10px;">‚Ä¢ Editor v·ªõi PWA design system match eTax Mobile</p>
          <p style="color: #333; margin-bottom: 10px;">‚Ä¢ Live preview responsive (Mobile/Tablet/Desktop)</p>
          <p style="color: #333; margin-bottom: 10px;">‚Ä¢ PWA Components: Header ƒë·ªè, Cards, Buttons, Tables</p>
          <p style="color: #333;">‚Ä¢ Auto-save v√† sync real-time v·ªõi Firebase</p>
        </div>

        <div class="content-types-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
          
          <div class="content-type-card" style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-left: 4px solid #b71c1c;">
            <h4 style="margin-top: 0; color: #b71c1c;">üì¢ Th√¥ng b√°o trang</h4>
            <p style="color: #666; margin-bottom: 15px;">T·∫°o th√¥ng b√°o cho t·ª´ng trang ri√™ng bi·ªát</p>
            <button onclick="createPageNotification()" style="background: #b71c1c; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
              ‚ûï T·∫°o th√¥ng b√°o
            </button>
          </div>

          <div class="content-type-card" style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-left: 4px solid #28a745;">
            <h4 style="margin-top: 0; color: #28a745;">üìã N·ªôi dung trang</h4>
            <p style="color: #666; margin-bottom: 15px;">Ch·ªânh s·ª≠a n·ªôi dung ch√≠nh c·ªßa c√°c trang</p>
            <button onclick="editPageContent()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
              ‚úèÔ∏è Ch·ªânh s·ª≠a
            </button>
          </div>

          <div class="content-type-card" style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-left: 4px solid #17a2b8;">
            <h4 style="margin-top: 0; color: #17a2b8;">üìä D·ªØ li·ªáu ƒë·ªông</h4>
            <p style="color: #666; margin-bottom: 15px;">Qu·∫£n l√Ω d·ªØ li·ªáu thay ƒë·ªïi theo user</p>
            <button onclick="manageDynamicData()" style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
              üîÑ Qu·∫£n l√Ω
            </button>
          </div>

        </div>

        <div id="contentManagementEditor" style="min-height: 400px;">
          <!-- Rich Text Editor s·∫Ω load ·ªü ƒë√¢y -->
        </div>
      `;
    }

    // üìù T·∫°o n·ªôi dung m·ªõi v·ªõi Rich Editor
    function createNewContent() {
      document.getElementById('contentManagementEditor').innerHTML = `
        <div style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
          <h3 style="margin-bottom: 20px; color: #333;">üìù T·∫†O N·ªòI DUNG M·ªöI</h3>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;">
              üì± Ch·ªçn trang √°p d·ª•ng:
            </label>
            <select id="targetPage" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
              <option value="">-- Ch·ªçn trang --</option>
              <option value="index.html">üè† Trang ch·ªß (index.html)</option>
              <option value="thongbao.html">üì¢ Th√¥ng b√°o (thongbao.html)</option>
              <option value="hoadondt.html">üìÑ H√≥a ƒë∆°n ƒëi·ªán t·ª≠ (hoadondt.html)</option>
              <option value="khaithue.html">üìã Khai thu·∫ø (khaithue.html)</option>
              <option value="nopthue.html">üí∞ N·ªôp thu·∫ø (nopthue.html)</option>
              <option value="nghiavu.html">üè¢ Nghƒ©a v·ª• (nghiavu.html)</option>
              <option value="tienich.html">üîß Ti·ªán √≠ch (tienich.html)</option>
              <option value="hotro.html">‚ùì H·ªó tr·ª£ (hotro.html)</option>
            </select>
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;">
              üéØ Lo·∫°i n·ªôi dung:
            </label>
            <select id="contentType" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
              <option value="announcement">üì¢ Th√¥ng b√°o</option>
              <option value="information">‚ÑπÔ∏è Th√¥ng tin</option>
              <option value="instruction">üìã H∆∞·ªõng d·∫´n</option>
              <option value="form">üìù Bi·ªÉu m·∫´u</option>
              <option value="table">üìä B·∫£ng d·ªØ li·ªáu</option>
            </select>
          </div>

          <div id="richTextEditorContainer"></div>
          
          <div style="margin-top: 20px; text-align: right;">
            <button onclick="showContentManagement()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; margin-right: 10px; cursor: pointer;">
              ‚ùå H·ªßy
            </button>
            <button onclick="saveNewContent()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
              üíæ L∆∞u n·ªôi dung
            </button>
          </div>
        </div>
      `;
      
      // Initialize Rich Text Editor
      initETaxRichEditor('richTextEditorContainer', {
        showPreview: true,
        autoSave: true,
        mobileFirst: true
      });
    }

    // üíæ L∆∞u n·ªôi dung m·ªõi
    async function saveNewContent() {
      const targetPage = document.getElementById('targetPage').value;
      const contentType = document.getElementById('contentType').value;
      
      if (!targetPage) {
        alert('‚ùå Vui l√≤ng ch·ªçn trang √°p d·ª•ng!');
        return;
      }
      
      const content = etaxEditor.getContent();
      
      if (!content || content.trim() === '') {
        alert('‚ùå Vui l√≤ng nh·∫≠p n·ªôi dung!');
        return;
      }
      
      try {
        const contentData = {
          targetPage: targetPage,
          contentType: contentType,
          content: content,
          createdAt: Date.now(),
          createdBy: 'admin@etax.vn',
          status: 'active',
          lastModified: Date.now()
        };
        
        // L∆∞u v√†o Firebase
        await db.ref('pageContent').push(contentData);
        
        // Ghi log
        await db.ref('adminLogs').push({
          action: 'T·∫°o n·ªôi dung m·ªõi',
          details: \`\${contentType} cho \${targetPage}\`,
          admin: 'admin@etax.vn',
          timestamp: Date.now(),
          date: new Date().toLocaleString('vi-VN')
        });
        
        alert('‚úÖ ƒê√£ t·∫°o n·ªôi dung th√†nh c√¥ng!\\n\\nN·ªôi dung s·∫Ω hi·ªÉn th·ªã tr√™n trang ƒë∆∞·ª£c ch·ªçn.');
        showContentManagement();
        
      } catch (error) {
        console.error('L·ªói l∆∞u n·ªôi dung:', error);
        alert('‚ùå C√≥ l·ªói x·∫£y ra khi l∆∞u n·ªôi dung!');
      }
    }

    // üì¢ T·∫°o th√¥ng b√°o cho trang
    function createPageNotification() {
      alert('üöß Ch·ª©c nƒÉng t·∫°o th√¥ng b√°o ri√™ng cho t·ª´ng trang ƒëang ph√°t tri·ªÉn!');
    }

    // ‚úèÔ∏è Ch·ªânh s·ª≠a n·ªôi dung trang
    function editPageContent() {
      alert('üöß Ch·ª©c nƒÉng ch·ªânh s·ª≠a n·ªôi dung trang ƒëang ph√°t tri·ªÉn!');
    }

    // üîÑ Qu·∫£n l√Ω d·ªØ li·ªáu ƒë·ªông
    function manageDynamicData() {
      alert('üöß Ch·ª©c nƒÉng qu·∫£n l√Ω d·ªØ li·ªáu ƒë·ªông ƒëang ph√°t tri·ªÉn!');
    }

    function showPageManagement() {
      // Fix active menu
      document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
      const pageMenu = document.querySelector('[onclick="showPageManagement()"]');
      if (pageMenu) {
        pageMenu.classList.add('active');
      }
      
      document.getElementById('contentArea').innerHTML = `
        <div class="content-header">
          <h2 class="content-title">üì± QU·∫¢N L√ù TRANG CON</h2>
          <button class="add-btn" onclick="alert('T√≠nh nƒÉng s·∫Ω ƒë∆∞·ª£c ph√°t tri·ªÉn!')">
            <i class="fas fa-plus"></i> Th√™m trang m·ªõi
          </button>
        </div>
        
        <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; text-align: center;">
          <h3>üöß Ch·ª©c nƒÉng ƒëang ph√°t tri·ªÉn</h3>
          <p>Qu·∫£n l√Ω c√°c trang con s·∫Ω ƒë∆∞·ª£c b·ªï sung trong phi√™n b·∫£n ti·∫øp theo</p>
        </div>
      `;
    }

    function showSystemLogs() {
      // Fix active menu
      document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
      const logMenu = document.querySelector('[onclick="showSystemLogs()"]');
      if (logMenu) {
        logMenu.classList.add('active');
      }
      
      document.getElementById('contentArea').innerHTML = `
        <div class="content-header">
          <h2 class="content-title">üìã NH·∫¨T K√ù H·ªÜ TH·ªêNG</h2>
          <button class="add-btn" onclick="alert('T√≠nh nƒÉng export logs s·∫Ω ƒë∆∞·ª£c b·ªï sung!')">
            <i class="fas fa-download"></i> Export logs
          </button>
        </div>
        
        <div style="background: #fff3cd; padding: 20px; border-radius: 10px; text-align: center;">
          <h3>üìã System Logs</h3>
          <p>Ch·ª©c nƒÉng theo d√µi nh·∫≠t k√Ω h·ªá th·ªëng s·∫Ω ƒë∆∞·ª£c ph√°t tri·ªÉn</p>
        </div>
      `;
    }

    function showSettings() {
      // Fix active menu
      document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
      const settingsMenu = document.querySelector('[onclick="showSettings()"]');
      if (settingsMenu) {
        settingsMenu.classList.add('active');
      }
      
      document.getElementById('contentArea').innerHTML = `
        <div class="content-header">
          <h2 class="content-title">‚öôÔ∏è C√ÄI ƒê·∫∂T H·ªÜ TH·ªêNG</h2>
          <button class="add-btn" onclick="alert('T√≠nh nƒÉng backup s·∫Ω ƒë∆∞·ª£c b·ªï sung!')">
            <i class="fas fa-save"></i> Backup System
          </button>
        </div>
        
        <div style="background: #f8d7da; padding: 20px; border-radius: 10px; text-align: center;">
          <h3>‚öôÔ∏è System Settings</h3>
          <p>C√†i ƒë·∫∑t h·ªá th·ªëng s·∫Ω ƒë∆∞·ª£c ph√°t tri·ªÉn trong phi√™n b·∫£n ti·∫øp theo</p>
        </div>
      `;
    }

    // üöÄ INIT
    window.onload = function() {
      console.log('üõ°Ô∏è Admin Panel loading...');
      
      try {
        // Check session with detailed logging
        const session = localStorage.getItem('etax_admin_session');
        if (!session) {
          console.error('‚ùå No session found, redirecting to login');
          alert('‚ùå B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p! Chuy·ªÉn v·ªÅ trang ƒëƒÉng nh·∫≠p...');
          window.location.href = 'admin-login.html';
          return;
        }

        const sessionData = JSON.parse(session);
        if (Date.now() > sessionData.expiresAt) {
          console.error('‚è∞ Session expired, redirecting to login');
          alert('‚è∞ Phi√™n l√†m vi·ªác ƒë√£ h·∫øt h·∫°n! Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i...');
          localStorage.removeItem('etax_admin_session');
          window.location.href = 'admin-login.html';
          return;
        }
        
        console.log('‚úÖ Session valid, initializing admin panel');
        
        // Start components
        updateTime();
        setInterval(updateTime, 1000);
        
        // Load dashboard with error handling
        console.log('üìä Loading dashboard...');
        showDashboard();
        
        // Start real-time monitoring
        startRealtimeUserMonitoring();
        
        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
          Notification.requestPermission();
        }
        
        console.log('‚úÖ Admin Panel loaded successfully');
        
      } catch (error) {
        console.error('‚ùå Admin Panel initialization failed:', error);
        alert('‚ùå C√≥ l·ªói khi kh·ªüi t·∫°o admin panel: ' + error.message);
      }
    };
  </script>
</body>
</html>