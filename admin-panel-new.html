<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ›¡ï¸ Báº¢NG ÄIá»€U KHIá»‚N eTAX ADMIN</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  
  <!-- ğŸ“ eTax Rich Text Editor -->
  <script src="js/etax-rich-editor.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', 'Tahoma', 'Microsoft Sans Serif', 'Arial', sans-serif;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    /* ğŸ¯ HEADER ADMIN */
    .admin-header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .admin-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 24px;
      font-weight: 700;
      color: #dc3545;
    }

    .admin-user {
      display: flex;
      align-items: center;
      gap: 15px;
      font-size: 14px;
      color: #666;
    }

    .logout-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.3s;
    }

    .logout-btn:hover {
      background: #c82333;
    }

    /* ğŸ“Š MAIN CONTAINER */
    .admin-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 30px;
    }

    /* ğŸ›ï¸ SIDEBAR MENU */
    .admin-sidebar {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      height: fit-content;
      position: sticky;
      top: 100px;
    }

    .sidebar-title {
      font-size: 18px;
      font-weight: 700;
      color: #333;
      margin-bottom: 20px;
      text-align: center;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .menu-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 15px;
      margin-bottom: 8px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      color: #666;
      font-weight: 500;
    }

    .menu-item:hover, .menu-item.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      transform: translateX(5px);
    }

    .menu-icon {
      font-size: 18px;
      width: 24px;
    }

    /* ğŸ“± MAIN CONTENT */
    .admin-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      min-height: 600px;
    }

    .content-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #f0f0f0;
    }

    .content-title {
      font-size: 28px;
      font-weight: 700;
      color: #333;
    }

    .add-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
    }

    .add-btn:hover {
      background: #218838;
      transform: translateY(-2px);
    }

    /* ğŸ“Š DASHBOARD STATS */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
      text-align: center;
    }

    .stat-number {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }

    /* ğŸ“‹ TABLE STYLES */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .data-table th,
    .data-table td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #f0f0f0;
    }

    .data-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #333;
    }

    .data-table tr:hover {
      background: #f8f9fa;
    }

    /* ğŸ¨ ACTION BUTTONS */
    .action-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      margin-right: 5px;
      transition: all 0.3s;
    }

    .btn-edit {
      background: #ffc107;
      color: #333;
    }

    .btn-delete {
      background: #dc3545;
      color: white;
    }

    .btn-view {
      background: #17a2b8;
      color: white;
    }

    .action-btn:hover {
      transform: scale(1.05);
    }

    /* ğŸ“± RESPONSIVE */
    @media (max-width: 768px) {
      .admin-container {
        grid-template-columns: 1fr;
        gap: 20px;
        padding: 20px 15px;
      }
      
      .admin-header {
        padding: 15px 20px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    /* ğŸ”„ LOADING STATE */
    .loading {
      text-align: center;
      padding: 50px;
      color: #666;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- ğŸ¯ HEADER -->
  <div class="admin-header">
    <div class="admin-logo">
      <i class="fas fa-shield-alt"></i>
      Báº¢NG ÄIá»€U KHIá»‚N eTAX
    </div>
    <div class="admin-user">
      <span>ğŸ‘¨â€ğŸ’¼ Xin chÃ o, Admin</span>
      <span id="currentTime"></span>
      <button class="logout-btn" onclick="adminLogout()">
        <i class="fas fa-sign-out-alt"></i> ÄÄƒng xuáº¥t
      </button>
    </div>
  </div>

  <!-- ğŸ“Š MAIN CONTAINER -->
  <div class="admin-container">
    <!-- ğŸ›ï¸ SIDEBAR -->
    <div class="admin-sidebar">
      <div class="sidebar-title">ğŸ“‹ MENU QUáº¢N LÃ</div>
      
      <div class="menu-item active" onclick="showDashboard()">
        <i class="menu-icon fas fa-tachometer-alt"></i>
        Tá»•ng quan há»‡ thá»‘ng
      </div>
      
      <div class="menu-item" onclick="showSystemNotifications()">
        <i class="menu-icon fas fa-bullhorn"></i>
        ThÃ´ng bÃ¡o toÃ n há»‡ thá»‘ng
      </div>
      
      <div class="menu-item" onclick="showUserManagement()">
        <i class="menu-icon fas fa-users"></i>
        Quáº£n lÃ½ ngÆ°á»i dÃ¹ng
      </div>
      
      <div class="menu-item" onclick="showContentManagement()">
        <i class="menu-icon fas fa-file-alt"></i>
        Quáº£n lÃ½ ná»™i dung
      </div>
      
      <div class="menu-item" onclick="openVisualEditor()">
        <i class="menu-icon fas fa-paint-brush"></i>
        Visual Editor
      </div>
      
      <div class="menu-item" onclick="showPageManagement()">
        <i class="menu-icon fas fa-sitemap"></i>
        Quáº£n lÃ½ trang con
      </div>
      
      <div class="menu-item" onclick="showSystemLogs()">
        <i class="menu-icon fas fa-clipboard-list"></i>
        Nháº­t kÃ½ há»‡ thá»‘ng
      </div>
      
      <div class="menu-item" onclick="showSettings()">
        <i class="menu-icon fas fa-cog"></i>
        CÃ i Ä‘áº·t há»‡ thá»‘ng
      </div>
    </div>

    <!-- ğŸ“± MAIN CONTENT -->
    <div class="admin-content">
      <div id="contentArea">
        <!-- Dashboard sáº½ load á»Ÿ Ä‘Ã¢y -->
        <div class="loading">
          <div class="spinner"></div>
          <p>Äang táº£i báº£ng Ä‘iá»u khiá»ƒn...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD_rJgBFgBulheVenQUE2KXr4PBpSpTCxw",
      authDomain: "etax-7fbf8.firebaseapp.com",
      databaseURL: "https://etax-7fbf8-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "etax-7fbf8",
      storageBucket: "etax-7fbf8.appspot.com",
      messagingSenderId: "1030026724634",
      appId: "1:1030026724634:web:d76f5f9dad43bad6fd58a3",
      measurementId: "G-YS5DLECJE6"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ğŸ” Kiá»ƒm tra session admin
    function checkAdminSession() {
      const session = localStorage.getItem('etax_admin_session');
      if (!session) {
        alert('âŒ Báº¡n chÆ°a Ä‘Äƒng nháº­p! Chuyá»ƒn vá» trang Ä‘Äƒng nháº­p...');
        window.location.href = 'admin-login.html';
        return false;
      }

      const sessionData = JSON.parse(session);
      if (Date.now() > sessionData.expiresAt) {
        alert('â° PhiÃªn lÃ m viá»‡c Ä‘Ã£ háº¿t háº¡n! Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i...');
        localStorage.removeItem('etax_admin_session');
        window.location.href = 'admin-login.html';
        return false;
      }

      return true;
    }

    // ğŸšª ÄÄƒng xuáº¥t admin
    function adminLogout() {
      if (confirm('ğŸ¤” Báº¡n cÃ³ cháº¯c muá»‘n Ä‘Äƒng xuáº¥t khÃ´ng?')) {
        localStorage.removeItem('etax_admin_session');
        alert('âœ… ÄÃ£ Ä‘Äƒng xuáº¥t thÃ nh cÃ´ng!');
        window.location.href = 'admin-login.html';
      }
    }

    // â° Cáº­p nháº­t thá»i gian
    function updateTime() {
      const now = new Date();
      document.getElementById('currentTime').textContent = 
        now.toLocaleString('vi-VN');
    }

    // ğŸ›ï¸ MENU FUNCTIONS
    function setActiveMenu(clickedItem) {
      document.querySelectorAll('.menu-item').forEach(item => {
        item.classList.remove('active');
      });
      clickedItem.classList.add('active');
    }

    // ğŸ“Š DASHBOARD
    function showDashboard() {
      // Fix active menu
      document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
      const dashboardMenu = document.querySelector('[onclick="showDashboard()"]');
      if (dashboardMenu) {
        dashboardMenu.classList.add('active');
      }
      document.getElementById('contentArea').innerHTML = `
        <div class="content-header">
          <h2 class="content-title">ğŸ“Š Tá»”NG QUAN Há»† THá»NG</h2>
          <span style="color: #666;">Cáº­p nháº­t: ${new Date().toLocaleString('vi-VN')}</span>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number" id="totalUsers">0</div>
            <div class="stat-label">ğŸ‘¥ Tá»•ng ngÆ°á»i dÃ¹ng</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="pendingUsers">0</div>
            <div class="stat-label">â³ Chá» duyá»‡t</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="systemNotifications">0</div>
            <div class="stat-label">ğŸ“¢ ThÃ´ng bÃ¡o há»‡ thá»‘ng</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalPages">13</div>
            <div class="stat-label">ğŸ“± Trang con</div>
          </div>
        </div>

        <h3 style="margin-bottom: 20px;">ğŸ“ˆ Hoáº¡t Ä‘á»™ng gáº§n Ä‘Ã¢y</h3>
        <div id="recentActivity"></div>
      `;
      loadDashboardData();
    }

    // ğŸ“¢ THÃ”NG BÃO Há»† THá»NG
    function showSystemNotifications() {
      // Fix active menu
      document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
      const notifMenu = document.querySelector('[onclick="showSystemNotifications()"]');
      if (notifMenu) {
        notifMenu.classList.add('active');
      }
      document.getElementById('contentArea').innerHTML = `
        <div class="content-header">
          <h2 class="content-title">ğŸ“¢ THÃ”NG BÃO TOÃ€N Há»† THá»NG</h2>
          <button class="add-btn" onclick="createSystemNotification()">
            <i class="fas fa-plus"></i> Táº¡o thÃ´ng bÃ¡o má»›i
          </button>
        </div>
        
        <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
          <h4 style="color: #1976d2; margin-bottom: 10px;">ğŸ’¡ HÆ°á»›ng dáº«n:</h4>
          <p style="color: #333; margin-bottom: 10px;">â€¢ ThÃ´ng bÃ¡o há»‡ thá»‘ng sáº½ hiá»ƒn thá»‹ trÃªn <strong>Táº¤T Cáº¢</strong> trang con cá»§a eTax</p>
          <p style="color: #333; margin-bottom: 10px;">â€¢ CÃ³ thá»ƒ thiáº¿t láº­p ngÃ y giá» tÃ¹y chá»‰nh (backdate)</p>
          <p style="color: #333;">â€¢ VÃ­ dá»¥: ThÃ´ng bÃ¡o báº£o trÃ¬, ngá»«ng giao dá»‹ch, cáº­p nháº­t há»‡ thá»‘ng...</p>
        </div>

        <div id="systemNotificationsList"></div>
      `;
      loadSystemNotifications();
    }

    // ğŸ‘¥ QUáº¢N LÃ NGÆ¯á»œI DÃ™NG vá»›i OTP  
    function showUserManagement() {
      // Fix active menu
      document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
      const userMenu = document.querySelector('[onclick="showUserManagement()"]');
      if (userMenu) {
        userMenu.classList.add('active');
      }
      document.getElementById('contentArea').innerHTML = `
        <div class="content-header">
          <h2 class="content-title">ğŸ‘¥ QUáº¢N LÃ NGÆ¯á»œI DÃ™NG & OTP</h2>
          <div style="display: flex; gap: 10px;">
            <button class="add-btn" onclick="createUser()">
              <i class="fas fa-user-plus"></i> Táº¡o user má»›i
            </button>
            <button class="add-btn" onclick="viewPendingRequests()" style="background: #ffc107;">
              <i class="fas fa-clock"></i> YÃªu cáº§u chá» duyá»‡t (<span id="pendingCount">0</span>)
            </button>
          </div>
        </div>
        
        <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
          <h4 style="color: #1976d2; margin-bottom: 10px;">ğŸ” SYSTEM OTP Má»šI:</h4>
          <p style="color: #333; margin-bottom: 10px;">â€¢ <strong>Láº§n Ä‘áº§u:</strong> User nháº­p MST + Password â†’ Admin duyá»‡t + gá»­i OTP</p>
          <p style="color: #333; margin-bottom: 10px;">â€¢ <strong>Láº§n sau:</strong> User vÃ o luÃ´n khÃ´ng cáº§n OTP</p>
          <p style="color: #333; margin-bottom: 10px;">â€¢ <strong>Admin control:</strong> CÃ³ thá»ƒ yÃªu cáº§u OTP láº¡i báº¥t ká»³ lÃºc nÃ o</p>
          <p style="color: #333;">â€¢ <strong>Real-time:</strong> Notifications tá»« user request Ä‘áº¿n admin instant</p>
        </div>

        <div class="tabs-container" style="margin-bottom: 20px;">
          <div class="tabs" style="display: flex; background: #f8f9fa; border-radius: 10px; padding: 5px;">
            <button class="tab-btn active" onclick="showUserTab('approved')" style="flex: 1; padding: 10px; border: none; background: white; border-radius: 6px; font-weight: 600; cursor: pointer;">
              âœ… User Ä‘Ã£ duyá»‡t
            </button>
            <button class="tab-btn" onclick="showUserTab('pending')" style="flex: 1; padding: 10px; border: none; background: transparent; border-radius: 6px; font-weight: 600; cursor: pointer;">
              â³ Chá» duyá»‡t (<span id="pendingTabCount">0</span>)
            </button>
            <button class="tab-btn" onclick="showUserTab('blocked')" style="flex: 1; padding: 10px; border: none; background: transparent; border-radius: 6px; font-weight: 600; cursor: pointer;">
              ğŸš« ÄÃ£ khÃ³a
            </button>
          </div>
        </div>

        <div id="userTabContent"></div>
      `;
      loadUserManagement();
      loadPendingRequests();
    }

    // ğŸ“„ Load dashboard data
    async function loadDashboardData() {
      try {
        // Load real data from Firebase
        const usersSnapshot = await db.ref('users').once('value');
        const users = usersSnapshot.val() || {};
        const totalUsers = Object.keys(users).length;
        
        const requestsSnapshot = await db.ref('userRequests').once('value');
        const requests = requestsSnapshot.val() || {};
        const pendingUsers = Object.values(requests).filter(req => req.status === 'pending').length;
        
        const notificationsSnapshot = await db.ref('systemNotifications').once('value');
        const notifications = notificationsSnapshot.val() || {};
        const totalNotifications = Object.keys(notifications).length;
        
        // Update UI with real data
        document.getElementById('totalUsers').textContent = totalUsers;
        document.getElementById('pendingUsers').textContent = pendingUsers;
        document.getElementById('systemNotifications').textContent = totalNotifications;
        
        document.getElementById('recentActivity').innerHTML = `
          <table class="data-table">
            <thead>
              <tr>
                <th>Thá»i gian</th>
                <th>Hoáº¡t Ä‘á»™ng</th>
                <th>NgÆ°á»i thá»±c hiá»‡n</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>${new Date().toLocaleString('vi-VN')}</td>
                <td>ÄÄƒng nháº­p há»‡ thá»‘ng</td>
                <td>admin@etax.vn</td>
              </tr>
            </tbody>
          </table>
        `;
      } catch (error) {
        console.error('Lá»—i load dashboard:', error);
      }
    }

    // ğŸ“¢ Load system notifications
    async function loadSystemNotifications() {
      try {
        const snapshot = await db.ref('systemNotifications').orderByChild('createdAt').once('value');
        const notifications = [];
        
        snapshot.forEach(child => {
          const data = child.val();
          notifications.push({
            id: child.key,
            ...data
          });
        });
        
        // Reverse Ä‘á»ƒ hiá»ƒn thá»‹ má»›i nháº¥t trÆ°á»›c
        notifications.reverse();
        
        let tableHTML = `
          <table class="data-table">
            <thead>
              <tr>
                <th>Loáº¡i</th>
                <th>TiÃªu Ä‘á» thÃ´ng bÃ¡o</th>
                <th>Thá»i gian hiá»ƒn thá»‹</th>
                <th>Tráº¡ng thÃ¡i</th>
                <th>HÃ nh Ä‘á»™ng</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        if (notifications.length === 0) {
          tableHTML += `
            <tr>
              <td colspan="5" style="text-align: center; padding: 50px; color: #666;">
                ğŸ“¢ ChÆ°a cÃ³ thÃ´ng bÃ¡o há»‡ thá»‘ng nÃ o
              </td>
            </tr>
          `;
        } else {
          notifications.forEach(notif => {
            const typeIcons = {
              maintenance: 'ğŸ”§',
              announcement: 'ğŸ“¢', 
              urgent: 'ğŸš¨',
              update: 'ğŸ“±',
              holiday: 'ğŸ‰'
            };
            
            const startDateTime = new Date(notif.startDate + 'T' + notif.startTime);
            const endDateTime = notif.endDate ? new Date(notif.endDate + 'T' + notif.endTime) : null;
            const now = new Date();
            
            let status = '';
            if (now < startDateTime) {
              status = 'â³ ChÆ°a hiá»ƒn thá»‹';
            } else if (endDateTime && now > endDateTime) {
              status = 'âœ… ÄÃ£ káº¿t thÃºc';
            } else {
              status = 'ğŸŸ¢ Äang hiá»ƒn thá»‹';
            }
            
            const timeRange = notif.endDate ? 
              `${notif.startDate} ${notif.startTime} - ${notif.endDate} ${notif.endTime}` :
              `Tá»« ${notif.startDate} ${notif.startTime}`;
            
            tableHTML += `
              <tr>
                <td>${typeIcons[notif.type] || 'ğŸ“¢'}</td>
                <td>
                  <strong>${notif.title}</strong><br>
                  <small style="color: #666;">${notif.content.substring(0, 50)}...</small>
                </td>
                <td><small>${timeRange}</small></td>
                <td>${status}</td>
                <td>
                  <button class="action-btn btn-view" onclick="viewNotification('${notif.id}')">ğŸ‘ï¸ Xem</button>
                  <button class="action-btn btn-edit" onclick="editNotification('${notif.id}')">âœï¸ Sá»­a</button>
                  <button class="action-btn btn-delete" onclick="deleteNotification('${notif.id}')">ğŸ—‘ï¸ XÃ³a</button>
                </td>
              </tr>
            `;
          });
        }
        
        tableHTML += `
            </tbody>
          </table>
        `;
        
        document.getElementById('systemNotificationsList').innerHTML = tableHTML;
        
      } catch (error) {
        console.error('Lá»—i load thÃ´ng bÃ¡o:', error);
        document.getElementById('systemNotificationsList').innerHTML = `
          <div style="text-align: center; padding: 50px; color: #dc3545;">
            âŒ CÃ³ lá»—i xáº£y ra khi táº£i danh sÃ¡ch thÃ´ng bÃ¡o
          </div>
        `;
      }
    }

    // ğŸ‘ï¸ Xem chi tiáº¿t thÃ´ng bÃ¡o
    async function viewNotification(id) {
      try {
        const snapshot = await db.ref('systemNotifications/' + id).once('value');
        const notif = snapshot.val();
        
        if (!notif) {
          alert('âŒ KhÃ´ng tÃ¬m tháº¥y thÃ´ng bÃ¡o!');
          return;
        }
        
        const timeRange = notif.endDate ? 
          `${notif.startDate} ${notif.startTime} - ${notif.endDate} ${notif.endTime}` :
          `Tá»« ${notif.startDate} ${notif.startTime} (vÃ´ thá»i háº¡n)`;
          
        alert(`ğŸ“¢ CHI TIáº¾T THÃ”NG BÃO\\n\\n` +
              `TiÃªu Ä‘á»: ${notif.title}\\n\\n` +
              `Ná»™i dung: ${notif.content}\\n\\n` +
              `Thá»i gian: ${timeRange}\\n\\n` +
              `Äá»™ Æ°u tiÃªn: ${notif.priority}\\n\\n` +
              `Táº¡o bá»Ÿi: ${notif.createdBy}\\n` +
              `Táº¡o lÃºc: ${new Date(notif.createdAt).toLocaleString('vi-VN')}`);
              
      } catch (error) {
        console.error('Lá»—i xem thÃ´ng bÃ¡o:', error);
        alert('âŒ CÃ³ lá»—i xáº£y ra!');
      }
    }

    // âœï¸ Sá»­a thÃ´ng bÃ¡o
    function editNotification(id) {
      alert('ğŸš§ Chá»©c nÄƒng sá»­a thÃ´ng bÃ¡o Ä‘ang phÃ¡t triá»ƒn!');
    }

    // ğŸ—‘ï¸ XÃ³a thÃ´ng bÃ¡o
    async function deleteNotification(id) {
      if (!confirm('ğŸ¤” Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a thÃ´ng bÃ¡o nÃ y khÃ´ng?\\n\\nHÃ nh Ä‘á»™ng nÃ y khÃ´ng thá»ƒ hoÃ n tÃ¡c!')) {
        return;
      }
      
      try {
        await db.ref('systemNotifications/' + id).remove();
        
        // Ghi log
        await db.ref('adminLogs').push({
          action: 'XÃ³a thÃ´ng bÃ¡o há»‡ thá»‘ng',
          details: 'ID: ' + id,
          admin: 'admin@etax.vn',
          timestamp: Date.now(),
          date: new Date().toLocaleString('vi-VN')
        });
        
        alert('âœ… ÄÃ£ xÃ³a thÃ´ng bÃ¡o thÃ nh cÃ´ng!');
        loadSystemNotifications();
        
      } catch (error) {
        console.error('Lá»—i xÃ³a thÃ´ng bÃ¡o:', error);
        alert('âŒ CÃ³ lá»—i xáº£y ra khi xÃ³a thÃ´ng bÃ¡o!');
      }
    }

    // ğŸ‘¥ Load user management vá»›i OTP system
    async function loadUserManagement() {
      showUserTab('approved');
    }

    // ğŸ“‹ Show user tab
    async function showUserTab(tabType) {
      // Update tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = 'transparent';
      });
      event.target.classList.add('active');
      event.target.style.background = 'white';

      const contentDiv = document.getElementById('userTabContent');
      
      if (tabType === 'approved') {
        await loadApprovedUsers(contentDiv);
      } else if (tabType === 'pending') {
        await loadPendingRequests(contentDiv);
      } else if (tabType === 'blocked') {
        await loadBlockedUsers(contentDiv);
      }
    }

    // âœ… Load approved users
    async function loadApprovedUsers(container) {
      try {
        const snapshot = await db.ref('users').orderByChild('status').equalTo('active').once('value');
        const users = [];
        
        snapshot.forEach(child => {
          users.push({
            mst: child.key,
            ...child.val()
          });
        });

        let tableHTML = `
          <table class="data-table">
            <thead>
              <tr>
                <th>MST</th>
                <th>NgÃ y táº¡o</th>
                <th>Láº§n Ä‘Äƒng nháº­p cuá»‘i</th>
                <th>Tráº¡ng thÃ¡i</th>
                <th>HÃ nh Ä‘á»™ng</th>
              </tr>
            </thead>
            <tbody>
        `;

        if (users.length === 0) {
          tableHTML += `
            <tr>
              <td colspan="5" style="text-align: center; padding: 50px; color: #666;">
                âœ… ChÆ°a cÃ³ user nÃ o Ä‘Æ°á»£c duyá»‡t
              </td>
            </tr>
          `;
        } else {
          users.forEach(user => {
            const createdDate = new Date(user.createdAt).toLocaleString('vi-VN');
            const lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleString('vi-VN') : 'ChÆ°a Ä‘Äƒng nháº­p';
            
            tableHTML += `
              <tr>
                <td><strong>${user.mst}</strong></td>
                <td>${createdDate}</td>
                <td>${lastLogin}</td>
                <td><span style="color: #28a745;">ğŸŸ¢ Hoáº¡t Ä‘á»™ng</span></td>
                <td>
                  <button class="action-btn btn-edit" onclick="requireOTPUser('${user.mst}')">ğŸ” YÃªu cáº§u OTP</button>
                  <button class="action-btn btn-delete" onclick="blockUser('${user.mst}')">ğŸš« KhÃ³a</button>
                  <button class="action-btn btn-view" onclick="viewUserDetails('${user.mst}')">ğŸ‘ï¸ Chi tiáº¿t</button>
                </td>
              </tr>
            `;
          });
        }

        tableHTML += `</tbody></table>`;
        container.innerHTML = tableHTML;

      } catch (error) {
        console.error('Load approved users error:', error);
        container.innerHTML = `<div style="color: #dc3545; text-align: center; padding: 50px;">âŒ Lá»—i táº£i danh sÃ¡ch user</div>`;
      }
    }

    // â³ Load pending requests
    async function loadPendingRequests(container = null) {
      try {
        const snapshot = await db.ref('userRequests').orderByChild('status').equalTo('pending').once('value');
        const requests = [];
        
        snapshot.forEach(child => {
          requests.push({
            id: child.key,
            ...child.val()
          });
        });

        // Update counts
        const count = requests.length;
        const pendingCountEl = document.getElementById('pendingCount');
        const pendingTabCountEl = document.getElementById('pendingTabCount');
        if (pendingCountEl) pendingCountEl.textContent = count;
        if (pendingTabCountEl) pendingTabCountEl.textContent = count;

        if (!container) return; // Chá»‰ update count

        let tableHTML = `
          <table class="data-table">
            <thead>
              <tr>
                <th>MST</th>
                <th>Thá»i gian yÃªu cáº§u</th>
                <th>User Agent</th>
                <th>HÃ nh Ä‘á»™ng</th>
              </tr>
            </thead>
            <tbody>
        `;

        if (requests.length === 0) {
          tableHTML += `
            <tr>
              <td colspan="4" style="text-align: center; padding: 50px; color: #666;">
                â³ KhÃ´ng cÃ³ yÃªu cáº§u nÃ o Ä‘ang chá» duyá»‡t
              </td>
            </tr>
          `;
        } else {
          requests.forEach(request => {
            const requestTime = new Date(request.requestTime).toLocaleString('vi-VN');
            const userAgent = request.userAgent ? request.userAgent.substring(0, 50) + '...' : 'Unknown';
            
            tableHTML += `
              <tr>
                <td><strong>${request.mst}</strong></td>
                <td>${requestTime}</td>
                <td><small>${userAgent}</small></td>
                <td>
                  <button class="action-btn btn-edit" onclick="approveUser('${request.id}', '${request.mst}')">âœ… Duyá»‡t</button>
                  <button class="action-btn btn-delete" onclick="rejectUser('${request.id}')">âŒ Tá»« chá»‘i</button>
                  <button class="action-btn btn-view" onclick="viewRequestDetails('${request.id}')">ğŸ‘ï¸ Chi tiáº¿t</button>
                </td>
              </tr>
            `;
          });
        }

        tableHTML += `</tbody></table>`;
        container.innerHTML = tableHTML;

      } catch (error) {
        console.error('Load pending requests error:', error);
        if (container) {
          container.innerHTML = `<div style="color: #dc3545; text-align: center; padding: 50px;">âŒ Lá»—i táº£i yÃªu cáº§u chá» duyá»‡t</div>`;
        }
      }
    }

    // âœ… Approve user
    async function approveUser(requestId, mst) {
      const otp = prompt('ğŸ” Nháº­p mÃ£ OTP 6 sá»‘ Ä‘á»ƒ gá»­i cho user:');
      
      if (!otp || otp.length !== 6 || !/^[0-9]+$/.test(otp)) {
        alert('âŒ Vui lÃ²ng nháº­p mÃ£ OTP 6 sá»‘!');
        return;
      }

      try {
        // Update request vá»›i OTP vÃ  approve
        await db.ref('userRequests/' + requestId).update({
          status: 'approved',
          otp: otp,
          approvedTime: Date.now(),
          approvedBy: 'admin@etax.vn'
        });

        // Ghi log
        await db.ref('adminLogs').push({
          action: 'Duyá»‡t user vÃ  gá»­i OTP',
          details: \`MST: \${mst}, OTP: \${otp}\`,
          admin: 'admin@etax.vn',
          timestamp: Date.now(),
          date: new Date().toLocaleString('vi-VN')
        });

        alert(\`âœ… ÄÃ£ duyá»‡t user MST: \${mst}\\n\\nğŸ” OTP Ä‘Ã£ gá»­i: \${otp}\\n\\nVui lÃ²ng thÃ´ng bÃ¡o mÃ£ nÃ y cho user!\`);
        
        // Reload pending requests
        loadPendingRequests();
        
      } catch (error) {
        console.error('Approve user error:', error);
        alert('âŒ CÃ³ lá»—i xáº£y ra khi duyá»‡t user!');
      }
    }

    // âŒ Reject user
    async function rejectUser(requestId) {
      if (!confirm('ğŸ¤” Báº¡n cÃ³ cháº¯c muá»‘n tá»« chá»‘i yÃªu cáº§u nÃ y?')) return;

      try {
        await db.ref('userRequests/' + requestId).update({
          status: 'rejected',
          rejectedTime: Date.now(),
          rejectedBy: 'admin@etax.vn'
        });

        alert('âœ… ÄÃ£ tá»« chá»‘i yÃªu cáº§u!');
        loadPendingRequests();
        
      } catch (error) {
        console.error('Reject user error:', error);
        alert('âŒ CÃ³ lá»—i xáº£y ra khi tá»« chá»‘i!');
      }
    }

    // ğŸ” Require OTP for existing user
    async function requireOTPUser(mst) {
      if (!confirm(\`ğŸ” YÃªu cáº§u user MST: \${mst} pháº£i nháº­p OTP láº¡i láº§n Ä‘Äƒng nháº­p tiáº¿p theo?\\n\\nUser sáº½ pháº£i chá» admin duyá»‡t vÃ  gá»­i OTP má»›i.\`)) return;

      try {
        await db.ref('users/' + mst).update({
          requireOTP: true,
          otpRequiredTime: Date.now(),
          otpRequiredBy: 'admin@etax.vn'
        });

        alert(\`âœ… ÄÃ£ yÃªu cáº§u OTP cho user MST: \${mst}\\n\\nLáº§n Ä‘Äƒng nháº­p tiáº¿p theo user sáº½ pháº£i chá» admin duyá»‡t.\`);
        
      } catch (error) {
        console.error('Require OTP error:', error);
        alert('âŒ CÃ³ lá»—i xáº£y ra!');
      }
    }

    // ğŸš« Block user
    async function blockUser(mst) {
      if (!confirm(\`ğŸš« KhÃ³a user MST: \${mst}?\\n\\nUser sáº½ khÃ´ng thá»ƒ Ä‘Äƒng nháº­p cho Ä‘áº¿n khi Ä‘Æ°á»£c má»Ÿ khÃ³a.\`)) return;

      try {
        await db.ref('users/' + mst).update({
          status: 'blocked',
          blockedTime: Date.now(),
          blockedBy: 'admin@etax.vn'
        });

        alert(\`âœ… ÄÃ£ khÃ³a user MST: \${mst}\`);
        loadUserManagement();
        
      } catch (error) {
        console.error('Block user error:', error);
        alert('âŒ CÃ³ lá»—i xáº£y ra khi khÃ³a user!');
      }
    }

    // Start real-time listening for pending requests
    function startRealtimeUserMonitoring() {
      db.ref('userRequests').on('child_added', (snapshot) => {
        const request = snapshot.val();
        if (request.status === 'pending') {
          // Update count and show notification
          loadPendingRequests();
          
          // Desktop notification
          if (Notification.permission === 'granted') {
            new Notification('ğŸ” YÃªu cáº§u Ä‘Äƒng nháº­p má»›i', {
              body: \`User MST: \${request.mst} muá»‘n Ä‘Äƒng nháº­p\`,
              icon: 'assets/logo.png'
            });
          }
        }
      });
    }

    // ğŸ“¢ Táº¡o thÃ´ng bÃ¡o há»‡ thá»‘ng má»›i
    function createSystemNotification() {
      document.getElementById('contentArea').innerHTML = `
        <div class="content-header">
          <h2 class="content-title">ğŸ“¢ Táº O THÃ”NG BÃO Há»† THá»NG</h2>
          <button class="add-btn" onclick="showSystemNotifications()" style="background: #6c757d;">
            <i class="fas fa-arrow-left"></i> Quay láº¡i danh sÃ¡ch
          </button>
        </div>
        
        <div style="max-width: 800px;">
          <form id="systemNotificationForm" onsubmit="saveSystemNotification(event)">
            
            <!-- Loáº¡i thÃ´ng bÃ¡o -->
            <div style="margin-bottom: 25px;">
              <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;">
                ğŸ·ï¸ Loáº¡i thÃ´ng bÃ¡o:
              </label>
              <select id="notificationType" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                <option value="maintenance">ğŸ”§ Báº£o trÃ¬ há»‡ thá»‘ng</option>
                <option value="announcement">ğŸ“¢ ThÃ´ng bÃ¡o chung</option>
                <option value="urgent">ğŸš¨ Kháº©n cáº¥p</option>
                <option value="update">ğŸ“± Cáº­p nháº­t há»‡ thá»‘ng</option>
                <option value="holiday">ğŸ‰ NgÃ y lá»… / Nghá»‰</option>
              </select>
            </div>

            <!-- TiÃªu Ä‘á» -->
            <div style="margin-bottom: 25px;">
              <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;">
                ğŸ“ TiÃªu Ä‘á» thÃ´ng bÃ¡o:
              </label>
              <input type="text" id="notificationTitle" required
                placeholder="VD: Táº¡m ngá»«ng giao dá»‹ch thuáº¿ Ä‘á»ƒ báº£o trÃ¬ há»‡ thá»‘ng"
                style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
            </div>

            <!-- Ná»™i dung -->
            <div style="margin-bottom: 25px;">
              <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;">
                ğŸ“„ Ná»™i dung thÃ´ng bÃ¡o:
              </label>
              <textarea id="notificationContent" rows="4" required
                placeholder="MÃ´ táº£ chi tiáº¿t ná»™i dung thÃ´ng bÃ¡o..."
                style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; resize: vertical;"></textarea>
            </div>

            <!-- Thá»i gian hiá»ƒn thá»‹ -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;">
                  ğŸ“… NgÃ y báº¯t Ä‘áº§u hiá»ƒn thá»‹:
                </label>
                <input type="date" id="startDate" required
                  style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
              </div>
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;">
                  â° Giá» báº¯t Ä‘áº§u:
                </label>
                <input type="time" id="startTime" required
                  style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
              </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;">
                  ğŸ“… NgÃ y káº¿t thÃºc hiá»ƒn thá»‹:
                </label>
                <input type="date" id="endDate"
                  style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                <small style="color: #666;">Äá»ƒ trá»‘ng náº¿u hiá»ƒn thá»‹ vÃ´ thá»i háº¡n</small>
              </div>
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;">
                  â° Giá» káº¿t thÃºc:
                </label>
                <input type="time" id="endTime"
                  style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
              </div>
            </div>

            <!-- Hiá»ƒn thá»‹ trÃªn trang nÃ o -->
            <div style="margin-bottom: 25px;">
              <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;">
                ğŸ“± Hiá»ƒn thá»‹ trÃªn cÃ¡c trang:
              </label>
              <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <label style="display: block; margin-bottom: 10px;">
                  <input type="checkbox" id="showOnAll" checked onchange="toggleAllPages()" style="margin-right: 8px;">
                  <strong>âœ… Táº¥t cáº£ trang (khuyáº¿n nghá»‹)</strong>
                </label>
                <div id="specificPages" style="display: none; margin-left: 20px;">
                  <label style="display: block; margin-bottom: 5px;"><input type="checkbox" style="margin-right: 8px;"> ğŸ  Trang chá»§ (index.html)</label>
                  <label style="display: block; margin-bottom: 5px;"><input type="checkbox" style="margin-right: 8px;"> ğŸ“¢ ThÃ´ng bÃ¡o (thongbao.html)</label>
                  <label style="display: block; margin-bottom: 5px;"><input type="checkbox" style="margin-right: 8px;"> ğŸ“„ HÃ³a Ä‘Æ¡n Ä‘iá»‡n tá»­ (hoadondt.html)</label>
                  <label style="display: block; margin-bottom: 5px;"><input type="checkbox" style="margin-right: 8px;"> ğŸ“‹ Khai thuáº¿ (khaithue.html)</label>
                  <label style="display: block; margin-bottom: 5px;"><input type="checkbox" style="margin-right: 8px;"> ğŸ’° Ná»™p thuáº¿ (nopthue.html)</label>
                </div>
              </div>
            </div>

            <!-- Äá»™ Æ°u tiÃªn -->
            <div style="margin-bottom: 30px;">
              <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;">
                â­ Äá»™ Æ°u tiÃªn hiá»ƒn thá»‹:
              </label>
              <select id="priority" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                <option value="normal">ğŸ“Œ BÃ¬nh thÆ°á»ng</option>
                <option value="high">ğŸ”¥ Cao (ná»•i báº­t)</option>
                <option value="critical">ğŸš¨ Cá»±c cao (popup)</option>
              </select>
            </div>

            <!-- Buttons -->
            <div style="display: flex; gap: 15px; justify-content: flex-end;">
              <button type="button" onclick="showSystemNotifications()" 
                style="padding: 12px 24px; border: 2px solid #6c757d; background: white; color: #6c757d; border-radius: 8px; cursor: pointer; font-weight: 600;">
                âŒ Há»§y bá»
              </button>
              <button type="submit"
                style="padding: 12px 24px; border: none; background: #28a745; color: white; border-radius: 8px; cursor: pointer; font-weight: 600;">
                ğŸ’¾ LÆ°u thÃ´ng bÃ¡o
              </button>
            </div>
          </form>
        </div>
      `;
      
      // Set default date to today
      const today = new Date();
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      
      document.getElementById('startDate').value = today.toISOString().split('T')[0];
      document.getElementById('startTime').value = '08:00';
      document.getElementById('endDate').value = tomorrow.toISOString().split('T')[0];
      document.getElementById('endTime').value = '17:00';
    }

    // ğŸ”„ Toggle hiá»ƒn thá»‹ táº¥t cáº£ trang
    function toggleAllPages() {
      const showOnAll = document.getElementById('showOnAll').checked;
      const specificPages = document.getElementById('specificPages');
      specificPages.style.display = showOnAll ? 'none' : 'block';
    }

    // ğŸ’¾ LÆ°u thÃ´ng bÃ¡o há»‡ thá»‘ng
    async function saveSystemNotification(event) {
      event.preventDefault();
      
      const formData = {
        type: document.getElementById('notificationType').value,
        title: document.getElementById('notificationTitle').value,
        content: document.getElementById('notificationContent').value,
        startDate: document.getElementById('startDate').value,
        startTime: document.getElementById('startTime').value,
        endDate: document.getElementById('endDate').value,
        endTime: document.getElementById('endTime').value,
        showOnAll: document.getElementById('showOnAll').checked,
        priority: document.getElementById('priority').value,
        createdAt: Date.now(),
        createdBy: 'admin@etax.vn',
        status: 'active'
      };

      try {
        // LÆ°u vÃ o Firebase
        const notificationRef = await db.ref('systemNotifications').push(formData);
        
        // Ghi log
        await db.ref('adminLogs').push({
          action: 'Táº¡o thÃ´ng bÃ¡o há»‡ thá»‘ng',
          details: formData.title,
          admin: 'admin@etax.vn',
          timestamp: Date.now(),
          date: new Date().toLocaleString('vi-VN')
        });

        alert('âœ… ÄÃ£ táº¡o thÃ´ng bÃ¡o há»‡ thá»‘ng thÃ nh cÃ´ng!\\n\\nThÃ´ng bÃ¡o sáº½ hiá»ƒn thá»‹ trÃªn táº¥t cáº£ trang con theo thá»i gian Ä‘Ã£ thiáº¿t láº­p.');
        showSystemNotifications();
        
      } catch (error) {
        console.error('Lá»—i lÆ°u thÃ´ng bÃ¡o:', error);
        alert('âŒ CÃ³ lá»—i xáº£y ra khi lÆ°u thÃ´ng bÃ¡o!');
      }
    }

    // ğŸ‘¤ Táº¡o user má»›i
    function createUser() {
      alert('ğŸš§ Chá»©c nÄƒng Ä‘ang phÃ¡t triá»ƒn - Sáº½ cÃ³ trong bÆ°á»›c tiáº¿p theo!');
    }

    // ğŸ“„ QUáº¢N LÃ Ná»˜I DUNG
    // ğŸ¨ Open Visual Editor in new tab
    function openVisualEditor() {
      // Find and set active menu item
      const menuItems = document.querySelectorAll('.menu-item');
      menuItems.forEach(item => item.classList.remove('active'));
      const visualEditorMenu = document.querySelector('[onclick="openVisualEditor()"]');
      if (visualEditorMenu) {
        visualEditorMenu.classList.add('active');
      }
      
      // Open in new tab
      window.open('multi-page-visual-editor.html', '_blank', 'width=1400,height=900');
      
      // Also show info in current panel
      document.getElementById('contentArea').innerHTML = `
        <div class="content-header">
          <h2 class="content-title">ğŸ¨ VISUAL EDITOR</h2>
          <button class="add-btn" onclick="openVisualEditor()">
            <i class="fas fa-external-link-alt"></i> Má»Ÿ láº¡i Visual Editor
          </button>
        </div>
        
        <div style="background: #e8f4fd; padding: 30px; border-radius: 15px; text-align: center;">
          <div style="font-size: 48px; margin-bottom: 20px;">ğŸ¨</div>
          <h3 style="color: #333; margin-bottom: 15px;">Visual Editor Ä‘Ã£ má»Ÿ trong tab má»›i!</h3>
          <p style="color: #666; margin-bottom: 25px;">
            CÃ´ng cá»¥ chá»‰nh sá»­a visual cho phÃ©p anh:
          </p>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 25px 0;">
            <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              <div style="font-size: 24px; margin-bottom: 10px;">ğŸ“±</div>
              <h4>Chá»‰nh sá»­a trá»±c tiáº¿p</h4>
              <p style="font-size: 13px; color: #666;">Click vÃ o element Ä‘á»ƒ chá»‰nh sá»­a styling</p>
            </div>
            
            <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              <div style="font-size: 24px; margin-bottom: 10px;">ğŸ¯</div>
              <h4>Multi-page editing</h4>
              <p style="font-size: 13px; color: #666;">Quáº£n lÃ½ táº¥t cáº£ 13 trang eTax</p>
            </div>
            
            <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              <div style="font-size: 24px; margin-bottom: 10px;">ğŸ’¾</div>
              <h4>Live saving</h4>
              <p style="font-size: 13px; color: #666;">Thay Ä‘á»•i Ä‘Æ°á»£c lÆ°u ngay vÃ o Firebase</p>
            </div>
          </div>
          
          <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
            <strong>ğŸ’¡ HÆ°á»›ng dáº«n sá»­ dá»¥ng:</strong><br>
            1. Chá»n trang tá»« sidebar trÃ¡i<br>
            2. Click vÃ o element muá»‘n chá»‰nh sá»­a<br>
            3. Thay Ä‘á»•i style á»Ÿ panel pháº£i<br>
            4. áº¤n "Ãp dá»¥ng thay Ä‘á»•i" Ä‘á»ƒ lÆ°u
          </div>
        </div>
      `;
    }

    function showContentManagement() {
      // Fix active menu
      document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
      const contentMenu = document.querySelector('[onclick="showContentManagement()"]');
      if (contentMenu) {
        contentMenu.classList.add('active');
      }
      document.getElementById('contentArea').innerHTML = `
        <div class="content-header">
          <h2 class="content-title">ğŸ“„ QUáº¢N LÃ Ná»˜I DUNG</h2>
          <button class="add-btn" onclick="createNewContent()">
            <i class="fas fa-plus"></i> Táº¡o ná»™i dung má»›i
          </button>
        </div>
        
        <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
          <h4 style="color: #2e7d32; margin-bottom: 10px;">ğŸ“ RICH TEXT EDITOR:</h4>
          <p style="color: #333; margin-bottom: 10px;">â€¢ Editor vá»›i PWA design system match eTax Mobile</p>
          <p style="color: #333; margin-bottom: 10px;">â€¢ Live preview responsive (Mobile/Tablet/Desktop)</p>
          <p style="color: #333; margin-bottom: 10px;">â€¢ PWA Components: Header Ä‘á», Cards, Buttons, Tables</p>
          <p style="color: #333;">â€¢ Auto-save vÃ  sync real-time vá»›i Firebase</p>
        </div>

        <div class="content-types-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
          
          <div class="content-type-card" style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-left: 4px solid #b71c1c;">
            <h4 style="margin-top: 0; color: #b71c1c;">ğŸ“¢ ThÃ´ng bÃ¡o trang</h4>
            <p style="color: #666; margin-bottom: 15px;">Táº¡o thÃ´ng bÃ¡o cho tá»«ng trang riÃªng biá»‡t</p>
            <button onclick="createPageNotification()" style="background: #b71c1c; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
              â• Táº¡o thÃ´ng bÃ¡o
            </button>
          </div>

          <div class="content-type-card" style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-left: 4px solid #28a745;">
            <h4 style="margin-top: 0; color: #28a745;">ğŸ“‹ Ná»™i dung trang</h4>
            <p style="color: #666; margin-bottom: 15px;">Chá»‰nh sá»­a ná»™i dung chÃ­nh cá»§a cÃ¡c trang</p>
            <button onclick="editPageContent()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
              âœï¸ Chá»‰nh sá»­a
            </button>
          </div>

          <div class="content-type-card" style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-left: 4px solid #17a2b8;">
            <h4 style="margin-top: 0; color: #17a2b8;">ğŸ“Š Dá»¯ liá»‡u Ä‘á»™ng</h4>
            <p style="color: #666; margin-bottom: 15px;">Quáº£n lÃ½ dá»¯ liá»‡u thay Ä‘á»•i theo user</p>
            <button onclick="manageDynamicData()" style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
              ğŸ”„ Quáº£n lÃ½
            </button>
          </div>

        </div>

        <div id="contentManagementEditor" style="min-height: 400px;">
          <!-- Rich Text Editor sáº½ load á»Ÿ Ä‘Ã¢y -->
        </div>
      `;
    }

    // ğŸ“ Táº¡o ná»™i dung má»›i vá»›i Rich Editor
    function createNewContent() {
      document.getElementById('contentManagementEditor').innerHTML = `
        <div style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
          <h3 style="margin-bottom: 20px; color: #333;">ğŸ“ Táº O Ná»˜I DUNG Má»šI</h3>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;">
              ğŸ“± Chá»n trang Ã¡p dá»¥ng:
            </label>
            <select id="targetPage" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
              <option value="">-- Chá»n trang --</option>
              <option value="index.html">ğŸ  Trang chá»§ (index.html)</option>
              <option value="thongbao.html">ğŸ“¢ ThÃ´ng bÃ¡o (thongbao.html)</option>
              <option value="hoadondt.html">ğŸ“„ HÃ³a Ä‘Æ¡n Ä‘iá»‡n tá»­ (hoadondt.html)</option>
              <option value="khaithue.html">ğŸ“‹ Khai thuáº¿ (khaithue.html)</option>
              <option value="nopthue.html">ğŸ’° Ná»™p thuáº¿ (nopthue.html)</option>
              <option value="nghiavu.html">ğŸ¢ NghÄ©a vá»¥ (nghiavu.html)</option>
              <option value="tienich.html">ğŸ”§ Tiá»‡n Ã­ch (tienich.html)</option>
              <option value="hotro.html">â“ Há»— trá»£ (hotro.html)</option>
            </select>
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;">
              ğŸ¯ Loáº¡i ná»™i dung:
            </label>
            <select id="contentType" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
              <option value="announcement">ğŸ“¢ ThÃ´ng bÃ¡o</option>
              <option value="information">â„¹ï¸ ThÃ´ng tin</option>
              <option value="instruction">ğŸ“‹ HÆ°á»›ng dáº«n</option>
              <option value="form">ğŸ“ Biá»ƒu máº«u</option>
              <option value="table">ğŸ“Š Báº£ng dá»¯ liá»‡u</option>
            </select>
          </div>

          <div id="richTextEditorContainer"></div>
          
          <div style="margin-top: 20px; text-align: right;">
            <button onclick="showContentManagement()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; margin-right: 10px; cursor: pointer;">
              âŒ Há»§y
            </button>
            <button onclick="saveNewContent()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
              ğŸ’¾ LÆ°u ná»™i dung
            </button>
          </div>
        </div>
      `;
      
      // Initialize Rich Text Editor
      initETaxRichEditor('richTextEditorContainer', {
        showPreview: true,
        autoSave: true,
        mobileFirst: true
      });
    }

    // ğŸ’¾ LÆ°u ná»™i dung má»›i
    async function saveNewContent() {
      const targetPage = document.getElementById('targetPage').value;
      const contentType = document.getElementById('contentType').value;
      
      if (!targetPage) {
        alert('âŒ Vui lÃ²ng chá»n trang Ã¡p dá»¥ng!');
        return;
      }
      
      const content = etaxEditor.getContent();
      
      if (!content || content.trim() === '') {
        alert('âŒ Vui lÃ²ng nháº­p ná»™i dung!');
        return;
      }
      
      try {
        const contentData = {
          targetPage: targetPage,
          contentType: contentType,
          content: content,
          createdAt: Date.now(),
          createdBy: 'admin@etax.vn',
          status: 'active',
          lastModified: Date.now()
        };
        
        // LÆ°u vÃ o Firebase
        await db.ref('pageContent').push(contentData);
        
        // Ghi log
        await db.ref('adminLogs').push({
          action: 'Táº¡o ná»™i dung má»›i',
          details: \`\${contentType} cho \${targetPage}\`,
          admin: 'admin@etax.vn',
          timestamp: Date.now(),
          date: new Date().toLocaleString('vi-VN')
        });
        
        alert('âœ… ÄÃ£ táº¡o ná»™i dung thÃ nh cÃ´ng!\\n\\nNá»™i dung sáº½ hiá»ƒn thá»‹ trÃªn trang Ä‘Æ°á»£c chá»n.');
        showContentManagement();
        
      } catch (error) {
        console.error('Lá»—i lÆ°u ná»™i dung:', error);
        alert('âŒ CÃ³ lá»—i xáº£y ra khi lÆ°u ná»™i dung!');
      }
    }

    // ğŸ“¢ Táº¡o thÃ´ng bÃ¡o cho trang
    function createPageNotification() {
      alert('ğŸš§ Chá»©c nÄƒng táº¡o thÃ´ng bÃ¡o riÃªng cho tá»«ng trang Ä‘ang phÃ¡t triá»ƒn!');
    }

    // âœï¸ Chá»‰nh sá»­a ná»™i dung trang
    function editPageContent() {
      alert('ğŸš§ Chá»©c nÄƒng chá»‰nh sá»­a ná»™i dung trang Ä‘ang phÃ¡t triá»ƒn!');
    }

    // ğŸ”„ Quáº£n lÃ½ dá»¯ liá»‡u Ä‘á»™ng
    function manageDynamicData() {
      alert('ğŸš§ Chá»©c nÄƒng quáº£n lÃ½ dá»¯ liá»‡u Ä‘á»™ng Ä‘ang phÃ¡t triá»ƒn!');
    }

    function showPageManagement() {
      // Fix active menu
      document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
      const pageMenu = document.querySelector('[onclick="showPageManagement()"]');
      if (pageMenu) {
        pageMenu.classList.add('active');
      }
      
      document.getElementById('contentArea').innerHTML = `
        <div class="content-header">
          <h2 class="content-title">ğŸ“± QUáº¢N LÃ TRANG CON</h2>
          <button class="add-btn" onclick="alert('TÃ­nh nÄƒng sáº½ Ä‘Æ°á»£c phÃ¡t triá»ƒn!')">
            <i class="fas fa-plus"></i> ThÃªm trang má»›i
          </button>
        </div>
        
        <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; text-align: center;">
          <h3>ğŸš§ Chá»©c nÄƒng Ä‘ang phÃ¡t triá»ƒn</h3>
          <p>Quáº£n lÃ½ cÃ¡c trang con sáº½ Ä‘Æ°á»£c bá»• sung trong phiÃªn báº£n tiáº¿p theo</p>
        </div>
      `;
    }

    function showSystemLogs() {
      // Fix active menu
      document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
      const logMenu = document.querySelector('[onclick="showSystemLogs()"]');
      if (logMenu) {
        logMenu.classList.add('active');
      }
      
      document.getElementById('contentArea').innerHTML = `
        <div class="content-header">
          <h2 class="content-title">ğŸ“‹ NHáº¬T KÃ Há»† THá»NG</h2>
          <button class="add-btn" onclick="alert('TÃ­nh nÄƒng export logs sáº½ Ä‘Æ°á»£c bá»• sung!')">
            <i class="fas fa-download"></i> Export logs
          </button>
        </div>
        
        <div style="background: #fff3cd; padding: 20px; border-radius: 10px; text-align: center;">
          <h3>ğŸ“‹ System Logs</h3>
          <p>Chá»©c nÄƒng theo dÃµi nháº­t kÃ½ há»‡ thá»‘ng sáº½ Ä‘Æ°á»£c phÃ¡t triá»ƒn</p>
        </div>
      `;
    }

    function showSettings() {
      // Fix active menu
      document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
      const settingsMenu = document.querySelector('[onclick="showSettings()"]');
      if (settingsMenu) {
        settingsMenu.classList.add('active');
      }
      
      document.getElementById('contentArea').innerHTML = `
        <div class="content-header">
          <h2 class="content-title">âš™ï¸ CÃ€I Äáº¶T Há»† THá»NG</h2>
          <button class="add-btn" onclick="alert('TÃ­nh nÄƒng backup sáº½ Ä‘Æ°á»£c bá»• sung!')">
            <i class="fas fa-save"></i> Backup System
          </button>
        </div>
        
        <div style="background: #f8d7da; padding: 20px; border-radius: 10px; text-align: center;">
          <h3>âš™ï¸ System Settings</h3>
          <p>CÃ i Ä‘áº·t há»‡ thá»‘ng sáº½ Ä‘Æ°á»£c phÃ¡t triá»ƒn trong phiÃªn báº£n tiáº¿p theo</p>
        </div>
      `;
    }

    // ğŸš€ INIT
    window.onload = function() {
      console.log('ğŸ›¡ï¸ Admin Panel loading...');
      
      try {
        // Check session with detailed logging
        const session = localStorage.getItem('etax_admin_session');
        if (!session) {
          console.error('âŒ No session found, redirecting to login');
          alert('âŒ Báº¡n chÆ°a Ä‘Äƒng nháº­p! Chuyá»ƒn vá» trang Ä‘Äƒng nháº­p...');
          window.location.href = 'admin-login.html';
          return;
        }

        const sessionData = JSON.parse(session);
        if (Date.now() > sessionData.expiresAt) {
          console.error('â° Session expired, redirecting to login');
          alert('â° PhiÃªn lÃ m viá»‡c Ä‘Ã£ háº¿t háº¡n! Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i...');
          localStorage.removeItem('etax_admin_session');
          window.location.href = 'admin-login.html';
          return;
        }
        
        console.log('âœ… Session valid, initializing admin panel');
        
        // Start components
        updateTime();
        setInterval(updateTime, 1000);
        
        // Load dashboard with error handling
        console.log('ğŸ“Š Loading dashboard...');
        showDashboard();
        
        // Start real-time monitoring
        startRealtimeUserMonitoring();
        
        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
          Notification.requestPermission();
        }
        
        console.log('âœ… Admin Panel loaded successfully');
        
      } catch (error) {
        console.error('âŒ Admin Panel initialization failed:', error);
        alert('âŒ CÃ³ lá»—i khi khá»Ÿi táº¡o admin panel: ' + error.message);
      }
    };
  </script>
</body>
</html>