<!-- create-first-admin.html -->
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tạo Admin Đầu Tiên - eTax</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .setup-container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
      text-align: center;
    }
    
    .setup-icon {
      width: 100px;
      height: 100px;
      background: #ff6b6b;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      color: white;
      font-size: 40px;
    }
    
    .title {
      font-size: 28px;
      font-weight: 700;
      color: #333;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      line-height: 1.5;
    }
    
    .warning-box {
      background: #fff3cd;
      border: 2px solid #ffeaa7;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      text-align: left;
    }
    
    .warning-title {
      font-weight: 600;
      color: #856404;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .warning-text {
      color: #856404;
      font-size: 14px;
      line-height: 1.4;
    }
    
    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }
    
    .form-input {
      width: 100%;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 16px;
      transition: border-color 0.3s;
      box-sizing: border-box;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #ff6b6b;
    }
    
    .create-btn {
      width: 100%;
      background: #ff6b6b;
      color: white;
      border: none;
      padding: 18px;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .create-btn:hover {
      background: #ee5a52;
    }
    
    .create-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .success-box {
      background: #d4edda;
      border: 2px solid #c3e6cb;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      display: none;
    }
    
    .error-box {
      background: #f8d7da;
      border: 2px solid #f5c6cb;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      color: #721c24;
      display: none;
    }
    
    .check-status {
      background: #e3f2fd;
      border: 2px solid #bbdefb;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      text-align: left;
    }
  </style>
</head>
<body>
  <div class="setup-container">
    <div class="setup-icon">
      <i class="fas fa-user-shield"></i>
    </div>
    
    <h1 class="title">Thiết lập Admin Đầu Tiên</h1>
    <p class="subtitle">Tạo tài khoản quản trị viên chính để quản lý hệ thống eTax</p>
    
    <!-- Kiểm tra trạng thái -->
    <div class="check-status" id="statusCheck">
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
        <div class="spinner" id="checkSpinner" style="width: 20px; height: 20px; border: 2px solid #ccc; border-top: 2px solid #ff6b6b; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <span>Đang kiểm tra hệ thống...</span>
      </div>
      <div id="statusResult"></div>
    </div>
    
    <div class="warning-box">
      <div class="warning-title">
        <i class="fas fa-exclamation-triangle"></i>
        Quan trọng!
      </div>
      <div class="warning-text">
        • Trang này chỉ sử dụng một lần duy nhất để tạo admin đầu tiên<br>
        • Sau khi tạo xong, hãy xóa file này để bảo mật<br>
        • Ghi nhớ thông tin đăng nhập admin cẩn thận<br>
        • Không chia sẻ thông tin admin cho người khác
      </div>
    </div>
    
    <form onsubmit="createFirstAdmin(event)" id="adminForm" style="display: none;">
      <div class="form-group">
        <label class="form-label">Tên đăng nhập Admin: <span style="color: red;">*</span></label>
        <input type="text" class="form-input" id="adminUsername" placeholder="VD: admin" required minlength="4">
      </div>
      
      <div class="form-group">
        <label class="form-label">Mật khẩu Admin: <span style="color: red;">*</span></label>
        <input type="password" class="form-input" id="adminPassword" placeholder="Mật khẩu mạnh (ít nhất 8 ký tự)" required minlength="8">
      </div>
      
      <div class="form-group">
        <label class="form-label">Xác nhận mật khẩu: <span style="color: red;">*</span></label>
        <input type="password" class="form-input" id="confirmPassword" placeholder="Nhập lại mật khẩu" required>
      </div>
      
      <div class="form-group">
        <label class="form-label">Họ tên quản trị viên:</label>
        <input type="text" class="form-input" id="adminName" placeholder="VD: Nguyễn Văn A">
      </div>
      
      <div class="form-group">
        <label class="form-label">Email liên hệ:</label>
        <input type="email" class="form-input" id="adminEmail" placeholder="admin@company.com">
      </div>
      
      <button type="submit" class="create-btn" id="createBtn">
        <i class="fas fa-user-plus"></i>
        Tạo Admin Đầu Tiên
      </button>
    </form>
    
    <div class="success-box" id="successBox">
      <h3 style="color: #155724; margin-bottom: 10px;">
        <i class="fas fa-check-circle"></i>
        Tạo Admin Thành Công!
      </h3>
      <p style="color: #155724; margin: 0;">
        Tài khoản admin đã được tạo. Bạn có thể đăng nhập vào admin panel ngay bây giờ.
      </p>
      <a href="admin-login.html" style="display: inline-block; background: #28a745; color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; margin-top: 15px;">
        Đi tới Admin Login
      </a>
    </div>
    
    <div class="error-box" id="errorBox">
      <h3 style="color: #721c24; margin-bottom: 10px;">
        <i class="fas fa-exclamation-circle"></i>
        Có lỗi xảy ra!
      </h3>
      <p id="errorMessage" style="color: #721c24; margin: 0;"></p>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD_rJgBFgBulheVenQUE2KXr4PBpSpTCxw",
      authDomain: "etax-7fbf8.firebaseapp.com",
      databaseURL: "https://etax-7fbf8-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "etax-7fbf8",
      storageBucket: "etax-7fbf8.appspot.com",
      messagingSenderId: "1030026724634",
      appId: "1:1030026724634:web:d76f5f9dad43bad6fd58a3",
      measurementId: "G-YS5DLECJE6"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Kiểm tra hệ thống khi trang load
    window.addEventListener('load', checkSystemStatus);

    async function checkSystemStatus() {
      try {
        // Kiểm tra xem đã có admin nào chưa
        const adminSnapshot = await db.ref('adminUsers').once('value');
        const statusResult = document.getElementById('statusResult');
        const adminForm = document.getElementById('adminForm');
        const checkSpinner = document.getElementById('checkSpinner');
        
        checkSpinner.style.display = 'none';
        
        if (adminSnapshot.exists() && Object.keys(adminSnapshot.val()).length > 0) {
          // Đã có admin
          statusResult.innerHTML = `
            <div style="color: #856404;">
              <i class="fas fa-info-circle"></i>
              <strong>Hệ thống đã có admin!</strong><br>
              Đã tồn tại ${Object.keys(adminSnapshot.val()).length} tài khoản admin trong hệ thống.
            </div>
            <a href="admin-login.html" style="display: inline-block; background: #007bff; color: white; padding: 10px 20px; border-radius: 6px; text-decoration: none; margin-top: 10px;">
              Đi tới trang đăng nhập Admin
            </a>
          `;
        } else {
          // Chưa có admin nào
          statusResult.innerHTML = `
            <div style="color: #28a745;">
              <i class="fas fa-check-circle"></i>
              <strong>Hệ thống chưa có admin!</strong><br>
              Bạn có thể tạo tài khoản admin đầu tiên ngay bây giờ.
            </div>
          `;
          adminForm.style.display = 'block';
        }
        
      } catch (error) {
        console.error('Error checking system:', error);
        document.getElementById('statusResult').innerHTML = `
          <div style="color: #dc3545;">
            <i class="fas fa-exclamation-triangle"></i>
            Không thể kết nối Firebase. Kiểm tra lại cấu hình.
          </div>
        `;
      }
    }

    async function createFirstAdmin(event) {
      event.preventDefault();
      
      const username = document.getElementById('adminUsername').value.trim();
      const password = document.getElementById('adminPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const name = document.getElementById('adminName').value.trim();
      const email = document.getElementById('adminEmail').value.trim();
      
      // Validation
      if (password !== confirmPassword) {
        showError('Mật khẩu xác nhận không khớp!');
        return;
      }
      
      if (password.length < 8) {
        showError('Mật khẩu phải có ít nhất 8 ký tự!');
        return;
      }
      
      // Disable form
      const createBtn = document.getElementById('createBtn');
      createBtn.disabled = true;
      createBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang tạo...';
      
      try {
        // Kiểm tra lại lần nữa xem có admin nào chưa
        const adminSnapshot = await db.ref('adminUsers').once('value');
        if (adminSnapshot.exists() && Object.keys(adminSnapshot.val()).length > 0) {
          showError('Hệ thống đã có admin! Không thể tạo thêm từ trang này.');
          resetButton();
          return;
        }
        
        // Tạo admin data
        const adminData = {
          username: username,
          password: password, // Trong thực tế nên hash, nhưng để đơn giản
          name: name || 'Super Admin',
          email: email || '',
          role: 'super_admin',
          status: 'active',
          createdAt: Date.now(),
          createdBy: 'system',
          permissions: {
            manage_users: true,
            manage_tokens: true,
            upload_documents: true,
            view_analytics: true,
            system_settings: true
          }
        };
        
        // Lưu vào Firebase
        await db.ref('adminUsers/' + username).set(adminData);
        
        // Ghi log
        await db.ref('systemLogs').push({
          action: 'first_admin_created',
          username: username,
          timestamp: Date.now(),
          details: 'First admin account created'
        });
        
        showSuccess();
        
      } catch (error) {
        console.error('Error creating admin:', error);
        showError('Có lỗi xảy ra: ' + error.message);
        resetButton();
      }
    }
    
    function showError(message) {
      const errorBox = document.getElementById('errorBox');
      const errorMessage = document.getElementById('errorMessage');
      errorMessage.textContent = message;
      errorBox.style.display = 'block';
      document.getElementById('successBox').style.display = 'none';
    }
    
    function showSuccess() {
      const successBox = document.getElementById('successBox');
      successBox.style.display = 'block';
      document.getElementById('errorBox').style.display = 'none';
      document.getElementById('adminForm').style.display = 'none';
    }
    
    function resetButton() {
      const createBtn = document.getElementById('createBtn');
      createBtn.disabled = false;
      createBtn.innerHTML = '<i class="fas fa-user-plus"></i> Tạo Admin Đầu Tiên';
    }

    // Animation cho spinner
    const style = document.createElement('style');
    style.textContent = `
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>