<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìÑ Qu·∫£n l√Ω PDF - eTAX ADMIN</title>
  
  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <!-- Firebase Config -->
  <script src="./firebase-config.js"></script>
  
  <!-- PDF.js for PDF parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', 'Tahoma', 'Microsoft Sans Serif', 'Arial', sans-serif;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    .admin-header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .admin-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 20px;
      font-weight: 700;
      color: #dc3545;
    }

    .back-btn {
      background: #6c757d;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      transition: background 0.3s;
    }

    .back-btn:hover {
      background: #545b62;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    .content-header {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .content-title {
      font-size: 24px;
      color: #333;
      margin-bottom: 15px;
    }

    .info-box {
      background: #e8f4fd;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      border-left: 4px solid #007bff;
    }

    .info-box h4 {
      color: #0056b3;
      margin-bottom: 10px;
    }

    .info-box p {
      color: #333;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }

    .card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .card-title {
      color: #b71c1c;
      margin-bottom: 20px;
      font-size: 18px;
      font-weight: 600;
    }

    .user-selector {
      margin-bottom: 25px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .form-select,
    .form-input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .form-select:focus,
    .form-input:focus {
      outline: none;
      border-color: #007bff;
    }

    .upload-zone {
      border: 2px dashed #ddd;
      border-radius: 10px;
      padding: 40px 20px;
      text-align: center;
      margin-bottom: 20px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .upload-zone:hover {
      border-color: #007bff;
      background: #f8f9fa;
    }

    .upload-zone.dragover {
      border-color: #007bff;
      background: #e3f2fd;
    }

    .upload-icon {
      font-size: 48px;
      margin-bottom: 15px;
      color: #999;
    }

    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
      margin-right: 10px;
    }

    .btn-primary {
      background: #007bff;
      color: white;
    }

    .btn-primary:hover {
      background: #0056b3;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #1e7e34;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #545b62;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .pdf-preview {
      display: none;
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
    }

    .extracted-data {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .data-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }

    .data-row:last-child {
      border-bottom: none;
    }

    .data-label {
      font-weight: 600;
      color: #333;
    }

    .data-value {
      color: #666;
    }

    .pdf-list {
      max-height: 500px;
      overflow-y: auto;
    }

    .pdf-item {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 4px solid #007bff;
    }

    .pdf-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .pdf-filename {
      font-weight: 600;
      color: #333;
    }

    .pdf-date {
      color: #666;
      font-size: 12px;
    }

    .pdf-info {
      font-size: 13px;
      color: #666;
      line-height: 1.4;
    }

    .pdf-actions {
      margin-top: 10px;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      margin-right: 8px;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }

    .empty-state .icon {
      font-size: 64px;
      margin-bottom: 15px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #007bff;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px 15px;
      }
      
      .main-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .upload-zone {
        padding: 20px 15px;
      }
      
      .pdf-item-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>

<body>
  <div class="admin-header">
    <div class="admin-logo">
      üìÑ Qu·∫£n l√Ω PDF & T√†i li·ªáu
    </div>
    <a href="admin-dashboard.html" class="back-btn">‚Üê V·ªÅ Dashboard</a>
  </div>

  <div class="container">
    <!-- Header -->
    <div class="content-header">
      <h2 class="content-title">üìÑ QU·∫¢N L√ù PDF CHO T·ª™NG KH√ÅCH H√ÄNG</h2>
      
      <div class="info-box">
        <h4>üéØ WORKFLOW UPLOAD PDF:</h4>
        <p>‚Ä¢ <strong>B∆∞·ªõc 1:</strong> Ch·ªçn kh√°ch h√†ng (MST) t·ª´ danh s√°ch</p>
        <p>‚Ä¢ <strong>B∆∞·ªõc 2:</strong> Upload file PDF ‚Üí T·ª± ƒë·ªông parsing th√¥ng tin</p>
        <p>‚Ä¢ <strong>B∆∞·ªõc 3:</strong> Ki·ªÉm tra & x√°c nh·∫≠n th√¥ng tin</p>
        <p>‚Ä¢ <strong>B∆∞·ªõc 4:</strong> L∆∞u v√†o h·ªá th·ªëng ‚Üí User c√≥ th·ªÉ tra c·ª©u ngay</p>
      </div>
    </div>

    <!-- Main Grid -->
    <div class="main-grid">
      <!-- Left: Upload Section -->
      <div class="card">
        <h3 class="card-title">üì§ Upload PDF cho Kh√°ch h√†ng</h3>
        
        <!-- User Selection -->
        <div class="user-selector" style="margin-bottom: 20px;">
          <label class="form-label">üë§ Ch·ªçn kh√°ch h√†ng ƒë·ªÉ g√°n PDF:</label>
          <select class="form-select" id="userSelect">
            <option value="">-- Ch·ªçn kh√°ch h√†ng --</option>
          </select>
        </div>

        <!-- Upload Zone -->
        <div class="upload-zone" id="uploadZone">
          <div class="upload-icon">üìÑ</div>
          <p style="margin-bottom: 15px; color: #666;">K√©o th·∫£ file PDF v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn</p>
          <p style="font-size: 12px; color: #999;">H·ªó tr·ª£: PDF (t·ªëi ƒëa 10MB)</p>
          <input type="file" id="pdfInput" accept=".pdf" style="display: none;">
        </div>

        <!-- Editable Fields -->
        <div class="extracted-fields" id="extractedFields" style="display: none; margin-top: 20px;">
          <h4 style="margin-bottom: 15px; color: #333;">‚úèÔ∏è Th√¥ng tin tr√≠ch xu·∫•t (c√≥ th·ªÉ ch·ªânh s·ª≠a):</h4>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label class="form-label">MST t·ª´ PDF:</label>
              <input type="text" id="editMST" class="form-input" placeholder="MST..." oninput="updateTableFromFields()">
            </div>
            <div>
              <label class="form-label">M√£ tham chi·∫øu:</label>
              <input type="text" id="editRefNumber" class="form-input" placeholder="M√£ tham chi·∫øu..." oninput="updateTableFromFields()">
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label class="form-label">S·ªë ti·ªÅn:</label>
              <input type="text" id="editAmount" class="form-input" placeholder="S·ªë ti·ªÅn..." oninput="updateTableFromFields()">
            </div>
            <div>
              <label class="form-label">Ng√†y n·ªôp:</label>
              <input type="text" id="editDate" class="form-input" placeholder="dd/mm/yyyy" oninput="updateTableFromFields()">
            </div>
          </div>
        </div>

        <!-- Extracted Data Table -->
        <div class="extracted-table" id="extractedTable" style="display: none; margin-top: 20px;">
          <h4 style="margin-bottom: 15px; color: #333;">üìã B·∫£ng tr√≠ch xu·∫•t PDF</h4>
          
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              <thead>
                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                  <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057; border-right: 1px solid #dee2e6;">M√£ tham chi·∫øu</th>
                  <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057; border-right: 1px solid #dee2e6;">S·ªë ti·ªÅn PDF</th>
                  <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057; border-right: 1px solid #dee2e6;">Ng√†y n·ªôp PDF</th>
                  <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057; border-right: 1px solid #dee2e6;">MST PDF</th>
                  <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Gi·ªù</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td style="padding: 12px; border-right: 1px solid #dee2e6;">
                    <span id="displayRefNumber" style="color: #0c5460; font-weight: 500;">-</span>
                  </td>
                  <td style="padding: 12px; border-right: 1px solid #dee2e6;">
                    <span id="displayAmount" style="color: #155724; font-weight: 500;">-</span>
                  </td>
                  <td style="padding: 12px; border-right: 1px solid #dee2e6;">
                    <span id="displayDate" style="color: #721c24; font-weight: 500;">-</span>
                  </td>
                  <td style="padding: 12px; border-right: 1px solid #dee2e6;">
                    <span id="displayMST" style="color: #dc3545; font-weight: 500;">-</span>
                  </td>
                  <td style="padding: 12px;">
                    <span id="displayHour" style="color: #6f42c1; font-weight: 500;">-</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Action Buttons -->
        <div style="text-align: center; margin-top: 20px;">
          <button class="btn btn-success" onclick="confirmPDFUpload()" id="confirmBtn" style="display: none;">
            ‚úÖ X√°c nh·∫≠n & L∆∞u PDF
          </button>
          <button class="btn btn-secondary" onclick="clearPDFData()">
            üóëÔ∏è X√≥a & Upload l·∫°i
          </button>
        </div>
      </div>

      <!-- Right: PDF List -->
      <div class="card">
        <h3 class="card-title">üìã PDF ƒë√£ Upload</h3>
        
        <div style="margin-bottom: 20px;">
          <label class="form-label">üîç L·ªçc theo kh√°ch h√†ng:</label>
          <select class="form-select" id="filterSelect" onchange="filterPDFList()">
            <option value="">-- T·∫•t c·∫£ kh√°ch h√†ng --</option>
          </select>
        </div>

        <div class="pdf-list" id="pdfList">
          <div class="loading">
            <div class="spinner"></div>
            ƒêang t·∫£i danh s√°ch PDF...
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentPDFData = null;
    let allUsers = []; // Still load all users to check if scanned MST exists

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üìÑ PDF Management page loaded');
      initializePage();
    });

    async function initializePage() {
      try {
        await loadUsers(); // Load users to validate scanned MST
        setupUploadZone();
        await loadPDFList(); // Load existing PDFs
        console.log('‚úÖ PDF Management initialized');
      } catch (error) {
        console.error('‚ùå Error initializing page:', error);
      }
    }

    // Load users and populate dropdown
    async function loadUsers() {
      try {
        const usersSnapshot = await db.ref('users').once('value');
        const users = usersSnapshot.val() || {};
        allUsers = Object.entries(users).map(([mst, user]) => ({ mst, fullName: user.fullName || 'N/A' }));
        
        // Populate user dropdown
        const userSelect = document.getElementById('userSelect');
        userSelect.innerHTML = '<option value="">-- Ch·ªçn kh√°ch h√†ng --</option>';
        allUsers.forEach(user => {
          userSelect.innerHTML += `<option value="${user.mst}">${user.mst} - ${user.fullName}</option>`;
        });
        
        // Populate filter dropdown too
        const filterSelect = document.getElementById('filterSelect');
        filterSelect.innerHTML = '<option value="">-- T·∫•t c·∫£ kh√°ch h√†ng --</option>';
        allUsers.forEach(user => {
          filterSelect.innerHTML += `<option value="${user.mst}">${user.mst} - ${user.fullName}</option>`;
        });
        
        console.log('‚úÖ Users loaded:', allUsers.length);
      } catch (error) {
        console.error('‚ùå Error loading users:', error);
      }
    }

    // Setup upload zone
    function setupUploadZone() {
      const uploadZone = document.getElementById('uploadZone');
      const pdfInput = document.getElementById('pdfInput');
      
      uploadZone.addEventListener('click', () => pdfInput.click());
      pdfInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) handleFileUpload(e.target.files[0]);
      });
      uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
      uploadZone.addEventListener('dragleave', (e) => { e.preventDefault(); uploadZone.classList.remove('dragover'); });
      uploadZone.addEventListener('drop', (e) => {
        e.preventDefault(); uploadZone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type === 'application/pdf') handleFileUpload(files[0]);
        else alert('‚ùå Vui l√≤ng ch·ªçn file PDF h·ª£p l·ªá');
      });
    }

    // Handle file upload - NO VALIDATION, just OCR and let admin edit
    async function handleFileUpload(file) {
      if (file.size > 10 * 1024 * 1024) {
        alert('‚ùå File PDF qu√° l·ªõn (t·ªëi ƒëa 10MB)');
        return;
      }
      
      try {
        console.log('üìÑ Processing PDF:', file.name);
        document.getElementById('extractedFields').style.display = 'block';
        document.getElementById('extractedTable').style.display = 'block';

        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
        let fullText = '';
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent();
          fullText += textContent.items.map(item => item.str).join(' ') + '\n';
        }
        
        // Extract info but don't validate - let admin edit
        const extractedInfo = parseVietnamTaxPDF(fullText);
        
        // Populate editable fields with extracted data
        document.getElementById('editMST').value = extractedInfo.mst || '';
        document.getElementById('editRefNumber').value = extractedInfo.referenceNumber || '';
        document.getElementById('editAmount').value = extractedInfo.amount || '';
        document.getElementById('editDate').value = extractedInfo.paymentDate || '';
        
        // Update display table
        updateDisplayTable(extractedInfo);

        currentPDFData = {
          fileName: file.name,
          fileSize: file.size,
          uploadTime: Date.now(),
          extractedData: extractedInfo,
          fullText: fullText
        };
        
        // Show confirm button
        document.getElementById('confirmBtn').style.display = 'inline-block';
        console.log('‚úÖ PDF processed, ready for admin review');
        
      } catch (error) {
        console.error('‚ùå Error processing PDF:', error);
        alert('‚ùå L·ªói x·ª≠ l√Ω PDF: ' + error.message);
        clearPDFData();
      }
    }

    // Generate business hours time (8:00-17:00)
    function generateBusinessHour() {
      const hours = Math.floor(Math.random() * 10) + 8; // 8-17
      const minutes = Math.floor(Math.random() * 60);   // 0-59
      const seconds = Math.floor(Math.random() * 60);   // 0-59
      
      return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    // Parse Vietnamese tax PDF with business hour
    function parseVietnamTaxPDF(text) {
      const data = {
        referenceNumber: '',
        amount: '',
        paymentDate: '',
        mst: '',
        hour: generateBusinessHour() // Gi·ªù h√†nh ch√≠nh 8:00-17:00
      };
      
      try {
        const refMatch = text.match(/(?:m√£ tham chi·∫øu|s·ªë tham chi·∫øu)[:\s]*([A-Z0-9]{8,20})/i);
        if (refMatch) data.referenceNumber = refMatch[1];
        
        const amountMatch = text.match(/(?:s·ªë ti·ªÅn|th√†nh ti·ªÅn|t·ªïng ti·ªÅn)[:\s]*([0-9.,]+)/i);
        if (amountMatch) data.amount = amountMatch[1].replace(/\./g, ',');
        
        const dateMatch = text.match(/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/);
        if (dateMatch) data.paymentDate = dateMatch[1];

        const mstMatch = text.match(/(?:m√£ s·ªë thu·∫ø|MST)[:\s]*(\d{10,13})/i);
        if (mstMatch) data.mst = mstMatch[1];
        
        console.log('üìÑ Parsed data:', data);
        
      } catch (error) {
        console.error('‚ùå Error parsing PDF:', error);
      }
      
      return data;
    }

    // Display extracted data (remains the same)
    function displayExtractedData(data) {
      const extractedData = document.getElementById('extractedData');
      
      extractedData.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 10px;">Giao d·ªãch n·ªôp thu·∫ø</div>
        <div style="font-size: 14px; color: #666; margin-bottom: 15px;">Ng√†y th√¥ng b√°o: ${data.paymentDate} ${data.hour}</div>
        <div>
          Ng∆∞·ªùi n·ªôp thu·∫ø ƒë√£ n·ªôp thu·∫ø th√†nh c√¥ng cho<br>
          m√£ s·ªë thu·∫ø ${data.mst}, m√£ tham chi·∫øu:<br>
          ${data.referenceNumber}, s·ªë ti·ªÅn n·ªôp: ${data.amount} VND.
        </div>
      `;
    }

    // Confirm PDF upload - get data from editable fields
    async function confirmPDFUpload() {
      if (!currentPDFData) {
        alert('‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu PDF ƒë·ªÉ l∆∞u');
        return;
      }
      
      const selectedUser = document.getElementById('userSelect').value;
      if (!selectedUser) {
        alert('‚ùå Vui l√≤ng ch·ªçn kh√°ch h√†ng ƒë·ªÉ g√°n PDF');
        return;
      }
      
      try {
        const pdfId = 'pdf_' + Date.now();
        
        // Get data from editable fields (admin may have modified)
        const finalData = {
          mst: document.getElementById('editMST').value.trim(),
          referenceNumber: document.getElementById('editRefNumber').value.trim(),
          amount: document.getElementById('editAmount').value.trim(),
          paymentDate: document.getElementById('editDate').value.trim(),
          hour: new Date().toLocaleTimeString('vi-VN')
        };

        const pdfRecord = {
          id: pdfId,
          fileName: currentPDFData.fileName,
          fileSize: currentPDFData.fileSize,
          uploadTime: currentPDFData.uploadTime,
          extractedData: finalData,
          uploadedBy: 'admin@etax.vn'
        };
        
        await db.ref('pdfDocuments/' + pdfId).set(pdfRecord);
        
        await db.ref('customerPDFs/' + selectedUser + '/' + pdfId).set({
          assignedAt: Date.now(),
          assignedBy: 'admin@etax.vn'
        });

        // 1. T·∫°o record cho tra c·ª©u ch·ª©ng t·ª´ (tra-cuu-chung-tu.html)
        const certificateId = 'cert_' + Date.now();
        const certificateRecord = {
          id: certificateId,
          referenceNumber: finalData.referenceNumber,           // "M√£ tham chi·∫øu" 
          amount: finalData.amount,                             // "S·ªë ti·ªÅn pdf"
          paymentDate: finalData.paymentDate,                   // "Ng√†y n·ªôp pdf"
          status: `<div>Th√†nh c√¥ng -NH<br>TGTT ƒë√£<br>tr·ª´ ti·ªÅn th√†nh<br>c√¥ng</div>`, // "Tr·∫°ng th√°i"
          pdfLink: `PDFForm/${currentPDFData.fileName}`,        // "In ch·ª©ng t·ª´" - link PDF
          mst: selectedUser,
          createdAt: Date.now(),
          createdBy: 'admin@etax.vn'
        };
        await db.ref('certificates/' + certificateId).set(certificateRecord);
        
        // G√°n ch·ª©ng t·ª´ cho user
        await db.ref('userCertificates/' + selectedUser + '/' + certificateId).set({
          assignedAt: Date.now(),
          assignedBy: 'admin@etax.vn'
        });

        // 2. T·∫°o th√¥ng b√°o c√° nh√¢n cho thongbao.html
        const notificationId = 'notif_' + Date.now();
        
        // T·∫°o timestamp t·ª´ ng√†y OCR + gi·ªù h√†nh ch√≠nh
        let notificationTimestamp = Date.now(); // Fallback
        try {
          if (finalData.paymentDate) {
            const dateParts = finalData.paymentDate.split(/[\/\-]/);
            if (dateParts.length === 3) {
              const day = parseInt(dateParts[0]);
              const month = parseInt(dateParts[1]) - 1; // Month is 0-indexed
              const year = parseInt(dateParts[2]);
              
              // T·∫°o ng√†y t·ª´ OCR + gi·ªù h√†nh ch√≠nh
              const ocrDate = new Date(year, month, day);
              const [hours, minutes, seconds] = finalData.hour.split(':').map(n => parseInt(n));
              ocrDate.setHours(hours, minutes, seconds);
              
              notificationTimestamp = ocrDate.getTime();
            }
          }
        } catch (error) {
          console.log('Using current timestamp as fallback');
        }
        
        const notification = {
          title: 'Giao d·ªãch n·ªôp thu·∫ø',
          // N·ªôi dung cho trang thongbao.html
          content: `Ng∆∞·ªùi n·ªôp thu·∫ø ƒë√£ n·ªôp thu·∫ø th√†nh c√¥ng cho<br>m√£ s·ªë thu·∫ø ${finalData.mst}, m√£ tham chi·∫øu: ${finalData.referenceNumber}`,
          // N·ªôi dung chi ti·∫øt cho popup
          detailContent: `
            <div>Ng√†y th√¥ng b√°o: ${finalData.paymentDate} ${finalData.hour}</div>
            <div>
              Ng∆∞·ªùi n·ªôp thu·∫ø ƒë√£ n·ªôp thu·∫ø th√†nh c√¥ng cho<br>
              m√£ s·ªë thu·∫ø ${finalData.mst}, m√£ tham chi·∫øu:<br>
              ${finalData.referenceNumber}, s·ªë ti·ªÅn n·ªôp: ${finalData.amount} VND.
            </div>
          `,
          type: 'personal',
          targetUser: selectedUser,
          publishDate: notificationTimestamp, // D√πng ng√†y OCR + gi·ªù h√†nh ch√≠nh
          backdate: null,
          // Th√™m d·ªØ li·ªáu mapping
          pdfData: {
            referenceNumber: finalData.referenceNumber,
            amount: finalData.amount, 
            paymentDate: finalData.paymentDate,
            mst: finalData.mst,
            hour: finalData.hour
          }
        };
        await db.ref('notifications/' + notificationId).set(notification);
        
        console.log('‚úÖ PDF uploaded successfully:', pdfId);
        alert(`‚úÖ ƒê√£ upload PDF th√†nh c√¥ng cho kh√°ch h√†ng: ${selectedUser}`);
        
        clearPDFData();
        await loadPDFList();
        
      } catch (error) {
        console.error('‚ùå Error uploading PDF:', error);
        alert('‚ùå L·ªói upload PDF: ' + error.message);
      }
    }

    // Clear PDF data
    function clearPDFData() {
      currentPDFData = null;
      document.getElementById('extractedFields').style.display = 'none';
      document.getElementById('extractedTable').style.display = 'none';
      document.getElementById('confirmBtn').style.display = 'none';
      document.getElementById('pdfInput').value = '';
      document.getElementById('userSelect').value = '';
      
      // Clear editable fields
      document.getElementById('editMST').value = '';
      document.getElementById('editRefNumber').value = '';
      document.getElementById('editAmount').value = '';
      document.getElementById('editDate').value = '';
      
      // Clear display table
      document.getElementById('displayRefNumber').textContent = '-';
      document.getElementById('displayAmount').textContent = '-';
      document.getElementById('displayDate').textContent = '-';
      document.getElementById('displayMST').textContent = '-';
      document.getElementById('displayHour').textContent = '-';
    }

    // Load PDF list (remains the same)
    async function loadPDFList() {
      try {
        console.log('üìã Loading PDF list...');
        
        const pdfList = document.getElementById('pdfList');
        pdfList.innerHTML = '<div class="loading"><div class="spinner"></div>ƒêang t·∫£i danh s√°ch PDF...</div>';
        
        const pdfSnapshot = await db.ref('pdfDocuments').once('value');
        const pdfs = pdfSnapshot.val() || {};
        
        const customerPDFSnapshot = await db.ref('customerPDFs').once('value');
        const customerPDFs = customerPDFSnapshot.val() || {};
        
        allPDFs = [];
        Object.entries(pdfs).forEach(([pdfId, pdfData]) => {
          let assignedTo = null;
          for (const [mst, userPDFs] of Object.entries(customerPDFs)) {
            if (userPDFs[pdfId]) {
              assignedTo = mst;
              break;
            }
          }
          
          allPDFs.push({
            id: pdfId,
            ...pdfData,
            assignedTo: assignedTo
          });
        });
        
        allPDFs.sort((a, b) => (b.uploadTime || 0) - (a.uploadTime || 0));
        
        displayPDFList();
        
        console.log('‚úÖ PDF list loaded:', allPDFs.length);
        
      } catch (error) {
        console.error('‚ùå Error loading PDF list:', error);
        document.getElementById('pdfList').innerHTML = `
          <div class="empty-state">
            <div class="icon">‚ùå</div>
            <h3>L·ªói t·∫£i d·ªØ li·ªáu</h3>
            <p>${error.message}</p>
          </div>
        `;
      }
    }

    // Display PDF list (remains the same)
    function displayPDFList() {
      const pdfList = document.getElementById('pdfList');
      const filterValue = document.getElementById('filterSelect').value;
      
      let filteredPDFs = allPDFs;
      if (filterValue) {
        filteredPDFs = allPDFs.filter(pdf => pdf.assignedTo === filterValue);
      }
      
      if (filteredPDFs.length === 0) {
        pdfList.innerHTML = `
          <div class="empty-state">
            <div class="icon">üì≠</div>
            <h3>Ch∆∞a c√≥ PDF n√†o</h3>
            <p>Ch∆∞a c√≥ PDF n√†o ƒë∆∞·ª£c upload${filterValue ? ' cho kh√°ch h√†ng n√†y' : ''}</p>
          </div>
        `;
        return;
      }
      
      pdfList.innerHTML = filteredPDFs.map(pdf => {
        const user = allUsers.find(u => u.mst === pdf.assignedTo);
        const userName = user ? user.fullName : 'N/A'; // Use fullName
        
        return `
          <div class="pdf-item">
            <div class="pdf-item-header">
              <div class="pdf-filename">üìÑ ${pdf.fileName}</div>
              <div class="pdf-date">${new Date(pdf.uploadTime).toLocaleString('vi-VN')}</div>
            </div>
            <div class="pdf-info">
              <strong>üë§ Kh√°ch h√†ng:</strong> ${pdf.assignedTo || 'Ch∆∞a g√°n'} - ${userName}<br>
              <strong>üí∞ S·ªë ti·ªÅn:</strong> ${pdf.extractedData?.amount || 'N/A'}<br>
              <strong>üìÖ Ng√†y n·ªôp:</strong> ${pdf.extractedData?.paymentDate || 'N/A'}<br>
              <strong>üî¢ M√£ tham chi·∫øu:</strong> ${pdf.extractedData?.referenceNumber || 'N/A'}
            </div>
            <div class="pdf-actions">
              <button class="btn btn-primary btn-small" onclick="viewPDFDetails('${pdf.id}')">
                üëÅÔ∏è Xem chi ti·∫øt
              </button>
              <button class="btn btn-danger btn-small" onclick="deletePDF('${pdf.id}')">
                üóëÔ∏è X√≥a
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Filter PDF list (remains the same)
    function filterPDFList() {
      displayPDFList();
    }

    // View PDF details (remains the same)
    function viewPDFDetails(pdfId) {
      const pdf = allPDFs.find(p => p.id === pdfId);
      if (!pdf) return;
      
      const details = `
        M√£ tham chi·∫øu: ${pdf.extractedData?.referenceNumber || 'N/A'}
        S·ªë ti·ªÅn: ${pdf.extractedData?.amount || 'N/A'} VND
        Ng√†y n·ªôp: ${pdf.extractedData?.paymentDate || 'N/A'}
        Tr·∫°ng th√°i: Th√†nh c√¥ng -NH TGTT ƒë√£ tr·ª´ ti·ªÅn th√†nh c√¥ng
        In ch·ª©ng t·ª´: ${pdf.fileName}
      `;
      
      alert(details);
    }

    // Update display table with extracted data
    function updateDisplayTable(data) {
      document.getElementById('displayRefNumber').textContent = data.referenceNumber || '-';
      document.getElementById('displayAmount').textContent = data.amount || '-';
      document.getElementById('displayDate').textContent = data.paymentDate || '-';
      document.getElementById('displayMST').textContent = data.mst || '-';
      document.getElementById('displayHour').textContent = data.hour || '-';
    }
    
    // Update table when user edits fields
    function updateTableFromFields() {
      document.getElementById('displayRefNumber').textContent = document.getElementById('editRefNumber').value || '-';
      document.getElementById('displayAmount').textContent = document.getElementById('editAmount').value || '-';
      document.getElementById('displayDate').textContent = document.getElementById('editDate').value || '-';
      document.getElementById('displayMST').textContent = document.getElementById('editMST').value || '-';
      document.getElementById('displayHour').textContent = new Date().toLocaleTimeString('vi-VN');
    }

    // Delete PDF (remains the same)
    async function deletePDF(pdfId) {
      const pdf = allPDFs.find(p => p.id === pdfId);
      if (!pdf) return;
      
      if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a PDF: ${pdf.fileName}?`)) return;
      
      try {
        await db.ref('pdfDocuments/' + pdfId).remove();
        if (pdf.assignedTo) {
          await db.ref('customerPDFs/' + pdf.assignedTo + '/' + pdfId).remove();
        }
        console.log('‚úÖ PDF deleted:', pdfId);
        alert('‚úÖ ƒê√£ x√≥a PDF th√†nh c√¥ng');
        loadPDFList();
      } catch (error) {
        console.error('‚ùå Error deleting PDF:', error);
        alert('‚ùå L·ªói x√≥a PDF: ' + error.message);
      }
    }
  </script>
</body>
</html>