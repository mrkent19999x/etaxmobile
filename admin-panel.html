<!DOCTYPE html>
<html lang="vi">
<head>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
<!-- PDF.js Library để phân tích PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <meta charset="UTF-8">
  <!-- PWA Meta Tags -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#b71c1c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="eTax Mobile">
  <link rel="apple-touch-icon" href="./assets/logo.png">
  <meta name="format-detection" content="telephone=no">
  
  <title>eTax Admin Panel - Quản lý hệ thống</title>
  <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  
  <style>
    /* Thêm CSS cho chức năng phân tích PDF */
.pdf-analysis-container {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 20px;
  padding: 25px;
  margin: 20px 0;
  color: white;
  box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
}

.analysis-header {
  text-align: center;
  margin-bottom: 25px;
}

.analysis-header h3 {
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 10px;
}

.analysis-header p {
  opacity: 0.9;
  font-size: 16px;
}

.pdf-drop-zone {
  background: rgba(255, 255, 255, 0.15);
  border: 2px dashed rgba(255, 255, 255, 0.5);
  border-radius: 15px;
  padding: 30px 20px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  margin-bottom: 20px;
}

.pdf-drop-zone:hover {
  background: rgba(255, 255, 255, 0.2);
  border-color: rgba(255, 255, 255, 0.8);
  transform: translateY(-2px);
}

.pdf-drop-zone.dragover {
  background: rgba(255, 255, 255, 0.25);
  border-color: white;
  transform: scale(1.02);
}

.drop-icon {
  font-size: 48px;
  margin-bottom: 15px;
  opacity: 0.8;
}

.drop-text {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 8px;
}

.drop-hint {
  font-size: 14px;
  opacity: 0.8;
}

.analysis-progress {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  padding: 20px;
  margin: 15px 0;
  display: none;
}

.progress-steps {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

.progress-step {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  padding: 12px;
  text-align: center;
  transition: all 0.3s ease;
}

.progress-step.active {
  background: rgba(255, 255, 255, 0.2);
  transform: scale(1.05);
}

.progress-step.completed {
  background: rgba(76, 175, 80, 0.3);
}

.step-icon {
  font-size: 24px;
  margin-bottom: 8px;
}

.step-text {
  font-size: 12px;
  font-weight: 500;
}

.analysis-results {
  background: rgba(255, 255, 255, 0.95);
  color: #333;
  border-radius: 12px;
  padding: 20px;
  margin-top: 15px;
  display: none;
}

.results-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 15px;
  margin: 15px 0;
}

.result-item {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 15px;
  border-left: 4px solid #667eea;
}

.result-label {
  font-size: 11px;
  color: #666;
  text-transform: uppercase;
  font-weight: 600;
  margin-bottom: 5px;
}

.result-value {
  font-size: 14px;
  color: #333;
  font-weight: 500;
}

.amount-highlight {
  color: #e74c3c;
  font-weight: 700;
  font-size: 16px;
}

.auto-fill-btn {
  background: #28a745;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  margin: 10px 5px;
  transition: all 0.3s ease;
}

.auto-fill-btn:hover {
  background: #218838;
  transform: translateY(-2px);
}

.spinner {
  width: 20px;
  height: 20px;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-top: 2px solid white;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  display: inline-block;
  margin-right: 10px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      color: #333;
      line-height: 1.6;
    }

    /* Loading Screen */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: white;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .admin-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      display: none;
    }

    /* Header */
    .admin-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 20px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .admin-avatar {
      width: 60px;
      height: 60px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .admin-info h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .admin-role {
      opacity: 0.9;
      font-size: 14px;
    }

    .header-actions {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .logout-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      gap: 20px;
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
    }

    .stat-icon.users { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .stat-icon.tokens { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .stat-icon.devices { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .stat-icon.docs { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }

    .stat-content h3 {
      font-size: 32px;
      font-weight: 700;
      color: #333;
      margin-bottom: 5px;
    }

    .stat-content p {
      color: #666;
      font-size: 14px;
    }

    /* Navigation Tabs */
    .nav-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .nav-tab {
      padding: 12px 20px;
      background: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      color: #666;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .nav-tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      transform: translateY(-2px);
    }

    .nav-tab:hover:not(.active) {
      background: #f8f9fa;
      transform: translateY(-1px);
    }

    /* Section Cards */
    .section-card {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.08);
      margin-bottom: 30px;
    }

    .card-title {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Form Styles */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .form-label {
      font-weight: 600;
      margin-bottom: 8px;
      color: #555;
    }

    .form-input, .form-select {
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s;
      background: white;
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: #667eea;
    }

    /* Buttons */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary { background: #6c757d; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-warning { background: #ffc107; color: #333; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-info { background: #17a2b8; color: white; }
    .btn-small { padding: 8px 16px; font-size: 14px; }

    /* Token Generator */
    .token-generator {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 20px;
    }

    .generated-token {
      background: rgba(255, 255, 255, 0.2);
      padding: 15px;
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      margin: 15px 0;
      word-break: break-all;
    }

    /* Tables */
    .table-container {
      overflow-x: auto;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.08);
      background: white;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 12px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
    }

    .data-table td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }

    .data-table tr:hover {
      background: #f8f9ff;
    }

    /* Upload Area */
    .upload-area {
      border: 3px dashed #d1ecf1;
      border-radius: 15px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
      margin-bottom: 20px;
    }

    .upload-area:hover {
      border-color: #5a67d8;
      background: linear-gradient(135deg, #f0f2ff 0%, #f8f9ff 100%);
      transform: translateY(-2px);
    }

    .upload-icon {
      font-size: 48px;
      color: #667eea;
      margin-bottom: 15px;
    }

    .file-info {
      background: linear-gradient(135deg, #e3f2fd 0%, #f8f9ff 100%);
      border-radius: 12px;
      padding: 20px;
      margin: 15px 0;
      border-left: 4px solid #2196f3;
      display: none;
    }

    .extraction-result {
      background: linear-gradient(135deg, #e8f5e8 0%, #f0fff0 100%);
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      border-left: 4px solid #28a745;
      display: none;
    }

    /* Notifications */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 10px;
      color: white;
      font-weight: 600;
      z-index: 10000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
      max-width: 400px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success { background: #28a745; }
    .notification.error { background: #dc3545; }
    .notification.warning { background: #ffc107; color: #333; }
    .notification.info { background: #17a2b8; }

    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal.show {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    /* Modal header */
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #eee;
    }

    .modal-title {
      margin: 0;
      font-size: 20px;
      color: #333;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-btn:hover {
      color: #dc3545;
    }

    /* Password toggle */
    .password-group {
      position: relative;
    }

    .password-toggle {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      color: #666;
      padding: 5px;
      margin-top: 12px;
    }

    .password-toggle:hover {
      color: #333;
    }

    /* User actions */
    .user-actions {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }

    /* Hidden sections */
    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .admin-container {
        padding: 15px;
      }

      .header-content {
        flex-direction: column;
        text-align: center;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .nav-tabs {
        flex-direction: column;
        gap: 5px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .user-actions {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="orientation-warning">
    <div>
      <h2>📱 Xoay màn hình</h2>
      <p>Vui lòng xoay thiết bị về chế độ dọc để sử dụng ứng dụng</p>
    </div>
  </div>
  <!-- Loading Screen -->
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-spinner"></div>
    <p>Đang xác thực quyền truy cập...</p>
  </div>

  <div class="admin-container" id="adminContainer">
    <!-- Header -->
    <div class="admin-header">
      <div class="header-content">
        <div class="header-left">
          <div class="admin-avatar">
            <i class="fas fa-user-shield"></i>
          </div>
          <div class="admin-info">
            <h1 id="adminName">Admin Panel</h1>
            <div class="admin-role" id="adminRole">Super Administrator</div>
          </div>
        </div>
        <div class="header-actions">
          <span id="lastLogin" style="opacity: 0.8; font-size: 14px;"></span>
          <button class="logout-btn" onclick="logoutAdmin()">
            <i class="fas fa-sign-out-alt"></i>
            Đăng xuất
          </button>
        </div>
      </div>
    </div>

    <!-- Stats Dashboard -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon users">
          <i class="fas fa-users"></i>
        </div>
        <div class="stat-content">
          <h3 id="totalUsers">0</h3>
          <p>Tổng người dùng</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon tokens">
          <i class="fas fa-key"></i>
        </div>
        <div class="stat-content">
          <h3 id="activeTokens">0</h3>
          <p>Token hoạt động</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon devices">
          <i class="fas fa-mobile-alt"></i>
        </div>
        <div class="stat-content">
          <h3 id="totalDevices">0</h3>
          <p>Thiết bị đã xác thực</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon docs">
          <i class="fas fa-file-pdf"></i>
        </div>
        <div class="stat-content">
          <h3 id="totalDocuments">0</h3>
          <p>Chứng từ PDF</p>
        </div>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="switchTab('users')">
        <i class="fas fa-users"></i> Quản lý người dùng
      </button>
	  <button class="nav-tab" onclick="switchTab('trusted-devices')">
    <i class="fas fa-mobile-alt"></i> Thiết bị tin cậy
</button>
      <button class="nav-tab" onclick="switchTab('upload')">
        <i class="fas fa-cloud-upload-alt"></i> Upload chứng từ
      </button>
      <button class="nav-tab" onclick="switchTab('tax-lookup')">
        <i class="fas fa-search"></i> Tra cứu chứng từ
      </button>
      <button class="nav-tab" onclick="switchTab('tokens')">
        <i class="fas fa-key"></i> Quản lý Token
      </button>
      <button class="nav-tab" onclick="switchTab('documents')">
        <i class="fas fa-file-pdf"></i> Chứng từ
      </button>
      <button class="nav-tab" onclick="switchTab('notifications')">
        <i class="fas fa-bell"></i> Thông báo
      </button>
      <button class="nav-tab" onclick="switchTab('activity')">
        <i class="fas fa-history"></i> Nhật ký hoạt động
      </button>
    </div>

    <!-- User Management Section -->
    <div id="users-section" class="section active">
      <div class="section-card">
        <h2 class="card-title">
          <i class="fas fa-user-plus"></i>
          Tạo tài khoản người dùng mới
        </h2>

        <!-- Token Generator -->
        <div class="token-generator">
          <h3><i class="fas fa-key"></i> Tạo Device Token</h3>
          <p>Token này sẽ được liên kết với tài khoản người dùng</p>
          <div class="generated-token" id="generatedToken">
            Nhấn "Tạo Token mới" để tạo token
          </div>
          <button type="button" class="btn btn-primary" onclick="generateToken()">
            <i class="fas fa-refresh"></i> Tạo Token mới
          </button>
        </div>

        <!-- User Form -->
        <form onsubmit="createNewUser(event)">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Device Token *</label>
              <input type="text" id="userToken" class="form-input" required readonly 
                     placeholder="Token sẽ được tạo tự động">
            </div>
            <div class="form-group">
              <label class="form-label">Mã số thuế (MST) *</label>
              <input type="text" id="userId" class="form-input" required 
                     placeholder="Nhập mã số thuế">
            </div>
            <div class="form-group">
              <label class="form-label">Mật khẩu *</label>
              <input type="password" id="userPassword" class="form-input" required 
                     placeholder="Nhập mật khẩu">
            </div>
            <div class="form-group">
              <label class="form-label">Họ tên *</label>
              <input type="text" id="userFullName" class="form-input" required 
                     placeholder="Nhập họ tên đầy đủ">
            </div>
            <div class="form-group">
              <label class="form-label">Địa chỉ</label>
              <input type="text" id="userAddress" class="form-input" 
                     placeholder="Nhập địa chỉ">
            </div>
            <div class="form-group">
              <label class="form-label">Cục thuế</label>
              <input type="text" id="userTaxOffice" class="form-input" 
                     placeholder="Nhập tên cục thuế">
            </div>
            <div class="form-group">
              <label class="form-label">Ngày khởi tạo tài khoản thuế *</label>
              <input type="datetime-local" id="accountCreationDate" class="form-input" required>
            </div>
            <div class="form-group">
              <label class="form-label">Vai trò</label>
              <select id="userRole" class="form-select">
                <option value="taxpayer">Người nộp thuế</option>
                <option value="business">Doanh nghiệp</option>
                <option value="individual">Cá nhân</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Thời hạn (ngày)</label>
              <input type="number" id="userDuration" class="form-input" value="365" 
                     min="1" max="3650" placeholder="Số ngày có hiệu lực">
            </div>
          </div>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-user-plus"></i> Tạo tài khoản
          </button>
        </form>
      </div>

      <!-- Users List -->
      <div class="section-card">
        <h2 class="card-title">
          <i class="fas fa-users"></i>
          Danh sách người dùng
        </h2>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>MST</th>
                <th>Họ tên</th>
                <th>Vai trò</th>
                <th>Ngày tạo</th>
                <th>Trạng thái</th>
                <th>Thao tác</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <tr>
                <td colspan="6" style="text-align: center; padding: 40px;">
                  <i class="fas fa-spinner fa-spin"></i> Đang tải dữ liệu...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Upload Section -->
    <div id="upload-section" class="section">
      <div class="section-card">
        <h2 class="card-title">
          <i class="fas fa-cloud-upload-alt"></i>
          Upload chứng từ PDF
        </h2>

        <!-- File Upload Area -->
        <div class="upload-area" onclick="document.getElementById('pdfFile').click()">
          <div class="upload-icon">
            <i class="fas fa-cloud-upload-alt"></i>
          </div>
          <h3>Chọn file PDF</h3>
          <p>Nhấn vào đây để chọn file PDF hoặc kéo thả file vào đây</p>
          <input type="file" id="pdfFile" accept=".pdf" style="display: none;" onchange="handleFileSelect(event)">
        </div>

        <!-- File Info -->
        <div id="fileInfo" class="file-info">
          <h4><i class="fas fa-file-pdf"></i> Thông tin file</h4>
          <p><strong>Tên file:</strong> <span id="fileName"></span></p>
          <button type="button" class="btn btn-info" onclick="extractPDFData()">
            <i class="fas fa-search"></i> Phân tích PDF
          </button>
        </div>

        <!-- Extraction Results -->
        <div id="extractionResults" class="extraction-result">
          <h4><i class="fas fa-check-circle"></i> Thông tin được trích xuất</h4>
          <div id="extractedData"></div>
        </div>

        <!-- Document Form -->
        <form onsubmit="uploadDocument(event)">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Mã tham chiếu *</label>
              <input type="text" id="documentReference" class="form-input" required 
                     placeholder="Mã tham chiếu chứng từ">
            </div>
            <div class="form-group">
              <label class="form-label">Người nộp thuế (MST) *</label>
              <select id="documentUser" class="form-select" required>
                <option value="">Chọn người dùng</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Thuế TNCN</label>
              <input type="text" id="taxTNCN" class="form-input" 
                     placeholder="Số tiền thuế TNCN">
            </div>
            <div class="form-group">
              <label class="form-label">Thuế GTGT</label>
              <input type="text" id="taxGTGT" class="form-input" 
                     placeholder="Số tiền thuế GTGT">
            </div>
            <div class="form-group">
              <label class="form-label">Tổng số tiền *</label>
              <input type="text" id="totalAmount" class="form-input" required 
                     placeholder="Tổng số tiền" oninput="convertToWords()">
            </div>
            <div class="form-group">
              <label class="form-label">Số tiền bằng chữ</label>
              <input type="text" id="amountInWords" class="form-input" readonly 
                     placeholder="Sẽ được tự động chuyển đổi">
            </div>
            <div class="form-group">
              <label class="form-label">Ngày nộp *</label>
              <input type="date" id="paymentDate" class="form-input" required>
            </div>
            <div class="form-group">
              <label class="form-label">Giờ nộp</label>
              <input type="time" id="paymentTime" class="form-input">
            </div>
            <div class="form-group">
              <label class="form-label">Mã ĐBHC</label>
              <input type="text" id="dbhcCode" class="form-input" 
                     placeholder="Mã điều tra - bổ hoàn - chuyển">
            </div>
            <div class="form-group">
              <label class="form-label">Trạng thái</label>
              <select id="documentStatus" class="form-select">
                <option value="completed">Hoàn thành</option>
                <option value="pending">Đang xử lý</option>
                <option value="failed">Thất bại</option>
              </select>
            </div>
            <div class="form-group" style="grid-column: 1 / -1;">
              <label class="form-label">Ghi chú</label>
              <textarea id="documentNotes" class="form-input" rows="3" 
                        placeholder="Ghi chú thêm về chứng từ"></textarea>
            </div>
          </div>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> Lưu chứng từ
          </button>
        </form>
      </div>
    </div>

    <!-- Tokens Section -->
    <div id="tokens-section" class="section">
      <div class="section-card">
        <h2 class="card-title">
         <i class="fas fa-key"></i>
         Quản lý Device Token
       </h2>
       <div class="table-container">
         <table class="data-table">
           <thead>
             <tr>
               <th>Token</th>
               <th>Người dùng liên kết</th>
               <th>Ngày tạo</th>
               <th>Trạng thái</th>
               <th>Hết hạn</th>
               <th>Thao tác</th>
             </tr>
           </thead>
           <tbody id="tokensTableBody">
             <tr>
               <td colspan="6" style="text-align: center; padding: 40px;">
                 <i class="fas fa-spinner fa-spin"></i> Đang tải dữ liệu...
               </td>
             </tr>
           </tbody>
         </table>
       </div>
     </div>
   </div>

   <!-- Documents Section -->
   <div id="documents-section" class="section">
     <div class="section-card">
       <h2 class="card-title">
         <i class="fas fa-file-pdf"></i>
         Danh sách chứng từ
       </h2>
       <div class="table-container">
         <table class="data-table">
           <thead>
             <tr>
               <th>Mã tham chiếu</th>
               <th>Người nộp thuế</th>
               <th>Số tiền</th>
               <th>Ngày nộp</th>
               <th>Trạng thái</th>
               <th>Thao tác</th>
             </tr>
           </thead>
           <tbody id="documentsTableBody">
             <tr>
               <td colspan="6" style="text-align: center; padding: 40px;">
                 <i class="fas fa-spinner fa-spin"></i> Đang tải dữ liệu...
               </td>
             </tr>
           </tbody>
         </table>
       </div>
     </div>
   </div>

   <!-- Notifications Section -->
   <div id="notifications-section" class="section">
     <div class="section-card">
       <h2 class="card-title">
         <i class="fas fa-bell"></i>
         Gửi thông báo
       </h2>
       <form onsubmit="createNotification(event)">
         <div class="form-grid">
           <div class="form-group">
             <label class="form-label">Người nhận *</label>
             <select id="notificationUser" class="form-select" required>
               <option value="">Chọn người dùng</option>
               <option value="all">Tất cả người dùng</option>
             </select>
           </div>
           <div class="form-group">
             <label class="form-label">Loại thông báo *</label>
             <select id="notificationType" class="form-select" required>
               <option value="info">Thông tin</option>
               <option value="warning">Cảnh báo</option>
               <option value="success">Thành công</option>
               <option value="error">Lỗi</option>
               <option value="transaction">Giao dịch</option>
               <option value="account">Tài khoản</option>
             </select>
           </div>
           <div class="form-group">
             <label class="form-label">Tiêu đề *</label>
             <input type="text" id="notificationTitle" class="form-input" required 
                    placeholder="Tiêu đề thông báo">
           </div>
           <div class="form-group">
             <label class="form-label">Thời gian</label>
             <input type="datetime-local" id="notificationDate" class="form-input">
           </div>
           <div class="form-group" style="grid-column: 1 / -1;">
             <label class="form-label">Nội dung *</label>
             <textarea id="notificationContent" class="form-input" rows="4" required 
                       placeholder="Nội dung thông báo"></textarea>
           </div>
           <div class="form-group">
             <label class="form-label">Chứng từ liên quan</label>
             <input type="text" id="relatedDocument" class="form-input" 
                    placeholder="Mã chứng từ (nếu có)">
           </div>
         </div>
         <button type="submit" class="btn btn-primary">
           <i class="fas fa-paper-plane"></i> Gửi thông báo
         </button>
       </form>
     </div>
   </div>

   <!-- Activity Log Section -->
   <div id="activity-section" class="section">
     <div class="section-card">
       <h2 class="card-title">
         <i class="fas fa-history"></i>
         Nhật ký hoạt động hệ thống
       </h2>
       <div class="table-container">
         <table class="data-table">
           <thead>
             <tr>
               <th>Thời gian</th>
               <th>Hoạt động</th>
               <th>User/Token</th>
               <th>Thiết bị</th>
               <th>Chi tiết</th>
             </tr>
           </thead>
           <tbody id="activityTableBody">
             <tr>
               <td colspan="5" style="text-align: center; padding: 40px;">
                 <i class="fas fa-spinner fa-spin"></i> Đang tải dữ liệu...
               </td>
             </tr>
           </tbody>
         </table>
       </div>
     </div>
   </div>
 </div>

 <!-- Edit User Modal -->
 <div id="editUserModal" class="modal">
   <div class="modal-content">
     <div class="modal-header">
       <h3 class="modal-title"><i class="fas fa-edit"></i> Chỉnh sửa thông tin người dùng</h3>
       <button class="close-btn" onclick="closeModal('editUserModal')">&times;</button>
     </div>
     <form onsubmit="updateUser(event)">
       <div class="form-group">
         <label class="form-label">MST (không thể sửa)</label>
         <input type="text" id="editUserId" class="form-input" readonly>
       </div>
       <div class="form-group">
         <label class="form-label">Họ tên *</label>
         <input type="text" id="editUserName" class="form-input" required>
       </div>
       <div class="form-group">
         <label class="form-label">Địa chỉ</label>
         <input type="text" id="editUserAddress" class="form-input">
       </div>
       <div class="form-group">
         <label class="form-label">Cục thuế</label>
         <input type="text" id="editUserTaxOffice" class="form-input">
       </div>
       <div class="form-group">
         <label class="form-label">Vai trò</label>
         <select id="editUserRole" class="form-select">
           <option value="taxpayer">Người nộp thuế</option>
           <option value="business">Doanh nghiệp</option>
           <option value="individual">Cá nhân</option>
         </select>
       </div>
       <div style="display: flex; gap: 10px; margin-top: 20px;">
         <button type="submit" class="btn btn-primary">
           <i class="fas fa-save"></i> Cập nhật
         </button>
         <button type="button" class="btn btn-secondary" onclick="closeModal('editUserModal')">
           <i class="fas fa-times"></i> Hủy
         </button>
       </div>
     </form>
   </div>
 </div>

 <!-- Change Password Modal -->
 <div id="changePasswordModal" class="modal">
   <div class="modal-content">
     <div class="modal-header">
       <h3 class="modal-title"><i class="fas fa-key"></i> Đổi mật khẩu người dùng</h3>
       <button class="close-btn" onclick="closeModal('changePasswordModal')">&times;</button>
     </div>
     <form onsubmit="changeUserPassword(event)">
       <div class="form-group">
         <label class="form-label">Người dùng:</label>
         <input type="text" class="form-input" id="passwordUserId" readonly>
       </div>
       
       <div class="form-group password-group">
         <label class="form-label">Mật khẩu mới <span style="color: red;">*</span></label>
         <input type="password" class="form-input" id="newPassword" placeholder="Nhập mật khẩu mới" required minlength="6">
         <button type="button" class="password-toggle" onclick="togglePassword('newPassword')">
           <i class="fas fa-eye"></i>
         </button>
       </div>
       
       <div class="form-group password-group">
         <label class="form-label">Xác nhận mật khẩu mới <span style="color: red;">*</span></label>
         <input type="password" class="form-input" id="confirmNewPassword" placeholder="Nhập lại mật khẩu mới" required>
         <button type="button" class="password-toggle" onclick="togglePassword('confirmNewPassword')">
           <i class="fas fa-eye"></i>
         </button>
       </div>
       
       <div style="display: flex; gap: 15px; margin-top: 20px;">
         <button type="button" class="btn btn-secondary" onclick="closeModal('changePasswordModal')">
           <i class="fas fa-times"></i> Hủy
         </button>
         <button type="submit" class="btn btn-warning">
           <i class="fas fa-key"></i> Đổi mật khẩu
         </button>
       </div>
     </form>
   </div>
 </div>

 <!-- User Details Modal -->
 <div id="userDetailsModal" class="modal">
   <div class="modal-content">
     <div class="modal-header">
       <h3 class="modal-title"><i class="fas fa-user"></i> Chi tiết người dùng</h3>
       <button class="close-btn" onclick="closeModal('userDetailsModal')">&times;</button>
     </div>
     <div id="userDetailsContent" style="padding: 20px;">
       <!-- Content will be populated by JavaScript -->
     </div>
     <div style="margin-top: 20px; text-align: center;">
       <button type="button" class="btn btn-secondary" onclick="closeModal('userDetailsModal')">
         <i class="fas fa-times"></i> Đóng
       </button>
     </div>
	 <!-- Thêm section mới cho quản lý thiết bị tin cậy -->
<div id="trusted-devices-section" class="section">
    <div class="section-header">
        <h2><i class="fas fa-mobile-alt"></i> Quản lý thiết bị tin cậy</h2>
        <p>Quản lý và kiểm soát các thiết bị đã đăng ký tin cậy</p>
    </div>

    <!-- Device Stats Cards -->
    <div class="stats-grid" style="margin-bottom: 30px;">
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-mobile-alt"></i></div>
            <div class="stat-info">
                <div class="stat-number" id="totalDevicesCount">0</div>
                <div class="stat-label">Tổng thiết bị</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-clock"></i></div>
            <div class="stat-info">
                <div class="stat-number" id="activeDevicesCount">0</div>
                <div class="stat-label">Hoạt động 30 ngày</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-users"></i></div>
            <div class="stat-info">
                <div class="stat-number" id="uniqueUsersCount">0</div>
                <div class="stat-label">Người dùng duy nhất</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-trash"></i></div>
            <div class="stat-info">
                <div class="stat-number" id="oldDevicesCount">0</div>
                <div class="stat-label">Thiết bị cũ (>90 ngày)</div>
            </div>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="control-panel" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 15px; align-items: end;">
            <div>
                <label for="deviceSearchInput">🔍 Tìm kiếm:</label>
                <input type="text" id="deviceSearchInput" placeholder="MST, Device ID, User Agent..." 
                       onkeyup="filterDevices()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            
            <div>
                <label for="deviceStatusFilter">📱 Trạng thái:</label>
                <select id="deviceStatusFilter" onchange="filterDevices()" 
                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="">Tất cả</option>
                    <option value="active">Hoạt động</option>
                    <option value="inactive">Không hoạt động (>30 ngày)</option>
                    <option value="old">Cũ (>90 ngày)</option>
                </select>
            </div>
            
            <div>
                <label for="deviceDateFilter">📅 Đăng ký:</label>
                <select id="deviceDateFilter" onchange="filterDevices()" 
                        style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="">Tất cả</option>
                    <option value="today">Hôm nay</option>
                    <option value="week">7 ngày qua</option>
                    <option value="month">30 ngày qua</option>
                </select>
            </div>
            
            <div>
                <button class="btn btn-warning" onclick="cleanupOldDevices()" title="Dọn dẹp thiết bị cũ">
                    <i class="fas fa-broom"></i> Dọn dẹp
                </button>
            </div>
        </div>
    </div>

    <!-- Devices Table -->
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th style="width: 120px;">MST</th>
                    <th style="width: 150px;">Tên người dùng</th>
                    <th style="width: 120px;">Device ID</th>
                    <th style="width: 100px;">Nền tảng</th>
                    <th style="width: 130px;">Đăng ký lúc</th>
                    <th style="width: 130px;">Truy cập cuối</th>
                    <th style="width: 80px;">Trạng thái</th>
                    <th style="width: 120px;">Thao tác</th>
                </tr>
            </thead>
            <tbody id="devicesTableBody">
                <tr>
                    <td colspan="8" style="text-align: center; padding: 40px;">
                        <i class="fas fa-spinner fa-spin"></i> Đang tải dữ liệu...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Bulk Actions -->
    <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
        <h4><i class="fas fa-tools"></i> Thao tác hàng loạt</h4>
        <div style="margin-top: 10px;">
            <button class="btn btn-danger" onclick="removeSelectedDevices()" id="bulkRemoveBtn" disabled>
                <i class="fas fa-trash"></i> Xóa các thiết bị đã chọn
            </button>
            <button class="btn btn-info" onclick="exportDevicesData()" style="margin-left: 10px;">
                <i class="fas fa-download"></i> Xuất dữ liệu
            </button>
            <span style="margin-left: 15px; color: #666;" id="selectedCount">Đã chọn: 0 thiết bị</span>
        </div>
    </div>
</div>

<!-- Device Details Modal -->
<div id="deviceDetailsModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-mobile-alt"></i> Chi tiết thiết bị</h3>
            <button class="close-btn" onclick="closeModal('deviceDetailsModal')">&times;</button>
        </div>
        <div id="deviceDetailsContent" style="padding: 20px;">
            <!-- Content will be populated by JavaScript -->
        </div>
        <div style="margin-top: 20px; text-align: center;">
            <button type="button" class="btn btn-danger" id="removeDeviceBtn" onclick="removeDeviceFromModal()">
                <i class="fas fa-trash"></i> Xóa thiết bị
            </button>
            <button type="button" class="btn btn-secondary" onclick="closeModal('deviceDetailsModal')" style="margin-left: 10px;">
                <i class="fas fa-times"></i> Đóng
            </button>
        </div>
    </div>
</div>

<script>
// ===== TRUSTED DEVICE MANAGEMENT FUNCTIONS =====

let allDevices = [];
let filteredDevices = [];
let selectedDevices = new Set();
let currentDeviceDetails = null;

// Load trusted devices data
async function loadTrustedDevices() {
    try {
        console.log('📱 Loading trusted devices...');
        
        if (!trustedDeviceManager) {
            trustedDeviceManager = new TrustedDeviceManager(db);
        }
        
        // Get all trusted devices
        allDevices = await trustedDeviceManager.getAllTrustedDevices();
        filteredDevices = [...allDevices];
        
        console.log(`📱 Loaded ${allDevices.length} trusted devices`);
        
        // Update stats
        updateDeviceStats();
        
        // Render devices table
        renderDevicesTable();
        
    } catch (error) {
        console.error('❌ Error loading trusted devices:', error);
        showNotification('❌ Lỗi tải dữ liệu thiết bị: ' + error.message, 'error');
    }
}

// Update device statistics
function updateDeviceStats() {
    const now = Date.now();
    const thirtyDaysAgo = now - (30 * 24 * 60 * 60 * 1000);
    const ninetyDaysAgo = now - (90 * 24 * 60 * 60 * 1000);
    
    const totalDevices = allDevices.length;
    const activeDevices = allDevices.filter(device => device.lastAccess > thirtyDaysAgo).length;
    const uniqueUsers = new Set(allDevices.map(device => device.userId)).size;
    const oldDevices = allDevices.filter(device => device.lastAccess < ninetyDaysAgo).length;
    
    document.getElementById('totalDevicesCount').textContent = totalDevices;
    document.getElementById('activeDevicesCount').textContent = activeDevices;
    document.getElementById('uniqueUsersCount').textContent = uniqueUsers;
    document.getElementById('oldDevicesCount').textContent = oldDevices;
}

// Render devices table
function renderDevicesTable() {
    const tbody = document.getElementById('devicesTableBody');
    
    if (filteredDevices.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" style="text-align: center; padding: 40px;">
                    <i class="fas fa-mobile-alt" style="font-size: 48px; color: #ddd; margin-bottom: 10px;"></i><br>
                    <span style="color: #666;">Không có thiết bị nào</span>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = filteredDevices.map(device => {
        const registeredDate = new Date(device.registeredAt).toLocaleString('vi-VN');
        const lastAccessDate = new Date(device.lastAccess).toLocaleString('vi-VN');
        const daysSinceAccess = Math.floor((Date.now() - device.lastAccess) / (24 * 60 * 60 * 1000));
        
        let statusBadge, statusText;
        if (daysSinceAccess <= 1) {
            statusBadge = 'success';
            statusText = 'Hoạt động';
        } else if (daysSinceAccess <= 30) {
            statusBadge = 'warning';
            statusText = `${daysSinceAccess} ngày`;
        } else {
            statusBadge = 'danger';
            statusText = 'Không hoạt động';
        }
        
        const platform = device.platform || 'Unknown';
        const shortPlatform = platform.length > 15 ? platform.substring(0, 12) + '...' : platform;
        
        return `
            <tr data-device-id="${device.deviceId}" ${selectedDevices.has(device.deviceId) ? 'class="selected"' : ''}>
                <td>
                    <input type="checkbox" class="device-checkbox" value="${device.deviceId}" 
                           onchange="toggleDeviceSelection('${device.deviceId}')" 
                           ${selectedDevices.has(device.deviceId) ? 'checked' : ''}>
                    <strong>${device.userId}</strong>
                </td>
                <td title="${device.userInfo?.name || 'N/A'}">${device.userInfo?.name || 'N/A'}</td>
                <td>
                    <code style="font-size: 11px;">${device.deviceId.substring(7, 19)}...</code>
                </td>
                <td title="${platform}">${shortPlatform}</td>
                <td>${registeredDate}</td>
                <td>${lastAccessDate}</td>
                <td><span class="badge badge-${statusBadge}">${statusText}</span></td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="viewDeviceDetails('${device.deviceId}')" title="Xem chi tiết">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="removeDevice('${device.deviceId}')" title="Xóa thiết bị">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// Filter devices
function filterDevices() {
    const searchTerm = document.getElementById('deviceSearchInput').value.toLowerCase();
    const statusFilter = document.getElementById('deviceStatusFilter').value;
    const dateFilter = document.getElementById('deviceDateFilter').value;
    
    filteredDevices = allDevices.filter(device => {
        // Search filter
        const matchesSearch = !searchTerm || 
            device.userId.toLowerCase().includes(searchTerm) ||
            device.deviceId.toLowerCase().includes(searchTerm) ||
            (device.userInfo?.name || '').toLowerCase().includes(searchTerm) ||
            (device.userAgent || '').toLowerCase().includes(searchTerm) ||
            (device.platform || '').toLowerCase().includes(searchTerm);
        
        // Status filter
        let matchesStatus = true;
        if (statusFilter) {
            const daysSinceAccess = Math.floor((Date.now() - device.lastAccess) / (24 * 60 * 60 * 1000));
            switch (statusFilter) {
                case 'active':
                    matchesStatus = daysSinceAccess <= 30;
                    break;
                case 'inactive':
                    matchesStatus = daysSinceAccess > 30 && daysSinceAccess <= 90;
                    break;
                case 'old':
                    matchesStatus = daysSinceAccess > 90;
                    break;
            }
        }
        
        // Date filter
        let matchesDate = true;
        if (dateFilter) {
            const deviceDate = new Date(device.registeredAt);
            const now = new Date();
            switch (dateFilter) {
                case 'today':
                    matchesDate = deviceDate.toDateString() === now.toDateString();
                    break;
                case 'week':
                    matchesDate = (now - deviceDate) <= (7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    matchesDate = (now - deviceDate) <= (30 * 24 * 60 * 60 * 1000);
                    break;
            }
        }
        
        return matchesSearch && matchesStatus && matchesDate;
    });
    
    renderDevicesTable();
}

// Toggle device selection
function toggleDeviceSelection(deviceId) {
    if (selectedDevices.has(deviceId)) {
        selectedDevices.delete(deviceId);
    } else {
        selectedDevices.add(deviceId);
    }
    
    updateSelectionUI();
}

// Update selection UI
function updateSelectionUI() {
    const count = selectedDevices.size;
    document.getElementById('selectedCount').textContent = `Đã chọn: ${count} thiết bị`;
    document.getElementById('bulkRemoveBtn').disabled = count === 0;
    
    // Update row styling
    filteredDevices.forEach(device => {
        const row = document.querySelector(`tr[data-device-id="${device.deviceId}"]`);
        if (row) {
            if (selectedDevices.has(device.deviceId)) {
                row.classList.add('selected');
            } else {
                row.classList.remove('selected');
            }
        }
    });
}

// View device details
async function viewDeviceDetails(deviceId) {
    try {
        const device = allDevices.find(d => d.deviceId === deviceId);
        if (!device) {
            showNotification('❌ Không tìm thấy thiết bị', 'error');
            return;
        }
        
        currentDeviceDetails = device;
        
        const content = document.getElementById('deviceDetailsContent');
        content.innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h4><i class="fas fa-user"></i> Thông tin người dùng</h4>
                    <table class="detail-table">
                        <tr><td><strong>MST:</strong></td><td>${device.userId}</td></tr>
                        <tr><td><strong>Tên:</strong></td><td>${device.userInfo?.name || 'N/A'}</td></tr>
                        <tr><td><strong>Email:</strong></td><td>${device.userInfo?.email || 'N/A'}</td></tr>
                        <tr><td><strong>Token sử dụng:</strong></td><td><code>${device.token}</code></td></tr>
                    </table>
                </div>
                
                <div>
                    <h4><i class="fas fa-mobile-alt"></i> Thông tin thiết bị</h4>
                    <table class="detail-table">
                        <tr><td><strong>Device ID:</strong></td><td><code style="font-size: 11px;">${device.deviceId}</code></td></tr>
                        <tr><td><strong>Fingerprint:</strong></td><td><code style="font-size: 11px;">${device.fingerprint.substring(0, 20)}...</code></td></tr>
                        <tr><td><strong>Nền tảng:</strong></td><td>${device.platform || 'N/A'}</td></tr>
                        <tr><td><strong>Ngôn ngữ:</strong></td><td>${device.language || 'N/A'}</td></tr>
                        <tr><td><strong>Màn hình:</strong></td><td>${device.screenResolution || 'N/A'}</td></tr>
                        <tr><td><strong>Timezone:</strong></td><td>${device.timezone || 'N/A'}</td></tr>
                    </table>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <h4><i class="fas fa-clock"></i> Thời gian</h4>
                <table class="detail-table">
                    <tr><td><strong>Đăng ký lúc:</strong></td><td>${new Date(device.registeredAt).toLocaleString('vi-VN')}</td></tr>
                    <tr><td><strong>Truy cập cuối:</strong></td><td>${new Date(device.lastAccess).toLocaleString('vi-VN')}</td></tr>
                    <tr><td><strong>Trạng thái:</strong></td><td>${device.status || 'active'}</td></tr>
                    <tr><td><strong>Phương thức đăng ký:</strong></td><td>${device.userInfo?.registrationMethod || 'N/A'}</td></tr>
                </table>
            </div>
            
            <div style="margin-top: 20px;">
                <h4><i class="fas fa-code"></i> User Agent</h4>
                <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; word-break: break-all;">
                    ${device.userAgent || 'N/A'}
                </div>
            </div>
        `;
        
        openModal('deviceDetailsModal');
        
    } catch (error) {
        console.error('❌ Error viewing device details:', error);
        showNotification('❌ Lỗi xem chi tiết thiết bị: ' + error.message, 'error');
    }
}

// Remove single device
async function removeDevice(deviceId) {
    const device = allDevices.find(d => d.deviceId === deviceId);
    if (!device) {
        showNotification('❌ Không tìm thấy thiết bị', 'error');
        return;
    }
    
    if (!confirm(`⚠️ BẠN CÓ CHẮC CHẮN MUỐN XÓA THIẾT BỊ TIN CẬY NÀY?\n\nUser: ${device.userId}\nDevice: ${device.deviceId.substring(7, 19)}...\nĐăng ký: ${new Date(device.registeredAt).toLocaleString('vi-VN')}\n\nSau khi xóa, user sẽ phải nhập token mới để truy cập lại.\n\nNhấn OK để xác nhận xóa`)) {
        return;
    }
    
    try {
        const result = await trustedDeviceManager.removeTrustedDevice(deviceId, currentAdminUser.username);
        
        if (result.success) {
            showNotification(`🎉 Đã xóa thiết bị tin cậy thành công!\n\nUser "${device.userId}" sẽ phải xác thực token lại lần sau.`, 'success');
            
            // Remove from local arrays
            allDevices = allDevices.filter(d => d.deviceId !== deviceId);
            filteredDevices = filteredDevices.filter(d => d.deviceId !== deviceId);
            selectedDevices.delete(deviceId);
            
            // Refresh UI
            updateDeviceStats();
            renderDevicesTable();
            updateSelectionUI();
            
        } else {
            showNotification('❌ Lỗi xóa thiết bị: ' + result.error, 'error');
        }
        
    } catch (error) {
        console.error('❌ Error removing device:', error);
        showNotification('❌ Có lỗi khi xóa thiết bị: ' + error.message, 'error');
    }
}

// Remove device from modal
function removeDeviceFromModal() {
    if (currentDeviceDetails) {
        closeModal('deviceDetailsModal');
        removeDevice(currentDeviceDetails.deviceId);
    }
}

// Remove selected devices
async function removeSelectedDevices() {
    if (selectedDevices.size === 0) {
        showNotification('❌ Vui lòng chọn ít nhất một thiết bị để xóa', 'error');
        return;
    }
    
    const selectedArray = Array.from(selectedDevices);
    const deviceNames = selectedArray.map(deviceId => {
        const device = allDevices.find(d => d.deviceId === deviceId);
        return device ? device.userId : deviceId;
    }).join(', ');
    
    if (!confirm(`⚠️ BẠN CÓ CHẮC CHẮN MUỐN XÓA ${selectedDevices.size} THIẾT BỊ TIN CẬY?\n\nCác user: ${deviceNames}\n\nSau khi xóa, các user này sẽ phải nhập token mới để truy cập lại.\n\nNhấn OK để xác nhận xóa hàng loạt`)) {
        return;
    }
    
    try {
        let successCount = 0;
        let errorCount = 0;
        
        showNotification(`🔄 Đang xóa ${selectedDevices.size} thiết bị...`, 'info');
        
        for (const deviceId of selectedArray) {
            try {
                const result = await trustedDeviceManager.removeTrustedDevice(deviceId, currentAdminUser.username);
                if (result.success) {
                    successCount++;
                } else {
                    errorCount++;
                }
            } catch (error) {
                errorCount++;
                console.error('❌ Error removing device:', deviceId, error);
            }
        }
        
        // Update local data
        allDevices = allDevices.filter(d => !selectedArray.includes(d.deviceId));
        filteredDevices = filteredDevices.filter(d => !selectedArray.includes(d.deviceId));
        selectedDevices.clear();
        
        // Refresh UI
        updateDeviceStats();
        renderDevicesTable();
        updateSelectionUI();
        
        showNotification(`🎉 Đã xóa thành công ${successCount}/${selectedArray.length} thiết bị!${errorCount > 0 ? `\n⚠️ ${errorCount} thiết bị gặp lỗi` : ''}`, 'success');
        
    } catch (error) {
        console.error('❌ Error in bulk remove:', error);
        showNotification('❌ Có lỗi khi xóa hàng loạt: ' + error.message, 'error');
    }
}

// Cleanup old devices
async function cleanupOldDevices() {
    if (!confirm(`🧹 DỌON DẸP THIẾT BỊ CŨ\n\nThao tác này sẽ xóa tất cả thiết bị không hoạt động quá 90 ngày.\n\nBạn có chắc chắn muốn tiếp tục?\n\nNhấn OK để xác nhận dọn dẹp`)) {
        return;
    }
    
    try {
        showNotification('🧹 Đang dọn dẹp thiết bị cũ...', 'info');
        
        const cleanedCount = await trustedDeviceManager.cleanupOldDevices(90);
        
        if (cleanedCount > 0) {
            showNotification(`🎉 Đã dọn dẹp ${cleanedCount} thiết bị cũ thành công!`, 'success');
            
            // Reload data
            await loadTrustedDevices();
        } else {
            showNotification('ℹ️ Không có thiết bị cũ nào cần dọn dẹp', 'info');
        }
        
    } catch (error) {
        console.error('❌ Error cleaning up devices:', error);
        showNotification('❌ Lỗi dọn dẹp thiết bị: ' + error.message, 'error');
    }
}

// Export devices data
function exportDevicesData() {
    try {
        const csvData = [
            ['MST', 'Tên người dùng', 'Device ID', 'Nền tảng', 'Đăng ký lúc', 'Truy cập cuối', 'Trạng thái', 'Token', 'User Agent']
        ];
        
        allDevices.forEach(device => {
            const daysSinceAccess = Math.floor((Date.now() - device.lastAccess) / (24 * 60 * 60 * 1000));
            const status = daysSinceAccess <= 30 ? 'Hoạt động' : 'Không hoạt động';
            
            csvData.push([
                device.userId,
                device.userInfo?.name || 'N/A',
                device.deviceId,
                device.platform || 'N/A',
                new Date(device.registeredAt).toLocaleString('vi-VN'),
                new Date(device.lastAccess).toLocaleString('vi-VN'),
                status,
                device.token || 'N/A',
                device.userAgent || 'N/A'
            ]);
        });
        
        const csvContent = csvData.map(row => 
            row.map(field => `"${field}"`).join(',')
        ).join('\n');
        
        const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `etax_trusted_devices_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        
        showNotification('📁 Đã xuất dữ liệu thiết bị thành công!', 'success');
        
    } catch (error) {
        console.error('❌ Error exporting data:', error);
        showNotification('❌ Lỗi xuất dữ liệu: ' + error.message, 'error');
    }
}

// ===== UPDATE MAIN ADMIN FUNCTIONS =====

// Update switchTab function to handle trusted devices
const originalSwitchTab = switchTab;
switchTab = function(tabName) {
    originalSwitchTab(tabName);
    
    // Load trusted devices data when tab is opened
    if (tabName === 'trusted-devices') {
        loadTrustedDevices();
    }
};

// Update loadDashboardStats to include device stats
const originalLoadDashboardStats = loadDashboardStats;
loadDashboardStats = async function() {
    await originalLoadDashboardStats();
    
    // Add device stats to dashboard
    try {
        if (!trustedDeviceManager) {
            trustedDeviceManager = new TrustedDeviceManager(db);
        }
        
        const devices = await trustedDeviceManager.getAllTrustedDevices();
        const deviceCount = devices.length;
        
        // Update dashboard if device stat card exists
        const deviceStatCard = document.getElementById('deviceStatCard');
        if (deviceStatCard) {
            deviceStatCard.querySelector('.stat-number').textContent = deviceCount;
        }
        
    } catch (error) {
        console.warn('⚠️ Could not load device stats for dashboard:', error);
    }
};

// ===== ADDITIONAL CSS STYLES =====
const additionalStyles = `
<style>
.detail-table {
    width: 100%;
    margin: 10px 0;
}

.detail-table td {
    padding: 5px;
    border-bottom: 1px solid #eee;
}

.detail-table td:first-child {
    width: 40%;
    color: #666;
}

.selected {
    background-color: #e3f2fd !important;
}

.device-checkbox {
    margin-right: 8px;
}

.badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: bold;
    text-transform: uppercase;
}

.badge-success {
    background: #4CAF50;
    color: white;
}

.badge-warning {
    background: #FF9800;
    color: white;
}

.badge-danger {
    background: #f44336;
    color: white;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 12px;
    margin: 0 2px;
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr 1fr;
    }
    
    .control-panel > div {
        grid-template-columns: 1fr;
    }
    
    .data-table {
        font-size: 12px;
    }
    
    .data-table th,
    .data-table td {
        padding: 8px 4px;
    }
}
</style>
`;

// Add styles to head
document.head.insertAdjacentHTML('beforeend', additionalStyles);

console.log('✅ Trusted Device Management loaded successfully');
</script>
   </div>
 </div>

 <script>
   // ===== FIREBASE CONFIGURATION =====
   const firebaseConfig = {
     apiKey: "AIzaSyD_rJgBFgBulheVenQUE2KXr4PBpSpTCxw",
     authDomain: "etax-7fbf8.firebaseapp.com",
     databaseURL: "https://etax-7fbf8-default-rtdb.asia-southeast1.firebasedatabase.app",
     projectId: "etax-7fbf8",
     storageBucket: "etax-7fbf8.appspot.com",
     messagingSenderId: "1030026724634",
     appId: "1:1030026724634:web:d76f5f9dad43bad6fd58a3",
     measurementId: "G-YS5DLECJE6"
   };

   // Initialize Firebase
   firebase.initializeApp(firebaseConfig);
   const db = firebase.database();

   // ===== GLOBAL VARIABLES =====
   let currentAdminUser = null;
   let currentToken = '';
   let editingUserId = '';

   // ===== AUTHENTICATION AND INITIALIZATION =====
   async function checkAdminAuth() {
     const session = localStorage.getItem('etax_admin_session');
     
     if (!session) {
       window.location.href = 'admin-login.html';
       return;
     }

     try {
       currentAdminUser = JSON.parse(session);
       
       // Update UI
       document.getElementById('adminName').textContent = currentAdminUser.username || 'Admin Panel';
       document.getElementById('adminRole').textContent = currentAdminUser.role || 'Administrator';
       
       if (currentAdminUser.loginTime) {
         document.getElementById('lastLogin').textContent = 
           `Đăng nhập lần cuối: ${new Date(currentAdminUser.loginTime).toLocaleString('vi-VN')}`;
       }

       // Hide loading screen and show admin panel
       document.getElementById('loadingScreen').style.display = 'none';
       document.getElementById('adminContainer').style.display = 'block';

       // Load initial data
       await loadDashboardStats();
       await loadUsers();
       await loadUserDropdown();
       await loadTokens();
       await loadDocuments();
       await loadActivityLog();
       setDefaultDateTime();
       setDefaultNotificationDate();
       setDefaultAccountCreationDate();

       console.log('✅ Admin panel loaded successfully');

     } catch (error) {
       console.error('Auth error:', error);
       localStorage.removeItem('etax_admin_session');
       window.location.href = 'admin-login.html';
     }
   }

   // ===== NAVIGATION FUNCTIONS =====
   function switchTab(tabName) {
     // Hide all sections
     document.querySelectorAll('.section').forEach(section => {
       section.classList.remove('active');
     });

     // Remove active class from all tabs
     document.querySelectorAll('.nav-tab').forEach(tab => {
       tab.classList.remove('active');
     });

     // Show selected section
     document.getElementById(tabName + '-section').classList.add('active');

     // Add active class to clicked tab
     event.target.classList.add('active');

     // Load data for specific sections
     if (tabName === 'activity') {
       loadActivityLog();
     }
   }

   // ===== TOKEN MANAGEMENT =====
   function generateToken() {
     currentToken = 'ETAX' + Date.now().toString(36).toUpperCase() + 
                    Math.random().toString(36).substr(2, 5).toUpperCase();
     
     document.getElementById('generatedToken').textContent = currentToken;
     document.getElementById('userToken').value = currentToken;
     
     showNotification('🎉 Token mới đã được tạo: ' + currentToken, 'success');
   }

   // ===== USER MANAGEMENT FUNCTIONS =====
   async function createNewUser(event) {
     event.preventDefault();
     
     const token = document.getElementById('userToken').value.trim();
     const userId = document.getElementById('userId').value.trim();
     const password = document.getElementById('userPassword').value.trim();
     const fullName = document.getElementById('userFullName').value.trim();
     const address = document.getElementById('userAddress').value.trim();
     const taxOffice = document.getElementById('userTaxOffice').value.trim();
     const accountCreationDate = document.getElementById('accountCreationDate').value;
     const role = document.getElementById('userRole').value;
     const duration = parseInt(document.getElementById('userDuration').value);

     if (!token || !userId || !password || !fullName || !accountCreationDate) {
       showNotification('❌ Vui lòng điền đầy đủ thông tin bắt buộc!', 'error');
       return;
     }

     try {
       // Check if user already exists
       const userSnapshot = await db.ref('users/' + userId).once('value');
       if (userSnapshot.exists()) {
         showNotification('❌ MST này đã tồn tại trong hệ thống!', 'error');
         return;
       }

       const now = Date.now();
       const expiresAt = now + (duration * 24 * 60 * 60 * 1000);
       const taxAccountCreationTime = new Date(accountCreationDate).getTime();

       // Create user data
       const userData = {
         mst: userId,
         password: password,
         name: fullName,
         address: address,
         taxoffice: taxOffice,
         role: role,
         date: new Date().toISOString().split('T')[0],
         duration: duration,
         createdAt: now,
         expiresAt: expiresAt,
         taxAccountCreationDate: taxAccountCreationTime,
         taxAccountCreationDateFormatted: new Date(accountCreationDate).toLocaleString('vi-VN'),
         status: 'active',
         linkedToken: token,
         createdBy: currentAdminUser.username
       };

       // Create token data
       const tokenData = {
         linkedUserId: userId,
         createdAt: now,
         expiresAt: expiresAt,
         used: false,
         createdBy: currentAdminUser.username
       };

       // Save to Firebase
       await db.ref('users/' + userId).set(userData);
       await db.ref('deviceTokens/' + token).set(tokenData);

       // Send account opening notification
       const accountNotification = {
         type: 'account_opened',
         title: 'Mở tài khoản giao dịch thuế điện tử',
         content: `Chúc mừng! Tài khoản giao dịch thuế điện tử của bạn đã được mở thành công vào ngày ${new Date(accountCreationDate).toLocaleString('vi-VN')}. 

Thông tin tài khoản:
- MST: ${userId}
- Họ tên: ${fullName}
- Ngày mở: ${new Date(accountCreationDate).toLocaleString('vi-VN')}
- Thời hạn: ${duration} ngày

Bạn có thể bắt đầu sử dụng các dịch vụ thuế điện tử ngay bây giờ!`,
         timestamp: Date.now(),
         relatedDocument: null
       };

       await createNotificationForUser(userId, accountNotification);

       // Log activity
       await db.ref('activityLogs').push({
         type: 'user_created',
         userId: userId,
         userName: fullName,
         token: token,
         taxAccountCreationDate: taxAccountCreationTime,
         timestamp: Date.now(),
         details: `Admin tạo tài khoản mới cho ${fullName} với ngày khởi tạo thuế: ${new Date(accountCreationDate).toLocaleString('vi-VN')}`,
         admin: currentAdminUser.username
       });

       showNotification(`🎉 Tạo tài khoản thành công!\n\n👤 User: ${fullName}\n🔑 Token: ${token}\n📅 Ngày mở tài khoản thuế: ${new Date(accountCreationDate).toLocaleString('vi-VN')}\n\n✅ Đã gửi thông báo mở tài khoản cho user!`, 'success');
       
       // Reset form
       document.querySelector('#users-section form').reset();
       document.getElementById('userDuration').value = '365';
       document.getElementById('generatedToken').textContent = 'Nhấn "Tạo Token mới" để tạo token';
       document.getElementById('userToken').value = '';
       currentToken = '';
       setDefaultDateTime();
       setDefaultAccountCreationDate();
       
       // Reload data
       loadUsers();
       loadDashboardStats();
       loadUserDropdown();

     } catch (error) {
       console.error('Error creating user:', error);
       showNotification('❌ Có lỗi xảy ra khi tạo tài khoản: ' + error.message, 'error');
     }
   }

   async function loadUsers() {
     try {
       console.log('👥 Loading users...');
       
       const snapshot = await db.ref('users').once('value');
       const users = snapshot.val() || {};
       
       const tbody = document.getElementById('usersTableBody');
       if (!tbody) {
         console.warn('Users table body not found');
         return;
       }
       
       tbody.innerHTML = '';

       if (Object.keys(users).length === 0) {
         tbody.innerHTML = `
           <tr>
             <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
               <i class="fas fa-users" style="font-size: 48px; opacity: 0.3; margin-bottom: 10px; display: block;"></i>
               Chưa có người dùng nào được tạo
             </td>
           </tr>
         `;
         return;
       }

       Object.entries(users).forEach(([userId, userData]) => {
         const createdDate = userData.createdAt ? 
           new Date(userData.createdAt).toLocaleDateString('vi-VN') : 
           userData.date || 'N/A';
         
         const status = userData.status === 'active' ? 
           '<span style="color: #28a745; font-weight: bold;">✅ Hoạt động</span>' : 
           '<span style="color: #dc3545; font-weight: bold;">❌ Không hoạt động</span>';

         const row = `
           <tr>
             <td><code>${userId}</code></td>
             <td><strong>${userData.name || 'N/A'}</strong></td>
             <td><span class="badge">${userData.role || 'taxpayer'}</span></td>
             <td>${createdDate}</td>
             <td>${status}</td>
             <td>
               <div class="user-actions">
                 <button class="btn btn-small btn-info" onclick="viewUserDetails('${userId}')" title="Xem chi tiết">
                   <i class="fas fa-eye"></i>
                 </button>
                 <button class="btn btn-small btn-warning" onclick="editUser('${userId}')" title="Chỉnh sửa">
                   <i class="fas fa-edit"></i>
                 </button>
                 <button class="btn btn-small btn-success" onclick="changePassword('${userId}')" title="Đổi mật khẩu">
                   <i class="fas fa-key"></i>
                 </button>
                 <button class="btn btn-small" style="background: #17a2b8; color: white;" onclick="generateNewToken('${userId}')" title="Tạo token mới">
                   <i class="fas fa-refresh"></i>
                 </button>
                 <button class="btn btn-small" style="background: #6f42c1; color: white;" onclick="loginAsUser('${userId}')" title="Đăng nhập trực tiếp">
                   <i class="fas fa-sign-in-alt"></i>
                 </button>
                 <button class="btn btn-small btn-danger" onclick="deleteUser('${userId}')" title="Xóa">
                   <i class="fas fa-trash"></i>
                 </button>
               </div>
             </td>
           </tr>
         `;
         tbody.innerHTML += row;
       });

       console.log('✅ Users loaded:', Object.keys(users).length);

     } catch (error) {
       console.error('Error loading users:', error);
       showNotification('❌ Có lỗi khi tải danh sách người dùng', 'error');
     }
   }

   // View user details
   async function viewUserDetails(userId) {
     try {
       const snapshot = await db.ref('users/' + userId).once('value');
       const userData = snapshot.val();
       
       if (!userData) {
         showNotification('❌ Không tìm thấy thông tin người dùng', 'error');
         return;
       }

       const createdDate = userData.createdAt ? new Date(userData.createdAt).toLocaleString('vi-VN') : 'N/A';
       const expiresDate = userData.expiresAt ? new Date(userData.expiresAt).toLocaleString('vi-VN') : 'N/A';
       const taxAccountDate = userData.taxAccountCreationDateFormatted || 'N/A';

       const detailsHTML = `
         <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 15px;">
           <h4 style="color: #495057; margin-bottom: 15px;"><i class="fas fa-user"></i> Thông tin cơ bản</h4>
           <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
             <div><strong>🆔 MST:</strong> ${userId}</div>
             <div><strong>👤 Họ tên:</strong> ${userData.name || 'N/A'}</div>
             <div><strong>🏠 Địa chỉ:</strong> ${userData.address || 'N/A'}</div>
             <div><strong>🏢 CQT quản lý:</strong> ${userData.taxoffice || 'N/A'}</div>
             <div><strong>👑 Vai trò:</strong> ${userData.role || 'taxpayer'}</div>
             <div><strong>📅 Ngày tạo:</strong> ${createdDate}</div>
             <div><strong>⏰ Hết hạn:</strong> ${expiresDate}</div>
             <div><strong>📝 Thời hạn:</strong> ${userData.duration || 0} ngày</div>
           </div>
         </div>
         
         <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
           <h4 style="color: #856404; margin-bottom: 10px;"><i class="fas fa-shield-alt"></i> Thông tin bảo mật</h4>
           <div style="font-size: 14px;">
             <div><strong>🔑 Token liên kết:</strong> <code>${userData.linkedToken || 'N/A'}</code></div>
             <div style="margin-top: 5px;"><strong>🔐 Mật khẩu:</strong> <code>${userData.password || 'N/A'}</code> <span style="color: #dc3545;">(chỉ admin mới thấy)</span></div>
           </div>
         </div>
         
         <div style="background: #d4edda; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
           <h4 style="color: #155724; margin-bottom: 10px;"><i class="fas fa-calendar-alt"></i> Thông tin thuế</h4>
           <div style="font-size: 14px;">
             <div><strong>📅 Ngày khởi tạo tài khoản thuế:</strong> ${taxAccountDate}</div>
           </div>
         </div>
         
         <div style="background: #d1ecf1; padding: 15px; border-radius: 10px;">
           <h4 style="color: #0c5460; margin-bottom: 10px;"><i class="fas fa-info-circle"></i> Thông tin hệ thống</h4>
           <div style="font-size: 14px;">
             <div><strong>👨‍💼 Được tạo bởi:</strong> ${userData.createdBy || 'N/A'}</div>
             <div><strong>🔄 Cập nhật lần cuối:</strong> ${userData.updatedAt ? new Date(userData.updatedAt).toLocaleString('vi-VN') : 'Chưa cập nhật'}</div>
             <div><strong>👨‍💼 Được cập nhật bởi:</strong> ${userData.updatedBy || 'N/A'}</div>
           </div>
         </div>
       `;

       document.getElementById('userDetailsContent').innerHTML = detailsHTML;
       showModal('userDetailsModal');

     } catch (error) {
       console.error('Error loading user details:', error);
       showNotification('❌ Có lỗi khi tải thông tin chi tiết', 'error');
     }
   }

   // Edit user
   async function editUser(userId) {
     try {
       console.log('🔧 Đang tải thông tin user:', userId);
       
       const snapshot = await db.ref('users/' + userId).once('value');
       const userData = snapshot.val();
       
       if (!userData) {
         showNotification('❌ Không tìm thấy thông tin người dùng', 'error');
         return;
       }

       console.log('✅ Đã load dữ liệu user:', userData);

       // Fill edit form
       document.getElementById('editUserId').value = userId;
       document.getElementById('editUserName').value = userData.name || '';
       document.getElementById('editUserAddress').value = userData.address || '';
       document.getElementById('editUserTaxOffice').value = userData.taxoffice || '';
       document.getElementById('editUserRole').value = userData.role || 'taxpayer';
       
       editingUserId = userId;
       showModal('editUserModal');
       
       console.log('✅ Đã mở modal edit user');

     } catch (error) {
       console.error('❌ Error loading user data:', error);
       showNotification('❌ Có lỗi khi tải thông tin người dùng: ' + error.message, 'error');
     }
   }

   // Update user
   async function updateUser(event) {
     event.preventDefault();
     
     if (!editingUserId) {
       showNotification('❌ Không xác định được người dùng cần cập nhật', 'error');
       return;
     }

     try {
       const updateData = {
         name: document.getElementById('editUserName').value.trim(),
         address: document.getElementById('editUserAddress').value.trim(),
         taxoffice: document.getElementById('editUserTaxOffice').value.trim(),
         role: document.getElementById('editUserRole').value,
         updatedAt: Date.now(),
         updatedBy: currentAdminUser.username
       };

       await db.ref('users/' + editingUserId).update(updateData);
       
       // Log update
       await db.ref('activityLogs').push({
         type: 'user_updated',
         userId: editingUserId,
         admin: currentAdminUser.username,
         timestamp: Date.now(),
         details: `Cập nhật thông tin user ${editingUserId}`
       });
       
       showNotification('🎉 Cập nhật thông tin thành công!', 'success');
       closeModal('editUserModal');
       loadUsers();
       loadUserDropdown();
       loadDashboardStats();

     } catch (error) {
       console.error('Error updating user:', error);
       showNotification('❌ Có lỗi khi cập nhật thông tin: ' + error.message, 'error');
     }
   }

   // Change password
   function changePassword(userId) {
     editingUserId = userId;
     document.getElementById('passwordUserId').value = userId;
     document.getElementById('newPassword').value = '';
     document.getElementById('confirmNewPassword').value = '';
     showModal('changePasswordModal');
   }

   // Change user password submit
   async function changeUserPassword(event) {
     event.preventDefault();
     
     const newPassword = document.getElementById('newPassword').value;
     const confirmPassword = document.getElementById('confirmNewPassword').value;
     
     if (newPassword !== confirmPassword) {
       showNotification('❌ Mật khẩu xác nhận không khớp!', 'error');
       return;
     }
     
     if (newPassword.length < 6) {
       showNotification('❌ Mật khẩu phải có ít nhất 6 ký tự!', 'error');
       return;
     }
     
     try {
       await db.ref('users/' + editingUserId + '/password').set(newPassword);
       
       // Log password change
       await db.ref('activityLogs').push({
         type: 'password_changed',
         userId: editingUserId,
         admin: currentAdminUser.username,
         timestamp: Date.now(),
         details: `Đổi mật khẩu cho user ${editingUserId}`
       });
       
       showNotification(`🎉 Đã đổi mật khẩu cho user "${editingUserId}" thành công!`, 'success');
       closeModal('changePasswordModal');
       
     } catch (error) {
       console.error('Error changing password:', error);
       showNotification('❌ Có lỗi khi đổi mật khẩu: ' + error.message, 'error');
     }
   }

   // Generate new token for user
   async function generateNewToken(userId) {
     if (!confirm(`Tạo token mới cho user "${userId}"?\n\nToken cũ sẽ bị vô hiệu hóa.`)) {
       return;
     }

     try {
       // Tạo token mới
       const newToken = 'ETAX' + Date.now().toString(36).toUpperCase() + 
                        Math.random().toString(36).substr(2, 5).toUpperCase();
       
       // Get user data
       const userSnapshot = await db.ref('users/' + userId).once('value');
       const userData = userSnapshot.val();
       
       if (!userData) {
         showNotification('❌ Không tìm thấy user', 'error');
         return;
       }

       // Xóa token cũ nếu có
       if (userData.linkedToken) {
         await db.ref('deviceTokens/' + userData.linkedToken).remove();
       }

       // Tạo token data mới
       const now = Date.now();
       const expiresAt = now + (365 * 24 * 60 * 60 * 1000); // 1 năm

       const tokenData = {
         linkedUserId: userId,
         createdAt: now,
         expiresAt: expiresAt,
         used: false,
         createdBy: currentAdminUser.username
       };

       // Lưu token mới
       await db.ref('deviceTokens/' + newToken).set(tokenData);
       
       // Cập nhật user với token mới
       await db.ref('users/' + userId + '/linkedToken').set(newToken);

       // Log activity
       await db.ref('activityLogs').push({
         type: 'token_regenerated',
         userId: userId,
         newToken: newToken,
         oldToken: userData.linkedToken || 'N/A',
         admin: currentAdminUser.username,
         timestamp: Date.now(),
         details: `Tạo token mới cho user ${userId}`
       });

       showNotification(`🎉 Đã tạo token mới cho user "${userId}"!\n\nToken: ${newToken}`, 'success');
       
       // Reload data
       loadUsers();
       loadTokens();
       loadDashboardStats();

     } catch (error) {
       console.error('Error generating new token:', error);
       showNotification('❌ Có lỗi khi tạo token mới: ' + error.message, 'error');
     }
   }

   // Login as user (direct access)
   function loginAsUser(userId) {
     if (confirm(`Đăng nhập trực tiếp vào tài khoản "${userId}"?\n\nBạn sẽ được chuyển đến index.html của user này.`)) {
       // Tạo session tạm cho user
       const userSession = {
         mst: userId,
         directLoginByAdmin: true,
         adminUser: currentAdminUser.username,
         loginTime: Date.now()
       };
       
       // Lưu vào localStorage
       localStorage.setItem('etax_admin_direct_login', JSON.stringify(userSession));
       
       // Chuyển đến index.html
       window.open(`index.html?admin_login=${userId}`, '_blank');
       
       showNotification(`🔗 Đang mở index.html cho user "${userId}"`, 'info');
     }
   }

   // Delete user
   async function deleteUser(userId) {
     if (!confirm(`⚠️ BẠN CÓ CHẮC CHẮN MUỐN XÓA NGƯỜI DÙNG "${userId}"?\n\nThao tác này sẽ:\n- Xóa vĩnh viễn tài khoản\n- Vô hiệu hóa token liên kết\n- Xóa tất cả chứng từ liên quan\n- Không thể hoàn tác\n\nNhấn OK để xác nhận xóa`)) {
       return;
     }

     try {
       // Get user data to find linked token and documents
       const userSnapshot = await db.ref('users/' + userId).once('value');
       const userData = userSnapshot.val();
       
       // Delete user
       await db.ref('users/' + userId).remove();
       
       // Delete linked token if exists
       if (userData && userData.linkedToken) {
         await db.ref('deviceTokens/' + userData.linkedToken).remove();
       }
       
       // Delete user's documents
       const documentsSnapshot = await db.ref('pdf_documents').orderByChild('taxpayerMST').equalTo(userId).once('value');
       if (documentsSnapshot.exists()) {
         const documents = documentsSnapshot.val();
         const deletePromises = Object.keys(documents).map(docId => 
           db.ref('pdf_documents/' + docId).remove()
         );
         await Promise.all(deletePromises);
       }
       
       // Delete user's notifications
       await db.ref('notifications/' + userId).remove();
       
       // Log deletion
       await db.ref('activityLogs').push({
         type: 'user_deleted',
         userId: userId,
         admin: currentAdminUser.username,
         timestamp: Date.now(),
         details: `Xóa người dùng ${userId} và tất cả dữ liệu liên quan`
       });
       
       showNotification(`🎉 Đã xóa người dùng "${userId}" và tất cả dữ liệu liên quan!`, 'success');
       loadUsers();
       loadDashboardStats();
       loadUserDropdown();
       loadTokens();
       loadDocuments();

     } catch (error) {
       console.error('Error deleting user:', error);
       showNotification('❌ Có lỗi khi xóa người dùng: ' + error.message, 'error');
     }
   }

   // ===== NOTIFICATION HELPER FUNCTIONS =====
   async function createNotificationForUser(userId, notificationData) {
     try {
       const notificationId = db.ref().push().key;
       await db.ref(`notifications/${userId}/${notificationId}`).set({
         ...notificationData,
         createdAt: Date.now(),
         createdBy: currentAdminUser ? currentAdminUser.username : 'system'
       });
       
       console.log(`✅ Notification created for user ${userId}`);
       return true;
       
     } catch (error) {
       console.error('Error creating notification for user:', error);
       return false;
     }
   }

   async function createTransactionNotification(documentData) {
     const success = await createNotificationForUser(documentData.taxpayerMST, {
       type: 'transaction',
       title: 'Giao dịch nộp thuế',
       content: `Người nộp thuế đã nộp thuế thành công cho mã số thuế ${documentData.taxpayerMST}, mã tham chiếu: ${documentData.mst}. Số tiền: ${documentData.amount} VND.`,
       timestamp: Date.now(),
       relatedDocument: documentData.mst
     });
     
     if (success) {
       console.log('✅ Transaction notification sent');
     }
   }

   async function createAccountNotification(userId, createdDate) {
     const success = await createNotificationForUser(userId, {
       type: 'account',
       title: 'Tài khoản giao dịch thuế điện tử',
       content: `Tài khoản thuế điện tử của bạn đã được tạo thành công vào ngày ${createdDate}. Bạn có thể sử dụng dịch vụ thuế điện tử ngay bây giờ.`,
       timestamp: Date.now(),
       relatedDocument: null
     });
     
     if (success) {
       console.log('✅ Account notification sent');
     }
   }

   // ===== DOCUMENT UPLOAD FUNCTIONS =====
   function handleFileSelect(event) {
     const file = event.target.files[0];
     if (file && file.type === 'application/pdf') {
       document.getElementById('fileName').textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
       document.getElementById('fileInfo').style.display = 'block';
       
       // Store file globally
       window.selectedPDFFile = file;
       
       showNotification('✅ File PDF đã được chọn. Nhấn "Phân tích PDF" để extract thông tin!', 'success');
     } else {
       showNotification('❌ Vui lòng chọn file PDF hợp lệ!', 'error');
     }
   }

   async function extractPDFData() {
     if (!window.selectedPDFFile) {
       showNotification('❌ Vui lòng chọn file PDF trước!', 'error');
       return;
     }

     showNotification('⏳ Đang phân tích PDF...', 'info');

     // Mock data extraction (trong thực tế cần PDF.js)
     setTimeout(() => {
       const mockData = {
         reference: 'TAX' + Date.now().toString().slice(-8),
         amount: '5000000',
         taxTNCN: '500000',
         taxGTGT: '1000000',
         date: new Date().toISOString().split('T')[0],
         time: '14:30',
         dbhc: 'DBHC001'
       };

       // Fill form with extracted data
       document.getElementById('documentReference').value = mockData.reference;
       document.getElementById('totalAmount').value = mockData.amount;
       document.getElementById('taxTNCN').value = mockData.taxTNCN;
       document.getElementById('taxGTGT').value = mockData.taxGTGT;
       document.getElementById('paymentDate').value = mockData.date;
       document.getElementById('paymentTime').value = mockData.time;
       document.getElementById('dbhcCode').value = mockData.dbhc;

       // Convert amount to words
       convertToWords();

       // Show results
       document.getElementById('extractedData').innerHTML = `
         <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
           <div style="background: white; padding: 10px; border-radius: 8px; border-left: 3px solid #28a745;">
             <strong>Mã tham chiếu:</strong> ${mockData.reference}
           </div>
           <div style="background: white; padding: 10px; border-radius: 8px; border-left: 3px solid #28a745;">
             <strong>Tổng tiền:</strong> ${parseInt(mockData.amount).toLocaleString('vi-VN')} VND
           </div>
           <div style="background: white; padding: 10px; border-radius: 8px; border-left: 3px solid #28a745;">
             <strong>Thuế TNCN:</strong> ${parseInt(mockData.taxTNCN).toLocaleString('vi-VN')} VND
           </div>
           <div style="background: white; padding: 10px; border-radius: 8px; border-left: 3px solid #28a745;">
             <strong>Ngày nộp:</strong> ${new Date(mockData.date).toLocaleDateString('vi-VN')}
           </div>
         </div>
       `;
       document.getElementById('extractionResults').style.display = 'block';

       showNotification('🎉 Phân tích PDF thành công! Dữ liệu đã được điền vào form.', 'success');
     }, 2000);
   }

   async function uploadDocument(event) {
     event.preventDefault();
     
     if (!window.selectedPDFFile) {
       showNotification('❌ Vui lòng chọn file PDF trước!', 'error');
       return;
     }
     
     const documentData = {
       mst: document.getElementById('documentReference').value.trim(),
       taxpayerMST: document.getElementById('documentUser').value,
       taxTNCN: document.getElementById('taxTNCN').value.trim(),
       taxGTGT: document.getElementById('taxGTGT').value.trim(),
       amount: document.getElementById('totalAmount').value.trim(),
       amountInWords: document.getElementById('amountInWords').value.trim(),
       date: document.getElementById('paymentDate').value,
       time: document.getElementById('paymentTime').value,
       dbhc: document.getElementById('dbhcCode').value.trim(),
       status: 'completed', // Force status to completed
       notes: document.getElementById('documentNotes').value.trim(),
       uploadDate: new Date().toISOString(),
       uploadedBy: currentAdminUser.username,
       type: 'tax_payment_document'
     };
     
     if (!documentData.mst || !documentData.taxpayerMST) {
       showNotification('❌ Vui lòng điền đầy đủ thông tin bắt buộc!', 'error');
       return;
     }
     
     try {
       showNotification('⏳ Đang lưu chứng từ...', 'info');
       
       // Save document to Firebase
       await db.ref('pdf_documents/' + documentData.mst).set(documentData);
       
       // Send notification to user
       await createTransactionNotification(documentData);
       
       // Log activity
       await db.ref('activityLogs').push({
         type: 'document_uploaded',
         documentId: documentData.mst,
         userId: documentData.taxpayerMST,
         timestamp: Date.now(),
         details: `Upload chứng từ ${documentData.mst} cho user ${documentData.taxpayerMST} - Trạng thái: ${documentData.status}`,
         admin: currentAdminUser.username
       });
       
       showNotification('🎉 Lưu chứng từ thành công!\n\n📄 Mã: ' + documentData.mst + '\n✅ Trạng thái: Hoàn thành', 'success');
       
       // Reset form
       document.querySelector('#upload-section form').reset();
       document.getElementById('fileInfo').style.display = 'none';
       document.getElementById('extractionResults').style.display = 'none';
       window.selectedPDFFile = null;
       setDefaultDateTime();
       
       // Reload data
       loadDocuments();
       loadDashboardStats();
       
     } catch (error) {
       console.error('Error uploading document:', error);
       showNotification('❌ Có lỗi khi lưu chứng từ: ' + error.message, 'error');
     }
   }

   // ===== NOTIFICATION MANAGEMENT =====
   async function createNotification(event) {
     event.preventDefault();
     
     const userId = document.getElementById('notificationUser').value;
     const type = document.getElementById('notificationType').value;
     const title = document.getElementById('notificationTitle').value.trim();
     const content = document.getElementById('notificationContent').value.trim();
     const date = document.getElementById('notificationDate').value;
     const relatedDocument = document.getElementById('relatedDocument').value.trim();
     
     if (!userId || !title || !content) {
       showNotification('❌ Vui lòng điền đầy đủ thông tin bắt buộc!', 'error');
       return;
     }
     
     try {
       const notificationData = {
         type: type,
         title: title,
         content: content,
         timestamp: date ? new Date(date).getTime() : Date.now(),
         createdBy: currentAdminUser.username,
         createdAt: Date.now(),
         relatedDocument: relatedDocument || null
       };
       
       if (userId === 'all') {
         // Send to all users
         const usersSnapshot = await db.ref('users').once('value');
         const users = usersSnapshot.val() || {};
         
         const promises = Object.keys(users).map(async (userMst) => {
           const notificationId = db.ref().push().key;
           return db.ref(`notifications/${userMst}/${notificationId}`).set(notificationData);
         });
         
         await Promise.all(promises);
         
         showNotification(`🎉 Đã gửi thông báo cho ${Object.keys(users).length} người dùng!`, 'success');
         
       } else {
         // Send to specific user
         const notificationId = db.ref().push().key;
         await db.ref(`notifications/${userId}/${notificationId}`).set(notificationData);
         
         showNotification(`🎉 Đã gửi thông báo cho user ${userId}!`, 'success');
       }
       
       // Log activity
       await db.ref('activityLogs').push({
         type: 'notification_sent',
         targetUser: userId,
         notificationTitle: title,
         timestamp: Date.now(),
         details: `Admin gửi thông báo "${title}" cho ${userId === 'all' ? 'tất cả người dùng' : userId}`,
         admin: currentAdminUser.username
       });
       
       // Reset form
       document.querySelector('#notifications-section form').reset();
       setDefaultNotificationDate();
       
     } catch (error) {
       console.error('Error creating notification:', error);
       showNotification('❌ Có lỗi khi gửi thông báo: ' + error.message, 'error');
     }
   }

   // ===== DATA LOADING FUNCTIONS =====
   async function loadDashboardStats() {
     try {
       console.log('📊 Loading dashboard stats...');
       
       const [usersSnapshot, tokensSnapshot, documentsSnapshot] = await Promise.all([
         db.ref('users').once('value'),
         db.ref('deviceTokens').once('value'),
         db.ref('pdf_documents').once('value')
       ]);

       const users = usersSnapshot.val() || {};
       const tokens = tokensSnapshot.val() || {};
       const documents = documentsSnapshot.val() || {};

       const totalUsers = Object.keys(users).length;
       const activeTokens = Object.values(tokens).filter(token => !token.used).length;
       const totalDevices = Object.values(tokens).filter(token => token.used).length;
       const totalDocuments = Object.keys(documents).length;

       // Update UI
       const totalUsersElement = document.getElementById('totalUsers');
       const activeTokensElement = document.getElementById('activeTokens');
       const totalDevicesElement = document.getElementById('totalDevices');
       const totalDocumentsElement = document.getElementById('totalDocuments');

       if (totalUsersElement) totalUsersElement.textContent = totalUsers;
       if (activeTokensElement) activeTokensElement.textContent = activeTokens;
       if (totalDevicesElement) totalDevicesElement.textContent = totalDevices;
       if (totalDocumentsElement) totalDocumentsElement.textContent = totalDocuments;

       console.log('✅ Dashboard stats loaded:', { totalUsers, activeTokens, totalDevices, totalDocuments });

     } catch (error) {
       console.error('Error loading dashboard stats:', error);
       showNotification('❌ Có lỗi khi tải thống kê dashboard', 'error');
     }
   }

   async function loadUserDropdown() {
     try {
       const snapshot = await db.ref('users').once('value');
       const users = snapshot.val() || {};
       
       const dropdowns = ['documentUser', 'notificationUser'];
       
       dropdowns.forEach(dropdownId => {
         const dropdown = document.getElementById(dropdownId);
         if (!dropdown) return;
         
         // Clear existing options (keep first option)
         const firstOption = dropdown.firstElementChild;
         dropdown.innerHTML = '';
         if (firstOption) dropdown.appendChild(firstOption);
         
         // Add "all users" option for notification dropdown
         if (dropdownId === 'notificationUser') {
           const allOption = document.createElement('option');
           allOption.value = 'all';
           allOption.textContent = 'Tất cả người dùng';
           dropdown.appendChild(allOption);
         }
         
         // Add user options
         Object.entries(users).forEach(([userId, userData]) => {
           const option = document.createElement('option');
           option.value = userId;
           option.textContent = `${userId} - ${userData.name || 'N/A'}`;
           dropdown.appendChild(option);
         });
       });

     } catch (error) {
       console.error('Error loading user dropdown:', error);
     }
   }

   async function loadTokens() {
     try {
       const snapshot = await db.ref('deviceTokens').once('value');
       const tokens = snapshot.val() || {};
       
       const tbody = document.getElementById('tokensTableBody');
       tbody.innerHTML = '';

       if (Object.keys(tokens).length === 0) {
         tbody.innerHTML = `
           <tr>
             <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
               <i class="fas fa-key" style="font-size: 48px; opacity: 0.3; margin-bottom: 10px; display: block;"></i>
               Chưa có token nào được tạo
             </td>
           </tr>
         `;
         return;
       }

       Object.entries(tokens).forEach(([tokenId, tokenData]) => {
         const createdDate = new Date(tokenData.createdAt || Date.now()).toLocaleDateString('vi-VN');
         const expiresDate = new Date(tokenData.expiresAt || Date.now()).toLocaleDateString('vi-VN');
         
         const status = tokenData.used ? 
           '<span style="color: #28a745; font-weight: bold;">✅ Đã sử dụng</span>' : 
           '<span style="color: #ffc107; font-weight: bold;">⏳ Chưa sử dụng</span>';

         const linkedUser = tokenData.linkedUserId || 'Chưa liên kết';

         const row = `
           <tr>
             <td><code style="font-size: 12px;">${tokenId.slice(0, 20)}...</code></td>
             <td><strong>${linkedUser}</strong></td>
             <td>${createdDate}</td>
             <td>${status}</td>
             <td>${expiresDate}</td>
             <td>
               <button class="btn btn-small btn-info" onclick="viewTokenDetails('${tokenId}')">
                 <i class="fas fa-eye"></i>
               </button>
             </td>
           </tr>
         `;
         tbody.innerHTML += row;
       });

     } catch (error) {
       console.error('Error loading tokens:', error);
       showNotification('❌ Có lỗi khi tải danh sách token', 'error');
     }
   }

   async function loadDocuments() {
     try {
       const snapshot = await db.ref('pdf_documents').once('value');
       const documents = snapshot.val() || {};
       
       const tbody = document.getElementById('documentsTableBody');
       tbody.innerHTML = '';

       if (Object.keys(documents).length === 0) {
         tbody.innerHTML = `
           <tr>
             <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
               <i class="fas fa-file-pdf" style="font-size: 48px; opacity: 0.3; margin-bottom: 10px; display: block;"></i>
               Chưa có chứng từ nào được upload
             </td>
           </tr>
         `;
         return;
       }

       Object.entries(documents).forEach(([docId, docData]) => {
         const uploadDate = docData.uploadDate ? 
           new Date(docData.uploadDate).toLocaleDateString('vi-VN') : 
           docData.date || 'N/A';
         
         const amount = docData.amount ? 
           parseInt(docData.amount).toLocaleString('vi-VN') + ' VND' : 
           'N/A';

         const status = docData.status === 'completed' ? 
           '<span style="color: #28a745; font-weight: bold;">✅ Hoàn thành</span>' : 
           docData.status === 'pending' ? 
           '<span style="color: #ffc107; font-weight: bold;">⏳ Đang xử lý</span>' :
           '<span style="color: #dc3545; font-weight: bold;">❌ Thất bại</span>';

         const row = `
           <tr>
             <td><code>${docData.mst || docId}</code></td>
             <td><strong>${docData.taxpayerMST || 'N/A'}</strong></td>
             <td>${amount}</td>
             <td>${uploadDate}</td>
             <td>${status}</td>
             <td>
               <div style="display: flex; gap: 5px;">
                 <button class="btn btn-small btn-info" onclick="viewDocument('${docId}')">
                   <i class="fas fa-eye"></i>
                 </button>
                 <button class="btn btn-small btn-danger" onclick="deleteDocument('${docId}')">
                   <i class="fas fa-trash"></i>
                 </button>
               </div>
             </td>
           </tr>
         `;
         tbody.innerHTML += row;
       });

     } catch (error) {
       console.error('Error loading documents:', error);
       showNotification('❌ Có lỗi khi tải danh sách chứng từ', 'error');
     }
   }

   async function loadActivityLog() {
     try {
       const snapshot = await db.ref('activityLogs').orderByChild('timestamp').limitToLast(100).once('value');
       const logs = snapshot.val() || {};
       
       const tbody = document.getElementById('activityTableBody');
       tbody.innerHTML = '';

       if (Object.keys(logs).length === 0) {
         tbody.innerHTML = `
           <tr>
             <td colspan="5" style="text-align: center; padding: 40px; color: #666;">
               <i class="fas fa-history" style="font-size: 48px; opacity: 0.3; margin-bottom: 10px; display: block;"></i>
               Chưa có hoạt động nào được ghi nhận
             </td>
           </tr>
         `;
         return;
       }

       // Convert to array and sort by timestamp (newest first)
       const logsArray = Object.entries(logs).map(([id, data]) => ({ id, ...data }));
       logsArray.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

       logsArray.forEach((logData) => {
         const timestamp = new Date(logData.timestamp || Date.now()).toLocaleString('vi-VN');
         const activityType = getActivityIcon(logData.type);
         const deviceInfo = logData.deviceId ? 
           logData.deviceId.slice(0, 20) + '...' : 'N/A';
         
         const row = `
           <tr>
             <td>${timestamp}</td>
             <td>
               <span class="activity-badge ${logData.type}" style="
                 background: #f8f9fa; 
                 color: #333; 
                 padding: 4px 8px; 
                 border-radius: 12px; 
                 font-size: 12px; 
                 font-weight: 600;
                 border-left: 3px solid #667eea;
               ">
                 ${activityType.icon} ${activityType.text}
               </span>
             </td>
             <td><code>${logData.token || logData.userId || 'N/A'}</code></td>
             <td style="font-size: 12px;">${deviceInfo}</td>
             <td>${logData.details || ''}</td>
           </tr>
         `;
         tbody.innerHTML += row;
       });

     } catch (error) {
       console.error('Error loading activity log:', error);
       showNotification('❌ Có lỗi khi tải nhật ký hoạt động', 'error');
     }
   }

   function getActivityIcon(type) {
     const types = {
       'token_activated': { icon: '🔓', text: 'Token được kích hoạt' },
       'token_revoked': { icon: '🚫', text: 'Token bị thu hồi' },
       'token_regenerated': { icon: '🔄', text: 'Token được tạo lại' },
       'user_login': { icon: '🔑', text: 'Đăng nhập' },
       'user_logout': { icon: '🚪', text: 'Đăng xuất' },
       'user_created': { icon: '👤', text: 'Tạo tài khoản' },
       'user_updated': { icon: '✏️', text: 'Cập nhật thông tin' },
       'user_deleted': { icon: '🗑️', text: 'Xóa tài khoản' },
       'document_uploaded': { icon: '📄', text: 'Upload chứng từ' },
       'document_deleted': { icon: '🗑️', text: 'Xóa chứng từ' },
       'notification_sent': { icon: '📢', text: 'Gửi thông báo' },
       'device_linked': { icon: '📱', text: 'Liên kết thiết bị' },
       'direct_user_access': { icon: '🔗', text: 'Truy cập trực tiếp' },
       'password_changed': { icon: '🔐', text: 'Đổi mật khẩu' },
       'admin_login': { icon: '🔐', text: 'Admin đăng nhập' },
       'admin_logout': { icon: '🚪', text: 'Admin đăng xuất' }
     };
     return types[type] || { icon: '📝', text: 'Hoạt động khác' };
   }

   // ===== UTILITY FUNCTIONS =====
   function convertToWords() {
     const amount = document.getElementById('totalAmount').value.trim();
     if (!amount || isNaN(amount)) {
       document.getElementById('amountInWords').value = '';
       return;
     }

     const words = convertNumberToWords(parseInt(amount));
     document.getElementById('amountInWords').value = words;
   }

   function convertNumberToWords(amount) {
     if (amount === 0) return "không đồng";
     
     const ones = ["", "một", "hai", "ba", "bốn", "năm", "sáu", "bảy", "tám", "chín"];
     const tens = ["", "", "hai mươi", "ba mươi", "bốn mươi", "năm mươi", "sáu mươi", "bảy mươi", "tám mươi", "chín mươi"];
     
     function convertThreeDigits(num) {
       let result = "";
       const hundreds = Math.floor(num / 100);
       const remainder = num % 100;
       const tensDigit = Math.floor(remainder / 10);
       const onesDigit = remainder % 10;
       
       if (hundreds > 0) {
         result += ones[hundreds] + " trăm";
         if (remainder > 0) result += " ";
       }
       
       if (tensDigit >= 2) {
         result += tens[tensDigit];
         if (onesDigit > 0) {
           result += " " + ones[onesDigit];
         }
       } else if (tensDigit === 1) {
         result += "mười";
         if (onesDigit > 0) {
           result += " " + ones[onesDigit];
         }
       } else if (onesDigit > 0) {
         result += ones[onesDigit];
       }
       
       return result;
     }
     
     if (amount < 1000) {
       return convertThreeDigits(amount) + " đồng";
     } else if (amount < 1000000) {
       const thousands = Math.floor(amount / 1000);
       const remainder = amount % 1000;
       let result = convertThreeDigits(thousands) + " nghìn";
       if (remainder > 0) result += " " + convertThreeDigits(remainder);
       return result + " đồng";
     } else if (amount < 1000000000) {
       const millions = Math.floor(amount / 1000000);
       const remainder = amount % 1000000;
       let result = convertThreeDigits(millions) + " triệu";
       if (remainder > 0) {
         if (remainder >= 1000) {
           const thousands = Math.floor(remainder / 1000);
           const lastThree = remainder % 1000;
           result += " " + convertThreeDigits(thousands) + " nghìn";
           if (lastThree > 0) result += " " + convertThreeDigits(lastThree);
         } else {
           result += " " + convertThreeDigits(remainder);
         }
       }
       return result + " đồng";
     }
     
     return amount.toLocaleString('vi-VN') + " đồng";
   }

   function setDefaultDateTime() {
     try {
       const now = new Date();
       const localDate = now.toISOString().split('T')[0];
       const localTime = now.toTimeString().slice(0, 5);
       
       const paymentDateElement = document.getElementById('paymentDate');
       const paymentTimeElement = document.getElementById('paymentTime');
       
       if (paymentDateElement) {
         paymentDateElement.value = localDate;
       }
       if (paymentTimeElement) {
         paymentTimeElement.value = localTime;
       }
       
       console.log('✅ Default date/time set successfully');
     } catch (error) {
       console.error('Error setting default date/time:', error);
     }
   }

   function setDefaultNotificationDate() {
     try {
       const now = new Date();
       const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
       const notificationDateElement = document.getElementById('notificationDate');
       
       if (notificationDateElement) {
         notificationDateElement.value = localDateTime;
       }
       
       console.log('✅ Default notification date set successfully');
     } catch (error) {
       console.error('Error setting default notification date:', error);
     }
   }

   function setDefaultAccountCreationDate() {
     try {
       const now = new Date();
       const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
       const accountCreationElement = document.getElementById('accountCreationDate');
       
       if (accountCreationElement) {
         accountCreationElement.value = localDateTime;
       }
       
       console.log('✅ Default account creation date set successfully');
     } catch (error) {
       console.error('Error setting default account creation date:', error);
     }
   }

   // Toggle password visibility
   function togglePassword(inputId) {
     const input = document.getElementById(inputId);
     const button = input.parentNode.querySelector('.password-toggle i');
     
     if (input.type === 'password') {
       input.type = 'text';
       button.className = 'fas fa-eye-slash';
     } else {
       input.type = 'password';
       button.className = 'fas fa-eye';
     }
   }

   // View document
   function viewDocument(mst) {
     window.open(`xem-chung-tu.html?mst=${mst}`, '_blank');
   }

   // Delete document
   async function deleteDocument(mst) {
     if (!confirm(`Bạn có chắc chắn muốn xóa chứng từ "${mst}"?\n\nThao tác này không thể hoàn tác.`)) {
       return;
     }

     try {
       await db.ref('pdf_documents/' + mst).remove();
       
       // Log deletion
       await db.ref('activityLogs').push({
         type: 'document_deleted',
         documentId: mst,
         admin: currentAdminUser.username,
         timestamp: Date.now(),
         details: `Xóa chứng từ ${mst}`
       });
       
       showNotification(`🎉 Đã xóa chứng từ "${mst}" thành công!`, 'success');
       loadDocuments();
       loadDashboardStats();
       
     } catch (error) {
       console.error('Error deleting document:', error);
       showNotification('❌ Có lỗi khi xóa chứng từ: ' + error.message, 'error');
     }
   }

   // View token details
   function viewTokenDetails(tokenId) {
     showNotification(`🔑 Token: ${tokenId}\n\nTính năng xem chi tiết token đang được phát triển.`, 'info');
   }

   // ===== LOGOUT FUNCTION =====
   function logoutAdmin() {
     if (confirm('Bạn có chắc chắn muốn đăng xuất khỏi admin panel?')) {
       // Log logout
       db.ref('activityLogs').push({
         type: 'admin_logout',
         admin: currentAdminUser.username,
         timestamp: Date.now(),
         details: `Admin ${currentAdminUser.username} đăng xuất`
       });
       
       localStorage.removeItem('etax_admin_session');
       showNotification('🎉 Đã đăng xuất thành công!', 'success');
       setTimeout(() => {
         window.location.href = 'admin-login.html';
       }, 1500);
     }
   }

   // ===== MODAL FUNCTIONS =====
   function showModal(modalId) {
     document.getElementById(modalId).classList.add('show');
   }

   function closeModal(modalId) {
     document.getElementById(modalId).classList.remove('show');
     editingUserId = '';
   }

   // ===== NOTIFICATION SYSTEM =====
   function showNotification(message, type = 'info') {
     // Remove existing notifications
     const existingNotifications = document.querySelectorAll('.notification');
     existingNotifications.forEach(notif => notif.remove());

     const notification = document.createElement('div');
     notification.className = `notification ${type}`;
     notification.innerHTML = `
       <div style="display: flex; align-items: center; gap: 10px;">
         <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
         <span style="white-space: pre-line;">${message}</span>
       </div>
     `;

     document.body.appendChild(notification);

     // Show notification
     setTimeout(() => notification.classList.add('show'), 100);

     // Auto hide after 5 seconds
     setTimeout(() => {
       notification.classList.remove('show');
       setTimeout(() => notification.remove(), 300);
     }, 5000);
   }

   // ===== EVENT LISTENERS =====
   document.addEventListener('click', function(event) {
     if (event.target.classList.contains('modal')) {
       closeModal(event.target.id);
     }
   });

   document.addEventListener('keydown', function(event) {
     if (event.key === 'Escape') {
       const openModal = document.querySelector('.modal.show');
       if (openModal) {
         closeModal(openModal.id);
       }
     }
   });

   // Auto-refresh data every 60 seconds
   setInterval(() => {
     if (document.visibilityState === 'visible') {
       loadDashboardStats();
     }
   }, 60000);

   // Check session validity every 5 minutes
   setInterval(() => {
     checkAdminAuth();
   }, 5 * 60 * 1000);

   // ===== INITIALIZE APPLICATION =====
   document.addEventListener('DOMContentLoaded', function() {
     console.log('🚀 Admin panel initializing...');
     checkAdminAuth();
   });

   // Prevent form submission with Enter key in certain fields
   document.addEventListener('keydown', function(event) {
     if (event.key === 'Enter' && event.target.type !== 'submit' && event.target.tagName !== 'TEXTAREA') {
       event.preventDefault();
     }
   });

   console.log('✅ Admin panel JavaScript loaded successfully');
 </script>
 <script>
// Global variables cho PDF analysis
let selectedPDFFile = null;
let extractedPDFData = null;
const storage = firebase.storage();

// Configure PDF.js worker
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// Thay thế function handleFileSelect hiện có
function handleFileSelect(event) {
  const file = event.target.files[0];
  if (!file) return;

  if (file.type !== 'application/pdf') {
    showNotification('❌ Vui lòng chọn file PDF', 'error');
    return;
  }

  if (file.size > 10 * 1024 * 1024) { // 10MB limit
    showNotification('❌ File quá lớn. Vui lòng chọn file nhỏ hơn 10MB', 'error');
    return;
  }

  selectedPDFFile = file;
  
  // Update file info
  document.getElementById('fileName').textContent = file.name;
  document.getElementById('fileInfo').style.display = 'block';
  
  // Auto start analysis
  extractPDFData();
}

// Nâng cấp function extractPDFData với phân tích thông minh
async function extractPDFData() {
  if (!selectedPDFFile) {
    showNotification('❌ Vui lòng chọn file PDF trước', 'error');
    return;
  }

  // Show progress
  const progressContainer = document.querySelector('.analysis-progress') || createProgressContainer();
  progressContainer.style.display = 'block';
  
  // Hide previous results
  const resultsContainer = document.querySelector('.analysis-results');
  if (resultsContainer) resultsContainer.style.display = 'none';

  try {
    // Step 1: Đọc file PDF
    updateProgressStep(1, 'active');
    await sleep(300);

    const arrayBuffer = await selectedPDFFile.arrayBuffer();
    
    // Step 2: Trích xuất văn bản
    updateProgressStep(1, 'completed');
    updateProgressStep(2, 'active');
    await sleep(300);

    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
    let fullText = '';
    
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const textContent = await page.getTextContent();
      const pageText = textContent.items.map(item => item.str).join(' ');
      fullText += pageText + ' ';
    }

    // Step 3: Phân tích dữ liệu thông minh
    updateProgressStep(2, 'completed');
    updateProgressStep(3, 'active');
    await sleep(300);

    extractedPDFData = parseDocumentDataSmart(fullText);

    // Step 4: Hoàn thành
    updateProgressStep(3, 'completed');
    updateProgressStep(4, 'active');
    await sleep(300);
    updateProgressStep(4, 'completed');

    // Show results
    setTimeout(() => {
      displayExtractionResults(extractedPDFData);
      progressContainer.style.display = 'none';
      showNotification('🎉 Phân tích PDF hoàn tất! Dữ liệu đã được trích xuất thành công.', 'success');
    }, 500);

  } catch (error) {
    console.error('Lỗi phân tích PDF:', error);
    showNotification('❌ Lỗi khi phân tích PDF: ' + error.message, 'error');
    progressContainer.style.display = 'none';
  }
}

// Phân tích dữ liệu PDF thông minh dựa trên mẫu đã upload
function parseDocumentDataSmart(text) {
  const data = {
    documentType: 'Giấy nộp tiền vào ngân sách nhà nước',
    filename: selectedPDFFile.name,
    fileSize: selectedPDFFile.size,
    analyzedAt: new Date().toISOString(),
    rawText: text // Lưu để debug
  };

  // Trích xuất Mã tham chiếu (Reference Number)
  const refPatterns = [
    /Số tham chiếu[:\s]*(\d+)/i,
    /Reference[:\s]*(\d+)/i,
    /Mã tham chiếu[:\s]*(\d+)/i
  ];
  
  for (const pattern of refPatterns) {
    const match = text.match(pattern);
    if (match) {
      data.referenceNumber = match[1];
      break;
    }
  }

  // Trích xuất Mã số thuế (Tax ID)
  const taxIdPatterns = [
    /Mã số thuế[:\s]*([0-9-]+)/i,
    /MST[:\s]*([0-9-]+)/i,
    /Tax ID[:\s]*([0-9-]+)/i
  ];
  
  for (const pattern of taxIdPatterns) {
    const match = text.match(pattern);
    if (match) {
      data.taxId = match[1];
      break;
    }
  }

  // Trích xuất Người nộp thuế
  const taxpayerPatterns = [
    /Người nộp thuế[:\s]*([^\n\r]+)/i,
    /Taxpayer[:\s]*([^\n\r]+)/i,
    /Tên người nộp[:\s]*([^\n\r]+)/i
  ];
  
  for (const pattern of taxpayerPatterns) {
    const match = text.match(pattern);
    if (match) {
      data.taxpayerName = match[1].trim();
      break;
    }
  }

  // Trích xuất Địa chỉ
  const addressPatterns = [
    /Địa chỉ[:\s]*([^\n\r]+)/i,
    /Address[:\s]*([^\n\r]+)/i
  ];
  
  for (const pattern of addressPatterns) {
    const match = text.match(pattern);
    if (match) {
      data.address = match[1].trim();
      break;
    }
  }

  // Trích xuất Ngày nộp
  const datePatterns = [
    /Ngày (\d{1,2}) tháng (\d{1,2}) năm (\d{4})/i,
    /(\d{1,2})\/(\d{1,2})\/(\d{4})/g,
    /(\d{4})-(\d{2})-(\d{2})/g
  ];
  
  for (const pattern of datePatterns) {
    const match = text.match(pattern);
    if (match) {
      if (pattern.source.includes('tháng')) {
        data.paymentDate = `${match[1].padStart(2, '0')}/${match[2].padStart(2, '0')}/${match[3]}`;
      } else {
        data.paymentDate = match[0];
      }
      break;
    }
  }

  // Trích xuất Tổng tiền
  const totalPatterns = [
    /Tổng cộng[:\s]*([0-9,\.]+)/i,
    /Total[:\s]*([0-9,\.]+)/i,
    /Tổng số tiền[:\s]*([0-9,\.]+)/i
  ];
  
  for (const pattern of totalPatterns) {
    const match = text.match(pattern);
    if (match) {
      data.totalAmount = parseInt(match[1].replace(/[,\.]/g, ''));
      break;
    }
  }

  // Trích xuất Thuế TNCN (Personal Income Tax)
  const personalTaxPatterns = [
    /Thuế thu nhập.*?cá nhân.*?([0-9,\.]+)/i,
    /Personal.*?income.*?tax.*?([0-9,\.]+)/i,
    /TNCN.*?([0-9,\.]+)/i
  ];
  
  for (const pattern of personalTaxPatterns) {
    const match = text.match(pattern);
    if (match) {
      data.personalIncomeTax = parseInt(match[1].replace(/[,\.]/g, ''));
      break;
    }
  }

  // Trích xuất Thuế GTGT (VAT)
  const vatPatterns = [
    /Thuế giá trị gia tăng.*?([0-9,\.]+)/i,
    /VAT.*?([0-9,\.]+)/i,
    /GTGT.*?([0-9,\.]+)/i
  ];
  
  for (const pattern of vatPatterns) {
    const match = text.match(pattern);
    if (match) {
      data.vatTax = parseInt(match[1].replace(/[,\.]/g, ''));
      break;
    }
  }

  // Trích xuất thông tin ngân hàng
  if (text.includes('NGÂN HÀNG TMCP QUÂN ĐỘI') || text.includes('MB') || text.includes('Military')) {
    data.bank = 'Ngân hàng TMCP Quân đội (MB Bank)';
  }

  // Trích xuất Mã hiệu form
  const formCodePatterns = [
    /Mã hiệu[:\s]*([A-Z0-9-]+)/i,
    /Form code[:\s]*([A-Z0-9-]+)/i,
    /Code[:\s]*([A-Z0-9-]+)/i
  ];
  
  for (const pattern of formCodePatterns) {
    const match = text.match(pattern);
    if (match) {
      data.formCode = match[1];
      break;
    }
  }

  // Trích xuất Người nộp thay (nếu có)
  const submitterPatterns = [
    /Người nộp thay[:\s]*([^\n\r]+)/i,
    /Submitted by[:\s]*([^\n\r]+)/i
  ];
  
  for (const pattern of submitterPatterns) {
    const match = text.match(pattern);
    if (match) {
      data.submittedBy = match[1].trim();
      break;
    }
  }

  return data;
}

// Hiển thị kết quả phân tích
function displayExtractionResults(data) {
  let resultsContainer = document.querySelector('.analysis-results');
  if (!resultsContainer) {
    resultsContainer = document.createElement('div');
    resultsContainer.className = 'analysis-results';
    document.getElementById('extractionResults').appendChild(resultsContainer);
  }

  const formatCurrency = (amount) => {
    if (!amount || isNaN(amount)) return 'Không có thông tin';
    return new Intl.NumberFormat('vi-VN', {
      style: 'currency',
      currency: 'VND'
    }).format(amount);
  };

  const formatFileSize = (bytes) => {
    if (!bytes) return 'Không xác định';
    const mb = bytes / (1024 * 1024);
    return mb.toFixed(2) + ' MB';
  };

  resultsContainer.innerHTML = `
    <div style="text-align: center; margin-bottom: 20px;">
      <h4 style="color: #28a745; margin-bottom: 10px;">
        <i class="fas fa-check-circle"></i> Phân tích hoàn tất
      </h4>
      <p style="margin: 0; color: #666;">Dữ liệu đã được trích xuất từ PDF thành công</p>
    </div>

    <div class="results-grid">
      <div class="result-item">
        <div class="result-label">Loại chứng từ</div>
        <div class="result-value">${data.documentType}</div>
      </div>
      
      <div class="result-item">
        <div class="result-label">Mã tham chiếu</div>
        <div class="result-value">${data.referenceNumber || 'Không tìm thấy'}</div>
      </div>
      
      <div class="result-item">
        <div class="result-label">Mã số thuế</div>
        <div class="result-value">${data.taxId || 'Không tìm thấy'}</div>
      </div>
      
      <div class="result-item">
        <div class="result-label">Người nộp thuế</div>
        <div class="result-value">${data.taxpayerName || 'Không tìm thấy'}</div>
      </div>
      
      <div class="result-item">
        <div class="result-label">Địa chỉ</div>
        <div class="result-value">${data.address || 'Không tìm thấy'}</div>
      </div>
      
      <div class="result-item">
        <div class="result-label">Ngày nộp</div>
        <div class="result-value">${data.paymentDate || 'Không tìm thấy'}</div>
      </div>
      
      <div class="result-item">
        <div class="result-label">Tổng tiền</div>
        <div class="result-value amount-highlight">${formatCurrency(data.totalAmount)}</div>
      </div>
      
      ${data.personalIncomeTax ? `
      <div class="result-item">
        <div class="result-label">Thuế TNCN</div>
        <div class="result-value amount-highlight">${formatCurrency(data.personalIncomeTax)}</div>
      </div>
      ` : ''}
      
      ${data.vatTax ? `
      <div class="result-item">
        <div class="result-label">Thuế GTGT</div>
        <div class="result-value amount-highlight">${formatCurrency(data.vatTax)}</div>
      </div>
      ` : ''}
      
      <div class="result-item">
        <div class="result-label">Ngân hàng</div>
        <div class="result-value">${data.bank || 'Không xác định'}</div>
      </div>
      
      <div class="result-item">
        <div class="result-label">Mã hiệu</div>
        <div class="result-value">${data.formCode || 'Không tìm thấy'}</div>
      </div>
      
      <div class="result-item">
        <div class="result-label">Tên file gốc</div>
        <div class="result-value">${data.filename} (${formatFileSize(data.fileSize)})</div>
      </div>
    </div>

    <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
      <button type="button" class="auto-fill-btn" onclick="autoFillForm()">
        <i class="fas fa-magic"></i> Tự động điền form
      </button>
      <button type="button" class="auto-fill-btn" onclick="previewPDF()" style="background: #007bff;">
        <i class="fas fa-eye"></i> Xem PDF gốc
      </button>
    </div>
  `;

  resultsContainer.style.display = 'block';
  document.getElementById('extractedData').innerHTML = resultsContainer.outerHTML;
}

// Tự động điền form từ dữ liệu đã trích xuất
function autoFillForm() {
  if (!extractedPDFData) {
    showNotification('❌ Không có dữ liệu để điền form', 'error');
    return;
  }

  try {
    // Fill basic info
    if (extractedPDFData.referenceNumber) {
      document.getElementById('documentReference').value = extractedPDFData.referenceNumber;
    }

    if (extractedPDFData.taxpayerName) {
      document.getElementById('taxpayerName').value = extractedPDFData.taxpayerName;
    }

    if (extractedPDFData.taxId) {
      document.getElementById('taxpayerMST').value = extractedPDFData.taxId;
      
      // Auto select user if exists
      const userSelect = document.getElementById('documentUser');
      for (let option of userSelect.options) {
        if (option.value === extractedPDFData.taxId) {
          userSelect.value = extractedPDFData.taxId;
          break;
        }
      }
    }

    if (extractedPDFData.address) {
      document.getElementById('taxpayerAddress').value = extractedPDFData.address;
    }

    if (extractedPDFData.paymentDate) {
      // Convert to proper date format for input
      const dateStr = extractedPDFData.paymentDate;
      if (dateStr.includes('/')) {
        const parts = dateStr.split('/');
        if (parts.length === 3) {
          const formattedDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
          document.getElementById('transactionDate').value = formattedDate;
        }
      }
    }

    // Fill amounts
    if (extractedPDFData.totalAmount) {
      document.getElementById('amount').value = extractedPDFData.totalAmount.toLocaleString('vi-VN');
    }

    if (extractedPDFData.personalIncomeTax) {
      document.getElementById('taxTNCN').value = extractedPDFData.personalIncomeTax.toLocaleString('vi-VN');
    }

    if (extractedPDFData.vatTax) {
      document.getElementById('taxGTGT').value = extractedPDFData.vatTax.toLocaleString('vi-VN');
    }

    // Fill bank info
    if (extractedPDFData.bank) {
      document.getElementById('bankName').value = extractedPDFData.bank;
    }

    // Auto-generate MST if not provided
    if (!document.getElementById('mst').value) {
      generateNewMST();
    }

    // Convert amount to words
    if (extractedPDFData.totalAmount) {
      document.getElementById('amountInWords').value = convertToVietnameseWords(extractedPDFData.totalAmount);
    }

    // Set default status
    document.getElementById('status').value = 'completed';

    // Validate form
    validateForm();

    showNotification('✅ Đã tự động điền form từ dữ liệu PDF!', 'success');

  } catch (error) {
    console.error('Error auto-filling form:', error);
    showNotification('❌ Có lỗi khi tự động điền form: ' + error.message, 'error');
  }
}

// Xem PDF gốc
function previewPDF() {
  if (!selectedPDFFile) {
    showNotification('❌ Không có file PDF để xem', 'error');
    return;
  }

  const blob = new Blob([selectedPDFFile], { type: 'application/pdf' });
  const url = URL.createObjectURL(blob);
  
  window.open(url, '_blank');
  showNotification('📄 Đang mở PDF trong tab mới...', 'info');
}

// Tạo container cho progress nếu chưa có
function createProgressContainer() {
  let progressContainer = document.querySelector('.analysis-progress');
  if (!progressContainer) {
    progressContainer = document.createElement('div');
    progressContainer.className = 'analysis-progress';
    progressContainer.innerHTML = `
      <div style="display: flex; align-items: center; margin-bottom: 15px;">
        <div class="spinner"></div>
        <strong>Đang phân tích chứng từ PDF...</strong>
      </div>
      <div class="progress-steps">
        <div class="progress-step" id="step1">
          <div class="step-icon"><i class="fas fa-file-pdf"></i></div>
          <div class="step-text">Đọc PDF</div>
        </div>
        <div class="progress-step" id="step2">
          <div class="step-icon"><i class="fas fa-text-width"></i></div>
          <div class="step-text">Trích xuất text</div>
        </div>
        <div class="progress-step" id="step3">
          <div class="step-icon"><i class="fas fa-brain"></i></div>
          <div class="step-text">Phân tích dữ liệu</div>
        </div>
        <div class="progress-step" id="step4">
          <div class="step-icon"><i class="fas fa-check"></i></div>
          <div class="step-text">Hoàn thành</div>
        </div>
      </div>
    `;
    
    // Insert after file info
    const fileInfo = document.getElementById('fileInfo');
    if (fileInfo) {
      fileInfo.insertAdjacentElement('afterend', progressContainer);
    }
  }
  return progressContainer;
}

// Update progress step
function updateProgressStep(stepNumber, status) {
  const step = document.getElementById(`step${stepNumber}`);
  if (step) {
    step.classList.remove('active', 'completed');
    if (status) {
      step.classList.add(status);
    }
  }
}

// Utility function
function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// Setup drag and drop cho upload area khi page load
document.addEventListener('DOMContentLoaded', function() {
  const uploadArea = document.querySelector('.upload-area');
  if (uploadArea) {
    uploadArea.addEventListener('dragover', function(e) {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', function(e) {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', function(e) {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      
      const files = e.dataTransfer.files;
      if (files.length > 0 && files[0].type === 'application/pdf') {
        const fileInput = document.getElementById('pdfFile');
        fileInput.files = files;
        handleFileSelect({ target: { files: files } });
      } else {
        showNotification('❌ Vui lòng chỉ chọn file PDF', 'error');
      }
    });
  }

  // Add analysis header to upload section
  const uploadSection = document.getElementById('upload-section');
  if (uploadSection && !uploadSection.querySelector('.pdf-analysis-container')) {
    const analysisHeader = document.createElement('div');
    analysisHeader.className = 'pdf-analysis-container';
    analysisHeader.innerHTML = `
      <div class="analysis-header">
        <h3><i class="fas fa-magic"></i> Phân tích PDF Thông minh</h3>
        <p>Upload file PDF để tự động trích xuất thông tin chứng từ thuế</p>
      </div>
    `;
    
    const cardTitle = uploadSection.querySelector('.card-title');
    if (cardTitle) {
      cardTitle.insertAdjacentElement('afterend', analysisHeader);
    }
  }
});

console.log('🚀 PDF Analysis Enhancement loaded successfully!');
</script>
</body>
</html>